<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Oracle特殊恢复原理与实战_06 使用BBED手工修复block数据]]></title>
      <url>/2018/03/28/oracle/Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/06_Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%85%A5%E9%97%A8/</url>
      <content type="html"><![CDATA[<h2 id="Oracle-11g-Data-Block-Layout"><a href="#Oracle-11g-Data-Block-Layout" class="headerlink" title="Oracle 11g Data Block Layout"></a>Oracle 11g Data Block Layout</h2><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0327_oracle_dsi_01.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0327_oracle_dsi_02.png" alt=""></p>
<a id="more"></a>
<p><img src="http://p2c0rtsgc.bkt.clouddn.com/0327_oracle_dsi_03.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0327_oracle_dsi_04.png" alt=""></p>
<h3 id="KCBH"><a href="#KCBH" class="headerlink" title="KCBH"></a>KCBH</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0327_oracle_dsi_05.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; conn lyj/lyj</span>
<span class="line">SQL&gt; <span class="keyword">select</span> ROWID,ID,NAME,DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) FILE<span class="comment">#,DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID) BLOCK# from t1;</span></span>
<span class="line"></span>
<span class="line">ROWID                      ID NAME            FILE<span class="comment">#     BLOCK#</span></span>
<span class="line">------------------ ---------- ---------- ---------- ----------</span>
<span class="line">AAAW0oAAGAAAACDAAA          <span class="number">1</span> AAAAAA              <span class="number">6</span>        <span class="number">131</span></span>
<span class="line">AAAW0oAAGAAAACDAAB          <span class="number">2</span> BBBBB               <span class="number">6</span>        <span class="number">131</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 进入BBED</span></span>
<span class="line">BBED&gt; set file <span class="number">6</span> block <span class="number">131</span></span>
<span class="line">        FILE<span class="comment">#           6</span></span>
<span class="line">        BLOCK<span class="comment">#          131</span></span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">map</span> /v</span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">131</span>                                   Dba:<span class="number">0x01800083</span></span>
<span class="line">------------------------------------------------------------</span>
<span class="line"> KTB Data Block (Table/Cluster)</span>
<span class="line"></span>
<span class="line"> struct kcbh, <span class="number">20</span> bytes                      @0       </span>
<span class="line">    ub1 type_kcbh                           @0       </span>
<span class="line">    ub1 frmt_kcbh                           @1       </span>
<span class="line">    ub1 spare1_kcbh                         @2       </span>
<span class="line">    ub1 spare2_kcbh                         @3       </span>
<span class="line">    ub4 rdba_kcbh                           @4       </span>
<span class="line">    ub4 bas_kcbh                            @8       </span>
<span class="line">    ub2 wrp_kcbh                            @12      </span>
<span class="line">    ub1 seq_kcbh                            @14      </span>
<span class="line">    ub1 flg_kcbh                            @15      </span>
<span class="line">    ub2 chkval_kcbh                         @16      </span>
<span class="line">    ub2 spare3_kcbh                         @18</span>
<span class="line"></span>
<span class="line">BBED&gt; p kcbh</span>
<span class="line">struct kcbh, <span class="number">20</span> bytes                       @0       </span>
<span class="line">   ub1 type_kcbh                            @0        <span class="number">0x06</span>    <span class="comment"># 06代表数据块</span></span>
<span class="line">   ub1 frmt_kcbh                            @1        <span class="number">0xa2</span>    <span class="comment"># 0xa2代表块的大小是8k</span></span>
<span class="line">   ub1 spare1_kcbh                          @2        <span class="number">0x00</span>    <span class="comment"># 保留值</span></span>
<span class="line">   ub1 spare2_kcbh                          @3        <span class="number">0x00</span>    <span class="comment"># 保留值</span></span>
<span class="line">   ub4 rdba_kcbh                            @4        <span class="number">0x01800083</span> <span class="comment"># RDBA相对数据块地址 6号文件的131号块（转换方法在下面）</span></span>
<span class="line">   ub4 bas_kcbh                             @8        <span class="number">0x0037066e</span> <span class="comment"># 块头的SCN(低32位) </span></span>
<span class="line">   ub2 wrp_kcbh                             @12       <span class="number">0x0000</span>     <span class="comment"># 块头的SCN(高16位)</span></span>
<span class="line">   ub1 seq_kcbh                             @14       <span class="number">0x02</span>       <span class="comment"># seq最大值254</span></span>
<span class="line">   ub1 flg_kcbh                             @15       <span class="number">0x06</span> (KCBHFDLC, KCBHFCKV)</span>
<span class="line">   ub2 chkval_kcbh                          @16       <span class="number">0x9200</span>     <span class="comment"># db_block_checksum </span></span>
<span class="line">   ub2 spare3_kcbh                          @18       <span class="number">0x0000</span>     <span class="comment"># 保留值</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># 下面为rdba换算成文件号块号的方法</span></span>
</pre></td></tr></table></figure></p>
<h4 id="rdba转换成文件号块号的方法"><a href="#rdba转换成文件号块号的方法" class="headerlink" title="rdba转换成文件号块号的方法"></a>rdba转换成文件号块号的方法</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rdba：<span class="number">0x01800083</span>   </span>
<span class="line">      <span class="number">0000</span> <span class="number">0001</span> <span class="number">1000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">1000</span> <span class="number">0011</span></span>
<span class="line">前<span class="number">10</span>位文件号：<span class="number">0000</span> <span class="number">0001</span> <span class="number">10</span>  -  <span class="number">6</span>号文件</span>
<span class="line">后<span class="number">22</span>位块号：  <span class="number">00</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">0000</span> <span class="number">1000</span> <span class="number">0011</span> - <span class="number">131</span>号块</span>
</pre></td></tr></table></figure>
<h4 id="RDBA转换函数"><a href="#RDBA转换函数" class="headerlink" title="RDBA转换函数"></a>RDBA转换函数</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下以函数用来从RDBA中转换file#和block#出来</span></span>
<span class="line">CREATE OR REPLACE FUNCTION getbfno (p_dba IN VARCHAR2)</span>
<span class="line">   RETURN VARCHAR2</span>
<span class="line">IS</span>
<span class="line">   l_str   VARCHAR2 (<span class="number">255</span>) DEFAULT NULL;</span>
<span class="line">   l_fno   VARCHAR2 (<span class="number">15</span>);</span>
<span class="line">   l_bno   VARCHAR2 (<span class="number">15</span>);</span>
<span class="line">BEGIN</span>
<span class="line">   l_fno :=</span>
<span class="line">      DBMS_UTILITY.data_block_address_file (TO_NUMBER (LTRIM (p_dba, <span class="string">'0x'</span>),</span>
<span class="line">                                                       <span class="string">'xxxxxxxx'</span></span>
<span class="line">                                                      )</span>
<span class="line">                                           );</span>
<span class="line">   l_bno :=</span>
<span class="line">      DBMS_UTILITY.data_block_address_block (TO_NUMBER (LTRIM (p_dba, <span class="string">'0x'</span>),</span>
<span class="line">                                                        <span class="string">'xxxxxxxx'</span></span>
<span class="line">                                                       )</span>
<span class="line">                                            );</span>
<span class="line">   l_str :=</span>
<span class="line">         <span class="string">'datafile# is:'</span></span>
<span class="line">      || l_fno</span>
<span class="line">      || CHR (<span class="number">10</span>)</span>
<span class="line">      || <span class="string">'datablock is:'</span></span>
<span class="line">      || l_bno</span>
<span class="line">      || CHR (<span class="number">10</span>)</span>
<span class="line">      || <span class="string">'dump command:alter system dump datafile '</span></span>
<span class="line">      || l_fno</span>
<span class="line">      || <span class="string">' block '</span></span>
<span class="line">      || l_bno</span>
<span class="line">      || <span class="string">';'</span>;</span>
<span class="line">   RETURN l_str;</span>
<span class="line">END;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">SQL&gt; select getbfno('0x01800083') BFNO from dual;</span>
<span class="line"></span>
<span class="line">BFNO</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">datafile# is:6</span>
<span class="line">datablock is:131</span>
<span class="line">dump command:alter system dump datafile 6 block 131;</span></span>
</pre></td></tr></table></figure>
<h4 id="scn-wrap和scn"><a href="#scn-wrap和scn" class="headerlink" title="scn wrap和scn"></a>scn wrap和scn</h4><p>在Oracle内部，SCN分为两部分存储，分别称之为scn wrap和scn base。<br>实际上SCN长度为48位，即它其实就是一个48位的整数。只不过可能是由于在早些年通常只能处理32位甚至是16位的数据，所以人为地分成了低32位（scnbase）和高16位（scn wrap）。<br>为什么不设计成64位，这个或许是觉得48位已经足够长了并且为了节省两个字节的空间：）。那么SCN这个48位长的整数，最大就是2^48（2的48次方, 281万亿，281474976710656），很大的一个数字了。 这里有一个重要的公式：<code>SCN= (SCN_WRP * 4294967296) + SCN_BAS</code></p>
<h3 id="KTBBH-Transaction-Layer"><a href="#KTBBH-Transaction-Layer" class="headerlink" title="KTBBH: Transaction Layer"></a>KTBBH: Transaction Layer</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0327_oracle_dsi_06.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># DUMP的结构</span></span>
<span class="line">Block header <span class="keyword">dump</span>:  <span class="number">0x01800083</span></span>
<span class="line"> Object id on Block? Y</span>
<span class="line"> seg/obj: <span class="number">0x16d28</span>  csc: <span class="number">0x00</span>.<span class="number">367</span>d2<span class="number">0</span>  itc: <span class="number">2</span>  flg: E  typ: <span class="number">1</span> - DATA</span>
<span class="line">     brn: <span class="number">0</span>  bdba: <span class="number">0x1800080</span> ver: <span class="number">0x01</span> opc: <span class="number">0</span></span>
<span class="line">     inc: <span class="number">0</span>  exflg: <span class="number">0</span></span>
<span class="line"></span>
<span class="line"> Itl           Xid                  Uba         Flag  Lck        Scn/Fsc</span>
<span class="line"><span class="number">0x01</span>   <span class="number">0x0009</span>.<span class="number">01</span>a.<span class="number">00000</span>954  <span class="number">0x00c06012</span>.<span class="number">03</span>cd.<span class="number">1</span>d  --U-    <span class="number">1</span>  fsc <span class="number">0x0000</span>.<span class="number">00367</span>d21</span>
<span class="line"><span class="number">0x02</span>   <span class="number">0x0009</span>.<span class="number">00</span>c.<span class="number">00000</span>965  <span class="number">0x00c06012</span>.<span class="number">03</span>d1.<span class="number">37</span>  --U-    <span class="number">1</span>  fsc <span class="number">0x0000</span>.<span class="number">0037066</span>e</span>
<span class="line">bdba: <span class="number">0x01800083</span></span>
<span class="line">data_block_dump,data header at <span class="number">0x7f4671807a64</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># BBED</span></span>
<span class="line">BBED&gt; p ktbbh</span>
<span class="line">struct ktbbh, <span class="number">72</span> bytes                      @20      </span>
<span class="line">   ub1 ktbbhtyp                             @20       <span class="number">0x01</span> (KDDBTDATA)</span>
<span class="line">   union ktbbhsid, <span class="number">4</span> bytes                  @24      </span>
<span class="line">      ub4 ktbbhsg1                          @24       <span class="number">0x00016d28</span></span>
<span class="line">      ub4 ktbbhod1                          @24       <span class="number">0x00016d28</span></span>
<span class="line">   struct ktbbhcsc, <span class="number">8</span> bytes                 @28      </span>
<span class="line">      ub4 kscnbas                           @28       <span class="number">0x00367d20</span></span>
<span class="line">      ub2 kscnwrp                           @32       <span class="number">0x0000</span></span>
<span class="line">   sb2 ktbbhict                             @36      -<span class="number">2046</span></span>
<span class="line">   ub1 ktbbhflg                             @38       <span class="number">0x32</span> (NONE)</span>
<span class="line">   ub1 ktbbhfsl                             @39       <span class="number">0x00</span></span>
<span class="line">   ub4 ktbbhfnx                             @40       <span class="number">0x01800080</span></span>
<span class="line">   struct ktbbhitl[<span class="number">0</span>], <span class="number">24</span> bytes             @44      </span>
<span class="line">      struct ktbitxid, <span class="number">8</span> bytes              @44      </span>
<span class="line">         ub2 kxidusn                        @44       <span class="number">0x0009</span></span>
<span class="line">         ub2 kxidslt                        @46       <span class="number">0x001a</span></span>
<span class="line">         ub4 kxidsqn                        @48       <span class="number">0x00000954</span></span>
<span class="line">      struct ktbituba, <span class="number">8</span> bytes              @52      </span>
<span class="line">         ub4 kubadba                        @52       <span class="number">0x00c06012</span></span>
<span class="line">         ub2 kubaseq                        @56       <span class="number">0x03cd</span></span>
<span class="line">         ub1 kubarec                        @58       <span class="number">0x1d</span></span>
<span class="line">      ub2 ktbitflg                          @60       <span class="number">0x2001</span> (KTBFUPB)</span>
<span class="line">      union _ktbitun, <span class="number">2</span> bytes               @62      </span>
<span class="line">         sb2 _ktbitfsc                      @62       <span class="number">0</span></span>
<span class="line">         ub2 _ktbitwrp                      @62       <span class="number">0x0000</span></span>
<span class="line">      ub4 ktbitbas                          @64       <span class="number">0x00367d21</span></span>
<span class="line">   struct ktbbhitl[<span class="number">1</span>], <span class="number">24</span> bytes             @68      </span>
<span class="line">      struct ktbitxid, <span class="number">8</span> bytes              @68      </span>
<span class="line">         ub2 kxidusn                        @68       <span class="number">0x0009</span></span>
<span class="line">         ub2 kxidslt                        @70       <span class="number">0x000c</span></span>
<span class="line">         ub4 kxidsqn                        @72       <span class="number">0x00000965</span></span>
<span class="line">      struct ktbituba, <span class="number">8</span> bytes              @76      </span>
<span class="line">         ub4 kubadba                        @76       <span class="number">0x00c06012</span></span>
<span class="line">         ub2 kubaseq                        @80       <span class="number">0x03d1</span></span>
<span class="line">         ub1 kubarec                        @82       <span class="number">0x37</span></span>
<span class="line">      ub2 ktbitflg                          @84       <span class="number">0x2001</span> (KTBFUPB)</span>
<span class="line">      union _ktbitun, <span class="number">2</span> bytes               @86      </span>
<span class="line">         sb2 _ktbitfsc                      @86       <span class="number">0</span></span>
<span class="line">         ub2 _ktbitwrp                      @86       <span class="number">0x0000</span></span>
<span class="line">      ub4 ktbitbas                          @88       <span class="number">0x0037066e</span></span>
</pre></td></tr></table></figure></p>
<h3 id="KDBH"><a href="#KDBH" class="headerlink" title="KDBH"></a>KDBH</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0327_oracle_dsi_07.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dump</span></span>
<span class="line">tsiz: <span class="number">0x1f98</span></span>
<span class="line">hsiz: <span class="number">0x16</span></span>
<span class="line">pbl: <span class="number">0x7f4671807a64</span></span>
<span class="line">     <span class="number">76543210</span></span>
<span class="line">flag=--------</span>
<span class="line">ntab=<span class="number">1</span></span>
<span class="line">nrow=<span class="number">2</span></span>
<span class="line">frre=-<span class="number">1</span></span>
<span class="line">fsbo=<span class="number">0x16</span></span>
<span class="line">fseo=<span class="number">0x1f7f</span></span>
<span class="line">avsp=<span class="number">0x1f69</span></span>
<span class="line">tosp=<span class="number">0x1f69</span></span>
<span class="line"><span class="number">0xe</span>:pti[<span class="number">0</span>]      nrow=<span class="number">2</span>  offs=<span class="number">0</span></span>
<span class="line"><span class="number">0x12</span>:pri[<span class="number">0</span>]     offs=<span class="number">0x1f8b</span></span>
<span class="line"><span class="number">0x14</span>:pri[<span class="number">1</span>]     offs=<span class="number">0x1f7f</span></span>
<span class="line">block_row_dump:</span>
<span class="line">tab <span class="number">0</span>, row <span class="number">0</span>, @0x1f8b</span>
<span class="line">tl: <span class="number">13</span> fb: --H-FL-- lb: <span class="number">0x1</span>  cc: <span class="number">2</span></span>
<span class="line">col  <span class="number">0</span>: [ <span class="number">2</span>]  c1 <span class="number">02</span></span>
<span class="line">col  <span class="number">1</span>: [ <span class="number">6</span>]  <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span></span>
<span class="line">tab <span class="number">0</span>, row <span class="number">1</span>, @0x1f7f</span>
<span class="line">tl: <span class="number">12</span> fb: --H-FL-- lb: <span class="number">0x2</span>  cc: <span class="number">2</span></span>
<span class="line">col  <span class="number">0</span>: [ <span class="number">2</span>]  c1 <span class="number">03</span></span>
<span class="line">col  <span class="number">1</span>: [ <span class="number">5</span>]  <span class="number">42</span> <span class="number">42</span> <span class="number">42</span> <span class="number">42</span> <span class="number">42</span></span>
<span class="line">end_of_block_dump</span>
<span class="line"></span>
<span class="line"><span class="comment"># bbed</span></span>
<span class="line">BBED&gt; p kdbr</span>
<span class="line">sb2 kdbr[<span class="number">0</span>]                                 @118      <span class="number">8075</span></span>
<span class="line">sb2 kdbr[<span class="number">1</span>]                                 @120      <span class="number">8063</span></span>
<span class="line"></span>
<span class="line">BBED&gt; p *kdbr[<span class="number">0</span>]</span>
<span class="line">rowdata[<span class="number">12</span>]</span>
<span class="line">-----------</span>
<span class="line">ub1 rowdata[<span class="number">12</span>]                             @8175     <span class="number">0x2c</span></span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">x</span>/rncccccc</span>
<span class="line">rowdata[<span class="number">12</span>]                                 @8175    </span>
<span class="line">-----------</span>
<span class="line">flag@8175: <span class="number">0x2c</span> (KDRHFL, KDRHFF, KDRHFH)</span>
<span class="line">lock@8176: <span class="number">0x01</span></span>
<span class="line">cols@8177:    <span class="number">2</span></span>
<span class="line"></span>
<span class="line">col    <span class="number">0</span>[<span class="number">2</span>] @8178: <span class="number">1</span> </span>
<span class="line">col    <span class="number">1</span>[<span class="number">6</span>] @8181: AAAAAA</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">BBED&gt;  p *kdbr[<span class="number">1</span>]</span>
<span class="line">rowdata[<span class="number">0</span>]</span>
<span class="line">----------</span>
<span class="line">ub1 rowdata[<span class="number">0</span>]                              @8163     <span class="number">0x2c</span></span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">x</span>/rncccccc</span>
<span class="line">rowdata[<span class="number">0</span>]                                  @8163    </span>
<span class="line">----------</span>
<span class="line">flag@8163: <span class="number">0x2c</span> (KDRHFL, KDRHFF, KDRHFH)</span>
<span class="line">lock@8164: <span class="number">0x02</span></span>
<span class="line">cols@8165:    <span class="number">2</span></span>
<span class="line"></span>
<span class="line">col    <span class="number">0</span>[<span class="number">2</span>] @8166: <span class="number">2</span> </span>
<span class="line">col    <span class="number">1</span>[<span class="number">5</span>] @8169: BBBBB</span>
<span class="line"></span>
<span class="line"><span class="comment"># 转换语句</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> <span class="keyword">dump</span>(<span class="string">'AAAAAA'</span>,<span class="number">16</span>) from dual;</span>
<span class="line"></span>
<span class="line">DUMP(<span class="string">'AAAAAA'</span>,<span class="number">16</span>)</span>
<span class="line">-------------------------------</span>
<span class="line">Typ=<span class="number">96</span> Len=<span class="number">6</span>: <span class="number">41</span>,<span class="number">41</span>,<span class="number">41</span>,<span class="number">41</span>,<span class="number">41</span>,<span class="number">41</span></span>
</pre></td></tr></table></figure></p>
<h2 id="Oracle-ROWID格式解析"><a href="#Oracle-ROWID格式解析" class="headerlink" title="Oracle ROWID格式解析"></a>Oracle ROWID格式解析</h2><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0327_oracle_dsi_08.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> ROWID,ID,NAME,DBMS_ROWID.ROWID_RELATIVE_FNO(ROWID) FILE<span class="comment">#,DBMS_ROWID.ROWID_BLOCK_NUMBER(ROWID) BLOCK# from t1;</span></span>
<span class="line"></span>
<span class="line">ROWID                      ID NAME            FILE<span class="comment">#     BLOCK#</span></span>
<span class="line">------------------ ---------- ---------- ---------- ----------</span>
<span class="line">AAAW0oAAGAAAACDAAA          <span class="number">1</span> AAAAAA              <span class="number">6</span>        <span class="number">131</span></span>
<span class="line">AAAW0oAAGAAAACDAAB          <span class="number">2</span> BBBBB               <span class="number">6</span>        <span class="number">131</span></span>
</pre></td></tr></table></figure></p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="insert一条记录，没有提交事务，会写入Datablock吗？"><a href="#insert一条记录，没有提交事务，会写入Datablock吗？" class="headerlink" title="insert一条记录，没有提交事务，会写入Datablock吗？"></a>insert一条记录，没有提交事务，会写入Datablock吗？</h3><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://wenku.baidu.com/view/0624178076eeaeaad0f33028.html" target="_blank" rel="external">Oracle数据块损坏知识</a></p>
]]></content>
      
        <categories>
            
            <category> Oracle特殊恢复原理与实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> DSI </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle特殊恢复原理与实战_05 使用BBED跳过归档的恢复]]></title>
      <url>/2018/03/26/oracle/Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/05_Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%85%A5%E9%97%A8/</url>
      <content type="html"><![CDATA[<h2 id="使用BBED跳过归档的恢复"><a href="#使用BBED跳过归档的恢复" class="headerlink" title="使用BBED跳过归档的恢复"></a>使用BBED跳过归档的恢复</h2><h3 id="模拟场景：在做恢复时发现丢失部分归档"><a href="#模拟场景：在做恢复时发现丢失部分归档" class="headerlink" title="模拟场景：在做恢复时发现丢失部分归档"></a>模拟场景：在做恢复时发现丢失部分归档</h3><p>开启归档<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; archive <span class="keyword">log</span> list;</span>
<span class="line">Database <span class="keyword">log</span> mode              Archive Mode</span>
<span class="line">Automatic archival             Enabled</span>
<span class="line">Archive destination            USE_DB_RECOVERY_FILE_DEST</span>
<span class="line">Oldest online <span class="keyword">log</span> sequence     <span class="number">44</span></span>
<span class="line">Next <span class="keyword">log</span> sequence to archive   <span class="number">46</span></span>
<span class="line">Current <span class="keyword">log</span> sequence           <span class="number">46</span></span>
<span class="line"></span>
<span class="line">SQL&gt; show parameter recovery</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">db_recovery_file_dest                string      /u01/app/oracle/fast_recovery<span class="number">_</span></span>
<span class="line">                                                 area</span>
<span class="line">db_recovery_file_dest_size           big integer <span class="number">10</span>G</span>
<span class="line">recovery_parallelism                 integer     <span class="number">0</span></span>
</pre></td></tr></table></figure></p>
<a id="more"></a>
<p>创建表空间、用户、表并插入数据<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create tablespace skip_arch datafile <span class="string">'/u01/app/oracle/oradata/orcl/skip_arch01.dbf'</span> size <span class="number">50</span><span class="keyword">m</span>;</span>
<span class="line">create user lyj identified by lyj default tablespace skip_arch;</span>
<span class="line">grant dba to lyj;</span>
<span class="line">conn lyj/lyj</span>
<span class="line">create table t1 (id <span class="keyword">int</span>,name varchar2(<span class="number">10</span>));</span>
<span class="line">insert into t1 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'AAAAAA'</span>);</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure></p>
<p>对6号文件做备份<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line">col FILE_NAME <span class="keyword">for</span> a6<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> FILE_ID,FILE_NAME from dba_data_files order by <span class="number">1</span>;</span>
<span class="line"></span>
<span class="line">   FILE_ID FILE_NAME</span>
<span class="line">---------- ------------------------------------------------------------</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl/system01.dbf</span>
<span class="line">         <span class="number">2</span> /u01/app/oracle/oradata/orcl/sysaux01.dbf</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl/undotbs01.dbf</span>
<span class="line">         <span class="number">4</span> /u01/app/oracle/oradata/orcl/users01.dbf</span>
<span class="line">         <span class="number">5</span> /u01/app/oracle/oradata/orcl/dsi01.dbf</span>
<span class="line">         <span class="number">6</span> /u01/app/oracle/oradata/orcl/skip_arch01.dbf</span>
<span class="line"></span>
<span class="line">rman target /</span>
<span class="line">backup datafile <span class="number">6</span> <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/datafile5_%U'</span>;</span>
</pre></td></tr></table></figure></p>
<p>切换归档日志<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> sequence<span class="comment">#,status from v$archived_log order by 1 desc;</span></span>
<span class="line"> SEQUENCE<span class="comment"># S</span></span>
<span class="line">---------- -</span>
<span class="line">        <span class="number">45</span> A   </span>
<span class="line">        <span class="number">44</span> A</span>
<span class="line">        <span class="number">43</span> A</span>
<span class="line">        <span class="number">42</span> A</span>
<span class="line">        <span class="number">41</span> A</span>
<span class="line">        <span class="number">40</span> A</span>
<span class="line"></span>
<span class="line"><span class="comment"># 多次切换</span></span>
<span class="line">alter <span class="keyword">system</span> switch logfile;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">select sequence#,status from v$archived_log order by 1 desc;</span>
<span class="line"></span>
<span class="line"> SEQUENCE# S</span>
<span class="line">---------- -</span>
<span class="line">        51 A</span>
<span class="line">        50 A</span>
<span class="line">        49 A</span>
<span class="line">        48 A</span>
<span class="line">        47 A</span>
<span class="line">        46 A</span>
<span class="line"></span>
<span class="line"># 查看归档文件</span>
<span class="line">cd /u</span>01/app/oracle/fast_recovery_area/ORCL/archivelog/<span class="number">2018_03_19</span></span>
<span class="line">ll</span>
<span class="line">total <span class="number">56544</span></span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">36331008</span> Mar <span class="number">19</span> <span class="number">00</span>:<span class="number">01</span> o1_mf_1_45_fbx39wby<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">21547008</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">05</span> o1_mf_1_46_fbyrbkbz<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">2048</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">05</span> o1_mf_1_47_fbyrbmnn<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">1536</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">05</span> o1_mf_1_48_fbyrbqww<span class="number">_</span>.arc  </span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">1024</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">06</span> o1_mf_1_49_fbyrbs1o<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">1024</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">06</span> o1_mf_1_50_fbyrbt9w<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">1024</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">06</span> o1_mf_1_51_fbyrbv64<span class="number">_</span>.arc</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除48、49号归档</span></span>
<span class="line">rm o1_mf_1_48_fbyrbqww<span class="number">_</span>.arc o1_mf_1_49_fbyrbs1o<span class="number">_</span>.arc</span>
<span class="line">ll</span>
<span class="line">total <span class="number">56536</span></span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">36331008</span> Mar <span class="number">19</span> <span class="number">00</span>:<span class="number">01</span> o1_mf_1_45_fbx39wby<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">21547008</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">05</span> o1_mf_1_46_fbyrbkbz<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">2048</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">05</span> o1_mf_1_47_fbyrbmnn<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">1024</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">06</span> o1_mf_1_50_fbyrbt9w<span class="number">_</span>.arc</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">1024</span> Mar <span class="number">19</span> <span class="number">15</span>:<span class="number">06</span> o1_mf_1_51_fbyrbv64<span class="number">_</span>.arc</span>
</pre></td></tr></table></figure></p>
<p>离线6号文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> FILE<span class="comment">#, CREATION_CHANGE#,CHECKPOINT_CHANGE#,UNRECOVERABLE_CHANGE#,LAST_CHANGE#,OFFLINE_CHANGE#,STATUS </span></span>
<span class="line">  from v$datafile order by <span class="number">1</span>;</span>
<span class="line"></span>
<span class="line">     FILE<span class="comment"># CREATION_CHANGE# CHECKPOINT_CHANGE# UNRECOVERABLE_CHANGE# LAST_CHANGE# OFFLINE_CHANGE# STATUS</span></span>
<span class="line">---------- ---------------- ------------------ --------------------- ------------ --------------- -------</span>
<span class="line">         <span class="number">1</span>                <span class="number">7</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> SYSTEM</span>
<span class="line">         <span class="number">2</span>             <span class="number">1834</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> ONLINE</span>
<span class="line">         <span class="number">3</span>           <span class="number">923328</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> ONLINE</span>
<span class="line">         <span class="number">4</span>            <span class="number">16143</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> ONLINE</span>
<span class="line">         <span class="number">5</span>          <span class="number">2959979</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> ONLINE</span>
<span class="line">         <span class="number">6</span>          <span class="number">3570623</span>            <span class="number">3571679</span>                     <span class="number">0</span>                            <span class="number">0</span> ONLINE</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database datafile <span class="number">6</span> offline;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> FILE<span class="comment">#, CREATION_CHANGE#,CHECKPOINT_CHANGE#,UNRECOVERABLE_CHANGE#,LAST_CHANGE#,OFFLINE_CHANGE#,STATUS </span></span>
<span class="line">  from v$datafile order by <span class="number">1</span>;</span>
<span class="line"></span>
<span class="line">     FILE<span class="comment"># CREATION_CHANGE# CHECKPOINT_CHANGE# UNRECOVERABLE_CHANGE# LAST_CHANGE# OFFLINE_CHANGE# STATUS</span></span>
<span class="line">---------- ---------------- ------------------ --------------------- ------------ --------------- -------</span>
<span class="line">         <span class="number">1</span>                <span class="number">7</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> SYSTEM</span>
<span class="line">         <span class="number">2</span>             <span class="number">1834</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> ONLINE</span>
<span class="line">         <span class="number">3</span>           <span class="number">923328</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> ONLINE</span>
<span class="line">         <span class="number">4</span>            <span class="number">16143</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> ONLINE</span>
<span class="line">         <span class="number">5</span>          <span class="number">2959979</span>            <span class="number">3571679</span>                     <span class="number">0</span>                      <span class="number">2985399</span> ONLINE</span>
<span class="line">         <span class="number">6</span>          <span class="number">3570623</span>            <span class="number">3571679</span>                     <span class="number">0</span>      <span class="number">3572789</span>               <span class="number">0</span> RECOVER</span>
</pre></td></tr></table></figure></p>
<blockquote>
<p>archivelog模式下，当数据文件offline时，其对应的数据文件头stop scn会更新，同时controlfile中该datafile的stop scn信息也会更新，此时也会更新offline scn，并且offline scn等于stop scn。</p>
</blockquote>
<p>对6号文件进行还原<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rman target /</span>
<span class="line">RMAN&gt; restore datafile <span class="number">6</span>;</span>
<span class="line"></span>
<span class="line">Starting restore at <span class="number">2018</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">15</span>:<span class="number">49</span>:<span class="number">54</span></span>
<span class="line">using channel ORA_DISK_1</span>
<span class="line"></span>
<span class="line">channel ORA_DISK_1: starting datafile backup set restore</span>
<span class="line">channel ORA_DISK_1: specifying datafile(<span class="keyword">s</span>) to restore from backup set</span>
<span class="line">channel ORA_DISK_1: restoring datafile <span class="number">00006</span> to /u01/app/oracle/oradata/orcl/skip_arch01.dbf</span>
<span class="line">channel ORA_DISK_1: reading from backup piece /oradata/rmanbackup/datafile5_05su6blm_1_1</span>
<span class="line">channel ORA_DISK_1: piece handle=<span class="regexp">/oradata/rmanbackup</span><span class="regexp">/datafile5_05su6blm_1_1 tag=TAG20180319T145901</span>
<span class="line">channel ORA_DISK_1: restored backup piece 1</span>
<span class="line">channel ORA_DISK_1: restore complete, elapsed time: 00:00:03</span>
<span class="line">Finished restore at 2018-03-19 15:49:57</span></span>
</pre></td></tr></table></figure></p>
<p>6号数据文件无法被online<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter database datafile <span class="number">6</span> online;</span>
<span class="line">alter database datafile <span class="number">6</span> online</span>
<span class="line">*</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">01113</span>: file <span class="number">6</span> needs media recovery</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">6</span>: <span class="string">'/u01/app/oracle/oradata/orcl/skip_arch01.dbf'</span></span>
</pre></td></tr></table></figure></p>
<p>对6号文件进行恢复时因归档丢失报错<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">RMAN&gt; recover datafile <span class="number">6</span>;</span>
<span class="line"></span>
<span class="line">Starting recover at <span class="number">2018</span>-<span class="number">03</span>-<span class="number">19</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">03</span></span>
<span class="line">using channel ORA_DISK_1</span>
<span class="line"></span>
<span class="line">starting media recovery</span>
<span class="line"></span>
<span class="line">archived <span class="keyword">log</span> <span class="keyword">for</span> thread <span class="number">1</span> with sequence <span class="number">46</span> is already on disk as file /u01/app/oracle/fast_recovery_area/ORCL/archivelog/<span class="number">2018_03_19</span>/o1_mf_1_46_fbyrbkbz<span class="number">_</span>.arc</span>
<span class="line">archived <span class="keyword">log</span> <span class="keyword">for</span> thread <span class="number">1</span> with sequence <span class="number">47</span> is already on disk as file /u01/app/oracle/fast_recovery_area/ORCL/archivelog/<span class="number">2018_03_19</span>/o1_mf_1_47_fbyrbmnn<span class="number">_</span>.arc</span>
<span class="line">archived <span class="keyword">log</span> <span class="keyword">for</span> thread <span class="number">1</span> with sequence <span class="number">50</span> is already on disk as file /u01/app/oracle/fast_recovery_area/ORCL/archivelog/<span class="number">2018_03_19</span>/o1_mf_1_50_fbyrbt9w<span class="number">_</span>.arc</span>
<span class="line">archived <span class="keyword">log</span> <span class="keyword">for</span> thread <span class="number">1</span> with sequence <span class="number">51</span> is already on disk as file /u01/app/oracle/fast_recovery_area/ORCL/archivelog/<span class="number">2018_03_19</span>/o1_mf_1_51_fbyrbv64<span class="number">_</span>.arc</span>
<span class="line">RMAN-<span class="number">00571</span>: ===========================================================</span>
<span class="line">RMAN-<span class="number">0056</span>9: =============== ERROR MESSAGE STACK FOLLOWS ===============</span>
<span class="line">RMAN-<span class="number">00571</span>: ===========================================================</span>
<span class="line">RMAN-<span class="number">03002</span>: failure of recover command at <span class="number">03</span>/<span class="number">19</span>/<span class="number">2018</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">03</span></span>
<span class="line">RMAN-<span class="number">06053</span>: unable to perform media recovery because of missing <span class="keyword">log</span></span>
<span class="line">RMAN-<span class="number">06025</span>: <span class="keyword">no</span> backup of archived <span class="keyword">log</span> <span class="keyword">for</span> thread <span class="number">1</span> with sequence <span class="number">49</span> <span class="keyword">and</span> starting SCN of <span class="number">3571670</span> found to restore</span>
<span class="line">RMAN-<span class="number">06025</span>: <span class="keyword">no</span> backup of archived <span class="keyword">log</span> <span class="keyword">for</span> thread <span class="number">1</span> with sequence <span class="number">48</span> <span class="keyword">and</span> starting SCN of <span class="number">3571667</span> found to restore</span>
</pre></td></tr></table></figure></p>
<h3 id="跳归档恢复"><a href="#跳归档恢复" class="headerlink" title="跳归档恢复"></a>跳归档恢复</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 归档序列48、49已丢失，从50开始恢复</span></span>
<span class="line"><span class="keyword">select</span> to_char(SEQUENCE<span class="comment">#,'xxxxxxxxxxx') seq，</span></span>
<span class="line">       to_char(FIRST_CHANGE<span class="comment">#,'xxxxxxxxxxx') scn</span></span>
<span class="line">  from v$archived_log where SEQUENCE<span class="comment">#=50;</span></span>
<span class="line"></span>
<span class="line">SEQ          SCN</span>
<span class="line">------------ ------------</span>
<span class="line">          <span class="number">32</span>       <span class="number">367</span>fd9     <span class="comment"># d97f3600</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 把上面的值更新到6号文件头</span></span>
<span class="line">BBED&gt; info</span>
<span class="line"> File<span class="comment">#  Name                                                        Size(blks)</span></span>
<span class="line"> -----  ----                                                        ----------</span>
<span class="line">     <span class="number">1</span>  /u01/app/oracle/oradata/orcl/system01.dbf                        <span class="number">97281</span></span>
<span class="line">     <span class="number">2</span>  /u01/app/oracle/oradata/orcl/sysaux01.dbf                        <span class="number">96001</span></span>
<span class="line">     <span class="number">3</span>  /u01/app/oracle/oradata/orcl/undotbs01.dbf                       <span class="number">21121</span></span>
<span class="line">     <span class="number">4</span>  /u01/app/oracle/oradata/orcl/users01.dbf                           <span class="number">641</span></span>
<span class="line">     <span class="number">5</span>  /u01/app/oracle/oradata/orcl/dsi01.dbf                           <span class="number">64001</span></span>
<span class="line">     <span class="number">6</span>  /u01/app/oracle/oradata/orcl/skip_arch01.dbf                      <span class="number">6400</span></span>
<span class="line"></span>
<span class="line">BBED&gt; set file <span class="number">6</span> block <span class="number">1</span></span>
<span class="line">        FILE<span class="comment">#           6</span></span>
<span class="line">        BLOCK<span class="comment">#          1</span></span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">map</span> /v</span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">1</span>                                     Dba:<span class="number">0x01800001</span></span>
<span class="line">------------------------------------------------------------</span>
<span class="line"> Data File Header</span>
<span class="line"></span>
<span class="line"> struct kcvfh, <span class="number">860</span> bytes                    @0       </span>
<span class="line">    struct kcvfhbfh, <span class="number">20</span> bytes               @0       </span>
<span class="line">    struct kcvfhhdr, <span class="number">76</span> bytes               @20      </span>
<span class="line">    ub4 kcvfhrdb                            @96      </span>
<span class="line">    struct kcvfhcrs, <span class="number">8</span> bytes                @100     </span>
<span class="line">    ub4 kcvfhcrt                            @108     </span>
<span class="line">    ub4 kcvfhrlc                            @112     </span>
<span class="line">    struct kcvfhrls, <span class="number">8</span> bytes                @116     </span>
<span class="line">    ub4 kcvfhbti                            @124     </span>
<span class="line">    struct kcvfhbsc, <span class="number">8</span> bytes                @128     </span>
<span class="line">    ub2 kcvfhbth                            @136     </span>
<span class="line">    ub2 kcvfhsta                            @138     </span>
<span class="line">    struct kcvfhckp, <span class="number">36</span> bytes               @484      <span class="comment">##</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">BBED&gt; p kcvfhckp</span>
<span class="line">struct kcvfhckp, <span class="number">36</span> bytes                   @484     </span>
<span class="line">   struct kcvcpscn, <span class="number">8</span> bytes                 @484      <span class="comment">## SCN</span></span>
<span class="line">      ub4 kscnbas                           @484      <span class="number">0x00367eb2</span></span>
<span class="line">      ub2 kscnwrp                           @488      <span class="number">0x0000</span></span>
<span class="line">   ub4 kcvcptim                             @492      <span class="number">0x39e32eb6</span></span>
<span class="line">   ub2 kcvcpthr                             @496      <span class="number">0x0001</span></span>
<span class="line">   union u, <span class="number">12</span> bytes                        @500     </span>
<span class="line">      struct kcvcprba, <span class="number">12</span> bytes             @500     </span>
<span class="line">         ub4 kcrbaseq                       @500      <span class="number">0x0000002e</span>   <span class="comment">## SEQ</span></span>
<span class="line">         ub4 kcrbabno                       @504      <span class="number">0x00009623</span></span>
<span class="line">         ub2 kcrbabof                       @508      <span class="number">0x0010</span></span>
<span class="line">   ub1 kcvcpetb[<span class="number">0</span>]                          @512      <span class="number">0x02</span></span>
<span class="line">   ub1 kcvcpetb[<span class="number">1</span>]                          @513      <span class="number">0x00</span></span>
<span class="line">   ub1 kcvcpetb[<span class="number">2</span>]                          @514      <span class="number">0x00</span></span>
<span class="line">   ub1 kcvcpetb[<span class="number">3</span>]                          @515      <span class="number">0x00</span></span>
<span class="line">   ub1 kcvcpetb[<span class="number">4</span>]                          @516      <span class="number">0x00</span></span>
<span class="line">   ub1 kcvcpetb[<span class="number">5</span>]                          @517      <span class="number">0x00</span></span>
<span class="line">   ub1 kcvcpetb[<span class="number">6</span>]                          @518      <span class="number">0x00</span></span>
<span class="line">   ub1 kcvcpetb[<span class="number">7</span>]                          @519      <span class="number">0x00</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改SCN</span></span>
<span class="line">BBED&gt; <span class="keyword">dump</span> /v offset <span class="number">484</span> count <span class="number">32</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">1</span>       Offsets:  <span class="number">484</span> to  <span class="number">515</span>  Dba:<span class="number">0x01800001</span></span>
<span class="line">-------------------------------------------------------</span>
<span class="line"> b27e360<span class="number">0</span> <span class="number">00000000</span> b62ee339 <span class="number">01000000</span> l .~<span class="number">6</span>........<span class="number">9</span>....</span>
<span class="line"> <span class="number">2</span>e00000<span class="number">0</span> <span class="number">23960000</span> <span class="number">1000774</span>a <span class="number">02000000</span> l ....<span class="comment">#.....wJ....</span></span>
<span class="line"></span>
<span class="line"> &lt;<span class="number">16</span> bytes per line&gt;</span>
<span class="line"></span>
<span class="line">BBED&gt; modify /<span class="keyword">x</span> d9 offset <span class="number">484</span></span>
<span class="line">Warning: contents of previous BIFILE will be lost. Proceed? (Y/N) <span class="keyword">y</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">1</span>                Offsets:  <span class="number">484</span> to  <span class="number">515</span>           Dba:<span class="number">0x01800001</span></span>
<span class="line">------------------------------------------------------------------------</span>
<span class="line"> d97e360<span class="number">0</span> <span class="number">00000000</span> b62ee339 <span class="number">01000000</span> <span class="number">2</span>e00000<span class="number">0</span> <span class="number">23960000</span> <span class="number">1000774</span>a <span class="number">02000000</span> </span>
<span class="line"></span>
<span class="line"> &lt;<span class="number">32</span> bytes per line&gt;</span>
<span class="line"></span>
<span class="line">BBED&gt; modify /<span class="keyword">x</span> <span class="number">7</span>f360<span class="number">0</span> offset <span class="number">485</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">1</span>                Offsets:  <span class="number">485</span> to  <span class="number">516</span>           Dba:<span class="number">0x01800001</span></span>
<span class="line">------------------------------------------------------------------------</span>
<span class="line"> <span class="number">7</span>f36000<span class="number">0</span> <span class="number">000000</span>b6 <span class="number">2</span>ee33901 <span class="number">0000002</span>e <span class="number">00000023</span> <span class="number">96000010</span> <span class="number">00774</span>a02 <span class="number">00000000</span> </span>
<span class="line"></span>
<span class="line"> &lt;<span class="number">32</span> bytes per line&gt;</span>
<span class="line"></span>
<span class="line">BBED&gt; sum apply</span>
<span class="line">Check value <span class="keyword">for</span> File <span class="number">6</span>, Block <span class="number">1</span>:</span>
<span class="line">current = <span class="number">0xc392</span>, required = <span class="number">0xc392</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改SEQ</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> to_number(<span class="string">'2e'</span>,<span class="string">'xxxxxxxxxxxxxxxxx'</span>) from dual;</span>
<span class="line"></span>
<span class="line">TO_NUMBER(<span class="string">'2E'</span>,<span class="string">'XXXXXXXXXXXXXXXXX'</span>)</span>
<span class="line">-----------------------------------</span>
<span class="line">                                 <span class="number">46</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> to_char(<span class="number">50</span>,<span class="string">'xxxxxxxxx'</span>) from dual;</span>
<span class="line"></span>
<span class="line">TO_CHAR(<span class="number">50</span></span>
<span class="line">----------</span>
<span class="line">        <span class="number">32</span></span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">dump</span> /v offset <span class="number">500</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">1</span>       Offsets:  <span class="number">500</span> to  <span class="number">531</span>  Dba:<span class="number">0x01800001</span></span>
<span class="line">-------------------------------------------------------</span>
<span class="line"> <span class="number">2</span>e00000<span class="number">0</span> <span class="number">23960000</span> <span class="number">1000774</span>a <span class="number">02000000</span> l ....<span class="comment">#.....wJ....</span></span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> l ................</span>
<span class="line"></span>
<span class="line"> &lt;<span class="number">16</span> bytes per line&gt;</span>
<span class="line"></span>
<span class="line">BBED&gt; modify /<span class="keyword">x</span> <span class="number">32</span> offset <span class="number">500</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">1</span>                Offsets:  <span class="number">500</span> to  <span class="number">531</span>           Dba:<span class="number">0x01800001</span></span>
<span class="line">------------------------------------------------------------------------</span>
<span class="line"> <span class="number">32000000</span> <span class="number">23960000</span> <span class="number">1000774</span>a <span class="number">02000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"></span>
<span class="line"> &lt;<span class="number">32</span> bytes per line&gt;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改块号</span></span>
<span class="line">BBED&gt; <span class="keyword">dump</span> /v offset <span class="number">504</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">1</span>       Offsets:  <span class="number">504</span> to  <span class="number">535</span>  Dba:<span class="number">0x01800001</span></span>
<span class="line">-------------------------------------------------------</span>
<span class="line"> <span class="number">23960000</span> <span class="number">1000774</span>a <span class="number">02000000</span> <span class="number">00000000</span> l <span class="comment">#.....wJ........</span></span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> l ................</span>
<span class="line"></span>
<span class="line"> &lt;<span class="number">16</span> bytes per line&gt;</span>
<span class="line"></span>
<span class="line">BBED&gt; modify /<span class="keyword">x</span> <span class="number">0100</span> offset <span class="number">504</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/skip</span>_arch01.dbf (<span class="number">6</span>)</span>
<span class="line"> Block: <span class="number">1</span>                Offsets:  <span class="number">504</span> to  <span class="number">535</span>           Dba:<span class="number">0x01800001</span></span>
<span class="line">------------------------------------------------------------------------</span>
<span class="line"> <span class="number">01000000</span> <span class="number">1000774</span>a <span class="number">02000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"></span>
<span class="line">BBED&gt; sum apply</span>
<span class="line">Check value <span class="keyword">for</span> File <span class="number">6</span>, Block <span class="number">1</span>:</span>
<span class="line">current = <span class="number">0x55ac</span>, required = <span class="number">0x55ac</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 之后6号数据文件在recover后就可以online</span></span>
<span class="line">SQL&gt; recover datafile <span class="number">6</span>;</span>
<span class="line">Media recovery complete.</span>
<span class="line">SQL&gt; alter database datafile <span class="number">6</span> online;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
</pre></td></tr></table></figure>
<h2 id="datafile的status有哪些"><a href="#datafile的status有哪些" class="headerlink" title="datafile的status有哪些"></a>datafile的status有哪些</h2><p>datafile的status：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">KCCFEFDB 0x0001 /* file read-only, plugged from foreign DB */</span>
<span class="line">KCCFEONL 0x0002 /* file is ONLine */</span>
<span class="line">KCCFERDE 0x0004 /* ReaDing is Enabled */</span>
<span class="line">KCCFECGE 0x0008 /* ChanGing is Enabled */</span>
<span class="line">KCCFEMRR 0x0010 /* Media Recovery Required */</span>
<span class="line">KCCFEGEM 0x0020 /* Generate End hot backup Marker at next open */</span>
<span class="line">KCCFECKD 0x0040 /* File record generated by check dictionary */</span>
<span class="line">KCCFESOR 0x0080 /* Save Offline scn Range at next checkpoint */</span>
<span class="line">KCCFERMF 0x0100 /* Renamed Missing File */</span>
<span class="line">KCCFEGOI 0x0200 /* Generate Off-line Immediate marker */</span>
<span class="line">KCCFECUV 0x0400 /* Checkpoint by instance where UnVerified */</span>
<span class="line">KCCFEDRP 0x0800 /* offline to be DRoPped */</span>
<span class="line">KCCFEODC 0x2000 /* Online at Dictionary Check if read/only tblspc */</span>
<span class="line">KCCFEDBR 0x4000 /* entry created by DBMS_BACKUP_RESTORE */</span>
<span class="line">KCCFETRO 0x8000 /* Transition Read Only */define KCCFEWCC 0x1000 /*</span>
</pre></td></tr></table></figure></p>
<p>示例<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">DATA FILE <span class="comment">#1: </span></span>
<span class="line">  name <span class="comment">#8: /u01/app/oracle/oradata/orcl/system01.dbf</span></span>
<span class="line">creation size=<span class="number">0</span> block size=<span class="number">8192</span> status=<span class="number">0xe</span> head=<span class="number">8</span> tail=<span class="number">8</span> dup=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="number">0xe</span> = <span class="number">0x8</span> + <span class="number">0x4</span> + <span class="number">0x2</span></span>
<span class="line">Change/Write + Read + <span class="string">Online =&gt;</span> Normal status of <span class="keyword">open</span> files</span>
</pre></td></tr></table></figure></p>
<h2 id="详解检查点的结构"><a href="#详解检查点的结构" class="headerlink" title="详解检查点的结构"></a>详解检查点的结构</h2><p>通过Data File Header Dump，可以从dump出的trace文件看到检查点最核心的结构，<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">Checkpointed at scn:  <span class="number">0x0000</span>.<span class="number">0036</span>b8dd <span class="number">03</span>/<span class="number">19</span>/<span class="number">2018</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">37</span></span>
<span class="line"> thread:<span class="number">1</span> rba:(<span class="number">0x35</span>.<span class="number">2.10</span>)</span>
<span class="line"> enabled  threads:  <span class="number">01000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span>
<span class="line"></span>
<span class="line">SCN：<span class="number">0x0000</span>.<span class="number">0036</span>b8dd <span class="number">03</span>/<span class="number">19</span>/<span class="number">2018</span> <span class="number">22</span>:<span class="number">00</span>:<span class="number">37</span> 时间 </span>
<span class="line">RBA：日志的地址（<span class="keyword">log</span> sequence number + block number + 偏移量）</span>
<span class="line">THREAD：线程，<span class="number">1</span>单实例</span>
</pre></td></tr></table></figure></p>
<h2 id="其他内容"><a href="#其他内容" class="headerlink" title="其他内容"></a>其他内容</h2><p>Data File Header Dump<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter session set events <span class="string">'immediate trace name file_hdrs level &lt;n&gt;'</span>;</span>
<span class="line">如：</span>
<span class="line">alter session set events <span class="string">'immediate trace name file_hdrs level 10'</span>;</span>
</pre></td></tr></table></figure></p>
<p>level<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">level 1: control file&apos;s data file entry</span>
<span class="line">level 2 &amp; 4 : level 1 + generic file header</span>
<span class="line">level 3 or higher: level 2 + data file header</span>
<span class="line">level 10: Most commonly used, It provides the same output as level 3.</span>
</pre></td></tr></table></figure></p>
<p>File Type<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">KCCTYPCF <span class="number">1</span> /* control file *<span class="regexp">/</span>
<span class="line">KCCTYPRL 2 /</span>* <span class="keyword">redo</span> <span class="keyword">log</span> file *<span class="regexp">/</span>
<span class="line">KCCTYPDF 3 /</span>* vanilla db file *<span class="regexp">/</span>
<span class="line">KCCTYPBC 4 /</span>* backup control file *<span class="regexp">/</span>
<span class="line">KCCTYPBP 5 /</span>* backup piece *<span class="regexp">/</span>
<span class="line">KCCTYPTF 6 /</span>* temporary db file *<span class="regexp">/</span>
<span class="line">KCCTYPCT 7 /</span>* change tracking file *<span class="regexp">/</span>
<span class="line">KCCTYPFL 8 /</span>* flashback database <span class="keyword">log</span> file *<span class="regexp">/</span>
<span class="line">KCCTYPAL 9 /</span>* archivelog file *<span class="regexp">/</span>
<span class="line">KCCTYPDC 10 /</span>* datafile copy file *<span class="regexp">/</span>
<span class="line">KCCTYPIR 11 /</span>* incompletely restored db file *<span class="regexp">/</span>
<span class="line">KCCTYPEL 12 /</span>* foreign archivelog file *<span class="regexp">/</span>
<span class="line">KCCTYPLB 13 /</span>* LOB *<span class="regexp">/</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> Oracle特殊恢复原理与实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> DSI </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle特殊恢复原理与实战_03 Control file深入内部解析]]></title>
      <url>/2018/03/10/oracle/Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/03_Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%85%A5%E9%97%A8/</url>
      <content type="html"><![CDATA[<h2 id="Control-file-dump"><a href="#Control-file-dump" class="headerlink" title="Control file: dump"></a>Control file: dump</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter session set events <span class="string">'immediate trace name controlf level &lt;n&gt;'</span>;</span>
<span class="line">如：</span>
<span class="line">alter session set events <span class="string">'immediate trace name controlf level 1'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 通过以下命令查看dump trace文件的位置</span></span>
<span class="line"><span class="keyword">select</span> * from v$diag_info where NAME=<span class="string">'Default Trace File'</span>;</span>
</pre></td></tr></table></figure>
<blockquote>
<p>level <n>:<br>level 1: Generic File Header<br>Level 2: Level 1 + database information + database entry + check point<br>         progress records + Extended database entry<br>level 3 or Higher&lt; 9: level 2 + reuse record section<br>level 10: Memory dump of all the control file logical blocks</n></p>
</blockquote>
<a id="more"></a>
<h2 id="Control-file-file-header"><a href="#Control-file-file-header" class="headerlink" title="Control file: file header"></a>Control file: file header</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter session set events <span class="string">'immediate trace name controlf level 1'</span>;</span>
<span class="line"><span class="keyword">select</span> * from v$diag_info where NAME=<span class="string">'Default Trace File'</span>; </span>
<span class="line"></span>
<span class="line"><span class="keyword">dump</span> trace:</span>
<span class="line">DUMP OF CONTROL FILES, Seq <span class="comment"># 28874 = 0x70ca</span></span>
<span class="line"> V1<span class="number">0</span> STYLE FILE HEADER:</span>
<span class="line">        Compatibility Vsn = <span class="number">186647552</span>=<span class="number">0xb200400</span>     <span class="comment"># 数据库版本 11.2.0.4</span></span>
<span class="line">        Db ID=<span class="number">1493347395</span>=<span class="number">0x5902ac43</span>, Db Name=<span class="string">'ORCL'</span></span>
<span class="line">        Activation ID=<span class="number">0</span>=<span class="number">0x0</span></span>
<span class="line">        Control Seq=<span class="number">28874</span>=<span class="number">0x70ca</span>, File size=<span class="number">614</span>=<span class="number">0x266</span>  <span class="comment"># 控制文件大小</span></span>
<span class="line">        File Number=<span class="number">0</span>, Blksiz=<span class="number">16384</span>, File Type=<span class="number">1</span> CONTROL</span>
<span class="line"></span>
<span class="line"><span class="comment"># Seq</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> CONTROLFILE_SEQUENCE<span class="comment"># from v$database;</span></span>
<span class="line"></span>
<span class="line">CONTROLFILE_SEQUENCE<span class="comment">#</span></span>
<span class="line">---------------------</span>
<span class="line">                <span class="number">28875</span></span>
</pre></td></tr></table></figure>
<h2 id="Control-file-DATABASE-ENTRY"><a href="#Control-file-DATABASE-ENTRY" class="headerlink" title="Control file: DATABASE ENTRY"></a>Control file: DATABASE ENTRY</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter session set events <span class="string">'immediate trace name controlf level 2'</span>;</span>
<span class="line"><span class="keyword">select</span> * from v$diag_info where NAME=<span class="string">'Default Trace File'</span>; </span>
<span class="line"></span>
<span class="line"><span class="keyword">dump</span> trace:</span>
<span class="line">***************************************************************************</span>
<span class="line">DATABASE ENTRY</span>
<span class="line">***************************************************************************</span>
<span class="line"> (size = <span class="number">316</span>, compat size = <span class="number">316</span>, section max = <span class="number">1</span>, section in-<span class="keyword">use</span> = <span class="number">1</span>,</span>
<span class="line">  <span class="keyword">last</span>-recid= <span class="number">0</span>, old-recno = <span class="number">0</span>, <span class="keyword">last</span>-recno = <span class="number">0</span>)</span>
<span class="line"> (extent = <span class="number">1</span>, blkno = <span class="number">1</span>, numrecs = <span class="number">1</span>)</span>
<span class="line"> <span class="number">02</span>/<span class="number">26</span>/<span class="number">2018</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">45</span></span>
<span class="line"> DB Name <span class="string">"ORCL"</span></span>
<span class="line"> Database flags = <span class="number">0x00404001</span> <span class="number">0x00001200</span></span>
<span class="line"> Controlfile Creation Timestamp  <span class="number">02</span>/<span class="number">26</span>/<span class="number">2018</span> <span class="number">17</span>:<span class="number">12</span>:<span class="number">46</span></span>
<span class="line"> Incmplt recovery scn: <span class="number">0x0000</span>.<span class="number">00000000</span></span>
<span class="line"> Resetlogs scn: <span class="number">0x0000</span>.<span class="number">002</span>d8db8 Resetlogs Timestamp  <span class="number">02</span>/<span class="number">26</span>/<span class="number">2018</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">23</span></span>
<span class="line"> Prior resetlogs scn: <span class="number">0x0000</span>.<span class="number">002</span>d3346 Prior resetlogs Timestamp  <span class="number">02</span>/<span class="number">26</span>/<span class="number">2018</span> <span class="number">14</span>:<span class="number">33</span>:<span class="number">26</span></span>
<span class="line"> Redo Version: compatible=<span class="number">0xb200400</span></span>
<span class="line"> <span class="comment">#Data files = 7, #Online files = 7</span></span>
<span class="line"> Database checkpoint: Thread=<span class="number">1</span> scn: <span class="number">0x0000</span>.<span class="number">00370</span>ab3</span>
<span class="line"> Threads: <span class="comment">#Enabled=1, #Open=1, Head=1, Tail=1</span></span>
<span class="line"> enabled  threads:  <span class="number">01000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span></span>
<span class="line">...</span>
<span class="line"></span>
<span class="line"><span class="comment">#Database flags : 当前数据库的状态</span></span>
<span class="line">    KCCDIMRE <span class="number">0x00000001</span> whether media recovery enabled(that is: ARCHIVELOG mode)  <span class="comment">#</span></span>
<span class="line">    KCCDICKD <span class="number">0x00000002</span> <span class="keyword">if</span> dictionary must be checked with control file</span>
<span class="line">    KCCDIRLR <span class="number">0x00000004</span> DB OPEN RESETLOGS required</span>
<span class="line">    KCCDIJNK <span class="number">0x00000008</span> (junk value from beta)</span>
<span class="line">    KCCDIMRC <span class="number">0x00000010</span> was/is <span class="keyword">last</span> mounted READ_COMPATIBLE</span>
<span class="line">    KCCDICNV <span class="number">0x00000020</span> controlfile was just created by convert from v6</span>
<span class="line">    KCCDIIRA <span class="number">0x00000040</span> Incomplete Recovery Allowed <span class="keyword">when</span> resetting logs</span>
<span class="line">    KCCDICCF <span class="number">0x00000100</span> Controlfile was created with CREATE CONTROLFILE</span>
<span class="line">    KCCDIINV <span class="number">0x00000200</span> Invalid control file <span class="keyword">or</span> database; still creating</span>
<span class="line">    KCCDISBD <span class="number">0x00000400</span> StandBy Database; control file <span class="keyword">for</span> hot standby</span>
<span class="line">    KCCDIORL <span class="number">0x00000800</span> Opened ResetLogs; set <span class="keyword">until</span> dictionary check</span>
<span class="line">    KCCDICFC <span class="number">0x00001000</span> valid ControlFile Checkpoint in backup cf</span>
<span class="line">    KCCDISSN <span class="number">0x00002000</span> SnapShot controlfile fileName pointer valid</span>
<span class="line">    KCCDIUCD <span class="number">0x00004000</span> lazy file header Update Checkpoint cycle Done  <span class="comment">#</span></span>
<span class="line">    KCCDICLO <span class="number">0x00008000</span> clone database</span>
<span class="line">    KCCDINDL <span class="number">0x00010000</span> standby database No Data Loss</span>
<span class="line">    KCCDISPK <span class="number">0x00020000</span> Supplemental <span class="keyword">log</span> primary <span class="keyword">keys</span></span>
<span class="line">    KCCDISUI <span class="number">0x00040000</span> Supplemental <span class="keyword">log</span> unique indexes</span>
<span class="line">    KCCDISFK <span class="number">0x00080000</span> Supplemental <span class="keyword">log</span> foreign <span class="keyword">keys</span></span>
<span class="line">    KCCDIGDA <span class="number">0x00100000</span> Database guard all</span>
<span class="line">    KCCDIGDS <span class="number">0x00200000</span> Database guard standby data</span>
<span class="line">    KCCDIIMR <span class="number">0x00400000</span> Group Membership Recovery is supported   <span class="comment">#</span></span>
<span class="line">    KCCDIEAR <span class="number">0x00800000</span> End-of-<span class="keyword">redo</span> Archival Received</span>
<span class="line">    KCCDISTR <span class="number">0x01000000</span> Standby Terminal Recovery</span>
<span class="line">    KCCDILSB <span class="number">0x02000000</span> Logical StandBy database</span>
<span class="line"></span>
<span class="line">Database flags = <span class="number">0x00404001</span> = KCCDIIMR + KCCDIUCD + KCCDIMRE</span>
<span class="line"></span>
<span class="line"><span class="comment"># 一般控制文件的检查点要比数据库的检查点大一些</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> CONTROLFILE_CHANGE<span class="comment">#, CHECKPOINT_CHANGE# from v$database;</span></span>
<span class="line"></span>
<span class="line">CONTROLFILE_CHANGE<span class="comment"># CHECKPOINT_CHANGE#</span></span>
<span class="line">------------------- ------------------</span>
<span class="line">            <span class="number">3616799</span>            <span class="number">3607219</span></span>
</pre></td></tr></table></figure>
<h2 id="Control-file-PROGRESS-RECORDS"><a href="#Control-file-PROGRESS-RECORDS" class="headerlink" title="Control file: PROGRESS RECORDS"></a>Control file: PROGRESS RECORDS</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">***************************************************************************</span>
<span class="line">CHECKPOINT PROGRESS RECORDS</span>
<span class="line">***************************************************************************</span>
<span class="line"> (size = <span class="number">8180</span>, compat size = <span class="number">8180</span>, section max = <span class="number">11</span>, section in-<span class="keyword">use</span> = <span class="number">0</span>,</span>
<span class="line">  <span class="keyword">last</span>-recid= <span class="number">0</span>, old-recno = <span class="number">0</span>, <span class="keyword">last</span>-recno = <span class="number">0</span>)</span>
<span class="line"> (extent = <span class="number">1</span>, blkno = <span class="number">2</span>, numrecs = <span class="number">11</span>)</span>
<span class="line">THREAD <span class="comment">#1 - status:0x2 flags:0x0 dirty:30</span></span>
<span class="line">low cache rba:(<span class="number">0x36</span>.<span class="number">42</span>a6.<span class="number">0</span>) on disk rba:(<span class="number">0x36</span>.<span class="number">42</span>d3.<span class="number">0</span>)  <span class="comment"># 实例恢复时，启动数据库从low cache rba，到on disk rba结束</span></span>
<span class="line">on disk scn: <span class="number">0x0000</span>.<span class="number">00372</span>e55 <span class="number">03</span>/<span class="number">20</span>/<span class="number">2018</span> <span class="number">15</span>:<span class="number">46</span>:<span class="number">19</span></span>
<span class="line">resetlogs scn: <span class="number">0x0000</span>.<span class="number">002</span>d8db8 <span class="number">02</span>/<span class="number">26</span>/<span class="number">2018</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">23</span></span>
<span class="line">heartbeat: <span class="number">971215409</span> mount id: <span class="number">1498920122</span></span>
</pre></td></tr></table></figure>
<h2 id="Control-file-EXTENDED-DATABASE-ENTRY"><a href="#Control-file-EXTENDED-DATABASE-ENTRY" class="headerlink" title="Control file: EXTENDED DATABASE ENTRY"></a>Control file: EXTENDED DATABASE ENTRY</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">***************************************************************************</span>
<span class="line">EXTENDED DATABASE ENTRY</span>
<span class="line">***************************************************************************</span>
<span class="line"> (size = <span class="number">900</span>, compat size = <span class="number">900</span>, section max = <span class="number">1</span>, section in-<span class="keyword">use</span> = <span class="number">1</span>,</span>
<span class="line">  <span class="keyword">last</span>-recid= <span class="number">0</span>, old-recno = <span class="number">0</span>, <span class="keyword">last</span>-recno = <span class="number">0</span>)</span>
<span class="line"> (extent = <span class="number">1</span>, blkno = <span class="number">150</span>, numrecs = <span class="number">1</span>)</span>
<span class="line">Control AutoBackup date(dd/mm/yyyy)=<span class="number">26</span>/ <span class="number">2</span>/<span class="number">2018</span></span>
<span class="line">Next AutoBackup sequence= <span class="number">0</span></span>
<span class="line">Database recovery target inc<span class="comment">#:2, Last open inc#:2</span></span>
<span class="line">flg:<span class="number">0x0</span>, flag:<span class="number">0x0</span></span>
<span class="line">Change tracking <span class="keyword">state</span>=<span class="number">0</span>, file <span class="keyword">index</span>=<span class="number">0</span>, checkpoint count=0scn: <span class="number">0x0000</span>.<span class="number">00000000</span></span>
<span class="line">Flashback <span class="keyword">log</span> count=<span class="number">0</span>, block count=<span class="number">0</span></span>
<span class="line">Desired flashback <span class="keyword">log</span> size=<span class="number">0</span> blocks</span>
<span class="line">Oldest guarantee restore point=<span class="number">0</span></span>
<span class="line">Highest thread enable/disable scn: <span class="number">0x0000</span>.<span class="number">00000000</span></span>
<span class="line">Number of Open thread with finite <span class="keyword">next</span> SCN in <span class="keyword">last</span> <span class="keyword">log</span>: <span class="number">0</span></span>
<span class="line">Number of half-enabled <span class="keyword">redo</span> threads: <span class="number">0</span></span>
<span class="line">Sum of absolute file numbers <span class="keyword">for</span> files currently being moved online: <span class="number">0</span></span>
</pre></td></tr></table></figure>
<h2 id="课后作业"><a href="#课后作业" class="headerlink" title="课后作业"></a>课后作业</h2><p>1.数据文件5号文件头offset=1的a2代表什么意思？如何把5号文件的文件头offset=1的值a2变为c2(写出详细操作步骤，切不能用BBED修改)<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> * from v$dbfile where file<span class="comment">#=5;</span></span>
<span class="line"></span>
<span class="line">     FILE<span class="comment"># NAME</span></span>
<span class="line">---------- --------------------------------------------------</span>
<span class="line">         <span class="number">5</span> /u01/app/oracle/oradata/orcl/dsi01.dbf</span>
<span class="line"></span>
<span class="line">bbed</span>
<span class="line"></span>
<span class="line">BBED&gt; info</span>
<span class="line"> File<span class="comment">#  Name                                                        Size(blks)</span></span>
<span class="line"> -----  ----                                                        ----------</span>
<span class="line">     <span class="number">1</span>  /u01/app/oracle/oradata/orcl/system01.dbf                        <span class="number">97281</span></span>
<span class="line">     <span class="number">2</span>  /u01/app/oracle/oradata/orcl/sysaux01.dbf                        <span class="number">96001</span></span>
<span class="line">     <span class="number">3</span>  /u01/app/oracle/oradata/orcl/undotbs01.dbf                       <span class="number">21121</span></span>
<span class="line">     <span class="number">4</span>  /u01/app/oracle/oradata/orcl/users01.dbf                           <span class="number">641</span></span>
<span class="line">     <span class="number">5</span>  /u01/app/oracle/oradata/orcl/dsi01.dbf                           <span class="number">64001</span></span>
<span class="line">     <span class="number">6</span>  /u01/app/oracle/oradata/orcl/skip_arch01.dbf                      <span class="number">6400</span></span>
<span class="line"></span>
<span class="line">BBED&gt; set file <span class="number">5</span> block <span class="number">1</span></span>
<span class="line">        FILE<span class="comment">#           5</span></span>
<span class="line">        BLOCK<span class="comment">#          1</span></span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">dump</span> count <span class="number">32</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/dsi</span>01.dbf (<span class="number">5</span>)</span>
<span class="line"> Block: <span class="number">1</span>                Offsets:    <span class="number">0</span> to   <span class="number">31</span>           Dba:<span class="number">0x01400001</span></span>
<span class="line">------------------------------------------------------------------------</span>
<span class="line"> 0ba2000<span class="number">0</span> <span class="number">01004001</span> <span class="number">00000000</span> <span class="number">00000104</span> <span class="number">63</span>cf000<span class="number">0</span> <span class="number">00000000</span> <span class="number">0004200</span>b <span class="number">43</span>ac0259 </span>
<span class="line"></span>
<span class="line"></span>
<span class="line">BBED&gt; p kcvfhbfh</span>
<span class="line">struct kcvfhbfh, <span class="number">20</span> bytes                   @0       </span>
<span class="line">   ub1 type_kcbh                            @0        <span class="number">0x0b</span></span>
<span class="line">   ub1 frmt_kcbh                            @1        <span class="number">0xa2</span>   <span class="comment"># blocksize 8k</span></span>
<span class="line">   ub1 spare1_kcbh                          @2        <span class="number">0x00</span></span>
<span class="line">   ub1 spare2_kcbh                          @3        <span class="number">0x00</span></span>
<span class="line">   ub4 rdba_kcbh                            @4        <span class="number">0x01400001</span></span>
<span class="line">   ub4 bas_kcbh                             @8        <span class="number">0x00000000</span></span>
<span class="line">   ub2 wrp_kcbh                             @12       <span class="number">0x0000</span></span>
<span class="line">   ub1 seq_kcbh                             @14       <span class="number">0x01</span></span>
<span class="line">   ub1 flg_kcbh                             @15       <span class="number">0x04</span> (KCBHFCKV)</span>
<span class="line">   ub2 chkval_kcbh                          @16       <span class="number">0xcf63</span></span>
<span class="line">   ub2 spare3_kcbh                          @18       <span class="number">0x0000</span></span>
<span class="line"></span>
<span class="line">frmt_kcbh：块格式。不同版本，不同的文件，这个值也不一样</span>
<span class="line">Oracle <span class="number">6</span>,<span class="number">7</span> : <span class="number">0x01</span></span>
<span class="line"><span class="number">8</span>i~<span class="number">9</span>i:all: <span class="number">0x02</span></span>
<span class="line"><span class="number">10</span>g~<span class="number">12</span>c:<span class="number">2</span>k : <span class="number">0x62</span></span>
<span class="line"><span class="number">4</span>k : <span class="number">0x82</span></span>
<span class="line"><span class="number">8</span>k : <span class="number">0xa2</span></span>
<span class="line"><span class="number">16</span>k : <span class="number">0xc2</span>  </span>
<span class="line">Redo <span class="number">6</span>~<span class="number">12</span>c : <span class="number">0x22</span></span>
</pre></td></tr></table></figure></p>
<p>正常是无法修改已创建datafile块的大小，只能创建一个新的表空间，指定块大小为16k，最后把8k表空间的内容MOVE到16k的表空间中。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sqlplus / as sysdba</span>
<span class="line"></span>
<span class="line">SQL&gt; show parameter cache_size</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">client_result_cache_size             big integer <span class="number">0</span></span>
<span class="line">db_16k_cache_size                    big integer <span class="number">0</span></span>
<span class="line">db_2k_cache_size                     big integer <span class="number">0</span></span>
<span class="line">db_32k_cache_size                    big integer <span class="number">0</span></span>
<span class="line">db_4k_cache_size                     big integer <span class="number">0</span></span>
<span class="line">db_8k_cache_size                     big integer <span class="number">0</span></span>
<span class="line">db_cache_size                        big integer <span class="number">0</span></span>
<span class="line">db_flash_cache_size                  big integer <span class="number">0</span></span>
<span class="line">db_keep_cache_size                   big integer <span class="number">0</span></span>
<span class="line">db_recycle_cache_size                big integer <span class="number">0</span></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> set db_16k_cache_size = <span class="number">100</span>M;</span>
<span class="line"></span>
<span class="line">System altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; show parameter cache_size</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">client_result_cache_size             big integer <span class="number">0</span></span>
<span class="line">db_16k_cache_size                    big integer <span class="number">112</span>M</span>
<span class="line">db_2k_cache_size                     big integer <span class="number">0</span></span>
<span class="line">db_32k_cache_size                    big integer <span class="number">0</span></span>
<span class="line">db_4k_cache_size                     big integer <span class="number">0</span></span>
<span class="line">db_8k_cache_size                     big integer <span class="number">0</span></span>
<span class="line">db_cache_size                        big integer <span class="number">0</span></span>
<span class="line">db_flash_cache_size                  big integer <span class="number">0</span></span>
<span class="line">db_keep_cache_size                   big integer <span class="number">0</span></span>
<span class="line">db_recycle_cache_size                big integer <span class="number">0</span></span>
<span class="line">SQL&gt; create tablespace ts_16 blocksize <span class="number">16</span>k datafile <span class="string">'/u01/app/oracle/oradata/orcl/ts16_01.dbf'</span> size <span class="number">50</span><span class="keyword">m</span>;</span>
<span class="line"></span>
<span class="line">Tablespace created.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> file<span class="comment">#||chr(9)||name||chr(9)||bytes from v$datafile;</span></span>
<span class="line"></span>
<span class="line">FILE<span class="comment">#||CHR(9)||NAME||CHR(9)||BYTES</span></span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line"><span class="number">1</span>       /u01/app/oracle/oradata/orcl/system01.dbf       <span class="number">796917760</span></span>
<span class="line"><span class="number">2</span>       /u01/app/oracle/oradata/orcl/sysaux01.dbf       <span class="number">786432000</span></span>
<span class="line"><span class="number">3</span>       /u01/app/oracle/oradata/orcl/undotbs01.dbf      <span class="number">209715200</span></span>
<span class="line"><span class="number">4</span>       /u01/app/oracle/oradata/orcl/users01.dbf        <span class="number">5242880</span></span>
<span class="line"><span class="number">5</span>       /u01/app/oracle/oradata/orcl/dsi01.dbf  <span class="number">524288000</span></span>
<span class="line"><span class="number">6</span>       /u01/app/oracle/oradata/orcl/skip_arch01.dbf    <span class="number">52428800</span></span>
<span class="line"><span class="number">7</span>       /u01/app/oracle/oradata/orcl/ts16_01.dbf        <span class="number">52428800</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 新建的7号文件文件头offset=1的位置就是c2了</span></span>
<span class="line">echo <span class="string">"7 /u01/app/oracle/oradata/orcl/ts16_01.dbf 52428800"</span> &gt;&gt; filelist.txt</span>
<span class="line"></span>
<span class="line">bbed</span>
<span class="line"></span>
<span class="line">BBED&gt; info</span>
<span class="line"> File<span class="comment">#  Name                                                        Size(blks)</span></span>
<span class="line"> -----  ----                                                        ----------</span>
<span class="line">     <span class="number">1</span>  /u01/app/oracle/oradata/orcl/system01.dbf                        <span class="number">97281</span></span>
<span class="line">     <span class="number">2</span>  /u01/app/oracle/oradata/orcl/sysaux01.dbf                        <span class="number">96001</span></span>
<span class="line">     <span class="number">3</span>  /u01/app/oracle/oradata/orcl/undotbs01.dbf                       <span class="number">21121</span></span>
<span class="line">     <span class="number">4</span>  /u01/app/oracle/oradata/orcl/users01.dbf                           <span class="number">641</span></span>
<span class="line">     <span class="number">5</span>  /u01/app/oracle/oradata/orcl/dsi01.dbf                           <span class="number">64001</span></span>
<span class="line">     <span class="number">6</span>  /u01/app/oracle/oradata/orcl/skip_arch01.dbf                      <span class="number">6400</span></span>
<span class="line">     <span class="number">7</span>  /u01/app/oracle/oradata/orcl/ts16_01.dbf                          <span class="number">6400</span></span>
<span class="line"></span>
<span class="line">BBED&gt; set file <span class="number">7</span> block <span class="number">1</span></span>
<span class="line">        FILE<span class="comment">#           7</span></span>
<span class="line">        BLOCK<span class="comment">#          1</span></span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">dump</span> count <span class="number">32</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/ts</span>16_01.dbf (<span class="number">7</span>)</span>
<span class="line"> Block: <span class="number">1</span>                Offsets:    <span class="number">0</span> to   <span class="number">31</span>           Dba:<span class="number">0x01c00001</span></span>
<span class="line">------------------------------------------------------------------------</span>
<span class="line"> 0bc2000<span class="number">0</span> <span class="number">0100</span>c001 <span class="number">00000000</span> <span class="number">00000104</span> <span class="number">7</span>bd7000<span class="number">0</span> <span class="number">00000000</span> <span class="number">0004200</span>b <span class="number">43</span>ac0259</span>
</pre></td></tr></table></figure></p>
<p>2.Oracle实例恢复从low cache rba开始恢复，至少恢复到on disk rba，请用实验来证明？（给出详细操作步骤）<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">shutdown</span> abort;</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line">SQL&gt; startup mount</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">889193112</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3472883712</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">SQL&gt; alter session set events <span class="string">'immediate trace name controlf level 2'</span>;</span>
<span class="line"></span>
<span class="line">Session altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> * from v$diag_info where NAME=<span class="string">'Default Trace File'</span>; </span>
<span class="line"></span>
<span class="line">   INST_ID NAME</span>
<span class="line">---------- ----------------------------------------------------------------</span>
<span class="line">VALUE</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">         <span class="number">1</span> Default Trace File</span>
<span class="line">/u01/app/oracle/diag/rdbms/orcl/orcl/trace/orcl_ora_8852.trc</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">查看<span class="keyword">dump</span> trace CHECKPOINT PROGRESS RECORDS部分信息：</span>
<span class="line">***************************************************************************</span>
<span class="line">CHECKPOINT PROGRESS RECORDS</span>
<span class="line">***************************************************************************</span>
<span class="line"> (size = <span class="number">8180</span>, compat size = <span class="number">8180</span>, section max = <span class="number">11</span>, section in-<span class="keyword">use</span> = <span class="number">0</span>,</span>
<span class="line">  <span class="keyword">last</span>-recid= <span class="number">0</span>, old-recno = <span class="number">0</span>, <span class="keyword">last</span>-recno = <span class="number">0</span>)</span>
<span class="line"> (extent = <span class="number">1</span>, blkno = <span class="number">2</span>, numrecs = <span class="number">11</span>)</span>
<span class="line">THREAD <span class="comment">#1 - status:0x2 flags:0x0 dirty:21</span></span>
<span class="line">low cache rba:(<span class="number">0x36</span>.<span class="number">4</span>da4.<span class="number">0</span>) on disk rba:(<span class="number">0x36</span>.<span class="number">4</span>dbd.<span class="number">0</span>)    <span class="comment"># 从(0x36.4da4.0) 开始恢复到(0x36.4dbd.0)结束</span></span>
<span class="line">on disk scn: <span class="number">0x0000</span>.<span class="number">003731</span>ec <span class="number">03</span>/<span class="number">20</span>/<span class="number">2018</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">06</span></span>
<span class="line">resetlogs scn: <span class="number">0x0000</span>.<span class="number">002</span>d8db8 <span class="number">02</span>/<span class="number">26</span>/<span class="number">2018</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">23</span></span>
<span class="line">heartbeat: <span class="number">971294256</span> mount id: <span class="number">1499044775</span></span>
</pre></td></tr></table></figure></p>
<p>解读：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">low cache rba:(<span class="number">0x36</span>.<span class="number">4</span>da4.<span class="number">0</span>)</span>
<span class="line">SQL&gt; <span class="keyword">select</span> to_number(<span class="number">36</span>,<span class="string">'xxxxxx'</span>) from dual;</span>
<span class="line"></span>
<span class="line">TO_NUMBER(<span class="number">36</span>,<span class="string">'XXXXXX'</span>)</span>
<span class="line">----------------------</span>
<span class="line">                    <span class="number">54</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> to_number(<span class="string">'4da4'</span>,<span class="string">'xxxxxx'</span>) from dual;</span>
<span class="line"></span>
<span class="line">TO_NUMBER(<span class="string">'4DA4'</span>,<span class="string">'XXXXXX'</span>)</span>
<span class="line">--------------------------</span>
<span class="line">                     <span class="number">19876</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">on disk rba:(<span class="number">0x36</span>.<span class="number">4</span>dbd.<span class="number">0</span>)</span>
<span class="line">SQL&gt; <span class="keyword">select</span> to_number(<span class="number">36</span>,<span class="string">'xxxxxx'</span>) from dual;</span>
<span class="line"></span>
<span class="line">TO_NUMBER(<span class="number">36</span>,<span class="string">'XXXXXX'</span>)</span>
<span class="line">----------------------</span>
<span class="line">                    <span class="number">54</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> to_number(<span class="string">'4dbd'</span>,<span class="string">'xxxxxx'</span>) from dual;</span>
<span class="line"></span>
<span class="line">TO_NUMBER(<span class="string">'4DA4'</span>,<span class="string">'XXXXXX'</span>)</span>
<span class="line">--------------------------</span>
<span class="line">                     <span class="number">19901</span></span>
<span class="line"></span>
<span class="line">实例恢复将从第<span class="number">54</span>号日志第<span class="number">19876</span>块偏移量为<span class="number">0</span>开始，到第<span class="number">54</span>号日志第<span class="number">19901</span>块偏移量为<span class="number">0</span>结束</span>
</pre></td></tr></table></figure></p>
<p>验证：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动数据库</span></span>
<span class="line">alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看alert日志</span></span>
<span class="line">Beginning crash recovery of <span class="number">1</span> threads</span>
<span class="line"> parallel recovery started with <span class="number">3</span> processes</span>
<span class="line">Started <span class="keyword">redo</span> scan</span>
<span class="line">Completed <span class="keyword">redo</span> scan</span>
<span class="line"> <span class="keyword">read</span> <span class="number">12</span> KB <span class="keyword">redo</span>, <span class="number">21</span> data blocks need recovery</span>
<span class="line">Started <span class="keyword">redo</span> application at</span>
<span class="line"> Thread <span class="number">1</span>: logseq <span class="number">54</span>, block <span class="number">19876</span></span>
<span class="line">Recovery of Online Redo Log: Thread <span class="number">1</span> Group <span class="number">3</span> Seq <span class="number">54</span> Reading mem <span class="number">0</span></span>
<span class="line">  Mem<span class="comment"># 0: /u01/app/oracle/oradata/orcl/redo03.log</span></span>
<span class="line">Completed <span class="keyword">redo</span> application of <span class="number">0</span>.<span class="number">01</span>MB</span>
<span class="line">Completed crash recovery at</span>
<span class="line"> Thread <span class="number">1</span>: logseq <span class="number">54</span>, block <span class="number">19901</span>, scn <span class="number">3637260</span></span>
<span class="line"> <span class="number">21</span> data blocks <span class="keyword">read</span>, <span class="number">21</span> data blocks written, <span class="number">12</span> <span class="keyword">redo</span> k-bytes <span class="keyword">read</span></span>
<span class="line"></span>
<span class="line">从alert日志中可以验证，实例从low cache rba开始恢复，至少恢复到on disk rba</span>
</pre></td></tr></table></figure></p>
<p>3.误操作rm -rf control0*.ctl删除全部控制文件，通过文件描述符对控制文件进行恢复。（给出详细操作步骤）<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; show parameter control_files</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">control_files                        string      /u01/app/oracle/oradata/orcl/c</span>
<span class="line">                                                 ontrol01.ctl, <span class="regexp">/u01/app</span><span class="regexp">/oracle/</span></span>
<span class="line">                                                 fast_recovery_area/orcl/contro</span>
<span class="line">                                                 l02.ctl</span>
<span class="line"></span>
<span class="line"><span class="keyword">exit</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 先复制一份，以防万一</span></span>
<span class="line">cp /u01/app/oracle/oradata/orcl/control01.ctl /u01/app/oracle/oradata/orcl/control01.ctl.bak</span>
<span class="line">cp /u01/app/oracle/fast_recovery_area/orcl/control02.ctl /u01/app/oracle/fast_recovery_area/orcl/control02.ctl.bak</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除控制文件</span></span>
<span class="line">rm -rf /u01/app/oracle/oradata/orcl/control01.ctl /u01/app/oracle/fast_recovery_area/orcl/control02.ctl</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看检查点进程</span></span>
<span class="line">ps -ef | <span class="keyword">grep</span> ckpt | <span class="keyword">grep</span> -v <span class="keyword">grep</span></span>
<span class="line">oracle    <span class="number">8834</span>     <span class="number">1</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">15</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> ora_ckpt_orcl</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">cd /proc/<span class="number">8834</span>/fd</span>
<span class="line">total <span class="number">0</span></span>
<span class="line">lr-<span class="keyword">x</span>------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">0</span> -&gt; <span class="regexp">/dev/null</span></span>
<span class="line">l-wx------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">1</span> -&gt; <span class="regexp">/dev/null</span></span>
<span class="line">lrwx------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">10</span> -&gt; <span class="regexp">/u01/app</span><span class="regexp">/oracle/</span><span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/db_1/dbs/lkORCL</span>
<span class="line">lr-<span class="keyword">x</span>------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">11</span> -&gt; <span class="regexp">/u01/app</span><span class="regexp">/oracle/</span><span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/db_1/rdbms/mesg/oraus.msb</span>
<span class="line">l-wx------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">2</span> -&gt; <span class="regexp">/dev/null</span></span>
<span class="line">lrwx------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">256</span> -&gt; <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/control</span>01.ctl (deleted)    <span class="comment">##</span></span>
<span class="line">lrwx------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">257</span> -&gt; <span class="regexp">/u01/app</span><span class="regexp">/oracle/fast</span>_recovery_area/orcl/control02.ctl (deleted) <span class="comment">##</span></span>
<span class="line">lr-<span class="keyword">x</span>------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">3</span> -&gt; <span class="regexp">/dev/null</span></span>
<span class="line">lr-<span class="keyword">x</span>------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">4</span> -&gt; <span class="regexp">/dev/null</span></span>
<span class="line">lr-<span class="keyword">x</span>------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">5</span> -&gt; <span class="regexp">/dev/null</span></span>
<span class="line">lr-<span class="keyword">x</span>------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">6</span> -&gt; <span class="regexp">/u01/app</span><span class="regexp">/oracle/</span><span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/db_1/rdbms/mesg/oraus.msb</span>
<span class="line">lr-<span class="keyword">x</span>------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">7</span> -&gt; <span class="regexp">/proc/</span><span class="number">8834</span>/fd</span>
<span class="line">lr-<span class="keyword">x</span>------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">8</span> -&gt; <span class="regexp">/dev/zero</span></span>
<span class="line">lrwx------ <span class="number">1</span> oracle oinstall <span class="number">64</span> Mar <span class="number">20</span> <span class="number">16</span>:<span class="number">59</span> <span class="number">9</span> -&gt; <span class="regexp">/u01/app</span><span class="regexp">/oracle/</span><span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/db_1/dbs/hc_orcl.dat</span>
<span class="line"></span>
<span class="line">cp <span class="number">256</span> /u01/app/oracle/oradata/orcl/control01.ctl</span>
<span class="line">cp <span class="number">257</span> /u01/app/oracle/fast_recovery_area/orcl/control02.ctl</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关库的时候报错，但可以正常启动</span></span>
<span class="line">[oracle@orcl11g ~]$ sqlplus / as sysdba</span>
<span class="line"></span>
<span class="line">SQL*Plus: Release <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> Production on Tue Mar <span class="number">20</span> <span class="number">17</span>:<span class="number">00</span>:<span class="number">38</span> <span class="number">2018</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2013</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Connected to:</span>
<span class="line">Oracle Database <span class="number">11</span>g Enterprise Edition Release <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> - <span class="number">64</span>bit Production</span>
<span class="line">With the Partitioning, OLAP, Data Mining <span class="keyword">and</span> Real Application Testing options</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">Database closed.</span>
<span class="line">ORA-<span class="number">03113</span>: end-of-file on communication channel</span>
<span class="line">Process ID: <span class="number">9043</span></span>
<span class="line">Session ID: <span class="number">191</span> Serial number: <span class="number">13</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">exit</span></span>
<span class="line">Disconnected from Oracle Database <span class="number">11</span>g Enterprise Edition Release <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> - <span class="number">64</span>bit Production</span>
<span class="line">With the Partitioning, OLAP, Data Mining <span class="keyword">and</span> Real Application Testing options</span>
<span class="line">[oracle@orcl11g ~]$ sqlplus / as sysdba</span>
<span class="line"></span>
<span class="line">SQL*Plus: Release <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> Production on Tue Mar <span class="number">20</span> <span class="number">17</span>:<span class="number">00</span>:<span class="number">56</span> <span class="number">2018</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2013</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Connected to an idle instance.</span>
<span class="line"></span>
<span class="line">SQL&gt; startup</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">889193112</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3472883712</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">Database opened.</span>
</pre></td></tr></table></figure></p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="http://m.blog.itpub.net/28539951/viewspace-1994654/" target="_blank" rel="external">oracle控制文件转储说明</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> Oracle特殊恢复原理与实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> DSI </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_10 Docker常用命令]]></title>
      <url>/2018/02/28/docker/10_docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<h2 id="docker-search"><a href="#docker-search" class="headerlink" title="docker search"></a>docker search</h2><p>命令示例：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">docker search oracle</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">NAME                                DESCRIPTION                                     STARS               OFFICIAL            AUTOMATED</span>
<span class="line">oraclelinux                         Oracle Linux is an <span class="keyword">open</span>-source operating s...   <span class="number">404</span>                 [OK]                </span>
<span class="line">frolvlad/alpine-oraclejdk8          The smallest Docker image with OracleJDK <span class="number">8</span>...   <span class="number">270</span>                                     [OK]</span>
<span class="line">alexeiled/docker-oracle-xe-<span class="number">11</span>g      This is a working (hopefully) Oracle XE <span class="number">11</span>...   <span class="number">223</span>                                     [OK]</span>
<span class="line">sath89/oracle-<span class="number">12</span>c                   Oracle Standard Edition <span class="number">12</span>c Release <span class="number">1</span> with...   <span class="number">222</span>                                     [OK]</span>
<span class="line">sath89/oracle-xe-<span class="number">11</span>g                Oracle xe <span class="number">11</span>g with database files mount su...   <span class="number">136</span>                                     [OK]</span>
<span class="line">isuper/java-oracle                  This repository contains all java releases...   <span class="number">55</span>                                      [OK]</span>
<span class="line">jaspeen/oracle-<span class="number">11</span>g                  Docker image <span class="keyword">for</span> Oracle <span class="number">11</span>g database            <span class="number">55</span>                                      [OK]</span>
<span class="line">oracle/glassfish                    GlassFish Java EE Application Server on Or...   <span class="number">31</span>                                      [OK]</span>
<span class="line">oracle/openjdk                      Docker images containing OpenJDK Oracle Linux   <span class="number">26</span>                                      [OK]</span>
<span class="line">airdock/oracle-jdk                  Docker Image <span class="keyword">for</span> Oracle Java SDK (<span class="number">8</span> <span class="keyword">and</span> <span class="number">7</span>)...   <span class="number">23</span>                                      [OK]</span>
<span class="line">wnameless/oracle-xe-<span class="number">11</span>g             Dockerfile of Oracle Database Express Edit...   <span class="number">22</span>                                      [OK]</span>
<span class="line">ingensi/oracle-jdk                  Official Oracle JDK installed on centos.        <span class="number">21</span>                                      [OK]</span>
<span class="line">cogniteev/oracle-java               Oracle JDK <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="keyword">and</span> <span class="number">9</span> based on Ubuntu ...   <span class="number">20</span>                                      [OK]</span>
<span class="line">n3ziniuka5/ubuntu-oracle-jdk        Ubuntu with Oracle JDK. Check tags <span class="keyword">for</span> ver...   <span class="number">14</span>                                      [OK]</span>
<span class="line">oracle/nosql                        Oracle NoSQL on a Docker Image with Oracle...   <span class="number">13</span>                                      [OK]</span>
<span class="line">sgrio/java-oracle                   Docker images of Java <span class="number">7</span>/<span class="number">8</span> provided by Orac...   <span class="number">7</span>                                       [OK]</span>
<span class="line">andreptb/oracle-java                Debian Jessie based image with Oracle JDK ...   <span class="number">7</span>                                       [OK]</span>
<span class="line">openweb/oracle-tomcat               A <span class="keyword">fork</span> off of Official tomcat image with O...   <span class="number">7</span>                                       [OK]</span>
<span class="line">flurdy/oracle-java7                 Base image containing Oracle<span class="string">'s Java 7 JDK       5                                       [OK]</span>
<span class="line">martinseeler/oracle-server-jre      Oracle'</span><span class="keyword">s</span> Java <span class="number">8</span> as <span class="number">61</span> MB Docker container.      <span class="number">4</span>                                       [OK]</span>
<span class="line">davidcaste/debian-oracle-java       Oracle Java <span class="number">8</span> (<span class="keyword">and</span> <span class="number">7</span>) over Debian Jessie        <span class="number">3</span>                                       [OK]</span>
<span class="line">teradatalabs/centos6-java8-oracle   Docker image of CentOS <span class="number">6</span> with Oracle JDK <span class="number">8</span>...   <span class="number">3</span>                                       </span>
<span class="line">spansari/nodejs-oracledb            nodejs with oracledb installed globally on...   <span class="number">1</span>                                       </span>
<span class="line">publicisworldwide/oracle-core       This is the core image based on Oracle Lin...   <span class="number">1</span>                                       [OK]</span>
<span class="line">sigma/nimbus-lock-oracle                                                            <span class="number">0</span>                                       [OK]</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<a id="more"></a>
<p>也可以去<a href="https://hub.docker.com/" target="_blank" rel="external">https://hub.docker.com/ </a>里去搜索，更直观，以及dockfile等内容<br><img src="http://oligvdnzp.bkt.clouddn.com/1213_docker_03.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1213_docker_04.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1213_docker_05.png" alt=""></p>
<h2 id="docker-pull"><a href="#docker-pull" class="headerlink" title="docker pull"></a>docker pull</h2><p>pull镜像，命令示例：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">docker pull java</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">Using default tag: latest</span>
<span class="line">latest: Pulling from library/java</span>
<span class="line"><span class="number">5040</span>bd29839<span class="number">0</span>: Pull complete </span>
<span class="line">fce5728aad85: Pull complete </span>
<span class="line"><span class="number">76610</span>ec20bf5: Pull complete </span>
<span class="line"><span class="number">60170</span>fec2151: Pull complete </span>
<span class="line">e98f73de8f0d: Pull complete </span>
<span class="line"><span class="number">11</span>f7af24ed9c: Pull complete </span>
<span class="line"><span class="number">49</span>e2d6393f32: Downloading [============================&gt;                      ]  <span class="number">72.97</span>MB/<span class="number">130.1</span>MB   <span class="comment"># 分层Downloading、Extracting images</span></span>
<span class="line">bb9cdec9c7f3: Verifying Checksum</span>
<span class="line"></span>
<span class="line">Digest: sha256:c1ff613e8ba25833d2e1940da0940c3824f03f802c449f3d1815a66b7f8c0e9d</span>
<span class="line">Status: Downloaded newer image <span class="keyword">for</span> java:latest      <span class="comment"># 完成</span></span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># sgrio/java-oracle latest: pointed to sgrio/java-oracle:server_jre_9</span></span>
<span class="line">docker pull sgrio/java-oracle</span>
<span class="line"></span>
<span class="line"><span class="comment"># pull java 8 image用以下命令</span></span>
<span class="line">docker pull sgrio/java-oracle:server_jre_8</span>
</pre></td></tr></table></figure></p>
<h2 id="docker-images"><a href="#docker-images" class="headerlink" title="docker images"></a>docker images</h2><p>查看本地已经装载的镜像，命令示例：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">docker images</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span>
<span class="line">sgrio/java-oracle   server_jre_8        <span class="number">6</span>d10e204fc36        <span class="number">2</span> weeks ago         <span class="number">292</span>MB</span>
<span class="line">hello-world         latest              f2a91732366c        <span class="number">3</span> weeks ago         <span class="number">1.85</span>kB</span>
<span class="line">ubuntu              latest              <span class="number">20</span>c44cd7596f        <span class="number">3</span> weeks ago         <span class="number">123</span>MB</span>
<span class="line">lwieske/java-<span class="number">8</span>      jdk-<span class="number">8</span>u131           0ff57dff9137        <span class="number">5</span> months ago        <span class="number">590</span>MB</span>
<span class="line">java                latest              d23bdf5b1b1b        <span class="number">11</span> months ago       <span class="number">643</span>MB</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h2 id="docker-run"><a href="#docker-run" class="headerlink" title="docker run"></a>docker run</h2><p>docker run [OPTIONS] IMAGE[:TAG] [COMMAND] [ARG…]</p>
<ul>
<li>docker run后面追加-d=true或者-d，那么容器将会运行在后台模式。</li>
<li>docker exec来进入到到该容器中，或者attach重新连接容器的会话</li>
<li>进行交互式操作（例如Shell脚本），须使用-i -t参数同容器进行数据交互</li>
<li>docker run时没有指定–name，那么deamon会自动生成一个随机字符串UUID</li>
<li>Docker时有自动化的需求，可以将containerID输出到指定的文件中（PIDfile）： –cidfile=”” </li>
<li>Docker的容器是没有特权的，例如不能在容器中再启动一个容器。这是因为默认情况下容器是不能访问任何其它设备的。但是通过”privileged”，容器就拥有了访问任何其它设备的权限。</li>
</ul>
<p>命令示例：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">docker run -it java java -version</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">openjdk version <span class="string">"1.8.0_111"</span></span>
<span class="line">OpenJDK Runtime Environment (build <span class="number">1.8</span>.<span class="number">0_111</span>-<span class="number">8</span>u111-b14-<span class="number">2</span>~bpo8+<span class="number">1</span>-b14)</span>
<span class="line">OpenJDK <span class="number">64</span>-Bit Server VM (build <span class="number">25.111</span>-b14, mixed mode)</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">docker run -it sgrio/java-oracle:server_jre_8 java -version</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">java version <span class="string">"1.8.0_152"</span></span>
<span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span>.<span class="number">0_152</span>-b16)</span>
<span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">25.152</span>-b16, mixed mode)</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">docker run -it java uname</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">Linux</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">docker run -it java ps</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">  PID TTY          TIME CMD</span>
<span class="line">    <span class="number">1</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> ps</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">docker run -it java ip addr</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN group default qlen <span class="number">1</span></span>
<span class="line">    <span class="keyword">link</span>/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span>
<span class="line">    inet <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/<span class="number">8</span> scope host lo</span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line"><span class="number">52</span>: eth<span class="number">0</span>@if53: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> UP group default </span>
<span class="line">    <span class="keyword">link</span>/ether <span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">11</span>:<span class="number">00</span>:<span class="number">02</span> brd ff:ff:ff:ff:ff:ff</span>
<span class="line">    inet <span class="number">172.17</span>.<span class="number">0</span>.<span class="number">2</span>/<span class="number">16</span> scope global eth<span class="number">0</span></span>
<span class="line">       valid_lft forever preferred_lft forever    </span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">docker run -it java ip addr</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN group default qlen <span class="number">1</span></span>
<span class="line">    <span class="keyword">link</span>/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span>
<span class="line">    inet <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/<span class="number">8</span> scope host lo</span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line"><span class="number">58</span>: eth<span class="number">0</span>@if59: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> UP group default </span>
<span class="line">    <span class="keyword">link</span>/ether <span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">11</span>:<span class="number">00</span>:<span class="number">02</span> brd ff:ff:ff:ff:ff:ff</span>
<span class="line">    inet <span class="number">172.17</span>.<span class="number">0</span>.<span class="number">2</span>/<span class="number">16</span> scope global eth<span class="number">0</span></span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------       </span></span>
<span class="line"></span>
<span class="line">docker run -it java env</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">PATH=<span class="regexp">/usr/local</span><span class="regexp">/sbin:/usr</span><span class="regexp">/local/bin</span>:<span class="regexp">/usr/sbin</span>:<span class="regexp">/usr/bin</span>:<span class="regexp">/sbin:/bin</span></span>
<span class="line">HOSTNAME=<span class="number">126</span>a22eb2c97</span>
<span class="line">TERM=xterm</span>
<span class="line">LANG=C.UTF-<span class="number">8</span></span>
<span class="line">JAVA_HOME=<span class="regexp">/usr/lib</span><span class="regexp">/jvm/java</span>-<span class="number">8</span>-openjdk-amd64</span>
<span class="line">JAVA_VERSION=<span class="number">8</span>u111</span>
<span class="line">JAVA_DEBIAN_VERSION=<span class="number">8</span>u111-b14-<span class="number">2</span>~bpo8+<span class="number">1</span></span>
<span class="line">CA_CERTIFICATES_JAVA_VERSION=<span class="number">20140324</span></span>
<span class="line">HOME=<span class="regexp">/root</span>
<span class="line">#---------------------------------------------------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># docker run 里面的命令结束了，container就结束了</span></span>
</pre></td></tr></table></figure></p>
<h2 id="批量停止所有运行中的容器"><a href="#批量停止所有运行中的容器" class="headerlink" title="批量停止所有运行中的容器"></a>批量停止所有运行中的容器</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tee stop_all_container.sh &lt;&lt;-<span class="string">'EOF'</span></span>
<span class="line">sudo docker ps | grep -v CONTAINER | awk <span class="string">'&#123;print $1&#125;'</span>| xargs sudo docker stop</span>
<span class="line">EOF</span>
<span class="line"></span>
<span class="line">chmod +x stop_all_container.sh</span>
</pre></td></tr></table></figure>
<h2 id="批量删除所有容器"><a href="#批量删除所有容器" class="headerlink" title="批量删除所有容器"></a>批量删除所有容器</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tee rm_all_container.sh &lt;&lt;-<span class="string">'EOF'</span></span>
<span class="line">sudo docker ps <span class="_">-a</span> | grep -v CONTAINER | awk <span class="string">'&#123;print $1&#125;'</span>| xargs sudo docker rm</span>
<span class="line">EOF</span>
<span class="line"></span>
<span class="line">chmod +x rm_all_container.sh</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一台电脑同时使用GitHub和GitLab仓库]]></title>
      <url>/2018/02/27/tools/github%E4%B8%8Egitlab%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<p>github已在用，后公司搭建私有gitlab仓库，现要在一台电脑上同时使用GitHub和GitLab仓库<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_gitlab_01.png" alt=""></p>
<a id="more"></a>
<p>进入git bash生成gitlab钥匙<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cd ~/.ssh</span>
<span class="line">$ ssh-keygen -t rsa -C &quot;liuyajun@ydgw.cn&quot;</span>
<span class="line">Generating public/private rsa key pair.</span>
<span class="line">Enter file in which to save the key (/c/Users/liuyajun/.ssh/id_rsa): /c/Users/liuyajun/.ssh/gitlab_id_rsa</span>
<span class="line">Enter passphrase (empty for no passphrase):</span>
<span class="line">Enter same passphrase again:</span>
<span class="line">Your identification has been saved in /c/Users/liuyajun/.ssh/gd_rgitlab_id_rsa.</span>
<span class="line">Your public key has been saved in /c/Users/liuyajun/.ssh/gd_rgitlab_id_rsa.pub.</span>
<span class="line">The key fingerprint is:</span>
<span class="line">SHA256:IBKC+H7rm/4f19CViQ3qtbDXHGNGufG4GCx33ykCJdQ liuyajun@ydgw.cn</span>
<span class="line">The keys randomart image is:</span>
<span class="line">+---[RSA 2048]----+</span>
<span class="line">|+ .     ... . .. |</span>
<span class="line">|o. .     . E =oo |</span>
<span class="line">| .. . .   =.o X= |</span>
<span class="line">|  .. . . o.=+B+o.|</span>
<span class="line">| .      S =o++ooo|</span>
<span class="line">|  . .      =....o|</span>
<span class="line">|   . .  . . o .  |</span>
<span class="line">|    ..   o       |</span>
<span class="line">|   o=o...        |</span>
<span class="line">+----[SHA256]-----+</span>
<span class="line"></span>
<span class="line">$ ll</span>
<span class="line">total 17</span>
<span class="line">-rw-r--r-- 1 liuyajun 197121 1679 二月 27 11:50 gitlab_id_rsa</span>
<span class="line">-rw-r--r-- 1 liuyajun 197121  398 二月 27 11:50 gitlab_id_rsa.pub</span>
<span class="line">-rw-r--r-- 1 liuyajun 197121 1675 一月 22  2017 id_rsa</span>
<span class="line">-rw-r--r-- 1 liuyajun 197121  401 一月 22  2017 id_rsa.pub</span>
<span class="line">-rw-r--r-- 1 liuyajun 197121 2351 二月 27 11:34 known_hosts</span>
<span class="line"></span>
<span class="line">eval $(ssh-agent -s)</span>
<span class="line">ssh-add ~/.ssh/gitlab_id_rsa</span>
</pre></td></tr></table></figure></p>
<p>用gitlab_id_rsa.pub里的内容配置gitlab帐号SSH KEY<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat ~/.ssh/gitlab_id_rsa.pub</span>
</pre></td></tr></table></figure></p>
<p><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_gitlab_02.png" alt=""></p>
<p>配置config<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cat ~/.ssh/config</span>
<span class="line"># GitLab.com server</span>
<span class="line">Host gitlab.com</span>
<span class="line">IdentityFile ~/.ssh/id_rsa</span>
<span class="line"></span>
<span class="line"># Private GitLab server</span>
<span class="line">Host 10.240.4.160</span>
<span class="line">IdentityFile ~/.ssh/gitlab_id_rsa</span>
</pre></td></tr></table></figure></p>
<p>测试<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh -T git@github.com</span>
<span class="line">ssh -T git@10.240.4.160</span>
</pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> gitlab </tag>
            
            <tag> gitlub </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_08使用Rancher pipeline搭建基于容器的CICD]]></title>
      <url>/2018/02/27/docker/08_%E4%BD%BF%E7%94%A8Rancher-pipeline%E6%90%AD%E5%BB%BA%E5%9F%BA%E4%BA%8E%E5%AE%B9%E5%99%A8%E7%9A%84CICD/</url>
      <content type="html"><![CDATA[<h2 id="CICD概述"><a href="#CICD概述" class="headerlink" title="CICD概述"></a>CICD概述</h2><ul>
<li>CI-持续集成(Continuous Integration)：频繁地将代码集成到主干的一种开发实践，每次集成都通过自动化的构建（包括编译，发布，自动化测试）来验证，从而尽早地发现集成错误。</li>
<li>CD-持续部署(Continuous Deployment)：从代码提交，自动化完成测试、构建及到生产环境的部署</li>
</ul>
<h2 id="在Rancher中做CI-CD的方法"><a href="#在Rancher中做CI-CD的方法" class="headerlink" title="在Rancher中做CI/CD的方法"></a>在Rancher中做CI/CD的方法</h2><ol>
<li>配合第三方工具，Drone/Travis/Jenkins，配合webhook，rancher cli等触发部署更新 </li>
<li>使用<code>Rancher pipeline</code>构建从源码提交到Rancher中应用部署的一套流水线</li>
</ol>
<a id="more"></a>
<h2 id="Rancher-pipeline的部署"><a href="#Rancher-pipeline的部署" class="headerlink" title="Rancher pipeline的部署"></a>Rancher pipeline的部署</h2><p>Ranche Pipeline 是Rancher V1.6.13更新发布的新功能。所以如果不是V1.6.13首先要进行 Rancher的升级。<br>Rancher pipeline的安装非常简单，在应用商店搜索pipeline<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0213_rancher_01.png" alt=""></p>
<p>用默认的配置一键部署<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0213_rancher_02.png" alt=""></p>
<p>等基础设施应用中pipeline中的服务都启动后，就会在上方看到流水线的菜单出现<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0213_rancher_03.png" alt=""></p>
<p>第一次打流水线时可能会因加载UI文件会慢一些，打开后的效果如下图<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0213_rancher_04.png" alt=""></p>
<h2 id="授权git仓库"><a href="#授权git仓库" class="headerlink" title="授权git仓库"></a>授权git仓库</h2><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0213_rancher_05.png" alt=""></p>
<p>选择gitlab<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0213_rancher_06.png" alt=""></p>
<p>按提示步骤设置gitlab<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_rancher_01.png" alt=""></p>
<p>配置GitLab进行基于OAuth的身份验证<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_rancher_02.png" alt=""></p>
<p>生成了客户端ID和秘钥<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_rancher_03.png" alt=""></p>
<p>填写刚生成的客户端ID和秘钥，并添写gitlab信息后验证<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_rancher_04.png" alt=""></p>
<p>授权<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_rancher_09.png" alt=""></p>
<p>等待验证<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_rancher_06.png" alt=""></p>
<p>验证成功<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_rancher_08.png" alt=""></p>
<p>可以添加其他更多的帐号（gitlab要退出重新用其他帐号登陆）<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0227_rancher_10.png" alt=""></p>
<h2 id="GO-DEMO"><a href="#GO-DEMO" class="headerlink" title="GO DEMO"></a>GO DEMO</h2><h3 id="添加流水线"><a href="#添加流水线" class="headerlink" title="添加流水线"></a>添加流水线</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0228_rancher_01.png" alt=""></p>
<p><img src="http://p2c0rtsgc.bkt.clouddn.com/0228_rancher_02.png" alt=""></p>
<p><img src="http://p2c0rtsgc.bkt.clouddn.com/0228_rancher_03.png" alt=""></p>
<p>添加一个阶段<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0228_rancher_04.png" alt=""></p>
<p>mkdir -p /go/src/10.240.4.160/example<br>ln -s $(pwd) /go/src/10.240.4.160/example/go<br>cd /go/src/10.240.4.160/example/go/outyet<br>GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o bin/outyet</p>
<p>docker pull 10.240.4.159/example/outyet:demo<br>/data/tomcat/webapps:/usr/local/tomcat/webapps</p>
<p><a href="https://github.com/golang/example" target="_blank" rel="external">https://github.com/golang/example</a></p>
<p>创建容器的时候指定启动参数，自动挂载localtime文件到容器内<br><a href="https://github.com/lawrli" target="_blank" rel="external">https://github.com/lawrli</a></p>
<p>##<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/etc/<span class="keyword">localtime</span>:<span class="regexp">/etc/localtime</span>:ro</span>
</pre></td></tr></table></figure></p>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><ul>
<li><a href="https://www.cnblogs.com/xzkzzz/p/8125389.html" target="_blank" rel="external">Rancher之Pipeline JAVA demo</a></li>
</ul>
<h1 id="将证书拷贝到如10-240-4-158客户机上并信任"><a href="#将证书拷贝到如10-240-4-158客户机上并信任" class="headerlink" title="将证书拷贝到如10.240.4.158客户机上并信任"></a>将证书拷贝到如10.240.4.158客户机上并信任</h1><p>scp -P 50022 10.240.4.160.crt 10.240.4.158:/usr/local/share/ca-certificates/</p>
<p>mattermost_external_url ‘<a href="https://10.240.4.160" target="_blank" rel="external">https://10.240.4.160</a>‘<br>mattermost_nginx[‘redirect_http_to_https’] = true<br>mattermost[‘gitlab_auth_endpoint’] = “<a href="https://10.240.4.160/oauth/authorize" target="_blank" rel="external">https://10.240.4.160/oauth/authorize</a>“<br>mattermost[‘gitlab_token_endpoint’] = “<a href="https://10.240.4.160/oauth/token" target="_blank" rel="external">https://10.240.4.160/oauth/token</a>“<br>mattermost[‘gitlab_user_api_endpoint’] = “<a href="https://10.240.4.160/api/v4/user" target="_blank" rel="external">https://10.240.4.160/api/v4/user</a>“</p>
<p>##<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">openssl req -new -newkey rsa:<span class="number">2048</span> -nodes -out <span class="number">10.240</span>.<span class="number">4.160</span>.csr -keyout <span class="number">10.240</span>.<span class="number">4.160</span>.key -subj <span class="string">"/C=CN/ST=Harbin/L=Harbin/O=ydgw/OU=IT/CN=10.240.4.160"</span></span>
<span class="line"></span>
<span class="line">openssl x509 -in <span class="number">10.240</span>.<span class="number">4.160</span>.crt -text -noout</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">cp <span class="number">10.240</span>.<span class="number">4.160</span>.crt /usr/<span class="keyword">local</span>/share/ca-certificates/</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="regexp">/data/dns</span>-etc/resolv.dnsmasq:<span class="regexp">/etc/resolv</span>.dnsmasq</span>
<span class="line">/data/dns-etc/dnsmasqhosts:<span class="regexp">/etc/dnsmasqhosts</span></span>
<span class="line">/data/dns-etc/dnsmasq.conf:<span class="regexp">/etc/dnsmasq</span>.conf</span>
<span class="line">/etc/<span class="keyword">localtime</span>:<span class="regexp">/etc/localtime</span>:ro</span>
<span class="line"></span>
<span class="line">dns (Expected <span class="keyword">state</span> running but got error: Error response from daemon: OCI runtime create failed: container_linux.go:<span class="number">296</span>: starting container process caused <span class="string">"process_linux.go:398: container init caused \"rootfs_linux.go:58: mounting \\\"/data/docker-dns/dnsmasq.conf\\\" to rootfs \\\"/var/lib/docker/aufs/mnt/3daf5708bcea4ec8da7108e5c8d6b2d030010e5a1fbe7d86349dc3db1a3fd774\\\" at \\\"/var/lib/docker/aufs/mnt/3daf5708bcea4ec8da7108e5c8d6b2d030010e5a1fbe7d86349dc3db1a3fd774/etc/dnsmasq.conf\\\" caused \\\"not a directory\\\"\""</span>: unknown: Are you trying to mount a directory onto a file (<span class="keyword">or</span> vice-versa)? Check <span class="keyword">if</span> the specified host path <span class="keyword">exists</span> <span class="keyword">and</span> is the expected type) </span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">docker run -d -p <span class="number">53</span>:<span class="number">53</span>/tcp -p <span class="number">53</span>:<span class="number">53</span>/udp --cap-add=NET_ADMIN --name dns-server andyshinn/dnsmasq</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">docker pull andyshinn/dnsmasq</span>
<span class="line"><span class="keyword">mkdir</span> -p /data/docker-dns</span>
<span class="line">cd /data/docker-dns</span>
<span class="line"></span>
<span class="line">vi resolv.dnsmasq</span>
<span class="line">nameserver <span class="number">202.97</span>.<span class="number">224.68</span></span>
<span class="line">nameserver <span class="number">114.114</span>.<span class="number">114.114</span></span>
<span class="line">nameserver <span class="number">8.8</span>.<span class="number">8.8</span></span>
<span class="line"></span>
<span class="line">vi dnsmasqhosts</span>
<span class="line"><span class="number">10.240</span>.<span class="number">4.160</span>  gitlab  gitlab.ydgw.cn</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">vi dnsmasq.conf</span>
<span class="line">resolv-file=<span class="regexp">/etc/dnsmasq</span>.d/resolv.dnsmasq</span>
<span class="line">addn-hosts=<span class="regexp">/etc/dnsmasq</span>.d/dnsmasqhosts</span>
<span class="line"></span>
<span class="line">resolv-file=<span class="regexp">/etc/dnsmasq</span>.d/resolv.dnsmasq</span>
<span class="line">addn-hosts=<span class="regexp">/etc/dnsmasq</span>.d/dnsmasqhosts</span>
<span class="line"></span>
<span class="line">docker tag SOURCE_IMAGE[:TAG] <span class="number">10.240</span>.<span class="number">4.159</span>/app/IMAGE[:TAG]</span>
<span class="line">docker-compose -f ./dns.yaml up -d</span>
</pre></td></tr></table></figure></p>
<p>容器-Docker为什么火？<br>Google自2004年就开始使用容器技术，目前他们每周要启动超过20亿个容器，每秒种新启动的容器就超过3000个，在容器技术方面有大量的积累。<br>曾相继开源了Cgroup(Control Groups)和Imctfy(Google开源Linux容器)这两个重量级项目。Google对Docker的支持力度非常大，不仅把imctfy先进之处融入Docker之中，还把自已的容器管理系统(kubernetes)也开源出来。</p>
<p>技术的发展产生了大量优秀的系统和软件。<br>操作系统：Redhat/Centos、Debian/Ubuntu、FreeBSD、SUSE等<br>编程语言：Java、Python、Ruby、Golang、C/C++等<br>WEB服务器：Apache、Nginx、Lighttpd等<br>数据库：Mysql、Redis、Mongodb等</p>
<p>软件开发人员在这么多种类中自由选择，结果就是维护一个非常庞大的开发、测试和生产环境，开发、测试和运维人员就会被种类繁多的环境折腾的筋疲力尽。即使只选择其中一两种，随着操作系统和软件版本的更新迭代，维护工作还是变得越来越庞大。</p>
]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
            <tag> rancher </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle特殊恢复原理与实战_02 Control file丢失的恢复]]></title>
      <url>/2018/02/26/oracle/Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/02_Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%85%A5%E9%97%A8/</url>
      <content type="html"><![CDATA[<h2 id="控制文件没有备份全部丢失恢复实战"><a href="#控制文件没有备份全部丢失恢复实战" class="headerlink" title="控制文件没有备份全部丢失恢复实战"></a>控制文件没有备份全部丢失恢复实战</h2><h3 id="准备测试环境"><a href="#准备测试环境" class="headerlink" title="准备测试环境"></a>准备测试环境</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; archive <span class="keyword">log</span> list;</span>
<span class="line">Database <span class="keyword">log</span> mode              Archive Mode</span>
<span class="line">Automatic archival             Enabled</span>
<span class="line">Archive destination            USE_DB_RECOVERY_FILE_DEST</span>
<span class="line">Oldest online <span class="keyword">log</span> sequence     <span class="number">110</span></span>
<span class="line">Next <span class="keyword">log</span> sequence to archive   <span class="number">112</span></span>
<span class="line">Current <span class="keyword">log</span> sequence           <span class="number">112</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE</span>
<span class="line">--------------------</span>
<span class="line">READ WRITE</span>
<span class="line"></span>
<span class="line">set line <span class="number">150</span></span>
<span class="line">set pagesize <span class="number">9999</span></span>
<span class="line">col name <span class="keyword">for</span> a6<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> * from v$controlfile;</span>
<span class="line"></span>
<span class="line">STATUS  NAME                                                         IS<span class="number">_</span> BLOCK_SIZE FILE_SIZE_BLKS</span>
<span class="line">------- ------------------------------------------------------------ --- ---------- --------------</span>
<span class="line">        <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/control</span>01.ctl                   NO       <span class="number">16384</span>            <span class="number">594</span></span>
<span class="line">        /u01/app/oracle/fast_recovery_area/orcl/control02.ctl        NO       <span class="number">16384</span>            <span class="number">594</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 为方便后续测试，先生成一个创建控制文件的脚本(也可以不生成，创建脚本可以oracle官方文档中找到)</span></span>
<span class="line">alter database backup controlfile to trace as <span class="string">'/tmp/control_bak.sql'</span>;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="摸拟控制文件全部丢失"><a href="#摸拟控制文件全部丢失" class="headerlink" title="摸拟控制文件全部丢失"></a>摸拟控制文件全部丢失</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rm -rf /u01/app/oracle/oradata/orcl/control01.ctl</span>
<span class="line">rm -rf /u01/app/oracle/fast_recovery_area/orcl/control02.ctl</span>
<span class="line"></span>
<span class="line"><span class="comment"># 丢失控制文件后，数据库仍能正常进行相关操作</span></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> switch logfile;</span>
<span class="line"></span>
<span class="line">System altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="regexp">/</span>
<span class="line"></span>
<span class="line">System altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter system checkpoint;</span>
<span class="line"></span>
<span class="line">System altered.</span></span>
</pre></td></tr></table></figure>
<h3 id="关闭和打开数据库报错"><a href="#关闭和打开数据库报错" class="headerlink" title="关闭和打开数据库报错"></a>关闭和打开数据库报错</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">ORA-<span class="number">00210</span>: cannot <span class="keyword">open</span> the specified control file</span>
<span class="line">ORA-<span class="number">00202</span>: control file: <span class="string">'/u01/app/oracle/oradata/orcl/control01.ctl'</span></span>
<span class="line">ORA-<span class="number">27041</span>: unable to <span class="keyword">open</span> file</span>
<span class="line">Linux-x86_64 Error: <span class="number">2</span>: No such file <span class="keyword">or</span> directory</span>
<span class="line">Additional information: <span class="number">3</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 强制关闭</span></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> abort</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line"></span>
<span class="line">SQL&gt; startup</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">905970328</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3456106496</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">ORA-<span class="number">00205</span>: error in identifying control file, check alert <span class="keyword">log</span> <span class="keyword">for</span> more info</span>
<span class="line"></span>
<span class="line"><span class="comment"># alert日志中报错信息</span></span>
<span class="line">Mon Feb <span class="number">26</span> <span class="number">14</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2018</span></span>
<span class="line">ALTER DATABASE   MOUNT</span>
<span class="line">ORA-<span class="number">00210</span>: cannot <span class="keyword">open</span> the specified control file</span>
<span class="line">ORA-<span class="number">00202</span>: control file: <span class="string">'/u01/app/oracle/fast_recovery_area/orcl/control02.ctl'</span></span>
<span class="line">ORA-<span class="number">27037</span>: unable to obtain file status</span>
<span class="line">Linux-x86_64 Error: <span class="number">2</span>: No such file <span class="keyword">or</span> directory</span>
<span class="line">Additional information: <span class="number">3</span></span>
<span class="line">ORA-<span class="number">00210</span>: cannot <span class="keyword">open</span> the specified control file</span>
<span class="line">ORA-<span class="number">00202</span>: control file: <span class="string">'/u01/app/oracle/oradata/orcl/control01.ctl'</span></span>
<span class="line">ORA-<span class="number">27037</span>: unable to obtain file status</span>
<span class="line">Linux-x86_64 Error: <span class="number">2</span>: No such file <span class="keyword">or</span> directory</span>
<span class="line">Additional information: <span class="number">3</span></span>
<span class="line">ORA-<span class="number">205</span> signalled during: ALTER DATABASE   MOUNT...</span>
<span class="line">Mon Feb <span class="number">26</span> <span class="number">14</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2018</span></span>
<span class="line">Checker run found <span class="number">2</span> new persistent data failures</span>
</pre></td></tr></table></figure>
<h3 id="数据库无法mount情况下获得数据库基本信息"><a href="#数据库无法mount情况下获得数据库基本信息" class="headerlink" title="数据库无法mount情况下获得数据库基本信息"></a>数据库无法mount情况下获得数据库基本信息</h3><h4 id="获得DB-NAME"><a href="#获得DB-NAME" class="headerlink" title="获得DB_NAME"></a>获得DB_NAME</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> status from v$instance;</span>
<span class="line"></span>
<span class="line">STATUS</span>
<span class="line">------------------------</span>
<span class="line">STARTED</span>
<span class="line"></span>
<span class="line">SQL&gt; show parameter db_name</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE                   VALUE</span>
<span class="line">------------------------------------ ---------------------- ------------------------------</span>
<span class="line">db_name                              string                 orcl</span>
</pre></td></tr></table></figure>
<p>也可以使用<a href="/2018/02/25/oracle/Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/01_Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%85%A5%E9%97%A8/#BBED解析DB-NAME">BBED解析DB-NAME</a></p>
<h4 id="获得字符集"><a href="#获得字符集" class="headerlink" title="获得字符集"></a>获得字符集</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> * from v$version;</span>
<span class="line"></span>
<span class="line">BANNER</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">Oracle Database <span class="number">11</span>g Enterprise Edition Release <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> - <span class="number">64</span>bit Production</span>
<span class="line">PL/SQL Release <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> - Production</span>
<span class="line">CORE    <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span>      Production</span>
<span class="line">TNS <span class="keyword">for</span> Linux: Version <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> - Production</span>
<span class="line">NLSRTL Version <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> - Production</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在同版本可正常打开的数据库中执行</span></span>
<span class="line"><span class="keyword">select</span> distinct dbms_rowid.rowid_relative_fno(rowid) file<span class="comment">#,</span></span>
<span class="line">       dbms_rowid.rowid_block_number(rowid) block<span class="comment">#</span></span>
<span class="line">  from props$;</span>
<span class="line"></span>
<span class="line">     FILE<span class="comment">#     BLOCK#</span></span>
<span class="line">---------- ----------</span>
<span class="line">         <span class="number">1</span>        <span class="number">801</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用dd工具dump</span></span>
<span class="line">dd <span class="keyword">if</span>=<span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/system</span>01.dbf of=<span class="regexp">/tmp/props</span> bs=<span class="number">8192</span> skip=<span class="number">801</span> count=<span class="number">1</span></span>
<span class="line"></span>
<span class="line">strings /tmp/props</span>
<span class="line"><span class="comment">#------------------------------</span></span>
<span class="line">......</span>
<span class="line">NLS_CHARACTERSET</span>
<span class="line">ZHS16GBK</span>
<span class="line">Character set,</span>
<span class="line">......</span>
<span class="line"><span class="comment">#------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="确认数据库是否归档"><a href="#确认数据库是否归档" class="headerlink" title="确认数据库是否归档"></a>确认数据库是否归档</h4><p>查看归档目录是否有文件，本测试是在归档环境</p>
<h3 id="恢复控制文件"><a href="#恢复控制文件" class="headerlink" title="恢复控制文件"></a>恢复控制文件</h3><p>结合上面获得的信息，构建创建controlfile的脚本恢复控制文件，根据REDO LOG日志是否有丢失，有以下两种</p>
<h4 id="NORESETLOGS"><a href="#NORESETLOGS" class="headerlink" title="NORESETLOGS"></a>NORESETLOGS</h4><p>REDO LOG日志没有丢失时使用NORESETLOGS脚本创建控制文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">STARTUP NOMOUNT</span>
<span class="line">CREATE CONTROLFILE REUSE DATABASE <span class="string">"ORCL"</span> NORESETLOGS  ARCHIVELOG</span>
<span class="line">    MAXLOGFILES <span class="number">16</span></span>
<span class="line">    MAXLOGMEMBERS <span class="number">3</span></span>
<span class="line">    MAXDATAFILES <span class="number">100</span></span>
<span class="line">    MAXINSTANCES <span class="number">8</span></span>
<span class="line">    MAXLOGHISTORY <span class="number">292</span></span>
<span class="line">LOGFILE</span>
<span class="line">  GROUP <span class="number">1</span> <span class="string">'/u01/app/oracle/oradata/orcl/redo01.log'</span>  SIZE <span class="number">50</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">  GROUP <span class="number">2</span> <span class="string">'/u01/app/oracle/oradata/orcl/redo02.log'</span>  SIZE <span class="number">50</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">  GROUP <span class="number">3</span> <span class="string">'/u01/app/oracle/oradata/orcl/redo03.log'</span>  SIZE <span class="number">50</span>M BLOCKSIZE <span class="number">512</span></span>
<span class="line">-- STANDBY LOGFILE</span>
<span class="line">DATAFILE</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/users01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/dsi01.dbf'</span></span>
<span class="line">CHARACTER SET ZHS16GBK</span>
<span class="line">;</span>
</pre></td></tr></table></figure></p>
<p>控制文件创建成功后，数据库打开到mount状态下<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 可以看到，两个controlfile都已被创建成功</span></span>
<span class="line">ll /u01/app/oracle/oradata/orcl/control01.ctl</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">10076160</span> Feb <span class="number">26</span> <span class="number">15</span>:<span class="number">58</span> /u01/app/oracle/oradata/orcl/control01.ctl</span>
<span class="line"></span>
<span class="line">ll /u01/app/oracle/fast_recovery_area/orcl/control02.ctl</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">10076160</span> Feb <span class="number">26</span> <span class="number">15</span>:<span class="number">59</span> /u01/app/oracle/fast_recovery_area/orcl/control02.ctl</span>
<span class="line"></span>
<span class="line"><span class="comment"># 数据库打开到mount状态下</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> status from v$instance;</span>
<span class="line"></span>
<span class="line">STATUS</span>
<span class="line">------------</span>
<span class="line">MOUNTED</span>
</pre></td></tr></table></figure></p>
<p>手工注册归档文件并打开数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> SEQUENCE<span class="comment">#,RESETLOGS_ID from v$archived_log;</span></span>
<span class="line"><span class="keyword">no</span> rows selected</span>
<span class="line"></span>
<span class="line">alter database register physical logfile <span class="string">'/u01/app/oracle/fast_recovery_area/ORCL/archivelog/2018_02_26/o1_mf_1_1_f97c8j9n_.arc'</span>;</span>
<span class="line">alter database register physical logfile <span class="string">'/u01/app/oracle/fast_recovery_area/ORCL/archivelog/2018_02_26/o1_mf_1_2_f97c8k76_.arc'</span>;</span>
<span class="line">alter database register physical logfile <span class="string">'/u01/app/oracle/fast_recovery_area/ORCL/archivelog/2018_02_26/o1_mf_1_3_f97c90sy_.arc'</span>;</span>
<span class="line">alter database register physical logfile <span class="string">'/u01/app/oracle/fast_recovery_area/ORCL/archivelog/2018_02_26/o1_mf_1_4_f97c92v1_.arc'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 如果归档很多，使用rman catalog方式注册归档，命令如下</span></span>
<span class="line">rman target /</span>
<span class="line">catalog start with <span class="string">'/u01/app/oracle/fast_recovery_area/ORCL/archivelog/2018_02_26/*.dbf'</span>;</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> SEQUENCE<span class="comment">#,RESETLOGS_ID from v$archived_log;</span></span>
<span class="line"></span>
<span class="line"> SEQUENCE<span class="comment"># RESETLOGS_ID</span></span>
<span class="line">---------- ------------</span>
<span class="line">         <span class="number">1</span>    <span class="number">969114806</span></span>
<span class="line">         <span class="number">2</span>    <span class="number">969114806</span></span>
<span class="line">         <span class="number">3</span>    <span class="number">969114806</span></span>
<span class="line">         <span class="number">4</span>    <span class="number">969114806</span></span>
<span class="line"><span class="comment"># 恢复数据库</span></span>
<span class="line">SQL&gt; recover database;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 所有redo日志归档（可选）</span></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> archive <span class="keyword">log</span> all;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 打开数据库</span></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建临时表空间</span></span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl/temp01.dbf'</span></span>
<span class="line">     SIZE <span class="number">500</span><span class="keyword">m</span>  REUSE AUTOEXTEND ON NEXT <span class="number">50</span><span class="keyword">m</span>  MAXSIZE <span class="number">32767</span>M;</span>
</pre></td></tr></table></figure></p>
<h4 id="RESETLOGS"><a href="#RESETLOGS" class="headerlink" title="RESETLOGS"></a>RESETLOGS</h4><p>重新准备环境<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 正常关闭数据库</span></span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除所有控制文件和redo log文件</span></span>
<span class="line">rm -rf /u01/app/oracle/oradata/orcl/control01.ctl</span>
<span class="line">rm -rf /u01/app/oracle/fast_recovery_area/orcl/control02.ctl</span>
<span class="line">rm -rf /u01/app/oracle/oradata/orcl/<span class="keyword">redo</span>*.log</span>
<span class="line"></span>
<span class="line">ll /u01/app/oracle/oradata/orcl/</span>
<span class="line">total <span class="number">2237496</span></span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">524296192</span> Feb <span class="number">26</span> <span class="number">17</span>:<span class="number">07</span> dsi01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">786440192</span> Feb <span class="number">26</span> <span class="number">17</span>:<span class="number">07</span> sysaux01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">796925952</span> Feb <span class="number">26</span> <span class="number">17</span>:<span class="number">07</span> system01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">524296192</span> Feb <span class="number">26</span> <span class="number">16</span>:<span class="number">34</span> temp01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">173023232</span> Feb <span class="number">26</span> <span class="number">17</span>:<span class="number">07</span> undotbs01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall   <span class="number">5251072</span> Feb <span class="number">26</span> <span class="number">17</span>:<span class="number">07</span> users01.dbf</span>
</pre></td></tr></table></figure></p>
<p>REDO LOG日志有丢失时需要重建时用RESETLOGS脚本创建控制文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">STARTUP NOMOUNT</span>
<span class="line">CREATE CONTROLFILE REUSE DATABASE <span class="string">"ORCL"</span> RESETLOGS  ARCHIVELOG</span>
<span class="line">    MAXLOGFILES <span class="number">16</span></span>
<span class="line">    MAXLOGMEMBERS <span class="number">3</span></span>
<span class="line">    MAXDATAFILES <span class="number">100</span></span>
<span class="line">    MAXINSTANCES <span class="number">8</span></span>
<span class="line">    MAXLOGHISTORY <span class="number">292</span></span>
<span class="line">LOGFILE</span>
<span class="line">  GROUP <span class="number">1</span> <span class="string">'/u01/app/oracle/oradata/orcl/redo01.log'</span>  SIZE <span class="number">50</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">  GROUP <span class="number">2</span> <span class="string">'/u01/app/oracle/oradata/orcl/redo02.log'</span>  SIZE <span class="number">50</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">  GROUP <span class="number">3</span> <span class="string">'/u01/app/oracle/oradata/orcl/redo03.log'</span>  SIZE <span class="number">50</span>M BLOCKSIZE <span class="number">512</span></span>
<span class="line">-- STANDBY LOGFILE</span>
<span class="line">DATAFILE</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/users01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl/dsi01.dbf'</span></span>
<span class="line">CHARACTER SET ZHS16GBK</span>
<span class="line">;</span>
<span class="line"><span class="comment"># 控制文件创建成功后，数据库打开到mount状态下</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 直接recover database报错</span></span>
<span class="line">SQL&gt; recover database;</span>
<span class="line">ORA-<span class="number">002</span>83: recovery session canceled due to errors</span>
<span class="line">ORA-<span class="number">01610</span>: recovery using the BACKUP CONTROLFILE option must be done</span>
<span class="line"></span>
<span class="line">SQL&gt; recover database using backup controlfile <span class="keyword">until</span> cancel;</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------</span></span>
<span class="line">ORA-<span class="number">0027</span>9: change <span class="number">2985399</span> generated at <span class="number">02</span>/<span class="number">26</span>/<span class="number">2018</span> <span class="number">17</span>:<span class="number">07</span>:08 needed <span class="keyword">for</span> thread <span class="number">1</span></span>
<span class="line">ORA-<span class="number">002</span>89: suggestion :</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/fast</span>_recovery_area/ORCL/archivelog/<span class="number">2018_02_26</span>/o1_mf_1_10<span class="number">_</span>%u_.arc</span>
<span class="line">ORA-<span class="number">002</span>8<span class="number">0</span>: change <span class="number">2985399</span> <span class="keyword">for</span> thread <span class="number">1</span> is in sequence <span class="comment">#10</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Specify <span class="keyword">log</span>: &#123;&lt;RET&gt;=suggested | filename | AUTO | CANCEL&#125;</span>
<span class="line">CANCEL</span>
<span class="line">Media recovery cancelled.</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># resetlogs打开数据库</span></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span> resetlogs;</span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建临时表空间</span></span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl/temp01.dbf'</span></span>
<span class="line">     SIZE <span class="number">500</span><span class="keyword">m</span>  REUSE AUTOEXTEND ON NEXT <span class="number">50</span><span class="keyword">m</span>  MAXSIZE <span class="number">32767</span>M;</span>
</pre></td></tr></table></figure></p>
<h2 id="RESETLOGS解析"><a href="#RESETLOGS解析" class="headerlink" title="RESETLOGS解析"></a>RESETLOGS解析</h2><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0226_oracle_dsi_01.png" alt=""></p>
<h2 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">CONFIGURE CONTROLFILE AUTOBACKUP ON;</span>
<span class="line">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO <span class="string">'/oradata/rmanbackup/ctrl_bak_%F'</span>;</span>
<span class="line">backup database <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/full_bak_%d_%T_%s_%U.bak'</span>;</span>
<span class="line">restore controlfile from autobackup;</span>
<span class="line"></span>
<span class="line">restore controlfile to <span class="string">'/u01/app/oracle/oradata/orcl/control01.ctl'</span> from <span class="string">'/oradata/rmanbackup/ctrl_bak_c-1493347395-20180226-02'</span>;</span>
<span class="line"></span>
<span class="line">list incarnation;</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> * from v$database_incarnation;</span>
<span class="line"></span>
<span class="line">INCARNATION<span class="comment"># RESETLOGS_CHANGE# RESETLOGS_TIME      PRIOR_RESETLOGS_CHANGE# PRIOR_RESETLOGS_TIM STATUS  RESETLOGS_ID PRIOR_INCARNATION# FLASHBACK_DATABASE_ALLOWED</span></span>
<span class="line">------------ ----------------- ------------------- ----------------------- ------------------- ------- ------------ ------------------ --------------------------</span>
<span class="line">           <span class="number">1</span>           <span class="number">2962246</span> <span class="number">2018</span>-<span class="number">02</span>-<span class="number">26</span> <span class="number">14</span>:<span class="number">33</span>:<span class="number">26</span>                  <span class="number">925702</span> <span class="number">2018</span>-<span class="number">01</span>-<span class="number">16</span> <span class="number">12</span>:<span class="number">57</span>:<span class="number">41</span> PARENT     <span class="number">969114806</span>                  <span class="number">0</span> NO</span>
<span class="line">           <span class="number">2</span>           <span class="number">2985400</span> <span class="number">2018</span>-<span class="number">02</span>-<span class="number">26</span> <span class="number">17</span>:<span class="number">24</span>:<span class="number">23</span>                 <span class="number">2962246</span> <span class="number">2018</span>-<span class="number">02</span>-<span class="number">26</span> <span class="number">14</span>:<span class="number">33</span>:<span class="number">26</span> CURRENT    <span class="number">969125063</span>                  <span class="number">1</span> NO</span>
</pre></td></tr></table></figure>
<h2 id="课后作业"><a href="#课后作业" class="headerlink" title="课后作业"></a>课后作业</h2><h3 id="哪些场景下需要用alter-database-open-resetlogs打开库？"><a href="#哪些场景下需要用alter-database-open-resetlogs打开库？" class="headerlink" title="哪些场景下需要用alter database open resetlogs打开库？"></a>哪些场景下需要用alter database open resetlogs打开库？</h3><ol>
<li>在不完全恢复（介质恢复）时</li>
<li>使用备份的控制文件进行数据库恢复时</li>
<li>丢失redo log，并使用RESETLOGS方式手工创建控制文件进行数据库恢复时</li>
</ol>
<h3 id="在删除所有controlfile和redolog日志的情况下shutdown-abort异常关库，能用resetlogs打开库吗？为什么？"><a href="#在删除所有controlfile和redolog日志的情况下shutdown-abort异常关库，能用resetlogs打开库吗？为什么？" class="headerlink" title="在删除所有controlfile和redolog日志的情况下shutdown abort异常关库，能用resetlogs打开库吗？为什么？"></a>在删除所有controlfile和redolog日志的情况下shutdown abort异常关库，能用resetlogs打开库吗？为什么？</h3><p>不能。<br>实例崩溃(shutdown abort)后启动数据库时需要恢复所需要的日志文件。丢失/损坏redolog日志的情况下，只能尝试使用隐含参数_allow_resetlogs_corruption，强制进行不完全恢复。</p>
<h3 id="用dd命令损坏其中一个控制文件的文件头（1号块）-然后尝试用startup-mount-命令挂载数据库报错-请用最快的恢复方式恢复控制文件，给出详细操作步骤？"><a href="#用dd命令损坏其中一个控制文件的文件头（1号块）-然后尝试用startup-mount-命令挂载数据库报错-请用最快的恢复方式恢复控制文件，给出详细操作步骤？" class="headerlink" title="用dd命令损坏其中一个控制文件的文件头（1号块）,然后尝试用startup mount;命令挂载数据库报错,请用最快的恢复方式恢复控制文件，给出详细操作步骤？"></a>用dd命令损坏其中一个控制文件的文件头（1号块）,然后尝试用startup mount;命令挂载数据库报错,请用最快的恢复方式恢复控制文件，给出详细操作步骤？</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ll</span>
<span class="line"><span class="comment">#---------------------------------------------------------------</span></span>
<span class="line">total <span class="number">2400952</span></span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall  <span class="number">10076160</span> Feb <span class="number">26</span> <span class="number">18</span>:<span class="number">13</span> control01.ctl</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">524296192</span> Feb <span class="number">26</span> <span class="number">18</span>:<span class="number">06</span> dsi01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall  <span class="number">52429312</span> Feb <span class="number">26</span> <span class="number">17</span>:<span class="number">32</span> redo01.log</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall  <span class="number">52429312</span> Feb <span class="number">26</span> <span class="number">17</span>:<span class="number">32</span> redo02.log</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall  <span class="number">52429312</span> Feb <span class="number">26</span> <span class="number">18</span>:<span class="number">12</span> redo03.log</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">786440192</span> Feb <span class="number">26</span> <span class="number">18</span>:<span class="number">06</span> sysaux01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">796925952</span> Feb <span class="number">26</span> <span class="number">18</span>:<span class="number">06</span> system01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">524296192</span> Feb <span class="number">26</span> <span class="number">17</span>:<span class="number">25</span> temp01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">173023232</span> Feb <span class="number">26</span> <span class="number">18</span>:<span class="number">06</span> undotbs01.dbf</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall   <span class="number">5251072</span> Feb <span class="number">26</span> <span class="number">18</span>:<span class="number">06</span> users01.dbf</span>
<span class="line"><span class="comment">#---------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">echo <span class="string">"database_name:orcl"</span> &gt; db</span>
<span class="line"></span>
<span class="line">dd <span class="keyword">if</span>=db of=control01.ctl bs=<span class="number">16834</span> <span class="keyword">seek</span>=<span class="number">1</span> count=<span class="number">1</span> conv=notrunc</span>
<span class="line"><span class="comment"># seek=BLOCKS     skip BLOCKS obs-sized blocks at start of output</span></span>
<span class="line"><span class="comment">#                 跳过一段以后才输出，是在备份时对of后面的部分也就是目标文件跳过多少块再开始写。</span></span>
<span class="line"><span class="comment"># conv=CONVS      convert the file as per the comma separated symbol list</span></span>
<span class="line"></span>
<span class="line">sqlplus / as sysdba</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">ORA-<span class="number">00227</span>: corrupt block detected in control file: (block <span class="number">1</span>, <span class="comment"># blocks 1)</span></span>
<span class="line">ORA-<span class="number">00202</span>: control file: <span class="string">'/u01/app/oracle/oradata/orcl/control01.ctl'</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> abort;</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line"></span>
<span class="line">SQL&gt; startup mount;</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">905970328</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3456106496</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">ORA-<span class="number">00227</span>: corrupt block detected in control file: (block <span class="number">0</span>, <span class="comment"># blocks )</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">$ bbed</span>
<span class="line"></span>
<span class="line">BBED: Release <span class="number">2.0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> - Limited Production on Mon Feb <span class="number">26</span> <span class="number">18</span>:<span class="number">22</span>:<span class="number">19</span> <span class="number">2018</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2011</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates.  All rights reserved.</span>
<span class="line"></span>
<span class="line">************* !!! For Oracle Internal Use only !!! ***************</span>
<span class="line"></span>
<span class="line">BBED&gt; set filename <span class="string">'/u01/app/oracle/oradata/orcl/control01.ctl'</span></span>
<span class="line">        FILENAME        /u01/app/oracle/oradata/orcl/control01.ctl</span>
<span class="line"></span>
<span class="line">BBED&gt; set block <span class="number">1</span></span>
<span class="line">        BLOCK<span class="comment">#          1</span></span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">dump</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/control</span>01.ctl (<span class="number">0</span>)</span>
<span class="line"> Block: <span class="number">1</span>                Offsets:    <span class="number">0</span> to  <span class="number">511</span>           Dba:<span class="number">0x00000000</span></span>
<span class="line">------------------------------------------------------------------------</span>
<span class="line"> <span class="number">15</span>c2000<span class="number">0</span> <span class="number">01000000</span> <span class="number">00000000</span> <span class="number">00000104</span> e9bd000<span class="number">0</span> <span class="number">00000000</span> <span class="number">0004200</span>b <span class="number">43</span>ac0259 </span>
<span class="line"> <span class="number">4</span>f52434c <span class="number">00000000</span> <span class="number">6</span>d56000<span class="number">0</span> <span class="number">66020000</span> <span class="number">00400000</span> <span class="number">00000100</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">8</span>d4f3859 0eaac339 c5942d0<span class="number">0</span> <span class="number">00000000</span> c0b6c339 <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> 0800000<span class="number">0</span> 0800000<span class="number">0</span> 0800000<span class="number">0</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">01000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00006461</span> <span class="number">74616261</span> <span class="number">73655</span>f6e <span class="number">616</span>d653a <span class="number">6</span>f72636c 0a00000<span class="number">0</span> <span class="number">00000000</span> <span class="number">00000000</span></span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"></span>
<span class="line"> &lt;<span class="number">32</span> bytes per line&gt;</span>
</pre></td></tr></table></figure>
<p>最快的恢复方式恢复控制文件，就是用第二个控制文件来恢复第一个<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cp /u01/app/oracle/fast_recovery_area/orcl/control02.ctl /u01/app/oracle/oradata/orcl/control01.ctl</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database mount;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
</pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> Oracle特殊恢复原理与实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> DSI </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle特殊恢复原理与实战_01 Oracle特殊恢复入门]]></title>
      <url>/2018/02/25/oracle/Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E6%88%98-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/01_Oracle%E7%89%B9%E6%AE%8A%E6%81%A2%E5%A4%8D%E5%85%A5%E9%97%A8/</url>
      <content type="html"><![CDATA[<blockquote>
<p><strong>本课程就是基于Oracle DSI403e学习Oracle特殊恢复</strong></p>
</blockquote>
<h2 id="DSI介绍"><a href="#DSI介绍" class="headerlink" title="DSI介绍"></a>DSI介绍</h2><p>DSI是Data Server Internals的缩写，是Oracle公司内部用来培训Oracle售后工程师使用的教材<br>DSI课程系统包括：</p>
<ul>
<li>DSI303  Advanced Backup, Restore and recovery Techniques</li>
<li>DSI401  Dumps Crashes and Corruptions</li>
<li>DSI402  Space and Transaction Management</li>
<li>DSI402e Data types and block structures</li>
<li>DSI403e Recovery Architecture Components</li>
<li>DSI404e Query Optimizer</li>
<li>DSI405  Performance TUning</li>
<li>DSI408  Real Application clusters Internals</li>
</ul>
<h2 id="BBED工具介绍"><a href="#BBED工具介绍" class="headerlink" title="BBED工具介绍"></a>BBED工具介绍</h2><ul>
<li>BBED stands for <strong><font color="red">B</font></strong>lock <strong><font color="red">B</font></strong>rower and <strong><font color="red">ED</font></strong>itor</li>
<li>BBED只是一款工具，类似于ultraEdit，单纯的会用BBED来修改数据没有任何意义！关键是要知道为什么要这么改！</li>
<li>在充分了解Block格式和Oracle的各种机制的基础上广泛使用BBED，用它来帮你构造测试案例，用它来验证测试结果，<strong><font color="red">用它来帮你深入理解Oracle！</font></strong></li>
</ul>
<a id="more"></a>
<h2 id="BBED工具使用"><a href="#BBED工具使用" class="headerlink" title="BBED工具使用"></a>BBED工具使用</h2><h3 id="安装bbed工具"><a href="#安装bbed工具" class="headerlink" title="安装bbed工具"></a>安装bbed工具</h3><p>上传sbbdpt.o、ssbbded.o、bbedus.msb(拷贝oracle的linux64版本)<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cp sbbdpt.o $ORACLE_HOME/rdbms/lib/ssbbded.o</span>
<span class="line">cp ssbbded.o $ORACLE_HOME/rdbms/lib/sbbdpt.o</span>
<span class="line">cp bbedus.msb $ORACLE_HOME/rdbms/mesg/bbedus.msb</span>
<span class="line"></span>
<span class="line">cd $ORACLE_HOME/rdbms/lib</span>
<span class="line">make -f $ORACLE_HOME/rdbms/lib/ins_rdbms.mk BBED=$ORACLE_HOME/bin/bbed $ORACLE_HOME/bin/bbed</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line">inking BBED utility (bbed)</span>
<span class="line">rm -f /u01/app/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/bin/bbed</span>
<span class="line">gcc -o /u01/app/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/bin/bbed -m64 -z noexecstack -L/u01/app/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/rdbms/lib/</span>
<span class="line"> -L/u01/app/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/lib/ -L/u01/app/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/lib/stubs/  </span>
<span class="line"> <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/11.2.0/db</span>_1/lib/s0main.o /u01/app/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/rdbms/lib/ssbbded.o </span>
<span class="line"> /u01/app/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/rdbms/lib/sbbdpt.o <span class="string">`cat /u01/app/oracle/product/11.2.0/db_1/lib/ldflags`</span>    </span>
<span class="line"> -lncrypt11 -lnsgr11 -lnzjs11 -ln11 -lnl11 -ldbtools11 -lclntsh  <span class="string">`cat /u01/app/oracle/product/11.2.0/db_1/lib/ldflags`</span>    </span>
<span class="line"> -lncrypt11 -lnsgr11 -lnzjs11 -ln11 -lnl11 -lnro11 <span class="string">`cat /u01/app/oracle/product/11.2.0/db_1/lib/ldflags`</span>    </span>
<span class="line"> -lncrypt11 -lnsgr11 -lnzjs11 -ln11 -lnl11 -lnnz11 -lzt11 -lztkg11 -lclient11 -lnnetd11  -lvsn11 -lcommon11 </span>
<span class="line"> -lgeneric11 -lmm -lsnls11 -lnls11  -lcore11 -lsnls11 -lnls11 -lcore11 -lsnls11 -lnls11 -lxml11 -lcore11 -lunls11 </span>
<span class="line"> -lsnls11 -lnls11 -lcore11 -lnls11 <span class="string">`cat /u01/app/oracle/product/11.2.0/db_1/lib/ldflags`</span>    -lncrypt11 -lnsgr11 </span>
<span class="line"> -lnzjs11 -ln11 -lnl11 -lnro11 <span class="string">`cat /u01/app/oracle/product/11.2.0/db_1/lib/ldflags`</span>    </span>
<span class="line"> -lncrypt11 -lnsgr11 -lnzjs11 -ln11 -lnl11 -lclient11 -lnnetd11  -lvsn11 -lcommon11 -lgeneric11   </span>
<span class="line"> -lsnls11 -lnls11  -lcore11 -lsnls11 -lnls11 -lcore11 -lsnls11 -lnls11 -lxml11 -lcore11 -lunls11 -lsnls11 </span>
<span class="line"> -lnls11 -lcore11 -lnls11 -lclient11 -lnnetd11  -lvsn11 -lcommon11 -lgeneric11 -lsnls11 -lnls11  -lcore11 </span>
<span class="line"> -lsnls11 -lnls11 -lcore11 -lsnls11 -lnls11 -lxml11 -lcore11 -lunls11 -lsnls11 -lnls11 -lcore11 -lnls11   </span>
<span class="line"> <span class="string">`cat /u01/app/oracle/product/11.2.0/db_1/lib/sysliblist`</span> -Wl,-rpath,<span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/11.2.0/db</span>_1/lib -lm    </span>
<span class="line"> <span class="string">`cat /u01/app/oracle/product/11.2.0/db_1/lib/sysliblist`</span> -ldl -lm   -L/u01/app/oracle/product/<span class="number">11.2</span>.<span class="number">0</span>/db_1/lib <span class="string">`</span>
<span class="line">#------------------------------------------------------------------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">ll $ORACLE_HOME/bin/bbed</span>
<span class="line">-rwxr-xr-x 1 oracle oinstall 255110 Feb 25 12:04 /u01/app/oracle/product/11.2.0/db_1/bin/bbed</span></span>
</pre></td></tr></table></figure></p>
<h3 id="配置使用BBED"><a href="#配置使用BBED" class="headerlink" title="配置使用BBED"></a>配置使用BBED</h3><h4 id="直接登入"><a href="#直接登入" class="headerlink" title="直接登入"></a>直接登入</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">$ bbed</span>
<span class="line">Password: blockedit   </span>
<span class="line"></span>
<span class="line">BBED: Release <span class="number">2.0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> - Limited Production on Sun Feb <span class="number">25</span> <span class="number">12</span>:<span class="number">14</span>:<span class="number">21</span> <span class="number">2018</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2011</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates.  All rights reserved.</span>
<span class="line"></span>
<span class="line">************* !!! For Oracle Internal Use only !!! ***************</span>
<span class="line"></span>
<span class="line">BBED&gt; <span class="keyword">exit</span></span>
</pre></td></tr></table></figure>
<h4 id="配置文件登入"><a href="#配置文件登入" class="headerlink" title="配置文件登入"></a>配置文件登入</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sqlplus / as sysdba</span>
<span class="line">SQL&gt; <span class="keyword">select</span> file<span class="comment">#||chr(9)||name||chr(9)||bytes from v$datafile;</span></span>
<span class="line"></span>
<span class="line">FILE<span class="comment">#||CHR(9)||NAME||CHR(9)||BYTES</span></span>
<span class="line">----------------------------------------------------------------------------</span>
<span class="line"><span class="number">1</span>       /u01/app/oracle/oradata/dgt/system01.dbf        <span class="number">734003200</span></span>
<span class="line"><span class="number">2</span>       /u01/app/oracle/oradata/dgt/sysaux01.dbf        <span class="number">629145600</span></span>
<span class="line"><span class="number">3</span>       /u01/app/oracle/oradata/dgt/undotbs01.dbf       <span class="number">209715200</span></span>
<span class="line"><span class="number">4</span>       /u01/app/oracle/oradata/dgt/users01.dbf <span class="number">5242880</span></span>
<span class="line"><span class="number">5</span>       /u01/app/oracle/oradata/dgt/dsi01.dbf   <span class="number">524288000</span></span>
<span class="line">SQL&gt; <span class="keyword">exit</span></span>
<span class="line"></span>
<span class="line">cd ~</span>
<span class="line">vi par.txt</span>
<span class="line"><span class="comment">#-------------------------------------------------------</span></span>
<span class="line">blocksize=<span class="number">8192</span></span>
<span class="line">listfile=filelist.txt</span>
<span class="line">mode=edit</span>
<span class="line"><span class="comment">#-------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">vi filelist.txt</span>
<span class="line"><span class="comment">#-------------------------------------------------------</span></span>
<span class="line"><span class="number">1</span>       /u01/app/oracle/oradata/dgt/system01.dbf        <span class="number">734003200</span></span>
<span class="line"><span class="number">2</span>       /u01/app/oracle/oradata/dgt/sysaux01.dbf        <span class="number">629145600</span></span>
<span class="line"><span class="number">3</span>       /u01/app/oracle/oradata/dgt/undotbs01.dbf       <span class="number">209715200</span></span>
<span class="line"><span class="number">4</span>       /u01/app/oracle/oradata/dgt/users01.dbf <span class="number">5242880</span></span>
<span class="line"><span class="number">5</span>       /u01/app/oracle/oradata/dgt/dsi01.dbf   <span class="number">524288000</span></span>
<span class="line"><span class="comment">#-------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 用别名的方式直接登录</span></span>
<span class="line">echo <span class="string">"alias bbed='rlwrap bbed parfile=par.txt password=blockedit'"</span> &gt;&gt; <span class="regexp">/home/oracle</span><span class="regexp">/.bash_profile</span>
<span class="line"></span>
<span class="line">source /home</span><span class="regexp">/oracle/</span>.bash_profile</span>
<span class="line"></span>
<span class="line">bbed</span>
<span class="line"><span class="comment">#-------------------------------------------------------</span></span>
<span class="line">BBED: Release <span class="number">2.0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> - Limited Production on Sun Feb <span class="number">25</span> <span class="number">12</span>:<span class="number">34</span>:<span class="number">15</span> <span class="number">2018</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2011</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates.  All rights reserved.</span>
<span class="line"></span>
<span class="line">************* !!! For Oracle Internal Use only !!! ***************</span>
</pre></td></tr></table></figure>
<h4 id="BBED常用命令"><a href="#BBED常用命令" class="headerlink" title="BBED常用命令"></a>BBED常用命令</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">常用命令：set、find、<span class="keyword">dump</span>、modify、sum apply、examine、<span class="keyword">map</span> 、<span class="keyword">print</span>、verity，示例如下：</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看访问的数据文件列表</span></span>
<span class="line">BBED&gt; info</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------</span></span>
<span class="line"> File<span class="comment">#  Name                                                        Size(blks)</span></span>
<span class="line"> -----  ----                                                        ----------</span>
<span class="line">     <span class="number">1</span>  /u01/app/oracle/oradata/dgt/system01.dbf                         <span class="number">89600</span></span>
<span class="line">     <span class="number">2</span>  /u01/app/oracle/oradata/dgt/sysaux01.dbf                         <span class="number">76800</span></span>
<span class="line">     <span class="number">3</span>  /u01/app/oracle/oradata/dgt/undotbs01.dbf                        <span class="number">25600</span></span>
<span class="line">     <span class="number">4</span>  /u01/app/oracle/oradata/dgt/users01.dbf                            <span class="number">640</span></span>
<span class="line">     <span class="number">5</span>  /u01/app/oracle/oradata/dgt/dsi01.dbf                            <span class="number">64000</span></span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">set file <span class="number">5</span> block <span class="number">1</span> <span class="comment"># 访问5号文件的1号块</span></span>
<span class="line">set dba <span class="number">0x01000020</span></span>
<span class="line">set offset <span class="number">0</span>       <span class="comment"># 0表示第一个字节开始</span></span>
<span class="line">set block <span class="number">1</span>        <span class="comment"># 1表示第一个块开始</span></span>
<span class="line">set count <span class="number">8192</span>     <span class="comment"># 默认是显示512字节</span></span>
<span class="line"></span>
<span class="line">find /<span class="keyword">x</span> <span class="number">05</span>d67g     <span class="comment"># 查指定的字符串在指定数据块中的具体位置</span></span>
<span class="line">                   <span class="comment"># f --find的简写，表示继续从当前位置开始往下查询字符串05d67g</span></span>
<span class="line"><span class="keyword">dump</span>               <span class="comment"># 十六进制查看block</span></span>
<span class="line"><span class="keyword">dump</span> /v            <span class="comment"># 查看十六进制内容的同时以文本方式“翻译”十六进制显示的内容，相当于对当前block执行strings命令</span></span>
<span class="line"></span>
<span class="line">modify /<span class="keyword">x</span> d43      <span class="comment"># 修改指定block,指定offset的数据块块内记录的内容</span></span>
<span class="line">sum apply          <span class="comment"># 计算修改后的数据块的checksum值，然后写入数据块的offset为16-17的位置</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">map</span> /v             <span class="comment"># 查看块结构</span></span>
</pre></td></tr></table></figure>
<h3 id="BBED解析DB-NAME"><a href="#BBED解析DB-NAME" class="headerlink" title="BBED解析DB_NAME"></a>BBED解析DB_NAME</h3><p>DB_NAME数据库名，长度不能超出8个字符，记录在datafile,redolog和control file文件头中<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">BBED&gt; set file <span class="number">5</span> block <span class="number">1</span></span>
<span class="line">        FILE<span class="comment">#           5</span></span>
<span class="line">        BLOCK<span class="comment">#          1</span></span>
</pre></td></tr></table></figure></p>
<p>kcvfh：Kernel Cache recoVer File Header<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0225_oracle_dsi_01.png" alt=""></p>
<p>从下图可以验证DB_NAME最长只能为8个字节，DB_NAME是DGT<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0225_oracle_dsi_02.png" alt=""></p>
<p>用dump方式查看DB_NAME<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0225_oracle_dsi_03.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> <span class="keyword">chr</span>(to_number(<span class="keyword">substr</span>(<span class="string">'4447540000000000'</span>,rownum*<span class="number">2</span>-<span class="number">1</span>,<span class="number">2</span>),<span class="string">'xxxxxxxx'</span>)) from dba_objects where rownum&lt;=<span class="number">9</span>;</span>
<span class="line"></span>
<span class="line">CH</span>
<span class="line">--</span>
<span class="line">D</span>
<span class="line">G</span>
<span class="line">T</span>
</pre></td></tr></table></figure></p>
<h2 id="诊断trace-files"><a href="#诊断trace-files" class="headerlink" title="诊断trace files"></a>诊断trace files</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> <span class="keyword">events</span> <span class="string">'immediate trace name controlf level N'</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> <span class="keyword">events</span> <span class="string">'immediate trace name file_hdrs level N'</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> <span class="keyword">events</span> <span class="string">'immediate trace name redohdr level N'</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> <span class="keyword">events</span> <span class="string">'immediate trace name treedump level 64952'</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> dump <span class="keyword">datafile</span> <span class="number">3</span> <span class="keyword">block</span> <span class="number">256</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> dump <span class="keyword">logfile</span> <span class="string">'/u01/app/oracle/oradata/dgt/redo01.log'</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> dump <span class="keyword">undo</span> header <span class="string">"_SYSSMU17_3012809736$"</span>;</span>
</pre></td></tr></table></figure>
<p>详见：<a href="http://www.cnblogs.com/rootq/archive/2008/11/12/1332239.html" target="_blank" rel="external">Oracle数据库event事件与dump文件介绍</a></p>
<h2 id="Recovery算法"><a href="#Recovery算法" class="headerlink" title="Recovery算法"></a>Recovery算法</h2><p>Oracle为了在任何情况下都能顺利执行recovery操作，采用了一系列的算法/设计来保证recovery的成功实施：</p>
<ul>
<li>Page Fix  块修复</li>
<li>Write-Ahead-Log  日志优先写</li>
<li>Log-force-at-commit  提交必须把日志写到日志文件</li>
<li>Online-Log Switch Management  日志切换管理</li>
<li>Checkpointing  检查点</li>
<li>Thread-Open Flag  线程打开的标记</li>
<li>Incremental Checkpointing  增量检查点</li>
<li>Two-Pass Recovery  两次恢复</li>
</ul>
<h3 id="Page-Fix-Rule"><a href="#Page-Fix-Rule" class="headerlink" title="Page Fix Rule"></a>Page Fix Rule</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0225_oracle_dsi_04.png" alt=""></p>
<h3 id="Write-Ahead-Logging"><a href="#Write-Ahead-Logging" class="headerlink" title="Write Ahead Logging"></a>Write Ahead Logging</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0225_oracle_dsi_05.png" alt=""></p>
<h3 id="Online-Log-Switching"><a href="#Online-Log-Switching" class="headerlink" title="Online Log Switching"></a>Online Log Switching</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0225_oracle_dsi_06.png" alt=""></p>
<h3 id="Checkpoint"><a href="#Checkpoint" class="headerlink" title="Checkpoint"></a>Checkpoint</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0225_oracle_dsi_07.png" alt=""><br>RBA(Redo Block Address)，由三部分组成，80-日志序列号，20-日志第几个block，16-在这个块上的第几个字节</p>
<h2 id="Recovery方法"><a href="#Recovery方法" class="headerlink" title="Recovery方法"></a>Recovery方法</h2><ul>
<li>Recovery for a thread starts at last checkpoint</li>
<li>Recovery progresses, redo record by redo record, until all available redo has been applied<ul>
<li>Find the block</li>
<li>Block time &gt; Redo record time: Skip block</li>
<li>Block time = Redo record time: Apply changes</li>
<li>Block time &lt; Redo record time: Stuck recovery(ORA-600[3020])</li>
</ul>
</li>
<li>No generation of redo</li>
</ul>
<h3 id="通过BBED工具修改文件头信息，使数据库不能正常打开"><a href="#通过BBED工具修改文件头信息，使数据库不能正常打开" class="headerlink" title="通过BBED工具修改文件头信息，使数据库不能正常打开"></a>通过BBED工具修改文件头信息，使数据库不能正常打开</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 关闭数据库</span></span>
<span class="line"><span class="keyword">shutdown</span> immedaite</span>
<span class="line"></span>
<span class="line"><span class="comment"># 通过BBED工具修改文件头信息</span></span>
<span class="line">bbed</span>
<span class="line"></span>
<span class="line">BBED&gt; info</span>
<span class="line"> File<span class="comment">#  Name                                                        Size(blks)</span></span>
<span class="line"> -----  ----                                                        ----------</span>
<span class="line">     <span class="number">1</span>  /u01/app/oracle/oradata/dgt/system01.dbf                         <span class="number">89600</span></span>
<span class="line">     <span class="number">2</span>  /u01/app/oracle/oradata/dgt/sysaux01.dbf                         <span class="number">76800</span></span>
<span class="line">     <span class="number">3</span>  /u01/app/oracle/oradata/dgt/undotbs01.dbf                        <span class="number">25600</span></span>
<span class="line">     <span class="number">4</span>  /u01/app/oracle/oradata/dgt/users01.dbf                            <span class="number">640</span></span>
<span class="line">     <span class="number">5</span>  /u01/app/oracle/oradata/dgt/dsi01.dbf                            <span class="number">64000</span></span>
<span class="line"></span>
<span class="line">BBED&gt; set file <span class="number">5</span> block <span class="number">1</span></span>
<span class="line">        FILE<span class="comment">#           5</span></span>
<span class="line">        BLOCK<span class="comment">#          1</span></span>
<span class="line"></span>
<span class="line">BBED&gt; p kcvfhcpc</span>
<span class="line">ub4 kcvfhcpc                                @140      <span class="number">0x00000003</span></span>
<span class="line"></span>
<span class="line">BBED&gt; p kcvfhccc</span>
<span class="line">ub4 kcvfhccc                                @148      <span class="number">0x00000002</span></span>
<span class="line"></span>
<span class="line">BBED&gt; modify /<span class="keyword">x</span> <span class="number">1</span> offset <span class="number">140</span></span>
<span class="line"> File: <span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/dgt/dsi</span>01.dbf (<span class="number">5</span>)</span>
<span class="line"> Block: <span class="number">1</span>                Offsets:  <span class="number">140</span> to  <span class="number">651</span>           Dba:<span class="number">0x01400001</span></span>
<span class="line">------------------------------------------------------------------------</span>
<span class="line"> <span class="number">01000000</span> <span class="number">00000000</span> <span class="number">02000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">05000000</span> <span class="number">03004453</span> <span class="number">49000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">05000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">961</span>b430<span class="number">0</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">7547</span>c239 <span class="number">01000000</span> <span class="number">44000000</span> d297040<span class="number">0</span> <span class="number">10004964</span> <span class="number">02000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> </span>
<span class="line"> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> <span class="number">00000000</span> 0d000d0<span class="number">0</span> 0d00010<span class="number">0</span> </span>
<span class="line"></span>
<span class="line"> &lt;<span class="number">32</span> bytes per line&gt;</span>
<span class="line"></span>
<span class="line">BBED&gt; sum apply</span>
<span class="line">Check value <span class="keyword">for</span> File <span class="number">5</span>, Block <span class="number">1</span>:</span>
<span class="line">current = <span class="number">0x82d5</span>, required = <span class="number">0x82d5</span></span>
<span class="line"></span>
<span class="line">BBED&gt; p kcvfhcpc</span>
<span class="line">ub4 kcvfhcpc                                @140      <span class="number">0x00000001</span></span>
<span class="line"></span>
<span class="line">BBED&gt; p kcvfhccc</span>
<span class="line">ub4 kcvfhccc                                @148      <span class="number">0x00000002</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># kcvfhcpc（检查点的计数器）的值要大于kcvfhccc（检查点的控制文件备份的计数器）</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 这时已经不能打开数据库了</span></span>
<span class="line">SQL&gt; startup</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4409401344</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260408</span> bytes</span>
<span class="line">Variable Size            <span class="number">1140851272</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3254779904</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11509760</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">ORA-<span class="number">01113</span>: file <span class="number">5</span> needs media recovery</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">5</span>: <span class="string">'/u01/app/oracle/oradata/dgt/dsi01.dbf'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># alter日志中有以下错误提示</span></span>
<span class="line">Errors in file /u01/app/oracle/diag/rdbms/dgtp/dgt/trace/dgt_ora_10717.trc:</span>
<span class="line">ORA-<span class="number">01113</span>: file <span class="number">5</span> needs media recovery</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">5</span>: <span class="string">'/u01/app/oracle/oradata/dgt/dsi01.dbf'</span></span>
<span class="line">ORA-<span class="number">1113</span> signalled during: ALTER DATABASE OPEN...</span>
</pre></td></tr></table></figure>
<h2 id="参考文件："><a href="#参考文件：" class="headerlink" title="参考文件："></a>参考文件：</h2><ul>
<li><a href="https://www.2cto.com/database/201406/309329.html" target="_blank" rel="external">利用BBED恢复数据文件头</a></li>
</ul>
<h2 id="编译安装lrzsz"><a href="#编译安装lrzsz" class="headerlink" title="编译安装lrzsz"></a>编译安装lrzsz</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">tar xvpf lrzsz-<span class="number">0</span>.<span class="number">12.20</span>.tar.gz</span>
<span class="line">cd lrzsz-<span class="number">0</span>.<span class="number">12.20</span></span>
<span class="line">./configure --prefix=<span class="regexp">/usr/local</span><span class="regexp">/lrzsz</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line">cd /usr</span><span class="regexp">/bin</span>
<span class="line">ln -s /usr</span><span class="regexp">/local/lrzsz</span><span class="regexp">/bin/lrz</span> rz</span>
<span class="line">ln -<span class="keyword">s</span> /usr/<span class="keyword">local</span>/lrzsz/bin/lsz sz</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Oracle特殊恢复原理与实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> DSI </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_07 搭建harbor企业级私有registry]]></title>
      <url>/2018/01/30/docker/07_%E6%90%AD%E5%BB%BAharbor%E4%BC%81%E4%B8%9A%E7%BA%A7register/</url>
      <content type="html"><![CDATA[<h2 id="主机环境要求"><a href="#主机环境要求" class="headerlink" title="主机环境要求"></a>主机环境要求</h2><h3 id="硬件Hardware"><a href="#硬件Hardware" class="headerlink" title="硬件Hardware"></a>硬件Hardware</h3><table>
<thead>
<tr>
<th>Resource</th>
<th>Capacity</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU</td>
<td>minimal 2 CPU</td>
<td>4 CPU is prefered</td>
</tr>
<tr>
<td>Mem</td>
<td>minimal 4GB</td>
<td>8GB is prefered</td>
</tr>
<tr>
<td>Disk</td>
<td>minimal 40GB</td>
<td>160GB is prefered</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h3 id="软件Software"><a href="#软件Software" class="headerlink" title="软件Software"></a>软件Software</h3><table>
<thead>
<tr>
<th>Software</th>
<th>Version</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Python</td>
<td>version 2.7 or higher</td>
<td>Note that you may have to install Python on Linux distributions (Gentoo, Arch) that do not come with a Python interpreter installed by default</td>
</tr>
<tr>
<td>Docker engine</td>
<td>version 1.10 or higher</td>
<td>For installation instructions, please refer to: <a href="https://docs.docker.com/engine/installation/" target="_blank" rel="external">https://docs.docker.com/engine/installation/</a></td>
</tr>
<tr>
<td>Docker Compose</td>
<td>version 1.6.0 or higher</td>
<td>For installation instructions, please refer to: <a href="https://docs.docker.com/compose/install/" target="_blank" rel="external">https://docs.docker.com/compose/install/</a></td>
</tr>
<tr>
<td>Openssl</td>
<td>latest is prefered</td>
<td>Generate certificate and keys for Harbor</td>
</tr>
</tbody>
</table>
<h3 id="网络端口Network-ports"><a href="#网络端口Network-ports" class="headerlink" title="网络端口Network ports"></a>网络端口Network ports</h3><table>
<thead>
<tr>
<th>Port</th>
<th>Protocol</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>443</td>
<td>HTTPS</td>
<td>Harbor UI and API will accept requests on this port for https protocol</td>
</tr>
<tr>
<td>4443</td>
<td>HTTS</td>
<td>Connections to the Docker Content Trust service for Harbor, only needed when Notary is enabled</td>
</tr>
<tr>
<td>80</td>
<td>HTTP</td>
<td>Harbor UI and API will accept requests on this port for http protocol</td>
</tr>
</tbody>
</table>
<h2 id="安装harbor"><a href="#安装harbor" class="headerlink" title="安装harbor"></a>安装harbor</h2><h3 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h3><p>详见<a href="/2018/01/11/docker/03_docker的部署安装-Ubuntu/">docker的部署安装</a></p>
<h3 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">curl -L https:<span class="regexp">//github</span>.com/docker/compose/releases/download/<span class="number">1.18</span>.<span class="number">0</span>/docker-compose-<span class="string">`uname -s`</span>-<span class="string">`uname -m`</span> -o /usr/<span class="keyword">local</span>/bin/docker-compose</span>
<span class="line"><span class="keyword">chmod</span> +<span class="keyword">x</span> /usr/<span class="keyword">local</span>/bin/docker-compose</span>
<span class="line"></span>
<span class="line">docker-compose version</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">docker-compose version <span class="number">1.18</span>.<span class="number">0</span>, build <span class="number">8</span>dd22a9</span>
<span class="line">docker-py version: <span class="number">2.6</span>.<span class="number">1</span></span>
<span class="line">CPython version: <span class="number">2.7</span>.<span class="number">13</span></span>
<span class="line">OpenSSL version: OpenSSL <span class="number">1.0</span>.<span class="number">1</span>t  <span class="number">3</span> May <span class="number">2016</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="下载harbor离线包"><a href="#下载harbor离线包" class="headerlink" title="下载harbor离线包"></a>下载harbor离线包</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">wget http:<span class="regexp">//harbor</span>.orientsoft.cn/harbor-v1.<span class="number">3.0</span>/harbor-offline-installer-v1.<span class="number">3.0</span>.tgz</span>
<span class="line">tar xvf harbor-offline-installer-v1.<span class="number">3.0</span>.tgz</span>
</pre></td></tr></table></figure>
<h3 id="配置HTTPS所需证书"><a href="#配置HTTPS所需证书" class="headerlink" title="配置HTTPS所需证书"></a>配置HTTPS所需证书</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> /data</span>
<span class="line"><span class="keyword">mkdir</span> /root/data</span>
<span class="line">cd /root/data</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建自已的CA证书</span></span>
<span class="line">openssl req -newkey rsa:<span class="number">4096</span> -nodes -sha256 -keyout ca.key -x509 -days <span class="number">3650</span> -out ca.crt</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">Country Name (<span class="number">2</span> letter code) [AU]:CN</span>
<span class="line">State <span class="keyword">or</span> Province Name (full name) [Some-State]:Harbin</span>
<span class="line">Locality Name (eg, city) []:Harbin</span>
<span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:ydgw</span>
<span class="line">Organizational Unit Name (eg, section) []:ydgw</span>
<span class="line">Common Name (e.g. server FQDN <span class="keyword">or</span> YOUR name) []:<span class="number">10.240</span>.<span class="number">4.159</span></span>
<span class="line">Email Address []:liuyajun@ydgw.cn</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 生成一个证书签名请求</span></span>
<span class="line">openssl req  -newkey rsa:<span class="number">4096</span> -nodes -sha256 -keyout <span class="number">10.240</span>.<span class="number">4.159</span>.key -out <span class="number">10.240</span>.<span class="number">4.159</span>.csr</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">Country Name (<span class="number">2</span> letter code) [AU]:CN</span>
<span class="line">State <span class="keyword">or</span> Province Name (full name) [Some-State]:Harbin</span>
<span class="line">Locality Name (eg, city) []:Harbin</span>
<span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:ydgw</span>
<span class="line">Organizational Unit Name (eg, section) []:ydgw</span>
<span class="line">Common Name (e.g. server FQDN <span class="keyword">or</span> YOUR name) []:<span class="number">10.240</span>.<span class="number">4.159</span></span>
<span class="line">Email Address []:liuyajun@ydgw.cn</span>
<span class="line"></span>
<span class="line">Please enter the following <span class="string">'extra'</span> attributes</span>
<span class="line">to be sent with your certificate request</span>
<span class="line">A challenge password []:   <span class="comment">#密码留空即可</span></span>
<span class="line">An optional company name []:</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建文件夹和辅助内容</span></span>
<span class="line"><span class="keyword">mkdir</span> demoCA</span>
<span class="line">cd demoCA</span>
<span class="line">touch index.txt</span>
<span class="line">echo <span class="string">'01'</span> &gt; serial</span>
<span class="line">cd ..</span>
<span class="line"></span>
<span class="line">ll</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">total <span class="number">28</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">3</span> root root <span class="number">4096</span> Jan <span class="number">30</span> <span class="number">22</span>:<span class="number">11</span> ./</span>
<span class="line">drwx------ <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">30</span> <span class="number">22</span>:09 ../</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1740</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">38</span> <span class="number">10.240</span>.<span class="number">4.159</span>.csr</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3272</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">38</span> <span class="number">10.240</span>.<span class="number">4.159</span>.key</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">37</span> ca.crt</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3272</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">37</span> ca.key</span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">2</span> root root <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">39</span> demoCA/</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 签名证书</span></span>
<span class="line">echo subjectAltName = IP:<span class="number">10.240</span>.<span class="number">4.159</span> &gt; extfile.cnf</span>
<span class="line">openssl ca -in <span class="number">10.240</span>.<span class="number">4.159</span>.csr -out <span class="number">10.240</span>.<span class="number">4.159</span>.crt -cert ca.crt -keyfile ca.key -extfile extfile.cnf -days <span class="number">3650</span> -outdir .</span>
<span class="line"></span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">Using configuration from /usr/lib/ssl/openssl.cnf</span>
<span class="line">Check that the request matches the signature</span>
<span class="line">Signature ok</span>
<span class="line">Certificate Details:</span>
<span class="line">        Serial Number: <span class="number">1</span> (<span class="number">0x1</span>)</span>
<span class="line">        Validity</span>
<span class="line">            Not Before: Jan <span class="number">31</span> <span class="number">06</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2018</span> GMT</span>
<span class="line">            Not After : Jan <span class="number">31</span> <span class="number">06</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2019</span> GMT</span>
<span class="line">        Subject:</span>
<span class="line">            countryName               = CN</span>
<span class="line">            stateOrProvinceName       = Harbin</span>
<span class="line">            organizationName          = ydgw</span>
<span class="line">            organizationalUnitName    = ydgw</span>
<span class="line">            commonName                = <span class="number">10.240</span>.<span class="number">4.159</span></span>
<span class="line">            emailAddress              = liuyajun@ydgw.cn</span>
<span class="line">        X509v3 extensions:</span>
<span class="line">            X509v3 Subject Alternative Name: </span>
<span class="line">                IP Address:<span class="number">10.240</span>.<span class="number">4.159</span></span>
<span class="line">Certificate is to be certified <span class="keyword">until</span> Jan <span class="number">31</span> <span class="number">06</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2019</span> GMT (<span class="number">365</span> days)</span>
<span class="line">Sign the certificate? [<span class="regexp">y/n]:y</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span>
<span class="line">Write out database with 1 new entries</span>
<span class="line">Data Base Updated</span>
<span class="line">#------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">ll</span>
<span class="line">#------------------------------------------------------------</span>
<span class="line">total 48</span>
<span class="line">drwxr-xr-x 3 root root 4096 Jan 30 22:20 ./</span></span>
<span class="line">drwx------ <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">30</span> <span class="number">22</span>:09 ../</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">6873</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">39</span> <span class="number">01</span>.pem</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">6873</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">39</span> <span class="number">10.240</span>.<span class="number">4.159</span>.crt</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1740</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">38</span> <span class="number">10.240</span>.<span class="number">4.159</span>.csr</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3272</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">38</span> <span class="number">10.240</span>.<span class="number">4.159</span>.key</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">37</span> ca.crt</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3272</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">37</span> ca.key</span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">2</span> root root <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">39</span> demoCA/</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">33</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">39</span> extfile.cnf</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 证书加入本机信任</span></span>
<span class="line">cp <span class="number">10.240</span>.<span class="number">4.159</span>.crt /usr/<span class="keyword">local</span>/share/ca-certificates/</span>
<span class="line">update-ca-certificates</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启docker使证书生效</span></span>
<span class="line">systemctl daemon-reload</span>
<span class="line">systemctl restart docker</span>
</pre></td></tr></table></figure>
<blockquote>
<p>上述安装使用的IP地址曾用域名配置，但启动harbor后，docker login总会报类似以下错误信息，调了两天也没有找到解决办法，最后只好放弃<br>docker login reg.ydgw.cn<br>Username: admin<br>Password:<br>Error response from daemon: Get <a href="https://reg.ydgw.cn/v2/" target="_blank" rel="external">https://reg.ydgw.cn/v2/</a>: x509: certificate is not valid for any names, but wanted to match reg.ydgw.cn</p>
</blockquote>
<h3 id="配置安装启动harbor"><a href="#配置安装启动harbor" class="headerlink" title="配置安装启动harbor"></a>配置安装启动harbor</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入harbor的触压后的目录</span></span>
<span class="line">cd harbor</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">ll</span>
<span class="line">total <span class="number">934372</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">3</span> root root      <span class="number">4096</span> Jan <span class="number">30</span> <span class="number">22</span>:<span class="number">40</span> ./</span>
<span class="line">drwx------ <span class="number">6</span> root root      <span class="number">4096</span> Jan <span class="number">30</span> <span class="number">22</span>:<span class="number">40</span> ../</span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">3</span> root root      <span class="number">4096</span> Jan <span class="number">30</span> <span class="number">22</span>:<span class="number">40</span> common/</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root      <span class="number">1119</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> docker-compose.clair.yml</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root      <span class="number">1702</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> docker-compose.notary.yml</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root      <span class="number">3303</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> docker-compose.yml</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root      <span class="number">4304</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> harbor_1_1_0_template</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root      <span class="number">5008</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> harbor.cfg</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">955424047</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">39</span> harbor.v1.<span class="number">3.0</span>.tar.gz</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> root root      <span class="number">5332</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> install.sh*</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">1284054</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> LICENSE</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root       <span class="number">481</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> NOTICE</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> root root     <span class="number">18882</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> prepare*</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> root root      <span class="number">4550</span> Jan  <span class="number">4</span> <span class="number">05</span>:<span class="number">33</span> upgrade*</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">vi harbor.cfg</span>
<span class="line"><span class="comment"># 更改以下几项内容</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">hostname = reg.ydgw.cn</span>
<span class="line">ui_url_protocol = https</span>
<span class="line"></span>
<span class="line">ssl_cert = <span class="regexp">/root/data</span><span class="regexp">/10.240.4.159.crt</span>
<span class="line">ssl_cert_key = /root</span><span class="regexp">/data/</span><span class="number">10.240</span>.<span class="number">4.159</span>.key</span>
<span class="line"></span>
<span class="line">db_password = xxxxxxx    <span class="comment"># MYSQL数据库密码，可以改复杂些的</span></span>
<span class="line">harbor_admin_password = xxxxxxxx  <span class="comment"># harbor admin用户密码，后在WEB界面也能改</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 生成配置文件</span></span>
<span class="line">./prepare</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动harbor(第一次启动，需要pull一些镜像)</span></span>
<span class="line">docker-compose up -d</span>
</pre></td></tr></table></figure>
<h3 id="持久性的数据和日志文件"><a href="#持久性的数据和日志文件" class="headerlink" title="持久性的数据和日志文件"></a>持久性的数据和日志文件</h3><p>默认情况下，注册表数据将保留在主机的<code>/data</code>目录中。即使拆除和或重建Harbor的集装箱，这些数据也保持不变。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ll /data</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">total <span class="number">36</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">8</span> root  root  <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> ./</span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">25</span> root  root  <span class="number">4096</span> Jan <span class="number">30</span> <span class="number">21</span>:<span class="number">02</span> ../</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">2</span> <span class="number">10000</span> <span class="number">10000</span> <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> ca_download/</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">2</span> <span class="number">10000</span> <span class="number">10000</span> <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> config/</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">5</span> <span class="number">10000</span> <span class="number">10000</span> <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> database/</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">2</span> <span class="number">10000</span> <span class="number">10000</span> <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> job_logs/</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">2</span> <span class="number">10000</span> <span class="number">10000</span> <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> psc/</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">2</span> <span class="number">10000</span> <span class="number">10000</span> <span class="number">4096</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> registry/</span>
<span class="line">-rw-------  <span class="number">1</span> <span class="number">10000</span> <span class="number">10000</span>   <span class="number">16</span> Jan <span class="number">31</span> <span class="number">01</span>:<span class="number">42</span> secretkey</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h2 id="Harbor的使用"><a href="#Harbor的使用" class="headerlink" title="Harbor的使用"></a>Harbor的使用</h2><h3 id="web登陆"><a href="#web登陆" class="headerlink" title="web登陆"></a>web登陆</h3><p>使用浏览器打开：<a href="https://10.240.4.159" target="_blank" rel="external">https://10.240.4.159</a><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0131_harbor_01.png" alt=""><br>输入用户名和密码登陆<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0131_harbor_02.png" alt=""></p>
<h3 id="客户端docker-login"><a href="#客户端docker-login" class="headerlink" title="客户端docker login"></a>客户端docker login</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 客户端不安装证书直接登陆会报以下错误</span></span>
<span class="line">docker login <span class="number">10.240</span>.<span class="number">4.159</span></span>
<span class="line">Username: admin</span>
<span class="line">Password: </span>
<span class="line">Error response from daemon: Get https:<span class="regexp">//</span><span class="number">10.240</span>.<span class="number">4.159</span>/v2/: x509: certificate signed by unknown authority</span>
<span class="line"></span>
<span class="line"><span class="comment"># 将证书拷贝到如10.240.4.160客户机上并信任</span></span>
<span class="line">scp <span class="number">10.240</span>.<span class="number">4.159</span>.crt <span class="number">10.240</span>.<span class="number">4.160</span>:<span class="regexp">/usr/local</span><span class="regexp">/share/ca</span>-certificates/</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在10.240.4.160客户机上执行</span></span>
<span class="line">update-ca-certificates</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启docker使证书生效</span></span>
<span class="line">systemctl daemon-reload</span>
<span class="line">systemctl restart docker</span>
<span class="line"></span>
<span class="line"><span class="comment"># 之后就可以正常登陆了</span></span>
<span class="line">docker login <span class="number">10.240</span>.<span class="number">4.159</span></span>
<span class="line">Username: admin</span>
<span class="line">Password: </span>
<span class="line">Login Succeeded</span>
</pre></td></tr></table></figure>
<h3 id="上传镜像到harbor"><a href="#上传镜像到harbor" class="headerlink" title="上传镜像到harbor"></a>上传镜像到harbor</h3><p>在harbor中新建一个os的项目，访问级别设置为公开<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0131_harbor_03.png" alt=""></p>
<p>点击os项目，推送镜像可以看到命令提示<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0131_harbor_04.png" alt=""></p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先下载官方的centos镜像</span></span>
<span class="line">docker pull centos:<span class="number">7.4</span>.<span class="number">1708</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改TAG标签</span></span>
<span class="line">docker tag centos:<span class="number">7.4</span>.<span class="number">1708</span> <span class="number">10.240</span>.<span class="number">4.159</span>/os/centos:<span class="number">7.4</span>.<span class="number">1708</span></span>
<span class="line"></span>
<span class="line">docker images | <span class="keyword">grep</span> centos</span>
<span class="line"><span class="number">10.240</span>.<span class="number">4.159</span>/os/centos           <span class="number">7.4</span>.<span class="number">1708</span>            <span class="number">3</span>afd47092a0e        <span class="number">2</span> months ago        <span class="number">197</span>MB</span>
<span class="line">centos                           <span class="number">7.4</span>.<span class="number">1708</span>            <span class="number">3</span>afd47092a0e        <span class="number">2</span> months ago        <span class="number">197</span>MB</span>
<span class="line"></span>
<span class="line"><span class="comment"># 推送镜像(需要login)</span></span>
<span class="line">docker <span class="keyword">push</span> <span class="number">10.240</span>.<span class="number">4.159</span>/os/centos:<span class="number">7.4</span>.<span class="number">1708</span></span>
</pre></td></tr></table></figure>
<p>重新刷新后，harbor中已经能看到推送的镜像了<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0131_harbor_05.png" alt=""></p>
<h2 id="Harbor的生命周期"><a href="#Harbor的生命周期" class="headerlink" title="Harbor的生命周期"></a>Harbor的生命周期</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd harbor</span>
<span class="line"></span>
<span class="line"><span class="comment"># 停止和启动</span></span>
<span class="line">docker-compose stop</span>
<span class="line">docker-compose start</span>
<span class="line"></span>
<span class="line"><span class="comment"># 要更改Harbor的配置，请首先停止现有的Harbor实例并进行更新harbor.cfg。然后运行prepare脚本来填充配置。最后重新创建并启动Harbor的实例：</span></span>
<span class="line">docker-compose down -v   <span class="comment"># 删除Harbor 的容器，同时保留图像数据和Harbor的数据库文件在文件系统上</span></span>
<span class="line">vi harbor.cfg</span>
<span class="line">./prepare</span>
<span class="line">docker-compose up -d</span>
</pre></td></tr></table></figure>
<h2 id="Harbor故障排除"><a href="#Harbor故障排除" class="headerlink" title="Harbor故障排除"></a>Harbor故障排除</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">docker-compose ps</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line">       Name                     Command               State                                Ports                              </span>
<span class="line">------------------------------------------------------------------------------------------------------------------------------</span>
<span class="line">harbor-adminserver   /harbor/start.sh                 Up                                                                      </span>
<span class="line">harbor-db            /usr/<span class="keyword">local</span>/bin/docker-entr ...   Up      <span class="number">3306</span>/tcp                                                        </span>
<span class="line">harbor-jobservice    /harbor/start.sh                 Up                                                                      </span>
<span class="line">harbor-<span class="keyword">log</span>           /bin/sh -c /usr/<span class="keyword">local</span>/bin/ ...   Up      <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">1514</span>-&gt;<span class="number">10514</span>/tcp                                       </span>
<span class="line">harbor-ui            /harbor/start.sh                 Up                                                                      </span>
<span class="line">nginx                nginx -g daemon off;             Up      <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">443</span>-&gt;<span class="number">443</span>/tcp, <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">4443</span>-&gt;<span class="number">4443</span>/tcp, <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span>
<span class="line">registry             /entrypoint.sh serve /etc/ ...   Up      <span class="number">5000</span>/tcp </span>
<span class="line"><span class="comment">#----------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="comment"># 如果容器未处于UP状态，请检查目录中该容器的日志文件/var/log/harbor。例如，如果容器harbor-ui没有运行，则应该查看日志文件ui.log</span></span>
<span class="line"></span>
<span class="line">netstat -tnulp</span>
<span class="line">Active Internet connections (only servers)</span>
<span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span>
<span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">45512</span>           <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:*               LISTEN      <span class="number">27569</span>/rpc.statd </span>
<span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">1514</span>          <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:*               LISTEN      <span class="number">14876</span>/docker-proxy</span>
<span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">111</span>             <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:*               LISTEN      <span class="number">12897</span>/rpcbind   </span>
<span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">22</span>              <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:*               LISTEN      <span class="number">13362</span>/sshd      </span>
<span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">111</span>                  :::*                    LISTEN      <span class="number">12897</span>/rpcbind   </span>
<span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">80</span>                   :::*                    LISTEN      <span class="number">15838</span>/docker-proxy   <span class="comment"># 80</span></span>
<span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">44851</span>                :::*                    LISTEN      <span class="number">27569</span>/rpc.statd </span>
<span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">22</span>                   :::*                    LISTEN      <span class="number">13362</span>/sshd      </span>
<span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">443</span>                  :::*                    LISTEN      <span class="number">15824</span>/docker-proxy</span>
<span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">4443</span>                 :::*                    LISTEN      <span class="number">15812</span>/docker-proxy</span>
<span class="line">udp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">777</span>             <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:*                           <span class="number">12897</span>/rpcbind   </span>
<span class="line">udp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">60715</span>           <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:*                           <span class="number">27569</span>/rpc.statd </span>
<span class="line">udp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">111</span>             <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:*                           <span class="number">12897</span>/rpcbind   </span>
<span class="line">udp        <span class="number">0</span>      <span class="number">0</span> <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">609</span>           <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:*                           <span class="number">27569</span>/rpc.statd </span>
<span class="line">udp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">777</span>                  :::*                                <span class="number">12897</span>/rpcbind   </span>
<span class="line">udp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">111</span>                  :::*                                <span class="number">12897</span>/rpcbind   </span>
<span class="line">udp6       <span class="number">0</span>      <span class="number">0</span> :::<span class="number">41485</span>                :::*                                <span class="number">27569</span>/rpc.statd</span>
</pre></td></tr></table></figure>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><ul>
<li>官方文档：<a href="https://github.com/vmware/harbor/tree/master/docs" target="_blank" rel="external">https://github.com/vmware/harbor/tree/master/docs</a></li>
<li><a href="http://blog.csdn.net/csdn_duomaomao/article/details/78036331" target="_blank" rel="external">Harbor 私有仓库简单部署</a></li>
<li><a href="https://zhidao.baidu.com/question/685917198094733452.html" target="_blank" rel="external">harbor 怎么配https</a></li>
<li><a href="https://www.2cto.com/net/201611/565471.html" target="_blank" rel="external">ubuntu14.04/16.04https形式安装docker私有库harbor</a></li>
<li><a href="https://www.ilanni.com/?p=13492" target="_blank" rel="external">烂泥：企业docker仓库harbor搭建与配置(2017.11.10更新)</a></li>
<li><a href="https://www.cnblogs.com/biglittleant/p/7283738.html" target="_blank" rel="external">VMware Harbor 学习</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
            <tag> harbor </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_06 使用rancher搭建gitlab服务并启用https]]></title>
      <url>/2018/01/22/docker/06_%E4%BD%BF%E7%94%A8rancher%E6%90%AD%E5%BB%BAgitlab%E6%9C%8D%E5%8A%A1%E5%B9%B6%E5%90%AF%E7%94%A8https/</url>
      <content type="html"><![CDATA[<h2 id="添加一个服务"><a href="#添加一个服务" class="headerlink" title="添加一个服务"></a>添加一个服务</h2><p>添加应用(使用rancher默认的编排工具Cattle，docker-ce升级到最新版本)<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0205_rancher_01.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0205_rancher_02.png" alt=""><br><a id="more"></a><br>为应用添加服务<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0205_rancher_03.png" alt=""><br>设置名称、镜像，添加端口映射：80、22、443<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0205_rancher_04.png" alt=""></p>
<p>持久化本地存储：<br>/data/gitlab/app-data:/var/opt/gitlab<br>/data/gitlab/log-data:/var/log/gitlab<br>/data/gitlab/conf-files:/etc/gitlab<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0205_rancher_05.png" alt=""></p>
<p>设置容器主机名 gitlab<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0205_rancher_06.png" alt=""></p>
<p>设置健康检查<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0207_rancher_05.png" alt=""></p>
<p>调度安装到指定的主机上，并创建<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0205_rancher_08.png" alt=""></p>
<p>创建成功<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0205_rancher_09.png" alt=""></p>
<h2 id="gitlab启用https"><a href="#gitlab启用https" class="headerlink" title="gitlab启用https"></a>gitlab启用https</h2><h3 id="配置HTTPS所需证书"><a href="#配置HTTPS所需证书" class="headerlink" title="配置HTTPS所需证书"></a>配置HTTPS所需证书</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> /root/data</span>
<span class="line">cd /root/data</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建自已的CA证书</span></span>
<span class="line">openssl req -newkey rsa:<span class="number">4096</span> -nodes -sha256 -keyout ca.key -x509 -days <span class="number">3650</span> -out ca.crt</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">Country Name (<span class="number">2</span> letter code) [AU]:CN</span>
<span class="line">State <span class="keyword">or</span> Province Name (full name) [Some-State]:Harbin</span>
<span class="line">Locality Name (eg, city) []:Harbin</span>
<span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:ydgw</span>
<span class="line">Organizational Unit Name (eg, section) []:ydgw</span>
<span class="line">Common Name (e.g. server FQDN <span class="keyword">or</span> YOUR name) []:<span class="number">10.240</span>.<span class="number">4.160</span></span>
<span class="line">Email Address []:liuyajun@ydgw.cn</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 生成一个证书签名请求</span></span>
<span class="line">openssl req -newkey rsa:<span class="number">4096</span> -nodes -sha256 -keyout <span class="number">10.240</span>.<span class="number">4.160</span>.key -out <span class="number">10.240</span>.<span class="number">4.160</span>.csr</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">Country Name (<span class="number">2</span> letter code) [AU]:CN</span>
<span class="line">State <span class="keyword">or</span> Province Name (full name) [Some-State]:Harbin</span>
<span class="line">Locality Name (eg, city) []:Harbin</span>
<span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:ydgw</span>
<span class="line">Organizational Unit Name (eg, section) []:ydgw</span>
<span class="line">Common Name (e.g. server FQDN <span class="keyword">or</span> YOUR name) []:<span class="number">10.240</span>.<span class="number">4.160</span></span>
<span class="line">Email Address []:liuyajun@ydgw.cn</span>
<span class="line"></span>
<span class="line">Please enter the following <span class="string">'extra'</span> attributes</span>
<span class="line">to be sent with your certificate request</span>
<span class="line">A challenge password []:   <span class="comment">#密码留空即可</span></span>
<span class="line">An optional company name []:</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建文件夹和辅助内容</span></span>
<span class="line"><span class="keyword">mkdir</span> demoCA</span>
<span class="line">cd demoCA</span>
<span class="line">touch index.txt</span>
<span class="line">echo <span class="string">'01'</span> &gt; serial</span>
<span class="line">cd ..</span>
<span class="line"></span>
<span class="line">ll</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">total <span class="number">28</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">3</span> root root <span class="number">4096</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">03</span> ./</span>
<span class="line">drwx------ <span class="number">6</span> root root <span class="number">4096</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">00</span> ../</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1740</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">02</span> <span class="number">10.240</span>.<span class="number">4.160</span>.csr</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3272</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">02</span> <span class="number">10.240</span>.<span class="number">4.160</span>.key</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">01</span> ca.crt</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3276</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">01</span> ca.key</span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">2</span> root root <span class="number">4096</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">03</span> demoCA/</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 签名证书</span></span>
<span class="line">echo subjectAltName = IP:<span class="number">10.240</span>.<span class="number">4.160</span> &gt; extfile.cnf</span>
<span class="line">openssl ca -in <span class="number">10.240</span>.<span class="number">4.160</span>.csr -out <span class="number">10.240</span>.<span class="number">4.160</span>.crt -cert ca.crt -keyfile ca.key -extfile extfile.cnf -days <span class="number">3650</span> -outdir .</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">Using configuration from /usr/lib/ssl/openssl.cnf</span>
<span class="line">Check that the request matches the signature</span>
<span class="line">Signature ok</span>
<span class="line">Certificate Details:</span>
<span class="line">        Serial Number: <span class="number">1</span> (<span class="number">0x1</span>)</span>
<span class="line">        Validity</span>
<span class="line">            Not Before: Feb  <span class="number">5</span> 09:<span class="number">03</span>:<span class="number">38</span> <span class="number">2018</span> GMT</span>
<span class="line">            Not After : Feb  <span class="number">5</span> 09:<span class="number">03</span>:<span class="number">38</span> <span class="number">2019</span> GMT</span>
<span class="line">        Subject:</span>
<span class="line">            countryName               = CN</span>
<span class="line">            stateOrProvinceName       = Harbin</span>
<span class="line">            organizationName          = ydgw</span>
<span class="line">            organizationalUnitName    = ydgw</span>
<span class="line">            commonName                = <span class="number">10.240</span>.<span class="number">4.160</span></span>
<span class="line">            emailAddress              = liuyajun@ydgw.cn</span>
<span class="line">        X509v3 extensions:</span>
<span class="line">            X509v3 Subject Alternative Name: </span>
<span class="line">                IP Address:<span class="number">10.240</span>.<span class="number">4.160</span></span>
<span class="line">Certificate is to be certified <span class="keyword">until</span> Feb  <span class="number">5</span> 09:<span class="number">03</span>:<span class="number">38</span> <span class="number">2019</span> GMT (<span class="number">365</span> days)</span>
<span class="line">Sign the certificate? [<span class="regexp">y/n]:y</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">1 out of 1 certificate requests certified, commit? [y/n]y</span>
<span class="line">Write out database with 1 new entries</span>
<span class="line">Data Base Updated</span>
<span class="line">#------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">ll</span>
<span class="line">#------------------------------------------------------------</span>
<span class="line">total 48</span>
<span class="line">drwxr-xr-x 3 root root 4096 Jan 30 22:20 ./</span></span>
<span class="line">drwx------ <span class="number">5</span> root root <span class="number">4096</span> Jan <span class="number">30</span> <span class="number">22</span>:09 ../</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">6873</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">03</span> <span class="number">01</span>.pem</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">6873</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">03</span> <span class="number">10.240</span>.<span class="number">4.160</span>.crt</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1740</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">02</span> <span class="number">10.240</span>.<span class="number">4.160</span>.csr</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3272</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">02</span> <span class="number">10.240</span>.<span class="number">4.160</span>.key</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">2098</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">01</span> ca.crt</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">3276</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">01</span> ca.key</span>
<span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">2</span> root root <span class="number">4096</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">03</span> demoCA/</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root   <span class="number">33</span> Feb  <span class="number">5</span> <span class="number">17</span>:<span class="number">03</span> extfile.cnf</span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 证书加入本机信任</span></span>
<span class="line">cp <span class="number">10.240</span>.<span class="number">4.160</span>.crt /usr/<span class="keyword">local</span>/share/ca-certificates/</span>
<span class="line">update-ca-certificates</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启docker使证书生效</span></span>
<span class="line">systemctl daemon-reload</span>
<span class="line">systemctl restart docker</span>
<span class="line"></span>
<span class="line"><span class="comment"># 将证书放到指定的路径</span></span>
<span class="line"><span class="keyword">mkdir</span> /data/gitlab/conf-files/ssl</span>
<span class="line"><span class="keyword">chmod</span> <span class="number">700</span> /data/gitlab/conf-files/ssl</span>
<span class="line">cp /root/data/<span class="number">10.240</span>.<span class="number">4.160</span>.crt /data/gitlab/conf-files/ssl/</span>
<span class="line">cp /root/data/<span class="number">10.240</span>.<span class="number">4.160</span>.key /data/gitlab/conf-files/ssl/</span>
</pre></td></tr></table></figure>
<h2 id="升级服务"><a href="#升级服务" class="headerlink" title="升级服务"></a>升级服务</h2><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0207_rancher_01.png" alt=""><br>添加环境变量GITLAB_OMNIBUS_CONFIG<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0207_rancher_02.png" alt=""><br>也可以直接修改配置文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /data/gitlab/conf-files/gitlab.rb</span>
<span class="line"><span class="comment"># 添加以下内容在文件的最后</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
<span class="line">external_url <span class="string">"https://10.240.4.160"</span></span>
<span class="line">nginx[<span class="string">'enable'</span>] = true</span>
<span class="line">nginx[<span class="string">'redirect_http_to_https'</span>] = true</span>
<span class="line">nginx[<span class="string">'ssl_certificate'</span>] = <span class="string">"/etc/gitlab/ssh/10.240.4.160.crt"</span></span>
<span class="line">nginx[<span class="string">'ssl_certificate_key'</span>] = <span class="string">"/etc/gitlab/ssh/10.240.4.160.key"</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h2 id="登陆gitlab"><a href="#登陆gitlab" class="headerlink" title="登陆gitlab"></a>登陆gitlab</h2><p><a href="https://10.240.4.160" target="_blank" rel="external">https://10.240.4.160</a><br>第一次登陆需要设置root密码<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0207_rancher_03.png" alt=""><br>登陆后界面<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0207_rancher_04.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
            <tag> rancher </tag>
            
            <tag> gitlab </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_05 Rancher的访问控制]]></title>
      <url>/2018/01/20/docker/05_rancher%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/</url>
      <content type="html"><![CDATA[<h2 id="设置rancher访问控制"><a href="#设置rancher访问控制" class="headerlink" title="设置rancher访问控制"></a>设置rancher访问控制</h2><h3 id="启用本地验证"><a href="#启用本地验证" class="headerlink" title="启用本地验证"></a>启用本地验证</h3><p>安装完rancher之后，正式使用前一定要配置管理员权限<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_01.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_02.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_03.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_05.png" alt=""></p>
<p>设置后，以后登陆Rancher server就需要输入用户名和密码了<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_04.png" alt=""></p>
<h3 id="创建普通帐户"><a href="#创建普通帐户" class="headerlink" title="创建普通帐户"></a>创建普通帐户</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_06.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_07.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_08.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0118_rancher_09.png" alt=""></p>
<h3 id="设置环境访问控制"><a href="#设置环境访问控制" class="headerlink" title="设置环境访问控制"></a>设置环境访问控制</h3><p><img src="http://p2c0rtsgc.bkt.clouddn.com/0207_rancher_06.png" alt=""><br>角色说明<a href="http://rancher.com/docs/rancher/v1.6/zh/environments/#成员角色" target="_blank" rel="external">官方文档</a>中有详细说明<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0207_rancher_07.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
            <tag> rancher </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_04 Rancher的部署安装(编排选用K8S)]]></title>
      <url>/2018/01/12/docker/04_rancher%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<h2 id="为什么要使用Rancher"><a href="#为什么要使用Rancher" class="headerlink" title="为什么要使用Rancher"></a>为什么要使用Rancher</h2><p>Rancher是一个开源的企业级容器管理平台。通过Rancher，企业再也不必自己使用一系列的开源软件去从头搭建容器服务平台。Rancher提供了在生产环境中使用的管理Docker和Kubernetes的全栈化容器部署与管理平台。</p>
<p><img src="http://p2c0rtsgc.bkt.clouddn.com/0111_rancher_01.png" alt=""></p>
<p>Rancher的官方文档：<a href="https://rancher.com/docs/rancher/latest/en/" target="_blank" rel="external">https://rancher.com/docs/rancher/latest/en/</a></p>
<p>下图展示了Rancher的主要组件和功能：<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0111_rancher_02.png" alt=""></p>
<a id="more"></a>
<h2 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h2><p>版本选择参照官方文档：<a href="https://rancher.com/docs/rancher/v1.6/en/hosts/#supported-docker-versions" target="_blank" rel="external">supported version of Docker</a></p>
<p><img src="http://p2c0rtsgc.bkt.clouddn.com/0116_rancher_01.png" alt=""></p>
<p><strong>根据上图，本文选用以下符合要求的最新版本</strong></p>
<table>
<thead>
<tr>
<th>软件</th>
<th>版本</th>
<th>github项目地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>rancher</td>
<td>1.6.14</td>
<td><a href="https://github.com/rancher/rancher" target="_blank" rel="external">https://github.com/rancher/rancher</a></td>
</tr>
<tr>
<td>docker</td>
<td>17.03.2-ce</td>
<td><a href="https://github.com/docker/docker-ce" target="_blank" rel="external">https://github.com/docker/docker-ce</a></td>
</tr>
<tr>
<td>kubernetes</td>
<td>1.8.5</td>
<td><a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="external">https://github.com/kubernetes/kubernetes</a></td>
</tr>
</tbody>
</table>
<h2 id="系统准备"><a href="#系统准备" class="headerlink" title="系统准备"></a>系统准备</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>IP地址</th>
<th>用途说明</th>
<th>操作系统</th>
</tr>
</thead>
<tbody>
<tr>
<td>rancher1</td>
<td>10.245.231.119</td>
<td>server管理节点</td>
<td>Ubuntu 16.04.3 LTS</td>
</tr>
<tr>
<td>docker201</td>
<td>10.245.231.201</td>
<td>agent工作节点</td>
<td>Ubuntu 16.04.3 LTS</td>
</tr>
<tr>
<td>docker201</td>
<td>10.245.231.202</td>
<td>agent工作节点</td>
<td>Ubuntu 16.04.3 LTS</td>
</tr>
</tbody>
</table>
<h2 id="禁用IPV6"><a href="#禁用IPV6" class="headerlink" title="禁用IPV6"></a>禁用IPV6</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo vi /etc/sysctl.d/<span class="number">99</span>-sysctl.conf</span>
<span class="line"><span class="comment"># 添加以下内容</span></span>
<span class="line"><span class="comment">#------------------------------------------</span></span>
<span class="line">net.ipv6.conf.all.disable_ipv6 = <span class="number">1</span></span>
<span class="line">net.ipv6.conf.default.disable_ipv6 = <span class="number">1</span></span>
<span class="line">net.ipv6.conf.lo.disable_ipv6 = <span class="number">1</span></span>
<span class="line"><span class="comment">#------------------------------------------</span></span>
<span class="line"></span>
<span class="line">sudo sysctl -p</span>
</pre></td></tr></table></figure>
<h2 id="禁用虚拟内存swap"><a href="#禁用虚拟内存swap" class="headerlink" title="禁用虚拟内存swap"></a>禁用虚拟内存swap</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 不重启电脑，禁用启用swap，立刻生效</span></span>
<span class="line">sudo swapoff -a</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启用命令</span></span>
<span class="line">sudo swapon -a</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看交换分区的状态</span></span>
<span class="line">sudo free -<span class="keyword">m</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 永久禁用Swap，在/etc/fstab中swap分区这行前加 #</span></span>
<span class="line">sudo vi /etc/fstab</span>
<span class="line"><span class="comment">#------------------------------------------</span></span>
<span class="line"><span class="comment"># /dev/mapper/docker201--vg-swap_1 none            swap    sw              0       0</span></span>
<span class="line"><span class="comment">#------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h2 id="安装指定版本的docker"><a href="#安装指定版本的docker" class="headerlink" title="安装指定版本的docker"></a>安装指定版本的docker</h2><p>在以上三台主机上，安装指定版本的docker，参照<a href="/2018/01/11/docker/03_docker%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85-Ubuntu/#安装DOCKER-CE">docker的部署安装-Ubuntu</a>并<a href="/2018/01/11/docker/03_docker%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85-Ubuntu/#使用阿里镜像加速器">配置阿里镜像加速器</a> </p>
<p>查看docker信息能看到以下内容：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo docker info </span>
<span class="line"><span class="comment">#------------------------------------------</span></span>
<span class="line">Registry Mirrors:</span>
<span class="line"> https:<span class="regexp">//lwdxerv</span>9.mirror.aliyuncs.com</span>
<span class="line"><span class="comment">#------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启docker服务</span></span>
<span class="line">sudo systemctl daemon-reload</span>
<span class="line">sudo systemctl restart docke</span>
<span class="line"></span>
<span class="line"><span class="comment"># 检查防火墙是否启动</span></span>
<span class="line">systemctl list-unit-files | <span class="keyword">grep</span> enable | <span class="keyword">grep</span> ufw</span>
<span class="line">ufw.service                                enabled</span>
</pre></td></tr></table></figure></p>
<h2 id="安装Rancher管理端"><a href="#安装Rancher管理端" class="headerlink" title="安装Rancher管理端"></a>安装Rancher管理端</h2><p>在rancher1上操作<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo docker run -d --name rancher -v /etc/<span class="keyword">localtime</span>:<span class="regexp">/etc/localtime</span> -v /opt/rancher/mysql:<span class="regexp">/var/lib</span><span class="regexp">/mysql --restart=unless-stopped -p 8080:8080 rancher/server</span></span>
<span class="line"></span>
<span class="line">$ sudo docker ps -a</span>
<span class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                              NAMES</span>
<span class="line"><span class="number">4</span>aba45218a7a        rancher/server      <span class="string">"/usr/bin/entry /u..."</span>   <span class="number">6</span> minutes ago       Up <span class="number">5</span> minutes        <span class="number">3306</span>/tcp, <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">8080</span>-&gt;<span class="number">8080</span>/tcp   rancher</span>
<span class="line"></span>
<span class="line">$ sudo docker <span class="keyword">exec</span> -it rancher /bin/bash</span>
<span class="line"></span>
<span class="line">root@4aba45218a7a:<span class="regexp">/# ps -ef</span>
<span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span>
<span class="line">root         1     0  0 15:03 ?        00:00:00 /usr</span><span class="regexp">/bin/s</span>6-svscan /service</span>
<span class="line">root         <span class="number">7</span>     <span class="number">1</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">03</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> s6-supervise cattle</span>
<span class="line">root         <span class="number">8</span>     <span class="number">1</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">03</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> s6-supervise graphite_exporter</span>
<span class="line">root         <span class="number">9</span>     <span class="number">1</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">03</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> s6-supervise mysql</span>
<span class="line">root        <span class="number">10</span>     <span class="number">7</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">03</span> ?        <span class="number">00</span>:<span class="number">01</span>:<span class="number">41</span> java -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -Xms128m -Xmx2g -XX:+HeapDumpOnOutOfMemoryErr</span>
<span class="line">mysql      <span class="number">113</span>     <span class="number">9</span>  <span class="number">1</span> <span class="number">15</span>:<span class="number">03</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">07</span> /usr/sbin/mysqld --basedir=<span class="regexp">/usr --datadir=/var</span><span class="regexp">/lib/mysql</span> --plugin-dir=<span class="regexp">/usr/lib</span><span class="regexp">/mysql/plugin</span> --user=mysql</span>
<span class="line">root       <span class="number">249</span>    <span class="number">10</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">03</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">03</span> rancher-catalog-service --config repo.json --refresh-interval <span class="number">300</span></span>
<span class="line">root       <span class="number">284</span>    <span class="number">10</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">04</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> websocket-proxy</span>
<span class="line">root       <span class="number">298</span>    <span class="number">10</span>  <span class="number">1</span> <span class="number">15</span>:<span class="number">04</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">04</span> go-machine-service</span>
<span class="line">root       <span class="number">306</span>    <span class="number">10</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">04</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> secrets-api server --enc-key-path .</span>
<span class="line">root       <span class="number">307</span>    <span class="number">10</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">04</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> webhook-service</span>
<span class="line">root       <span class="number">325</span>    <span class="number">10</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">04</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> rancher-compose-executor</span>
<span class="line">root       <span class="number">332</span>    <span class="number">10</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">04</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> rancher-auth-service --auth-config-file authConfigFile.txt</span>
<span class="line">root       <span class="number">425</span>     <span class="number">0</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">07</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /bin/bash</span>
<span class="line">root       <span class="number">440</span>     <span class="number">0</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">07</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /bin/bash</span>
<span class="line">root       <span class="number">507</span>     <span class="number">0</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">10</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /bin/bash</span>
<span class="line">root       <span class="number">523</span>   <span class="number">507</span>  <span class="number">0</span> <span class="number">15</span>:<span class="number">10</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> ps -ef</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用以下命令可以查看rancher容器日志</span></span>
<span class="line">sudo docker logs -f rancher</span>
</pre></td></tr></table></figure></p>
<p>访问 <a href="http://10.245.231.119:8080" target="_blank" rel="external">http://10.245.231.119:8080</a><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0116_rancher_08.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0116_rancher_09.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0116_rancher_03.png" alt=""></p>
<h2 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h2><p>进入环境管理，准备添加环境模板<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_01.png" alt=""><br>点击添加环境模板<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_02.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_03.png" alt=""></p>
<p>点击编辑设置后，在弹出的页面中，更改如下几个参数：<br>Private Registry for Add-Ons and Pod infra Container Images(修改私有仓库地址)：registry.cn-shenzhen.aliyuncs.com<br>Image namespace for Add-ons and Pod infra Container Images(修改AAONS组件命名空间)：rancher_cn<br>Image namespace for kubernetes-helm (修改kubernetes-helm命名空间)：rancher_cn<br>Pod Infra Container Image (修改默认的pause镜像名):rancher_cn/pause-amd64:3.0<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_04.png" alt=""></p>
<p>参数设置完，点击页面下方的设置按钮返回环境模板编辑页面，保持环境模板其他参数不变，点击页面下方的创建按钮。<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_05.png" alt=""></p>
<p>回到环境管理，点击添加环境<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_06.png" alt=""></p>
<p>选择新创建的环境模板后点击创建<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_07.png" alt=""></p>
<p>这样就用刚刚创建的模板创建了一个K8S环境<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_08.png" alt=""></p>
<p>设置为默认环境并切换到此环境<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_09.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_10.png" alt=""></p>
<h2 id="添加主机"><a href="#添加主机" class="headerlink" title="添加主机"></a>添加主机</h2><p>因为是第一次添加主机，系统会要求你确认节点注册地址，我们直接点击保存。<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0116_rancher_05.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0116_rancher_06.png" alt=""></p>
<p>依次登陆各个宿主机，执行5里面的脚本。</p>
<p>如果需要把rancher1加为宿主机，那么需要在4里面填写管理端和宿主主机之间互通的内网IP地址，建议不要添加rancher1为宿主机，方便后续做rancher server集群高可用。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker run --rm --privileged -v /var/run/docker.sock:/var/run/docker.sock -v /var/lib/rancher:/var/lib/rancher rancher/agent:v1.2.9 http://10.245.231.119:8080/v1/scripts/48FC1D196FBDD2EC666B:1514678400000:p9K0flJKUBDcKxpnOvJNoXAadU</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在所有的机器上执行，开启所需防火墙端口</span></span>
<span class="line">sudo ufw allow 500/udp</span>
<span class="line">sudo ufw allow 4500/udp</span>
</pre></td></tr></table></figure></p>
<p>经历较长时间后，添加成功<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_11.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_12.png" alt=""></p>
<p>按此办法可添加多台宿主机</p>
<p>k8s仪表板<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_14.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_15.png" alt=""></p>
<p>k8s命令行<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_16.png" alt=""></p>
<p>k8s基础设施（点击+可查看详细内容）<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_13.png" alt=""></p>
<p>主机视图<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_17.png" alt=""></p>
<p>正常状态，非系统容器应该有14个<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0117_rancher_18.png" alt=""></p>
<blockquote>
<p>因k8s管理复杂，本文只是演示如何配置k8s，后续文章的环境将继续使用rancher默认的Cattle，并且将docker升级到最新版本</p>
</blockquote>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ul>
<li><a href="http://blog.csdn.net/csdn_duomaomao/article/details/78746034" target="_blank" rel="external">使用RancherServer:v1.6.12部署K8S-v1.8.3</a></li>
<li><a href="https://www.cnrancher.com/kubernetes-installation/" target="_blank" rel="external">原生加速中国区Kubernetes安装</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
            <tag> rancher </tag>
            
            <tag> kubernetes </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_03 Docker的部署安装(Ubuntu)]]></title>
      <url>/2018/01/11/docker/03_docker%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85-Ubuntu/</url>
      <content type="html"><![CDATA[<h2 id="为什么生产环境中Docker要部署在Ubuntu上"><a href="#为什么生产环境中Docker要部署在Ubuntu上" class="headerlink" title="为什么生产环境中Docker要部署在Ubuntu上"></a>为什么生产环境中Docker要部署在Ubuntu上</h2><p>原来为了兼容企业级应用，之前学习Docker选用了Centos7做为部署安装Docker的系统平台，但在阅读官方文档后发现，Centos7下默认的Docker存储驱动在生产环境中部署是会有一些问题。<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0111_docker_01.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0111_docker_02.png" alt=""></p>
<p>详细可参考这篇文章：<a href="http://blog.csdn.net/csdn_duomaomao/article/details/78499639" target="_blank" rel="external">http://blog.csdn.net/csdn_duomaomao/article/details/78499639</a></p>
<a id="more"></a>
<h2 id="在Ubuntu上安装Docker"><a href="#在Ubuntu上安装Docker" class="headerlink" title="在Ubuntu上安装Docker"></a>在Ubuntu上安装Docker</h2><h3 id="查看系统版本"><a href="#查看系统版本" class="headerlink" title="查看系统版本"></a>查看系统版本</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">uname -a</span>
<span class="line">Linux rancher1 <span class="number">4.4</span>.<span class="number">0</span>-<span class="number">87</span>-generic <span class="comment">#110-Ubuntu SMP Tue Jul 18 12:55:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span>
<span class="line"></span>
<span class="line">cat /proc/version</span>
<span class="line">[sudo] password <span class="keyword">for</span> ubuntu: </span>
<span class="line">Linux version <span class="number">4.4</span>.<span class="number">0</span>-<span class="number">87</span>-generic (buildd@lcy01-<span class="number">31</span>) (gcc version <span class="number">5.4</span>.<span class="number">0</span> <span class="number">20160609</span> (Ubuntu <span class="number">5.4</span>.<span class="number">0</span>-<span class="number">6</span>ubuntu1~<span class="number">16.04</span>.<span class="number">4</span>) ) <span class="comment">#110-Ubuntu SMP Tue Jul 18 12:55:35 UTC 2017</span></span>
<span class="line"></span>
<span class="line">lsb_release -a</span>
<span class="line">No LSB modules are available.</span>
<span class="line">Distributor ID: Ubuntu</span>
<span class="line">Description:    Ubuntu <span class="number">16.04</span>.<span class="number">3</span> LTS</span>
<span class="line">Release:        <span class="number">16.04</span></span>
<span class="line">Codename:       xenial</span>
</pre></td></tr></table></figure>
<h3 id="移除旧的Docker版本"><a href="#移除旧的Docker版本" class="headerlink" title="移除旧的Docker版本"></a>移除旧的Docker版本</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io</span>
</pre></td></tr></table></figure>
<h3 id="安装必要的一些系统工具"><a href="#安装必要的一些系统工具" class="headerlink" title="安装必要的一些系统工具"></a>安装必要的一些系统工具</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Update the apt package index</span></span>
<span class="line">sudo apt-get update</span>
<span class="line"></span>
<span class="line"><span class="comment"># Install packages to allow apt to use a repository over HTTPS</span></span>
<span class="line">sudo apt-get -<span class="keyword">y</span> install apt-transport-https ca-certificates curl software-properties-common</span>
</pre></td></tr></table></figure>
<h3 id="安装GPG证书并使用阿里源"><a href="#安装GPG证书并使用阿里源" class="headerlink" title="安装GPG证书并使用阿里源"></a>安装GPG证书并使用阿里源</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Add Docker’s official GPG key</span></span>
<span class="line">curl -fsSL http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span>
<span class="line"></span>
<span class="line">sudo apt-key fingerprint 0EBFCD88</span>
<span class="line"><span class="comment">#--------------------------------------------------------------</span></span>
<span class="line">pub   <span class="number">4096</span>R/0EBFCD88 <span class="number">2017</span>-<span class="number">02</span>-<span class="number">22</span></span>
<span class="line">      Key fingerprint = <span class="number">9</span>DC8 <span class="number">5822</span> <span class="number">9</span>FC7 DD38 <span class="number">854</span>A  E2D8 <span class="number">8</span>D81 <span class="number">803</span>C 0EBF CD88</span>
<span class="line">uid                  Docker Release (CE deb) &lt;docker@docker.com&gt;</span>
<span class="line"><span class="function"><span class="keyword">sub</span>   4096<span class="title">R</span>/<span class="title">F273FCD8</span> 2017-02-22</span>
<span class="line">#--------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="title">sudo</span> <span class="title">add</span>-<span class="title">apt</span>-<span class="title">repository</span> "<span class="title">deb</span> [<span class="title">arch</span>=<span class="title">amd64</span>] <span class="title">http</span>://<span class="title">mirrors</span>.<span class="title">aliyun</span>.<span class="title">com</span>/<span class="title">docker</span>-<span class="title">ce</span>/<span class="title">linux</span>/<span class="title">ubuntu</span> $(<span class="title">lsb_release</span> -<span class="title">cs</span>) <span class="title">stable</span>"</span>
<span class="line"><span class="title">sudo</span> <span class="title">apt</span>-<span class="title">get</span> <span class="title">update</span></span></span>
</pre></td></tr></table></figure>
<h3 id="安装DOCKER-CE"><a href="#安装DOCKER-CE" class="headerlink" title="安装DOCKER CE"></a>安装DOCKER CE</h3><p>为了之后配置使用rancher和kubernetes，这里安装指定版本的docker(17.03.2-ce)<br>版本的选择参考：<a href="https://rancher.com/docs/rancher/v1.6/en/hosts/#supported-docker-versions" target="_blank" rel="external">https://rancher.com/docs/rancher/v1.6/en/hosts/#supported-docker-versions</a><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查找可用Docker-CE的版本</span></span>
<span class="line">sudo apt-cache madison docker-ce</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"> docker-ce | <span class="number">17.12</span>.<span class="number">0</span>~ce-<span class="number">0</span>~ubuntu | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"> docker-ce | <span class="number">17.09</span>.<span class="number">1</span>~ce-<span class="number">0</span>~ubuntu | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"> docker-ce | <span class="number">17.09</span>.<span class="number">0</span>~ce-<span class="number">0</span>~ubuntu | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"> docker-ce | <span class="number">17.06</span>.<span class="number">2</span>~ce-<span class="number">0</span>~ubuntu | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"> docker-ce | <span class="number">17.06</span>.<span class="number">1</span>~ce-<span class="number">0</span>~ubuntu | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"> docker-ce | <span class="number">17.06</span>.<span class="number">0</span>~ce-<span class="number">0</span>~ubuntu | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"> docker-ce | <span class="number">17.03</span>.<span class="number">2</span>~ce-<span class="number">0</span>~ubuntu-xenial | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"> docker-ce | <span class="number">17.03</span>.<span class="number">1</span>~ce-<span class="number">0</span>~ubuntu-xenial | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"> docker-ce | <span class="number">17.03</span>.<span class="number">0</span>~ce-<span class="number">0</span>~ubuntu-xenial | http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 安装指定版本的Docker-CE: (VERSION 例如上面的 17.03.2~ce-0~ubuntu-xenial)</span></span>
<span class="line">sudo apt-get -<span class="keyword">y</span> install docker-ce=<span class="number">17.03</span>.<span class="number">2</span>~ce-<span class="number">0</span>~ubuntu-xenial</span>
<span class="line"></span>
<span class="line"><span class="comment"># The Docker daemon starts automatically.</span></span>
</pre></td></tr></table></figure></p>
<h3 id="查看docker版本及运行信息"><a href="#查看docker版本及运行信息" class="headerlink" title="查看docker版本及运行信息"></a>查看docker版本及运行信息</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo docker version</span>
<span class="line"><span class="comment">#-----------------------------------</span></span>
<span class="line">Client:</span>
<span class="line"> Version:      <span class="number">17.03</span>.<span class="number">2</span>-ce</span>
<span class="line"> API version:  <span class="number">1.27</span></span>
<span class="line"> Go version:   go1.<span class="number">7.5</span></span>
<span class="line"> Git commit:   f5ec1e2</span>
<span class="line"> Built:        Tue Jun <span class="number">27</span> <span class="number">03</span>:<span class="number">35</span>:<span class="number">14</span> <span class="number">2017</span></span>
<span class="line"> OS/Arch:      linux/amd64</span>
<span class="line"></span>
<span class="line">Server:</span>
<span class="line"> Version:      <span class="number">17.03</span>.<span class="number">2</span>-ce</span>
<span class="line"> API version:  <span class="number">1.27</span> (minimum version <span class="number">1.12</span>)</span>
<span class="line"> Go version:   go1.<span class="number">7.5</span></span>
<span class="line"> Git commit:   f5ec1e2</span>
<span class="line"> Built:        Tue Jun <span class="number">27</span> <span class="number">03</span>:<span class="number">35</span>:<span class="number">14</span> <span class="number">2017</span></span>
<span class="line"> OS/Arch:      linux/amd64</span>
<span class="line"> Experimental: false</span>
<span class="line"><span class="comment">#-----------------------------------</span></span>
<span class="line"></span>
<span class="line">sudo docker info</span>
<span class="line"><span class="comment">#-----------------------------------</span></span>
<span class="line">Containers: <span class="number">0</span></span>
<span class="line"> Running: <span class="number">0</span></span>
<span class="line"> Paused: <span class="number">0</span></span>
<span class="line"> Stopped: <span class="number">0</span></span>
<span class="line">Images: <span class="number">0</span></span>
<span class="line">Server Version: <span class="number">17.03</span>.<span class="number">2</span>-ce</span>
<span class="line">Storage Driver: aufs</span>
<span class="line"> Root Dir: <span class="regexp">/var/lib</span><span class="regexp">/docker/aufs</span></span>
<span class="line"> Backing Filesystem: extfs</span>
<span class="line"> Dirs: <span class="number">0</span></span>
<span class="line"> Dirperm1 Supported: true</span>
<span class="line">Logging Driver: json-file</span>
<span class="line">Cgroup Driver: cgroupfs</span>
<span class="line">Plugins: </span>
<span class="line"> Volume: <span class="keyword">local</span></span>
<span class="line"> Network: bridge host macvlan null overlay</span>
<span class="line">Swarm: inactive</span>
<span class="line">Runtimes: runc</span>
<span class="line">Default Runtime: runc</span>
<span class="line">Init Binary: docker-init</span>
<span class="line">containerd version: <span class="number">4</span>ab9917febca54791c5f071a9d1f404867857fcc</span>
<span class="line">runc version: <span class="number">54296</span>cf40ad8143b62dbcaa1d90e520a2136ddfe</span>
<span class="line">init version: <span class="number">949</span>e6fa</span>
<span class="line">Security Options:</span>
<span class="line"> apparmor</span>
<span class="line"> seccomp</span>
<span class="line">  Profile: default</span>
<span class="line">Kernel Version: <span class="number">4.4</span>.<span class="number">0</span>-<span class="number">87</span>-generic</span>
<span class="line">Operating System: Ubuntu <span class="number">16.04</span>.<span class="number">3</span> LTS</span>
<span class="line">OSType: linux</span>
<span class="line">Architecture: x86_64</span>
<span class="line">CPUs: <span class="number">4</span></span>
<span class="line">Total Memory: <span class="number">3.859</span> GiB</span>
<span class="line">Name: rancher1</span>
<span class="line">ID: <span class="number">7</span>IDE:C4U7:SPVA:AQPL:KCPV:XCWC:ESIT:JAQL:NIVJ:FTZB:<span class="number">2</span>WNH:BTZJ</span>
<span class="line">Docker Root Dir: <span class="regexp">/var/lib</span><span class="regexp">/docker</span>
<span class="line">Debug Mode (client): false</span>
<span class="line">Debug Mode (server): false</span>
<span class="line">Registry: https:/</span><span class="regexp">/index.docker.io/v</span>1/</span>
<span class="line">Experimental: false</span>
<span class="line">Insecure Registries:</span>
<span class="line"> <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">8</span></span>
<span class="line">Live Restore Enabled: false</span>
<span class="line"></span>
<span class="line">WARNING: No swap limit support</span>
<span class="line"><span class="comment">#-----------------------------------</span></span>
<span class="line"><span class="comment"># WARNING: No swap limit support 这个警告不影响正常使用</span></span>
</pre></td></tr></table></figure>
<h3 id="设置不更新指定版本的docker-ce"><a href="#设置不更新指定版本的docker-ce" class="headerlink" title="设置不更新指定版本的docker-ce"></a>设置不更新指定版本的docker-ce</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo echo <span class="string">"docker-ce hold"</span> | sudo dpkg --set-selections</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查询当前系统内所有软件包的状态，命令为：</span></span>
<span class="line">sudo dpkg --get-selections | more</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查询当前系统被锁定不更新的软件包状态(hold)，命令为</span></span>
<span class="line">sudo dpkg --get-selections | <span class="keyword">grep</span> hold</span>
<span class="line"></span>
<span class="line"><span class="comment"># 取消不更新</span></span>
<span class="line">sudo echo <span class="string">"docker-ce install"</span> | sudo dpkg --set-selections</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看</span></span>
<span class="line">sudo dpkg --get-selections | <span class="keyword">grep</span> docker</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------</span></span>
<span class="line">docker-ce                                       install</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h2 id="卸载Docker-CE"><a href="#卸载Docker-CE" class="headerlink" title="卸载Docker CE"></a>卸载Docker CE</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo apt-get purge docker-ce</span>
<span class="line">sudo rm -rf /var/lib/docker</span>
</pre></td></tr></table></figure>
<h2 id="使用阿里镜像加速器"><a href="#使用阿里镜像加速器" class="headerlink" title="使用阿里镜像加速器"></a>使用阿里镜像加速器</h2><p>使用阿里云专属加速器加快获取Docker官方镜像，否则在国内速度会慢到你无法忍受哒。步骤如下：</p>
<ol>
<li>免费注册一个阿里云账号 <a href="https://www.aliyun.com/" target="_blank" rel="external">www.aliyun.com</a></li>
<li>进入加速器页面 <a href="https://cr.console.aliyun.com/#/accelerator" target="_blank" rel="external">https://cr.console.aliyun.com/#/accelerator </a></li>
<li>选择<code>镜像加速器</code><br><img src="http://oligvdnzp.bkt.clouddn.com/1213_docker_02.png" alt=""></li>
</ol>
<p>按图中进行相关配置<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下面的xxxxx要替换成你的专属加速器的地址哦</span></span>
<span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span>
<span class="line">&#123;</span>
<span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://xxxxxxx.mirror.aliyuncs.com"</span>]</span>
<span class="line">&#125;</span>
<span class="line">EOF</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启docker</span></span>
<span class="line">sudo /etc/init.d/docker restart</span>
</pre></td></tr></table></figure></p>
<h2 id="更改ubuntu源为阿里源"><a href="#更改ubuntu源为阿里源" class="headerlink" title="更改ubuntu源为阿里源"></a>更改ubuntu源为阿里源</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo vi /etc/apt/sources.list</span>
<span class="line"></span>
<span class="line"><span class="comment"># 输入ggdG删除所有内容，添加以下内容</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------------------</span></span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial main restricted universe multiverse  </span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse  </span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse  </span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse  </span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse  </span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial main restricted universe multiverse  </span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-security main restricted universe multiverse  </span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-updates main restricted universe multiverse  </span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse  </span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-proposed main restricted universe multiverse  </span>
<span class="line">deb http:<span class="regexp">//archive</span>.canonical.com/ubuntu/ xenial partner  </span>
<span class="line"><span class="comment">#----------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 更新获取阿里云软件源 提供的软件列表</span></span>
<span class="line">sudo apt-get update</span>
<span class="line"></span>
<span class="line"><span class="comment"># 更新软件</span></span>
<span class="line">sudo apt-get -<span class="keyword">y</span> upgrade</span>
<span class="line"></span>
<span class="line"><span class="comment"># 公司局域网域名解析有问题，手动配置hosts</span></span>
<span class="line">sudo vi /etc/hosts</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------</span></span>
<span class="line"><span class="number">221.206</span>.<span class="number">129.236</span>  mirrors.aliyun.com</span>
<span class="line"><span class="number">91.189</span>.<span class="number">88.162</span>  archive.ubuntu.com</span>
<span class="line"><span class="number">91.189</span>.<span class="number">92.150</span>  archive.canonical.com</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Ubuntu Server 16.04.3安装及常用配置图解]]></title>
      <url>/2018/01/10/linux/20180110_Ubuntu16.04.3%E5%AE%89%E8%A3%85%E5%9B%BE%E8%A7%A3/</url>
      <content type="html"><![CDATA[<h2 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h2><p>下载网站：<a href="https://www.ubuntu.com/download/server" target="_blank" rel="external">https://www.ubuntu.com/download/server</a><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-01.png" alt=""></p>
<p>ubuntu-16.04.3快速下载地址：<a href="https://mirrors.aliyun.com/ubuntu-releases/16.04.3/ubuntu-16.04.3-server-amd64.iso" target="_blank" rel="external">https://mirrors.aliyun.com/ubuntu-releases/16.04.3/ubuntu-16.04.3-server-amd64.iso</a></p>
<a id="more"></a>
<p>安装图解：<br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-02.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-03.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-04.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-05.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-06.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-07.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-08.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-09.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-10.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-11.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-12.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-13.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-14.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-15.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-16.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-17.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-18.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-19.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-20.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-21.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-22.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-33.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-24.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-25.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-26.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-27.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-28.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-29.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-30.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-31.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-32.png" alt=""><br><img src="http://p2c0rtsgc.bkt.clouddn.com/0110-ubuntu-install-33.png" alt=""></p>
<blockquote>
<p>坑：虚拟机安装ubuntu server 16.04中文版时出现“无法安装busybox-initramfs”，参考<a href="http://blog.csdn.net/u010780613/article/details/52457258" target="_blank" rel="external">http://blog.csdn.net/u010780613/article/details/52457258</a></p>
</blockquote>
<h2 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h2><h3 id="禁用IPV6"><a href="#禁用IPV6" class="headerlink" title="禁用IPV6"></a>禁用IPV6</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo vi /etc/modprobe.d/blacklist.conf</span>
<span class="line"><span class="comment"># 在文件尾添加</span></span>
<span class="line">blacklist ipv6</span>
</pre></td></tr></table></figure>
<h3 id="配置网络"><a href="#配置网络" class="headerlink" title="配置网络"></a>配置网络</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看IP设置</span></span>
<span class="line">ifconfig</span>
<span class="line"></span>
<span class="line"><span class="comment"># 命令方式配置ip地址</span></span>
<span class="line">sudo ifconfig ens16<span class="number">0</span> <span class="number">10.245</span>.<span class="number">231.201</span> netmask <span class="number">255.255</span>.<span class="number">255.0</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 命令方式配置网关</span></span>
<span class="line">sudo route add default gw <span class="number">10.245</span>.<span class="number">231.254</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置文件方式</span></span>
<span class="line">sudo vi /etc/network/interfaces</span>
<span class="line"><span class="comment">#-------------------------------------------------------------------------</span></span>
<span class="line"><span class="comment"># The primary network interface</span></span>
<span class="line">auto ens16<span class="number">0</span></span>
<span class="line">iface ens16<span class="number">0</span> inet static</span>
<span class="line">        address <span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">        netmask <span class="number">255.255</span>.<span class="number">255.0</span></span>
<span class="line">        network <span class="number">10.245</span>.<span class="number">231.0</span></span>
<span class="line">        broadcast <span class="number">10.245</span>.<span class="number">231.255</span></span>
<span class="line">        gateway <span class="number">10.245</span>.<span class="number">231.254</span></span>
<span class="line">        <span class="comment"># dns-* options are implemented by the resolvconf package, if installed</span></span>
<span class="line">        dns-nameservers <span class="number">114.114</span>.<span class="number">114.114</span></span>
<span class="line"><span class="comment">#-------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启生效</span></span>
<span class="line">sudo /etc/init.d/networking restart</span>
</pre></td></tr></table></figure>
<h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo /bin/hostname newname</span>
</pre></td></tr></table></figure>
<h3 id="修改阿里源"><a href="#修改阿里源" class="headerlink" title="修改阿里源"></a>修改阿里源</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份原配置文件</span></span>
<span class="line">sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak</span>
<span class="line"></span>
<span class="line"><span class="comment"># 更改配置文件</span></span>
<span class="line">sudo vi /etc/apt/sources.list</span>
<span class="line"><span class="comment"># 以下内容添到文件最前面</span></span>
<span class="line"><span class="comment">#-------------------------------------------------------------------------</span></span>
<span class="line"><span class="comment"># deb cdrom:[Ubuntu 16.04 LTS _Xenial Xerus_ - Release amd64 (20160420.1)]/ xenial main restricted</span></span>
<span class="line">deb-src http:<span class="regexp">//archive</span>.ubuntu.com/ubuntu xenial main restricted <span class="comment">#Added by software-properties</span></span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial main restricted</span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial main restricted multiverse universe <span class="comment">#Added by software-properties</span></span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-updates main restricted</span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-updates main restricted multiverse universe <span class="comment">#Added by software-properties</span></span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial universe</span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-updates universe</span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial multiverse</span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-updates multiverse</span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse</span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse <span class="comment">#Added by software-properties</span></span>
<span class="line">deb http:<span class="regexp">//archive</span>.canonical.com/ubuntu xenial partner</span>
<span class="line">deb-src http:<span class="regexp">//archive</span>.canonical.com/ubuntu xenial partner</span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-security main restricted</span>
<span class="line">deb-src http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-security main restricted multiverse universe <span class="comment">#Added by software-properties</span></span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-security universe</span>
<span class="line">deb http:<span class="regexp">//mirrors</span>.aliyun.com/ubuntu/ xenial-security multiverse</span>
<span class="line"><span class="comment">#-------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 执行更新</span></span>
<span class="line">sudo apt-get update</span>
</pre></td></tr></table></figure>
<h3 id="安装常用工具"><a href="#安装常用工具" class="headerlink" title="安装常用工具"></a>安装常用工具</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo apt-get install openssh-server</span>
</pre></td></tr></table></figure>
<h3 id="更改时区"><a href="#更改时区" class="headerlink" title="更改时区"></a>更改时区</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudo tzselect</span>
<span class="line">sudo cp /usr/share/zoneinfo/Asia/Shanghai /etc/<span class="keyword">localtime</span></span>
<span class="line"><span class="comment"># 参考：http://blog.csdn.net/yeyuangen/article/details/52103445</span></span>
</pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Ubuntu </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_02 Docker的部署安装(CentOS)]]></title>
      <url>/2017/12/12/docker/02_docker%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85-Centos/</url>
      <content type="html"><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="操作系统需求"><a href="#操作系统需求" class="headerlink" title="操作系统需求"></a>操作系统需求</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_15.png" alt=""><br><a id="more"></a></p>
<p><strong>为兼容企业级应用，学习选用Centos7做为部署安装Docker的系统平台</strong><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 通过以下命令可查看系统版本和内核版本等信息</span></span>
<span class="line">cat /etc/redhat-release</span>
<span class="line"><span class="comment">#-----------------------------------</span></span>
<span class="line">CentOS Linux release <span class="number">7.4</span>.<span class="number">1708</span> (Core) </span>
<span class="line"><span class="comment">#-----------------------------------</span></span>
<span class="line"></span>
<span class="line">uname -a</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line">Linux docker01 <span class="number">3.10</span>.<span class="number">0</span>-<span class="number">693</span>.el7.x86_64 <span class="comment">#1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">cat /etc/os-release</span>
<span class="line"><span class="comment">#------------------------------------------</span></span>
<span class="line">NAME=<span class="string">"CentOS Linux"</span></span>
<span class="line">VERSION=<span class="string">"7 (Core)"</span></span>
<span class="line">ID=<span class="string">"centos"</span></span>
<span class="line">ID_LIKE=<span class="string">"rhel fedora"</span></span>
<span class="line">VERSION_ID=<span class="string">"7"</span></span>
<span class="line">PRETTY_NAME=<span class="string">"CentOS Linux 7 (Core)"</span></span>
<span class="line">ANSI_COLOR=<span class="string">"0;31"</span></span>
<span class="line">CPE_NAME=<span class="string">"cpe:/o:centos:centos:7"</span></span>
<span class="line">HOME_URL=<span class="string">"https://www.centos.org/"</span></span>
<span class="line">BUG_REPORT_URL=<span class="string">"https://bugs.centos.org/"</span></span>
<span class="line"></span>
<span class="line">CENTOS_MANTISBT_PROJECT=<span class="string">"CentOS-7"</span></span>
<span class="line">CENTOS_MANTISBT_PROJECT_VERSION=<span class="string">"7"</span></span>
<span class="line">REDHAT_SUPPORT_PRODUCT=<span class="string">"centos"</span></span>
<span class="line">REDHAT_SUPPORT_PRODUCT_VERSION=<span class="string">"7"</span></span>
<span class="line"><span class="comment">#------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h3 id="更换默认的yum源"><a href="#更换默认的yum源" class="headerlink" title="更换默认的yum源"></a>更换默认的yum源</h3><p>Centos默认的yun源在国外，速度很慢有时间也无法访问<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">yum repolist</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line">Loaded plugins: fastestmirror</span>
<span class="line">Could <span class="keyword">not</span> retrieve mirrorlist http:<span class="regexp">//mirrorlist</span>.centos.org/?release=<span class="number">7</span>&amp;arch=x86_64&amp;repo=os&amp;infra=stock error was</span>
<span class="line"><span class="number">14</span>: curl<span class="comment">#6 - "Could not resolve host: mirrorlist.centos.org; Unknown error"</span></span>
<span class="line">Could <span class="keyword">not</span> retrieve mirrorlist http:<span class="regexp">//mirrorlist</span>.centos.org/?release=<span class="number">7</span>&amp;arch=x86_64&amp;repo=extras&amp;infra=stock error was</span>
<span class="line"><span class="number">14</span>: curl<span class="comment">#6 - "Could not resolve host: mirrorlist.centos.org; Unknown error"</span></span>
<span class="line">Could <span class="keyword">not</span> retrieve mirrorlist http:<span class="regexp">//mirrorlist</span>.centos.org/?release=<span class="number">7</span>&amp;arch=x86_64&amp;repo=updates&amp;infra=stock error was</span>
<span class="line"><span class="number">14</span>: curl<span class="comment">#6 - "Could not resolve host: mirrorlist.centos.org; Unknown error"</span></span>
<span class="line">repo id                                                         repo name                                                          status</span>
<span class="line">base/<span class="number">7</span>/x86_64                                                   CentOS-<span class="number">7</span> - Base                                                    <span class="number">0</span></span>
<span class="line">extras/<span class="number">7</span>/x86_64                                                 CentOS-<span class="number">7</span> - Extras                                                  <span class="number">0</span></span>
<span class="line">updates/<span class="number">7</span>/x86_64                                                CentOS-<span class="number">7</span> - Updates                                                 <span class="number">0</span></span>
<span class="line">repolist: <span class="number">0</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 公司内服务器域名解析总有问题，时好时不好，很烦，这里直接用hosts做解析</span></span>
<span class="line">vi /etc/hosts</span>
<span class="line"><span class="comment">#-------------------------------------</span></span>
<span class="line"><span class="number">221.206</span>.<span class="number">129.236</span>  mirrors.aliyun.com</span>
<span class="line"><span class="comment">#-------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 更换成aliyun yum源</span></span>
<span class="line">cp /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</span>
<span class="line">curl -o /etc/yum.repos.d/CentOS-Base.repo http:<span class="regexp">//mirrors</span>.aliyun.com/repo/Centos-<span class="number">7</span>.repo</span>
<span class="line"></span>
<span class="line"><span class="comment"># 编译CentOS-Base.repo，把带mirrors.aliyuncs.com的行都删除</span></span>
<span class="line">vi /etc/yum.repos.d/CentOS-Base.repo</span>
<span class="line"></span>
<span class="line"><span class="comment"># 运行以下命令生成缓存</span></span>
<span class="line">yum clean all</span>
<span class="line">yum makecache</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看已启用的repo，确保centos-extras repository是启用了，安装docker时需要</span></span>
<span class="line">yum repolist</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line">Loaded plugins: fastestmirror</span>
<span class="line">Loading mirror speeds from cached hostfile</span>
<span class="line"> * base: mirrors.aliyun.com</span>
<span class="line"> * extras: mirrors.aliyun.com</span>
<span class="line"> * updates: mirrors.aliyun.com</span>
<span class="line">repo id                                  repo name                                                        status</span>
<span class="line">base/<span class="number">7</span>/x86_64                            CentOS-<span class="number">7</span> - Base - mirrors.aliyun.com                             <span class="number">9</span>,<span class="number">591</span></span>
<span class="line">extras/<span class="number">7</span>/x86_64                          CentOS-<span class="number">7</span> - Extras - mirrors.aliyun.com                             <span class="number">284</span></span>
<span class="line">updates/<span class="number">7</span>/x86_64                         CentOS-<span class="number">7</span> - Updates - mirrors.aliyun.com                          <span class="number">1</span>,<span class="number">540</span></span>
<span class="line">repolist: <span class="number">11</span>,<span class="number">415</span></span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h3 id="更新系统-可选"><a href="#更新系统-可选" class="headerlink" title="更新系统(可选)"></a>更新系统(可选)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">yum update</span>
</pre></td></tr></table></figure>
<h3 id="删除docker旧版本"><a href="#删除docker旧版本" class="headerlink" title="删除docker旧版本"></a>删除docker旧版本</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 有旧版本的docker话，可以用下面命令删除</span></span>
<span class="line">yum remove docker docker-common docker-selinux docker-engine</span>
</pre></td></tr></table></figure>
<h2 id="安装-Docker-CE"><a href="#安装-Docker-CE" class="headerlink" title="安装 Docker CE"></a>安装 Docker CE</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">yum install -<span class="keyword">y</span> yum-utils device-mapper-persistent-data lvm2</span>
<span class="line"><span class="comment"># yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span></span>
<span class="line">yum-config-manager --add-repo http:<span class="regexp">//mirrors</span>.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span>
<span class="line">yum install -<span class="keyword">y</span> docker-ce</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line">.......</span>
<span class="line">Installed:</span>
<span class="line">  docker-ce.x86_64 <span class="number">0</span>:<span class="number">17.09</span>.<span class="number">1</span>.ce-<span class="number">1</span>.el7.centos                                                                                                                                    </span>
<span class="line"></span>
<span class="line">Dependency Installed:</span>
<span class="line">  audit-libs-python.x86_64 <span class="number">0</span>:<span class="number">2.7</span>.<span class="number">6</span>-<span class="number">3</span>.el7</span>
<span class="line">  checkpolicy.x86_64 <span class="number">0</span>:<span class="number">2.5</span>-<span class="number">4</span>.el7</span>
<span class="line">  container-selinux.noarch <span class="number">2</span>:<span class="number">2.28</span>-<span class="number">1</span>.git85ce147.el7</span>
<span class="line">  libcgroup.x86_64 <span class="number">0</span>:<span class="number">0</span>.<span class="number">41</span>-<span class="number">13</span>.el7</span>
<span class="line">  libseccomp.x86_64 <span class="number">0</span>:<span class="number">2.3</span>.<span class="number">1</span>-<span class="number">3</span>.el7</span>
<span class="line">  libsemanage-python.x86_64 <span class="number">0</span>:<span class="number">2.5</span>-<span class="number">8</span>.el7</span>
<span class="line">  policycoreutils-python.x86_64 <span class="number">0</span>:<span class="number">2.5</span>-<span class="number">17.1</span>.el7</span>
<span class="line">  python-IPy.noarch <span class="number">0</span>:<span class="number">0</span>.<span class="number">75</span>-<span class="number">6</span>.el7    </span>
<span class="line">  setools-libs.x86_64 <span class="number">0</span>:<span class="number">3.3</span>.<span class="number">8</span>-<span class="number">1.1</span>.el7       </span>
<span class="line">......</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<p>若需要安装指定的版本时，可参照以下命令<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 根据需要选择是否开启edge和test repositories</span></span>
<span class="line">yum-config-manager --enable docker-ce-edge</span>
<span class="line">yum-config-manager --enable docker-ce-test</span>
<span class="line"><span class="comment">## 禁用命令</span></span>
<span class="line">yum-config-manager --disable docker-ce-edge</span>
<span class="line"></span>
<span class="line"><span class="comment">## 安装指定的版本</span></span>
<span class="line">yum list docker-ce --showduplicates | <span class="keyword">sort</span> -r</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line">Loading mirror speeds from cached hostfile</span>
<span class="line">Loaded plugins: fastestmirror</span>
<span class="line">Installed Packages</span>
<span class="line">docker-ce.x86_64            <span class="number">17.09</span>.<span class="number">1</span>.ce-<span class="number">1</span>.el7.centos            docker-ce-stable </span>
<span class="line">docker-ce.x86_64            <span class="number">17.09</span>.<span class="number">1</span>.ce-<span class="number">1</span>.el7.centos            @docker-ce-stable</span>
<span class="line">docker-ce.x86_64            <span class="number">17.09</span>.<span class="number">0</span>.ce-<span class="number">1</span>.el7.centos            docker-ce-stable </span>
<span class="line">docker-ce.x86_64            <span class="number">17.06</span>.<span class="number">2</span>.ce-<span class="number">1</span>.el7.centos            docker-ce-stable </span>
<span class="line">docker-ce.x86_64            <span class="number">17.06</span>.<span class="number">1</span>.ce-<span class="number">1</span>.el7.centos            docker-ce-stable </span>
<span class="line">docker-ce.x86_64            <span class="number">17.06</span>.<span class="number">0</span>.ce-<span class="number">1</span>.el7.centos            docker-ce-stable </span>
<span class="line">docker-ce.x86_64            <span class="number">17.03</span>.<span class="number">2</span>.ce-<span class="number">1</span>.el7.centos            docker-ce-stable </span>
<span class="line">docker-ce.x86_64            <span class="number">17.03</span>.<span class="number">1</span>.ce-<span class="number">1</span>.el7.centos            docker-ce-stable </span>
<span class="line">docker-ce.x86_64            <span class="number">17.03</span>.<span class="number">0</span>.ce-<span class="number">1</span>.el7.centos            docker-ce-stable </span>
<span class="line">Available Packages</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">yum install docker-ce-<span class="number">17.06</span>.<span class="number">1</span>.ce</span>
</pre></td></tr></table></figure></p>
<h2 id="启动docker"><a href="#启动docker" class="headerlink" title="启动docker"></a>启动docker</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">systemctl start docker</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看docker的版本信息</span></span>
<span class="line">docker version</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line">Client:</span>
<span class="line"> Version:      <span class="number">17.09</span>.<span class="number">1</span>-ce       <span class="comment"># 客户端版本</span></span>
<span class="line"> API version:  <span class="number">1.32</span></span>
<span class="line"> Go version:   go1.<span class="number">8.3</span></span>
<span class="line"> Git commit:   <span class="number">19</span>e2cf6</span>
<span class="line"> Built:        Thu Dec  <span class="number">7</span> <span class="number">22</span>:<span class="number">23</span>:<span class="number">40</span> <span class="number">2017</span></span>
<span class="line"> OS/Arch:      linux/amd64</span>
<span class="line"></span>
<span class="line">Server:</span>
<span class="line"> Version:      <span class="number">17.09</span>.<span class="number">1</span>-ce       <span class="comment"># 服务端版本</span></span>
<span class="line"> API version:  <span class="number">1.32</span> (minimum version <span class="number">1.12</span>)</span>
<span class="line"> Go version:   go1.<span class="number">8.3</span></span>
<span class="line"> Git commit:   <span class="number">19</span>e2cf6</span>
<span class="line"> Built:        Thu Dec  <span class="number">7</span> <span class="number">22</span>:<span class="number">25</span>:<span class="number">03</span> <span class="number">2017</span></span>
<span class="line"> OS/Arch:      linux/amd64</span>
<span class="line"> Experimental: false</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看网络信息</span></span>
<span class="line">ip addr</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span>
<span class="line">    <span class="keyword">link</span>/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span>
<span class="line">    inet <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/<span class="number">8</span> scope host lo</span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host </span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line"><span class="number">2</span>: ens16<span class="number">0</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> UP qlen <span class="number">1000</span></span>
<span class="line">    <span class="keyword">link</span>/ether <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:ab:<span class="number">4</span>c:<span class="number">50</span> brd ff:ff:ff:ff:ff:ff</span>
<span class="line">    inet <span class="number">10.240</span>.<span class="number">4.185</span>/<span class="number">24</span> brd <span class="number">10.240</span>.<span class="number">4.255</span> scope global ens16<span class="number">0</span></span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">    inet6 fe8<span class="number">0</span>::<span class="number">250</span>:<span class="number">56</span>ff:feab:<span class="number">4</span>c5<span class="number">0</span>/<span class="number">64</span> scope <span class="keyword">link</span> </span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line"><span class="number">3</span>: docker<span class="number">0</span>: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="number">1500</span> qdisc noqueue <span class="keyword">state</span> DOWN  <span class="comment"># docker0 虚拟网桥</span></span>
<span class="line">    <span class="keyword">link</span>/ether <span class="number">02</span>:<span class="number">42</span>:<span class="number">72</span>:ac:<span class="number">05</span>:bf brd ff:ff:ff:ff:ff:ff</span>
<span class="line">    inet <span class="number">172.17</span>.<span class="number">0</span>.<span class="number">1</span>/<span class="number">16</span> scope global docker<span class="number">0</span></span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">    inet6 fe8<span class="number">0</span>::<span class="number">42</span>:<span class="number">72</span>ff:feac:<span class="number">5</span>bf/<span class="number">64</span> scope <span class="keyword">link</span> </span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">systemctl list-unit-files | <span class="keyword">grep</span> docker</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line">docker.service                                disabled</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置成自启服务</span></span>
<span class="line">systemctl enable docker.service</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看状态</span></span>
<span class="line">systemctl status docker</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line">● docker.service - Docker Application Container Engine</span>
<span class="line">   Loaded: loaded (<span class="regexp">/usr/lib</span><span class="regexp">/systemd/system</span><span class="regexp">/docker.service; enabled; vendor preset: disabled)</span>
<span class="line">   Active: active (running) since Tue 2017-12-12 17:24:31 CST; 13min ago</span>
<span class="line">     Docs: https:/</span><span class="regexp">/docs.docker.com</span>
<span class="line"> Main PID: 23479 (dockerd)</span>
<span class="line">   CGroup: /system</span>.slice/docker.service</span>
<span class="line">           ├─<span class="number">23479</span> /usr/bin/dockerd</span>
<span class="line">           └─<span class="number">23490</span> docker-containerd -l unix:<span class="regexp">//</span><span class="regexp">/var/run</span><span class="regexp">/docker/libcontainerd</span><span class="regexp">/docker-containerd.sock --metrics-interval=0 --start-timeout 2m --state-dir /var</span><span class="regexp">/run/docker</span><span class="regexp">/libco...</span>
<span class="line"></span>
<span class="line">Dec 12 17:24:29 docker01 dockerd[23479]: time="2017-12-12T17:24:29.594209004+08:00" level=info msg="libcontainerd: new containerd process, pid: 23490"</span>
<span class="line">Dec 12 17:24:30 docker01 dockerd[23479]: time="2017-12-12T17:24:30.596093094+08:00" level=warning msg="failed to rename /var</span><span class="regexp">/lib/docker</span><span class="regexp">/tmp for background deletio...chronously"</span>
<span class="line">Dec 12 17:24:30 docker01 dockerd[23479]: time="2017-12-12T17:24:30.654014669+08:00" level=info msg="Graph migration to content-addressability took 0.00 seconds"</span>
<span class="line">Dec 12 17:24:30 docker01 dockerd[23479]: time="2017-12-12T17:24:30.654714697+08:00" level=info msg="Loading containers: start."</span>
<span class="line">Dec 12 17:24:30 docker01 dockerd[23479]: time="2017-12-12T17:24:30.852920366+08:00" level=info msg="Default bridge (docker0) is assigned with an IP address 172.17...IP address"</span>
<span class="line">Dec 12 17:24:30 docker01 dockerd[23479]: time="2017-12-12T17:24:30.996504508+08:00" level=info msg="Loading containers: done."</span>
<span class="line">Dec 12 17:24:31 docker01 dockerd[23479]: time="2017-12-12T17:24:31.004149257+08:00" level=info msg="Docker daemon" commit=19e2cf6 graphdriver(s)=overlay version=17.09.1-ce</span>
<span class="line">Dec 12 17:24:31 docker01 dockerd[23479]: time="2017-12-12T17:24:31.004282017+08:00" level=info msg="Daemon has completed initialization"</span>
<span class="line">Dec 12 17:24:31 docker01 dockerd[23479]: time="2017-12-12T17:24:31.015479108+08:00" level=info msg="API listen on /var</span><span class="regexp">/run/docker</span>.sock<span class="string">"</span>
<span class="line">Dec 12 17:24:31 docker01 systemd[1]: Started Docker Application Container Engine.</span>
<span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span>
<span class="line">#--------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<p>运行hello-world image验证docker安装是否成功<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">docker run hello-world</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
<span class="line">Unable to find image <span class="string">'hello-world:latest'</span> locally</span>
<span class="line">latest: Pulling from library/hello-world</span>
<span class="line">ca4f61b1923c: Pull complete </span>
<span class="line">Digest: sha256:be0cd392e45be79ffeffa6b05338b98ebb16c87b255f48e297ec7f98e123905c</span>
<span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span>
<span class="line"></span>
<span class="line">Hello from Docker!</span>
<span class="line">This message shows that your installation appears to be working correctly.</span>
<span class="line"></span>
<span class="line">To generate this message, Docker took the following steps:</span>
<span class="line"> <span class="number">1</span>. The Docker client contacted the Docker daemon.</span>
<span class="line"> <span class="number">2</span>. The Docker daemon pulled the <span class="string">"hello-world"</span> image from the Docker Hub.</span>
<span class="line">    (amd64)</span>
<span class="line"> <span class="number">3</span>. The Docker daemon created a new container from that image which runs the</span>
<span class="line">    executable that produces the output you are currently reading.</span>
<span class="line"> <span class="number">4</span>. The Docker daemon streamed that output to the Docker client, which sent it</span>
<span class="line">    to your terminal.</span>
<span class="line"></span>
<span class="line">To try something more ambitious, you can run an Ubuntu container with:</span>
<span class="line"> $ docker run -it ubuntu bash</span>
<span class="line"></span>
<span class="line">Share images, automate workflows, <span class="keyword">and</span> more with a free Docker ID:</span>
<span class="line"> https:<span class="regexp">//cloud</span>.docker.com/</span>
<span class="line"></span>
<span class="line">For more examples <span class="keyword">and</span> ideas, visit:</span>
<span class="line"> https:<span class="regexp">//docs</span>.docker.com/engine/userguide/</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h2 id="升级和卸载docker"><a href="#升级和卸载docker" class="headerlink" title="升级和卸载docker"></a>升级和卸载docker</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 升级</span></span>
<span class="line">yum -<span class="keyword">y</span> upgrade docker-ce</span>
<span class="line"></span>
<span class="line"><span class="comment"># 卸载</span></span>
<span class="line">yum remove docker-ce</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除Images, containers, volumes, or customized configuration files </span></span>
<span class="line">rm -rf /var/lib/docker</span>
</pre></td></tr></table></figure>
<h2 id="使用阿里镜像加速器"><a href="#使用阿里镜像加速器" class="headerlink" title="使用阿里镜像加速器"></a>使用阿里镜像加速器</h2><p>使用阿里云专属加速器加快获取Docker官方镜像，否则在国内速度会慢到你无法忍受哒。步骤如下：</p>
<ol>
<li>免费注册一个阿里云账号 <a href="https://www.aliyun.com/" target="_blank" rel="external">www.aliyun.com</a></li>
<li>进入加速器页面 <a href="https://cr.console.aliyun.com/#/accelerator" target="_blank" rel="external">https://cr.console.aliyun.com/#/accelerator </a></li>
<li>选择<code>镜像加速器</code><br><img src="http://oligvdnzp.bkt.clouddn.com/1213_docker_02.png" alt=""></li>
</ol>
<p>按图中进行相关配置<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下面的xxxxx要替换成你的专属加速器的地址哦</span></span>
<span class="line">tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span>
<span class="line">&#123;</span>
<span class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://xxxxxxx.mirror.aliyuncs.com"</span>]</span>
<span class="line">&#125;</span>
<span class="line">EOF</span>
<span class="line"></span>
<span class="line">systemctl daemon-reload</span>
<span class="line">systemctl restart docker</span>
</pre></td></tr></table></figure></p>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><ul>
<li><a href="https://docs.docker.com/engine/installation/linux/docker-ce/centos/" target="_blank" rel="external">官方文档：Get Docker CE for CentOS</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Docker学习笔记_01 Docker的相关概念]]></title>
      <url>/2017/12/11/docker/01_docker%E7%9A%84%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5/</url>
      <content type="html"><![CDATA[<p>Docker就是虚拟化的一种轻量级替代技术。Docker的容器技术不依赖任何语言、框架或系统，可以将App变成一种标准化的、可移植的、自管理的组件，并脱离服务器硬件在任何主流系统中开发、调试和运行。</p>
<h2 id="Docker的核心技术"><a href="#Docker的核心技术" class="headerlink" title="Docker的核心技术"></a>Docker的核心技术</h2><h3 id="Docker相关的核心技术之cgroups"><a href="#Docker相关的核心技术之cgroups" class="headerlink" title="Docker相关的核心技术之cgroups"></a>Docker相关的核心技术之cgroups</h3><p>Linux系统中经常有个需求就是希望能限制某个或者某些进程的分配资源。于是就出现了<code>cgroups</code>的概念，<code>cgroup</code>就是<code>controller group</code> ，在这个group中，有分配好的特定比例的cpu时间，IO时间，可用内存大小等。 <code>cgroups</code>是将任意进程进行分组化管理的Linux内核功能。最初由google的工程师提出，后来被整合进Linux内核中。</p>
<p>cgroups中的 重要概念是“子系统”，也就是资源控制器，每种子系统就是一个资源的分配器，比如cpu子系统是控制cpu时间分配的。首先挂载子系统，然后才有control group的。比如先挂载memory子系统，然后在memory子系统中创建一个cgroup节点，在这个节点中，将需要控制的进程id写入，并且将控制的属性写入，这就完成了内存的资源限制。</p>
<p>cgroups 被Linux内核支持，有得天独厚的性能优势，发展势头迅猛。在很多领域可以取代虚拟化技术分割资源。cgroup默认有诸多资源组，可以限制几乎所有服务器上的资源：cpu mem iops,iobandwide,net,device acess等<br><a id="more"></a></p>
<h3 id="Docker相关的核心技术之LXC"><a href="#Docker相关的核心技术之LXC" class="headerlink" title="Docker相关的核心技术之LXC"></a>Docker相关的核心技术之LXC</h3><p>LXC是Linux containers的简称，是一种基于容器的操作系统层级的虚拟化技术。借助于namespace的隔离机制和cgroup限额功能，LXC提供了一套统一的API和工具来建立和管理container。LXC跟其他操作系统层次的虚拟化技术相比，最大的优势在于LXC被整合进内核，不用单独为内核打补丁。</p>
<p>LXC 旨在提供一个共享kernel的 OS 级虚拟化方法，在执行时不用重复加载Kernel, 且container的kernel与host共享，因此可以大大加快container的 启动过程，并显著减少内存消耗，容器在提供隔离的同时，还通过共享这些资源节省开销，这意味着容器比真正的虚拟化的开销要小得多。 在实际测试中，基于LXC的虚拟化方法的IO和CPU性能几乎接近 baremetal 的性能。 </p>
<p>虽然容器所使用的这种类型的隔离总的来说非常强大，然而是不是像运行在hypervisor上的虚拟机那么强壮仍具有争议性。如果内核停止，那么所有的容器就会停止运行。</p>
<ul>
<li>性能方面：LXC&gt;&gt;KVM&gt;&gt;XEN</li>
<li>内存利用率：LXC&gt;&gt;KVM&gt;&gt;XEN</li>
<li>隔离程度： XEN&gt;&gt;KVM&gt;&gt;LXC</li>
</ul>
<h3 id="Docker相关的核心技术之AUFS"><a href="#Docker相关的核心技术之AUFS" class="headerlink" title="Docker相关的核心技术之AUFS"></a>Docker相关的核心技术之AUFS</h3><p>什么是AUFS? AuFS是一个能透明覆盖一或多个现有文件系统的层状文件系统。 支持将不同目录挂载到同一个虚拟文件系统下，可以把不同的目录联合在一起，组成一个单一的目录。这种是一种虚拟的文件系统，文件系统不用格式化，直接挂载即可。</p>
<p>Docker一直在用AuFS作为容器的文件系统。当一个进程需要修改一个文件时，AuFS创建该文件的一个副本。AuFS可以把多层合并成文件系统的单层表示。这个过程称为写入复制<code>copy on write</code>。</p>
<p>AuFS允许Docker把某些镜像作为容器的基础。例如，你可能有一个可以作为很多不同容器的基础的CentOS系统镜像。多亏AuFS，只要一个CentOS镜像的副本就够了，这样既节省了存储和内存，也保证更快速的容器部署。</p>
<p>使用AuFS的另一个好处是Docker的版本容器镜像能力。每个新版本都是一个与之前版本的简单差异改动，有效地保持镜像文件最小化。但，这也意味着你总是要有一个记录该容器从一个版本到另一个版本改动的审计跟踪。</p>
<h2 id="Docker的核心组件"><a href="#Docker的核心组件" class="headerlink" title="Docker的核心组件"></a>Docker的核心组件</h2><h3 id="Docker-Image"><a href="#Docker-Image" class="headerlink" title="Docker Image"></a>Docker Image</h3><ul>
<li>Docker Image是一个极度精简版的Linux程序运行环境，比如vi这种基本的工具没有，官网的Java镜像包括的东西更少，除非是镜像叠加方式的，如Centos+Java7</li>
<li>Docker Image是需要定制化Build的一个“安装包”，包括基础镜像+应用的二进制部署包</li>
<li>Docker Image内不建议有运行期需要修改的配置文件</li>
<li>Dockerfile用来创建一个自定义的image,包含了用户指定的软件依赖等。当前目录下包含Dockerfile,使用命令build来创建新的image</li>
<li>Docker Image的最佳实践之一是尽量重用和使用网上公开的基础镜像</li>
</ul>
<h3 id="Docker-Container"><a href="#Docker-Container" class="headerlink" title="Docker Container"></a>Docker Container</h3><ul>
<li>Docker Container是Image的实例，共享内核</li>
<li>Docker Container里可以运行不同Os的Image，比如Ubuntu的或者Centos</li>
<li>Docker Container不建议内部开启一个SSHD服务，1.3版本后新增了docker exec命令进入容器排查问题。</li>
<li>Docker Container没有IP地址，通常不会有服务端口暴露，是一个封闭的“盒子/沙箱”</li>
</ul>
<p><strong>Docker Container的生命周期</strong><br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_03.png" alt=""></p>
<h3 id="Docker-Daemon"><a href="#Docker-Daemon" class="headerlink" title="Docker Daemon"></a>Docker Daemon</h3><ul>
<li>Docker Daemon是创建和运行Container的Linux守护进程，也是Docker最主要的核心组件</li>
<li>Docker Daemon 可以理解为Docker Container的Container</li>
<li>Docker Daemon可以绑定本地端口并提供Rest API服务，用来远程访问和控制</li>
</ul>
<h3 id="Docker-Registry-Hub"><a href="#Docker-Registry-Hub" class="headerlink" title="Docker Registry/Hub"></a>Docker Registry/Hub</h3><p>Docker之所以这么吸引人，除了它的新颖的技术外，围绕官方Registry（Docker Hub）的生态圈也是相当吸引人眼球的地方。在Docker Hub上你可以很轻松下载到大量已经容器化好的应用镜像，即拉即用。这些镜像中，有些是Docker官方维护的，更多的是众多开发者自发上传分享的。而且你还可以在Docker Hub中绑定你的代码托管系统（目前支持Github和Bitbucket）配置自动生成镜像功能，这样Docker Hub会在你代码更新时自动生成对应的Docker镜像。<br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_04.png" alt=""></p>
<h3 id="Docker-核心组件的关系"><a href="#Docker-核心组件的关系" class="headerlink" title="Docker 核心组件的关系"></a>Docker 核心组件的关系</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_05.png" alt=""></p>
<h2 id="Docker原理之App打包"><a href="#Docker原理之App打包" class="headerlink" title="Docker原理之App打包"></a>Docker原理之App打包</h2><p>LXC的基础上, Docker额外提供的Feature包括：标准统一的打包部署运行方案</p>
<p>为了最大化重用Image，加快运行速度，减少内存和磁盘footprint, Docker container运行时所构造的运行环境，实际上是由具有依赖关系的多个Layer组成的。例如一个apache的运行环境可能是在基础的rootfs image的基础上，叠加了包含例如Emacs等各种工具的image，再叠加包含apache及其相关依赖library的image，这些image由AUFS文件系统加载合并到统一路径中，以只读的方式存在，最后再叠加加载一层可写的空白的Layer用作记录对当前运行环境所作的修改。</p>
<p>有了层级化的Image做基础，理想中，不同的APP就可以既可能的共用底层文件系统，相关依赖工具等，同一个APP的不同实例也可以实现共用绝大多数数据，进而以copy on write的形式维护自己的那一份修改过的数据等.<br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_01.png" alt=""></p>
<h2 id="Docker全生命周期开发模式"><a href="#Docker全生命周期开发模式" class="headerlink" title="Docker全生命周期开发模式"></a>Docker全生命周期开发模式</h2><p>Docker正在迅速改变云计算领域的运作规则，并彻底颠覆云技术的发展前景。从持续集成/持续交付到微服务、开源协作乃至DevOps，Docker一路走来已经给应用程序开发生命周期以及云工程技术实践带来了巨大变革。<br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_02.png" alt=""></p>
<h2 id="Docker-CE和Docker-EE"><a href="#Docker-CE和Docker-EE" class="headerlink" title="Docker CE和Docker EE"></a>Docker CE和Docker EE</h2><p>Docker从17.03之后有两个可用版本：Community Edition (CE)社区版 and Enterprise Edition (EE) 企业版。社区版全功能免费使用，企业版强调安全，增加图形化管理等增强功能。功能对比如下图：<br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_07.png" alt=""></p>
<p>两个版本支持的平台如下：<br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_08.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_09.png" alt=""></p>
<h2 id="Docker版本命名规则"><a href="#Docker版本命名规则" class="headerlink" title="Docker版本命名规则"></a>Docker版本命名规则</h2><p>从2017年3月1号开始，Docker的版本命名发生如下变化：<br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_06.png" alt=""><br>Docker 会每月发布一个 edge 版本(17.03, 17.04, 17.05…)，每三个月发布一个 stable 版本(17.03, 17.06, 17.09, …)，企业版(EE) 和 stable 版本号保持一致，但每个版本提供一年维护。<br><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_10.png" alt=""></p>
<h2 id="Containers-vs-virtual-machines"><a href="#Containers-vs-virtual-machines" class="headerlink" title="Containers vs. virtual machines"></a>Containers vs. virtual machines</h2><h4 id="Virtual-Machine-diagram"><a href="#Virtual-Machine-diagram" class="headerlink" title="Virtual Machine diagram"></a>Virtual Machine diagram</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_13.png" alt=""></p>
<h4 id="Container-diagram"><a href="#Container-diagram" class="headerlink" title="Container diagram"></a>Container diagram</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/1212_docker_14.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> Docker学习笔记 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> docker </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 12 MySQL性能优化的最佳20+条经验]]></title>
      <url>/2017/12/05/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/12-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<p>本章有部分内容与《<a href="/2017/11/09/mysql/MySQL-性能优化最佳实践课程学习/10-MySQL-性能优化最佳实践/">MySQL性能优化最佳实践 - 10 MySQL写出高效SQL</a>》互为补充。</p>
<h2 id="从程序员的角度优化"><a href="#从程序员的角度优化" class="headerlink" title="从程序员的角度优化"></a>从程序员的角度优化</h2><ul>
<li>数据库的操作越来越成为整个应的的性能瓶颈，这点对于WEB应用尤其明显。</li>
<li>关于数据库性能，这不只是DBA才需要担心的事，更是程序员需要去关注的事情。</li>
<li>当设计表结构和操作数据库（DML操作）时，需要注意数据操作的性能。</li>
</ul>
<h3 id="为查询缓存优化你的查询"><a href="#为查询缓存优化你的查询" class="headerlink" title="为查询缓存优化你的查询"></a>为查询缓存优化你的查询</h3><p>大多数的MySQL服务器都开启了查询缓存</p>
<h3 id="EXPLAIN-你的SELECT-查询"><a href="#EXPLAIN-你的SELECT-查询" class="headerlink" title="EXPLAIN 你的SELECT 查询"></a>EXPLAIN 你的SELECT 查询</h3><ul>
<li>使用EXPLAIN 关键字可以让你知道MySQL是如何处理你的SQL语句的。这可以帮你分析你的查询语句或是表结构的性能瓶颈。</li>
<li>EXPLAIN 的查询结果还会告诉你你的索引主键被如何利用的，你的数据表是如何被搜索和排序的等等。</li>
<li>挑一个你的SELECT语句（推荐挑选那个最复杂的，有多表联接的），把关键字EXPLAIN加到前面。你可以使用phpmyadmin来做这个事。然后，你会看到一张表格。下面的这个示例中，我们忘记加上了group_id索引，并且有表联接。</li>
<li>当我们为group_id字段加上索引后：我们可以看到，前一个结果显示搜索了7883 行，而后一个只是搜索了两个表的9 和16 行。查看rows列可以让我们找到潜在的性能问题。</li>
</ul>
<a id="more"></a>
<h3 id="当只要一行数据时使用LIMIT-1"><a href="#当只要一行数据时使用LIMIT-1" class="headerlink" title="当只要一行数据时使用LIMIT 1"></a>当只要一行数据时使用LIMIT 1</h3><h3 id="为搜索字段建索引"><a href="#为搜索字段建索引" class="headerlink" title="为搜索字段建索引"></a>为搜索字段建索引</h3><h3 id="在Join表的时候使用相当类型的例，并将其索引"><a href="#在Join表的时候使用相当类型的例，并将其索引" class="headerlink" title="在Join表的时候使用相当类型的例，并将其索引"></a>在Join表的时候使用相当类型的例，并将其索引</h3><h3 id="千万不要ORDER-BY-RAND"><a href="#千万不要ORDER-BY-RAND" class="headerlink" title="千万不要ORDER BY RAND()"></a>千万不要ORDER BY RAND()</h3><h3 id="避免SELECT"><a href="#避免SELECT" class="headerlink" title="避免SELECT *"></a>避免SELECT *</h3><h3 id="永远为每张表设置一个ID"><a href="#永远为每张表设置一个ID" class="headerlink" title="永远为每张表设置一个ID"></a>永远为每张表设置一个ID</h3><ul>
<li>我们应该为数据库里的每张表都设置一个ID做为其主键，而且最好的是一个INT型的（推荐使用UNSIGNED），并设置上自动增加的AUTO_INCREMENT标志。</li>
<li>就算是你users 表有一个主键叫“email”的字段，你也别让它成为主键。使用VARCHAR类型来当主键会使用得性能下降。另外，在你的程序中，你应该使用表的ID来构造你的数据结构。</li>
<li>而且，在MySQL数据引擎下，还有一些操作需要使用主键，在这些情况下，主键的性能和设置变得非常重要，比如，集群，分区……</li>
<li>在这里，只有一个情况是例外，那就是“关联表”的“外键”，也就是说，这个表的主键，通过若干个别的表的主键构成。我们把这个情况叫做“外键”。比如：有一个“学生表”有学生的ID，有一个“课程表”有课程ID，那么，“成绩表”就是“关联表”了，其关联了学生表和课程表，在成绩表中，学生ID和课程ID叫“外键”其共同组成主键。</li>
</ul>
<h3 id="使用ENUM-而不是VARCHAR"><a href="#使用ENUM-而不是VARCHAR" class="headerlink" title="使用ENUM 而不是VARCHAR"></a>使用ENUM 而不是VARCHAR</h3><ul>
<li>ENUM 类型是非常快和紧凑的。在实际上，其保存的是TINYINT，但其外表上显示为字符串。这样一来，用这个字段来做一些选项列表变得相当的完美。</li>
<li>如果你有一个字段，比如“性别”，“国家”，“民族”，“状态”或“部门”，你知道这些字段的取值是有限而且固定的，那么，你应该使用ENUM 而不是VARCHAR。</li>
<li>MySQL也有一个“建议”（见第十条）告诉你怎么去重新组织你的表结构。当你有一个VARCHAR 字段时，这个建议会告诉你把其改成ENUM类型。使用PROCEDURE ANALYSE() 你可以得到相关的建议。</li>
</ul>
<h3 id="从PROCEDURE-ANALYSE-取得建议"><a href="#从PROCEDURE-ANALYSE-取得建议" class="headerlink" title="从PROCEDURE ANALYSE() 取得建议"></a>从PROCEDURE ANALYSE() 取得建议</h3><ul>
<li>PROCEDURE ANALYSE()会让MySQL帮你去分析你的字段和其实际的数据，并会给你一些有用的建议。只有表中有实际的数据，这些建议才会变得有用，因为要做一些大的决定是需要有数据作为基础的。</li>
<li>例如，如果你创建了一个INT 字段作为你的主键，然而并没有太多的数据，那么，PROCEDURE ANALYSE()会建议你把这个字段的类型改成MEDIUMINT 。或是你使用了一个VARCHAR 字段，因为数据不多，你可能会得到一个让你把它改成ENUM的建议。这些建议，都是可能因为数据不够多，所以决策做得就不够准。</li>
<li>在phpmyadmin里，你可以在查看表时，点击“Propose table structure” 来查看这些建议</li>
<li>一定要注意，这些只是建议，只有当你的表里的数据越来越多时，这些建议才会变得准确。一定要记住，你才是最终做决定的人。</li>
</ul>
<h3 id="尽可能的使用NOT-NULL"><a href="#尽可能的使用NOT-NULL" class="headerlink" title="尽可能的使用NOT NULL"></a>尽可能的使用NOT NULL</h3><h3 id="Prepared-Statements"><a href="#Prepared-Statements" class="headerlink" title="Prepared Statements"></a>Prepared Statements</h3><h3 id="无缓冲的查询"><a href="#无缓冲的查询" class="headerlink" title="无缓冲的查询"></a>无缓冲的查询</h3><h3 id="把IP地址存成UNSIGNED-INT"><a href="#把IP地址存成UNSIGNED-INT" class="headerlink" title="把IP地址存成UNSIGNED INT"></a>把IP地址存成UNSIGNED INT</h3><h3 id="固定长度的表会更快"><a href="#固定长度的表会更快" class="headerlink" title="固定长度的表会更快"></a>固定长度的表会更快</h3><ul>
<li>如果表中的所有字段都是“固定长度”的，整个表会被认为是“static” 或“fixed-length”。例如，表中没有如下类型的字段：VARCHAR，TEXT，BLOB。只要你包括了其中一个这些字段，那么这个表就不是“固定长度静态表”了，这样，MySQL引擎会用另一种方法来处理。</li>
<li>固定长度的表会提高性能，因为MySQL搜寻得会更快一些，因为这些固定的长度是很容易计算下一个数据的偏移量的，所以读取的自然也会很快。</li>
<li>而如果字段不是定长的，那么，每一次要找下一条的话，需要程序找到主键。</li>
<li>并且，固定长度的表也更容易被缓存和重建。不过，唯一的副作用是，固定长度的字段会浪费一些空间，因为定长的字段无论你用不用，他都是要分配那么多的空间。</li>
<li>使用“垂直分割”技术（见下一条），你可以分割你的表成为两个一个是定长的，一个则是不定长的。</li>
</ul>
<h3 id="垂直分割"><a href="#垂直分割" class="headerlink" title="垂直分割"></a>垂直分割</h3><ul>
<li>“垂直分割”是一种把数据库中的表按列变成几张表的方法，这样可以降低表的复杂度和字段的数目，从而达到优化的目的。（以前，在银行做过项目，见过一张表有100多个字段，很恐怖）</li>
<li>示例一：在Users表中有一个字段是家庭地址，这个字段是可选字段，相比起，而且你在数据库操作的时候除了个人信息外，你并不需要经常读取或是改写这个字段。那么，为什么不把他放到另外一张表中呢？</li>
<li>这样会让你的表有更好的性能，大家想想是不是，大量的时候，我对于用户表来说，只有用户ID，用户名，口令，用户角色等会被经常使用。小一点的表总是会有好的性能。</li>
<li>示例二：你有一个叫“last_login”的字段，它会在每次用户登录时被更新。但是，每次更新时会导致该表的查询缓存被清空。所以，你可以把这个字段放到另一个表中，这样就不会影响你对用户ID，用户名，用户角色的不停地读取了，因为查询缓存会帮你增加很多性能。</li>
<li>另外，你需要注意的是，这些被分出去的字段所形成的表，你不会经常性地去Join他们，不然的话，这样的性能会比不分割时还要差，而且，会是极数级的下降。</li>
</ul>
<h3 id="拆分大的DELETE-或INSERT-语句"><a href="#拆分大的DELETE-或INSERT-语句" class="headerlink" title="拆分大的DELETE 或INSERT 语句"></a>拆分大的DELETE 或INSERT 语句</h3><h3 id="越小的列会越快"><a href="#越小的列会越快" class="headerlink" title="越小的列会越快"></a>越小的列会越快</h3><ul>
<li>对于大多数的数据库引擎来说，硬盘操作可能是最重大的瓶颈。所以，把你的数据变得紧凑会对这种情况非常有帮助，因为这减少了对硬盘的访问。</li>
<li>参看MySQL 的文档Storage Requirements 查看所有的数据类型。</li>
<li>如果一个表只会有几列罢了（比如说字典表，配置表），那么，我们就没有理由使用INT 来做主键，使用MEDIUMINT, SMALLINT 或是更小的TINYINT 会更经济一些。如果你不需要记录时间，使用DATE 要比DATETIME 好得多。</li>
<li>当然，你也需要留够足够的扩展空间，不然，你日后来干这个事，你会死的很难看，参看Slashdot的例子（2009年11月06日），一个简单的ALTER TABLE语句花了3个多小时，因为里面有一千六百万条数据。</li>
</ul>
<h3 id="选择正确的存储引擎"><a href="#选择正确的存储引擎" class="headerlink" title="选择正确的存储引擎"></a>选择正确的存储引擎</h3><ul>
<li>在MySQL 中有两个存储引擎MyISAM和InnoDB，每个引擎都有利有弊。酷壳以前文章《MySQL: InnoDB还是MyISAM?》讨论和这个事情。</li>
<li>MyISAM适合于一些需要大量查询的应用，但其对于有大量写操作并不是很好。甚至你只是需要update一个字段，整个表都会被锁起来，而别的进程，就算是读进程都无法操作直到读操作完成。另外，MyISAM对于SELECT COUNT(*) 这类的计算是超快无比的。</li>
<li>InnoDB的趋势会是一个非常复杂的存储引擎，对于一些小的应用，它会比MyISAM还慢。他是它支持“行锁”，于是在写操作比较多的时候，会更优秀。并且，他还支持更多的高级应用，比如事务。</li>
</ul>
<h3 id="使用一个对象关系映射器（Object-Relational-Mapper）"><a href="#使用一个对象关系映射器（Object-Relational-Mapper）" class="headerlink" title="使用一个对象关系映射器（Object Relational Mapper）"></a>使用一个对象关系映射器（Object Relational Mapper）</h3><ul>
<li>使用ORM (Object Relational<br>Mapper)，你能够获得可靠的性能增涨。一个ORM可以做的所有事情，也能被手动的编写出来。但是，这需要一个高级专家。</li>
<li>ORM 的最重要的是“LazyLoading”，也就是说，只有在需要的去取值的时候才会去真正的去做。但你也需要小心这种机制的副作用，因为这很有可能会因为要去创建很多很多小的查询反而会降低性能。</li>
<li>ORM 还可以把你的SQL语句打包成一个事务，这会比单独执行他们快得多得多。</li>
</ul>
<h3 id="小心“永久链接”"><a href="#小心“永久链接”" class="headerlink" title="小心“永久链接”"></a>小心“永久链接”</h3><ul>
<li>“永久链接”的目的是用来减少重新创建MySQL链接的次数。当一个链接被创建了，它会永远处在连接的状态，就算是数据库操作已经结束了。而且，自从我们的Apache开始重用它的子进程后——也就是说，下一次的HTTP请求会重用Apache的子进程，并重用相同的MySQL 链接。</li>
<li>在理论上来说，这听起来非常的不错。但是从个人经验（也是大多数人的）上来说，这个功能制造出来的麻烦事更多。因为，你只有有限的链接数，内存问题，文件句柄数，等等。</li>
<li>而且，Apache运行在极端并行的环境中，会创建很多很多的了进程。这就是为什么这种“永久链接”的机制工作地不好的原因。在你决定要使用“永久链接”之前，你需要好好地考虑一下你的整个系统的架构。</li>
</ul>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CentOS7下MySQL5.7.20的安装-源码方式]]></title>
      <url>/2017/12/05/mysql/20171205_CentOS7%E4%B8%8BMySQL57%E7%9A%84%E5%AE%89%E8%A3%85-%E6%BA%90%E7%A0%81%E6%96%B9%E5%BC%8F/</url>
      <content type="html"><![CDATA[<h2 id="初始化环境"><a href="#初始化环境" class="headerlink" title="初始化环境"></a>初始化环境</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /etc/redhat-release </span>
<span class="line">Red Hat Enterprise Linux Server release <span class="number">7.4</span> (Maipo)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置主机名</span></span>
<span class="line">hostnamectl --static set-hostname NAME</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置IP地址</span></span>
<span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens16<span class="number">0</span></span>
<span class="line"><span class="comment">#-----------------------------------------</span></span>
<span class="line">TYPE=Ethernet</span>
<span class="line">PROXY_METHOD=none</span>
<span class="line">BROWSER_ONLY=<span class="keyword">no</span></span>
<span class="line">BOOTPROTO=static</span>
<span class="line">DEFROUTE=yes</span>
<span class="line">IPV4_FAILURE_FATAL=<span class="keyword">no</span></span>
<span class="line">IPV6INIT=<span class="keyword">no</span></span>
<span class="line">NAME=ens16<span class="number">0</span></span>
<span class="line">UUID=<span class="number">67869621</span>-df21-<span class="number">4</span>ad4-<span class="number">9369</span>-b58078ca74ea</span>
<span class="line">DEVICE=ens16<span class="number">0</span></span>
<span class="line">ONBOOT=yes</span>
<span class="line">IPADDR=<span class="number">10.240</span>.<span class="number">4.179</span></span>
<span class="line">PREFIX=<span class="number">24</span></span>
<span class="line">GATEWAY=<span class="number">10.240</span>.<span class="number">4.254</span></span>
<span class="line"><span class="comment">#-----------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 禁用firewall</span></span>
<span class="line">systemctl stop firewalld</span>
<span class="line">systemctl disable firewalld</span>
<span class="line">systemctl status firewalld</span>
<span class="line"></span>
<span class="line"><span class="comment"># 禁用SELINUX</span></span>
<span class="line">setenforce <span class="number">0</span></span>
<span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置配认yum源为光盘</span></span>
<span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line">mount /dev/cdrom /media/disk</span>
<span class="line">cd /etc/yum.repos.d/</span>
<span class="line">mv CentOS-Base.repo CentOS-Base.repo_bak</span>
<span class="line">vi CentOS-Base.repo</span>
<span class="line"><span class="comment">#-----------------------------------------</span></span>
<span class="line">[centos7]</span>
<span class="line">name=CentOS-$releasever</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span></span>
<span class="line">gpgcheck=<span class="number">0</span></span>
<span class="line">enabled=<span class="number">1</span></span>
<span class="line"><span class="comment">#-----------------------------------------</span></span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="编译安装mysql"><a href="#编译安装mysql" class="headerlink" title="编译安装mysql"></a>编译安装mysql</h2><h3 id="安装mysql源码编译依赖包及常用工具"><a href="#安装mysql源码编译依赖包及常用工具" class="headerlink" title="安装mysql源码编译依赖包及常用工具"></a>安装mysql源码编译依赖包及常用工具</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">yum -<span class="keyword">y</span> install lrzsz</span>
<span class="line">yum install cmake make gcc gcc-c++ ncurses ncurses-devel bison openssl-devel</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除原有mysql / mariadb相关包</span></span>
<span class="line">rpm -qa | <span class="keyword">grep</span> mysql</span>
<span class="line">rpm -qa | <span class="keyword">grep</span> mariadb</span>
<span class="line">mariadb-libs-<span class="number">5.5</span>.<span class="number">56</span>-<span class="number">2</span>.el7.x86_64</span>
<span class="line"></span>
<span class="line">rpm -e --nodeps mariadb-libs-<span class="number">5.5</span>.<span class="number">56</span>-<span class="number">2</span>.el7.x86_64</span>
</pre></td></tr></table></figure>
<h3 id="添加用户组、用户和创建安装目录"><a href="#添加用户组、用户和创建安装目录" class="headerlink" title="添加用户组、用户和创建安装目录"></a>添加用户组、用户和创建安装目录</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">groupadd mysql</span>
<span class="line">useradd -g mysql mysql</span>
<span class="line">echo <span class="string">"Mysql123456"</span> | passwd --stdin mysql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 当一台服务器部署多个mysql实例时，在相应的目录下创建名为[3306],[3307](端口号)等目录</span></span>
<span class="line"><span class="comment"># 这里为了标准化配置，单实例时也创建了名为[3306]的标准化目录</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /usr/<span class="keyword">local</span>/mysql</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mysql/conf/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mysql/data/<span class="number">3306</span>         </span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mysql/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mysql/<span class="keyword">log</span>/<span class="number">3306</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mysql/run/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mysql/tmp/<span class="number">3306</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">chown</span> mysql.mysql -R /usr/<span class="keyword">local</span>/mysql</span>
<span class="line"><span class="keyword">chown</span> mysql.mysql -R /u01/mysql</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">755</span> /u01/mysql</span>
<span class="line"></span>
<span class="line">echo <span class="string">"export PATH=\$PATH:/usr/local/mysql/bin"</span> &gt;&gt; <span class="regexp">/home/mysql</span><span class="regexp">/.bash_profile</span></span>
</pre></td></tr></table></figure>
<h3 id="MySQL运行环境配置"><a href="#MySQL运行环境配置" class="headerlink" title="MySQL运行环境配置"></a>MySQL运行环境配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span>
<span class="line"><span class="comment">#-----------------------------------------</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.shmall = <span class="number">4294967296</span></span>
<span class="line">kernel.shmmax = <span class="number">2199023255552</span></span>
<span class="line">kernel.msgmnb = <span class="number">65536</span></span>
<span class="line">kernel.msgmax = <span class="number">65536</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line"><span class="comment">#-----------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># kernel.shmmax算法：修改为物理内容的50%、60%</span></span>
<span class="line"><span class="comment"># 4G:kernel.shmmax = (4G*1024*1024*1024*1024)*50% = 2199023255552</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 没有设置的值可以通过以下方法查看，如</span></span>
<span class="line">cat /proc/sys/net/ipv4/ip_forward</span>
<span class="line">cat /proc/sys/net/ipv4/tcp_syncookies</span>
<span class="line">cat /proc/sys/net/ipv4/conf/default/rp_filter</span>
<span class="line">cat /proc/sys/net/ipv4/conf/default/accept_source_route</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使配置立即生效</span></span>
<span class="line">sysctl -p</span>
<span class="line"></span>
<span class="line">vi /etc/security/limits.conf</span>
<span class="line"><span class="comment">#-----------------------------------------</span></span>
<span class="line">mysql   soft   nofile    <span class="number">1024</span></span>
<span class="line">mysql   hard   nofile    <span class="number">65536</span></span>
<span class="line">mysql   soft   nproc     <span class="number">2047</span></span>
<span class="line">mysql   hard   nproc     <span class="number">16384</span></span>
<span class="line">mysql   soft   stack     <span class="number">10240</span></span>
<span class="line">mysql   hard   stack     <span class="number">32768</span></span>
<span class="line"><span class="comment">#-----------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="编译安装mysql-5-7"><a href="#编译安装mysql-5-7" class="headerlink" title="编译安装mysql 5.7"></a>编译安装mysql 5.7</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 上传boost_1_59_0.tar.gz mysql-5.7.20.tar.gz到服务器上</span></span>
<span class="line"><span class="comment"># wget https://sourceforge.net/projects/boost/files/boost/1.59.0/boost_1_59_0.tar.gz</span></span>
<span class="line"><span class="keyword">mkdir</span> /usr/<span class="keyword">local</span>/boost</span>
<span class="line">cd /tmp</span>
<span class="line">cp boost_1_59_<span class="number">0</span>.tar.gz /usr/<span class="keyword">local</span>/boost</span>
<span class="line">tar xpvf mysql-<span class="number">5.7</span>.<span class="number">20</span>.tar.gz</span>
<span class="line">cd mysql-<span class="number">5.7</span>.<span class="number">20</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 开始编译</span></span>
<span class="line">cmake \</span>
<span class="line">-DCMAKE_INSTALL_PREFIX=<span class="regexp">/usr/local</span><span class="regexp">/mysql \</span>
<span class="line">-DWITH_BOOST=/usr</span><span class="regexp">/local/boost</span> \</span>
<span class="line">-DDEFAULT_CHARSET=utf8 \</span>
<span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span>
<span class="line">-DWITH_EXTRA_CHARSETS=all \</span>
<span class="line">-DWITH_SSL=yes \</span>
<span class="line">-DWITH_EMBEDDED_SERVER=<span class="number">1</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DWITH_MYISAM_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_PARTITION_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DMYSQL_TCP_PORT=<span class="number">3306</span> \</span>
<span class="line">-DMYSQL_DATADIR=<span class="regexp">/u01/mysql</span><span class="regexp">/data/</span><span class="number">3306</span> \</span>
<span class="line">-DMYSQL_UNIX_ADDR=<span class="regexp">/u01/mysql</span><span class="regexp">/run/</span><span class="number">3306</span>/mysql.sock \</span>
<span class="line">-DSYSCONFDIR=<span class="regexp">/u01/mysql</span><span class="regexp">/conf/</span><span class="number">3306</span></span>
<span class="line"></span>
<span class="line"><span class="comment">## BLACKHOLE 黑洞引擎，写入的任何数据都会消失，用于记录binlog做复制的中继存储</span></span>
<span class="line"><span class="comment">## FEDERATED 通过这个引擎可以实现类似Oracle 下DBLINK的远程数据访问功能，</span></span>
<span class="line"><span class="comment">#            通过FEDERATED引擎创建的表只是在本地有表定义文件，数据文件则存在于远程数据库中</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 重新cmake需要删除当前目录下CMakeCache.txt，然后再重新执行</span></span>
<span class="line"></span>
<span class="line">make &amp;&amp; make install</span>
</pre></td></tr></table></figure>
<h3 id="配置my-cnf文件"><a href="#配置my-cnf文件" class="headerlink" title="配置my.cnf文件"></a>配置my.cnf文件</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line">cd /u01/mysql/conf/<span class="number">3306</span></span>
<span class="line">vi my.cnf</span>
<span class="line"></span>
<span class="line">[client]</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/mysql</span><span class="regexp">/run/</span><span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">autocommit=<span class="number">0</span></span>
<span class="line">general_log=off</span>
<span class="line">explicit_defaults_for_timestamp=true</span>
<span class="line">transaction_isolation=<span class="keyword">read</span>-committed</span>
<span class="line">lower_case_table_names=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># system</span></span>
<span class="line">basedir=<span class="regexp">/usr/local</span><span class="regexp">/mysql</span>
<span class="line">datadir=/u</span>01/mysql/data/<span class="number">3306</span></span>
<span class="line">max_allowed_packet=<span class="number">1</span>g</span>
<span class="line">max_connections=<span class="number">3000</span></span>
<span class="line">max_user_connections=<span class="number">2800</span></span>
<span class="line">open_files_limit=<span class="number">65535</span></span>
<span class="line">table_open_cache=<span class="number">2000</span></span>
<span class="line">pid_file=<span class="regexp">/u01/mysql</span><span class="regexp">/run/</span><span class="number">3306</span>/mysqld.pid</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">server_id=<span class="number">1</span></span>
<span class="line">skip_name_resolve=ON</span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/mysql</span><span class="regexp">/run/</span><span class="number">3306</span>/mysql.sock</span>
<span class="line">tmpdir=<span class="regexp">/u01/mysql</span><span class="regexp">/tmp/</span><span class="number">3306</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment">#binlog</span></span>
<span class="line">log_bin=<span class="regexp">/u01/mysql</span><span class="regexp">/log/</span><span class="number">3306</span>/binlog/binlog</span>
<span class="line">binlog_cache_size=<span class="number">32768</span></span>
<span class="line">binlog_format=row</span>
<span class="line">expire_logs_days=<span class="number">7</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">max_binlog_size=<span class="number">524288000</span></span>
<span class="line">sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#logging</span></span>
<span class="line">log_error=<span class="regexp">/u01/mysql</span><span class="regexp">/log/</span><span class="number">3306</span>/error.log</span>
<span class="line">slow_query_log_file=<span class="regexp">/u01/mysql</span><span class="regexp">/log/</span><span class="number">3306</span>/slow.log</span>
<span class="line">log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">slow_query_log=<span class="number">1</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#relay</span></span>
<span class="line">relay_log=<span class="regexp">/u01/mysql</span><span class="regexp">/log/</span><span class="number">3306</span>/relaylog</span>
<span class="line">relay_log_index=<span class="regexp">/u01/mysql</span><span class="regexp">/log/</span><span class="number">3306</span>/relay.index</span>
<span class="line">relay_log_info_file=<span class="regexp">/u01/mysql</span><span class="regexp">/log/</span><span class="number">3306</span>/relay-log.info</span>
<span class="line"></span>
<span class="line"><span class="comment">#slave</span></span>
<span class="line">slave_load_tmpdir=<span class="regexp">/u01/mysql</span><span class="regexp">/tmp/</span><span class="number">3306</span></span>
<span class="line">slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line"><span class="comment">#innodb</span></span>
<span class="line">innodb_data_home_dir=<span class="regexp">/u01/mysql</span><span class="regexp">/log/</span><span class="number">3306</span>/iblog</span>
<span class="line">innodb_log_group_home_dir=<span class="regexp">/u01/mysql</span><span class="regexp">/log/</span><span class="number">3306</span>/iblog</span>
<span class="line">innodb_adaptive_flushing=ON</span>
<span class="line">innodb_adaptive_hash_index=ON</span>
<span class="line">innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#default</span></span>
<span class="line">innodb_change_buffering=inserts</span>
<span class="line">innodb_checksums=ON</span>
<span class="line">innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">innodb_doublewrite=ON</span>
<span class="line">innodb_file_per_table=ON</span>
<span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">innodb_flush_method=O_DIRECT</span>
<span class="line">innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">innodb_open_files=<span class="number">60000</span></span>
<span class="line">innodb_purge_threads=<span class="number">1</span></span>
<span class="line">innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">innodb_stats_on_metadata=OFF</span>
<span class="line">innodb_support_xa=ON</span>
<span class="line">innodb_use_native_aio=OFF</span>
<span class="line">innodb_write_io_threads=<span class="number">10</span></span>
<span class="line"></span>
<span class="line">[mysqld_safe]</span>
<span class="line">datadir=<span class="regexp">/u01/mysql</span><span class="regexp">/data/</span><span class="number">3306</span></span>
</pre></td></tr></table></figure>
<h3 id="初始化MySQL"><a href="#初始化MySQL" class="headerlink" title="初始化MySQL"></a>初始化MySQL</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用以下命令可以看到mysql默认配置文件位置等信息</span></span>
<span class="line">mysqld --verbose --help</span>
<span class="line"></span>
<span class="line">cd /usr/<span class="keyword">local</span>/mysql/bin</span>
<span class="line"><span class="comment"># 方法一</span></span>
<span class="line">./mysqld --initialize-insecure --datadir=<span class="regexp">/u01/mysql</span><span class="regexp">/data/</span><span class="number">3306</span> --user=mysql</span>
<span class="line"><span class="comment">#初始化后，root密码为空</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># 方法二</span></span>
<span class="line">./mysqld --initialize --datadir=<span class="regexp">/u01/mysql</span><span class="regexp">/data/</span><span class="number">3306</span> --user=mysql</span>
<span class="line"><span class="comment"># 初始化后，root密码为一个临时密码，可以使用以下语句查看</span></span>
<span class="line"><span class="keyword">grep</span> <span class="string">'temporary password'</span> /u01/mysql/<span class="keyword">log</span>/<span class="number">3306</span>/error.log</span>
<span class="line"><span class="number">2017</span>-<span class="number">12</span>-<span class="number">06</span>T08:<span class="number">13</span>:<span class="number">52.132699</span>Z <span class="number">1</span> [Note] A temporary password is generated <span class="keyword">for</span> root@localhost: hZet!:+F1d=J</span>
</pre></td></tr></table></figure>
<h3 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /usr/<span class="keyword">local</span>/mysql/bin</span>
<span class="line">mysqld_safe &amp;</span>
</pre></td></tr></table></figure>
<h3 id="设置root密码"><a href="#设置root密码" class="headerlink" title="设置root密码"></a>设置root密码</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql_secure_installation</span>
</pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://blog.csdn.net/fxnawm/article/details/78497314" target="_blank" rel="external">MySQL5.7.20源码安装</a></li>
<li><a href="https://segmentfault.com/a/1190000012099346" target="_blank" rel="external">源码MySQL5.7.20 安装</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle Linux网卡参数默认设置导致ORA-603]]></title>
      <url>/2017/11/24/oracle/ORA/ORA-603/</url>
      <content type="html"><![CDATA[<p>环境：OEL6.8，ORACLE 11.2.0.4 双节点RAC<br>节点2 alert日志报错信息如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">Fri Nov <span class="number">24</span> 09:<span class="number">11</span>:<span class="number">42</span> <span class="number">2017</span></span>
<span class="line">skgxpvfynet: mtype: <span class="number">61</span> process <span class="number">11799</span> failed because of a resource problem in the OS. The OS has most likely run out of buffers (rval: <span class="number">4</span>)</span>
<span class="line">Errors in file /u01/app/oracle/diag/rdbms/orcl/orcl2/trace/orcl2_ora_11799.trc  (incident=<span class="number">123381</span>):</span>
<span class="line">ORA-<span class="number">00603</span>: ORACLE server session terminated by fatal error</span>
<span class="line">ORA-<span class="number">27504</span>: IPC error creating OSD context</span>
<span class="line">ORA-<span class="number">27300</span>: OS <span class="keyword">system</span> dependent operation:sendmsg failed with status: <span class="number">105</span></span>
<span class="line">ORA-<span class="number">27301</span>: OS failure message: No buffer space available</span>
<span class="line">ORA-<span class="number">27302</span>: failure occurred at: sskgxpsnd2</span>
<span class="line">Incident details in: <span class="regexp">/u01/app</span><span class="regexp">/oracle/diag</span><span class="regexp">/rdbms/orcl</span><span class="regexp">/orcl2/incident</span><span class="regexp">/incdir_123381/orcl</span>2_ora_11799_i123381.trc</span>
<span class="line">Fri Nov <span class="number">24</span> 09:<span class="number">11</span>:<span class="number">42</span> <span class="number">2017</span></span>
<span class="line">skgxpvfynet: mtype: <span class="number">61</span> process <span class="number">11801</span> failed because of a resource problem in the OS. The OS has most likely run out of buffers (rval: <span class="number">4</span>)</span>
<span class="line">opiodr aborting process unknown ospid (<span class="number">11743</span>) as a result of ORA-<span class="number">603</span></span>
<span class="line">Errors in file /u01/app/oracle/diag/rdbms/orcl/orcl2/trace/orcl2_ora_11801.trc  (incident=<span class="number">123382</span>):</span>
<span class="line">ORA-<span class="number">00603</span>: ORACLE server session terminated by fatal error</span>
<span class="line">ORA-<span class="number">27504</span>: IPC error creating OSD context</span>
<span class="line">ORA-<span class="number">27300</span>: OS <span class="keyword">system</span> dependent operation:sendmsg failed with status: <span class="number">105</span></span>
<span class="line">ORA-<span class="number">27301</span>: OS failure message: No buffer space available</span>
<span class="line">ORA-<span class="number">27302</span>: failure occurred at: sskgxpsnd2</span>
<span class="line">Incident details in: <span class="regexp">/u01/app</span><span class="regexp">/oracle/diag</span><span class="regexp">/rdbms/orcl</span><span class="regexp">/orcl2/incident</span><span class="regexp">/incdir_123382/orcl</span>2_ora_11801_i123382.trc</span>
<span class="line">Dumping diagnostic data in directory=[cdmp_20171124091142], requested by (instance=<span class="number">2</span>, osid=<span class="number">11743</span>), summary=[incident=<span class="number">123380</span>].</span>
</pre></td></tr></table></figure></p>
<a id="more"></a>
<p>trace文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#/u01/app/oracle/diag/rdbms/orcl/orcl2/trace/orcl2_ora_11799.trc</span></span>
<span class="line">*** <span class="number">2017</span>-<span class="number">11</span>-<span class="number">24</span> 09:<span class="number">11</span>:<span class="number">42.123</span></span>
<span class="line">*** CLIENT ID:() <span class="number">2017</span>-<span class="number">11</span>-<span class="number">24</span> 09:<span class="number">11</span>:<span class="number">42.123</span></span>
<span class="line">*** SERVICE NAME:() <span class="number">2017</span>-<span class="number">11</span>-<span class="number">24</span> 09:<span class="number">11</span>:<span class="number">42.123</span></span>
<span class="line">*** MODULE NAME:() <span class="number">2017</span>-<span class="number">11</span>-<span class="number">24</span> 09:<span class="number">11</span>:<span class="number">42.123</span></span>
<span class="line">*** ACTION NAME:() <span class="number">2017</span>-<span class="number">11</span>-<span class="number">24</span> 09:<span class="number">11</span>:<span class="number">42.123</span></span>
<span class="line"></span>
<span class="line">SKGXP:[<span class="number">7</span>fbcc2bfda88.<span class="number">0</span>]<span class="string">&#123;0&#125;</span>: SKGXPVFYNET: Socket self-test could <span class="keyword">not</span> verify successful transmission of <span class="number">32768</span> bytes (mtype <span class="number">61</span>).</span>
<span class="line">SKGXP:[<span class="number">7</span>fbcc2bfda88.<span class="number">1</span>]<span class="string">&#123;0&#125;</span>: The network is required to support UDP protocol sends of this size.  Socket is bound to <span class="number">169.254</span>.<span class="number">188.234</span>.</span>
<span class="line">SKGXP:[<span class="number">7</span>fbcc2bfda88.<span class="number">2</span>]<span class="string">&#123;0&#125;</span>: phase <span class="string">'send'</span>, <span class="number">0</span> tries, <span class="number">100</span> loops, <span class="number">4905</span> ms (<span class="keyword">last</span>)</span>
<span class="line">struct ksxpp * ksxppg<span class="number">_</span> [<span class="number">0xc122540</span>, <span class="number">0x7fbcc2995310</span>) = <span class="number">0x7fbcc2995308</span></span>
<span class="line">Dump of memory from <span class="number">0x00007FBCC2995308</span> to <span class="number">0x00007FBCC2996838</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># /u01/app/oracle/diag/rdbms/orcl/orcl2/incident/incdir_123381/orcl2_ora_11799_i123381.trc</span></span>
<span class="line">Dump continued from file: <span class="regexp">/u01/app</span><span class="regexp">/oracle/diag</span><span class="regexp">/rdbms/orcl</span><span class="regexp">/orcl2/trace</span><span class="regexp">/orcl2_ora_11799.trc</span>
<span class="line">ORA-00603: ORACLE server session terminated by fatal error</span>
<span class="line">ORA-27504: IPC error creating OSD context</span>
<span class="line">ORA-27300: OS system dependent operation:sendmsg failed with status: 105</span>
<span class="line">ORA-27301: OS failure message: No buffer space available</span>
<span class="line">ORA-27302: failure occurr</span>
<span class="line">#========= Dump for incident 123381 (ORA 603) ========</span></span>
</pre></td></tr></table></figure></p>
<p>经查MOS(Oracle Linux: ORA-27301:OS Failure Message: No Buffer Space Available (文档 ID 2041723.1)，发现可能是因为网卡的MUT参数设置过高导致网卡的缓存不足导致的。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">CAUSE</span>
<span class="line"></span>
<span class="line"> This happens due to less space available <span class="keyword">for</span> network buffer reservation.</span>
<span class="line"></span>
<span class="line">SOLUTION</span>
<span class="line"></span>
<span class="line"><span class="number">1</span>. On servers with High Physical Memory, the parameter vm.min_free_kbytes should be set in the order of <span class="number">0</span>.<span class="number">4</span>% of total </span>
<span class="line">Physical Memory. This helps in keeping a larger range of defragmented memory pages available <span class="keyword">for</span> network buffers </span>
<span class="line">reducing the probability of a low-buffer-space conditions.</span>
<span class="line"></span>
<span class="line">*** For example, on a server which is having <span class="number">256</span>GB RAM, the parameter vm.min_free_kbytes should be set to <span class="number">1048576</span> ***</span>
<span class="line"> </span>
<span class="line"></span>
<span class="line">On NUMA Enabled Systems, the value of vm.min_free_kbytes should be multiplied by the number of NUMA nodes since the value </span>
<span class="line">is to be <span class="keyword">split</span> across all the nodes.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">On NUMA Enabled Systems, the value of vm.min_free_kbytes = n * <span class="number">0</span>.<span class="number">4</span>% of total Physical Memory. Here <span class="string">'n'</span> is the </span>
<span class="line">number of NUMA nodes.</span>
<span class="line"> </span>
<span class="line"></span>
<span class="line"><span class="number">2</span>. Additionally, the MTU value should be modified as below</span>
<span class="line"></span>
<span class="line"><span class="comment">#ifconfig lo mtu 16436</span></span>
<span class="line"></span>
<span class="line">To make the change persistent over reboot add the following line in the file /etc/sysconfig/network-scripts/ifcfg-lo :</span>
<span class="line"></span>
<span class="line">MTU=<span class="number">16436</span></span>
<span class="line">Save the file <span class="keyword">and</span> restart the network service to load the changes</span>
<span class="line"></span>
<span class="line"><span class="comment">#service network restart</span></span>
</pre></td></tr></table></figure></p>
<p>这应该是OEL操作系统专属的错误，对比OEL、RHEL、CentOS系统，发现只有OEL系统网卡本地回环的MTU是65536，其他系统均是16436，而MOS上的解决方案是将网卡本地回环的MTU改为16436。这台服务器网卡本地回环的MTU当前设置如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">lo        Link encap:Local Loopback  </span>
<span class="line">          inet addr:<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>  Mask:<span class="number">255.0</span>.<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">          inet6 addr: ::<span class="number">1</span>/<span class="number">128</span> Scope:Host</span>
<span class="line">          UP LOOPBACK RUNNING  MTU:<span class="number">65536</span>  Metric:<span class="number">1</span></span>
<span class="line">          RX packets:<span class="number">1193604960</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span>
<span class="line">          TX packets:<span class="number">1193604960</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span>
<span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">0</span> </span>
<span class="line">          RX bytes:<span class="number">498857656538</span> (<span class="number">464.5</span> GiB)  TX bytes:<span class="number">498857656538</span> (<span class="number">464.5</span> GiB)</span>
</pre></td></tr></table></figure></p>
<p>当前服务器网卡本地回环的MTU默认设置是65536，按照MOS文档的方法修改这个设置。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ifconfig lo mtu <span class="number">16436</span></span>
</pre></td></tr></table></figure></p>
<p>这个命令将修改内存中网卡的参数，直接生效。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">lo        Link encap:Local Loopback  </span>
<span class="line">          inet addr:<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>  Mask:<span class="number">255.0</span>.<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">          inet6 addr: ::<span class="number">1</span>/<span class="number">128</span> Scope:Host</span>
<span class="line">          UP LOOPBACK RUNNING  MTU:<span class="number">16436</span>  Metric:<span class="number">1</span></span>
<span class="line">          RX packets:<span class="number">1193606824</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span>
<span class="line">          TX packets:<span class="number">1193606824</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span>
<span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">0</span> </span>
<span class="line">          RX bytes:<span class="number">498858566038</span> (<span class="number">464.5</span> GiB)  TX bytes:<span class="number">498858566038</span> (<span class="number">464.5</span> GiB)</span>
</pre></td></tr></table></figure></p>
<p>但是重启后将恢复默认值，如果保证重启也生效，就需要修改网卡的配置文件。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network-scripts/ifcfg-lo</span>
<span class="line"></span>
<span class="line">DEVICE=lo</span>
<span class="line">IPADDR=<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span></span>
<span class="line">NETMASK=<span class="number">255.0</span>.<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">NETWORK=<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">0</span></span>
<span class="line"><span class="comment"># If you're having problems with gated making 127.0.0.0/8 a martian,</span></span>
<span class="line"><span class="comment"># you can change this to something else (255.255.255.255, for example)</span></span>
<span class="line">BROADCAST=<span class="number">127.255</span>.<span class="number">255.255</span></span>
<span class="line">ONBOOT=yes</span>
<span class="line">NAME=loopback</span>
<span class="line">MTU=<span class="number">16436</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> ORA- </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 11 MySQL锁优化分析]]></title>
      <url>/2017/11/09/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/11-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="不同索引加锁顺序的问题，模拟重现死锁"><a href="#不同索引加锁顺序的问题，模拟重现死锁" class="headerlink" title="不同索引加锁顺序的问题，模拟重现死锁"></a>不同索引加锁顺序的问题，模拟重现死锁</h2><p>走索引的SQL语句，会涉及两把锁，在特定场景下就会产生交差锁等待</p>
<h3 id="测试表结构及相关语句"><a href="#测试表结构及相关语句" class="headerlink" title="测试表结构及相关语句"></a>测试表结构及相关语句</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show create table employees\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">       Table: employees</span>
<span class="line">Create Table: CREATE TABLE <span class="string">`employees`</span> (</span>
<span class="line">  <span class="string">`emp_no`</span> <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL,</span>
<span class="line">  <span class="string">`birth_date`</span> date NOT NULL,</span>
<span class="line">  <span class="string">`first_name`</span> varchar(<span class="number">14</span>) NOT NULL,</span>
<span class="line">  <span class="string">`last_name`</span> varchar(<span class="number">16</span>) NOT NULL,</span>
<span class="line">  <span class="string">`gender`</span> enum(<span class="string">'M'</span>,<span class="string">'F'</span>) NOT NULL,</span>
<span class="line">  <span class="string">`hire_date`</span> date NOT NULL,</span>
<span class="line">  <span class="string">`base_salaries`</span> decimal(<span class="number">8</span>,<span class="number">2</span>) NOT NULL,</span>
<span class="line">  <span class="string">`id`</span> <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</span>
<span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span>
<span class="line">  KEY <span class="string">`idx_emp_hire`</span> (<span class="string">`hire_date`</span>),</span>
<span class="line">  KEY <span class="string">`idx_emp_no`</span> (<span class="string">`emp_no`</span>)</span>
<span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">300151</span> DEFAULT CHARSET=utf8</span>
<span class="line"></span>
<span class="line">alter table employees drop primary key;</span>
<span class="line">create <span class="keyword">index</span> idx_emp_no on employees(emp_no);</span>
<span class="line">alter table employees add id <span class="keyword">int</span>;</span>
<span class="line">alter table employees change id id <span class="keyword">int</span> <span class="keyword">not</span> null auto_increment primary key;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="模拟重现死锁"><a href="#模拟重现死锁" class="headerlink" title="模拟重现死锁"></a>模拟重现死锁</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开两个会话</span></span>
<span class="line"><span class="comment"># 1. 会话1</span></span>
<span class="line">mysql&gt; start transaction;</span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from employees where emp_no=<span class="number">99075</span> <span class="keyword">for</span> update;</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line">| emp_no | birth_date | first_name | last_name | gender | hire_date  | base_salaries | id    |</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line">|  <span class="number">99075</span> | <span class="number">1961</span>-08-<span class="number">14</span> | Filipp     | Covnot    | M      | <span class="number">1999</span>-<span class="number">01</span>-<span class="number">02</span> |          <span class="number">0</span>.<span class="number">00</span> | <span class="number">89075</span> |</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line"></span>
<span class="line">mysql&gt; explain <span class="keyword">select</span> * from employees where emp_no=<span class="number">99075</span>;</span>
<span class="line">+----+-------------+-----------+------+---------------+------------+---------+-------+------+-------+</span>
<span class="line">| id | select_type | table     | type | possible_keys | key        | key_len | <span class="keyword">ref</span>   | rows | Extra |</span>
<span class="line">+----+-------------+-----------+------+---------------+------------+---------+-------+------+-------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | employees | <span class="keyword">ref</span>  | idx_emp_no    | idx_emp_no | <span class="number">4</span>       | const |    <span class="number">1</span> | NULL  |</span>
<span class="line">+----+-------------+-----------+------+---------------+------------+---------+-------+------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 2. 会话2</span></span>
<span class="line">mysql&gt; start transaction;</span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from employees where emp_no=<span class="number">108961</span> <span class="keyword">for</span> update;</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line">| emp_no | birth_date | first_name | last_name | gender | hire_date  | base_salaries | id    |</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line">| <span class="number">108961</span> | <span class="number">1962</span>-<span class="number">11</span>-<span class="number">13</span> | Jianhua    | Piveteau  | F      | <span class="number">1999</span>-<span class="number">01</span>-<span class="number">02</span> |       <span class="number">1000.00</span> | <span class="number">98961</span> |</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 3. 会话1</span></span>
<span class="line">mysql&gt; update employees set base_salaries=base_salaries+<span class="number">1000</span> where emp_no=<span class="number">108961</span>;</span>
<span class="line"><span class="comment">## 这时会产生锁等待，新开一个会话可以查看锁的状态</span></span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from information_schema.innodb_locks;</span>
<span class="line">+--------------------+-------------+-----------+-----------+-------------------------+------------+------------+-----------+----------+---------------+</span>
<span class="line">| lock_id            | lock_trx_id | lock_mode | lock_type | lock_table              | lock_index | lock_space | lock_page | lock_rec | lock_data     |</span>
<span class="line">+--------------------+-------------+-----------+-----------+-------------------------+------------+------------+-----------+----------+---------------+</span>
<span class="line">| <span class="number">26909</span>:<span class="number">208</span>:<span class="number">1522</span>:<span class="number">918</span> | <span class="number">26909</span>       | X         | RECORD    | <span class="string">`employees`</span>.<span class="string">`employees`</span> | idx_emp_no |        <span class="number">208</span> |      <span class="number">1522</span> |      <span class="number">918</span> | <span class="number">108961</span>, <span class="number">98961</span> |</span>
<span class="line">| <span class="number">26910</span>:<span class="number">208</span>:<span class="number">1522</span>:<span class="number">918</span> | <span class="number">26910</span>       | X         | RECORD    | <span class="string">`employees`</span>.<span class="string">`employees`</span> | idx_emp_no |        <span class="number">208</span> |      <span class="number">1522</span> |      <span class="number">918</span> | <span class="number">108961</span>, <span class="number">98961</span> |</span>
<span class="line">+--------------------+-------------+-----------+-----------+-------------------------+------------+------------+-----------+----------+---------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 4. 会话2</span></span>
<span class="line">mysql&gt; update employees set base_salaries=base_salaries+<span class="number">1000</span> where emp_no=<span class="number">99075</span>;</span>
<span class="line">ERROR <span class="number">1213</span> (<span class="number">40001</span>): Deadlock found <span class="keyword">when</span> trying to get lock; try restarting transaction</span>
<span class="line"><span class="comment">## 产生死锁</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 5. 会话1</span></span>
<span class="line">mysql&gt; update employees set base_salaries=base_salaries+<span class="number">1000</span> where emp_no=<span class="number">108961</span>;</span>
<span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">29.87</span> sec)</span>
<span class="line">Rows matched: <span class="number">1</span>  Changed: <span class="number">1</span>  Warnings: <span class="number">0</span></span>
<span class="line"><span class="comment">## 解锁，update语句执行成功</span></span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from employees where emp_no=<span class="number">108961</span>;</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line">| emp_no | birth_date | first_name | last_name | gender | hire_date  | base_salaries | id    |</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line">| <span class="number">108961</span> | <span class="number">1962</span>-<span class="number">11</span>-<span class="number">13</span> | Jianhua    | Piveteau  | F      | <span class="number">1999</span>-<span class="number">01</span>-<span class="number">02</span> |       <span class="number">2000.00</span> | <span class="number">98961</span> |</span>
<span class="line">+--------+------------+------------+-----------+--------+------------+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 6. 在新开会话中查看最后一次死锁信息</span></span>
<span class="line">mysql&gt; show engine innodb status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">  Type: InnoDB</span>
<span class="line">  Name: </span>
<span class="line">Status: </span>
<span class="line">....</span>
<span class="line"></span>
<span class="line">------------------------</span>
<span class="line">LATEST DETECTED DEADLOCK</span>
<span class="line">------------------------</span>
<span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">21</span> <span class="number">16</span>:<span class="number">46</span>:<span class="number">52</span> <span class="number">7</span>fc588cb970<span class="number">0</span></span>
<span class="line">*** (<span class="number">1</span>) TRANSACTION:</span>
<span class="line">TRANSACTION <span class="number">26909</span>, ACTIVE <span class="number">71</span> sec starting <span class="keyword">index</span> <span class="keyword">read</span></span>
<span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></span>
<span class="line">LOCK WAIT <span class="number">4</span> lock struct(<span class="keyword">s</span>), heap size <span class="number">1184</span>, <span class="number">3</span> row lock(<span class="keyword">s</span>)</span>
<span class="line">MySQL thread id <span class="number">157583</span>, OS thread handle <span class="number">0x7fc588c78700</span>, query id <span class="number">2221313</span> localhost root updating</span>
<span class="line">update employees set base_salaries=base_salaries+<span class="number">1000</span> where emp_no=<span class="number">108961</span></span>
<span class="line">*** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span>
<span class="line">RECORD LOCKS space id <span class="number">208</span> page <span class="keyword">no</span> <span class="number">1522</span> n bits <span class="number">1272</span> <span class="keyword">index</span> <span class="string">`idx_emp_no`</span> of table <span class="string">`employees`</span>.<span class="string">`employees`</span> trx id <span class="number">26909</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span>
<span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">918</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></span>
<span class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">8001</span>a9a1; asc     ;;</span>
<span class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80018291</span>; asc     ;;</span>
<span class="line"></span>
<span class="line">*** (<span class="number">2</span>) TRANSACTION:</span>
<span class="line">TRANSACTION <span class="number">26910</span>, ACTIVE <span class="number">32</span> sec starting <span class="keyword">index</span> <span class="keyword">read</span></span>
<span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></span>
<span class="line"><span class="number">4</span> lock struct(<span class="keyword">s</span>), heap size <span class="number">1184</span>, <span class="number">3</span> row lock(<span class="keyword">s</span>)</span>
<span class="line">MySQL thread id <span class="number">157584</span>, OS thread handle <span class="number">0x7fc588cb9700</span>, query id <span class="number">2221315</span> localhost root updating</span>
<span class="line">update employees set base_salaries=base_salaries+<span class="number">1000</span> where emp_no=<span class="number">99075</span></span>
<span class="line">*** (<span class="number">2</span>) HOLDS THE LOCK(S):</span>
<span class="line">RECORD LOCKS space id <span class="number">208</span> page <span class="keyword">no</span> <span class="number">1522</span> n bits <span class="number">1272</span> <span class="keyword">index</span> <span class="string">`idx_emp_no`</span> of table <span class="string">`employees`</span>.<span class="string">`employees`</span> trx id <span class="number">26910</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span>
<span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">918</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></span>
<span class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">8001</span>a9a1; asc     ;;</span>
<span class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80018291</span>; asc     ;;</span>
<span class="line"></span>
<span class="line">*** (<span class="number">2</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span>
<span class="line">RECORD LOCKS space id <span class="number">208</span> page <span class="keyword">no</span> <span class="number">1514</span> n bits <span class="number">1272</span> <span class="keyword">index</span> <span class="string">`idx_emp_no`</span> of table <span class="string">`employees`</span>.<span class="string">`employees`</span> trx id <span class="number">26910</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span>
<span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">656</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></span>
<span class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80018303</span>; asc     ;;</span>
<span class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80015</span>bf3; asc   [ ;;</span>
<span class="line">......</span>
</pre></td></tr></table></figure>
<h2 id="TMS死锁分析和处理，模拟重现死锁"><a href="#TMS死锁分析和处理，模拟重现死锁" class="headerlink" title="TMS死锁分析和处理，模拟重现死锁"></a>TMS死锁分析和处理，模拟重现死锁</h2><p>重现死锁<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%isolation%'</span>;</span>
<span class="line">+---------------+-----------------+</span>
<span class="line">| Variable_name | Value           |</span>
<span class="line">+---------------+-----------------+</span>
<span class="line">| tx_isolation  | REPEATABLE-READ |</span>
<span class="line">+---------------+-----------------+</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%lock_wait%'</span>;</span>
<span class="line">+--------------------------+----------+</span>
<span class="line">| Variable_name            | Value    |</span>
<span class="line">+--------------------------+----------+</span>
<span class="line">| innodb_lock_wait_timeout | <span class="number">20</span>       |</span>
<span class="line">| lock_wait_timeout        | <span class="number">31536000</span> |</span>
<span class="line">+--------------------------+----------+</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%autocommit%'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| autocommit    | OFF   |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 会话1</span></span>
<span class="line"><span class="keyword">use</span> lyj</span>
<span class="line">create table t2 (</span>
<span class="line">    a <span class="keyword">int</span> <span class="keyword">not</span> null default <span class="number">0</span>,</span>
<span class="line">    b <span class="keyword">int</span> default null,</span>
<span class="line">    primary key (a));</span>
<span class="line"></span>
<span class="line">insert into t2 (a,b) <span class="keyword">values</span>(<span class="number">2</span>,<span class="number">2</span>);</span>
<span class="line">insert into t2 (a,b) <span class="keyword">values</span>(<span class="number">3</span>,<span class="number">3</span>);</span>
<span class="line">insert into t2 (a,b) <span class="keyword">values</span>(<span class="number">4</span>,<span class="number">4</span>);</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> * from t2;</span>
<span class="line">+---+------+</span>
<span class="line">| a | b    |</span>
<span class="line">+---+------+</span>
<span class="line">| <span class="number">2</span> |    <span class="number">2</span> |</span>
<span class="line">| <span class="number">3</span> |    <span class="number">3</span> |</span>
<span class="line">| <span class="number">4</span> |    <span class="number">4</span> |</span>
<span class="line">+---+------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 下面为了方便区分，将提示符加上时间显示</span></span>
<span class="line"><span class="comment">## 启动mysql时添加 --prompt="\\u@\\h:\\d \\r:\\m:\\s&gt; "</span></span>
<span class="line">root@localhost:lyj <span class="number">10</span>:<span class="number">35</span>:<span class="number">42</span>&gt; insert into t2 (a,b) <span class="keyword">values</span>(<span class="number">5</span>,<span class="number">5</span>);</span>
<span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 会话2</span></span>
<span class="line">root@localhost:lyj <span class="number">10</span>:<span class="number">35</span>:<span class="number">37</span>&gt; <span class="keyword">use</span> lyj</span>
<span class="line">Database changed</span>
<span class="line">root@localhost:lyj <span class="number">10</span>:<span class="number">36</span>:<span class="number">30</span>&gt; <span class="keyword">select</span> * from t2;</span>
<span class="line">+---+------+</span>
<span class="line">| a | b    |</span>
<span class="line">+---+------+</span>
<span class="line">| <span class="number">2</span> |    <span class="number">2</span> |</span>
<span class="line">| <span class="number">3</span> |    <span class="number">3</span> |</span>
<span class="line">| <span class="number">4</span> |    <span class="number">4</span> |</span>
<span class="line">+---+------+</span>
<span class="line"></span>
<span class="line"><span class="comment">## 这时有锁等待</span></span>
<span class="line">root@localhost:lyj <span class="number">06</span>:<span class="number">07</span>:<span class="number">24</span>&gt; <span class="keyword">delete</span> from t2 where b=<span class="number">2</span>;</span>
<span class="line"><span class="comment">## 查看锁信息</span></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks;</span>
<span class="line">+---------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| lock_id       | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |</span>
<span class="line">+---------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| <span class="number">29509</span>:<span class="number">211</span>:<span class="number">3</span>:<span class="number">5</span> | <span class="number">29509</span>       | X         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |        <span class="number">211</span> |         <span class="number">3</span> |        <span class="number">5</span> | <span class="number">5</span>         |</span>
<span class="line">| <span class="number">29504</span>:<span class="number">211</span>:<span class="number">3</span>:<span class="number">5</span> | <span class="number">29504</span>       | X         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |        <span class="number">211</span> |         <span class="number">3</span> |        <span class="number">5</span> | <span class="number">5</span>         |</span>
<span class="line">+---------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 会话1</span></span>
<span class="line">root@localhost:lyj <span class="number">06</span>:<span class="number">07</span>:<span class="number">32</span>&gt;insert into t2 (a,b) <span class="keyword">values</span>(<span class="number">6</span>,<span class="number">6</span>);</span>
<span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">root@localhost:lyj <span class="number">06</span>:08:<span class="number">13</span>&gt;insert into t2 (a,b) <span class="keyword">values</span>(<span class="number">1</span>,<span class="number">1</span>);</span>
<span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 会话2，刚才的等待出现死锁错误</span></span>
<span class="line">ERROR <span class="number">1213</span> (<span class="number">40001</span>): Deadlock found <span class="keyword">when</span> trying to get lock; try restarting transaction</span>
</pre></td></tr></table></figure></p>
<p>死锁分析：在RR事务隔离级别下，由于DELETE没有用主键或者唯一索引，和INSERT形成死锁，无法避免。<br>处理办法：将事务隔离级别修改为RC，或才在RR事务隔离级别，将<code>innodb_locks_unsafe_for_binlog</code>设置为<code>on</code>也可以。</p>
<h2 id="MySQL如何避免死锁"><a href="#MySQL如何避免死锁" class="headerlink" title="MySQL如何避免死锁"></a>MySQL如何避免死锁</h2><h3 id="注意程序的逻辑（最重要）"><a href="#注意程序的逻辑（最重要）" class="headerlink" title="注意程序的逻辑（最重要）"></a>注意程序的逻辑（最重要）</h3><p>根本的原因是程序逻辑的顺序，最常见的是交差更新<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">Transaction <span class="number">1</span>: 更新表A -&gt; 更新表B</span>
<span class="line">Transaction <span class="number">2</span>: 更新表B -&gt; 更新表A</span>
</pre></td></tr></table></figure></p>
<p>这类问题要从程序上避免，所有的更新需要按照一定顺序</p>
<h3 id="保持事务的轻量"><a href="#保持事务的轻量" class="headerlink" title="保持事务的轻量"></a>保持事务的轻量</h3><p>越是轻量的事务，占有越少的锁资源，这样发生死锁的几率就越小</p>
<ol>
<li>提高运行速度，避免使用子查询，尽量使用主键等</li>
<li>尽量快提交事务，减少持有锁的时间</li>
</ol>
<p>死锁是数据库对事务的保护机制，一旦发生死锁，mysql会选择相对小的事务(undo较少的)进行回滚。死锁的发生与否，并不在于事务中有多少条SQL语句，死锁的关键在于：两个或两个以上的session加锁的顺序不一致。分析MySQ每条SQL的加锁规则、顺序，检查多个并发SQL间是否存在相反的顺序加锁的情况，就可以分析出各种潜在的死锁情况，也可以分析出线上死锁发生的原因。</p>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 10 MySQL写出高效SQL]]></title>
      <url>/2017/11/09/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/10-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="MySQL设计标准"><a href="#MySQL设计标准" class="headerlink" title="MySQL设计标准"></a>MySQL设计标准</h2><ol>
<li>数据库命名规范、统一，如vip_xxxx</li>
<li><strong><font color="red">表一旦设计好，字段只允许增加，不允许减少(drop column)</font></strong></li>
<li>统一使用INNODB存储引擎，UTF8编码（整个数据库的编码统一为<code>utf8_general_ci</code>，为此不需要建立表的DDL上加上<code>CHARACTER SET COLLATE utf8_general_ci）</code></li>
<li>需在设计阶段考虑如果访问量非常大，且不做<code>scale out(横向扩展)</code>表拆分的话，需读写分离，但读写分离注意主从复制有延迟的可能性</li>
<li><strong><font color="red">禁用</font></strong>stored procedure(包括存储过程，函数，触发器)，容易将业务逻辑和DB耦合在一起，并且MySQL的存储过程、触发器、函数中存在一定的bug</li>
<li><strong><font color="red">禁止使用</font></strong><code>UUID()</code>，<code>USER()</code>这样的<code>MYSQL INSIDE</code>函数，对于复制来说是很危险的，会导致主备数据不一致，重要的是会严重影响mysql性能</li>
<li>表必须有主键，建议统一由<code>auto_increment</code>字段生成整型，不建议使用组合主键， <strong><font color="red">另外<code>auto_increment</code>主键字段只作为虚拟主键，不建议与业务数据处理有关联关系，如果把控不好，会有问题</font></strong></li>
<li>库名、表名、字段名、索引名必须使用小写字母</li>
<li>多表join写SQL的时候，一定要给每个字段指定表名做前缀</li>
<li>如果应用使用的是长连接，应用必须具有自动重连的机制。但需避免每执行一个SQL去检查一次DB可用性<a id="more"></a></li>
<li>如果应用使用的是长连接，应用应该具有连接的TIMEOUT检查机制，及时回收长时间没有使用的连接，TIMEOUNT时间一般建议为20min</li>
<li>存储精确浮点数必须使用DECIMAL替代FLOAT和DOUBLE，DECIMAL类型具有更高的精度和更小的范围，它适合于财务和货币计算，如金额等</li>
<li>表名、列名必须有注释（必须加上<code>COMMENT &#39;&lt;字段扼要解说&gt;&#39;</code>），表结构变更须由库表OWNER所在团队发起</li>
<li>SQL语句必须采用<code>PreparedStatement</code>技术，可以提升性能并且避免SQL注入，如果编程语言不支持<code>PreparedStatement</code>技术，需要做好特殊字符过滤，如不要前后有空串等</li>
<li>尽可能不要使用TEXT、BLOB、CHAR字段类型，请使用<code>VARCHAR(N)</code>，N表示的是字符数不是字节数，比如<code>VARCHAR(255)</code>，可以最大存储255个汉字，需要根据实际宽度来设置N，<strong><font color="red">请注意同一表中，所有VARCHAR字段的长度加起来，不能大于65535</font></strong></li>
<li>每张表数据量建议控制在千万级别行以下，为此设计阶段需要考虑数据的归档</li>
<li>如果字段只有<code>ture or false</code>，请使用tinyint(数值范围-128～127)，如果模块分类：1订单/2商品；删除标示：0正常/1删除</li>
<li>存储时间（精确到秒）建议使用TIMESTAMP类型，因为TIMESTAMP使用4个字节，DATETIME使用8个字节，同时TIMESTAMP具有自动赋值以及自动更新的特性</li>
<li>每个字段的默认值不能用NULL，禁止<code>default NULL</code>，数据类型用<code>default 0</code>，字符类型用<code>default &#39;&#39;</code></li>
<li><strong><font color="red">关键业务数据表，建议用<code>create_time</code>和<code>last_update_time</code>，方便后期数据分析，如订单表，库存表</font></strong></li>
<li><strong><font color="red">关键业务数据表，如订单表、用户信息表，钱包支付信息等，禁止硬删除，必须软删除，加上<code>is_deleted</code>字段，标注这条记录的状态</font></strong></li>
<li><strong><font color="red">避免使用</font></strong><code>select col1,col2 from table where id in (select col from table) 这样的子查询</code></li>
<li>需要多表join的字段(<strong><font color="red">尽量避免多于两表join</font></strong>)，数据类型保持一致</li>
<li><strong><font color="red">加字段禁止使用after，因为不能确定全局代码里面是否都采用了类似<code>insert into table(col,col,col...) values ....</code>，若中间插一个字段，就会导致数据偏移的问题，影响可大可小，同样<code>select *</code>的也可能会影响数值的偏移</font></strong></li>
<li><strong><font color="red">生产环境中，MySQL忽略大小写，配置了<code>lower_case_table_names=1</code></font></strong></li>
<li>select语句只获取需要的字段，禁止使用select * from语句，这是有效防止新增字段对应用逻辑的影响，还能减少对性能的影响</li>
<li>INSERT语句必须显式的指明字段名称，不使用INSERT INTO table values()</li>
<li>禁止在where子句中对字段施加函数，如to_date(add_time)&gt;xxxxx，应改为add_time&gt;=unix_timestamp(date_add(str_to_date(‘20171109’,’%Y%m%d’),interval-29 day))</li>
<li>where条件中必须使用合适的类型，避免MySOL进行隐式类型转化，如ISENDED=1，字段类型是tinyint，则不能写成ISENDED=’1’</li>
<li>应用程序里的SQL语句，禁止一切DDL操作，如有特殊需要需与DBA协商，同意后方可使用</li>
<li>避免在SQL语句进行数学运算或函数运算，容易将业务逻辑和DB耦合在一起</li>
<li>INSERT语句使用batch提交</li>
<li>INNODB表避免使用count(*)操作，计数统计实时要求较强可以使用memcache或redis，非实时统计可以使用单独统计表，定时更新</li>
<li>使用%前缀模糊查询将不走索引，例如LIKE ‘%weibo’，不建议使用</li>
<li>避免多余的排序，使用group by时，默认会进行排序，当不需要排序时，可以使用order by null</li>
<li>不鼓励在数据库里排序，行数小的，建议放在应用服务上排序</li>
</ol>
<h2 id="事务的处理标准"><a href="#事务的处理标准" class="headerlink" title="事务的处理标准"></a>事务的处理标准</h2><ol>
<li>一个事务，处理的行数不能超过1000 rows/s，超出会导致主从复制延迟的问题</li>
<li>禁止一些框架或定制化的底层类等使用<code>set autocommit=0;</code>、<code>set autocommit=1;</code>这样控制事务，应该由程序把控，需要时<code>begin;</code>，操作完后及时<code>commit;</code></li>
</ol>
<h2 id="索引使用标准"><a href="#索引使用标准" class="headerlink" title="索引使用标准"></a>索引使用标准</h2><ol>
<li>非唯一索引建议使用<code>idx_表缩写名称_字段缩写名称</code>进行命名</li>
<li>唯一索引建议使用<code>uniq_表缩写名称_字段缩写名称</code>进行命名</li>
<li>索引名称必须使用小写</li>
<li>唯一键不和主键重复</li>
<li>索引字段的顺序需要考虑字段去重之后的个数，个数多的放在前面，就是数据分布</li>
<li>使用EXPLAIN判断SQL语句是否合理的使用索引，尽量避免extra列出现：<code>Using File Sort</code>，<code>Using Temporary</code></li>
<li>UPDATE、DELETE语句需要根据WHERE条件添加索引</li>
<li>合理创建联合索引（避免冗余），<code>(a,b,c)</code>相当于<code>(a)</code>、<code>(a,b)</code>、<code>(a,b,c)</code></li>
<li>合理利用覆盖索引（三星索引），如<code>select emain,uid from user_email where uid=xx</code>，如果uid不是主键，适当时候可以添加<code>(uid,email)</code>覆盖索引，以获得性能提升</li>
</ol>
<h2 id="约束设计"><a href="#约束设计" class="headerlink" title="约束设计"></a>约束设计</h2><ol>
<li>主键的内容不能被修改</li>
<li>禁用外键约束，外键约束一般不在数据库上创建，只表达一个逻辑的概念，由程序控制</li>
<li>unique约束命名<code>UK_列名</code>，check约束命名<code>CK_列名</code></li>
</ol>
<h2 id="怎么写出高效SQL"><a href="#怎么写出高效SQL" class="headerlink" title="怎么写出高效SQL"></a>怎么写出高效SQL</h2><ol>
<li>清晰无误的了知业务需求</li>
<li>满足业务需求，不做无用功</li>
<li>知道表数据量和索引基本情况</li>
<li>知道完成SQL需要扫描的数据量级</li>
<li>SQL执行计划OK？SQL性能达到要求？</li>
<li>调整索引和SQL，优化SQL</li>
</ol>
<h2 id="关于IN子查询"><a href="#关于IN子查询" class="headerlink" title="关于IN子查询"></a>关于IN子查询</h2><p>IN子查询容易导致问题，禁止使用，需改成join</p>
<ol>
<li>in子查询包含group by，外部查询的值传不到in子查询中，会导致in子查询效率低下</li>
<li>外部查询传入到in子查询中的值没法利用索引时，会导致in子查询效率低下</li>
<li>in子查询总是返回单个值时，用=，=和in处理机制不同</li>
<li>多个filter类子查询，一般在SQL后面的先执行</li>
</ol>
<h2 id="选择正确的驱动表"><a href="#选择正确的驱动表" class="headerlink" title="选择正确的驱动表"></a>选择正确的驱动表</h2><ol>
<li>多表关联查询，选择正确驱动表是最重要一步,好的开始是成功的一半</li>
<li>驱动表不一定是小表；表大，但过滤条件很强，能快速减少关联中间结果也可以选为驱动表</li>
<li>access vs filter</li>
<li>关联字段需建索引</li>
</ol>
<h2 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h2><h3 id="为什么使用prepared-statement能提高性能？"><a href="#为什么使用prepared-statement能提高性能？" class="headerlink" title="为什么使用prepared statement能提高性能？"></a>为什么使用prepared statement能提高性能？</h3><p>Statement主要用于执行静态SQL语句，即内容固定不变的SQL语句。Statement每执行一次都要对传入的SQL语句编译一次，效率较差。</p>
<p>PreparedStatement是Statement的子类，表示预编译的SQL语句的对象。在使用PreparedStatement对象执行SQL命令时，命令被数据库编译和解析，并放入命令缓冲区。缓冲区中的预编译SQL命令可以重复使用。</p>
<p>使用PreparedStatement时，SQL语句已提前编译，三种常用方法<code>execute</code>、<code>executeQuery</code>和<code>executeUpdate</code>已被更改，以使之不再需要参数。PreparedStatement 实例包含已事先编译的SQL语句，SQL语句可有一个或多个IN参数，IN参数的值在SQL语句创建时未被指定。该语句为每个IN留一个问号（“？”）作为占位符。 每个问号的值必须在该语句执行之前，通过适当的setInt或者setString 等方法提供。由于 PreparedStatement 对象已预编译过，所以其执行速度要快于Statement 对象。因此，多次执行的 SQL 语句经常创建为PreparedStatement 对象，以提高效率。</p>
<p>PreparedStatement的另外一个好处就是预防sql注入攻击。对JDBC而言，SQL注入攻击对PreparedStatement无效，因为PreparedStatement不允许在插入参数时改变SQL语句的逻辑结构。</p>
<h3 id="MySql优化的一般步骤是什么？举个例子详细说明。"><a href="#MySql优化的一般步骤是什么？举个例子详细说明。" class="headerlink" title="MySql优化的一般步骤是什么？举个例子详细说明。"></a>MySql优化的一般步骤是什么？举个例子详细说明。</h3><h4 id="通过show-status命令了解各种sql的执行效率"><a href="#通过show-status命令了解各种sql的执行效率" class="headerlink" title="通过show status命令了解各种sql的执行效率"></a>通过<code>show status</code>命令了解各种sql的执行效率</h4><p>通过SHOW STATUS可以提供服务器状态信息，也可以使用mysqladmin extended-status命令获得。SHOW STATUS可以根据需要显示session级别的统计结果和global级别的统计结果。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 以下几个参数对Myisam和Innodb存储引擎都计数</span></span>
<span class="line">Com_select  执行<span class="keyword">select</span>操作的次数，一次查询只累加<span class="number">1</span></span>
<span class="line">Com_insert  执行insert操作的次数，对于批量插入的insert操作，只累加一次</span>
<span class="line">Com_update  执行update操作的次数</span>
<span class="line">Com_delete　执行<span class="keyword">delete</span>操作的次数</span>
<span class="line"></span>
<span class="line"><span class="comment"># 以下几个参数是针对Innodb存储引擎计数的，累加的算法也略有不同</span></span>
<span class="line">Innodb_rows_read　   <span class="keyword">select</span>查询返回的行数</span>
<span class="line">Innodb_rows_inserted 执行insert操作插入的行数</span>
<span class="line">Innodb_rows_updated  执行update操作更新的行数</span>
<span class="line">Innodb_rows_deleted　执行<span class="keyword">delete</span>操作删除的行数</span>
<span class="line"></span>
<span class="line"><span class="comment"># 以下几个参数便于了解数据库的基本情况</span></span>
<span class="line">Connections  试图连接Mysql服务器的次数</span>
<span class="line">Uptime　     服务器工作时间</span>
<span class="line">Slow_queries 慢查询的次数</span>
<span class="line"></span>
<span class="line"><span class="comment"># 对于事务型的应用，通过Com_commit和Com_rollback可以了解事务提交和回滚的情况</span></span>
<span class="line"><span class="comment"># 对于回滚操作非常频繁的数据库，可能意味着应用编写存在问题</span></span>
</pre></td></tr></table></figure></p>
<h4 id="定位执行效率较低的SQL语句"><a href="#定位执行效率较低的SQL语句" class="headerlink" title="定位执行效率较低的SQL语句"></a>定位执行效率较低的SQL语句</h4><p>可以通过以下两种方式定位执行效率较低的SQL语句：</p>
<ol>
<li>可以通过慢查询日志定位那些执行效率较低的sql语句，用<code>--log-slow-queries[=file_name]</code>选项启动时，mysqld写一个包含所有执行时间超过<code>long_query_time</code>秒的SQL语句的日志文件。可以链接到管理维护中的相关章节。</li>
<li>慢查询日志在查询结束以后才纪录，所以在应用反映执行效率出现问题的时候查询慢查询日志并不能定位问题，可以使用<code>show processlist</code>命令查看当前MySQL在进行的线程，包括线程的状态，是否锁表等等，可以实时的查看SQL执行情况，同时对一些锁表操作进行优化</li>
</ol>
<h4 id="通过explain分析低效率的SQL语句的执行情况"><a href="#通过explain分析低效率的SQL语句的执行情况" class="headerlink" title="通过explain分析低效率的SQL语句的执行情况"></a>通过explain分析低效率的SQL语句的执行情况</h4><p>通过以上步骤查询到效率低的SQL后，可以通过explain或者desc获取MySQL如何执行SELECT语句的信息，包括select语句执行过程表如何连接和连接的次序。<br>执行计划说明：</p>
<blockquote>
<p>select_type：select类型<br>table：输出结果集的表<br>type：表示表的连接类型<br>　　1. 当表中仅有一行是type的值为system是最佳的连接类型；<br>　　2. 当select操作中使用索引进行表连接时type的值为ref；<br>　　3. 当select的表连接没有使用索引时，经常会看到type的值为ALL，表示对该表进行了全表扫描，这时需要考虑通过创建索引来提高表连接的效率。<br>possible_keys：表示查询时,可以使用的索引列.<br>key：表示使用的索引<br>key_len：索引长度<br>rows：扫描范围<br>Extra：执行情况的说明和描述</p>
</blockquote>
<h4 id="确定问题，并采取相应的优化措施"><a href="#确定问题，并采取相应的优化措施" class="headerlink" title="确定问题，并采取相应的优化措施"></a>确定问题，并采取相应的优化措施</h4><p>确认问题出现的原因后，可以根据情况采取相应的措施，进行优化提高执行的效率。 示例如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain <span class="keyword">select</span> e.emp_no,e.first_name,e.last_name,e.hire_date,d.dept_no from employees e,dept_emp d </span>
<span class="line">       where d.emp_no=e.emp_no <span class="keyword">and</span> d.dept_no=<span class="string">'d005'</span>;</span>
<span class="line">+----+-------------+-------+--------+---------------+---------+---------+--------------------+--------+-------------+</span>
<span class="line">| id | select_type | table | type   | possible_keys | key     | key_len | <span class="keyword">ref</span>                | rows   | Extra       |</span>
<span class="line">+----+-------------+-------+--------+---------------+---------+---------+--------------------+--------+-------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | d     | ALL    | NULL          | NULL    | NULL    | NULL               | <span class="number">331290</span> | Using where |</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | e     | eq_ref | PRIMARY       | PRIMARY | <span class="number">4</span>       | employees.d.emp_no |      <span class="number">1</span> | NULL        |</span>
<span class="line">+----+-------------+-------+--------+---------------+---------+---------+--------------------+--------+-------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 这个例子，对表dept_emp全表扫描，效果不理想，对d表的dept_no字段创建了索引，查询需要扫描的行数明显较少</span></span>
<span class="line">create <span class="keyword">index</span> idx_dept_emp_dn on dept_emp(dept_no);</span>
<span class="line"></span>
<span class="line">mysql&gt; explain <span class="keyword">select</span> e.emp_no,e.first_name,e.last_name,e.hire_date,d.dept_no from employees e,dept_emp d </span>
<span class="line">       where d.emp_no=e.emp_no <span class="keyword">and</span> d.dept_no=<span class="string">'d005'</span>;</span>
<span class="line">+----+-------------+-------+--------+-----------------+-----------------+---------+--------------------+--------+-----------------------+</span>
<span class="line">| id | select_type | table | type   | possible_keys   | key             | key_len | <span class="keyword">ref</span>                | rows   | Extra                 |</span>
<span class="line">+----+-------------+-------+--------+-----------------+-----------------+---------+--------------------+--------+-----------------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | d     | <span class="keyword">ref</span>    | idx_dept_emp_dn | idx_dept_emp_dn | <span class="number">12</span>      | const              | <span class="number">164256</span> | Using <span class="keyword">index</span> condition |</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | e     | eq_ref | PRIMARY         | PRIMARY         | <span class="number">4</span>       | employees.d.emp_no |      <span class="number">1</span> | NULL                  |</span>
<span class="line">+----+-------------+-------+--------+-----------------+-----------------+---------+--------------------+--------+-----------------------+</span>
</pre></td></tr></table></figure></p>
<h3 id="MySQL-这该死的-“IN-子查询-”，如下SQL怎么优化-“in-子查询-”？"><a href="#MySQL-这该死的-“IN-子查询-”，如下SQL怎么优化-“in-子查询-”？" class="headerlink" title="MySQL 这该死的 “IN (子查询)”，如下SQL怎么优化 “in(子查询)”？"></a>MySQL 这该死的 “IN (子查询)”，如下SQL怎么优化 “in(子查询)”？</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 优化前</span></span>
<span class="line">SELECT s1 FROM t1 WHERE s1 IN (SELECT s1 FROM t2 WHERE id = <span class="number">1</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 优化后</span></span>
<span class="line">SELECT s1 from t1 a,(SELECT s1 FROM t2 WHERE id = <span class="number">1</span>) b where a.s1=b.s1;</span>
</pre></td></tr></table></figure>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 这是一个简单的示例，每1000个语句为一批插入提交，它避免了SQL注入和内存不足的问题</span></span>
<span class="line"><span class="comment"># 插入到数据库使用批处理上万条记录，有可能产生的OutOfMemoryError</span></span>
<span class="line">import java.sql.Connection;</span>
<span class="line">import java.sql.PreparedStatement;</span>
<span class="line">...</span>
<span class="line">String sql = <span class="string">"insert into employee (name, city, phone) values (?, ?, ?)"</span>;</span>
<span class="line">Connection connection = new getConnection();</span>
<span class="line">PreparedStatement ps = connection.prepareStatement(sql);</span>
<span class="line">final <span class="keyword">int</span> batchSize = <span class="number">1000</span>;</span>
<span class="line"><span class="keyword">int</span> count = <span class="number">0</span>;</span>
<span class="line"><span class="keyword">for</span> (Employee employee: employees) &#123;</span>
<span class="line">    ps.setString(<span class="number">1</span>, employee.getName());</span>
<span class="line">    ps.setString(<span class="number">2</span>, employee.getCity());</span>
<span class="line">    ps.setString(<span class="number">3</span>, employee.getPhone());</span>
<span class="line">    ps.addBatch();</span>
<span class="line">    <span class="keyword">if</span>(++count % batchSize == <span class="number">0</span>) &#123;</span>
<span class="line">        ps.executeBatch();</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
<span class="line">ps.executeBatch(); <span class="regexp">//</span> insert remaining records</span>
<span class="line">ps.close();</span>
<span class="line">connection.close();</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 09 MySQL优化器算法解析]]></title>
      <url>/2017/10/24/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/09-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%20/</url>
      <content type="html"><![CDATA[<h2 id="MySQL优化器"><a href="#MySQL优化器" class="headerlink" title="MySQL优化器"></a>MySQL优化器</h2><h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>给定一个SQL，查找SQL最优（局部最优）的执行路径，使得用户能够更快的得到SQL的执行结果。</p>
<h3 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h3><ol>
<li>代价模型：RBO(基于规则的优化)、CBO(基于成本的优化)</li>
<li>SQL的每一种执行路径，均可计算一个对应的执行代价，代价越小，执行效率越高<a id="more"></a>
</li>
</ol>
<h3 id="CBO方式成本的计算"><a href="#CBO方式成本的计算" class="headerlink" title="CBO方式成本的计算"></a>CBO方式成本的计算</h3><blockquote>
<p>Total cost = CPU cost + IO cost</p>
</blockquote>
<h4 id="CPU-cost计算模型"><a href="#CPU-cost计算模型" class="headerlink" title="CPU cost计算模型"></a>CPU cost计算模型</h4><p>CPU cost = rows/5 + (rows/10 if comparing key)</p>
<blockquote>
<p>CPU cost:</p>
<ol>
<li>MySQL上层，处理返回记录所花开销</li>
<li>CPU Cost=records/TIME_FOR_COMPARE=Records/5</li>
<li>每5条记录处的时间，作为1 Cost</li>
</ol>
</blockquote>
<h4 id="IO-cost计算模型"><a href="#IO-cost计算模型" class="headerlink" title="IO cost计算模型"></a>IO cost计算模型</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/1024_mysql_tune_01.png" alt=""><br>IO cost以聚集索引叶子节点的数量进行计算</p>
<ul>
<li>全扫描<br>IO Cost = table stat_clustered_index_size<br>聚簇索引page总数，一个page作为1 cost</li>
<li>范围扫描<br>IO Cost = [(ranges+rows)/total_rows]*全扫描IO Cost<br>聚簇索引范围扫描与返回记录成比率</li>
</ul>
<p><img src="http://oligvdnzp.bkt.clouddn.com/1024_mysql_tune_02.png" alt=""><br>若需要回表，则IO cost以预估的记录数量进行计算，开销相当巨大</p>
<ul>
<li>二级索引之索引覆盖扫描<ul>
<li>索引覆盖扫描，减少返回聚簇索引的IO代价<br>keys_per_block=(stats_block_size/2)/(key_info[keynr].key_lenth+ref_length+1)<br>stats_block_size/2 = 索引页半满</li>
<li>IO Cost：(records+keys_per_block-1)/keys_per_block</li>
<li>计算range占用多少个二级索引页面，既为索引覆盖扫描的IO Cost</li>
</ul>
</li>
<li>二级索引之索引非覆盖扫描<ul>
<li>索引非覆盖扫描，需要回聚簇索引读取完整记录，增加IO代价</li>
<li>IO Cost = （range+rows）</li>
<li>range:多少个范围<br>对于IN查询，就会转换为多个索引范围查询</li>
<li>row:为范围中一共有多少记录<br>由于每一条记录都需要返回聚簇索引，因此每一条记录都会产生1 Cost</li>
</ul>
</li>
</ul>
<h3 id="Cost模型分析"><a href="#Cost模型分析" class="headerlink" title="Cost模型分析"></a>Cost模型分析</h3><ul>
<li>聚簇索引扫描代价为索引页面总数量</li>
<li>二级索引覆盖扫描代价较小</li>
<li>二级索引非覆盖扫描，代价巨大</li>
<li>Cost模型的计算，需要统计信息的支持<ul>
<li>stat_clustered_index_size</li>
<li>ranges</li>
<li>records/rows</li>
<li>stats_block_size</li>
<li>key_info[keynr].key_length</li>
<li>rec_per_key</li>
<li>……</li>
</ul>
</li>
</ul>
<h2 id="MySQL优化总流程"><a href="#MySQL优化总流程" class="headerlink" title="MySQL优化总流程"></a>MySQL优化总流程</h2><p><img src="http://oligvdnzp.bkt.clouddn.com/1024_mysql_tune_03.png" alt=""></p>
<h2 id="索引元数据的统计"><a href="#索引元数据的统计" class="headerlink" title="索引元数据的统计"></a>索引元数据的统计</h2><p><img src="http://oligvdnzp.bkt.clouddn.com/1024_mysql_tune_04.png" alt=""></p>
<h3 id="随机抽样统计元数据参数"><a href="#随机抽样统计元数据参数" class="headerlink" title="随机抽样统计元数据参数"></a>随机抽样统计元数据参数</h3><p>innodb_stats_sample_pages (5.5版本)<br>innodb_stats_transient_sample_pages (5.6版本)</p>
<h3 id="MySQL-5-6版本默认持久化索引元数据参数"><a href="#MySQL-5-6版本默认持久化索引元数据参数" class="headerlink" title="MySQL 5.6版本默认持久化索引元数据参数"></a>MySQL 5.6版本默认持久化索引元数据参数</h3><p>innodb_stats_persistent<br>nnodb_stats_persistent_sample_pages<br>innodb_stats_on_metadata<br>innodb_stats_auto_recalc</p>
<h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><h3 id="测试环境脚本"><a href="#测试环境脚本" class="headerlink" title="测试环境脚本"></a>测试环境脚本</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">drop database lyj;</span>
<span class="line">create database lyj;</span>
<span class="line"><span class="keyword">use</span> lyj;</span>
<span class="line"></span>
<span class="line">create table t1 (</span>
<span class="line">    c1 <span class="keyword">int</span>(<span class="number">11</span>) <span class="keyword">not</span> null default <span class="string">'0'</span>,</span>
<span class="line">    c2 varchar(<span class="number">128</span>) default null,</span>
<span class="line">    c3 varchar(<span class="number">64</span>) default null,</span>
<span class="line">    c4 <span class="keyword">int</span>(<span class="number">11</span>) default null,</span>
<span class="line">    primary key (c1),</span>
<span class="line">    key ind_c2 (c2),</span>
<span class="line">    key ind_c4 (c4));</span>
<span class="line"></span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'a'</span>,<span class="string">'A'</span>,<span class="number">10</span>);</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'b'</span>,<span class="string">'B'</span>,<span class="number">20</span>);</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">'b'</span>,<span class="string">'BB'</span>,<span class="number">20</span>);</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">'b'</span>,<span class="string">'BBB'</span>,<span class="number">30</span>);</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">'b'</span>,<span class="string">'BBB'</span>,<span class="number">40</span>);</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">6</span>,<span class="string">'c'</span>,<span class="string">'C'</span>,<span class="number">50</span>);</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">'d'</span>,<span class="string">'D'</span>,<span class="number">60</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line">+----+------+------+------+</span>
<span class="line">| c1 | c2   | c3   | c4   |</span>
<span class="line">+----+------+------+------+</span>
<span class="line">|  <span class="number">1</span> | a    | A    |   <span class="number">10</span> |</span>
<span class="line">|  <span class="number">2</span> | b    | B    |   <span class="number">20</span> |</span>
<span class="line">|  <span class="number">3</span> | b    | BB   |   <span class="number">20</span> |</span>
<span class="line">|  <span class="number">4</span> | b    | BBB  |   <span class="number">30</span> |</span>
<span class="line">|  <span class="number">5</span> | b    | BBB  |   <span class="number">40</span> |</span>
<span class="line">|  <span class="number">6</span> | c    | C    |   <span class="number">50</span> |</span>
<span class="line">|  <span class="number">7</span> | d    | D    |   <span class="number">60</span> |</span>
<span class="line">+----+------+------+------+</span>
</pre></td></tr></table></figure>
<h3 id="执行以下SQL为什么不走索引ind-c2？"><a href="#执行以下SQL为什么不走索引ind-c2？" class="headerlink" title="执行以下SQL为什么不走索引ind_c2？"></a>执行以下SQL为什么不走索引ind_c2？</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain <span class="keyword">select</span> * from t1 where c4=<span class="number">20</span> <span class="keyword">and</span> c2=<span class="string">'b'</span>\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">           id: <span class="number">1</span></span>
<span class="line">  select_type: SIMPLE</span>
<span class="line">        table: t1</span>
<span class="line">         type: <span class="keyword">ref</span></span>
<span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span>
<span class="line">          key: ind_c4</span>
<span class="line">      key_len: <span class="number">5</span></span>
<span class="line">          <span class="keyword">ref</span>: const</span>
<span class="line">         rows: <span class="number">2</span></span>
<span class="line">        Extra: Using where</span>
<span class="line"></span>
<span class="line">set optimizer_trace=<span class="string">'enabled=on'</span>;</span>
<span class="line">set optimizer_trace_max_mem_size=<span class="number">1000000</span>;</span>
<span class="line">set end_markers_in_json=on;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from t1 where c4=<span class="number">20</span> <span class="keyword">and</span> c2=<span class="string">'b'</span>;</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from information_schema.optimizer_trace\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">                            QUERY: <span class="keyword">select</span> * from t1 where c4=<span class="number">20</span> <span class="keyword">and</span> c2=<span class="string">'b'</span></span>
<span class="line">                            TRACE: &#123;</span>
<span class="line">......</span>
<span class="line">                  <span class="string">"potential_range_indices"</span>: [ <span class="comment"># 列出备选索引</span></span>
<span class="line">                    &#123;</span>
<span class="line">                      <span class="string">"index"</span>: <span class="string">"PRIMARY"</span>, </span>
<span class="line">                      <span class="string">"usable"</span>: false,         <span class="comment"># 本行表明主键索引不可用</span></span>
<span class="line">                      <span class="string">"cause"</span>: <span class="string">"not_applicable"</span></span>
<span class="line">                    &#125;,</span>
<span class="line">                    &#123;</span>
<span class="line">                      <span class="string">"index"</span>: <span class="string">"ind_c2"</span>,</span>
<span class="line">                      <span class="string">"usable"</span>: true,</span>
<span class="line">                      <span class="string">"key_parts"</span>: [</span>
<span class="line">                        <span class="string">"c2"</span>,</span>
<span class="line">                        <span class="string">"c1"</span></span>
<span class="line">                      ] /* key_parts *<span class="regexp">/</span>
<span class="line">                    &#125;,</span>
<span class="line">                    &#123;</span>
<span class="line">                      "index": "ind_c4",</span>
<span class="line">                      "usable": true,</span>
<span class="line">                      "key_parts": [</span>
<span class="line">                        "c4",</span>
<span class="line">                        "c1"</span>
<span class="line">                      ] /</span>* key_parts *<span class="regexp">/</span>
<span class="line">                    &#125;</span>
<span class="line">                  ] /</span>* potential_range_indices *<span class="regexp">/,</span>
<span class="line">                  "setup_range_conditions": [</span>
<span class="line">                  ] /</span>* setup_range_conditions *<span class="regexp">/,</span>
<span class="line">                  "group_index_range": &#123;</span>
<span class="line">                    "chosen": false,</span>
<span class="line">                    "cause": "not_group_by_or_distinct"</span>
<span class="line">                  &#125; /</span>* group_index_range *<span class="regexp">/,</span>
<span class="line">                  "analyzing_range_alternatives": &#123;   # 开始计算每个索引做范围扫描的花费</span>
<span class="line">                    "range_scan_alternatives": [</span>
<span class="line">                      &#123;</span>
<span class="line">                        "index": "ind_c2",</span>
<span class="line">                        "ranges": [</span>
<span class="line">                          "b &lt;= c2 &lt;= b"</span>
<span class="line">                        ] /</span>* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 4,         # c2=b的结果有4行</span>
<span class="line">                        "cost": 5.81,</span>
<span class="line">                        "chosen": false,   # 这个索引没有被选中，原因是cost</span>
<span class="line">                        "cause": "cost"   </span>
<span class="line">                      &#125;,</span>
<span class="line">                      &#123;</span>
<span class="line">                        "index": "ind_c4",</span>
<span class="line">                        "ranges": [</span>
<span class="line">                          "20 &lt;= c4 &lt;= 20"</span>
<span class="line">                        ] /</span>* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 2,</span>
<span class="line">                        "cost": 3.41,</span>
<span class="line">                        "chosen": true     # 这个索引的代价最小,被选中</span>
<span class="line">                      &#125;</span>
<span class="line">......</span>
<span class="line">                  "chosen_range_access_summary": &#123;  # 总结：因为cost最小选择了ind_c4</span>
<span class="line">                    "range_access_plan": &#123;</span>
<span class="line">                      "type": "range_scan",</span>
<span class="line">                      "index": "ind_c4",</span>
<span class="line">                      "rows": 2,</span>
<span class="line">                      "ranges": [</span>
<span class="line">                        "20 &lt;= c4 &lt;= 20"</span>
<span class="line">                      ] /</span>* ranges *<span class="regexp">/</span>
<span class="line">                    &#125; /</span>* range_access_plan *<span class="regexp">/,</span>
<span class="line">                    "rows_for_plan": 2,</span>
<span class="line">                    "cost_for_plan": 3.41,</span>
<span class="line">                    "chosen": true</span>
<span class="line">                  &#125; /</span>* chosen_range_access_summary *<span class="regexp">/</span>
<span class="line">......</span></span>
</pre></td></tr></table></figure>
<p>因为ind_c4范围扫描的cost要小于ind_c2，所以索引不走ind_c2</p>
<h3 id="where条件中字段c2和c4换个位置，索引还是不走ind-c2？为什么？"><a href="#where条件中字段c2和c4换个位置，索引还是不走ind-c2？为什么？" class="headerlink" title="where条件中字段c2和c4换个位置，索引还是不走ind_c2？为什么？"></a>where条件中字段c2和c4换个位置，索引还是不走ind_c2？为什么？</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> * from t1 where  c2=<span class="string">'b'</span> <span class="keyword">and</span> c4=<span class="number">20</span>\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">           id: <span class="number">1</span></span>
<span class="line">  select_type: SIMPLE</span>
<span class="line">        table: t1</span>
<span class="line">         type: <span class="keyword">ref</span></span>
<span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span>
<span class="line">          key: ind_c4</span>
<span class="line">      key_len: <span class="number">5</span></span>
<span class="line">          <span class="keyword">ref</span>: const</span>
<span class="line">         rows: <span class="number">2</span></span>
<span class="line">        Extra: Using where</span>
</pre></td></tr></table></figure>
<p>因为ind_c4范围扫描的cost要小于ind_c2，所以索引不走ind_c2，跟c2和c4的位置无关。验证方法同上。</p>
<h3 id="如下语句，换个条件c2-’c’，为什么可以走索引ind-c2？"><a href="#如下语句，换个条件c2-’c’，为什么可以走索引ind-c2？" class="headerlink" title="如下语句，换个条件c2=’c’，为什么可以走索引ind_c2？"></a>如下语句，换个条件c2=’c’，为什么可以走索引ind_c2？</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain <span class="keyword">select</span> * from t1 where c2=<span class="string">'c'</span> <span class="keyword">and</span> c4=<span class="number">20</span>\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">           id: <span class="number">1</span></span>
<span class="line">  select_type: SIMPLE</span>
<span class="line">        table: t1</span>
<span class="line">         type: <span class="keyword">ref</span></span>
<span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span>
<span class="line">          key: ind_c2</span>
<span class="line">      key_len: <span class="number">387</span></span>
<span class="line">          <span class="keyword">ref</span>: const</span>
<span class="line">         rows: <span class="number">1</span></span>
<span class="line">        Extra: Using <span class="keyword">index</span> condition; Using where</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from information_schema.optimizer_trace\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">                            QUERY: <span class="keyword">select</span> * from t1 where c2=<span class="string">'c'</span> <span class="keyword">and</span> c4=<span class="number">20</span></span>
<span class="line">                            TRACE: &#123;</span>
<span class="line">......</span>
<span class="line">                  <span class="string">"analyzing_range_alternatives"</span>: &#123;</span>
<span class="line">                    <span class="string">"range_scan_alternatives"</span>: [</span>
<span class="line">                      &#123;</span>
<span class="line">                        <span class="string">"index"</span>: <span class="string">"ind_c2"</span>,</span>
<span class="line">                        <span class="string">"ranges"</span>: [</span>
<span class="line">                          <span class="string">"c &lt;= c2 &lt;= c"</span></span>
<span class="line">                        ] /* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 1,           # c2=c 的结果集有1行</span>
<span class="line">                        "cost": 2.21,</span>
<span class="line">                        "chosen": true       # 这个索引的代价最小,被选中</span>
<span class="line">                      &#125;,</span>
<span class="line">                      &#123;</span>
<span class="line">                        "index": "ind_c4",</span>
<span class="line">                        "ranges": [</span>
<span class="line">                          "20 &lt;= c4 &lt;= 20"</span>
<span class="line">                        ] /</span>* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 2,</span>
<span class="line">                        "cost": 3.41,</span>
<span class="line">                        "chosen": false,   # 这个索引没有被选中，原因是cost</span>
<span class="line">                        "cause": "cost"</span>
<span class="line">                      &#125;</span>
<span class="line">                  ......</span></span>
</pre></td></tr></table></figure>
<h3 id="创建复合索引"><a href="#创建复合索引" class="headerlink" title="创建复合索引"></a>创建复合索引</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ALTER TABLE t1 ADD KEY ind_c2_c4(c2,c4);</span>
</pre></td></tr></table></figure>
<p><strong>下面语句为什么不走复合索引ind_c2_c4？</strong><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> * from t1 where  c2=<span class="string">'b'</span> <span class="keyword">and</span> c4=<span class="number">20</span>\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">           id: <span class="number">1</span></span>
<span class="line">  select_type: SIMPLE</span>
<span class="line">        table: t1</span>
<span class="line">         type: <span class="keyword">ref</span></span>
<span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span>
<span class="line">          key: ind_c4</span>
<span class="line">      key_len: <span class="number">5</span></span>
<span class="line">          <span class="keyword">ref</span>: const</span>
<span class="line">         rows: <span class="number">2</span></span>
<span class="line">        Extra: Using where</span>
<span class="line"></span>
<span class="line">set optimizer_trace=<span class="string">'enabled=on'</span>;</span>
<span class="line">set optimizer_trace_max_mem_size=<span class="number">1000000</span>;</span>
<span class="line">set end_markers_in_json=on;</span>
<span class="line"><span class="keyword">select</span> * from t1 where  c2=<span class="string">'b'</span> <span class="keyword">and</span> c4=<span class="number">20</span>;</span>
<span class="line"><span class="keyword">select</span> * from information_schema.optimizer_trace\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">                            QUERY: <span class="keyword">select</span> * from t1 where  c2=<span class="string">'b'</span> <span class="keyword">and</span> c4=<span class="number">20</span></span>
<span class="line">                            TRACE: &#123;</span>
<span class="line">......</span>
<span class="line">                  <span class="string">"potential_range_indices"</span>: [</span>
<span class="line">                    &#123;</span>
<span class="line">                      <span class="string">"index"</span>: <span class="string">"PRIMARY"</span>,</span>
<span class="line">                      <span class="string">"usable"</span>: false,</span>
<span class="line">                      <span class="string">"cause"</span>: <span class="string">"not_applicable"</span></span>
<span class="line">                    &#125;,</span>
<span class="line">                    &#123;</span>
<span class="line">                      <span class="string">"index"</span>: <span class="string">"ind_c2"</span>,</span>
<span class="line">                      <span class="string">"usable"</span>: true,</span>
<span class="line">                      <span class="string">"key_parts"</span>: [</span>
<span class="line">                        <span class="string">"c2"</span>,</span>
<span class="line">                        <span class="string">"c1"</span></span>
<span class="line">                      ] /* key_parts *<span class="regexp">/</span>
<span class="line">                    &#125;,</span>
<span class="line">                    &#123;</span>
<span class="line">                      "index": "ind_c4",</span>
<span class="line">                      "usable": true,</span>
<span class="line">                      "key_parts": [</span>
<span class="line">                        "c4",</span>
<span class="line">                        "c1"</span>
<span class="line">                      ] /</span>* key_parts *<span class="regexp">/</span>
<span class="line">                    &#125;,</span>
<span class="line">                    &#123;</span>
<span class="line">                      "index": "ind_c2_c4",</span>
<span class="line">                      "usable": true,</span>
<span class="line">                      "key_parts": [</span>
<span class="line">                        "c2",</span>
<span class="line">                        "c4",</span>
<span class="line">                        "c1"</span>
<span class="line">                      ] /</span>* key_parts *<span class="regexp">/</span>
<span class="line">                    &#125;</span>
<span class="line">                  ] /</span>* potential_range_indices *<span class="regexp">/,</span>
<span class="line">                  "setup_range_conditions": [</span>
<span class="line">                  ] /</span>* setup_range_conditions *<span class="regexp">/,</span>
<span class="line">                  "group_index_range": &#123;</span>
<span class="line">                    "chosen": false,</span>
<span class="line">                    "cause": "not_group_by_or_distinct"</span>
<span class="line">                  &#125; /</span>* group_index_range *<span class="regexp">/,</span>
<span class="line">                  "analyzing_range_alternatives": &#123;</span>
<span class="line">                    "range_scan_alternatives": [</span>
<span class="line">                      &#123;</span>
<span class="line">                        "index": "ind_c2",</span>
<span class="line">                        "ranges": [</span>
<span class="line">                          "b &lt;= c2 &lt;= b"</span>
<span class="line">                        ] /</span>* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 4,</span>
<span class="line">                        "cost": 5.81,</span>
<span class="line">                        "chosen": false,</span>
<span class="line">                        "cause": "cost"</span>
<span class="line">                      &#125;,</span>
<span class="line">                      &#123;</span>
<span class="line">                        "index": "ind_c4",</span>
<span class="line">                        "ranges": [</span>
<span class="line">                          "20 &lt;= c4 &lt;= 20"</span>
<span class="line">                        ] /</span>* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 2,</span>
<span class="line">                        "cost": 3.41,</span>
<span class="line">                        "chosen": true</span>
<span class="line">                      &#125;,</span>
<span class="line">                      &#123;</span>
<span class="line">                        "index": "ind_c2_c4",</span>
<span class="line">                        "ranges": [</span>
<span class="line">                          "b &lt;= c2 &lt;= b AND 20 &lt;= c4 &lt;= 20"</span>
<span class="line">                        ] /</span>* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 2,</span>
<span class="line">                        "cost": 3.41,</span>
<span class="line">                        "chosen": false,</span>
<span class="line">                        "cause": "cost"</span>
<span class="line">                      &#125;</span>
<span class="line">......</span>
<span class="line">                  "chosen_range_access_summary": &#123;</span>
<span class="line">                    "range_access_plan": &#123;</span>
<span class="line">                      "type": "range_scan",</span>
<span class="line">                      "index": "ind_c4",</span>
<span class="line">                      "rows": 2,</span>
<span class="line">                      "ranges": [</span>
<span class="line">                        "20 &lt;= c4 &lt;= 20"</span>
<span class="line">                      ] /</span>* ranges *<span class="regexp">/</span>
<span class="line">                    &#125; /</span>* range_access_plan *<span class="regexp">/,</span>
<span class="line">                    "rows_for_plan": 2,</span>
<span class="line">                    "cost_for_plan": 3.41,</span>
<span class="line">                    "chosen": true</span>
<span class="line">                  &#125; /</span>* chosen_range_access_summary *<span class="regexp">/</span>
<span class="line">                &#125; /</span>* range_analysis *<span class="regexp">/</span>
<span class="line">              &#125;</span>
<span class="line"> ......</span></span>
</pre></td></tr></table></figure></p>
<p>索引ind_c4和ind_c2_c4都是非覆盖扫描，而ind_c4和ind_c2_c4的cost是一样的，mysql会选择叶子块数量较少的那个索引，很明显ind_c4叶子块数量较少。</p>
<p><strong>下面语句为什么又可以走复合索引ind_c2_c4？</strong><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">explain <span class="keyword">select</span> c2,c4 from t1 where c2=<span class="string">'b'</span> <span class="keyword">and</span> c4=<span class="number">20</span>\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">           id: <span class="number">1</span></span>
<span class="line">  select_type: SIMPLE</span>
<span class="line">        table: t1</span>
<span class="line">         type: <span class="keyword">ref</span></span>
<span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span>
<span class="line">          key: ind_c2_c4</span>
<span class="line">      key_len: <span class="number">392</span></span>
<span class="line">          <span class="keyword">ref</span>: const,const</span>
<span class="line">         rows: <span class="number">2</span></span>
<span class="line">        Extra: Using where; Using <span class="keyword">index</span></span>
<span class="line"></span>
<span class="line">set optimizer_trace=<span class="string">'enabled=on'</span>;</span>
<span class="line">set optimizer_trace_max_mem_size=<span class="number">1000000</span>;</span>
<span class="line">set end_markers_in_json=on;</span>
<span class="line"><span class="keyword">select</span> c2,c4 from t1 where c2=<span class="string">'b'</span> <span class="keyword">and</span> c4=<span class="number">20</span>;</span>
<span class="line"><span class="keyword">select</span> * from information_schema.optimizer_trace\G;</span>
<span class="line"></span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">                            QUERY: <span class="keyword">select</span> c2,c4 from t1 where c2=<span class="string">'b'</span> <span class="keyword">and</span> c4=<span class="number">20</span></span>
<span class="line">                            TRACE: &#123;</span>
<span class="line">......</span>
<span class="line">                  <span class="string">"analyzing_range_alternatives"</span>: &#123;</span>
<span class="line">                    <span class="string">"range_scan_alternatives"</span>: [</span>
<span class="line">                      &#123;</span>
<span class="line">                        <span class="string">"index"</span>: <span class="string">"ind_c2"</span>,</span>
<span class="line">                        <span class="string">"ranges"</span>: [</span>
<span class="line">                          <span class="string">"b &lt;= c2 &lt;= b"</span></span>
<span class="line">                        ] /* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 4,</span>
<span class="line">                        "cost": 5.81,</span>
<span class="line">                        "chosen": false,</span>
<span class="line">                        "cause": "cost"</span>
<span class="line">                      &#125;,</span>
<span class="line">                      &#123;</span>
<span class="line">                        "index": "ind_c4",</span>
<span class="line">                        "ranges": [</span>
<span class="line">                          "20 &lt;= c4 &lt;= 20"</span>
<span class="line">                        ] /</span>* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": false,</span>
<span class="line">                        "rows": 2,</span>
<span class="line">                        "cost": 3.41,</span>
<span class="line">                        "chosen": false,</span>
<span class="line">                        "cause": "cost"</span>
<span class="line">                      &#125;,</span>
<span class="line">                      &#123;</span>
<span class="line">                        "index": "ind_c2_c4",</span>
<span class="line">                        "ranges": [</span>
<span class="line">                          "b &lt;= c2 &lt;= b AND 20 &lt;= c4 &lt;= 20"</span>
<span class="line">                        ] /</span>* ranges *<span class="regexp">/,</span>
<span class="line">                        "index_dives_for_eq_ranges": true,</span>
<span class="line">                        "rowid_ordered": true,</span>
<span class="line">                        "using_mrr": false,</span>
<span class="line">                        "index_only": true,    # 索引覆盖扫描</span>
<span class="line">                        "rows": 2,</span>
<span class="line">                        "cost": 3.41,</span>
<span class="line">                        "chosen": false,</span>
<span class="line">                        "cause": "cost"</span>
<span class="line">                      &#125;</span>
<span class="line">                    ] /</span>* range_scan_alternatives *<span class="regexp">/,</span>
<span class="line">                    "analyzing_roworder_intersect": &#123;</span>
<span class="line">                      "intersecting_indices": [</span>
<span class="line">                        &#123;</span>
<span class="line">                          "index": "ind_c2_c4",</span>
<span class="line">                          "index_scan_cost": 1.0476,</span>
<span class="line">                          "cumulated_index_scan_cost": 1.0476,</span>
<span class="line">                          "disk_sweep_cost": 0,</span>
<span class="line">                          "cumulated_total_cost": 1.0476,</span>
<span class="line">                          "usable": true,</span>
<span class="line">                          "matching_rows_now": 2,</span>
<span class="line">                          "isect_covering_with_this_index": true,</span>
<span class="line">                          "chosen": true</span>
<span class="line">                        &#125;</span>
<span class="line">                      ] /</span>* intersecting_indices *<span class="regexp">/,</span>
<span class="line">                      "clustered_pk": &#123;</span>
<span class="line">                        "clustered_pk_added_to_intersect": false,</span>
<span class="line">                        "cause": "no_clustered_pk_index"</span>
<span class="line">                      &#125; /</span>* clustered_pk *<span class="regexp">/,</span>
<span class="line">                      "chosen": false,</span>
<span class="line">                      "cause": "too_few_indexes_to_merge"</span>
<span class="line">                    &#125; /</span>* analyzing_roworder_intersect *<span class="regexp">/</span>
<span class="line">                  &#125; /</span>* analyzing_range_alternatives *<span class="regexp">/</span>
<span class="line">                &#125; /</span>* range_analysis *<span class="regexp">/</span>
<span class="line">              &#125;</span>
<span class="line">            ] /</span>* rows_estimation *<span class="regexp">/</span>
<span class="line">          &#125;,</span>
<span class="line">          &#123;</span>
<span class="line">            "considered_execution_plans": [</span>
<span class="line">              &#123;</span>
<span class="line">                "plan_prefix": [</span>
<span class="line">                ] /</span>* plan_prefix *<span class="regexp">/,</span>
<span class="line">                "table": "`t1`",</span>
<span class="line">                "best_access_path": &#123;</span>
<span class="line">                  "considered_access_paths": [</span>
<span class="line">                    &#123;</span>
<span class="line">                      "access_type": "ref",</span>
<span class="line">                      "index": "ind_c2",</span>
<span class="line">                      "rows": 4,</span>
<span class="line">                      "cost": 2.8,</span>
<span class="line">                      "chosen": true</span>
<span class="line">                    &#125;,</span>
<span class="line">                    &#123;</span>
<span class="line">                      "access_type": "ref",</span>
<span class="line">                      "index": "ind_c4",</span>
<span class="line">                      "rows": 2,</span>
<span class="line">                      "cost": 2.4,</span>
<span class="line">                      "chosen": true</span>
<span class="line">                    &#125;,</span>
<span class="line">                    &#123;</span>
<span class="line">                      "access_type": "ref",</span>
<span class="line">                      "index": "ind_c2_c4",</span>
<span class="line">                      "rows": 2,</span>
<span class="line">                      "cost": 1.4476,</span>
<span class="line">                      "chosen": true</span>
<span class="line">                    &#125;,</span>
<span class="line">                    &#123;</span>
<span class="line">                      "access_type": "scan",</span>
<span class="line">                      "cause": "covering_index_better_than_full_scan",  </span>
<span class="line">                      "chosen": false</span>
<span class="line">                    &#125;</span>
<span class="line">                  ] /</span>* considered_access_paths *<span class="regexp">/</span>
<span class="line">                &#125; /</span>* best_access_path *<span class="regexp">/,</span>
<span class="line">                "cost_for_plan": 1.4476,</span>
<span class="line">                "rows_for_plan": 2,</span>
<span class="line">                "chosen": true</span>
<span class="line">              &#125;</span>
<span class="line">......</span></span>
</pre></td></tr></table></figure></p>
<p>因为语中ind_c2_c4是索引覆盖扫描，不需要回表，代价较小。</p>
<h3 id="查看索引元数据持久化"><a href="#查看索引元数据持久化" class="headerlink" title="查看索引元数据持久化"></a>查看索引元数据持久化</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * from mysql.innodb_table_stats where table_name=<span class="string">'t1'</span>;</span>
<span class="line">+---------------+------------+---------------------+--------+----------------------+--------------------------+</span>
<span class="line">| database_name | table_name | last_update         | n_rows | clustered_index_size | sum_of_other_index_sizes |</span>
<span class="line">+---------------+------------+---------------------+--------+----------------------+--------------------------+</span>
<span class="line">| lyj           | t1         | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">16</span>:<span class="number">39</span>:<span class="number">48</span> |      <span class="number">7</span> |                    <span class="number">1</span> |                        <span class="number">2</span> |</span>
<span class="line">+---------------+------------+---------------------+--------+----------------------+--------------------------+</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from mysql.innodb_index_stats where table_name=<span class="string">'t1'</span>;</span>
<span class="line">+---------------+------------+------------+---------------------+--------------+------------+-------------+-----------------------------------+</span>
<span class="line">| database_name | table_name | index_name | last_update         | stat_name    | stat_value | sample_size | stat_description                  |</span>
<span class="line">+---------------+------------+------------+---------------------+--------------+------------+-------------+-----------------------------------+</span>
<span class="line">| lyj           | t1         | PRIMARY    | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | n_diff_pfx01 |          <span class="number">7</span> |           <span class="number">1</span> | c1                                |</span>
<span class="line">| lyj           | t1         | PRIMARY    | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | n_leaf_pages |          <span class="number">1</span> |        NULL | Number of leaf pages in the <span class="keyword">index</span> |</span>
<span class="line">| lyj           | t1         | PRIMARY    | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | size         |          <span class="number">1</span> |        NULL | Number of pages in the <span class="keyword">index</span>      |</span>
<span class="line">| lyj           | t1         | ind_c2     | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | n_diff_pfx01 |          <span class="number">4</span> |           <span class="number">1</span> | c2                                |</span>
<span class="line">| lyj           | t1         | ind_c2     | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | n_diff_pfx02 |          <span class="number">7</span> |           <span class="number">1</span> | c2,c1                             |</span>
<span class="line">| lyj           | t1         | ind_c2     | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | n_leaf_pages |          <span class="number">1</span> |        NULL | Number of leaf pages in the <span class="keyword">index</span> |</span>
<span class="line">| lyj           | t1         | ind_c2     | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | size         |          <span class="number">1</span> |        NULL | Number of pages in the <span class="keyword">index</span>      |</span>
<span class="line">| lyj           | t1         | ind_c2_c4  | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">16</span>:<span class="number">39</span>:<span class="number">48</span> | n_diff_pfx01 |          <span class="number">4</span> |           <span class="number">1</span> | c2                                |</span>
<span class="line">| lyj           | t1         | ind_c2_c4  | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">16</span>:<span class="number">39</span>:<span class="number">48</span> | n_diff_pfx02 |          <span class="number">6</span> |           <span class="number">1</span> | c2,c4                             |</span>
<span class="line">| lyj           | t1         | ind_c2_c4  | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">16</span>:<span class="number">39</span>:<span class="number">48</span> | n_diff_pfx03 |          <span class="number">7</span> |           <span class="number">1</span> | c2,c4,c1                          |</span>
<span class="line">| lyj           | t1         | ind_c2_c4  | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">16</span>:<span class="number">39</span>:<span class="number">48</span> | n_leaf_pages |          <span class="number">1</span> |        NULL | Number of leaf pages in the <span class="keyword">index</span> |</span>
<span class="line">| lyj           | t1         | ind_c2_c4  | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">16</span>:<span class="number">39</span>:<span class="number">48</span> | size         |          <span class="number">1</span> |        NULL | Number of pages in the <span class="keyword">index</span>      |</span>
<span class="line">| lyj           | t1         | ind_c4     | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | n_diff_pfx01 |          <span class="number">6</span> |           <span class="number">1</span> | c4                                |</span>
<span class="line">| lyj           | t1         | ind_c4     | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | n_diff_pfx02 |          <span class="number">7</span> |           <span class="number">1</span> | c4,c1                             |</span>
<span class="line">| lyj           | t1         | ind_c4     | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | n_leaf_pages |          <span class="number">1</span> |        NULL | Number of leaf pages in the <span class="keyword">index</span> |</span>
<span class="line">| lyj           | t1         | ind_c4     | <span class="number">2017</span>-<span class="number">10</span>-<span class="number">24</span> <span class="number">15</span>:<span class="number">17</span>:<span class="number">27</span> | size         |          <span class="number">1</span> |        NULL | Number of pages in the <span class="keyword">index</span>      |</span>
<span class="line">+---------------+------------+------------+---------------------+--------------+------------+-------------+-----------------------------------+</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[flashback常用命令整理]]></title>
      <url>/2017/10/19/oracle/flashback%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="flashback常用命令整理"><a href="#flashback常用命令整理" class="headerlink" title="flashback常用命令整理"></a>flashback常用命令整理</h2><h3 id="打开数据库闪回"><a href="#打开数据库闪回" class="headerlink" title="打开数据库闪回"></a>打开数据库闪回</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> name,open_mode,log_mode,force_logging,flashback_on from v$database;</span>
<span class="line"></span>
<span class="line">NAME      OPEN_MODE            LOG_MODE     FOR FLASHBACK_ON</span>
<span class="line">--------- -------------------- ------------ --- ------------------</span>
<span class="line">ORCL      READ WRITE           ARCHIVELOG   NO  NO</span>
<span class="line"></span>
<span class="line">SQL&gt; archive <span class="keyword">log</span> list;</span>
<span class="line">Database <span class="keyword">log</span> mode              Archive Mode</span>
<span class="line">Automatic archival             Enabled</span>
<span class="line">Archive destination            /u01/app/arch/</span>
<span class="line">Oldest online <span class="keyword">log</span> sequence     <span class="number">246</span></span>
<span class="line">Next <span class="keyword">log</span> sequence to archive   <span class="number">249</span></span>
<span class="line">Current <span class="keyword">log</span> sequence           <span class="number">249</span></span>
<span class="line"></span>
<span class="line">SQL&gt; show parameter recovery</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">db_recovery_file_dest                string</span>
<span class="line">db_recovery_file_dest_size           big integer <span class="number">0</span></span>
<span class="line">recovery_parallelism                 integer     <span class="number">0</span></span>
<span class="line"></span>
<span class="line">alter <span class="keyword">system</span> set log_archive_dest=<span class="string">''</span>;</span>
<span class="line">alter <span class="keyword">system</span> set db_recovery_file_dest_size=<span class="number">10</span>g;</span>
<span class="line">alter <span class="keyword">system</span> set db_recovery_file_dest=<span class="string">'/u01/app/fra'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 2880单位是分钟minutes</span></span>
<span class="line">alter <span class="keyword">system</span> set db_flashback_retention_target=<span class="number">2880</span>;</span>
<span class="line"></span>
<span class="line">alter database flashback on;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="数据库的闪回"><a href="#数据库的闪回" class="headerlink" title="数据库的闪回"></a>数据库的闪回</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基于SCN的闪回</span></span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line">startup</span>
<span class="line">flashback database to scn <span class="number">5303782</span>;</span>
<span class="line">alter database <span class="keyword">open</span> resetlogs;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 基于时间闪回</span></span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line">startup</span>
<span class="line">flashback database to timestamp to_timestamp(<span class="string">'2017-10-20 10:09:56'</span>,<span class="string">'yyyy-mm-dd hh24:mi:ss'</span>);</span>
<span class="line">alter database <span class="keyword">open</span> resetlogs;</span>
</pre></td></tr></table></figure>
<h3 id="删除表的闪回"><a href="#删除表的闪回" class="headerlink" title="删除表的闪回"></a>删除表的闪回</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn lyj/lyj</span>
<span class="line">drop table flashback_test;</span>
<span class="line"></span>
<span class="line">show recyclebin;</span>
<span class="line">ORIGINAL NAME    RECYCLEBIN NAME                OBJECT TYPE  DROP TIME</span>
<span class="line">---------------- ------------------------------ ------------ -------------------</span>
<span class="line">FLASHBACK_TEST   BIN$W/KZ5pudF7bgU24D9QoueQ==$0 TABLE        <span class="number">2017</span>-<span class="number">10</span>-<span class="number">20</span>:<span class="number">10</span>:<span class="number">55</span>:<span class="number">11</span></span>
<span class="line"></span>
<span class="line">flashback table FLASHBACK_TEST to before drop;</span>
</pre></td></tr></table></figure>
<h3 id="DML操作的闪回"><a href="#DML操作的闪回" class="headerlink" title="DML操作的闪回"></a>DML操作的闪回</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 根据时间确定SCN号</span></span>
<span class="line"><span class="keyword">select</span> timestamp_to_scn(to_date(<span class="string">'2017-10-20 11:23:44'</span>,<span class="string">'yyyy-mm-dd hh24:mi:ss'</span>)) scn from dual;</span>
<span class="line">alter table flashback_test enable row movement;</span>
<span class="line">flashback table flashback_test to scn <span class="number">5305382</span>;</span>
</pre></td></tr></table></figure>
<h3 id="查询的闪回"><a href="#查询的闪回" class="headerlink" title="查询的闪回"></a>查询的闪回</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基于时间的闪回查询（5分钟前）</span></span>
<span class="line"><span class="keyword">select</span> count(*) from flashback_test as of timestamp sysdate-<span class="number">5</span>/<span class="number">1440</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 基于SCN号的闪回查询</span></span>
<span class="line"><span class="keyword">select</span> count(*) from flashback_test as of scn <span class="number">5305382</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 闪回查询时间设置参数，单位是秒 10800s=3小时间</span></span>
<span class="line">alter <span class="keyword">system</span> set undo_retention=<span class="number">10800</span>;</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> 常用命令与脚本 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> flashback </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[RMAN (Recovery Manager) 常用命令整理]]></title>
      <url>/2017/10/19/oracle/RMAN%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="RMAN核心文件"><a href="#RMAN核心文件" class="headerlink" title="RMAN核心文件"></a>RMAN核心文件</h2><p>RMAN的核心文件：recover.bsq (dbms_rcvman dbms_backup_restore)<br>所在位置：$ORACLE_HOME/rdbms/admin/recover.bsq</p>
<a id="more"></a>
<h2 id="RMAN常用命令"><a href="#RMAN常用命令" class="headerlink" title="RMAN常用命令"></a>RMAN常用命令</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rman target /</span>
<span class="line">show all;</span>
<span class="line">configure retention policy to redundancy <span class="number">1</span>;</span>
<span class="line">configure retention policy to recovery window of <span class="number">3</span> days;</span>
<span class="line">configure retention policy clear;</span>
<span class="line">configure controlfile autobackup on;</span>
<span class="line">configure default device type to disk;</span>
<span class="line">configure channel device type disk maxpiecesize <span class="number">50</span>M;</span>
<span class="line">configure channel <span class="number">1</span> device type disk maxpiecesize <span class="number">100</span>M <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/full_bak_%U'</span>;</span>
<span class="line">configure channel <span class="number">2</span> device type disk maxpiecesize <span class="number">100</span>M <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/full_bak_%U'</span>;</span>
<span class="line">configure channel <span class="number">3</span> device type disk maxpiecesize <span class="number">100</span>M <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/full_bak_%U'</span>;</span>
<span class="line">configure channel <span class="number">4</span> device type disk maxpiecesize <span class="number">100</span>M <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/full_bak_%U'</span>;</span>
<span class="line">configure device type disk parallelism <span class="number">4</span> backup type to compressed backupset;</span>
<span class="line"></span>
<span class="line">show device type;</span>
<span class="line">show default device type;</span>
<span class="line"></span>
<span class="line">list backup;</span>
<span class="line">list expired backup;</span>
<span class="line">list backup of spfile;</span>
<span class="line">list backup of controlfile;</span>
<span class="line">list backup of tablespace users;</span>
<span class="line">list backup of datafile <span class="number">1</span>;</span>
<span class="line">list backup of archivelog all;</span>
<span class="line"></span>
<span class="line">crosscheck copy;</span>
<span class="line">crosscheck backup;</span>
<span class="line">crosscheck archivelog all;</span>
<span class="line"><span class="keyword">delete</span> noprompt expired copy;</span>
<span class="line"><span class="keyword">delete</span> noprompt expired backup;</span>
<span class="line"><span class="keyword">delete</span> noprompt expired archivelog all;</span>
<span class="line">report obsolete;</span>
<span class="line"><span class="keyword">delete</span> noprompt obsolete;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">report schema;</span>
<span class="line">report need backup days <span class="number">3</span>;</span>
<span class="line">report need backup;</span>
<span class="line">report obsolete;</span>
<span class="line"></span>
<span class="line">backup database;</span>
<span class="line">backup database plus archivelog skip inaccessible <span class="keyword">delete</span> input;</span>
<span class="line">backup incremental level=<span class="number">0</span> database;</span>
<span class="line">backup incremental level=<span class="number">1</span> database;</span>
<span class="line">backup incremental level=<span class="number">2</span> database;</span>
<span class="line"></span>
<span class="line"><span class="keyword">delete</span> backupset <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>;</span>
<span class="line"></span>
<span class="line">restore database;</span>
<span class="line">restore tablespace users;</span>
<span class="line">restore datafile <span class="number">1</span>;</span>
<span class="line">restore controlfile from autobackup;</span>
<span class="line"></span>
<span class="line">recover database;</span>
<span class="line">recover tablespace users;</span>
<span class="line">recover datafile <span class="number">1</span>;</span>
<span class="line">recover database <span class="keyword">until</span> sequence <span class="number">8</span>;</span>
<span class="line">recover database <span class="keyword">until</span> scn <span class="number">1812584</span>;</span>
<span class="line"></span>
<span class="line">run&#123;</span>
<span class="line">    set <span class="keyword">until</span> <span class="keyword">time</span> <span class="string">"to_date('2016-08-29 11:15:22','YYYY-MM-DD HH24:MI:SS')"</span>;</span>
<span class="line">    restore database;</span>
<span class="line">    recover database;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">run&#123;</span>
<span class="line">    set <span class="keyword">until</span> sequence <span class="number">9</span>;</span>
<span class="line">    recover database;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 示例</span></span>
<span class="line">startup nomount</span>
<span class="line">restore controlfile from <span class="string">'xxxx'</span>;</span>
<span class="line">alter database mount;</span>
<span class="line">catalog start with <span class="string">'xxxxx'</span>;</span>
<span class="line">restore database;</span>
<span class="line"></span>
<span class="line">run &#123;</span>
<span class="line">allocate channel c1 type disk;</span>
<span class="line">allocate channel c2 type disk;</span>
<span class="line">allocate channel c3 type disk;</span>
<span class="line">allocate channel c4 type disk;</span>
<span class="line">backup as compressed backupset</span>
<span class="line">    skip inaccessible</span>
<span class="line">    tag db_bak</span>
<span class="line">    filesperset <span class="number">4</span></span>
<span class="line">    <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/bak_%d_%T_%s_%U'</span></span>
<span class="line">    database;</span>
<span class="line">    sql <span class="string">'alter system archive log current'</span>;</span>
<span class="line">release channel c1;</span>
<span class="line">release channel c2;</span>
<span class="line">release channel c3;</span>
<span class="line">release channel c4;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">run &#123;</span>
<span class="line">allocate channel c1 type disk;</span>
<span class="line">allocate channel c2 type disk;</span>
<span class="line">allocate channel c3 type disk;</span>
<span class="line">allocate channel c4 type disk;</span>
<span class="line">backup as compressed backupset</span>
<span class="line">    tag arc_bak</span>
<span class="line">    <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/arc_%d_%T_%s_%U'</span></span>
<span class="line">    archivelog all <span class="keyword">delete</span> input;</span>
<span class="line">release channel c1;</span>
<span class="line">release channel c2;</span>
<span class="line">release channel c3;</span>
<span class="line">release channel c4;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="RMAN相关概念与脚本"><a href="#RMAN相关概念与脚本" class="headerlink" title="RMAN相关概念与脚本"></a>RMAN相关概念与脚本</h2><h3 id="SCN：System-Change-Number-数据库对自身变化的一个标记"><a href="#SCN：System-Change-Number-数据库对自身变化的一个标记" class="headerlink" title="SCN：System Change Number 数据库对自身变化的一个标记"></a>SCN：System Change Number 数据库对自身变化的一个标记</h3><ul>
<li>系统级 (v$database checkpoint_change#)</li>
<li>数据文件级/结束SCN (v$datafile file#, checkpoint_change#, last_change#)</li>
<li>数据文件头部 (v$datafile_header file#, checkpoint_change#)<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> checkpoint_change<span class="comment"># from v$database;</span></span>
<span class="line"><span class="keyword">select</span> file<span class="comment">#, checkpoint_change#, last_change# from v$datafile;</span></span>
<span class="line"><span class="keyword">select</span> file<span class="comment">#, checkpoint_change# from v$datafile_header;</span></span>
<span class="line">alter <span class="keyword">system</span> checkpoint;</span>
</pre></td></tr></table></figure>
</li>
</ul>
<h3 id="查看autobackup-controlfile延迟时间隐藏参数脚本"><a href="#查看autobackup-controlfile延迟时间隐藏参数脚本" class="headerlink" title="查看autobackup controlfile延迟时间隐藏参数脚本"></a>查看autobackup controlfile延迟时间隐藏参数脚本</h3><p>正常情况下，建议RMAN中设置<code>CONFIGURE CONTROLFILE AUTOBACKUP ON</code>，这样在增加删除表空间等数据库维护操作时，做备份时，会自动建立控制文件与spfile文件的备份。在维护数据库增加数据文件时，并不会马上做控制文件的自动备份，实际上有一些小小延迟，延迟时间受参数<code>_controlfile_autobackup_delay</code>的控制，这样的目地在于如果增加很多数据文件，频繁备份并不是非常必要，适当延迟可以避免频繁备份控制文件。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set pagesize <span class="number">9999</span></span>
<span class="line">set line <span class="number">180</span></span>
<span class="line">col name <span class="keyword">for</span> a45</span>
<span class="line">col value <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">col description <span class="keyword">for</span> a7<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> a.ksppinm name, b.ksppstvl value, a.ksppdesc description</span>
<span class="line">    from <span class="keyword">x</span>$ksppi a, <span class="keyword">x</span>$ksppcv b</span>
<span class="line">    where a.indx = b.indx <span class="keyword">and</span> a.ksppinm like <span class="string">'%control%delay'</span>;</span>
</pre></td></tr></table></figure></p>
<h3 id="开启归档模式"><a href="#开启归档模式" class="headerlink" title="开启归档模式"></a>开启归档模式</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">archive <span class="keyword">log</span> list</span>
<span class="line"><span class="keyword">select</span> log_mode from v$database;</span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line">startup mount</span>
<span class="line">alter database archivelog;</span>
<span class="line">alter database noarchivelog;</span>
<span class="line">alter database <span class="keyword">open</span>;</span>
<span class="line">show parameter archive</span>
<span class="line">show parameter recovery</span>
<span class="line">alter <span class="keyword">system</span> set log_archive_dest=<span class="string">'/oradata/archivelog'</span>;</span>
<span class="line">alter <span class="keyword">system</span> set log_archive_format=<span class="string">'arch_%t_%s_%r.arc'</span> scope=spfile;</span>
<span class="line"><span class="keyword">select</span> group<span class="comment">#,sequence#,members,status from v$log;</span></span>
<span class="line">alter <span class="keyword">system</span> switch logfile;</span>
<span class="line">alter <span class="keyword">system</span> checkpoint;</span>
</pre></td></tr></table></figure>
<h3 id="控制文件和参数文件的备份"><a href="#控制文件和参数文件的备份" class="headerlink" title="控制文件和参数文件的备份"></a>控制文件和参数文件的备份</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter database backup controlfile to <span class="string">'/tmp/control_bak.ctl'</span>;</span>
<span class="line">alter database backup controlfile to trace;</span>
<span class="line"><span class="comment"># 通过以下命令能查看trace位置</span></span>
<span class="line"><span class="keyword">select</span> * from v$diag_info where NAME=<span class="string">'Default Trace File'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 通过trace里脚本重建的控制文件，还需要手工修改temp表空间(表空间存在，数据文件实际存在，但没有被映射，以下脚本是进行复用)</span></span>
<span class="line"><span class="keyword">select</span> NAME from v$tempfile;</span>
<span class="line">col FILE_NAME <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">col TABLESPACE_NAME <span class="keyword">for</span> a1<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> FILE_NAME,TABLESPACE_NAME from dba_temp_files;</span>
<span class="line">alter tablespace temp add tempfile <span class="string">'/u01/app/oracle/oradata/orcl/temp01.dbf'</span> size <span class="number">20</span>M reuse;</span>
<span class="line">show parameter control</span>
<span class="line"></span>
<span class="line">create pfile=<span class="string">'/tmp/pfile.ora'</span> from spfile;</span>
</pre></td></tr></table></figure>
<h3 id="Block-change-track"><a href="#Block-change-track" class="headerlink" title="Block change track"></a>Block change track</h3><p><code>Block change track</code>是Oracle块修改跟踪，会记录<code>data file</code>里每个block的update信息，这些tracking信息保存在tracking文件里。<br>当启动<code>block change tracking</code>后，RMAN使用<code>trackingfile</code>里的信息，只读取改变的block信息，而不用在对整个data file进行扫描，从而提高了RMAN 备份的性能。启用/禁用的方法如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter database enable block change tracking using file <span class="string">'/u01/app/oracle/change_tracking'</span>;</span>
<span class="line">alter database disable block change tracking;</span>
</pre></td></tr></table></figure></p>
<h3 id="修改隐含参数，极端情况下恢复数据"><a href="#修改隐含参数，极端情况下恢复数据" class="headerlink" title="修改隐含参数，极端情况下恢复数据"></a>修改隐含参数，极端情况下恢复数据</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter <span class="keyword">system</span> set <span class="string">"_allow_resetlogs_corruption"</span>=true scope=spfile;</span>
<span class="line">alter <span class="keyword">system</span> set <span class="string">"_corrupted_rollback_segments"</span>=true scope=spfile;</span>
<span class="line">alter <span class="keyword">system</span> set <span class="string">"_offline_rollback_segments"</span>=true scope=spfile;</span>
<span class="line"></span>
<span class="line">alter <span class="keyword">system</span> set <span class="string">"_allow_resetlogs_corruption"</span>=false scope=spfile;</span>
<span class="line">alter <span class="keyword">system</span> set <span class="string">"_corrupted_rollback_segments"</span>=false scope=spfile;</span>
<span class="line">alter <span class="keyword">system</span> set <span class="string">"_offline_rollback_segments"</span>=false scope=spfile;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置"_allow_resetlogs_corruption"=true，在数据库Open过程中，Oracle会跳过某些一致性检查，从而使数据库可能跳过不一致状态</span></span>
<span class="line"><span class="comment"># 设置"_corrupted_rollback_segments"=true，以使数据库在启动的时候忽略损坏的回滚段，使数据库正常启动</span></span>
<span class="line"><span class="comment"># 设置"_offline_rollback_segments"=true，可以让指定的回滚段处于OFFLINE状态，从而达到和设置"_corrupted_rollback_segments"=true 一样的效果，两个参数可以配合使用.</span></span>
</pre></td></tr></table></figure>
<h3 id="热备"><a href="#热备" class="headerlink" title="热备"></a>热备</h3><ul>
<li>存在Split blocks 分离数据块的问题</li>
<li>启动热备保护，解决Split blocks问题，方法如下<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter tablespace xxxxx begin backup;</span>
<span class="line">执行热备 ( cp scp ftp -&gt; datafile )</span>
<span class="line">alter tablespace xxxxx end backup;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 生成热备所需批量脚本</span></span>
<span class="line"><span class="keyword">select</span> <span class="string">'alter tablespace '</span> || tablespace_name || <span class="string">' begin backup;'</span> from dba_tablespaces where CONTENTS &lt;&gt; <span class="string">'TEMPORARY'</span>;</span>
<span class="line"><span class="keyword">select</span> <span class="string">'alter tablespace '</span> || tablespace_name || <span class="string">' end backup;'</span> from dba_tablespaces where CONTENTS &lt;&gt; <span class="string">'TEMPORARY'</span>;</span>
</pre></td></tr></table></figure>
</li>
</ul>
<h3 id="查看数据中所有文件和总大小脚本"><a href="#查看数据中所有文件和总大小脚本" class="headerlink" title="查看数据中所有文件和总大小脚本"></a>查看数据中所有文件和总大小脚本</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> name from v$datafile</span>
<span class="line">union</span>
<span class="line"><span class="keyword">select</span> name from v$controlfile</span>
<span class="line">union</span>
<span class="line"><span class="keyword">select</span> name from v$tempfile</span>
<span class="line">union</span>
<span class="line"><span class="keyword">select</span> member from v$logfile;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> sum(sum_bytes)/<span class="number">1024</span>/<span class="number">1024</span> m_bytes</span>
<span class="line">from (</span>
<span class="line">    <span class="keyword">select</span> sum(bytes) sum_bytes from v$datafile</span>
<span class="line">    union</span>
<span class="line">    <span class="keyword">select</span> sum(bytes) sum_bytes from v$tempfile</span>
<span class="line">    union</span>
<span class="line">    <span class="keyword">select</span> (sum(bytes) * members) sum_bytes from v$log</span>
<span class="line">    group by members);</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> 常用命令与脚本 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> rman </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 08 SQL EXPLAIN解析]]></title>
      <url>/2017/10/17/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/08-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="什么是归并排序？"><a href="#什么是归并排序？" class="headerlink" title="什么是归并排序？"></a>什么是归并排序？</h2><p>如果需要排序的数据超过了sort_buffer_size的大小，说明无法在内存中完成排序，就需要写到临时文件中。若排序中产生了临时文件，需要利用归并排序算法保证临时文件中的记录是有序的。归并排序算法是分批将数据放到文件中进行排序，然后逐一按序合并。<br>简单来说是把在内存中无法直接排序的数据进行分批，每批已排序的结果分别放到文件中。用每个已排序的文件中第一行数据做进行比较，取出最小的值放到最终的合并排序文件中。重复以上操作，直到所有文件文件数据都放到合并排序文件中。<br><a id="more"></a></p>
<h2 id="执行计划中Using-temporary与using-filesort的区别？"><a href="#执行计划中Using-temporary与using-filesort的区别？" class="headerlink" title="执行计划中Using temporary与using filesort的区别？"></a>执行计划中Using temporary与using filesort的区别？</h2><p>Using temporary：表示MySQL需要使用临时表来存储结果集，常见于排序和分组查询。<br>Using filesort：MySQL中无法利用索引完成的排序操作称为“文件排序”，Using filesort只能在一张表中进行<br>示例：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain</span>
<span class="line">    -&gt; <span class="keyword">select</span> id from sbtest1</span>
<span class="line">    -&gt; union</span>
<span class="line">    -&gt; <span class="keyword">select</span> id from sbtest2</span>
<span class="line">    -&gt; order by id;</span>
<span class="line">+----+--------------+------------+-------+---------------+------+---------+------+--------+---------------------------------+</span>
<span class="line">| id | select_type  | table      | type  | possible_keys | key  | key_len | <span class="keyword">ref</span>  | rows   | Extra                           |</span>
<span class="line">+----+--------------+------------+-------+---------------+------+---------+------+--------+---------------------------------+</span>
<span class="line">|  <span class="number">1</span> | PRIMARY      | sbtest1    | <span class="keyword">index</span> | NULL          | k_1  | <span class="number">4</span>       | NULL | <span class="number">986400</span> | Using <span class="keyword">index</span>                     |</span>
<span class="line">|  <span class="number">2</span> | UNION        | sbtest2    | <span class="keyword">index</span> | NULL          | k_2  | <span class="number">4</span>       | NULL | <span class="number">986400</span> | Using <span class="keyword">index</span>                     |</span>
<span class="line">| NULL | UNION RESULT | &lt;union1,<span class="number">2</span>&gt; | ALL   | NULL          | NULL | NULL    | NULL |   NULL | Using temporary; Using filesort |</span>
<span class="line">+----+--------------+------------+-------+---------------+------+---------+------+--------+---------------------------------+</span>
<span class="line"><span class="comment"># Using temporary：表示使用临时表，将sbtest1和sbtest2数据放到临时表中</span></span>
<span class="line"><span class="comment"># Using filesort：表示将这个临时表进行排序，因Using filesort只能在一张表中进行，所以需要把数据汇总到临时表中，然后再进行排序</span></span>
</pre></td></tr></table></figure></p>
<h2 id="表中只有一条数据，为什么在执行计划中也会有using-filesort？（实验测试）"><a href="#表中只有一条数据，为什么在执行计划中也会有using-filesort？（实验测试）" class="headerlink" title="表中只有一条数据，为什么在执行计划中也会有using filesort？（实验测试）"></a>表中只有一条数据，为什么在执行计划中也会有using filesort？（实验测试）</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> * from test;</span>
<span class="line">+----+------+------+</span>
<span class="line">| id | name | dept |</span>
<span class="line">+----+------+------+</span>
<span class="line">|  <span class="number">1</span> | lyj  | dnb  |</span>
<span class="line">+----+------+------+</span>
<span class="line"></span>
<span class="line">mysql&gt; show create table test\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">       Table: test</span>
<span class="line">Create Table: CREATE TABLE <span class="string">`test`</span> (</span>
<span class="line">  <span class="string">`id`</span> <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL DEFAULT <span class="string">'0'</span>,</span>
<span class="line">  <span class="string">`name`</span> varchar(<span class="number">30</span>) DEFAULT NULL,</span>
<span class="line">  <span class="string">`dept`</span> varchar(<span class="number">30</span>) DEFAULT NULL,</span>
<span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span>
<span class="line">  KEY <span class="string">`name`</span> (<span class="string">`name`</span>)</span>
<span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; explain <span class="keyword">select</span> * from test order by name;</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span>
<span class="line">| id | select_type | table | type | possible_keys | key  | key_len | <span class="keyword">ref</span>  | rows | Extra          |</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | test  | ALL  | NULL          | NULL | NULL    | NULL |    <span class="number">1</span> | Using filesort |</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+------+------+----------------+</span>
</pre></td></tr></table></figure>
<p>filesort表示MySQL需要进行实际的排序操作，而不能通过索引获得已排序数据。</p>
<p>实际上，只要一条 SQL 语句需要进行排序操作，都会显示“Using filesort”，这并不表示就会有文件排序操作。</p>
<h2 id="explain执行计划包含的信息"><a href="#explain执行计划包含的信息" class="headerlink" title="explain执行计划包含的信息"></a>explain执行计划包含的信息</h2><h3 id="id：执行顺序"><a href="#id：执行顺序" class="headerlink" title="id：执行顺序"></a>id：执行顺序</h3><ul>
<li>id相同，执行顺序由上至下</li>
<li>子查询id的序号会递增，id值越大优先级越高，越先被执行</li>
</ul>
<h3 id="select-type：查询类型"><a href="#select-type：查询类型" class="headerlink" title="select _type：查询类型"></a>select _type：查询类型</h3><ol>
<li>SIMPLE：查询中不包含子查询或者UNION</li>
<li>查询中若包含任何复杂的子部分，最外层查询则被标记为：PRIMARY</li>
<li>在SELECT或WHERE列表中包含了子查询，该子查询被标记为：SUBQUERY</li>
<li>在FROM列表中包含的子查询被标记为：DERIVED（衍生）</li>
<li>若第二个SELECT出现在UNION之后，则被标记为UNION；若UNION包含在FROM子句的子查询中，外层SELECT将被标记为：DERIVED</li>
<li>从UNION表获取结果的SELECT被标记为：UNION RESULT</li>
</ol>
<h3 id="table：表"><a href="#table：表" class="headerlink" title="table：表"></a>table：表</h3><ul>
<li>每个执行步骤执行时引用的表</li>
<li>derivedN–有时不是真实的表名字,看到的是derivedN(N是id值,指第几步执行的结果)</li>
<li>unionM,N(行记录引用的UNIO连接的多个ID值)</li>
</ul>
<h3 id="type：搜索类型"><a href="#type：搜索类型" class="headerlink" title="type：搜索类型"></a>type：搜索类型</h3><p>表示MySQL在表中找到所需行的方式，又称“访问类型”，常见类型如下：</p>
<ul>
<li>ALL(全表)：Full Table Scan，MySQL将遍历全表以找到匹配的行</li>
<li>index(索引扫描)：Full Index Scan，index与ALL区别为index类型只遍历索引树</li>
<li>range(范围扫描)：索引范围扫描，对索引的扫描开始于某一点，返回匹配值域的行，常见于between、&lt;、&gt;等的查询</li>
<li>ref(关联/参考)：非唯一性索引扫描，返回匹配某个单独值的所有行。常见于使用非唯一索引即唯一索引的非唯一前缀进行的查找</li>
<li>eq_ref(等值关联/参考)：唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配。常见于主键或唯一索引扫描</li>
<li>const, system(常量)：当MySQL对查询某部分进行优化，并转换为一个常量时，使用这些类型访问。如将主键置于where列表中，MySQL就能将该查询转换为一个常量</li>
<li>NULL(空)：MySQL在优化过程中分解语句，执行时甚至不用访问表或索引</li>
</ul>
<p>由上至下，响应时间(RT)由最差到最好,through output不一定</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain <span class="keyword">select</span> id,c,pad from sbtest1 where pad=<span class="string">''</span>;</span>
<span class="line">+----+-------------+---------+------+---------------+------+---------+------+--------+-------------+</span>
<span class="line">| id | select_type | table   | type | possible_keys | key  | key_len | <span class="keyword">ref</span>  | rows   | Extra       |</span>
<span class="line">+----+-------------+---------+------+---------------+------+---------+------+--------+-------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | sbtest1 | ALL  | NULL          | NULL | NULL    | NULL | <span class="number">986400</span> | Using where |</span>
<span class="line">+----+-------------+---------+------+---------------+------+---------+------+--------+-------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; explain <span class="keyword">select</span> count(*) from sbtest1;</span>
<span class="line">+----+-------------+---------+-------+---------------+------+---------+------+--------+-------------+</span>
<span class="line">| id | select_type | table   | type  | possible_keys | key  | key_len | <span class="keyword">ref</span>  | rows   | Extra       |</span>
<span class="line">+----+-------------+---------+-------+---------------+------+---------+------+--------+-------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | sbtest1 | <span class="keyword">index</span> | NULL          | k_1  | <span class="number">4</span>       | NULL | <span class="number">986400</span> | Using <span class="keyword">index</span> |</span>
<span class="line">+----+-------------+---------+-------+---------------+------+---------+------+--------+-------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; explain <span class="keyword">select</span> id,c,pad from sbtest1 where id between <span class="number">50</span> <span class="keyword">and</span> <span class="number">100</span>;</span>
<span class="line">+----+-------------+---------+-------+---------------+---------+---------+------+------+-------------+</span>
<span class="line">| id | select_type | table   | type  | possible_keys | key     | key_len | <span class="keyword">ref</span>  | rows | Extra       |</span>
<span class="line">+----+-------------+---------+-------+---------------+---------+---------+------+------+-------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | sbtest1 | range | PRIMARY       | PRIMARY | <span class="number">4</span>       | NULL |   <span class="number">51</span> | Using where |</span>
<span class="line">+----+-------------+---------+-------+---------------+---------+---------+------+------+-------------+</span>
<span class="line"></span>
<span class="line">mysql&gt;  explain <span class="keyword">select</span> * from test where dept=<span class="string">'zb'</span>;</span>
<span class="line">+----+-------------+-------+------+----------------+----------------+---------+-------+------+--------------------------+</span>
<span class="line">| id | select_type | table | type | possible_keys  | key            | key_len | <span class="keyword">ref</span>   | rows | Extra                    |</span>
<span class="line">+----+-------------+-------+------+----------------+----------------+---------+-------+------+--------------------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | test  | <span class="keyword">ref</span>  | test_dept_name | test_dept_name | <span class="number">93</span>      | const |    <span class="number">5</span> | Using where; Using <span class="keyword">index</span> |</span>
<span class="line">+----+-------------+-------+------+----------------+----------------+---------+-------+------+--------------------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; explain <span class="keyword">select</span> * from (<span class="keyword">select</span> * from test where id=<span class="number">1</span>) d1;</span>
<span class="line">+----+-------------+------------+--------+---------------+---------+---------+-------+------+-------+</span>
<span class="line">| id | select_type | table      | type   | possible_keys | key     | key_len | <span class="keyword">ref</span>   | rows | Extra |</span>
<span class="line">+----+-------------+------------+--------+---------------+---------+---------+-------+------+-------+</span>
<span class="line">|  <span class="number">1</span> | PRIMARY     | &lt;derived2&gt; | <span class="keyword">system</span> | NULL          | NULL    | NULL    | NULL  |    <span class="number">1</span> | NULL  |</span>
<span class="line">|  <span class="number">2</span> | DERIVED     | test       | const  | PRIMARY       | PRIMARY | <span class="number">4</span>       | const |    <span class="number">1</span> | NULL  |</span>
<span class="line">+----+-------------+------------+--------+---------------+---------+---------+-------+------+-------+</span>
</pre></td></tr></table></figure>
<h3 id="possible-keys：可能用到的主键-索引"><a href="#possible-keys：可能用到的主键-索引" class="headerlink" title="possible-keys：可能用到的主键/索引"></a>possible-keys：可能用到的主键/索引</h3><p>指出MySQL能使用哪个索引在表中找到行，查询涉及到的字段上若存在索引，则该索引将被列出，但不一定被查询使用</p>
<h3 id="key：实际用到的主键-索引"><a href="#key：实际用到的主键-索引" class="headerlink" title="key：实际用到的主键/索引"></a>key：实际用到的主键/索引</h3><p>显示MySQL在查询中实际使用的索引，若没有使用索引，显示为NULL。 <br><font color="red">查询中若使用了覆盖索引，则该索引仅出现在key列表中</font></p>
<h3 id="key-len：key的长度"><a href="#key-len：key的长度" class="headerlink" title="key_len：key的长度"></a>key_len：key的长度</h3><p>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。 <br><font color="red">key_len显示的值为索引字段的最大可能长度，并非实际使用长度，即key_len是根据表定义计算而得，不是通过表内检索出的</font></p>
<h3 id="ref：参考（字段的关联）"><a href="#ref：参考（字段的关联）" class="headerlink" title="ref：参考（字段的关联）"></a>ref：参考（字段的关联）</h3><p>表示上述表的连接匹配条件，即哪些列或常量被用于查找索引列上的值</p>
<h3 id="row：估计结果行数"><a href="#row：估计结果行数" class="headerlink" title="row：估计结果行数"></a>row：估计结果行数</h3><p>表示MySQL根据表统计信息及索引选用情况，估算的找到所需的记录所需要读取的行数</p>
<h2 id="MySQL执行计划的局限"><a href="#MySQL执行计划的局限" class="headerlink" title="MySQL执行计划的局限"></a>MySQL执行计划的局限</h2><ul>
<li>EXPLAIN不会告诉你关于触发器、存储过程的信息或用户自定义函数对查询的影响情况</li>
<li>EXPLAIN不考虑各种Cache</li>
<li>EXPLAIN不能显示MySQL在执行查询时所作的优化工作</li>
<li>部分统计信息是估算的，并非精确值(如:对Innodb行数的估算)</li>
<li>EXPALIN只能解释SELECT操作，其他操作要重写为SELECT后查看执行计划（5.6.*版本已经可以对update，delete操作做EXPALIN）</li>
</ul>
<h2 id="MySQL5-6支持OPTIMIZER-TRACE"><a href="#MySQL5-6支持OPTIMIZER-TRACE" class="headerlink" title="MySQL5.6支持OPTIMIZER_TRACE"></a>MySQL5.6支持OPTIMIZER_TRACE</h2><p>开启可查看步骤：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 开启</span></span>
<span class="line">mysql&gt; show variables like <span class="string">'%trace%'</span>;</span>
<span class="line">+------------------------------+----------------------------------------------------------------------------+</span>
<span class="line">| Variable_name                | Value                                                                      |</span>
<span class="line">+------------------------------+----------------------------------------------------------------------------+</span>
<span class="line">| optimizer_trace              | enabled=off,one_line=off                                                   |</span>
<span class="line">| optimizer_trace_features     | greedy_search=on,range_optimizer=on,dynamic_range=on,repeated_subselect=on |</span>
<span class="line">| optimizer_trace_limit        | <span class="number">1</span>                                                                          |</span>
<span class="line">| optimizer_trace_max_mem_size | <span class="number">16384</span>                                                                      |</span>
<span class="line">| optimizer_trace_offset       | -<span class="number">1</span>                                                                         |</span>
<span class="line">+------------------------------+----------------------------------------------------------------------------+</span>
<span class="line"></span>
<span class="line">set optimizer_trace=<span class="string">'enabled=on'</span>;</span>
<span class="line">set optimizer_trace_max_mem_size=<span class="number">1000000</span>;</span>
<span class="line">set end_markers_in_json=on;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看</span></span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from information_schema.optimizer_trace\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">                            QUERY: explain <span class="keyword">select</span> id,pad from sbtest1 where id&lt;<span class="number">100</span></span>
<span class="line">                            TRACE: &#123;</span>
<span class="line">  <span class="string">"steps"</span>: [</span>
<span class="line">    &#123;</span>
<span class="line">      <span class="string">"join_preparation"</span>: &#123;</span>
<span class="line">        <span class="string">"select#"</span>: <span class="number">1</span>,</span>
<span class="line">        <span class="string">"steps"</span>: [</span>
<span class="line">          &#123;</span>
<span class="line">            <span class="string">"expanded_query"</span>: <span class="string">"/* select#1 */ select `sbtest1`.`id` AS `id`,`sbtest1`.`pad` AS `pad` from `sbtest1` where (`sbtest1`.`id` &lt; 100)"</span></span>
<span class="line">          &#125;</span>
<span class="line">        ] /* steps *<span class="regexp">/</span>
<span class="line">      &#125; /</span>* join_preparation *<span class="regexp">/</span>
<span class="line">    &#125;,</span>
<span class="line">    &#123;</span>
<span class="line">......</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle RMAN异机恢复归档RMAN-07518（供日志挖掘使用）及修改dbid步骤]]></title>
      <url>/2017/09/25/oracle/20170925_Oracle%20RMAN%E5%BC%82%E6%9C%BA%E6%81%A2%E5%A4%8D%E5%BD%92%E6%A1%A3RMAN-07518%EF%BC%88%E4%BE%9B%E6%97%A5%E5%BF%97%E6%8C%96%E6%8E%98%E4%BD%BF%E7%94%A8%EF%BC%89%E5%8F%8A%E4%BF%AE%E6%94%B9dbid%E6%AD%A5%E9%AA%A4/</url>
      <content type="html"><![CDATA[<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 原库：CRM (DBID=3657993631)  异机：DGT (DBID=1562574039)</span></span>
<span class="line">sqlplus / as sysdba</span>
<span class="line"><span class="keyword">exec</span> dbms_backup_restore.nidbegin(<span class="string">'dgt'</span>,<span class="string">'DGT'</span>,<span class="string">'3657993631'</span>,<span class="string">'1562574039'</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">10</span>);</span>
<span class="line"></span>
<span class="line">variable a number;</span>
<span class="line">variable b number;</span>
<span class="line">variable c number;</span>
<span class="line"></span>
<span class="line"><span class="keyword">exec</span> dbms_backup_restore.nidprocessdf(<span class="number">0</span>,<span class="number">0</span>,:a,:b,:c);</span>
<span class="line"><span class="keyword">exec</span> dbms_backup_restore.nidprocesscf(:a,:b);</span>
<span class="line"><span class="keyword">exec</span> dbms_backup_restore.nidend;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> dbid from v$database;</span>
<span class="line"></span>
<span class="line">rman target /</span>
<span class="line">catalog start with <span class="string">'/oradata/nfs/crmpn_rman/arc_temp'</span>;</span>
<span class="line"></span>
<span class="line">run</span>
<span class="line">&#123;allocate channel ci type disk;</span>
<span class="line">set archivelog destination to <span class="string">'/u01/'</span>;</span>
<span class="line">restore archivelog all;</span>
<span class="line">release channel ci;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<p>参考：</p>
<ol>
<li><a href="http://blog.csdn.net/lk_db/article/details/51931638" target="_blank" rel="external">Oracle RMAN异机恢复归档RMAN-07518（供日志挖掘使用）及修改dbid步骤</a></li>
<li>[使用dbms_backup_restore修改DBID](<a href="http://blog.csdn.net/lk_db/article/details/51931638" target="_blank" rel="external">http://blog.csdn.net/lk_db/article/details/51931638</a></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PROCEDURE NIDBEGIN</span>
<span class="line"> Argument Name                  Type                    In/Out Default?</span>
<span class="line"> ------------------------------ ----------------------- ------ --------</span>
<span class="line"> NEWDBNAME                      VARCHAR2                IN</span>
<span class="line"> OLDDBNAME                      VARCHAR2                IN</span>
<span class="line"> NEWDBID                        NUMBER                  IN</span>
<span class="line"> OLDDBID                        NUMBER                  IN</span>
<span class="line"> DOREVERT                       BINARY_INTEGER          IN</span>
<span class="line"> DORESTART                      BINARY_INTEGER          IN</span>
<span class="line"> EVENTS                         NUMBER                  IN</span>
<span class="line">PROCEDURE NIDEND</span>
<span class="line">PROCEDURE NIDGETNEWDBID</span>
<span class="line"> Argument Name                  Type                    In/Out Default?</span>
<span class="line"> ------------------------------ ----------------------- ------ --------</span>
<span class="line"> DBNAME                         VARCHAR2                IN</span>
<span class="line"> NDBID                          NUMBER                  OUT</span>
<span class="line">PROCEDURE NIDPROCESSCF</span>
<span class="line"> Argument Name                  Type                    In/Out Default?</span>
<span class="line"> ------------------------------ ----------------------- ------ --------</span>
<span class="line"> CHGDBID                        BINARY_INTEGER          OUT</span>
<span class="line"> CHGDBNAME                      BINARY_INTEGER          OUT</span>
<span class="line">PROCEDURE NIDPROCESSDF</span>
<span class="line"> Argument Name                  Type                    In/Out Default?</span>
<span class="line"> ------------------------------ ----------------------- ------ --------</span>
<span class="line"> FNO                            NUMBER                  IN</span>
<span class="line"> ISTEMP                         BINARY_INTEGER          IN</span>
<span class="line"> SKIPPED                        BINARY_INTEGER          OUT</span>
<span class="line"> CHGDBID                        BINARY_INTEGER          OUT</span>
<span class="line"> CHGDBNAME                      BINARY_INTEGER          OUT</span>
</pre></td></tr></table></figure>]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 07 MySQL索引设计]]></title>
      <url>/2017/09/21/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/07-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="B树与B-树的区别？"><a href="#B树与B-树的区别？" class="headerlink" title="B树与B+树的区别？"></a>B树与B+树的区别？</h2><ul>
<li>B树<ul>
<li>所有关键字在整颗树中出现，任何一个关键字出现且只出现在一个结点中</li>
<li>搜索在非叶子结点也可以命中</li>
<li>叶子节点间没有链表</li>
</ul>
</li>
<li>B+树<ul>
<li>所有关键字都在叶子结点出现</li>
<li>搜索不可能在非叶子结点命中</li>
<li>叶子节点间有链表</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h2 id="MySQL中HASH索引和B-树索引的区别？"><a href="#MySQL中HASH索引和B-树索引的区别？" class="headerlink" title="MySQL中HASH索引和B+树索引的区别？"></a>MySQL中HASH索引和B+树索引的区别？</h2><p>Hash索引是将索引键通过Hash运算之后，将Hash运算结果的Hash值和所对应的行指针信息存放于一个Hash表中。Hash索引的查询效率要远高于B-Tree索引，索引的检索可以一次定位，不像B-Tree索引需要从根节点到枝节点，最后才能访问到叶子节点这样多次的IO访问。虽然Hash索引效率高，但是Hash索引本身由于其特殊性也带来了很多限制和弊端，主要有以下这些：</p>
<ol>
<li>Hash索引仅仅能满足<code>=</code>,<code>IN</code>和<code>&lt;=&gt;</code>查询，不能使用范围查询<br>由于Hash索引比较的是进行Hash运算之后的Hash值，所以它只能用于等值的过滤，不能用于基于范围的过滤，因为经过相应的Hash算法处理之后的Hash值的大小关系，并不能保证和Hash运算前完全一样。 </li>
<li>Hash索引无法被用来避免数据的排序操作<br>由于Hash索引中存放的是经过Hash计算之后的Hash值，而且Hash值的大小关系并不一定和Hash运算前的键值完全一样，所以数据库无法利用索引的数据来避免任何排序运算; </li>
<li>Hash索引不能利用部分索引键查询<br>对于组合索引，Hash索引在计算Hash值的时候是组合索引键合并后再一起计算Hash值，而不是单独计算Hash值，所以通过组合索引的前面一个或几个索引键进行查询的时候，Hash索引也无法被利用。 </li>
<li>Hash索引在任何时候都不能避免表扫描<br>由于不同索引键存在相同Hash值，所以即使取满足某个Hash键值的数据的记录条数，也无法从Hash索引中直接完成查询，还是要通过访问表中的实际数据进行相应的比较，并得到相应的结果。 </li>
<li>Hash索引遇到大量Hash值相等的情况后性能并不一定就会比B-Tree索引高<br>对于选择性比较低的索引键，如果创建Hash索引，那么将会存在大量记录指针信息存于同一个Hash值相关联。这样要定位某一条记录时就会非常麻烦，会浪费多次表数据的访问，而造成整体性能低下。</li>
</ol>
<h2 id="聚簇索引与辅助索引的区别？"><a href="#聚簇索引与辅助索引的区别？" class="headerlink" title="聚簇索引与辅助索引的区别？"></a>聚簇索引与辅助索引的区别？</h2><p>　　聚簇索引和索引组织表(Index Organized Table, IOT)是一个意思，聚簇索引中的数据是按主键存储和排序。聚簇索引就是按照每张表的主键构造一棵B+树，同时叶子节点中存放的即为整张表的行记录数据，也将聚集索引的叶子节点称为数据页。聚簇索引的这个特性决定了索引组织表中数据也是索引的一部分。同B+树数据结构一样，每个数据页都通过一个双向链表来进行链接。由于实际的数据页只能按照一棵B+树进行排序，因此每张表只能拥有一个聚集索引。</p>
<p>　　辅助索引（secondary index，也称二级索引），叶子节点并不包含行记录的全部数据，叶子节点除了包含键值以外，每个叶子节点中的索引行中还包含了一个书签。该书签用来告诉Innodb存储引擎哪里可以找到与索引相对应的行数据。由于Innodb存储引擎是索引组织表，因此Innodb存储引擎的辅助索引的书签就是相应行数据的聚集索引键。辅助索引的存在并不影响数据在聚集索引中的组织，因此每张表上可以有多个辅助索引。当通过辅助索引来寻找数据时，Innodb存储引擎会遍历辅助索引并通过叶级别的指针获得指向主键索引的主键，然后再通过主键索引来找到一个完整的行记录。</p>
<p>　　一个表中，聚簇索引占用的空间肯定是最大的，因为它是存储了全部数据的，而辅助索引，是建立在某几个需要经常查询的列上面的，除了这几个列之外，剩下的就是用来“回表”的指针信息了，所以相对而言，辅助索引的占用空间都会比聚簇索引小很多，特别是在一个表的列数很多或是这些列中包含大字段的情况下。</p>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ORACLE审计]]></title>
      <url>/2017/09/13/oracle/oracle%E5%AE%A1%E8%AE%A1/</url>
      <content type="html"><![CDATA[<p>Oracle审计(Audit)主要用于记录用户对数据库所做的操作，基于配置的不同，审计的结果会放在操作系统文件中或者系统表中。<br>默认情况下，使用管理员权限连接实例，开启及关闭数据库是会强制进行审计的，其它的基础的操作则没有进行审计。<br>在一些安全性要求比较高的环境是需要做一些审计的配置的。</p>
<a id="more"></a>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show parameter audit_trail;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">audit_trail                          string      DB_EXTENDED</span>
<span class="line"></span>
<span class="line"><span class="comment"># 将审计结果放在数据库表中，并额外记录SQL_BIND和SQL_TEXT(具体执行语句)</span></span>
<span class="line">alter <span class="keyword">system</span> set audit_trail=db_extended scope=spfile;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启数据库</span></span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line">startup</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置审计内容</span></span>
<span class="line">audit all by lyj by access;</span>
<span class="line">audit <span class="keyword">select</span> table, update table, insert table, <span class="keyword">delete</span> table by lyj by access;</span>
<span class="line">audit execute procedure by lyj by access;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 取消设置</span></span>
<span class="line">noaudit all by lyj;</span>
<span class="line">noaudit <span class="keyword">select</span> table, update table, insert table, <span class="keyword">delete</span> table by lyj;</span>
<span class="line">noaudit execute procedure by lyj;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 审计dept表的查询，删除不论它是否成功</span></span>
<span class="line">audit <span class="keyword">select</span> ,<span class="keyword">delete</span> on scott.dept by access whenever <span class="keyword">not</span> successful;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 审计emp表的所有操作，只有当操作成功的时候</span></span>
<span class="line">audit all on scott.emp by access whenever successful;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 取消对表的审计</span></span>
<span class="line">noaudit all on scott.dept;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看审计记录</span></span>
<span class="line"><span class="keyword">select</span> USERNAME,USERHOST,TIMESTAMP,SQL_TEXT FROM dba_audit_trail order by timestamp;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 清空审计表内容</span></span>
<span class="line"><span class="keyword">truncate</span> table aud$;</span>
<span class="line"></span>
<span class="line"><span class="comment">## by access  每个被审计的操作都会生成一条记录</span></span>
<span class="line"><span class="comment">## by session 默认值，每个会话里同类型操作只会生成一条audit trail</span></span>
<span class="line"><span class="comment">## whenever successful 操作成功才审计</span></span>
<span class="line"><span class="comment">## whenever not successful 操作不成功才审计</span></span>
</pre></td></tr></table></figure>]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> audit </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 06 MySQL设计与开发最佳实践]]></title>
      <url>/2017/09/11/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/06-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="表结构设计的核心思想是什么？"><a href="#表结构设计的核心思想是什么？" class="headerlink" title="表结构设计的核心思想是什么？"></a>表结构设计的核心思想是什么？</h2><ol>
<li>表及表字段只增不减，即不删除表，不删除字段，只做增加。</li>
<li>使用<code>innodb</code>存储引擎，支持事务，MVCC，行级锁，更好的恢复性，更高效的IO，更先进的缓存，更先进的写策略。高并发下性能更好，对多核，大内存，SSD等硬件支持更好。</li>
<li>自增主键，推荐用独立于业务的<code>AUTO_INCREMENT</code>列或全局ID生成器做代理主键。</li>
<li>拆开宽表，便于运维，加快变更速度，提高查询性能，节省IO和内存。</li>
<li>控制单表数据量，纯INT不超过1000W，含VARCHAR不超过500w。建议单库不超过300-400个表。</li>
<li>控制列数据，越短越好，单表不超50个纯INT字段，VARCHAR(10)不超20个字段，单表字段数上限控制在20-50个。</li>
<li>表和字段加注释。</li>
<li>使用推荐的字段类型：<ul>
<li>时间 <code>timestamp</code></li>
<li>日期 <code>date</code></li>
<li>IP   <code>int unsigned</code>  <code>INET_ATON(&#39;127.0.0.1&#39;)</code>  <code>INET_NTOA(ip)</code></li>
<li>小数 <code>decimal</code></li>
<li>尽量不用<code>text/blob/char</code>，用<code>varchar</code></li>
<li>字段只有<code>true or false</code>，用<code>tinyint</code></li>
<li>非负数值，用<code>unsigned</code></li>
<li>默认值不能用<code>null</code>，数字类型用<code>default 0</code>，字符类型用<code>defalut &#39;&#39;</code></li>
</ul>
</li>
<li>不在数据库里存图片</li>
<li>禁用外键</li>
</ol>
<a id="more"></a>
<h2 id="建索引时要考虑哪些因素？"><a href="#建索引时要考虑哪些因素？" class="headerlink" title="建索引时要考虑哪些因素？"></a>建索引时要考虑哪些因素？</h2><h3 id="有个大表为了一个查询（一天就查2次），领导要你建索引（索引空间大小有500G），你怎么考虑，是建还是不建？"><a href="#有个大表为了一个查询（一天就查2次），领导要你建索引（索引空间大小有500G），你怎么考虑，是建还是不建？" class="headerlink" title="有个大表为了一个查询（一天就查2次），领导要你建索引（索引空间大小有500G），你怎么考虑，是建还是不建？"></a>有个大表为了一个查询（一天就查2次），领导要你建索引（索引空间大小有500G），你怎么考虑，是建还是不建？</h3><p><strong>建索引常用的规则如下：</strong></p>
<ol>
<li>表的主键、外键必须有索引； </li>
<li>数据量超过300w的表应该有索引； </li>
<li>经常与其他表进行连接的表，在连接字段上应该建立索引； </li>
<li>经常出现在Where子句中的字段，特别是大表的字段，应该建立索引； </li>
<li>索引应该建在选择性高的字段上； </li>
<li>索引应该建在小字段上，对于大的文本字段甚至超长字段，不要建索引； </li>
<li>复合索引的建立需要进行仔细分析，尽量考虑用单字段索引代替 <ul>
<li>正确选择复合索引中的主列字段，一般是选择性较好的字段； </li>
<li>复合索引的几个字段是否经常同时以AND方式出现在Where子句中？单字段查询是否极少甚至没有？如果是，则可以建立复合索引；否则考虑单字段索引； </li>
<li>如果复合索引中包含的字段经常单独出现在Where子句中，则分解为多个单字段索引； </li>
<li>如果复合索引所包含的字段超过3个，那么仔细考虑其必要性，考虑减少复合的字段； </li>
<li>如果既有单字段索引，又有这几个字段上的复合索引，一般可以删除复合索引</li>
</ul>
</li>
<li>频繁进行数据操作的表，不要建立太多的索引； </li>
<li>删除无用的索引，避免对执行计划造成负面影响</li>
</ol>
<p>若有一个大表，建索引空间有500G，且一天就查2次，那我是不建议建索引的。<br>根据索引空间大小500G，基本可以判断表的记录应该在亿条数据级以上，且应该是一个类似于日志记录性质的表，且日志增涨应该较快。<br>这么大的表建索引时，首先会给数据库造成较大的影响，并且建索引后会影响表的写入性能。 在一天就查询2次这种业务需求下，建索引的代价是相对较大的。</p>
<h2 id="执行计划中有-filesort-就会进行磁盘文件排序吗（详细说明）"><a href="#执行计划中有-filesort-就会进行磁盘文件排序吗（详细说明）" class="headerlink" title="执行计划中有 filesort 就会进行磁盘文件排序吗（详细说明）?"></a>执行计划中有 filesort 就会进行磁盘文件排序吗（详细说明）?</h2><p>filesort是在使用explain命令查看一条SQL的执行计划的时候可能会看到在 “Extra” 一列显示的信息。</p>
<p>filesort表示MySQL需要进行实际的排序操作，而不能通过索引获得已排序数据。</p>
<p>实际上，只要一条 SQL 语句需要进行排序操作，都会显示“Using filesort”，这并不表示就会有文件排序操作。</p>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 05 MySQL核心参数优化]]></title>
      <url>/2017/09/06/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/05-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="back-log参数的作用"><a href="#back-log参数的作用" class="headerlink" title="back_log参数的作用"></a>back_log参数的作用</h2><p>指定MySQL可能的TCP/IP的连接数量（一个TCP/IP连接占256k），默认是50。<br>当MySQL主线程在很短的时间内得到非常多的连接请求，该参数就起作用，之后主线程花些时间（尽管很短）检查连接并且启动一个新线程。<br>back_log参数的值指出在MySQL暂时停止响应新请求之前的短时间内多少个请求可以被存在堆栈中。如果系统在一个短时间内有很多连接，则需要增大该参数的值，该参数值指定到来的TCP/IP连接的侦听accept队列的大小。<br>不同的操作系统在这个accept队列大小上有它自己的限制，设定back_log高于你的操作系统的限制将是无效的。</p>
<p>参考值：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">back_log=<span class="number">300</span></span>
<span class="line"><span class="comment"># 或</span></span>
<span class="line">back_log=<span class="number">500</span></span>
</pre></td></tr></table></figure></p>
<a id="more"></a>
<h2 id="thread-cache-size参数的作用"><a href="#thread-cache-size参数的作用" class="headerlink" title="thread_cache_size参数的作用"></a>thread_cache_size参数的作用</h2><p>thread_cache_size线程池，线程缓存。这个值表示可以重新利用保存在缓存中线程的数量，当断开连接时如果缓存中还有空间,那么客户端的线程将被放到缓存中,如果线程重新被请求，那么请求将从缓存中读取，如果缓存中是空的或者是新的请求，那么这个线程将被重新创建，如果有很多新的线程，增加这个值可以改善系统性能。<br>每建立一个连接，都需要一个线程来与之匹配，此参数用来缓存空闲的线程，以至不被销毁，如果线程缓存中有空闲线程，这时候如果建立新连接，MYSQL就会很快的响应连接请求。<br>可根据物理内存设置规则如下：<br>1G  ―&gt; 8<br>2G  ―&gt; 16<br>3G  ―&gt; 32<br>大于3G  ―&gt; 64</p>
<p>参考值：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">thread_cache_size = <span class="number">64</span> </span>
<span class="line"></span>
<span class="line">mysql&gt; show variables like <span class="string">'thread_cache_size'</span>;</span>
<span class="line">+-------------------+-------+</span>
<span class="line">| Variable_name     | Value |</span>
<span class="line">+-------------------+-------+</span>
<span class="line">| thread_cache_size | <span class="number">10</span>    |</span>
<span class="line">+-------------------+-------+</span>
<span class="line"></span>
<span class="line">mysql&gt; show global status like <span class="string">'Thread%'</span>;</span>
<span class="line">+-------------------+-------+</span>
<span class="line">| Variable_name     | Value |</span>
<span class="line">+-------------------+-------+</span>
<span class="line">| Threads_cached    | <span class="number">9</span>     |</span>
<span class="line">| Threads_connected | <span class="number">2</span>     |</span>
<span class="line">| Threads_created   | <span class="number">12</span>    |</span>
<span class="line">| Threads_running   | <span class="number">2</span>     |</span>
<span class="line">+-------------------+-------+</span>
<span class="line"></span>
<span class="line">set global thread_cache_size=<span class="number">64</span></span>
</pre></td></tr></table></figure></p>
<h2 id="table-open-cache参数的作用"><a href="#table-open-cache参数的作用" class="headerlink" title="table_open_cache参数的作用"></a>table_open_cache参数的作用</h2><p>table_open_cache，表高速缓存的大小。</p>
<p>当某一连接访问一个表时，MySQL会检查当前已缓存表的数量。如果该表已经在缓存中打开，则会直接访问缓存中的表已加快查询速度；如果该表未被缓存，则会将当前的表添加进缓存并进行查询。</p>
<p>在执行缓存操作之前，table_cache用于限制缓存表的最大数目：如果当前已经缓存的表未达到table_cache，则会将新表添加进来；若已经达到此值，MySQL将根据缓存表的最后查询时间、查询率等规则释放之前的缓存。</p>
<p>参考值：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">table_open_cache=<span class="number">1024</span></span>
</pre></td></tr></table></figure></p>
<h2 id="学习笔记"><a href="#学习笔记" class="headerlink" title="学习笔记"></a>学习笔记</h2><p>###CPU的优化<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># innodb_thread_concurrency设置的值约等CPU数</span></span>
<span class="line">innodb_thread_concurrency=<span class="number">32</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 连接的优化</span></span>
</pre></td></tr></table></figure></p>
<h3 id="内存的优化"><a href="#内存的优化" class="headerlink" title="内存的优化"></a>内存的优化</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 关闭查询缓存，缓存到应用层(如redis)，不建议在MYSQL层面开始，5.6有BUG</span></span>
<span class="line">query_cache_type=<span class="number">0</span></span>
<span class="line">query_cache_size=<span class="number">0</span></span>
</pre></td></tr></table></figure>
<h3 id="IO的优化"><a href="#IO的优化" class="headerlink" title="IO的优化"></a>IO的优化</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 单实例时物理内存的60-70%</span></span>
<span class="line">innodb_buffer_pool_size=<span class="number">50</span>G</span>
<span class="line"></span>
<span class="line"><span class="comment"># 每秒后台进程处理IO数据的上限，一般设置总IO的75%左右。 SSD设置成20000</span></span>
<span class="line">innodb_io_capacity=<span class="number">20000</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># innodb redo日志组数量(iblog)</span></span>
<span class="line">innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># innodb redo日志组文件大小</span></span>
<span class="line">innodb_log_file_size=<span class="number">1000</span>M</span>
<span class="line"></span>
<span class="line"><span class="comment"># RAID使用直接写，提高性能</span></span>
<span class="line">innodb_flush_method=O_DIRECT</span>
<span class="line"></span>
<span class="line"><span class="comment"># 脏页达到50%就写磁盘</span></span>
<span class="line">innodb_max_dirty_pages_pct=<span class="number">50</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置一个表对应一个文件，保持默认</span></span>
<span class="line">innodb_file_per_table=on</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置PAGE大小(默认16k)</span></span>
<span class="line">innodb_page_size=<span class="number">4</span>k</span>
<span class="line"></span>
<span class="line"><span class="comment"># SSD盘设置为0</span></span>
<span class="line">innodb_flush_neighbors=<span class="number">0</span></span>
</pre></td></tr></table></figure>
<h3 id="连接的优化"><a href="#连接的优化" class="headerlink" title="连接的优化"></a>连接的优化</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 指定MySQL可能的TCP/IP的连接数量，现在一般都是长连接，这个值不建议设置过大</span></span>
<span class="line">back_log=<span class="number">300</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 最大的连接数</span></span>
<span class="line">max_connections=<span class="number">3000</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 最大的用户连接数(和上面差20，是留给管理用的)</span></span>
<span class="line">max_user_connections=<span class="number">2980</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 表描述符缓存大小，可减少文件打开/关闭次数</span></span>
<span class="line">table_open_cache=<span class="number">1024</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 线程池，线程缓存</span></span>
<span class="line">thread_cache_size=<span class="number">512</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 连接超时断开</span></span>
<span class="line">wait_timeout=<span class="number">120</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 交互超时断开</span></span>
<span class="line">interactive_timeout=<span class="number">120</span></span>
</pre></td></tr></table></figure>
<h3 id="数据库一致性优化"><a href="#数据库一致性优化" class="headerlink" title="数据库一致性优化"></a>数据库一致性优化</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">sync_binlog=<span class="number">1</span></span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 04 MySQL优化之Linux系统层面调优]]></title>
      <url>/2017/08/28/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/04-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="MySQL中出现存SWAP-主要会是哪些原因？"><a href="#MySQL中出现存SWAP-主要会是哪些原因？" class="headerlink" title="MySQL中出现存SWAP,主要会是哪些原因？"></a>MySQL中出现存SWAP,主要会是哪些原因？</h2><ol>
<li><p>没设置内核参数<code>sysctl.conf</code>中的<code>vm.swappiness=0</code></p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在CentOS 6.4及更新版本的内核中设置vm.swappiness=0，有可能会导致MySQL数据库所在的系统出现内存溢出(OOM)，</span></span>
<span class="line"><span class="comment"># 可将vm.swappiness设置成1</span></span>
<span class="line">vm.swappiness = <span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># CentOS 7.x中</span></span>
<span class="line"><span class="comment">## 查找到存在vm.swappiness参数的配置文件</span></span>
<span class="line">find /usr/lib/tuned -name <span class="string">'*.conf'</span> -type f -<span class="keyword">exec</span> <span class="keyword">grep</span> <span class="string">"vm.swappiness"</span> &#123;&#125; \+</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">/usr/lib/tuned/latency-performance/tuned.conf:vm.swappiness=<span class="number">10</span></span>
<span class="line">/usr/lib/tuned/throughput-performance/tuned.conf:vm.swappiness=<span class="number">10</span></span>
<span class="line">/usr/lib/tuned/virtual-guest/tuned.conf:vm.swappiness = <span class="number">30</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"><span class="comment"># 把以上3个文件中的vm.swappiness的值都修改为0或1</span></span>
</pre></td></tr></table></figure>
</li>
<li><p>没配置MySQL的配置参数memlock<br>这个参数会强迫mysqld进程的地址空间一直被锁定在物理内存上，对于os来说是非常霸道的一个要求。要用root帐号来启动MySQL才能生效。</p>
</li>
<li>没关闭NUMA<a id="more"></a>
</li>
</ol>
<h2 id="MySQL中CPU负载很高，是什么原因？给出查找的步骤及解决思路？"><a href="#MySQL中CPU负载很高，是什么原因？给出查找的步骤及解决思路？" class="headerlink" title="MySQL中CPU负载很高，是什么原因？给出查找的步骤及解决思路？"></a>MySQL中CPU负载很高，是什么原因？给出查找的步骤及解决思路？</h2><p>一般来说MySQL占用CPU高，多半是数据库有变态SQL、大表无索引，或有大量的并发任务导致。</p>
<h3 id="问题排查思路"><a href="#问题排查思路" class="headerlink" title="问题排查思路"></a>问题排查思路</h3><ol>
<li>确定高负载的类型，top命令看负载高是CPU还是IO。 </li>
<li>MySQL下执行查看当前的连接数与执行的sql语句。 </li>
<li>检查慢查询日志，可能是慢查询引起负载高。 </li>
<li>检查硬件问题，是否磁盘故障问题造成的。 </li>
<li>检查监控平台，对比此机器不同时间的负载。 </li>
</ol>
<h3 id="确定负载类型-top"><a href="#确定负载类型-top" class="headerlink" title="确定负载类型(top)"></a>确定负载类型(top)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">top</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------------</span></span>
<span class="line">top - <span class="number">11</span>:<span class="number">33</span>:<span class="number">17</span> up <span class="number">142</span> days, <span class="number">20</span>:<span class="number">57</span>,  <span class="number">2</span> users,  load average: <span class="number">1.85</span>, <span class="number">0</span>.<span class="number">80</span>, <span class="number">0</span>.<span class="number">62</span></span>
<span class="line">Tasks: <span class="number">174</span> total,   <span class="number">1</span> running, <span class="number">173</span> sleeping,   <span class="number">0</span> stopped,   <span class="number">0</span> zombie</span>
<span class="line">Cpu(<span class="keyword">s</span>): <span class="number">33.8</span>%us,  <span class="number">8.3</span>%sy,  <span class="number">0</span>.<span class="number">0</span>%ni, <span class="number">52.1</span>%id,  <span class="number">3.0</span>%wa,  <span class="number">0</span>.<span class="number">0</span>%hi,  <span class="number">2.8</span>%si,  <span class="number">0</span>.<span class="number">0</span>%st</span>
<span class="line">Mem:   <span class="number">8174352</span>k total,  <span class="number">3291308</span>k used,  <span class="number">4883044</span>k free,   <span class="number">151272</span>k buffers</span>
<span class="line">Swap: <span class="number">16531452</span>k total,    <span class="number">19584</span>k used, <span class="number">16511868</span>k free,  <span class="number">2034864</span>k cached</span>
<span class="line"></span>
<span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                      </span>
<span class="line"><span class="number">11420</span> mysql     <span class="number">20</span>   <span class="number">0</span> <span class="number">5786</span><span class="keyword">m</span> <span class="number">819</span><span class="keyword">m</span>  <span class="number">13</span><span class="keyword">m</span> S <span class="number">372.1</span> <span class="number">10.3</span>   <span class="number">0</span>:<span class="number">57.47</span> mysqld </span>
<span class="line">.....</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="查看当前的连接数与执行的sql语句"><a href="#查看当前的连接数与执行的sql语句" class="headerlink" title="查看当前的连接数与执行的sql语句"></a>查看当前的连接数与执行的sql语句</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show processlist;</span>
<span class="line">show processlist;</span>
<span class="line">+----+------+----------------------+------+-------------+------+-----------------------------------------------------------------------+------------------------------------------+</span>
<span class="line">| Id | User | Host                 | db   | Command     | Time | State                                                                 | Info                                     |</span>
<span class="line">+----+------+----------------------+------+-------------+------+-----------------------------------------------------------------------+------------------------------------------+</span>
<span class="line">|  <span class="number">1</span> | root | localhost            | NULL | Query       |    <span class="number">0</span> | init                                                                  | show processlist                         |</span>
<span class="line">| <span class="number">12</span> | rep  | <span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">41161</span> | NULL | Binlog Dump |  <span class="number">120</span> | Master has sent all binlog to slave; waiting <span class="keyword">for</span> binlog to be updated | NULL                                     |</span>
<span class="line">| <span class="number">26</span> | root | <span class="number">10.245</span>.<span class="number">231.201</span>:<span class="number">46306</span> | test | Query       |    <span class="number">0</span> | Writing to net                                                        | SELECT pad FROM sbtest11 WHERE id=<span class="number">100233</span> |</span>
<span class="line">| <span class="number">27</span> | root | <span class="number">10.245</span>.<span class="number">231.201</span>:<span class="number">46308</span> | test | Sleep       |    <span class="number">0</span> | NULL                                                                  | NULL                                     |</span>
<span class="line">| <span class="number">28</span> | root | <span class="number">10.245</span>.<span class="number">231.201</span>:<span class="number">46309</span> | test | Query       |    <span class="number">0</span> | statistics                                                            | SELECT pad FROM sbtest3 WHERE id=<span class="number">100176</span>  |</span>
<span class="line">| <span class="number">29</span> | root | <span class="number">10.245</span>.<span class="number">231.201</span>:<span class="number">46307</span> | test | Query       |    <span class="number">0</span> | Sending data                                                          | SELECT pad FROM sbtest15 WHERE id=<span class="number">63746</span>  |</span>
<span class="line">+----+------+----------------------+------+-------------+------+-----------------------------------------------------------------------+------------------------------------------+</span>
</pre></td></tr></table></figure>
<h3 id="记录慢查询"><a href="#记录慢查询" class="headerlink" title="记录慢查询"></a>记录慢查询</h3><p>编辑Mysql 配置文件(my.cnf),在[mysqld]字段添加以下几行<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">log_slow_queries = <span class="regexp">/usr/local</span><span class="regexp">/mysql/var</span><span class="regexp">/slow_queries.log   # 慢查询日志路径</span>
<span class="line">long_query_time = 10                                       # 记录SQL查询超过10s的语句</span>
<span class="line">log-queries-not-using-indexes = 1                          # 记录没有使用索引的sql</span></span>
</pre></td></tr></table></figure></p>
<h3 id="查看慢查询日志"><a href="#查看慢查询日志" class="headerlink" title="查看慢查询日志"></a>查看慢查询日志</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">tail /usr/<span class="keyword">local</span>/mysql/var/slow_queries.log </span>
<span class="line"><span class="comment"># Time: 130305  9:48:13</span></span>
<span class="line"><span class="comment"># User@Host: biotherm[biotherm] @  [8.8.8.45]</span></span>
<span class="line"><span class="comment"># Query_time: 1294.881407  Lock_time: 0.000179 Rows_sent: 4  Rows_examined: 1318033</span></span>
<span class="line"><span class="comment">## 这4个参数意思分别是：</span></span>
<span class="line"><span class="comment">## 查询时间                 锁定时间            查询结果行数   扫描行数</span></span>
<span class="line"><span class="comment">## 主要看扫描行数多的语句,然后去数据库加上对应的索引,再优化下变态的sql 语句</span></span>
<span class="line">SET timestamp=<span class="number">1363916893</span>; </span>
<span class="line">SELECT * FROM xxx_list WHERE tid = <span class="string">'11xx'</span>  AND del = <span class="number">0</span>  ORDER BY  id DESC  LIMIT <span class="number">0</span>, <span class="number">4</span>;</span>
<span class="line">.....</span>
</pre></td></tr></table></figure>
<h3 id="极端情况kill-sql进程"><a href="#极端情况kill-sql进程" class="headerlink" title="极端情况kill sql进程"></a>极端情况kill sql进程</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 找出占用cpu时间过长的sql，在mysql 下执行如下命令： </span></span>
<span class="line">show processlist; </span>
<span class="line"><span class="comment"># 确定后一条sql处于Query状态，且Time时间过长，锁定它的ID，执行如下命令： </span></span>
<span class="line"><span class="keyword">kill</span> QUERY  <span class="number">269815764</span>; </span>
<span class="line"><span class="comment">#注意：杀死 sql进程，可能导致数据丢失，所以执行前要衡量数据的重要性。</span></span>
</pre></td></tr></table></figure>
<h2 id="课程笔记"><a href="#课程笔记" class="headerlink" title="课程笔记"></a>课程笔记</h2><h3 id="设定主机名"><a href="#设定主机名" class="headerlink" title="设定主机名"></a>设定主机名</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/network</span>
</pre></td></tr></table></figure>
<h3 id="设定时区"><a href="#设定时区" class="headerlink" title="设定时区"></a>设定时区</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/sysconfig/clock</span>
<span class="line">ZONE=Asia/Shanghai</span>
<span class="line">UTC=false</span>
<span class="line">ARC=false</span>
<span class="line"></span>
<span class="line">rm /etc/<span class="keyword">localtime</span></span>
<span class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/<span class="keyword">localtime</span></span>
</pre></td></tr></table></figure>
<h3 id="设定NTP同步"><a href="#设定NTP同步" class="headerlink" title="设定NTP同步"></a>设定NTP同步</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sudocrontab-l</span>
<span class="line"><span class="number">0</span> * * * * <span class="regexp">/usr/sbin</span><span class="regexp">/ntpdate192.168.50.21; hwclock -w 1&gt;/dev</span><span class="regexp">/null 2&gt;&amp;1</span>
<span class="line">30 23 * * * /usr</span><span class="regexp">/sbin/ntpdate</span>192.<span class="number">168.50</span>.<span class="number">22</span>; hwclock -w <span class="number">1</span>&gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span>
</pre></td></tr></table></figure>
<h3 id="删除操作系统多余组和用户"><a href="#删除操作系统多余组和用户" class="headerlink" title="删除操作系统多余组和用户"></a>删除操作系统多余组和用户</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">groupdel adm</span>
<span class="line">groupdel lp</span>
<span class="line">groupdel news</span>
<span class="line">groupdel uucp</span>
<span class="line">groupdel games</span>
<span class="line">groupdel dip</span>
<span class="line">groupdel pppusers</span>
<span class="line">groupdel popusers</span>
<span class="line">groupdel slipusers</span>
<span class="line"></span>
<span class="line">userdel adm</span>
<span class="line">userdel lp</span>
<span class="line">userdel sync</span>
<span class="line">userdel <span class="keyword">shutdown</span></span>
<span class="line">userdel halt</span>
<span class="line">userdel news</span>
<span class="line">userdel uucp</span>
<span class="line">userdel operator</span>
<span class="line">userdel games</span>
<span class="line">userdel gopher</span>
<span class="line">userdel ftp</span>
</pre></td></tr></table></figure>
<h3 id="清理不需要的服务"><a href="#清理不需要的服务" class="headerlink" title="清理不需要的服务"></a>清理不需要的服务</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#一般只留下以下服务即可</span></span>
<span class="line">crond</span>
<span class="line">haldaemon</span>
<span class="line">irqbalance</span>
<span class="line">messagebus</span>
<span class="line">network</span>
<span class="line">sshd</span>
<span class="line">syslog</span>
</pre></td></tr></table></figure>
<h3 id="设置口令有效期和最少长度"><a href="#设置口令有效期和最少长度" class="headerlink" title="设置口令有效期和最少长度"></a>设置口令有效期和最少长度</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/login.defs</span>
<span class="line">PASS_MAX_DAYS=<span class="number">90</span></span>
<span class="line"><span class="comment"># 设置口令有效期为90（天）</span></span>
<span class="line">PASS_MIN_LEN <span class="number">8</span></span>
<span class="line"><span class="comment"># 设置口令最小长度为8</span></span>
</pre></td></tr></table></figure>
<h3 id="设置密码复杂度"><a href="#设置密码复杂度" class="headerlink" title="设置密码复杂度"></a>设置密码复杂度</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/pam.d/login</span>
<span class="line"><span class="comment"># 增加如下内容</span></span>
<span class="line">password required pam_cracklib.so difok=<span class="number">5</span> dcredit=-<span class="number">1</span> retry=<span class="number">1</span></span>
<span class="line"><span class="comment"># 新密码与旧密码必须有5个不同字符，必须有一个数字，一次失败后passwd程序返回错误信息</span></span>
</pre></td></tr></table></figure>
<h3 id="设置缺省密码长度限制"><a href="#设置缺省密码长度限制" class="headerlink" title="设置缺省密码长度限制"></a>设置缺省密码长度限制</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/login.defs</span>
<span class="line">PASS_MIN_LEN <span class="number">8</span></span>
</pre></td></tr></table></figure>
<h3 id="SSH安全配置"><a href="#SSH安全配置" class="headerlink" title="SSH安全配置"></a>SSH安全配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/ssh/sshd_config</span>
<span class="line">Procotol2         <span class="comment"># 强制使用协议</span></span>
<span class="line">PermitRootLoginno <span class="comment"># 不允许root远程登录</span></span>
</pre></td></tr></table></figure>
<h3 id="设置历史命令记录增加时间戳"><a href="#设置历史命令记录增加时间戳" class="headerlink" title="设置历史命令记录增加时间戳"></a>设置历史命令记录增加时间戳</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/profile</span>
<span class="line">HISTTIMEFORMAT=<span class="string">"%Y:%:M:%D %H-%m-%s"</span></span>
<span class="line"></span>
<span class="line">export=HISTTIMEFORMAT</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改用户当前目录下.bash_history文件权限</span></span>
<span class="line"><span class="keyword">chmod</span> <span class="number">600</span> .bash_history</span>
</pre></td></tr></table></figure>
<h3 id="sysctl内核参数配置最佳实践"><a href="#sysctl内核参数配置最佳实践" class="headerlink" title="sysctl内核参数配置最佳实践"></a>sysctl内核参数配置最佳实践</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sysctl -p</span>
<span class="line"><span class="comment">#----------------------------------------------</span></span>
<span class="line">net.ipv4.ip_forward = <span class="number">0</span></span>
<span class="line">net.ipv4.conf.default.rp_filter = <span class="number">0</span></span>
<span class="line">net.ipv4.conf.default.accept_source_route = <span class="number">0</span></span>
<span class="line">kernel.sysrq = <span class="number">0</span></span>
<span class="line">kernel.core_uses_pid = <span class="number">1</span></span>
<span class="line">kernel.msgmnb = <span class="number">65536</span></span>
<span class="line">kernel.msgmax = <span class="number">65536</span></span>
<span class="line">kernel.shmmax = <span class="number">4398046511104</span></span>
<span class="line">kernel.shmall = <span class="number">1073741824</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">1024</span> <span class="number">65000</span></span>
<span class="line">net.ipv4.tcp_tw_reuse = <span class="number">1</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">net.ipv4.tcp_syncookies = <span class="number">1</span></span>
<span class="line">net.ipv4.tcp_keepalive_time = <span class="number">1200</span></span>
<span class="line">net.ipv4.tcp_max_syn_backlog = <span class="number">4096</span></span>
<span class="line">net.core.netdev_max_backlog = <span class="number">2048</span></span>
<span class="line">net.ipv4.tcp_fin_timeout = <span class="number">15</span></span>
<span class="line">net.core.somaxconn = <span class="number">1024</span></span>
<span class="line">vm.swappiness = <span class="number">10</span></span>
<span class="line">vm.zone_reclaim_mode = <span class="number">0</span></span>
<span class="line">vm.extra_free_kbytes = <span class="number">2097152</span></span>
<span class="line"></span>
<span class="line">vm.nr_hugepages = <span class="number">20550</span></span>
<span class="line"><span class="comment">#----------------------------------------------</span></span>
<span class="line"></span>
<span class="line">net.ipv4.ip_forward = <span class="number">0</span>                          <span class="comment"># 禁止IP包转发</span></span>
<span class="line">net.ipv4.conf.default.rp_filter = <span class="number">0</span>              <span class="comment"># 避免伪装IP的攻击</span></span>
<span class="line">kernel.shmmax = <span class="number">4398046511104</span>                    <span class="comment"># 对mysql不生效，oracle用</span></span>
<span class="line">kernel.shmall = <span class="number">1073741824</span>                       <span class="comment"># 对mysql不生效，oracle用，不能小于SGA</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看os系统页的大小</span></span>
<span class="line">getconf PAGESIZE</span>
<span class="line"><span class="comment">#----------------------------------------------</span></span>
<span class="line"><span class="number">4096</span></span>
<span class="line"><span class="comment">#----------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 需要共享内存页数(假设SGA=16G)</span></span>
<span class="line"><span class="number">16</span>G/<span class="number">4</span>KB=<span class="number">16</span>*<span class="number">1024</span>*<span class="number">1024</span>/<span class="number">4</span>=<span class="number">16777216</span>KB/<span class="number">4</span>=<span class="number">4194304</span></span>
</pre></td></tr></table></figure>
<h3 id="调整操作系统预读"><a href="#调整操作系统预读" class="headerlink" title="调整操作系统预读"></a>调整操作系统预读</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">lspci -nn | <span class="keyword">grep</span> -i sata</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看预读设置</span></span>
<span class="line">cat /sys/block/sda/queue/read_ahead_kb </span>
<span class="line"><span class="number">4096</span></span>
<span class="line"><span class="comment"># 这个参数没有准确的答案，针对不同的应用场景有不同的合理值，这个不大适合统一标准化。</span></span>
</pre></td></tr></table></figure>
<h3 id="文件系统优化"><a href="#文件系统优化" class="headerlink" title="文件系统优化"></a>文件系统优化</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 格式化标准命令</span></span>
<span class="line">mkfs.xfs -f -iattr=<span class="number">2</span> -l lazy-count=<span class="number">1</span>,sectsize=<span class="number">4096</span> -b size=<span class="number">4096</span> -d sectsize=<span class="number">4096</span> -L data /dev/&lt;XXX&gt;</span>
<span class="line"><span class="comment"># mount标准命令</span></span>
<span class="line">mount -o rw,noatime,nodiratime,noikeep,nobarrier,allocsize=<span class="number">100</span>M,attr2,largeio,inode64,swalloc /dev/&lt;XXX&gt; <span class="regexp">/apps</span></span>
</pre></td></tr></table></figure>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a href="http://www.cnblogs.com/sopc-mc/archive/2011/10/09/2204858.html" target="_blank" rel="external">Linux I/O调度</a></p>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 03 MySQL服务器优化]]></title>
      <url>/2017/08/25/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/03-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%20/</url>
      <content type="html"><![CDATA[<h2 id="如何配置一个进程只跑在单个CPU上？"><a href="#如何配置一个进程只跑在单个CPU上？" class="headerlink" title="如何配置一个进程只跑在单个CPU上？"></a>如何配置一个进程只跑在单个CPU上？</h2><p>CPU性能调优方法之一：把进程或线程绑定在单个CPU上，这可以增加进程的CPU缓存速度，提高它的内存I/O性能。方法如下：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动MySQL，将该进程绑定到CPU1上</span></span>
<span class="line">taskset -c <span class="number">1</span> mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line"></span>
<span class="line"># 使用sysbench压测工具查看CPU绑定后效果</span>
<span class="line">drop database test;</span>
<span class="line">create database test;</span>
<span class="line"></span>
<span class="line">sysbench /usr</span><span class="regexp">/local/share</span><span class="regexp">/sysbench/tests</span><span class="regexp">/include/oltp</span>_legacy/select.lua \</span>
<span class="line">--oltp-table-size=<span class="number">100000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=test \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">20</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> prepare</span>
<span class="line"></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/select.lua \</span>
<span class="line">--oltp-table-size=<span class="number">100000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=test \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">20</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> run</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<p>使用<code>top</code>命令，查看每个CPU的负载(按1查看)，截图如下：<br><img src="http://oligvdnzp.bkt.clouddn.com/0825_mysql_01.png" alt=""><br>从上图中可以看出<code>MYSQL</code>的进程绑定到<code>CPU1</code>上了</p>
<h2 id="基于Linux中可用内存即将耗尽时为了释放更多内存会采取的步骤"><a href="#基于Linux中可用内存即将耗尽时为了释放更多内存会采取的步骤" class="headerlink" title="基于Linux中可用内存即将耗尽时为了释放更多内存会采取的步骤"></a>基于Linux中可用内存即将耗尽时为了释放更多内存会采取的步骤</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 释放前</span></span>
<span class="line">free -<span class="keyword">m</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span>
<span class="line">             total       used       free     shared    buffers     cached</span>
<span class="line">Mem:          <span class="number">7982</span>       <span class="number">5165</span>       <span class="number">2816</span>          <span class="number">0</span>        <span class="number">180</span>       <span class="number">3661</span></span>
<span class="line">-<span class="regexp">/+ buffers/cache</span>:       <span class="number">1324</span>       <span class="number">6658</span></span>
<span class="line">Swap:        <span class="number">16143</span>         <span class="number">19</span>      <span class="number">16124</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">cat /proc/sys/vm/drop_caches </span>
<span class="line"><span class="number">0</span></span>
<span class="line"></span>
<span class="line">sync</span>
<span class="line">echo <span class="number">3</span> &gt; <span class="regexp">/proc/sys</span><span class="regexp">/vm/drop</span>_caches</span>
<span class="line">cat /proc/sys/vm/drop_caches </span>
<span class="line"><span class="number">3</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># drop_caches 的值可以是 0-3 之间的数字，代表不同的含义：</span></span>
<span class="line"><span class="comment"># 0：不释放（系统默认值）</span></span>
<span class="line"><span class="comment"># 1：释放页缓存</span></span>
<span class="line"><span class="comment"># 2：释放 dentries 和 inodes</span></span>
<span class="line"><span class="comment"># 3：释放所有缓存</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 释放后</span></span>
<span class="line">free -<span class="keyword">m</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span>
<span class="line">             total       used       free     shared    buffers     cached</span>
<span class="line">Mem:          <span class="number">7982</span>       <span class="number">1196</span>       <span class="number">6785</span>          <span class="number">0</span>          <span class="number">2</span>         <span class="number">28</span></span>
<span class="line">-<span class="regexp">/+ buffers/cache</span>:       <span class="number">1165</span>       <span class="number">6816</span></span>
<span class="line">Swap:        <span class="number">16143</span>         <span class="number">19</span>      <span class="number">16124</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 释放完内存后改回去让系统重新自动分配内存。</span></span>
<span class="line">echo <span class="number">0</span> &gt;<span class="regexp">/proc/sys</span><span class="regexp">/vm/drop</span>_caches</span>
</pre></td></tr></table></figure>
<h2 id="逻辑I-O和物理I-O有什么区别？随机I-O和连续I-O有什么区别？"><a href="#逻辑I-O和物理I-O有什么区别？随机I-O和连续I-O有什么区别？" class="headerlink" title="逻辑I/O和物理I/O有什么区别？随机I/O和连续I/O有什么区别？"></a>逻辑I/O和物理I/O有什么区别？随机I/O和连续I/O有什么区别？</h2><h3 id="逻辑I-O和物理I-O区别"><a href="#逻辑I-O和物理I-O区别" class="headerlink" title="逻辑I/O和物理I/O区别"></a>逻辑I/O和物理I/O区别</h3><ul>
<li>逻辑I/O是指指读取内存中的数据</li>
<li>物理I/O是指直接读取物理磁盘中的文件</li>
</ul>
<h3 id="随机I-O和连续I-O区别"><a href="#随机I-O和连续I-O区别" class="headerlink" title="随机I/O和连续I/O区别"></a>随机I/O和连续I/O区别</h3><ul>
<li>随机I/O需要花费昂贵的磁头旋转和定位来查找</li>
<li>连续IO访问的速度远远快于随机IO</li>
<li>连续I/O一般只需扫描一次数据，缓存连续I/O的用处不大</li>
<li>缓存随机I/O可以节省更多的workload</li>
</ul>
<h2 id="描述一个网络接口工作超负荷会发生什么，包括对应用程序性能的影响。"><a href="#描述一个网络接口工作超负荷会发生什么，包括对应用程序性能的影响。" class="headerlink" title="描述一个网络接口工作超负荷会发生什么，包括对应用程序性能的影响。"></a>描述一个网络接口工作超负荷会发生什么，包括对应用程序性能的影响。</h2><p>ping值过高，丢包严重，应用程序连接访问缓慢</p>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><h3 id="解决free内存不足和numa架构内存分配不均"><a href="#解决free内存不足和numa架构内存分配不均" class="headerlink" title="解决free内存不足和numa架构内存分配不均"></a>解决free内存不足和numa架构内存分配不均</h3><ol>
<li>保证系统有足够多free内存，这个可以通过设置内存参数<ul>
<li>vm.min_free_kbytes= NNNNN    当系统free内存少于这个时，内核会启动回收内存，进程在分配内存时也会启动回收内存</li>
<li>vm.extra_free_kbytes= NNNNN  当系统free内存少于这个时，内核会从pagecache回收内存（用户进程不会回收内存）</li>
</ul>
</li>
<li>在突然大量连接到来之前保留足够free内存</li>
<li>采用交叉内存分配模式启动mysql或其它需要大内存的系统，保持多个节点之间内存分配平衡<code>numactl--interleave all command</code></li>
<li>优化mysql的%buffer%等参数内存分配，避免过大不合理参数</li>
</ol>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /proc/cpuinfo | <span class="keyword">grep</span> name | cut -f2 -d: | uniq -c</span>
<span class="line">      <span class="number">8</span>  Intel(R) Xeon(R) CPU E5-<span class="number">2640</span> v3 @ <span class="number">2.60</span>GHz</span>
<span class="line"></span>
<span class="line">numactl --hardware</span>
<span class="line"></span>
<span class="line"><span class="comment"># 内存带宽计算工具</span></span>
<span class="line">/ptu40_005_lin_intel64/bin/vtbwrun-c -A</span>
<span class="line"></span>
<span class="line"><span class="comment"># 下载地址：</span></span>
<span class="line"><span class="comment"># http://www.processorportal.com/Download_Intel_Performance_Tuning_Utility_4_0_Update_5/tree3f-aggregator_news_item--103398-/</span></span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CentOS7下MySQL5.7的安装-RPM方式]]></title>
      <url>/2017/08/23/mysql/20170823_CentOS7%E4%B8%8BMySQL57%E7%9A%84%E5%AE%89%E8%A3%85-RPM/</url>
      <content type="html"><![CDATA[<h2 id="Installing-MySQL-on-Linux-Using-RPM-Packages"><a href="#Installing-MySQL-on-Linux-Using-RPM-Packages" class="headerlink" title="Installing MySQL on Linux Using RPM Packages"></a>Installing MySQL on Linux Using RPM Packages</h2><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><p>mysql下载地址：<a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="external">https://dev.mysql.com/downloads/mysql/</a><br><img src="http://oligvdnzp.bkt.clouddn.com/0823_mysql_01.png" alt=""></p>
<a id="more"></a>
<h3 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 禁用SELINUX</span></span>
<span class="line">setenforce <span class="number">0</span></span>
<span class="line">vi /etc/selinux/config</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line">SELINUX=disabled</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 禁用防火墙</span></span>
<span class="line">systemctl disable firewalld</span>
<span class="line">systemctl stop firewalld</span>
<span class="line">systemctl status firewalld</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置内核参数(mysql需要)</span></span>
<span class="line">vi /etc/sysctl.d/<span class="number">99</span>-sysctl.conf</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line">kernel.shmmax = <span class="number">2199023255552</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line"><span class="comment"># kernel.shmmax算法：修改为物理内容的50%、60%</span></span>
<span class="line"><span class="comment"># 4G:kernel.shmmax = (4G*1024*1024*1024*1024)*50% = 2199023255552</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 使内核参数生效</span></span>
<span class="line">sysctl -p</span>
</pre></td></tr></table></figure>
<h3 id="使用RPM包安装mysql"><a href="#使用RPM包安装mysql" class="headerlink" title="使用RPM包安装mysql"></a>使用RPM包安装mysql</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装新版mysql之前，我们需要将系统自带的mariadb-lib卸载</span></span>
<span class="line">rpm -qa | <span class="keyword">grep</span> mariadb-lib</span>
<span class="line">rpm -e --nodeps mariadb-libs-<span class="number">5.5</span>.<span class="number">52</span>-<span class="number">1</span>.el7.x86_64</span>
<span class="line"></span>
<span class="line"><span class="comment"># 安装需要的工具包</span></span>
<span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line">mount /dev/cdrom /media/disk</span>
<span class="line"></span>
<span class="line">cd /etc/yum.repos.d/</span>
<span class="line">cp CentOS-Base.repo CentOS-Base.repo_bak</span>
<span class="line">vi CentOS-Base.repo</span>
<span class="line">[<span class="keyword">local</span>]</span>
<span class="line">name=CentOS-$releasever - Local</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span></span>
<span class="line">gpgcheck=<span class="number">0</span></span>
<span class="line">enabled=<span class="number">1</span></span>
<span class="line"></span>
<span class="line">yum -<span class="keyword">y</span> install lrzsz unzip</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用rz工具上传安装包后</span></span>
<span class="line">cd /tmp</span>
<span class="line">rz</span>
<span class="line"></span>
<span class="line">tar xvpf  mysql-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm-bundle.tar</span>
<span class="line">mysql-community-embedded-devel-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-client-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-server-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-test-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-embedded-compat-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-minimal-debuginfo-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-server-minimal-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-libs-compat-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-common-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-embedded-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-devel-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">mysql-community-libs-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 把不需要安装的包删除</span></span>
<span class="line">rm -rf mysql-community-embedded-devel-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">rm -rf mysql-community-test-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">rm -rf mysql-community-embedded-compat-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">rm -rf mysql-community-minimal-debuginfo-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">rm -rf mysql-community-server-minimal-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">rm -rf mysql-community-embedded-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line">rm -rf mysql-community-devel-<span class="number">5.7</span>.<span class="number">19</span>-<span class="number">1</span>.el7.x86_64.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 开始安装，依赖包会自动安装</span></span>
<span class="line">yum install mysql-community-&#123;server,client,common,libs&#125;-*</span>
<span class="line"></span>
<span class="line">yum install mysql-commercial-&#123;server,client,common,libs&#125;-*</span>
</pre></td></tr></table></figure>
<h3 id="使用RPM包标准安装mysql，相关文件在以下系统目录"><a href="#使用RPM包标准安装mysql，相关文件在以下系统目录" class="headerlink" title="使用RPM包标准安装mysql，相关文件在以下系统目录"></a>使用RPM包标准安装mysql，相关文件在以下系统目录</h3><table>
<thead>
<tr>
<th style="text-align:left">Files or Resources</th>
<th style="text-align:left">Location</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Client programs and scripts</td>
<td style="text-align:left">/usr/bin</td>
</tr>
<tr>
<td style="text-align:left">mysqld server</td>
<td style="text-align:left">/usr/sbin</td>
</tr>
<tr>
<td style="text-align:left">Configuration file</td>
<td style="text-align:left">/etc/my.cnf</td>
</tr>
<tr>
<td style="text-align:left">Data directory</td>
<td style="text-align:left">/var/lib/mysql</td>
</tr>
<tr>
<td style="text-align:left">Error log file</td>
<td style="text-align:left">For RHEL, Oracle Linux, CentOS or Fedora platforms: <br>/var/log/mysqld.log<br>For SLES: /var/log/mysql/mysqld.log</td>
</tr>
<tr>
<td style="text-align:left">Value of secure_file_priv</td>
<td style="text-align:left">/var/lib/mysql-files</td>
</tr>
<tr>
<td style="text-align:left">System V init script</td>
<td style="text-align:left">For RHEL, Oracle Linux, CentOS or Fedora platforms: <br>/etc/init.d/mysqld<br>For SLES: /etc/init.d/mysql</td>
</tr>
<tr>
<td style="text-align:left">Systemd service</td>
<td style="text-align:left">For RHEL, Oracle Linux, CentOS or Fedora platforms: mysqld<br>For SLES: mysql</td>
</tr>
<tr>
<td style="text-align:left">Pid file</td>
<td style="text-align:left">/var/run/mysql/mysqld.pid</td>
</tr>
<tr>
<td style="text-align:left">Socket</td>
<td style="text-align:left">/var/lib/mysql/mysql.sock</td>
</tr>
<tr>
<td style="text-align:left">Keyring directory</td>
<td style="text-align:left">/var/lib/mysql-keyring</td>
</tr>
<tr>
<td style="text-align:left">Unix manual pages</td>
<td style="text-align:left">/usr/share/man</td>
</tr>
<tr>
<td style="text-align:left">Include (header) files</td>
<td style="text-align:left">/usr/include/mysql</td>
</tr>
<tr>
<td style="text-align:left">Libraries</td>
<td style="text-align:left">/usr/lib/mysql</td>
</tr>
<tr>
<td style="text-align:left">Miscellaneous support files <br>(for example, error messages, and character set files)</td>
<td style="text-align:left">/usr/share/mysql</td>
</tr>
</tbody>
</table>
<h3 id="启动mysql"><a href="#启动mysql" class="headerlink" title="启动mysql"></a>启动mysql</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 以下两个命令都可以</span></span>
<span class="line">service mysqld start</span>
<span class="line">systemctl start mysqld.service</span>
</pre></td></tr></table></figure>
<h3 id="查看并登陆修改初始的root密码"><a href="#查看并登陆修改初始的root密码" class="headerlink" title="查看并登陆修改初始的root密码"></a>查看并登陆修改初始的root密码</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">grep</span> <span class="string">'temporary password'</span> /var/<span class="keyword">log</span>/mysqld.log</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line"><span class="number">2017</span>-08-<span class="number">23</span>T05:<span class="number">56</span>:<span class="number">38.197060</span>Z <span class="number">1</span> [Note] A temporary password is generated <span class="keyword">for</span> root@localhost: gi._hyg/f2oJ</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line"></span>
<span class="line">mysql -uroot -p</span>
<span class="line"></span>
<span class="line"><span class="comment"># 以下两个命令都可以修改root密码</span></span>
<span class="line">alter user <span class="string">'root'</span>@'localhost<span class="string">' identified by '</span>Center08+<span class="string">';</span>
<span class="line">set password for root@localhost = password('</span>Center08+<span class="string">');</span></span>
</pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 02 MySQL数据库性能衡量]]></title>
      <url>/2017/08/19/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/02-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="测试服务器（或虚拟机）的QPS峰值"><a href="#测试服务器（或虚拟机）的QPS峰值" class="headerlink" title="测试服务器（或虚拟机）的QPS峰值"></a>测试服务器（或虚拟机）的QPS峰值</h2><h3 id="利用sysbench压测工具模拟SELECT操作"><a href="#利用sysbench压测工具模拟SELECT操作" class="headerlink" title="利用sysbench压测工具模拟SELECT操作"></a>利用sysbench压测工具模拟SELECT操作</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 已有test库的话先drop掉</span></span>
<span class="line">drop database test;</span>
<span class="line">create database test;</span>
<span class="line"></span>
<span class="line"><span class="comment"># prepare准备阶段，构建压测环境</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/select.lua \</span>
<span class="line">--oltp-table-size=<span class="number">20000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=test \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">20</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> prepare</span>
<span class="line"></span>
<span class="line"><span class="comment"># 开始压测</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/select.lua \</span>
<span class="line">--oltp-table-size=<span class="number">20000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=test \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">20</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> run</span>
<span class="line"></span>
<span class="line">sysbench <span class="number">1.0</span>.<span class="number">5</span> (using bundled LuaJIT <span class="number">2.1</span>.<span class="number">0</span>-beta2)</span>
<span class="line"></span>
<span class="line">Running the test with following options:</span>
<span class="line">Number of threads: <span class="number">2</span></span>
<span class="line">Report intermediate results every <span class="number">10</span> second(<span class="keyword">s</span>)</span>
<span class="line">Initializing random number generator from current <span class="keyword">time</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Initializing worker threads...</span>
<span class="line"></span>
<span class="line">Threads started!</span>
<span class="line"></span>
<span class="line">[ <span class="number">10</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">8087.29</span> qps: <span class="number">8087.29</span> (r/w/o: <span class="number">8087.29</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">34</span> err/ <span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span> reconn/<span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">20</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">6949.28</span> qps: <span class="number">6949.28</span> (r/w/o: <span class="number">6949.28</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">35</span> err/ <span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span> reconn/<span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">30</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">7251.71</span> qps: <span class="number">7251.71</span> (r/w/o: <span class="number">7251.71</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">34</span> err/ <span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span> reconn/<span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">40</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">6927.19</span> qps: <span class="number">6927.19</span> (r/w/o: <span class="number">6927.19</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">35</span> err/ <span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span> reconn/<span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">50</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">7387.64</span> qps: <span class="number">7387.64</span> (r/w/o: <span class="number">7387.64</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">32</span> err/ <span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span> reconn/<span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">60</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">10171.21</span> qps: <span class="number">10171.21</span> (r/w/o: <span class="number">10171.21</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">26</span> err/ <span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span> reconn/<span class="keyword">s</span>: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">SQL statistics:</span>
<span class="line">    queries performed:</span>
<span class="line">        <span class="keyword">read</span>:                            <span class="number">467780</span></span>
<span class="line">        <span class="keyword">write</span>:                           <span class="number">0</span></span>
<span class="line">        other:                           <span class="number">0</span></span>
<span class="line">        total:                           <span class="number">467780</span></span>
<span class="line">    transactions:                        <span class="number">467780</span> (<span class="number">7795.29</span> per sec.)</span>
<span class="line">    queries:                             <span class="number">467780</span> (<span class="number">7795.29</span> per sec.)</span>
<span class="line">    ignored errors:                      <span class="number">0</span>      (<span class="number">0</span>.<span class="number">00</span> per sec.)</span>
<span class="line">    reconnects:                          <span class="number">0</span>      (<span class="number">0</span>.<span class="number">00</span> per sec.)</span>
<span class="line"></span>
<span class="line">General statistics:</span>
<span class="line">    total <span class="keyword">time</span>:                          <span class="number">60.0008</span><span class="keyword">s</span></span>
<span class="line">    total number of events:              <span class="number">467780</span></span>
<span class="line"></span>
<span class="line">Latency (ms):</span>
<span class="line">         min:                                  <span class="number">0</span>.<span class="number">11</span></span>
<span class="line">         avg:                                  <span class="number">0</span>.<span class="number">25</span></span>
<span class="line">         max:                                 <span class="number">27.63</span></span>
<span class="line">         <span class="number">95</span>th percentile:                      <span class="number">0</span>.<span class="number">34</span></span>
<span class="line">         sum:                             <span class="number">119092.82</span></span>
<span class="line"></span>
<span class="line">Threads fairness:</span>
<span class="line">    events (avg/stddev):           <span class="number">233890.0000</span>/<span class="number">242.00</span></span>
<span class="line">    execution <span class="keyword">time</span> (avg/stddev):   <span class="number">59.5464</span>/<span class="number">0</span>.<span class="number">00</span></span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="使用orzdba工具实际查看"><a href="#使用orzdba工具实际查看" class="headerlink" title="使用orzdba工具实际查看"></a>使用orzdba工具实际查看</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">[mysql@mydb1 ~]$ ./orzdba -lazy</span>
<span class="line"></span>
<span class="line">.=================================================.</span>
<span class="line">|       Welcome to <span class="keyword">use</span> the orzdba tool !          | </span>
<span class="line">|          Yep...Chinese English~                 |</span>
<span class="line"><span class="string">'=============== Date : 2017-08-20 ==============='</span></span>
<span class="line"></span>
<span class="line">HOST: mydb1   IP: <span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">DB  : lyj|performance_schema</span>
<span class="line">Var : port[<span class="number">3306</span>] read_only[OFF] version[<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span>] </span>
<span class="line">      </span>
<span class="line">      binlog_format[ROW] max_binlog_cache_size[<span class="number">4</span>G] max_binlog_size[<span class="number">500</span>M] </span>
<span class="line">      max_connect_errors[<span class="number">100</span>] max_connections[<span class="number">214</span>] max_user_connections[<span class="number">2800</span>] </span>
<span class="line">      open_files_limit[<span class="number">1024</span>] sync_binlog[<span class="number">100</span>] table_definition_cache[<span class="number">600</span>] </span>
<span class="line">      table_open_cache[<span class="number">400</span>] thread_cache_size[<span class="number">10</span>] </span>
<span class="line"></span>
<span class="line">      innodb_adaptive_flushing[ON] innodb_adaptive_hash_index[ON] innodb_buffer_pool_instances[<span class="number">8</span>] </span>
<span class="line">      innodb_buffer_pool_size[<span class="number">4</span>G] innodb_file_per_table[ON] innodb_flush_log_at_trx_commit[<span class="number">1</span>] </span>
<span class="line">      innodb_flush_method[O_DIRECT] innodb_io_capacity[<span class="number">1000</span>] innodb_lock_wait_timeout[<span class="number">10</span>] </span>
<span class="line">      innodb_log_buffer_size[<span class="number">64</span>M] innodb_log_file_size[<span class="number">1000</span>M] innodb_log_files_in_group[<span class="number">4</span>] </span>
<span class="line">      innodb_max_dirty_pages_pct[<span class="number">60</span>] innodb_open_files[<span class="number">400</span>] innodb_read_io_threads[<span class="number">4</span>] </span>
<span class="line">      innodb_stats_on_metadata[OFF] innodb_thread_concurrency[<span class="number">0</span>] innodb_write_io_threads[<span class="number">10</span>] </span>
<span class="line">      </span>
<span class="line"></span>
<span class="line">-------- -----load-avg---- ---cpu-usage--- ---swap---                     -QPS- -TPS-         -Hit%- ------threads------ </span>
<span class="line">  <span class="keyword">time</span>  |  <span class="number">1</span><span class="keyword">m</span>    <span class="number">5</span><span class="keyword">m</span>   <span class="number">15</span><span class="keyword">m</span> |usr sys idl iow|   si   so|  ins   upd   del    sel   iud|     lor    hit| run  con  cre  cac|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">25</span>| <span class="number">0</span>.<span class="number">07</span>  <span class="number">0</span>.<span class="number">04</span>  <span class="number">0</span>.<span class="number">05</span>|  <span class="number">0</span>   <span class="number">0</span> <span class="number">100</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>      <span class="number">0</span>     <span class="number">0</span>|       <span class="number">0</span> <span class="number">100.00</span>|   <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">28</span>| <span class="number">0</span>.<span class="number">14</span>  <span class="number">0</span>.<span class="number">06</span>  <span class="number">0</span>.<span class="number">05</span>|  <span class="number">8</span>   <span class="number">2</span>  <span class="number">90</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">7178</span>     <span class="number">0</span>|   <span class="number">15417</span> <span class="number">100.00</span>|   <span class="number">3</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">31</span>| <span class="number">0</span>.<span class="number">13</span>  <span class="number">0</span>.<span class="number">06</span>  <span class="number">0</span>.<span class="number">05</span>|  <span class="number">6</span>   <span class="number">3</span>  <span class="number">91</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">6757</span>     <span class="number">0</span>|   <span class="number">14528</span> <span class="number">100.00</span>|   <span class="number">4</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">34</span>| <span class="number">0</span>.<span class="number">13</span>  <span class="number">0</span>.<span class="number">06</span>  <span class="number">0</span>.<span class="number">05</span>|  <span class="number">7</span>   <span class="number">2</span>  <span class="number">91</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">6679</span>     <span class="number">0</span>|   <span class="number">14342</span> <span class="number">100.00</span>|   <span class="number">4</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">37</span>| <span class="number">0</span>.<span class="number">12</span>  <span class="number">0</span>.<span class="number">06</span>  <span class="number">0</span>.<span class="number">05</span>|  <span class="number">7</span>   <span class="number">3</span>  <span class="number">90</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">7569</span>     <span class="number">0</span>|   <span class="number">16285</span> <span class="number">100.00</span>|   <span class="number">2</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">40</span>| <span class="number">0</span>.<span class="number">12</span>  <span class="number">0</span>.<span class="number">06</span>  <span class="number">0</span>.<span class="number">05</span>|  <span class="number">8</span>   <span class="number">2</span>  <span class="number">90</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">7298</span>     <span class="number">0</span>|   <span class="number">15707</span> <span class="number">100.00</span>|   <span class="number">3</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">43</span>| <span class="number">0</span>.<span class="number">19</span>  <span class="number">0</span>.<span class="number">07</span>  <span class="number">0</span>.<span class="number">06</span>|  <span class="number">8</span>   <span class="number">2</span>  <span class="number">90</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">7668</span>     <span class="number">0</span>|   <span class="number">16498</span> <span class="number">100.00</span>|   <span class="number">2</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">46</span>| <span class="number">0</span>.<span class="number">18</span>  <span class="number">0</span>.<span class="number">07</span>  <span class="number">0</span>.<span class="number">06</span>|  <span class="number">8</span>   <span class="number">2</span>  <span class="number">91</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">9787</span>     <span class="number">0</span>|   <span class="number">21050</span> <span class="number">100.00</span>|   <span class="number">2</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">49</span>| <span class="number">0</span>.<span class="number">18</span>  <span class="number">0</span>.<span class="number">07</span>  <span class="number">0</span>.<span class="number">06</span>|  <span class="number">8</span>   <span class="number">2</span>  <span class="number">91</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>  <span class="number">11045</span>     <span class="number">0</span>|   <span class="number">23759</span> <span class="number">100.00</span>|   <span class="number">2</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"><span class="number">15</span>:<span class="number">51</span>:<span class="number">52</span>| <span class="number">0</span>.<span class="number">24</span>  <span class="number">0</span>.09  <span class="number">0</span>.<span class="number">06</span>|  <span class="number">8</span>   <span class="number">2</span>  <span class="number">90</span>   <span class="number">0</span>|    <span class="number">0</span>    <span class="number">0</span>|    <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span>   <span class="number">9709</span>     <span class="number">0</span>|   <span class="number">20881</span> <span class="number">100.00</span>|   <span class="number">2</span>    <span class="number">4</span>    <span class="number">0</span>    <span class="number">0</span>|</span>
<span class="line"></span>
<span class="line"><span class="comment"># 从上面可以看出QPS峰值大约在1万</span></span>
</pre></td></tr></table></figure>
<h3 id="利用ZABBIX监控工具观察QPS"><a href="#利用ZABBIX监控工具观察QPS" class="headerlink" title="利用ZABBIX监控工具观察QPS"></a>利用ZABBIX监控工具观察QPS</h3><p>zabbix自带的mysql模板共可监测以下14项，图形化查看方法如下<br><img src="http://oligvdnzp.bkt.clouddn.com/0820_mysql_02.png" alt=""></p>
<p>点”MySQL queries per second”项的Graph”就可以图形化观察QPS了<br><img src="http://oligvdnzp.bkt.clouddn.com/0820_mysql_01.png" alt=""></p>
<h2 id="重现MySQL主从复制延迟的场景"><a href="#重现MySQL主从复制延迟的场景" class="headerlink" title="重现MySQL主从复制延迟的场景"></a>重现MySQL主从复制延迟的场景</h2><h3 id="查看主从库状态"><a href="#查看主从库状态" class="headerlink" title="查看主从库状态"></a>查看主从库状态</h3><p>比较主库的<code>Position</code>和从库的<code>Read_Master_Log_Po</code>s和<code>Exec_Master_Log_Pos</code>是不是相同，以下相同说明没有延迟<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主库状态</span></span>
<span class="line">mysql&gt; show master status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000031</span></span>
<span class="line">         Position: <span class="number">458032215</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 从库状态</span></span>
<span class="line">mysql&gt; show slave status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000031</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">458032215</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">458032375</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000031</span></span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: Yes</span>
<span class="line">              Replicate_Do_DB: </span>
<span class="line">          Replicate_Ignore_DB: </span>
<span class="line">           Replicate_Do_Table: </span>
<span class="line">       Replicate_Ignore_Table: </span>
<span class="line">      Replicate_Wild_Do_Table: </span>
<span class="line">  Replicate_Wild_Ignore_Table: </span>
<span class="line">                   Last_Errno: <span class="number">0</span></span>
<span class="line">                   Last_Error: </span>
<span class="line">                 Skip_Counter: <span class="number">0</span></span>
<span class="line">          Exec_Master_Log_Pos: <span class="number">458032215</span></span>
<span class="line">              Relay_Log_Space: <span class="number">458032541</span></span>
<span class="line">              Until_Condition: None</span>
<span class="line">               Until_Log_File: </span>
<span class="line">                Until_Log_Pos: <span class="number">0</span></span>
<span class="line">           Master_SSL_Allowed: No</span>
<span class="line">           Master_SSL_CA_File: </span>
<span class="line">           Master_SSL_CA_Path: </span>
<span class="line">              Master_SSL_Cert: </span>
<span class="line">            Master_SSL_Cipher: </span>
<span class="line">               Master_SSL_Key: </span>
<span class="line">        Seconds_Behind_Master: <span class="number">0</span></span>
<span class="line">Master_SSL_Verify_Server_Cert: No</span>
<span class="line">                Last_IO_Errno: <span class="number">0</span></span>
<span class="line">                Last_IO_Error: </span>
<span class="line">               Last_SQL_Errno: <span class="number">0</span></span>
<span class="line">               Last_SQL_Error: </span>
<span class="line">  Replicate_Ignore_Server_Ids: </span>
<span class="line">             Master_Server_Id: <span class="number">101</span></span>
<span class="line">                  Master_UUID: <span class="number">337</span>aaf35-<span class="number">1</span>b73-<span class="number">11</span>e7-<span class="number">8</span>b3<span class="number">0</span>-<span class="number">005056</span>a01c3e</span>
<span class="line">             Master_Info_File: <span class="regexp">/u01/data</span><span class="regexp">/3306/master</span>.info</span>
<span class="line">                    SQL_Delay: <span class="number">0</span></span>
<span class="line">          SQL_Remaining_Delay: NULL</span>
<span class="line">      Slave_SQL_Running_State: Slave has <span class="keyword">read</span> all relay <span class="keyword">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it</span>
<span class="line">           Master_Retry_Count: <span class="number">86400</span></span>
<span class="line">                  Master_Bind: </span>
<span class="line">      Last_IO_Error_Timestamp: </span>
<span class="line">     Last_SQL_Error_Timestamp: </span>
<span class="line">               Master_SSL_Crl: </span>
<span class="line">           Master_SSL_Crlpath: </span>
<span class="line">           Retrieved_Gtid_Set: </span>
<span class="line">            Executed_Gtid_Set: </span>
<span class="line">                Auto_Position: <span class="number">0</span></span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure></p>
<h3 id="用sysbench工具做大批量的insert"><a href="#用sysbench工具做大批量的insert" class="headerlink" title="用sysbench工具做大批量的insert"></a>用sysbench工具做大批量的insert</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建数据库</span></span>
<span class="line">mysql&gt; drop database lyj;</span>
<span class="line">mysql&gt; create database lyj;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 用sysbench工具准备测试环境</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/insert.lua \</span>
<span class="line">--oltp-table-size=<span class="number">1000000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=lyj \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">2</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> prepare</span>
</pre></td></tr></table></figure>
<h3 id="查看从库状态"><a href="#查看从库状态" class="headerlink" title="查看从库状态"></a>查看从库状态</h3><p>在insert过程中，从库的<code>Read_Master_Log_Pos</code>和<code>Exec_Master_Log_Pos</code>出现不相同现象，表明MySQL主从复制有延迟<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show slave status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Queueing master event to the relay <span class="keyword">log</span></span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000031</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">524289249</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">458032683</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000031</span></span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: Yes</span>
<span class="line">              Replicate_Do_DB: </span>
<span class="line">          Replicate_Ignore_DB: </span>
<span class="line">           Replicate_Do_Table: </span>
<span class="line">       Replicate_Ignore_Table: </span>
<span class="line">      Replicate_Wild_Do_Table: </span>
<span class="line">  Replicate_Wild_Ignore_Table: </span>
<span class="line">                   Last_Errno: <span class="number">0</span></span>
<span class="line">                   Last_Error: </span>
<span class="line">                 Skip_Counter: <span class="number">0</span></span>
<span class="line">          Exec_Master_Log_Pos: <span class="number">458032523</span></span>
<span class="line">              Relay_Log_Space: <span class="number">524289857</span></span>
<span class="line">              Until_Condition: None</span>
<span class="line">               Until_Log_File: </span>
<span class="line">                Until_Log_Pos: <span class="number">0</span></span>
<span class="line">           Master_SSL_Allowed: No</span>
<span class="line">           Master_SSL_CA_File: </span>
<span class="line">           Master_SSL_CA_Path: </span>
<span class="line">              Master_SSL_Cert: </span>
<span class="line">            Master_SSL_Cipher: </span>
<span class="line">               Master_SSL_Key: </span>
<span class="line">        Seconds_Behind_Master: <span class="number">22</span></span>
<span class="line">Master_SSL_Verify_Server_Cert: No</span>
<span class="line">                Last_IO_Errno: <span class="number">0</span></span>
<span class="line">                Last_IO_Error: </span>
<span class="line">               Last_SQL_Errno: <span class="number">0</span></span>
<span class="line">               Last_SQL_Error: </span>
<span class="line">  Replicate_Ignore_Server_Ids: </span>
<span class="line">             Master_Server_Id: <span class="number">101</span></span>
<span class="line">                  Master_UUID: <span class="number">337</span>aaf35-<span class="number">1</span>b73-<span class="number">11</span>e7-<span class="number">8</span>b3<span class="number">0</span>-<span class="number">005056</span>a01c3e</span>
<span class="line">             Master_Info_File: <span class="regexp">/u01/data</span><span class="regexp">/3306/master</span>.info</span>
<span class="line">                    SQL_Delay: <span class="number">0</span></span>
<span class="line">          SQL_Remaining_Delay: NULL</span>
<span class="line">      Slave_SQL_Running_State: Reading event from the relay <span class="keyword">log</span></span>
<span class="line">           Master_Retry_Count: <span class="number">86400</span></span>
<span class="line">                  Master_Bind: </span>
<span class="line">      Last_IO_Error_Timestamp: </span>
<span class="line">     Last_SQL_Error_Timestamp: </span>
<span class="line">               Master_SSL_Crl: </span>
<span class="line">           Master_SSL_Crlpath: </span>
<span class="line">           Retrieved_Gtid_Set: </span>
<span class="line">            Executed_Gtid_Set: </span>
<span class="line">                Auto_Position: <span class="number">0</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL性能优化最佳实践 - 01 MySQL优化方法论]]></title>
      <url>/2017/08/04/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/01-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/</url>
      <content type="html"><![CDATA[<h2 id="MySQL优化方法的关键是？"><a href="#MySQL优化方法的关键是？" class="headerlink" title="MySQL优化方法的关键是？"></a>MySQL优化方法的关键是？</h2><ul>
<li>MySQL参数优化，innodb_buffer_pool_size/innodb_flush_log_at_trx_commit/sync_binlog</li>
<li>SQL开发规范</li>
<li>分库分表</li>
</ul>
<a id="more"></a>
<h2 id="如何权衡吞吐率-Throughput-和延时-Latency-？"><a href="#如何权衡吞吐率-Throughput-和延时-Latency-？" class="headerlink" title="如何权衡吞吐率(Throughput) 和延时(Latency)？"></a>如何权衡吞吐率(Throughput) 和延时(Latency)？</h2><ul>
<li>吞吐率：一般使用单位时间内服务器处理的请求数来描述其并发处理能力,称之为吞吐率（Throughput），单位是<code>req/s</code>。吞吐率特指Web服务器单位时间内处理的请求数。</li>
<li>延时：延时是描述操作里用来等待服务的时间。在某些情况下，它可以指的是整个操作时间，等同于响应时间。例如，一次应用程序请求、一次数据库查询、一次文件系统操作，等等。举个例子，延时可以表示从点击链接<br>到屏幕显示整个网页加载完成的时间。</li>
<li>目标：在用户能够接受的延时下，尽可能的提高吞吐量。</li>
</ul>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0804_mysql_01.png" alt=""></p>
<h2 id="如何理解5分钟法则和临近法则？"><a href="#如何理解5分钟法则和临近法则？" class="headerlink" title="如何理解5分钟法则和临近法则？"></a>如何理解5分钟法则和临近法则？</h2><ul>
<li>5分钟法则：数据访问过一次，如果要在5分钟之内再次被访问到，就把数据缓存起来。提高资源利用率，降低成本。MySQL中buffer pool就应用了5分钟法则。</li>
<li>临近法则：数据被访问之后，跟该数据相连的数据被访问的概率很大，所以把相连的一些数据都预读缓存起来，下次访问相连数据时就可从缓存里找到，提高了效率。</li>
</ul>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0804_mysql_02.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> MySQL性能优化最佳实践 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[按SQLID一键获取执行计划索引分区等信息的脚本]]></title>
      <url>/2017/07/28/oracle/Scripts/%E6%8C%89SQLID%E4%B8%80%E9%94%AE%E8%8E%B7%E5%8F%96%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E7%B4%A2%E5%BC%95%E5%88%86%E5%8C%BA%E7%AD%89%E4%BF%A1%E6%81%AF%E7%9A%84%E8%84%9A%E6%9C%AC/</url>
      <content type="html"><![CDATA[<p>按SQLID一键获取执行计划索引分区等信息的脚本<br><a id="more"></a><br>以下内容放<code>spoolsql.sql</code>中，在sqlplus中执行，相关信息会自动生成html文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set term off</span>
<span class="line">set termout off</span>
<span class="line">set heading on</span>
<span class="line">set feedback off</span>
<span class="line">set verify off</span>
<span class="line">set echo off</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">/*</span>
<span class="line">功能说明：</span>
<span class="line">   输入SQL_ID、spool路径。</span>
<span class="line">   输出与SQL相关的信息，spool到指定文件。</span>
<span class="line">*<span class="regexp">/</span>
<span class="line"></span>
<span class="line">set term on</span>
<span class="line">set termout on</span>
<span class="line">set heading off</span>
<span class="line">set feedback off</span>
<span class="line">set verify off</span>
<span class="line">set echo off</span>
<span class="line"></span>
<span class="line">SET markup html off spool ON pre off entmap off</span>
<span class="line"></span>
<span class="line">set define ^</span>
<span class="line">var sqlid varchar2(50);</span>
<span class="line">var outputdir varchar2(256);</span>
<span class="line">prompt "input sqlid:"</span>
<span class="line">define tmp_sqlid=^SQL_ID</span>
<span class="line">exec :sqlid := '^tmp_sqlid'</span>
<span class="line">column outputdir_sqlid new_value outputfile</span>
<span class="line">select './</span><span class="string">'||:sqlid||'</span>.html<span class="string">' as outputdir_sqlid from dual;</span>
<span class="line"></span>
<span class="line">SET markup html off spool ON pre off entmap off</span>
<span class="line"></span>
<span class="line">set term off</span>
<span class="line">set termout off</span>
<span class="line">set heading off</span>
<span class="line">set feedback off</span>
<span class="line">set verify off</span>
<span class="line">set trimspool on</span>
<span class="line">set trim on</span>
<span class="line">set echo off</span>
<span class="line"></span>
<span class="line">set linesize 32767</span>
<span class="line">set pagesize 999999</span>
<span class="line">set serveroutput on</span>
<span class="line"></span>
<span class="line">spool ^^outputfile</span>
<span class="line">declare</span>
<span class="line">  type refcursor is ref cursor;</span>
<span class="line">  vCur          refcursor;</span>
<span class="line">  vsqlid        varchar2(4000) := :sqlid;</span>
<span class="line">  vOwnerstr     varchar2(32767) := '</span><span class="string">';</span>
<span class="line">  vOwnerCnt     number(3) := 0;</span>
<span class="line">  vTableStr     varchar2(32767) := '</span><span class="string">';</span>
<span class="line">  vTableCnt     number(3) := 0;</span>
<span class="line">  vtmpchldnum   number;</span>
<span class="line">  vtmpplnval    number;</span>
<span class="line">  type VARCHARTAB is table of varchar2(32767) index by BINARY_INTEGER;</span>
<span class="line">  vPlanAddition VARCHARTAB;</span>
<span class="line">  arr_iter BINARY_INTEGER;</span>
<span class="line">  vsqltxt_c clob;</span>
<span class="line">  vsqltxt_a dbms_sql.varchar2a;</span>
<span class="line">  vsqltxt_lb number(1):= 0;</span>
<span class="line">  vsqltxt_le number(12);</span>
<span class="line">  vsqlcur number;</span>
<span class="line">  vsqlmsg varchar2(4000);</span>
<span class="line">begin</span>
<span class="line">  ----打开服务器output</span>
<span class="line">  dbms_output.enable(10000000000000);</span>
<span class="line">  </span>
<span class="line">  ----打印html头和样式</span>
<span class="line">  dbms_output.put_line('</span>&lt;html&gt;&lt;title&gt;Reports About SQL:<span class="string">'||vsqlid||'</span>&lt;<span class="regexp">/title&gt;&lt;head&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;style&gt;');</span>
<span class="line">  </span>
<span class="line">  dbms_output.put_line('th &#123;font:bold 8pt Arial,Helvetica,Geneva,sans-serif; color:White; background:#0066CC;padding-left:4px; padding-right:4px;padding-bottom:2px&#125;');</span>
<span class="line">  dbms_output.put_line('tr   &#123;font:10pt SimSun,SimSun,SimSun,SimSun;&#125;');</span>
<span class="line">  dbms_output.put_line('td   &#123;border:1px solid; font:10pt SimSun,SimSun,SimSun,SimSun;&#125;');</span>
<span class="line">  dbms_output.put_line('&lt;/style</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;<span class="regexp">/head&gt;&lt;body&gt;');</span>
<span class="line"></span>
<span class="line">  ----获取SQL文本</span>
<span class="line">  dbms_output.put_line('&lt;b&gt;sql_text&lt;/b</span>&gt;&lt;br&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;table&gt;&lt;<span class="keyword">tr</span>&gt;&lt;td&gt;<span class="string">');</span>
<span class="line">  select sqtxt</span>
<span class="line">    into vsqltxt_c</span>
<span class="line">    from (select sql_text sqtxt</span>
<span class="line">            from dba_hist_sqltext</span>
<span class="line">           where sql_id = vsqlid</span>
<span class="line">          union all</span>
<span class="line">          select sql_fulltext sqtxt from v$sqlarea where sql_id = vsqlid)</span>
<span class="line">   where rownum = 1;</span>
<span class="line">  vsqltxt_a.delete;</span>
<span class="line">  vsqltxt_le := DBMS_LOB.GETLENGTH(vsqltxt_c) / 2000 + 1;</span>
<span class="line">  for i in 1 .. vsqltxt_le loop</span>
<span class="line">    vsqltxt_a(i) := substr(vsqltxt_c, 1900 * (i - 1) + 1, 1900);</span>
<span class="line">    dbms_output.put_line(vsqltxt_a(i));</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line('</span>&lt;<span class="regexp">/td&gt;&lt;/tr</span>&gt;&lt;<span class="regexp">/table&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;br&gt;');</span>
<span class="line">  </span>
<span class="line">  ----获取执行计划--explain plan for</span>
<span class="line">  dbms_output.put_line('&lt;b&gt;explain plan for&lt;/b</span>&gt;&lt;table&gt;<span class="string">');</span>
<span class="line">  for v in (select distinct parsing_schema_name from dba_hist_sqlstat where sql_id = vsqlid) loop</span>
<span class="line">    dbms_output.put_line('</span>&lt;<span class="keyword">tr</span>&gt;&lt;td&gt;&lt;pre&gt;<span class="string">');</span>
<span class="line">    begin</span>
<span class="line">      execute immediate '</span>alter session set current_schema=<span class="string">'||v.parsing_schema_name;</span>
<span class="line">      vsqlcur := dbms_sql.open_cursor;</span>
<span class="line">      vsqltxt_a(0) := '</span>explain plan <span class="keyword">for</span> <span class="string">';</span>
<span class="line">      dbms_sql.parse(vsqlcur, vsqltxt_a, vsqltxt_lb, vsqltxt_le, false, dbms_sql.native);</span>
<span class="line">      vsqltxt_le := dbms_sql.execute(vsqlcur);</span>
<span class="line">      for v_in in (select plan_table_output as planline from table(dbms_xplan.display)) loop</span>
<span class="line">        dbms_output.put_line(v_in.planline);</span>
<span class="line">      end loop;</span>
<span class="line">      dbms_sql.close_cursor(vsqlcur);</span>
<span class="line">      exception</span>
<span class="line">        when others then</span>
<span class="line">        vsqlmsg := sqlerrm;</span>
<span class="line">          dbms_output.put_line(vsqlmsg);</span>
<span class="line">    end;</span>
<span class="line">    dbms_output.put_line('</span>&lt;<span class="regexp">/pre&gt;&lt;/td</span>&gt;&lt;<span class="regexp">/tr&gt;');</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line('&lt;/table</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;br&gt;<span class="string">');</span>
<span class="line"></span>
<span class="line">  ----获取执行计划--V$SQLPLAN</span>
<span class="line">  dbms_output.put_line('</span>&lt;b&gt;Execution Plan From V$SQLPLAN&lt;<span class="regexp">/b&gt;&lt;br&gt;');</span>
<span class="line">  for hashval in (select distinct plan_hash_value from v$sql_plan where sql_id = vsqlid) loop</span>
<span class="line">    dbms_output.put_line('SQL:'||vsqlid||', PLAN_HASH_VALUE:'||hashval.plan_hash_value);</span>
<span class="line">    dbms_output.put_line('&lt;table&gt;');</span>
<span class="line">    dbms_output.put_line('&lt;tr&gt;&lt;th&gt;ID&lt;/th</span>&gt;&lt;th&gt;DEP&lt;<span class="regexp">/th&gt;&lt;th width="400px"&gt;OPERITION&lt;/th</span>&gt;&lt;th&gt;NAME&lt;<span class="regexp">/th&gt;&lt;th&gt;ROWS&lt;/th</span>&gt;&lt;th&gt;BYTES&lt;<span class="regexp">/th&gt;&lt;th&gt;COST(%CPU)&lt;/th</span>&gt;&lt;th&gt;IO_COST&lt;<span class="regexp">/th&gt;&lt;th&gt;TIME&lt;/th</span>&gt;&lt;<span class="regexp">/tr&gt;');</span>
<span class="line">    vPlanAddition.delete;</span>
<span class="line">    arr_iter := 0;</span>
<span class="line">    for v in (select decode(trim(predicates), '', '' || ID, '*' || ID) ID,</span>
<span class="line">                     DEPTH,</span>
<span class="line">                     OPERATION,</span>
<span class="line">                     NAME,</span>
<span class="line">                     PREDICATES,</span>
<span class="line">                     "ROWS",</span>
<span class="line">                     BYTES,</span>
<span class="line">                     "COST(%CPU)",</span>
<span class="line">                     IO_COST,</span>
<span class="line">                     TIME</span>
<span class="line">                from (select a.plan_hash_value || ' ' plan_hash_value,</span>
<span class="line">               id ID,</span>
<span class="line">               depth DEPTH,</span>
<span class="line">               lpad(operation, length(operation) + depth * 6, '&amp;nbsp;') || ' ' || options OPERATION,</span>
<span class="line">               decode(OBJECT_NAME,</span>
<span class="line">                  null,</span>
<span class="line">                  '',</span>
<span class="line">                  '[' || OBJECT_TYPE || ']' || OBJECT_OWNER || '.' ||</span>
<span class="line">                  OBJECT_NAME) || '&amp;nbsp;' NAME,</span>
<span class="line">               case</span>
<span class="line">               when (length(access_predicates) &lt; 3 or access_predicates is null) then</span>
<span class="line">                case</span>
<span class="line">                when (length(filter_predicates) &lt; 3 or filter_predicates is null) then</span>
<span class="line">                 ' '</span>
<span class="line">                else</span>
<span class="line">                 '[filter]' || substr(filter_predicates, 1, 3990)</span>
<span class="line">                end</span>
<span class="line">               else</span>
<span class="line">                '[access]' || substr(access_predicates, 1, 3990)</span>
<span class="line">               end PREDICATES,</span>
<span class="line">               decode(cardinality, null, '', cardinality) || '&amp;nbsp;' "ROWS",</span>
<span class="line">               decode(Bytes, null, '', Bytes) || '&amp;nbsp;' BYTES,</span>
<span class="line">               decode(io_cost,</span>
<span class="line">                  null,</span>
<span class="line">                  decode(cost, null, '', cost),</span>
<span class="line">                  decode(cost, null, '', cost) || '(' ||</span>
<span class="line">                  decode(cost, 0, 0, round((cost - io_cost) /</span> cost * <span class="number">100</span>)) || <span class="string">')'</span>) || <span class="string">'&amp;nbsp;'</span> <span class="string">"COST(%CPU)"</span>,</span>
<span class="line">               --decode(cpu_cost, null, <span class="string">''</span>, cpu_cost) || <span class="string">' '</span> CPU_COST,</span>
<span class="line">               decode(io_cost, null, <span class="string">''</span>, io_cost) || <span class="string">' '</span> IO_COST,</span>
<span class="line">               trim(to_char(round(nvl(<span class="keyword">time</span>, <span class="number">0</span>) / <span class="number">3600</span>), <span class="string">'00'</span>)) || <span class="string">':'</span> ||</span>
<span class="line">               to_char(to_date(<span class="string">'19000101'</span>, <span class="string">'yyyymmdd'</span>) + nvl(<span class="keyword">time</span>, <span class="number">0</span>) / <span class="number">3600</span> / <span class="number">24</span>,</span>
<span class="line">                   <span class="string">'mi:ss'</span>) TIME</span>
<span class="line">            from v$sql_plan a,</span>
<span class="line">               (<span class="keyword">select</span> plan_hash_value, max(child_number) child_number, sql_id</span>
<span class="line">                from v$sql_plan</span>
<span class="line">               where sql_id = vsqlid</span>
<span class="line">               group by sql_id, plan_hash_value) b</span>
<span class="line">           where a.sql_id = b.sql_id</span>
<span class="line">             <span class="keyword">and</span> a.plan_hash_value = b.plan_hash_value</span>
<span class="line">             <span class="keyword">and</span> a.plan_hash_value = hashval.plan_hash_value</span>
<span class="line">             <span class="keyword">and</span> a.child_number = b.child_number</span>
<span class="line">           order by a.plan_hash_value, id asc</span>
<span class="line">          )) loop</span>
<span class="line">        arr_iter := arr_iter+<span class="number">1</span>;</span>
<span class="line">        vPlanAddition(arr_iter) := case <span class="keyword">when</span> trim(v.predicates)||<span class="string">' '</span> = <span class="string">' '</span> then <span class="string">''</span> </span>
<span class="line">            <span class="keyword">else</span> v.id||<span class="string">' =&gt; '</span>||v.predicates || <span class="string">'&lt;br&gt;'</span> end;</span>
<span class="line">        dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.ID || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.DEPTH ||</span>
<span class="line">                             <span class="string">'&lt;/td&gt;&lt;td width="400px"&gt;'</span> || v.OPERATION || </span>
<span class="line">               <span class="string">'&lt;/td&gt;&lt;td&gt;'</span>|| v.NAME || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.<span class="string">"ROWS"</span> ||</span>
<span class="line">                              <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.BYTES || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.<span class="string">"COST(%CPU)"</span> ||</span>
<span class="line">                               <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.IO_COST || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.TIME || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">    end loop;</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;br&gt;'</span>);</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;p style="font:10pt SimSun,SimSun,SimSun,SimSun"&gt;'</span>);</span>
<span class="line">    dbms_output.put_line(<span class="string">'Predicate Information (identified by operation id):&lt;br&gt;'</span>);</span>
<span class="line">    dbms_output.put_line(<span class="string">'---------------------------------------------------------------------------&lt;br&gt;'</span>);</span>
<span class="line">    arr_iter := <span class="number">0</span>;</span>
<span class="line">    <span class="keyword">for</span> v1 in <span class="number">1</span>..vPlanAddition.count loop</span>
<span class="line">      arr_iter := arr_iter+<span class="number">1</span>;</span>
<span class="line">      dbms_output.put_line(vPlanAddition(arr_iter));</span>
<span class="line">     end loop;</span>
<span class="line">     dbms_output.put_line(<span class="string">'&lt;p&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----SQL统计信息（SQL STATISTICS - V$SQLSTATS)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;SQL STATISTICS- V$SQLPLAN&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;HASH&lt;/th&gt;&lt;th&gt;DB_TIME&lt;/th&gt;&lt;th&gt;MEM&lt;/th&gt;&lt;th&gt;VERS&lt;/th&gt;&lt;th&gt;EXES&lt;/th&gt;&lt;th&gt;DISKS&lt;/th&gt;&lt;th&gt;GETS&lt;/th&gt;&lt;th&gt;ROWS&lt;/th&gt;&lt;th&gt;CPU&lt;/th&gt;&lt;th&gt;ELAPSED&lt;/th&gt;&lt;th&gt;CLUSTER_WAIT&lt;/th&gt;&lt;th&gt;CONCURRENCE_WAIT&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> mem.SQL_ID <span class="string">"ID"</span>,</span>
<span class="line">         mem.PLAN_HASH_VALUE <span class="string">"HASH"</span>,</span>
<span class="line">         mem_dbtime.VAL DB_TIME,</span>
<span class="line">         mem.SHARABLE_MEM MEM,</span>
<span class="line">         mem.VERSION_COUNT VERS,</span>
<span class="line">         mem.EXECUTIONS EXES,</span>
<span class="line">         mem.PARSE_CALLS PARSE_CALLS,</span>
<span class="line">         mem.DISK_READS <span class="string">"DISKS"</span>,</span>
<span class="line">         mem.BUFFER_GETS GETS,</span>
<span class="line">         mem.ROWS_PROCESSED <span class="string">"ROWS"</span>,</span>
<span class="line">         mem.CPU_TIME <span class="string">"CPU"</span>,</span>
<span class="line">         mem.ELAPSED_TIME ELAPSED,</span>
<span class="line">         mem.CLWAIT CLUSTER_WAIT,</span>
<span class="line">         mem.CCWAIT CONCURRENCE_WAIT</span>
<span class="line">      from (<span class="keyword">select</span> SQL_ID,</span>
<span class="line">             PLAN_HASH_VALUE,</span>
<span class="line">             SHARABLE_MEM,</span>
<span class="line">             VERSION_COUNT,</span>
<span class="line">             FETCHES,</span>
<span class="line">             END_OF_FETCH_COUNT,</span>
<span class="line">             SORTS,</span>
<span class="line">             EXECUTIONS,</span>
<span class="line">             PX_SERVERS_EXECUTIONS PX_SERVERS_EXECS,</span>
<span class="line">             LOADS,</span>
<span class="line">             INVALIDATIONS,</span>
<span class="line">             PARSE_CALLS,</span>
<span class="line">             DISK_READS,</span>
<span class="line">             BUFFER_GETS,</span>
<span class="line">             ROWS_PROCESSED,</span>
<span class="line">             CPU_TIME,</span>
<span class="line">             ELAPSED_TIME,</span>
<span class="line">             CLUSTER_WAIT_TIME     CLWAIT,</span>
<span class="line">             APPLICATION_WAIT_TIME APWAIT,</span>
<span class="line">             CONCURRENCY_WAIT_TIME CCWAIT,</span>
<span class="line">             DIRECT_WRITES,</span>
<span class="line">             PLSQL_EXEC_TIME       PLSEXEC_TIME,</span>
<span class="line">             JAVA_EXEC_TIME        JAVEXEC_TIME</span>
<span class="line">          from v$sqlstats</span>
<span class="line">         where sql_id = vsqlid) mem,(<span class="keyword">select</span> sum(value) val from v$sysstat where name = <span class="string">'DB time'</span>) mem_dbtime</span>
<span class="line">      ) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.<span class="string">"ID"</span>||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.<span class="string">"HASH"</span>||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.DB_TIME||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.MEM||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.VERS||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.EXES||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.<span class="string">"DISKS"</span>||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.GETS||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.<span class="string">"ROWS"</span>||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.<span class="string">"CPU"</span>||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.ELAPSED||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.CLUSTER_WAIT||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;td&gt;'</span>||v.CONCURRENCE_WAIT||<span class="string">'&lt;/td&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----获取执行计划--AWR</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Execution Plan From AWR&lt;/b&gt;&lt;br&gt;&lt;br&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> hashval in (<span class="keyword">select</span> distinct plan_hash_value from dba_hist_sql_plan where sql_id = vsqlid) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'SQL:'</span>||vsqlid||<span class="string">', PLAN_HASH_VALUE:'</span>||hashval.plan_hash_value);</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;table&gt;'</span>);</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;th&gt;ID&lt;/th&gt;&lt;th&gt;DEP&lt;/th&gt;&lt;th width="400px"&gt;OPERITION&lt;/th&gt;&lt;th&gt;NAME&lt;/th&gt;&lt;th&gt;ROWS&lt;/th&gt;&lt;th&gt;BYTES&lt;/th&gt;&lt;th&gt;COST(%CPU)&lt;/th&gt;&lt;th&gt;IO_COST&lt;/th&gt;&lt;th&gt;TIME&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  vPlanAddition.delete;</span>
<span class="line">  arr_iter := <span class="number">0</span>;</span>
<span class="line">    <span class="keyword">for</span> v in (<span class="keyword">select</span> decode(trim(predicates), <span class="string">''</span>, <span class="string">''</span> || ID, <span class="string">'*'</span> || ID) ID,</span>
<span class="line">                     DEPTH,</span>
<span class="line">                     OPERATION,</span>
<span class="line">                     NAME,</span>
<span class="line">                     PREDICATES,</span>
<span class="line">                     <span class="string">"ROWS"</span>,</span>
<span class="line">                     BYTES,</span>
<span class="line">                     <span class="string">"COST(%CPU)"</span>,</span>
<span class="line">                     IO_COST,</span>
<span class="line">                     TIME</span>
<span class="line">                from (<span class="keyword">select</span> a.plan_hash_value || <span class="string">' '</span> plan_hash_value,</span>
<span class="line">               id ID,</span>
<span class="line">               depth DEPTH,</span>
<span class="line">               lpad(operation, <span class="keyword">length</span>(operation) + depth * <span class="number">6</span>, <span class="string">'&amp;nbsp;'</span>) || <span class="string">' '</span> || options OPERATION,</span>
<span class="line">               decode(OBJECT_NAME,</span>
<span class="line">                  null,</span>
<span class="line">                  <span class="string">''</span>,</span>
<span class="line">                  <span class="string">'['</span> || OBJECT_TYPE || <span class="string">']'</span> || OBJECT_OWNER || <span class="string">'.'</span> ||</span>
<span class="line">                  OBJECT_NAME) || <span class="string">'&amp;nbsp;'</span> NAME,</span>
<span class="line">               case</span>
<span class="line">               <span class="keyword">when</span> (<span class="keyword">length</span>(access_predicates) &lt; <span class="number">3</span> <span class="keyword">or</span> access_predicates is null) then</span>
<span class="line">                case</span>
<span class="line">                <span class="keyword">when</span> (<span class="keyword">length</span>(filter_predicates) &lt; <span class="number">3</span> <span class="keyword">or</span> filter_predicates is null) then</span>
<span class="line">                 <span class="string">' '</span></span>
<span class="line">                <span class="keyword">else</span></span>
<span class="line">                 <span class="string">'[filter]'</span> || <span class="keyword">substr</span>(filter_predicates, <span class="number">1</span>, <span class="number">3990</span>)</span>
<span class="line">                end</span>
<span class="line">               <span class="keyword">else</span></span>
<span class="line">                <span class="string">'[access]'</span> || <span class="keyword">substr</span>(access_predicates, <span class="number">1</span>, <span class="number">3990</span>)</span>
<span class="line">               end PREDICATES,</span>
<span class="line">               decode(cardinality, null, <span class="string">''</span>, cardinality) || <span class="string">'&amp;nbsp;'</span> <span class="string">"ROWS"</span>,</span>
<span class="line">               decode(Bytes, null, <span class="string">''</span>, Bytes) || <span class="string">'&amp;nbsp;'</span> BYTES,</span>
<span class="line">               decode(io_cost,</span>
<span class="line">                  null,</span>
<span class="line">                  decode(cost, null, <span class="string">''</span>, cost),</span>
<span class="line">                  decode(cost, null, <span class="string">''</span>, cost) || <span class="string">'('</span> ||</span>
<span class="line">                  decode(cost, <span class="number">0</span>, <span class="number">0</span>, round((cost - io_cost) / cost * <span class="number">100</span>)) || <span class="string">')'</span>) || <span class="string">'&amp;nbsp;'</span> <span class="string">"COST(%CPU)"</span>,</span>
<span class="line">               --decode(cpu_cost, null, <span class="string">''</span>, cpu_cost) || <span class="string">' '</span> CPU_COST,</span>
<span class="line">               decode(io_cost, null, <span class="string">''</span>, io_cost) || <span class="string">' '</span> IO_COST,</span>
<span class="line">               trim(to_char(round(nvl(<span class="keyword">time</span>, <span class="number">0</span>) / <span class="number">3600</span>), <span class="string">'00'</span>)) || <span class="string">':'</span> ||</span>
<span class="line">               to_char(to_date(<span class="string">'19000101'</span>, <span class="string">'yyyymmdd'</span>) + nvl(<span class="keyword">time</span>, <span class="number">0</span>) / <span class="number">3600</span> / <span class="number">24</span>,</span>
<span class="line">                   <span class="string">'mi:ss'</span>) TIME</span>
<span class="line">            from dba_hist_sql_plan a</span>
<span class="line">           where a.sql_id = vsqlid</span>
<span class="line">             <span class="keyword">and</span> a.plan_hash_value = hashval.plan_hash_value</span>
<span class="line">           order by a.plan_hash_value, id asc</span>
<span class="line">          )) loop</span>
<span class="line">    /*AWR里没有Predicate信息</span>
<span class="line">    arr_iter := arr_iter+<span class="number">1</span>;</span>
<span class="line">        vPlanAddition(arr_iter) := case <span class="keyword">when</span> trim(v.predicates)||<span class="string">' '</span> = <span class="string">' '</span> then <span class="string">''</span> </span>
<span class="line">            <span class="keyword">else</span> <span class="string">'&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;'</span>|| v.id||<span class="string">' =&gt; '</span>||v.predicates || <span class="string">'&lt;br&gt;'</span> end;</span>
<span class="line">    *<span class="regexp">/</span>
<span class="line">        dbms_output.put_line('&lt;tr&gt;&lt;td&gt;' || v.ID || '&lt;/td</span>&gt;&lt;td&gt;<span class="string">' || v.DEPTH ||</span>
<span class="line">                             '</span>&lt;<span class="regexp">/td&gt;&lt;td width="400px"&gt;' || v.OPERATION || </span>
<span class="line">               '&lt;/td</span>&gt;&lt;td&gt;<span class="string">'|| v.NAME || '</span>&lt;<span class="regexp">/td&gt;&lt;td&gt;' || v."ROWS" ||</span>
<span class="line">                              '&lt;/td</span>&gt;&lt;td&gt;<span class="string">' || v.BYTES || '</span>&lt;<span class="regexp">/td&gt;&lt;td&gt;' || v."COST(%CPU)" ||</span>
<span class="line">                               '&lt;/td</span>&gt;&lt;td&gt;<span class="string">' || v.IO_COST || '</span>&lt;<span class="regexp">/td&gt;&lt;td&gt;' || v.TIME || '&lt;/td</span>&gt;&lt;<span class="regexp">/tr&gt;');</span>
<span class="line">      end loop;</span>
<span class="line">    dbms_output.put_line('&lt;/table</span>&gt;&lt;br&gt;<span class="string">');</span>
<span class="line">  /*AWR里没有Predicate信息</span>
<span class="line">  dbms_output.put_line('</span>&lt;p style=<span class="string">"font:10pt SimSun,SimSun,SimSun,SimSun"</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Predicate Information (identified by operation id):&lt;br&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;---------------------------------------------------------------------------&lt;br&gt;<span class="string">');</span>
<span class="line">  arr_iter := 0;</span>
<span class="line">  for v1 in 1..vPlanAddition.count loop</span>
<span class="line">    arr_iter := arr_iter+1;</span>
<span class="line">    dbms_output.put_line(vPlanAddition(arr_iter));</span>
<span class="line">  end loop;</span>
<span class="line">  */</span>
<span class="line">  dbms_output.put_line('</span>&lt;p&gt;<span class="string">');</span>
<span class="line">  end loop;</span>
<span class="line"></span>
<span class="line">/*</span>
<span class="line">  ----SQL统计信息（SQL STATISTICS - AWR)</span>
<span class="line">  dbms_output.put_line('</span>&lt;b&gt;SQL STATISTICS&lt;<span class="regexp">/b&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;table&gt;&lt;tr&gt;&lt;th&gt;ID&lt;/th</span>&gt;&lt;th&gt;HASH&lt;<span class="regexp">/th&gt;&lt;th&gt;DB_TIME_TOTAL&lt;/th</span>&gt;&lt;th&gt;DB_TIME_CURRENT&lt;<span class="regexp">/th&gt;&lt;th&gt;MEM&lt;/th</span>&gt;&lt;th&gt;VERS&lt;<span class="regexp">/th&gt;&lt;th&gt;EXES&lt;/th</span>&gt;&lt;th&gt;DISKS&lt;<span class="regexp">/th&gt;&lt;th&gt;GETS&lt;/th</span>&gt;&lt;th&gt;ROWS&lt;<span class="regexp">/th&gt;&lt;th&gt;CPU&lt;/th</span>&gt;&lt;th&gt;ELAPSED&lt;<span class="regexp">/th&gt;&lt;th&gt;CCWAIT&lt;/th</span>&gt;&lt;<span class="regexp">/tr&gt;');</span>
<span class="line">  for v in (select mem.SQL_ID "ID",</span>
<span class="line">         mem.PLAN_HASH_VALUE "HASH",</span>
<span class="line">         mem_dbtime.VAL - awr_dbtime.VAL DB_TIME_TOTAL,</span>
<span class="line">         mem_dbtime.VAL - (select max(value) VAL</span>
<span class="line">                   from dba_hist_sysstat</span>
<span class="line">                  where stat_name = 'DB time') DB_TIME_CURRENT,</span>
<span class="line">         mem.SHARABLE_MEM MEM,</span>
<span class="line">         mem.VERSION_COUNT VERS,</span>
<span class="line">         mem.EXECUTIONS - awr.EXECUTIONS EXES,</span>
<span class="line">         mem.PARSE_CALLS - awr.PARSE_CALLS PARSE_CALLS,</span>
<span class="line">         mem.DISK_READS - awr.DISK_READS "DISKS",</span>
<span class="line">         mem.BUFFER_GETS - awr.BUFFER_GETS GETS,</span>
<span class="line">         mem.ROWS_PROCESSED - awr.ROWS_PROCESSED "ROWS",</span>
<span class="line">         mem.CPU_TIME - awr.CPU_TIME "CPU",</span>
<span class="line">         mem.ELAPSED_TIME - awr.ELAPSED_TIME ELAPSED,</span>
<span class="line">         mem.CCWAIT - awr.CCWAIT CCWAIT</span>
<span class="line">      from (select SQL_ID,</span>
<span class="line">             PLAN_HASH_VALUE,</span>
<span class="line">             SHARABLE_MEM,</span>
<span class="line">             VERSION_COUNT,</span>
<span class="line">             FETCHES,</span>
<span class="line">             END_OF_FETCH_COUNT,</span>
<span class="line">             SORTS,</span>
<span class="line">             EXECUTIONS,</span>
<span class="line">             PX_SERVERS_EXECUTIONS PX_SERVERS_EXECS,</span>
<span class="line">             LOADS,</span>
<span class="line">             INVALIDATIONS,</span>
<span class="line">             PARSE_CALLS,</span>
<span class="line">             DISK_READS,</span>
<span class="line">             BUFFER_GETS,</span>
<span class="line">             ROWS_PROCESSED,</span>
<span class="line">             CPU_TIME,</span>
<span class="line">             ELAPSED_TIME,</span>
<span class="line">             --IOWAIT,</span>
<span class="line">             CLUSTER_WAIT_TIME     CLWAIT,</span>
<span class="line">             APPLICATION_WAIT_TIME APWAIT,</span>
<span class="line">             CONCURRENCY_WAIT_TIME CCWAIT,</span>
<span class="line">             DIRECT_WRITES,</span>
<span class="line">             PLSQL_EXEC_TIME       PLSEXEC_TIME,</span>
<span class="line">             JAVA_EXEC_TIME        JAVEXEC_TIME</span>
<span class="line">          from v$sqlstats</span>
<span class="line">         where sql_id = vsqlid) mem,</span>
<span class="line">         (select max(SNAP_ID) SNAP_ID,</span>
<span class="line">             SQL_ID,</span>
<span class="line">             PLAN_HASH_VALUE,</span>
<span class="line">             max(SHARABLE_MEM) SHARABLE_MEM,</span>
<span class="line">             max(VERSION_COUNT) VERSION_COUNT,</span>
<span class="line">             max(FETCHES_TOTAL) FETCHES,</span>
<span class="line">             max(END_OF_FETCH_COUNT_TOTAL) END_OF_FETCH_COUNT,</span>
<span class="line">             max(SORTS_TOTAL) SORTS,</span>
<span class="line">             max(EXECUTIONS_TOTAL) EXECUTIONS,</span>
<span class="line">             max(PX_SERVERS_EXECS_TOTAL) PX_SERVERS_EXECS,</span>
<span class="line">             max(LOADS_TOTAL) LOADS,</span>
<span class="line">             max(INVALIDATIONS_TOTAL) INVALIDATIONS,</span>
<span class="line">             max(PARSE_CALLS_TOTAL) PARSE_CALLS,</span>
<span class="line">             max(DISK_READS_TOTAL) DISK_READS,</span>
<span class="line">             max(BUFFER_GETS_TOTAL) BUFFER_GETS,</span>
<span class="line">             max(ROWS_PROCESSED_TOTAL) ROWS_PROCESSED,</span>
<span class="line">             max(CPU_TIME_TOTAL) CPU_TIME,</span>
<span class="line">             max(ELAPSED_TIME_TOTAL) ELAPSED_TIME,</span>
<span class="line">             max(CLWAIT_TOTAL) CLWAIT,</span>
<span class="line">             max(APWAIT_TOTAL) APWAIT,</span>
<span class="line">             max(CCWAIT_TOTAL) CCWAIT,</span>
<span class="line">             max(DIRECT_WRITES_TOTAL) DIRECT_WRITES,</span>
<span class="line">             max(PLSEXEC_TIME_TOTAL) PLSEXEC_TIME,</span>
<span class="line">             max(JAVEXEC_TIME_TOTAL) JAVEXEC_TIME</span>
<span class="line">          from dba_hist_sqlstat</span>
<span class="line">         where snap_id &gt;</span>
<span class="line">             (select min(snap_id)</span>
<span class="line">              from dba_hist_snapshot</span>
<span class="line">             where startup_time =</span>
<span class="line">                 (select max(startup_time) from dba_hist_snapshot))</span>
<span class="line">           and sql_id = vsqlid</span>
<span class="line">         group by sql_id, plan_hash_value) awr,</span>
<span class="line">         (select sum(value) val from v$sysstat where name = 'DB time') mem_dbtime,</span>
<span class="line">         (select a.snap_id, a.value val</span>
<span class="line">          from dba_hist_sysstat a</span>
<span class="line">         where a.snap_id &gt;</span>
<span class="line">             (select min(snap_id)</span>
<span class="line">              from dba_hist_snapshot</span>
<span class="line">             where startup_time =</span>
<span class="line">                 (select max(startup_time) from dba_hist_snapshot))</span>
<span class="line">           and a.stat_name = 'DB time') awr_dbtime</span>
<span class="line">     where awr.sql_id(+) = mem.sql_id</span>
<span class="line">       and awr.plan_hash_value(+) = mem.plan_hash_value</span>
<span class="line">       and awr.snap_id = awr_dbtime.snap_id</span>
<span class="line">      ) loop</span>
<span class="line">    dbms_output.put_line('&lt;tr&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;td&gt;'||v."ID"||'&lt;/td</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;td&gt;<span class="string">'||v."HASH"||'</span>&lt;<span class="regexp">/td&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;td&gt;'||v.DB_TIME_TOTAL||'&lt;/td</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;td&gt;<span class="string">'||v.DB_TIME_CURRENT||'</span>&lt;<span class="regexp">/td&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;td&gt;'||v.MEM||'&lt;/td</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;td&gt;<span class="string">'||v.VERS||'</span>&lt;<span class="regexp">/td&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;td&gt;'||v.EXES||'&lt;/td</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;td&gt;<span class="string">'||v."DISKS"||'</span>&lt;<span class="regexp">/td&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;td&gt;'||v.GETS||'&lt;/td</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;td&gt;<span class="string">'||v."ROWS"||'</span>&lt;<span class="regexp">/td&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;td&gt;'||v."CPU"||'&lt;/td</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;td&gt;<span class="string">'||v.ELAPSED||'</span>&lt;<span class="regexp">/td&gt;');</span>
<span class="line">  dbms_output.put_line('&lt;td&gt;'||v.CCWAIT||'&lt;/td</span>&gt;<span class="string">');</span>
<span class="line">  dbms_output.put_line('</span>&lt;<span class="regexp">/tr&gt;');</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line('&lt;/table</span>&gt;&lt;<span class="regexp">/br&gt;');</span>
<span class="line">*/</span></span>
<span class="line"></span>
<span class="line">  ----获取SQL语句所涉及的表</span>
<span class="line">  vOwnerCnt := <span class="number">0</span>;</span>
<span class="line">  vOwnerstr := <span class="string">''</span>;</span>
<span class="line">  vTableCnt := <span class="number">0</span>;</span>
<span class="line">  vTablestr := <span class="string">''</span>;</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> OBJECT_OWNER, object_name</span>
<span class="line">              from v$sql_plan</span>
<span class="line">             where sql_id = vsqlid</span>
<span class="line">               <span class="keyword">and</span> operation like <span class="string">'%TABLE%'</span></span>
<span class="line">       union</span>
<span class="line">      <span class="keyword">select</span> OBJECT_OWNER, object_name from dba_hist_sql_plan</span>
<span class="line">       where sql_id = vsqlid</span>
<span class="line">               <span class="keyword">and</span> operation like <span class="string">'%TABLE%'</span></span>
<span class="line">       union</span>
<span class="line">      <span class="keyword">select</span> OBJECT_OWNER, object_name from PLAN_TABLE</span>
<span class="line">       where operation like <span class="string">'%TABLE%'</span></span>
<span class="line">      ) loop</span>
<span class="line">    vTablestr := vTablestr || v.OBJECT_NAME || <span class="string">','</span>;</span>
<span class="line">    vTableCnt := vTableCnt + <span class="number">1</span>;</span>
<span class="line">    vOwnerstr := vOwnerstr || v.OBJECT_OWNER || <span class="string">','</span>;</span>
<span class="line">    vOwnerCnt := vOwnerCnt + <span class="number">1</span>;</span>
<span class="line">  end loop;</span>
<span class="line">  vOwnerstr := <span class="keyword">substr</span>(vOwnerstr, <span class="number">1</span>, <span class="keyword">length</span>(vOwnerstr) - <span class="number">1</span>);</span>
<span class="line">  vTablestr := <span class="keyword">substr</span>(vTablestr, <span class="number">1</span>, <span class="keyword">length</span>(vTablestr) - <span class="number">1</span>);</span>
<span class="line">  </span>
<span class="line">  ----SQL涉及所有表的尺寸（Table Segment Size)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Table Segment Size&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;&lt;th&gt;owner&lt;/th&gt;&lt;th&gt;segment_name&lt;/th&gt;&lt;th&gt;MB&lt;/th&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> owner, segment_name, to_char(sum(bytes) / <span class="number">1024</span> / <span class="number">1024</span>, <span class="string">'9999990.99'</span>) MB</span>
<span class="line">              from dba_segments</span>
<span class="line">             where segment_name in</span>
<span class="line">                   (SELECT REGEXP_SUBSTR(vTablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vTableCnt)</span>
<span class="line">                    <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             group by owner, segment_name</span>
<span class="line">             order by owner, segment_name) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.OWNER || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.segment_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.MB ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----SQL涉及所有表的相关信息(Table Statistics)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Table Statistics&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;OWNER&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;num_rows&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;blocks&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;degree&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;last_analyzed&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;temporary&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;partitioned&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;pct_free&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;tablespace_name&lt;/th&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> t.OWNER,</span>
<span class="line">                   t.table_name,</span>
<span class="line">                   t.num_rows,</span>
<span class="line">                   t.blocks,</span>
<span class="line">                   t.degree,</span>
<span class="line">                   t.last_analyzed,</span>
<span class="line">                   t.temporary,</span>
<span class="line">                   t.partitioned,</span>
<span class="line">                   t.pct_free,</span>
<span class="line">                   t.tablespace_name</span>
<span class="line">              from dba_tables t</span>
<span class="line">             where table_name in</span>
<span class="line">                   (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vTableCnt)</span>
<span class="line">               <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             order by owner, table_name) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.OWNER || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.num_rows ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.blocks || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.degree || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.last_analyzed ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.temporary || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.partitioned || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.pct_free ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.tablespace_name || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line"></span>
<span class="line">  ----SQL涉及所有表的列信息(Table Column Statistics)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Table Column Statistics&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;OWNER&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;column_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;data_type&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;nullable&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;last_analyzed&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;avg_col_len&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> owner,</span>
<span class="line">                   table_name,</span>
<span class="line">                   column_name,</span>
<span class="line">                   data_type,</span>
<span class="line">                   nullable,</span>
<span class="line">                   to_char(last_analyzed, <span class="string">'mm/dd/yy hh24:mi:ss'</span>) analyzed,</span>
<span class="line">                   avg_col_len</span>
<span class="line">              from dba_tab_cols</span>
<span class="line">             where table_name in (SELECT REGEXP_SUBSTR(vTABLESTR, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                                    FROM DUAL</span>
<span class="line">                                  CONNECT BY LEVEL &lt;= vTABLECNT)</span>
<span class="line">               <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">          order by owner, table_name, column_name) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.OWNER || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.column_name ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.data_type || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.nullable || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.analyzed ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.avg_col_len || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>); </span>
<span class="line"></span>
<span class="line">  ----SQL涉及所有表的触发器信息(Table Triggers)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Table Triggers&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;table_owner&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;base_object_type&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;tiggger_owner&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;trigger_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;trigger_type&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;triggering_event&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> table_owner,</span>
<span class="line">                   table_name,</span>
<span class="line">                   base_object_type,</span>
<span class="line">                   owner tiggger_owner,</span>
<span class="line">                   trigger_name,</span>
<span class="line">                   trigger_type,</span>
<span class="line">                   triggering_event</span>
<span class="line">              from dba_triggers</span>
<span class="line">             where table_name in (SELECT REGEXP_SUBSTR(vTABLESTR, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                                    FROM DUAL</span>
<span class="line">                                  CONNECT BY LEVEL &lt;= vTABLECNT)</span>
<span class="line">               <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             order by table_owner, table_name) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.table_owner || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.base_object_type ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.tiggger_owner || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.trigger_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.trigger_type ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.triggering_event || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>); </span>
<span class="line">  </span>
<span class="line">  ----SQL涉及的分区表的相关信息(Partition Statistics)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Partition Statistics&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;OWNER&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;partitioning_type&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;partition_count&lt;/th&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> t.owner,</span>
<span class="line">                   t.table_name,</span>
<span class="line">                   t.partitioning_type,</span>
<span class="line">                   t.partition_count</span>
<span class="line">              from dba_part_tables t</span>
<span class="line">             where table_name in</span>
<span class="line">                   (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vtablecnt)</span>
<span class="line">               <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.OWNER || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.partitioning_type || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.partition_count || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----分区表的分区列相关信息(Partition Key Statistics)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Partition Key Statistics&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;owner&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;object_type&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;column_name&lt;/th&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> owner, name, object_type, column_name</span>
<span class="line">              from dba_part_key_columns</span>
<span class="line">             where name in (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                              FROM DUAL</span>
<span class="line">                            CONNECT BY LEVEL &lt;= vtablecnt)</span>
<span class="line">               <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.OWNER || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.name ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.object_type || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.column_name || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----分区表分区范围信息(Partition Range Statistics)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Partition Range Statistics&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;owner&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;partition_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;high_value&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;tablespace_name&lt;/th&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (SELECT table_owner owner,</span>
<span class="line">                   table_name,</span>
<span class="line">                   partition_name,</span>
<span class="line">                   high_value,</span>
<span class="line">                   tablespace_name</span>
<span class="line">              FROM dba_tab_partitions t</span>
<span class="line">             where table_name in</span>
<span class="line">                   (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vtablecnt)</span>
<span class="line">               <span class="keyword">and</span> table_owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             order by table_owner, table_name, t.partition_position) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.OWNER || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.partition_name ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.high_value || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.tablespace_name || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----索引的大小(Index Segments)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Index Segments&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;OWNER&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;segment_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;MB&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> t1.owner,</span>
<span class="line">                   t2.table_name,</span>
<span class="line">                   t1.segment_name,</span>
<span class="line">                   to_char(sum(t1.bytes) / <span class="number">1024</span> / <span class="number">1024</span>, <span class="string">'9999990.99'</span>) MB</span>
<span class="line">              from dba_segments t1, dba_indexes t2</span>
<span class="line">             where t1.segment_name = t2.index_name</span>
<span class="line">               <span class="keyword">and</span> t1.segment_type like <span class="string">'%INDEX%'</span></span>
<span class="line">               <span class="keyword">and</span> t1.owner = t2.owner</span>
<span class="line">               <span class="keyword">and</span> t2.table_name in</span>
<span class="line">                   (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vtablecnt)</span>
<span class="line">               <span class="keyword">and</span> t1.owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">               <span class="keyword">and</span> t2.owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             group by t1.owner, t2.table_name, t1.segment_name</span>
<span class="line">             order by owner, table_name) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.owner || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.segment_name ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.MB || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----索引相关信息(Index Statistics)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Index Statistics&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;OWNER&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;rows&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;type&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;status&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;factor&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;blevel&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;distinct&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;leaf&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;unique&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;degree&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;analyzed&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> t.owner,</span>
<span class="line">                   t.table_name,</span>
<span class="line">                   t.index_name        <span class="string">"name"</span>,</span>
<span class="line">                   t.num_rows          <span class="string">"rows"</span>,</span>
<span class="line">                   t.index_type        <span class="string">"type"</span>,</span>
<span class="line">                   t.status,</span>
<span class="line">                   t.clustering_factor factor,</span>
<span class="line">                   t.blevel,</span>
<span class="line">                   t.distinct_keys     <span class="string">"distinct"</span>,</span>
<span class="line">                   t.leaf_blocks       leaf,</span>
<span class="line">                   t.uniqueness        <span class="string">"unique"</span>,</span>
<span class="line">                   t.degree,</span>
<span class="line">                   to_char(t.last_analyzed, <span class="string">'mm/dd/yy hh24:mi:ss'</span>) analyzed</span>
<span class="line">              from dba_indexes t</span>
<span class="line">             where table_name in</span>
<span class="line">                   (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vtablecnt)</span>
<span class="line">               <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             order by owner, table_name) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.owner || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.<span class="string">"name"</span> ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.<span class="string">"rows"</span> || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.<span class="string">"type"</span> || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.status ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.factor || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.blevel || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.<span class="string">"distinct"</span> ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.leaf || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.<span class="string">"unique"</span> || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.degree ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.analyzed || <span class="string">'&lt;/td&gt;&lt;tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----索引列信息，在哪些列有索引(Index columns)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Index columns&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;OWNER&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;column_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;column_position&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;DESCEND&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> t.index_owner owner,</span>
<span class="line">                   t.table_name,</span>
<span class="line">                   t.index_name,</span>
<span class="line">                   t.column_name,</span>
<span class="line">                   t.column_position,</span>
<span class="line">                   t.DESCEND</span>
<span class="line">              from dba_ind_columns t</span>
<span class="line">             where table_name in</span>
<span class="line">                   (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vtablecnt)</span>
<span class="line">               <span class="keyword">and</span> index_owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             order by owner, table_name, index_name, column_position) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.owner || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.index_name ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.column_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.column_position || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.DESCEND ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----分区索引的分区个数(Partition Indexes nums)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Partition Indexes Summary&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;OWNER&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;table_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;partitioning_type&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;partition_count&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> owner,</span>
<span class="line">                   table_name,</span>
<span class="line">                   index_name,</span>
<span class="line">                   partitioning_type,</span>
<span class="line">                   partition_count</span>
<span class="line">              from dba_part_indexes</span>
<span class="line">             where table_name in</span>
<span class="line">                   (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vtablecnt)</span>
<span class="line">               <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                      FROM DUAL</span>
<span class="line">                    CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             order by owner, table_name, index_name) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.owner || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.table_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.index_name ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.partitioning_type || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.partition_count || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----分区索引的详细信息(Partition Indexes details)</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Partition Indexes Details&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table&gt;&lt;tr&gt;'</span> || <span class="string">'&lt;th&gt;OWNER&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;index_name&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;partition_name&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;status&lt;/th&gt;'</span> || <span class="string">'&lt;th&gt;blevel&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;leaf_blocks&lt;/th&gt;'</span> ||</span>
<span class="line">                       <span class="string">'&lt;th&gt;tablespace_name&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> v in (<span class="keyword">select</span> index_owner owner,</span>
<span class="line">                   index_name,</span>
<span class="line">                   partition_name,</span>
<span class="line">                   status,</span>
<span class="line">                   blevel,</span>
<span class="line">                   leaf_blocks,</span>
<span class="line">                   tablespace_name</span>
<span class="line">              from dba_ind_partitions</span>
<span class="line">             where index_name in</span>
<span class="line">                   (<span class="keyword">select</span> index_name</span>
<span class="line">                      from dba_indexes</span>
<span class="line">                     where table_name in</span>
<span class="line">                           (SELECT REGEXP_SUBSTR(vtablestr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                              FROM DUAL</span>
<span class="line">                            CONNECT BY LEVEL &lt;= vtablecnt)</span>
<span class="line">                       <span class="keyword">and</span> owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                              FROM DUAL</span>
<span class="line">                            CONNECT BY LEVEL &lt;= vOwnerCnt))</span>
<span class="line">               <span class="keyword">and</span> index_owner in (SELECT REGEXP_SUBSTR(vOwnerstr, <span class="string">'[^,]+'</span>, <span class="number">1</span>, LEVEL) AS value_str</span>
<span class="line">                               FROM DUAL</span>
<span class="line">                   CONNECT BY LEVEL &lt;= vOwnerCnt)</span>
<span class="line">             order by owner, index_name, partition_name) loop</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || v.owner || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> ||</span>
<span class="line">                         v.index_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.partition_name ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.status || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.blevel || </span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.leaf_blocks ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || v.tablespace_name || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;&lt;/br&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  ----嵌入awrsqrpt</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;b&gt;Awrsqrpt Contents&lt;/b&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;div&gt;'</span>);</span>
<span class="line">  begin</span>
<span class="line">    <span class="keyword">for</span> v in (<span class="keyword">select</span> max(maxsnap_id) maxsnap_id,</span>
<span class="line">                     max(maxsnap_id) - <span class="number">1</span> as minsnap_id</span>
<span class="line">                from (<span class="keyword">select</span> startup_time,</span>
<span class="line">                             max(a.snap_id) maxsnap_id,</span>
<span class="line">                             min(a.snap_id) minsnap_id</span>
<span class="line">                        from dba_hist_snapshot a, dba_hist_sqlstat b</span>
<span class="line">                       where a.snap_id = b.snap_id</span>
<span class="line">                         <span class="keyword">and</span> b.sql_id = vsqlid</span>
<span class="line">                       group by startup_time)</span>
<span class="line">               where maxsnap_id &lt;&gt; minsnap_id) loop</span>
<span class="line">      dbms_output.put_line(<span class="string">'&lt;div&gt;'</span>);</span>
<span class="line">      begin</span>
<span class="line">        <span class="keyword">for</span> v_in in (<span class="keyword">select</span> output</span>
<span class="line">                     from table(dbms_workload_repository.awr_sql_report_html((<span class="keyword">select</span> dbid</span>
<span class="line">                                                                               from v$database</span>
<span class="line">                                                                              where rownum = <span class="number">1</span>),</span>
<span class="line">                                                                             (<span class="keyword">select</span> instance_number</span>
<span class="line">                                                                                from v$instance</span>
<span class="line">                                                                               where rownum = <span class="number">1</span>),</span>
<span class="line">                                                                             v.minsnap_id,</span>
<span class="line">                                                                             v.maxsnap_id,</span>
<span class="line">                                                                             vsqlid))) loop</span>
<span class="line">          dbms_output.put_line(v_in.output);</span>
<span class="line">        end loop;</span>
<span class="line">      Exception</span>
<span class="line">      <span class="keyword">when</span> others then</span>
<span class="line">        vsqlmsg := sqlerrm;</span>
<span class="line">        dbms_output.put_line(<span class="string">'SQL:'</span> || vsqlid || <span class="string">', cannot be found in DBA_HIST_XXXX.'</span>);</span>
<span class="line">        dbms_output.put_line(vsqlmsg);</span>
<span class="line">      end;</span>
<span class="line">      dbms_output.put_line(<span class="string">'&lt;/div&gt;'</span>);</span>
<span class="line">    end loop;</span>
<span class="line">  Exception</span>
<span class="line">    <span class="keyword">when</span> others then</span>
<span class="line">      vsqlmsg := sqlerrm;</span>
<span class="line">      dbms_output.put_line(vsqlmsg);</span>
<span class="line">  end;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/div&gt;'</span>);</span>
<span class="line">  </span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/body&gt;&lt;/html&gt;'</span>);</span>
<span class="line">  rollback;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line">set termout on</span>
<span class="line">spool off;</span>
<span class="line">exit</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> scripts </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一键获取数据库整体信息脚本]]></title>
      <url>/2017/07/28/oracle/Scripts/%E4%B8%80%E9%94%AE%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE%E5%BA%93%E6%95%B4%E4%BD%93%E4%BF%A1%E6%81%AF%E8%84%9A%E6%9C%AC/</url>
      <content type="html"><![CDATA[<p>一键获取数据库整体信息脚本<br>将脚本内容放<code>spooldb.sql</code>中，在sqlplus中执行，相关信息会自动生成5个文件，其中addm是最近一小时文件，ash是最近半小时文件，而awr文件是最近一小时和最近7天的两个文件。<br><a id="more"></a><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SET markup html ON spool ON pre off entmap off</span>
<span class="line"></span>
<span class="line">set term off</span>
<span class="line">set heading on</span>
<span class="line">set verify off</span>
<span class="line">set feedback off</span>
<span class="line"></span>
<span class="line">set linesize <span class="number">2000</span></span>
<span class="line">set pagesize <span class="number">30000</span></span>
<span class="line">set long <span class="number">999999999</span></span>
<span class="line">set longchunksize <span class="number">999999</span></span>
<span class="line"></span>
<span class="line">column index_name <span class="keyword">format</span> a3<span class="number">0</span></span>
<span class="line">column table_name <span class="keyword">format</span> a3<span class="number">0</span></span>
<span class="line">column num_rows <span class="keyword">format</span> <span class="number">999999999</span></span>
<span class="line">column index_type <span class="keyword">format</span> a24</span>
<span class="line">column num_rows <span class="keyword">format</span> <span class="number">999999999</span></span>
<span class="line">column status <span class="keyword">format</span> a8</span>
<span class="line">column clustering_factor <span class="keyword">format</span> <span class="number">999999999</span></span>
<span class="line">column degree <span class="keyword">format</span> a1<span class="number">0</span></span>
<span class="line">column blevel <span class="keyword">format</span> <span class="number">9</span></span>
<span class="line">column distinct_keys <span class="keyword">format</span> <span class="number">9999999999</span></span>
<span class="line">column leaf_blocks <span class="keyword">format</span>   <span class="number">9999999</span></span>
<span class="line">column last_analyzed    <span class="keyword">format</span> a1<span class="number">0</span></span>
<span class="line">column column_name <span class="keyword">format</span> a25</span>
<span class="line">column column_position <span class="keyword">format</span> <span class="number">9</span></span>
<span class="line">column temporary <span class="keyword">format</span> a2</span>
<span class="line">column partitioned <span class="keyword">format</span> a5</span>
<span class="line">column partitioning_type <span class="keyword">format</span> a7</span>
<span class="line">column partition_count <span class="keyword">format</span> <span class="number">999</span></span>
<span class="line">column program  <span class="keyword">format</span> a3<span class="number">0</span></span>
<span class="line">column spid  <span class="keyword">format</span> a6</span>
<span class="line">column pid  <span class="keyword">format</span> <span class="number">99999</span></span>
<span class="line">column sid  <span class="keyword">format</span> <span class="number">99999</span></span>
<span class="line">column serial<span class="comment"># format 99999</span></span>
<span class="line">column username  <span class="keyword">format</span> a12</span>
<span class="line">column osuser    <span class="keyword">format</span> a12</span>
<span class="line">column logon_time <span class="keyword">format</span>  date</span>
<span class="line">column event    <span class="keyword">format</span> a32</span>
<span class="line">column JOB_NAME        <span class="keyword">format</span> a3<span class="number">0</span></span>
<span class="line">column PROGRAM_NAME    <span class="keyword">format</span> a32</span>
<span class="line">column STATE           <span class="keyword">format</span> a1<span class="number">0</span></span>
<span class="line">column window_name           <span class="keyword">format</span> a3<span class="number">0</span></span>
<span class="line">column repeat_interval       <span class="keyword">format</span> a6<span class="number">0</span></span>
<span class="line">column machine <span class="keyword">format</span> a3<span class="number">0</span></span>
<span class="line">column program <span class="keyword">format</span> a3<span class="number">0</span></span>
<span class="line">column osuser <span class="keyword">format</span> a15</span>
<span class="line">column username <span class="keyword">format</span> a15</span>
<span class="line">column event <span class="keyword">format</span> a5<span class="number">0</span></span>
<span class="line">column seconds <span class="keyword">format</span> a1<span class="number">0</span></span>
<span class="line">column sqltext <span class="keyword">format</span> a10<span class="number">0</span></span>
<span class="line"></span>
<span class="line">SET markup html off</span>
<span class="line">column dbid new_value spool_dbid</span>
<span class="line">column inst_num new_value spool_inst_num</span>
<span class="line"><span class="keyword">select</span> dbid from v$database where rownum = <span class="number">1</span>;</span>
<span class="line"><span class="keyword">select</span> instance_number as inst_num from v$instance where rownum = <span class="number">1</span>;</span>
<span class="line">column spoolfile_name new_value spoolfile</span>
<span class="line"><span class="keyword">select</span> <span class="string">'spool_'</span>||(<span class="keyword">select</span> name from v$database where rownum=<span class="number">1</span>) ||<span class="string">'_'</span>|| (<span class="keyword">select</span> instance_number from v$instance where rownum=<span class="number">1</span>)||<span class="string">'_'</span>||to_char(sysdate,<span class="string">'yy-mm-dd_hh24.mi'</span>) as spoolfile_name from dual;</span>
<span class="line">spool &amp;&amp;spoolfile..html</span>
<span class="line"></span>
<span class="line">SET markup html off</span>
<span class="line">set serveroutput on;</span>
<span class="line"><span class="keyword">exec</span> dbms_output.enable(<span class="number">9999999999</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'&lt;html&gt;'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'&lt;style&gt;'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'th &#123;font:bold 8pt Arial,Helvetica,Geneva,sans-serif; color:White; background:#0066CC;padding-left:4px; padding-right:4px;padding-bottom:2px&#125;'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'&lt;/style&gt;'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'&lt;head&gt;'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'&lt;/head&gt;'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'&lt;body&gt;'</span>);</span>
<span class="line"></span>
<span class="line">SET markup html on</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;VERSION</span>
<span class="line"><span class="keyword">select</span> * from v$version;</span>
<span class="line"><span class="keyword">select</span> * from dba_registry_history;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Last startup <span class="keyword">time</span>, version, <span class="keyword">and</span> whether RAC</span>
<span class="line"><span class="keyword">select</span> * from</span>
<span class="line"> (<span class="keyword">select</span> name db_name from v$database),</span>
<span class="line"> (<span class="keyword">select</span> instance_name from v$instance),</span>
<span class="line"> (<span class="keyword">select</span> archiver from v$instance),</span>
<span class="line"> (<span class="keyword">select</span> snap_interval awr_interval, retention awr_retention FROM DBA_HIST_WR_CONTROL),</span>
<span class="line"> (<span class="keyword">select</span> flashback_on from v$database),</span>
<span class="line"> (<span class="keyword">select</span> parallel from v$instance),</span>
<span class="line"> (<span class="keyword">select</span> startup_time from v$instance),</span>
<span class="line"> (<span class="keyword">select</span> decode(name,null,<span class="string">'NOT ASM'</span>,<span class="string">'ASM'</span>) IS_ASM from (<span class="keyword">select</span> null name from dual union all (<span class="keyword">select</span> name IS_ASM from v$datafile where name like <span class="string">'+%'</span> <span class="keyword">and</span> rownum = <span class="number">1</span>))),</span>
<span class="line"> (<span class="keyword">select</span> max(end_time) rman_lastcompleted from v$rman_status where status = <span class="string">'COMPLETED'</span> <span class="keyword">and</span> object_type like <span class="string">'DB FULL'</span>)</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;CPU <span class="keyword">or</span> <span class="keyword">wait</span> <span class="keyword">for</span> the longest in <span class="number">30</span> minutes</span>
<span class="line"><span class="keyword">select</span> t.*, s.sid, s.serial<span class="comment">#, s.machine, s.program, s.osuser</span></span>
<span class="line">  from (<span class="keyword">select</span> c.USERNAME,</span>
<span class="line">               a.event,</span>
<span class="line">               to_char(a.cnt) as seconds,</span>
<span class="line">               a.sql_id</span>
<span class="line">               --,dbms_lob.substr(b.sql_fulltext,<span class="number">50</span>,<span class="number">1</span>) sqltext</span>
<span class="line">          from (<span class="keyword">select</span> rownum rn, t.*</span>
<span class="line">                  from (<span class="keyword">select</span> decode(s.session_state,</span>
<span class="line">                                      <span class="string">'WAITING'</span>,</span>
<span class="line">                                      s.event,</span>
<span class="line">                                      <span class="string">'Cpu + Wait For Cpu'</span>) Event,</span>
<span class="line">                               s.sql_id,</span>
<span class="line">                               s.user_id,</span>
<span class="line">                               count(*) CNT</span>
<span class="line">                          from v$active_session_history <span class="keyword">s</span></span>
<span class="line">                         where sample_time &gt; sysdate - <span class="number">30</span> / <span class="number">1440</span></span>
<span class="line">                         group by s.user_id,</span>
<span class="line">                                  decode(s.session_state,</span>
<span class="line">                                         <span class="string">'WAITING'</span>,</span>
<span class="line">                                         s.event,</span>
<span class="line">                                         <span class="string">'Cpu + Wait For Cpu'</span>),</span>
<span class="line">                                  s.sql_id</span>
<span class="line">                         order by CNT desc) t</span>
<span class="line">                 where rownum &lt; <span class="number">20</span>) a,</span>
<span class="line">               v$sqlarea b,</span>
<span class="line">               dba_users c</span>
<span class="line">         where a.sql_id = b.sql_id</span>
<span class="line">           <span class="keyword">and</span> a.user_id = c.user_id</span>
<span class="line">         order by CNT desc) t,</span>
<span class="line">       v$session <span class="keyword">s</span></span>
<span class="line">where t.sql_id = s.sql_id(+)</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Recent load status (based on AWR snapshot</span>
<span class="line"><span class="keyword">select</span> s.snap_date,</span>
<span class="line">       decode(s.redosize, null, <span class="string">'--shutdown or end--'</span>, s.currtime) <span class="string">"TIME"</span>,</span>
<span class="line">       to_char(round(s.seconds/<span class="number">60</span>,<span class="number">2</span>)) <span class="string">"elapse(min)"</span>,</span>
<span class="line">       round(t.db_time / <span class="number">1000000</span> / <span class="number">60</span>, <span class="number">2</span>) <span class="string">"DB time(min)"</span>,</span>
<span class="line">       s.redosize <span class="keyword">redo</span>,</span>
<span class="line">       round(s.redosize / s.seconds, <span class="number">2</span>) <span class="string">"redo/s"</span>,</span>
<span class="line">       s.logicalreads logical,</span>
<span class="line">       round(s.logicalreads / s.seconds, <span class="number">2</span>) <span class="string">"logical/s"</span>,</span>
<span class="line">       physicalreads physical,</span>
<span class="line">       round(s.physicalreads / s.seconds, <span class="number">2</span>) <span class="string">"phy/s"</span>,</span>
<span class="line">       s.executes execs,</span>
<span class="line">       round(s.executes / s.seconds, <span class="number">2</span>) <span class="string">"execs/s"</span>,</span>
<span class="line">       s.parse,</span>
<span class="line">       round(s.parse / s.seconds, <span class="number">2</span>) <span class="string">"parse/s"</span>,</span>
<span class="line">       s.hardparse,</span>
<span class="line">       round(s.hardparse / s.seconds, <span class="number">2</span>) <span class="string">"hardparse/s"</span>,</span>
<span class="line">       s.transactions trans,</span>
<span class="line">       round(s.transactions / s.seconds, <span class="number">2</span>) <span class="string">"trans/s"</span></span>
<span class="line">  from (<span class="keyword">select</span> curr_redo - last_redo redosize,</span>
<span class="line">               curr_logicalreads - last_logicalreads logicalreads,</span>
<span class="line">               curr_physicalreads - last_physicalreads physicalreads,</span>
<span class="line">               curr_executes - last_executes executes,</span>
<span class="line">               curr_parse - last_parse parse,</span>
<span class="line">               curr_hardparse - last_hardparse hardparse,</span>
<span class="line">               curr_transactions - last_transactions transactions,</span>
<span class="line">               round(((currtime + <span class="number">0</span>) - (lasttime + <span class="number">0</span>)) * <span class="number">3600</span> * <span class="number">24</span>, <span class="number">0</span>) seconds,</span>
<span class="line">               to_char(currtime, <span class="string">'yy/mm/dd'</span>) snap_date,</span>
<span class="line">               to_char(currtime, <span class="string">'hh24:mi'</span>) currtime,</span>
<span class="line">               currsnap_id endsnap_id,</span>
<span class="line">               to_char(startup_time, <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) startup_time</span>
<span class="line">          from (<span class="keyword">select</span> a.redo last_redo,</span>
<span class="line">                       a.logicalreads last_logicalreads,</span>
<span class="line">                       a.physicalreads last_physicalreads,</span>
<span class="line">                       a.executes last_executes,</span>
<span class="line">                       a.parse last_parse,</span>
<span class="line">                       a.hardparse last_hardparse,</span>
<span class="line">                       a.transactions last_transactions,</span>
<span class="line">                       lead(a.redo, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) curr_redo,</span>
<span class="line">                       lead(a.logicalreads, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) curr_logicalreads,</span>
<span class="line">                       lead(a.physicalreads, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) curr_physicalreads,</span>
<span class="line">                       lead(a.executes, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) curr_executes,</span>
<span class="line">                       lead(a.parse, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) curr_parse,</span>
<span class="line">                       lead(a.hardparse, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) curr_hardparse,</span>
<span class="line">                       lead(a.transactions, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) curr_transactions,</span>
<span class="line">                       b.end_interval_time lasttime,</span>
<span class="line">                       lead(b.end_interval_time, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) currtime,</span>
<span class="line">                       lead(b.snap_id, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) currsnap_id,</span>
<span class="line">                       b.startup_time</span>
<span class="line">                  from (<span class="keyword">select</span> snap_id,</span>
<span class="line">                               dbid,</span>
<span class="line">                               instance_number,</span>
<span class="line">                               sum(decode(stat_name, <span class="string">'redo size'</span>, value, <span class="number">0</span>)) <span class="keyword">redo</span>,</span>
<span class="line">                               sum(decode(stat_name,</span>
<span class="line">                                          <span class="string">'session logical reads'</span>,</span>
<span class="line">                                          value,</span>
<span class="line">                                          <span class="number">0</span>)) logicalreads,</span>
<span class="line">                               sum(decode(stat_name,</span>
<span class="line">                                          <span class="string">'physical reads'</span>,</span>
<span class="line">                                          value,</span>
<span class="line">                                          <span class="number">0</span>)) physicalreads,</span>
<span class="line">                               sum(decode(stat_name, <span class="string">'execute count'</span>, value, <span class="number">0</span>)) executes,</span>
<span class="line">                               sum(decode(stat_name,</span>
<span class="line">                                          <span class="string">'parse count (total)'</span>,</span>
<span class="line">                                          value,</span>
<span class="line">                                          <span class="number">0</span>)) parse,</span>
<span class="line">                               sum(decode(stat_name,</span>
<span class="line">                                          <span class="string">'parse count (hard)'</span>,</span>
<span class="line">                                          value,</span>
<span class="line">                                          <span class="number">0</span>)) hardparse,</span>
<span class="line">                               sum(decode(stat_name,</span>
<span class="line">                                          <span class="string">'user rollbacks'</span>,</span>
<span class="line">                                          value,</span>
<span class="line">                                          <span class="string">'user commits'</span>,</span>
<span class="line">                                          value,</span>
<span class="line">                                          <span class="number">0</span>)) transactions</span>
<span class="line">                          from dba_hist_sysstat</span>
<span class="line">                         where stat_name in</span>
<span class="line">                               (<span class="string">'redo size'</span>,</span>
<span class="line">                                <span class="string">'session logical reads'</span>,</span>
<span class="line">                                <span class="string">'physical reads'</span>,</span>
<span class="line">                                <span class="string">'execute count'</span>,</span>
<span class="line">                                <span class="string">'user rollbacks'</span>,</span>
<span class="line">                                <span class="string">'user commits'</span>,</span>
<span class="line">                                <span class="string">'parse count (hard)'</span>,</span>
<span class="line">                                <span class="string">'parse count (total)'</span>)</span>
<span class="line">                         group by snap_id, dbid, instance_number) a,</span>
<span class="line">                       dba_hist_snapshot b</span>
<span class="line">                 where a.snap_id = b.snap_id</span>
<span class="line">                   <span class="keyword">and</span> a.dbid = b.dbid</span>
<span class="line">                   <span class="keyword">and</span> a.instance_number = b.instance_number</span>
<span class="line">                   <span class="keyword">and</span> a.dbid = &amp;&amp;spool_dbid</span>
<span class="line">                   <span class="keyword">and</span> a.instance_number = &amp;&amp;spool_inst_num</span>
<span class="line">                 order by end_interval_time)) <span class="keyword">s</span>,</span>
<span class="line">       (<span class="keyword">select</span> lead(a.value, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) - a.value db_time,</span>
<span class="line">               lead(b.snap_id, <span class="number">1</span>, null) over(partition by b.startup_time order by b.end_interval_time) endsnap_id</span>
<span class="line">          from dba_hist_sys_time_model a, dba_hist_snapshot b</span>
<span class="line">         where a.snap_id = b.snap_id</span>
<span class="line">           <span class="keyword">and</span> a.dbid = b.dbid</span>
<span class="line">           <span class="keyword">and</span> a.instance_number = b.instance_number</span>
<span class="line">           <span class="keyword">and</span> a.stat_name = <span class="string">'DB time'</span></span>
<span class="line">           <span class="keyword">and</span> a.dbid = &amp;&amp;spool_dbid</span>
<span class="line">           <span class="keyword">and</span> a.instance_number = &amp;&amp;spool_inst_num) t</span>
<span class="line"> where s.endsnap_id = t.endsnap_id</span>
<span class="line">order by s.snap_date desc ,<span class="keyword">time</span> asc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;逻辑读最多</span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> sql_id,</span>
<span class="line">               s.EXECUTIONS,</span>
<span class="line">               s.LAST_LOAD_TIME,</span>
<span class="line">               s.FIRST_LOAD_TIME,</span>
<span class="line">               s.DISK_READS,</span>
<span class="line">               s.BUFFER_GETS</span>
<span class="line">          from v$sql <span class="keyword">s</span></span>
<span class="line">         where s.buffer_gets &gt; <span class="number">300</span></span>
<span class="line">         order by buffer_gets desc)</span>
<span class="line">where rownum &lt;= <span class="number">10</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Logical <span class="keyword">read</span> most</span>
<span class="line"><span class="keyword">select</span> * from (<span class="keyword">select</span> sql_id,</span>
<span class="line">       s.EXECUTIONS,</span>
<span class="line">       s.LAST_LOAD_TIME,</span>
<span class="line">       s.FIRST_LOAD_TIME,</span>
<span class="line">       s.DISK_READS,</span>
<span class="line">       s.BUFFER_GETS,</span>
<span class="line">       s.PARSE_CALLS</span>
<span class="line">  from v$sql <span class="keyword">s</span></span>
<span class="line">where s.disk_reads &gt; <span class="number">300</span></span>
<span class="line">order by disk_reads desc)</span>
<span class="line">where rownum&lt;=<span class="number">10</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Maximum number of executions</span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> sql_id,</span>
<span class="line">               s.EXECUTIONS,</span>
<span class="line">               s.LAST_LOAD_TIME,</span>
<span class="line">               s.FIRST_LOAD_TIME,</span>
<span class="line">               s.DISK_READS,</span>
<span class="line">               s.BUFFER_GETS,</span>
<span class="line">               s.PARSE_CALLS</span>
<span class="line">          from v$sql <span class="keyword">s</span></span>
<span class="line">         order by s.EXECUTIONS desc)</span>
<span class="line">where rownum &lt;= <span class="number">10</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;SQL parsing most</span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> sql_id,</span>
<span class="line">               s.EXECUTIONS,</span>
<span class="line">               s.LAST_LOAD_TIME,</span>
<span class="line">               s.FIRST_LOAD_TIME,</span>
<span class="line">               s.DISK_READS,</span>
<span class="line">               s.BUFFER_GETS,</span>
<span class="line">               s.PARSE_CALLS</span>
<span class="line">          from v$sql <span class="keyword">s</span></span>
<span class="line">         order by s.PARSE_CALLS desc)</span>
<span class="line">where rownum &lt;= <span class="number">10</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;The disk is sorted most</span>
<span class="line"><span class="keyword">select</span> sess.username, sql.address, sort1.blocks</span>
<span class="line">  from v$session sess, v$sqlarea sql, v$sort_usage sort1</span>
<span class="line">where sess.serial<span class="comment"># = sort1.session_num</span></span>
<span class="line">   <span class="keyword">and</span> sort1.sqladdr = sql.address</span>
<span class="line">   <span class="keyword">and</span> sort1.sqlhash = sql.hash_value</span>
<span class="line">   <span class="keyword">and</span> sort1.blocks &gt; <span class="number">200</span></span>
<span class="line">order by sort1.blocks desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Commits more than <span class="number">10</span>,<span class="number">000</span> session</span>
<span class="line"><span class="keyword">select</span> t1.sid, t1.value, t2.name</span>
<span class="line">  from v$sesstat t1, v$statname t2</span>
<span class="line"> where t2.name like <span class="string">'%user commits%'</span></span>
<span class="line">   <span class="keyword">and</span> t1.STATISTIC<span class="comment"># = t2.STATISTIC#</span></span>
<span class="line">   <span class="keyword">and</span> value &gt;= <span class="number">10000</span></span>
<span class="line"> order by value desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;SQL with a <span class="keyword">length</span> of more than <span class="number">100</span></span>
<span class="line">SELECT SQL_ID, COUNT(*) line_count</span>
<span class="line">  FROM V$SQLTEXT</span>
<span class="line"> GROUP BY SQL_ID</span>
<span class="line">HAVING COUNT(*) &gt;= <span class="number">100</span></span>
<span class="line"> ORDER BY COUNT(*) DESC</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Query shared memory share</span>
<span class="line"><span class="keyword">select</span> count(*),round(sum(sharable_mem)/<span class="number">1024</span>/<span class="number">1024</span>,<span class="number">2</span>)</span>
<span class="line">  from v$db_object_cache a</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Table with parallelism</span>
<span class="line"><span class="keyword">select</span> t.owner, t.table_name, degree</span>
<span class="line">  from dba_tables t</span>
<span class="line">where  trim(t.degree) &lt;&gt;<span class="string">'1'</span></span>
<span class="line">   <span class="keyword">and</span> trim(t.degree)&lt;&gt;<span class="string">'0'</span></span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>,<span class="string">'ORDSYS'</span>,<span class="string">'DBSNMP'</span>,<span class="string">'OUTLN'</span>,<span class="string">'TSMSYS'</span>)</span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'WK%'</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Index with parallelism</span>
<span class="line"><span class="keyword">select</span> t.owner, t.table_name, index_name, degree, status</span>
<span class="line">  from dba_indexes t</span>
<span class="line">where  trim(t.degree) &lt;&gt;<span class="string">'1'</span></span>
<span class="line">   <span class="keyword">and</span> trim(t.degree)&lt;&gt;<span class="string">'0'</span></span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>,<span class="string">'ORDSYS'</span>,<span class="string">'DBSNMP'</span>,<span class="string">'OUTLN'</span>,<span class="string">'TSMSYS'</span>)</span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'WK%'</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Invalid <span class="keyword">index</span></span>
<span class="line"><span class="keyword">select</span> t.index_name,</span>
<span class="line">       t.table_name,</span>
<span class="line">       blevel,</span>
<span class="line">       t.num_rows,</span>
<span class="line">       t.leaf_blocks,</span>
<span class="line">       t.distinct_keys</span>
<span class="line">  from dba_indexes t</span>
<span class="line">  where status = <span class="string">'UNUSABLE'</span></span>
<span class="line">  <span class="keyword">and</span>  table_owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>)</span>
<span class="line">  <span class="keyword">and</span>  table_owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">;</span>
<span class="line"><span class="keyword">select</span> t2.owner,</span>
<span class="line">       t1.blevel,</span>
<span class="line">       t1.leaf_blocks,</span>
<span class="line">       t1.INDEX_NAME,</span>
<span class="line">       t2.table_name,</span>
<span class="line">       t1.PARTITION_NAME,</span>
<span class="line">       t1.STATUS</span>
<span class="line">  from dba_ind_partitions t1, dba_indexes t2</span>
<span class="line">where t1.index_name = t2.index_name</span>
<span class="line">   <span class="keyword">and</span> t1.STATUS = <span class="string">'UNUSABLE'</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Invalid object</span>
<span class="line"><span class="keyword">select</span> t.owner,</span>
<span class="line">       t.object_type,</span>
<span class="line">       t.object_name</span>
<span class="line">  from dba_objects t</span>
<span class="line"> where STATUS=<span class="string">'INVALID'</span></span>
<span class="line">order by <span class="number">1</span>, <span class="number">2</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Bitmap <span class="keyword">index</span> <span class="keyword">and</span> function <span class="keyword">index</span>, <span class="keyword">reverse</span> key <span class="keyword">index</span></span>
<span class="line"><span class="keyword">select</span> t.owner,</span>
<span class="line">       t.table_name,</span>
<span class="line">       t.index_name,</span>
<span class="line">       t.index_type,</span>
<span class="line">       t.status,</span>
<span class="line">       t.blevel,</span>
<span class="line">       t.leaf_blocks</span>
<span class="line">  from dba_indexes t</span>
<span class="line"> where index_type in (<span class="string">'BITMAP'</span>, <span class="string">'FUNCTION-BASED NORMAL'</span>, <span class="string">'NORMAL/REV'</span>)</span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>,<span class="string">'ORDSYS'</span>,<span class="string">'DBSNMP'</span>,<span class="string">'OUTLN'</span>,<span class="string">'TSMSYS'</span>)</span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'WK%'</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;The combination of <span class="keyword">index</span> columns is more than four</span>
<span class="line"><span class="keyword">select</span> table_owner,table_name, index_name, count(*)</span>
<span class="line">  from dba_ind_columns</span>
<span class="line">where  table_owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>,<span class="string">'ORDSYS'</span>,<span class="string">'DBSNMP'</span>,<span class="string">'OUTLN'</span>,<span class="string">'TSMSYS'</span>)</span>
<span class="line">   <span class="keyword">and</span> table_owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">   <span class="keyword">and</span> table_owner <span class="keyword">not</span> like <span class="string">'WK%'</span></span>
<span class="line"> group by table_owner,table_name, index_name</span>
<span class="line">having count(*) &gt;= <span class="number">4</span></span>
<span class="line"> order by count(*) desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Indexed more than <span class="number">5</span> numbers</span>
<span class="line"><span class="keyword">select</span> owner,table_name, count(*) cnt</span>
<span class="line">  from dba_indexes</span>
<span class="line">where  owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>,<span class="string">'ORDSYS'</span>,<span class="string">'DBSNMP'</span>,<span class="string">'OUTLN'</span>,<span class="string">'TSMSYS'</span>)</span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'WK%'</span></span>
<span class="line"> group by owner,table_name</span>
<span class="line">having count(*) &gt;= <span class="number">5</span></span>
<span class="line">order by cnt desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Never indexed a large table</span>
<span class="line"><span class="keyword">select</span> segment_name,</span>
<span class="line">       bytes / <span class="number">1024</span> / <span class="number">1024</span> / <span class="number">1024</span> <span class="string">"GB"</span>,</span>
<span class="line">       blocks,</span>
<span class="line">       tablespace_name</span>
<span class="line">  from dba_segments</span>
<span class="line"> where segment_type = <span class="string">'TABLE'</span></span>
<span class="line">   <span class="keyword">and</span> segment_name <span class="keyword">not</span> in (<span class="keyword">select</span> table_name from dba_indexes)</span>
<span class="line">   <span class="keyword">and</span> bytes / <span class="number">1024</span> / <span class="number">1024</span> / <span class="number">1024</span> &gt;= <span class="number">0</span>.<span class="number">5</span></span>
<span class="line"> order by GB desc</span>
<span class="line">;</span>
<span class="line"><span class="keyword">select</span> segment_name, sum(bytes) / <span class="number">1024</span> / <span class="number">1024</span> / <span class="number">1024</span> <span class="string">"GB"</span>, sum(blocks)</span>
<span class="line">  from dba_segments</span>
<span class="line"> where segment_type = <span class="string">'TABLE PARTITION'</span></span>
<span class="line">   <span class="keyword">and</span> segment_name <span class="keyword">not</span> in (<span class="keyword">select</span> table_name from dba_indexes)</span>
<span class="line"> group by segment_name</span>
<span class="line">having sum(bytes) / <span class="number">1024</span> / <span class="number">1024</span> / <span class="number">1024</span> &gt;= <span class="number">0</span>.<span class="number">5</span></span>
<span class="line"> order by GB desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;There is a cross between the combined <span class="keyword">index</span> of the table <span class="keyword">and</span> the single column <span class="keyword">index</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> table_name, trunc(count(distinct(column_name)) / count(*),<span class="number">2</span>) cross_idx_rate</span>
<span class="line">  from dba_ind_columns</span>
<span class="line"> where table_owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>,<span class="string">'ORDSYS'</span>,<span class="string">'DBSNMP'</span>,<span class="string">'OUTLN'</span>,<span class="string">'TSMSYS'</span>)</span>
<span class="line">   <span class="keyword">and</span> table_owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">   <span class="keyword">and</span> table_owner <span class="keyword">not</span> like <span class="string">'WK%'</span></span>
<span class="line"> group by table_name</span>
<span class="line">having count(distinct(column_name)) / count(*) &lt; <span class="number">1</span> </span>
<span class="line">order by cross_idx_rate desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Object is built on the <span class="keyword">system</span> tablespace</span>
<span class="line"><span class="keyword">select</span> * from (</span>
<span class="line"><span class="keyword">select</span> owner, segment_name, tablespace_name, count(*) num</span>
<span class="line">  from dba_segments</span>
<span class="line"> where tablespace_name in(<span class="string">'SYSTEM'</span>,<span class="string">'SYSAUX'</span>)</span>
<span class="line">group by owner, segment_name, tablespace_name)</span>
<span class="line">where  owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>,<span class="string">'ORDSYS'</span>,<span class="string">'DBSNMP'</span>,<span class="string">'OUTLN'</span>,<span class="string">'TSMSYS'</span>)</span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">   <span class="keyword">and</span> owner <span class="keyword">not</span> like <span class="string">'WK%'</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Check whether the statistics are collected</span>
<span class="line"><span class="keyword">select</span> t.job_name,t.program_name,t.state,t.enabled</span>
<span class="line">  from dba_scheduler_jobs t</span>
<span class="line">where job_name = <span class="string">'GATHER_STATS_JOB'</span></span>
<span class="line">;</span>
<span class="line"><span class="keyword">select</span> client_name,status</span>
<span class="line">  from dba_autotask_client</span>
<span class="line">;</span>
<span class="line"><span class="keyword">select</span> window_next_time,autotask_status</span>
<span class="line">  from DBA_AUTOTASK_WINDOW_CLIENTS</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Check the object that was <span class="keyword">not</span> collected <span class="keyword">or</span> collected <span class="keyword">for</span> a long <span class="keyword">time</span></span>
<span class="line"><span class="keyword">select</span> owner, count(*)</span>
<span class="line">  from dba_tab_statistics t</span>
<span class="line">where (t.last_analyzed is null <span class="keyword">or</span> t.last_analyzed &lt; sysdate - <span class="number">100</span>)</span>
<span class="line">   <span class="keyword">and</span> table_name <span class="keyword">not</span> like <span class="string">'BIN$%'</span></span>
<span class="line">group by owner</span>
<span class="line">order by owner</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Temporary table <span class="keyword">for</span> collecting statistical information</span>
<span class="line"><span class="keyword">select</span> owner, table_name, t.last_analyzed, t.num_rows, t.blocks</span>
<span class="line">  from dba_tables t</span>
<span class="line">where t.temporary = <span class="string">'Y'</span></span>
<span class="line">   <span class="keyword">and</span> last_analyzed is <span class="keyword">not</span> null</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Log switching frequency analysis</span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> thread<span class="comment">#, sequence#, to_char(first_time, 'MM/DD/RR HH24:MI:SS')</span></span>
<span class="line">          from v$log_history</span>
<span class="line">         order by first_time desc)</span>
<span class="line"> where rownum &lt;= <span class="number">50</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;The amount of <span class="keyword">log</span> switch every day in the <span class="keyword">last</span> <span class="number">10</span> days</span>
<span class="line">SELECT SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH:MI:SS'</span>),<span class="number">1</span>,<span class="number">5</span>) Day,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'00'</span>,<span class="number">1</span>,<span class="number">0</span>)) H0<span class="number">0</span>,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'01'</span>,<span class="number">1</span>,<span class="number">0</span>)) H01,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'02'</span>,<span class="number">1</span>,<span class="number">0</span>)) H02,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'03'</span>,<span class="number">1</span>,<span class="number">0</span>)) H03,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'04'</span>,<span class="number">1</span>,<span class="number">0</span>)) H04,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'05'</span>,<span class="number">1</span>,<span class="number">0</span>)) H05,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'06'</span>,<span class="number">1</span>,<span class="number">0</span>)) H06,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'07'</span>,<span class="number">1</span>,<span class="number">0</span>)) H07,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'08'</span>,<span class="number">1</span>,<span class="number">0</span>)) H08,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'09'</span>,<span class="number">1</span>,<span class="number">0</span>)) H09,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'10'</span>,<span class="number">1</span>,<span class="number">0</span>)) H1<span class="number">0</span>,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'11'</span>,<span class="number">1</span>,<span class="number">0</span>)) H11,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'12'</span>,<span class="number">1</span>,<span class="number">0</span>)) H12,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'13'</span>,<span class="number">1</span>,<span class="number">0</span>)) H13,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'14'</span>,<span class="number">1</span>,<span class="number">0</span>)) H14,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'15'</span>,<span class="number">1</span>,<span class="number">0</span>)) H15,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'16'</span>,<span class="number">1</span>,<span class="number">0</span>)) H16,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'17'</span>,<span class="number">1</span>,<span class="number">0</span>)) H17,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'18'</span>,<span class="number">1</span>,<span class="number">0</span>)) H18,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'19'</span>,<span class="number">1</span>,<span class="number">0</span>)) H19,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'20'</span>,<span class="number">1</span>,<span class="number">0</span>)) H2<span class="number">0</span>,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'21'</span>,<span class="number">1</span>,<span class="number">0</span>)) H21,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'22'</span>,<span class="number">1</span>,<span class="number">0</span>)) H22 ,</span>
<span class="line">       SUM(DECODE(SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH24:MI:SS'</span>),<span class="number">10</span>,<span class="number">2</span>),<span class="string">'23'</span>,<span class="number">1</span>,<span class="number">0</span>)) H23,</span>
<span class="line">       COUNT(*) TOTAL</span>
<span class="line">FROM v$log_history  a</span>
<span class="line">   where first_time&gt;=to_char(sysdate-<span class="number">11</span>)</span>
<span class="line">GROUP BY SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH:MI:SS'</span>),<span class="number">1</span>,<span class="number">5</span>)</span>
<span class="line">ORDER BY SUBSTR(TO_CHAR(first_time, <span class="string">'MM/DD/RR HH:MI:SS'</span>),<span class="number">1</span>,<span class="number">5</span>) DESC</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Log group size</span>
<span class="line"><span class="keyword">select</span> group<span class="comment">#,bytes,status</span></span>
<span class="line">  from v$log</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;show recovery_file_dest usage</span>
<span class="line"> <span class="keyword">select</span> <span class="keyword">substr</span>(name, <span class="number">1</span>, <span class="number">30</span>) name,</span>
<span class="line">        space_limit as quota,</span>
<span class="line">        space_used as used,</span>
<span class="line">        space_reclaimable as reclaimable,</span>
<span class="line">        number_of_files as files</span>
<span class="line">   from v$recovery_file_dest</span>
<span class="line">;</span>
<span class="line"><span class="keyword">select</span> * from V$FLASH_RECOVERY_AREA_USAGE</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Check <span class="keyword">if</span> the sequence is less than <span class="number">20</span></span>
<span class="line"><span class="keyword">select</span> sequence_owner,</span>
<span class="line">       count(*) CNT,</span>
<span class="line">       sum(case <span class="keyword">when</span> t.cache_size &lt;= <span class="number">20</span> then <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> end ) CNT_LESS_2<span class="number">0</span>,</span>
<span class="line">       sum(case <span class="keyword">when</span> t.cache_size &gt; <span class="number">20</span> then <span class="number">1</span> <span class="keyword">else</span> <span class="number">0</span> end ) CNT_MORE_2<span class="number">0</span></span>
<span class="line">  from dba_sequences t</span>
<span class="line"> group by sequence_owner</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Table space usage</span>
<span class="line">set markup html off</span>
<span class="line">prompt &lt;p&gt;</span>
<span class="line">declare</span>
<span class="line">  type NUMBER_ARRAY is table of number(<span class="number">15</span>) <span class="keyword">index</span> by varchar2(<span class="number">30</span>);</span>
<span class="line">  ts_free_mb NUMBER_ARRAY;</span>
<span class="line">  cursor c1 is</span>
<span class="line">    <span class="keyword">select</span> tablespace_name, sum(free_mb) + sum(expired_mb) free_mb</span>
<span class="line">      from (SELECT tablespace_name,</span>
<span class="line">                   round(sum(nvl(bytes, <span class="number">0</span>)) / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) free_mb,</span>
<span class="line">                   <span class="number">0</span> expired_mb</span>
<span class="line">              FROM dba_free_space</span>
<span class="line">             GROUP BY tablespace_name</span>
<span class="line">            union all</span>
<span class="line">            <span class="keyword">select</span> tablespace_name,</span>
<span class="line">                   <span class="number">0</span> free_mb,</span>
<span class="line">                   round(sum(nvl(bytes, <span class="number">0</span>)) / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) expired_mb</span>
<span class="line">              from dba_undo_extents d</span>
<span class="line">             where tablespace_name =</span>
<span class="line">                   (<span class="keyword">select</span> value</span>
<span class="line">                      from v$parameter</span>
<span class="line">                     where name = <span class="string">'undo_tablespace'</span>)</span>
<span class="line">               <span class="keyword">and</span> status = <span class="string">'EXPIRED'</span></span>
<span class="line">             group by tablespace_name)</span>
<span class="line">     group by tablespace_name;</span>
<span class="line">  cursor c2 is</span>
<span class="line">    SELECT /*+ rule *<span class="regexp">/</span>
<span class="line">     tablespace_name, round(sum(bytes) /</span> <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) total_mb</span>
<span class="line">      FROM dba_data_files</span>
<span class="line">     where tablespace_name <span class="keyword">not</span> in</span>
<span class="line">           (<span class="keyword">select</span> tablespace_name</span>
<span class="line">              from dba_data_files</span>
<span class="line">             where upper(AUTOEXTENSIBLE) = <span class="string">'YES'</span>)</span>
<span class="line">     GROUP BY tablespace_name;</span>
<span class="line">  ts_name  varchar2(<span class="number">30</span>);</span>
<span class="line">  ts_total number(<span class="number">15</span>);</span>
<span class="line">  ts_used  number(<span class="number">15</span>);</span>
<span class="line">  ts_free  number(<span class="number">15</span>);</span>
<span class="line">  ts_rate  varchar2(<span class="number">5</span>);</span>
<span class="line">begin</span>
<span class="line">  <span class="keyword">for</span> rec1 in c1 loop</span>
<span class="line">    ts_free_mb(rec1.tablespace_name) := rec1.free_mb;</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;table border="1" width="90%" align="center" summary="Script output"&gt;'</span>);</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;th&gt;ts_name&lt;/th&gt;&lt;th&gt;ts_total&lt;/th&gt;&lt;th&gt;ts_used&lt;/th&gt;&lt;th&gt;ts_free&lt;/th&gt;&lt;th&gt;ts_rate&lt;/th&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  <span class="keyword">for</span> rec2 in c2 loop</span>
<span class="line">    ts_name  := null;</span>
<span class="line">    ts_total := null;</span>
<span class="line">    ts_used  := null;</span>
<span class="line">    ts_free  := null;</span>
<span class="line">    ts_rate  := null;</span>
<span class="line">    ts_name  := rec2.tablespace_name;</span>
<span class="line">    ts_total := rec2.total_mb;</span>
<span class="line">    ts_free  := nvl(ts_free_mb(ts_name), <span class="number">0</span>);</span>
<span class="line">    ts_used  := nvl(ts_total - ts_free, <span class="number">0</span>);</span>
<span class="line">    ts_rate  := to_char(round((ts_total - ts_free) / ts_total * <span class="number">100</span>, <span class="number">2</span>),</span>
<span class="line">                        <span class="string">'fm990.99'</span>);</span>
<span class="line">    dbms_output.put_line(<span class="string">'&lt;tr&gt;&lt;td&gt;'</span> || ts_name || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || ts_total ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || ts_used || <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || ts_free ||</span>
<span class="line">                         <span class="string">'&lt;/td&gt;&lt;td&gt;'</span> || ts_rate || <span class="string">'&lt;/td&gt;&lt;/tr&gt;'</span>);</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">'&lt;/table&gt;'</span>);</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line">prompt &lt;p&gt;</span>
<span class="line">set markup html on</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;The size of the entire database</span>
<span class="line">select owner, round(sum(bytes) /</span> <span class="number">1024</span> / <span class="number">1024</span> / <span class="number">1024</span>, <span class="number">2</span>) <span class="string">"GB"</span></span>
<span class="line">  from dba_segments</span>
<span class="line"> group by owner</span>
<span class="line"> order by <span class="number">2</span> desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Object size TOP1<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> owner,</span>
<span class="line">               segment_name,</span>
<span class="line">               segment_type,</span>
<span class="line">               round(sum(bytes) / <span class="number">1024</span> / <span class="number">1024</span>) object_size</span>
<span class="line">          from DBA_segments</span>
<span class="line">         group by owner, segment_name, segment_type</span>
<span class="line">         order by object_size desc)</span>
<span class="line">where rownum &lt;= <span class="number">10</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Recycle Bin situation (size <span class="keyword">and</span> quantity)</span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> SUM(BYTES) / <span class="number">1024</span> / <span class="number">1024</span> / <span class="number">1024</span> as recyb_size</span>
<span class="line">          from DBA_SEGMENTS</span>
<span class="line">         WHERE SEGMENT_NAME LIKE <span class="string">'BIN$%'</span>) a,</span>
<span class="line">       (<span class="keyword">select</span> count(*) as recyb_cnt from dba_recyclebin)</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Check who took up the undo tablespace</span>
<span class="line"></span>
<span class="line">SELECT r.name <span class="string">"roll_segment_name"</span>, rssize/<span class="number">1024</span>/<span class="number">1024</span>/<span class="number">1024</span> <span class="string">"RSSize(G)"</span>,</span>
<span class="line">  s.sid,</span>
<span class="line">  s.serial<span class="comment">#,</span></span>
<span class="line">  s.username,</span>
<span class="line">  s.status,</span>
<span class="line">  s.sql_hash_value,</span>
<span class="line">  s.SQL_ADDRESS,</span>
<span class="line">  s.MACHINE,</span>
<span class="line">  s.MODULE,</span>
<span class="line">  <span class="keyword">substr</span>(s.program, <span class="number">1</span>, <span class="number">78</span>) program,</span>
<span class="line">  r.usn,</span>
<span class="line">  hwmsize/<span class="number">1024</span>/<span class="number">1024</span>/<span class="number">1024</span>, shrinks ,xacts</span>
<span class="line">FROM sys.v<span class="number">_</span>$session <span class="keyword">s</span>,sys.v<span class="number">_</span>$transaction t,sys.v<span class="number">_</span>$rollname r, v$rollstat rs</span>
<span class="line">WHERE t.addr = s.taddr <span class="keyword">and</span> t.xidusn = r.usn <span class="keyword">and</span> r.usn=rs.USN</span>
<span class="line">Order by rssize desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Check who took up the temp tablespace</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> sql.sql_id,</span>
<span class="line">       t.Blocks * <span class="number">16</span> / <span class="number">1024</span> / <span class="number">1024</span>,</span>
<span class="line">       s.USERNAME,</span>
<span class="line">       s.SCHEMANAME,</span>
<span class="line">       t.tablespace,</span>
<span class="line">       t.segtype,</span>
<span class="line">       t.extents,</span>
<span class="line">       s.PROGRAM,</span>
<span class="line">       s.OSUSER,</span>
<span class="line">       s.TERMINAL,</span>
<span class="line">       s.sid,</span>
<span class="line">       s.SERIAL<span class="comment">#</span></span>
<span class="line">  from v$sort_usage t, v$session <span class="keyword">s</span> , v$sql sql</span>
<span class="line">where t.SESSION_ADDR = s.SADDR</span>
<span class="line">  <span class="keyword">and</span> t.SQLADDR=sql.ADDRESS</span>
<span class="line">  <span class="keyword">and</span> t.SQLHASH=sql.HASH_VALUE</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Observe the rollback segment, the temporary segment <span class="keyword">and</span> the general segment No is automatically expanded</span>
<span class="line"><span class="keyword">select</span> t2.contents, t1.*</span>
<span class="line">  from (<span class="keyword">select</span> file_name, tablespace_name, bytes, maxbytes, autoextensible</span>
<span class="line">          from dba_temp_files</span>
<span class="line">        union all</span>
<span class="line">        <span class="keyword">select</span> file_name, tablespace_name, bytes, maxbytes, autoextensible</span>
<span class="line">          from dba_data_files) t1,</span>
<span class="line">       dba_tablespaces t2</span>
<span class="line"> where t1.tablespace_name = t2.tablespace_name</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Table size of more than <span class="number">10</span>GB did <span class="keyword">not</span> build the partition table</span>
<span class="line"><span class="keyword">select</span> owner,</span>
<span class="line">       segment_name,</span>
<span class="line">       segment_type,</span>
<span class="line">       round(sum(bytes) / <span class="number">1024</span> / <span class="number">1024</span> / <span class="number">1024</span>,<span class="number">2</span>) object_size</span>
<span class="line">  from dba_segments</span>
<span class="line">where segment_type = <span class="string">'TABLE'</span></span>
<span class="line">  <span class="keyword">and</span> bytes &gt; <span class="number">10</span>*<span class="number">1024</span>*<span class="number">1024</span>*<span class="number">1024</span></span>
<span class="line">group by owner, segment_name, segment_type</span>
<span class="line">order by object_size desc</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;The top <span class="number">10</span> partitions are the most</span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> table_owner, table_name, count(*) cnt</span>
<span class="line">          from dba_tab_partitions</span>
<span class="line">         group by table_owner, table_name</span>
<span class="line">         order by cnt desc)</span>
<span class="line">where rownum &lt;= <span class="number">10</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Partitioned uneven table</span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> table_owner,</span>
<span class="line">               table_name,</span>
<span class="line">               max(num_rows) max_num_rows,</span>
<span class="line">               trunc(avg(num_rows), <span class="number">0</span>) avg_num_rows,</span>
<span class="line">               sum(num_rows) sum_num_rows,</span>
<span class="line">               case</span>
<span class="line">                 <span class="keyword">when</span> sum(num_rows) = <span class="number">0</span> then</span>
<span class="line">                  <span class="number">0</span></span>
<span class="line">                 <span class="keyword">else</span></span>
<span class="line">                  trunc(max(num_rows) / trunc(avg(num_rows), <span class="number">0</span>), <span class="number">2</span>)</span>
<span class="line">               end rate,</span>
<span class="line">               count(*) part_count</span>
<span class="line">          from dba_tab_partitions</span>
<span class="line">         group by table_owner, table_name)</span>
<span class="line"> where rate &gt; <span class="number">5</span>;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;A table with a column larger than <span class="number">100</span> <span class="keyword">or</span> less than <span class="number">2</span></span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> owner, table_name, count(*) col_count</span>
<span class="line">          from dba_tab_cols</span>
<span class="line">         group by owner, table_name)</span>
<span class="line"> where col_count &gt; <span class="number">100</span></span>
<span class="line">    <span class="keyword">or</span> col_count &lt;= <span class="number">2</span></span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>)</span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;The table property is NOLOGGING</span>
<span class="line"><span class="keyword">select</span> owner, table_name, tablespace_name, logging</span>
<span class="line">  from dba_tables</span>
<span class="line"> where logging = <span class="string">'NO'</span></span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>)</span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line"> ;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Table properties, containing COMPRESSION</span>
<span class="line"><span class="keyword">select</span> owner, table_name, tablespace_name, COMPRESSION</span>
<span class="line">  from dba_tables</span>
<span class="line"> where COMPRESSION = <span class="string">'ENABLED'</span></span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>)</span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;The <span class="keyword">index</span> property contains COMPRESSION</span>
<span class="line"><span class="keyword">select</span> owner, index_name, table_name, COMPRESSION</span>
<span class="line">  from dba_indexes</span>
<span class="line"> where COMPRESSION = <span class="string">'ENABLED'</span></span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>)</span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span></span>
<span class="line">;</span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Trigger</span>
<span class="line"><span class="keyword">select</span> OWNER, TRIGGER_NAME, TABLE_NAME, STATUS</span>
<span class="line">  from dba_triggers</span>
<span class="line"> where owner <span class="keyword">not</span> in (<span class="string">'SYSTEM'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'SYS'</span>,<span class="string">'CTXSYS'</span>,<span class="string">'MDSYS'</span>,<span class="string">'OLAPSYS'</span>,<span class="string">'WMSYS'</span>,<span class="string">'EXFSYS'</span>,<span class="string">'LBACSYS'</span>,<span class="string">'WKSYS'</span>,<span class="string">'XDB'</span>)</span>
<span class="line"> <span class="keyword">and</span>  owner <span class="keyword">not</span> like <span class="string">'FLOWS%'</span>;</span>
<span class="line"> </span>
<span class="line">prompt &lt;p&gt;The foreign key is <span class="keyword">not</span> indexed</span>
<span class="line"><span class="keyword">select</span> *</span>
<span class="line">  from (<span class="keyword">select</span> pk.owner PK_OWNER,</span>
<span class="line">               pk.constraint_name PK_NAME,</span>
<span class="line">               pk.table_name PK_TABLE_NAME,</span>
<span class="line">               fk.owner FK_OWNER,</span>
<span class="line">               fk.constraint_name FK_NAME,</span>
<span class="line">               fk.table_name FK_TABLE_NAME,</span>
<span class="line">               fk.delete_rule FK_DELETE_RULE,</span>
<span class="line">               ind_col.INDEX_NAME FK_INDEX_NAME,</span>
<span class="line">               ind.index_type FK_INDEX_TYPE,</span>
<span class="line">               con_col.COLUMN_NAME FK_INDEX_COLUMN_NAME,</span>
<span class="line">               con_col.POSITION FK_INDEX_COLUMN_POSITION,</span>
<span class="line">               decode(ind_col.INDEX_NAME,</span>
<span class="line">                      NULL,</span>
<span class="line">                      NULL,</span>
<span class="line">                      NVL(x_ind.status, <span class="string">'VALID'</span>)) IS_IND_VALID,</span>
<span class="line">               decode(ind_col.INDEX_NAME,</span>
<span class="line">                      NULL,</span>
<span class="line">                      NULL,</span>
<span class="line">                      NVL(x_ind_part.status, <span class="string">'VALID'</span>)) IS_IND_PART_VALID</span>
<span class="line">          from (<span class="keyword">select</span> * from dba_constraints where constraint_type = <span class="string">'R'</span>) fk,</span>
<span class="line">               (<span class="keyword">select</span> * from dba_constraints where constraint_type = <span class="string">'P'</span>) pk,</span>
<span class="line">               dba_cons_columns con_col,</span>
<span class="line">               dba_ind_columns ind_col,</span>
<span class="line">               dba_indexes ind,</span>
<span class="line">               (<span class="keyword">select</span> index_owner, index_name, status</span>
<span class="line">                  from dba_ind_partitions</span>
<span class="line">                 where status &lt;&gt; <span class="string">'VALID'</span>) x_ind_part,</span>
<span class="line">               (<span class="keyword">select</span> owner as index_owner, index_name, status</span>
<span class="line">                  from dba_indexes</span>
<span class="line">                 where status &lt;&gt; <span class="string">'VALID'</span>) x_ind</span>
<span class="line">         where fk.r_constraint_name = pk.constraint_name</span>
<span class="line">           <span class="keyword">and</span> pk.owner = fk.owner</span>
<span class="line">           <span class="keyword">and</span> fk.owner = con_col.owner</span>
<span class="line">           <span class="keyword">and</span> fk.table_name = con_col.table_name</span>
<span class="line">           <span class="keyword">and</span> fk.constraint_name = con_col.CONSTRAINT_NAME</span>
<span class="line">           <span class="keyword">and</span> con_col.owner = ind_col.TABLE_OWNER(+)</span>
<span class="line">           <span class="keyword">and</span> con_col.TABLE_NAME = ind_col.TABLE_NAME(+)</span>
<span class="line">           <span class="keyword">and</span> con_col.COLUMN_NAME = ind_col.COLUMN_NAME(+)</span>
<span class="line">           <span class="keyword">and</span> ind_col.INDEX_OWNER = ind.owner(+)</span>
<span class="line">           <span class="keyword">and</span> ind_col.INDEX_NAME = ind.index_name(+)</span>
<span class="line">           <span class="keyword">and</span> ind_col.INDEX_OWNER = x_ind.index_owner(+)</span>
<span class="line">           <span class="keyword">and</span> ind_col.INDEX_NAME = x_ind.index_name(+)</span>
<span class="line">           <span class="keyword">and</span> ind_col.INDEX_OWNER = x_ind_part.index_owner(+)</span>
<span class="line">           <span class="keyword">and</span> ind_col.INDEX_NAME = x_ind_part.index_name(+))</span>
<span class="line"> where FK_INDEX_NAME is null</span>
<span class="line"> order by FK_OWNER ASC</span>
<span class="line">;</span>
<span class="line"></span>
<span class="line"><span class="regexp">/* Bad performance</span>
<span class="line">prompt &lt;p&gt;Hot block (summary)</span>
<span class="line">SELECT *+ rule *</span>
<span class="line">         e.owner, e.segment_name, e.segment_type, sum(b.tch) tch</span>
<span class="line">          FROM dba_extents e,</span>
<span class="line">               (SELECT *</span>
<span class="line">                  FROM (SELECT addr, ts#, file#, dbarfil, dbablk, tch</span>
<span class="line">                          FROM x$bh</span>
<span class="line">                         ORDER BY tch DESC)</span>
<span class="line">                 WHERE ROWNUM &lt;= 10) b</span>
<span class="line">         WHERE e.relative_fno = b.dbarfil</span>
<span class="line">           AND e.block_id &lt;= b.dbablk</span>
<span class="line">           AND e.block_id + e.blocks &gt; b.dbablk</span>
<span class="line">           group by e.owner, e.segment_name, e.segment_type</span>
<span class="line">order by tch desc</span>
<span class="line">;</span>
<span class="line">prompt &lt;p&gt;Hot block (unfolded, not summary)</span>
<span class="line">SELECT *+ rule *</span>
<span class="line">        distinct e.owner, e.segment_name, e.segment_type, dbablk,b.tch</span>
<span class="line">          FROM dba_extents e,</span>
<span class="line">               (SELECT *</span>
<span class="line">                  FROM (SELECT addr, ts#, file#, dbarfil, dbablk, tch</span>
<span class="line">                          FROM x$bh</span>
<span class="line">                         ORDER BY tch DESC)</span>
<span class="line">                 WHERE ROWNUM &lt;= 10) b</span>
<span class="line">         WHERE e.relative_fno = b.dbarfil</span>
<span class="line">           AND e.block_id &lt;= b.dbablk</span>
<span class="line">           AND e.block_id + e.blocks &gt; b.dbablk</span>
<span class="line">order by tch desc</span>
<span class="line">;</span>
<span class="line">*/</span></span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Appendix: check the parameter settings of session_cached_cursors <span class="keyword">and</span> increase the parameter value <span class="keyword">if</span> the usage rate is <span class="number">100</span>%</span>
<span class="line">SELECT <span class="string">'session_cached_cursors'</span> PARAMETER,  </span>
<span class="line">         LPAD(VALUE, <span class="number">5</span>) VALUE,  </span>
<span class="line">         DECODE(VALUE, <span class="number">0</span>, <span class="string">' n/a'</span>, TO_CHAR(<span class="number">100</span> * USED / VALUE, <span class="string">'990'</span>) || <span class="string">'%'</span>) USAGE  </span>
<span class="line">   FROM (SELECT MAX(S.VALUE) USED  </span>
<span class="line">            FROM V$STATNAME N, V$SESSTAT S  </span>
<span class="line">           WHERE N.NAME = <span class="string">'session cursor cache count'</span>  </span>
<span class="line">             AND S.STATISTIC<span class="comment"># = N.STATISTIC#),  </span></span>
<span class="line">         (SELECT VALUE FROM V$PARAMETER WHERE NAME = <span class="string">'session_cached_cursors'</span>)  </span>
<span class="line">  UNION ALL  </span>
<span class="line">SELECT <span class="string">'open_cursors'</span>,  </span>
<span class="line">         LPAD(VALUE, <span class="number">5</span>),  </span>
<span class="line">         TO_CHAR(<span class="number">100</span> * USED / VALUE, <span class="string">'990'</span>) || <span class="string">'%'</span>  </span>
<span class="line">   FROM (SELECT MAX(SUM(S.VALUE)) USED  </span>
<span class="line">            FROM V$STATNAME N, V$SESSTAT S  </span>
<span class="line">           WHERE N.NAME IN  </span>
<span class="line">                 (<span class="string">'opened cursors current'</span>, <span class="string">'session cursor cache count'</span>)  </span>
<span class="line">             AND S.STATISTIC<span class="comment"># = N.STATISTIC#  </span></span>
<span class="line">           GROUP BY S.SID),  </span>
<span class="line">         (SELECT VALUE FROM V$PARAMETER WHERE NAME = <span class="string">'open_cursors'</span>);  </span>
<span class="line"></span>
<span class="line"></span>
<span class="line">prompt &lt;p&gt;Appendix: all parameters of Oracle <span class="keyword">for</span> reference</span>
<span class="line">show parameter</span>
<span class="line"></span>
<span class="line">set markup html off</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'&lt;/body&gt;'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_output.put_line(<span class="string">'&lt;/html&gt;'</span>);</span>
<span class="line"></span>
<span class="line">spool off</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">/* Obtain awr、addm、ash *<span class="regexp">/</span>
<span class="line">--HTML tags are not used below</span>
<span class="line">SET markup html off spool ON pre off entmap off</span>
<span class="line"></span>
<span class="line">set trim on</span>
<span class="line">set trimspool on</span>
<span class="line">set heading off</span>
<span class="line"></span>
<span class="line">--select dbid、instance_number</span>
<span class="line">column dbid new_value awr_dbid</span>
<span class="line">column instance_number new_value awr_inst_num</span>
<span class="line">select dbid from v$database;</span>
<span class="line">select instance_number from v$instance;</span>
<span class="line"></span>
<span class="line">--Ash report in half an hour</span>
<span class="line">column ashbegintime new_value ashbegin_str</span>
<span class="line">column ashendtime new_value ashend_str</span>
<span class="line">select to_char(sysdate-3/</span><span class="number">144</span>,<span class="string">'yyyymmddhh24miss'</span>) as ashbegintime, to_char(sysdate,<span class="string">'yyyymmddhh24miss'</span>) as ashendtime from dual;</span>
<span class="line"></span>
<span class="line">column ashfile_name new_value ashfile</span>
<span class="line"><span class="keyword">select</span> <span class="string">'ashrpt_'</span> || to_char(&amp;&amp;awr_inst_num) || <span class="string">'_'</span> || to_char(&amp;&amp;ashbegin_str) || <span class="string">'_'</span> || to_char(&amp;&amp;ashend_str) ashfile_name from dual;</span>
<span class="line">spool &amp;&amp;ashfile..html</span>
<span class="line"><span class="keyword">select</span> * from table(dbms_workload_repository.ash_report_html(to_char(&amp;&amp;awr_dbid),to_char(&amp;&amp;awr_inst_num),to_date(to_char(&amp;&amp;ashbegin_str),<span class="string">'yyyymmddhh24miss'</span>),to_date(to_char(&amp;&amp;ashend_str),<span class="string">'yyyymmddhh24miss'</span>)));</span>
<span class="line">spool off;</span>
<span class="line"></span>
<span class="line">--Create AWR snapshot</span>
<span class="line">column begin_snap new_value awr_begin_snap</span>
<span class="line">column end_snap new_value awr_end_snap</span>
<span class="line"><span class="keyword">select</span> max(snap_id) begin_snap</span>
<span class="line">  from dba_hist_snapshot</span>
<span class="line"> where snap_id &lt; (<span class="keyword">select</span> max(snap_id) from dba_hist_snapshot);</span>
<span class="line"><span class="keyword">select</span> max(snap_id) end_snap from dba_hist_snapshot;</span>
<span class="line">declare</span>
<span class="line">  snap_maxtime date;</span>
<span class="line">  snap_mintime date;</span>
<span class="line">begin</span>
<span class="line">  <span class="keyword">select</span> max(end_interval_time) + <span class="number">0</span></span>
<span class="line">    into snap_maxtime</span>
<span class="line">    from dba_hist_snapshot</span>
<span class="line">   where snap_id = to_number(&amp;&amp;awr_end_snap);</span>
<span class="line">  <span class="keyword">select</span> max(end_interval_time) + <span class="number">0</span></span>
<span class="line">    into snap_mintime</span>
<span class="line">    from dba_hist_snapshot</span>
<span class="line">   where snap_id = to_number(&amp;&amp;awr_begin_snap);</span>
<span class="line">  <span class="keyword">if</span> sysdate - snap_maxtime &gt; <span class="number">10</span>/<span class="number">1445</span> then</span>
<span class="line">    dbms_workload_repository.create_snapshot();</span>
<span class="line">  end <span class="keyword">if</span>;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">--The latest two AWR reports between snap_id</span>
<span class="line">column begin_snap new_value awr_begin_snap</span>
<span class="line">column end_snap new_value awr_end_snap</span>
<span class="line">select max(snap_id) begin_snap</span>
<span class="line">  from dba_hist_snapshot</span>
<span class="line"> where snap_id &lt; (select max(snap_id) from dba_hist_snapshot);</span>
<span class="line">select max(snap_id) end_snap from dba_hist_snapshot;</span>
<span class="line">column awrfile_name new_value awrfile</span>
<span class="line">select 'awrrpt_' || to_char(&amp;&amp;awr_inst_num) || '_' || to_char(&amp;&amp;awr_begin_snap) || '_' || to_char(&amp;&amp;awr_end_snap) awrfile_name from dual;</span>
<span class="line"></span>
<span class="line">spool &amp;&amp;awrfile..html</span>
<span class="line">select output from table(dbms_workload_repository.awr_report_html(&amp;&amp;awr_dbid,&amp;&amp;awr_inst_num,&amp;&amp;awr_begin_snap,&amp;&amp;awr_end_snap));</span>
<span class="line">spool off;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">--The longest AWR report available (all analyses since a week)</span>
<span class="line">column begin_snap new_value awr_begin_snap</span>
<span class="line">column end_snap new_value awr_end_snap</span>
<span class="line">select a.begin_snap, a.end_snap</span>
<span class="line">  from (select startup_time, min(snap_id) begin_snap, max(snap_id) end_snap</span>
<span class="line">          from dba_hist_snapshot</span>
<span class="line">         group by startup_time) a,</span>
<span class="line">       (select max(startup_time) startup_time from dba_hist_snapshot) b</span>
<span class="line"> where a.startup_time = b.startup_time</span>
<span class="line">   and rownum = 1;</span>
<span class="line">column awrfile_name new_value awrfile</span>
<span class="line">select 'awrrpt_' || to_char(&amp;&amp;awr_inst_num) || '_' || to_char(&amp;&amp;awr_begin_snap) || '_' || to_char(&amp;&amp;awr_end_snap) ||'_all' awrfile_name from dual;</span>
<span class="line"></span>
<span class="line">spool &amp;&amp;awrfile..html</span>
<span class="line">select output from table(dbms_workload_repository.awr_report_html(&amp;&amp;awr_dbid,&amp;&amp;awr_inst_num,&amp;&amp;awr_begin_snap,&amp;&amp;awr_end_snap));</span>
<span class="line">spool off;</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">--Latest ADDM Report</span>
<span class="line">column addmfile_name new_value addmfile</span>
<span class="line">select 'addmrpt_' || to_char(&amp;&amp;awr_inst_num) || '_' || to_char(&amp;&amp;awr_begin_snap) || '_' || to_char(&amp;&amp;awr_end_snap) addmfile_name from dual;</span>
<span class="line">set serveroutput on</span>
<span class="line">spool &amp;&amp;addmfile..txt</span>
<span class="line">declare</span>
<span class="line">  id          number;</span>
<span class="line">  name        varchar2(200) := '';</span>
<span class="line">  descr       varchar2(500) := '';</span>
<span class="line">  addmrpt     clob;</span>
<span class="line">  v_ErrorCode number;</span>
<span class="line">BEGIN</span>
<span class="line">  name := '&amp;&amp;addmfile';</span>
<span class="line">  begin</span>
<span class="line">    dbms_advisor.create_task('ADDM', id, name, descr, null);</span>
<span class="line">    dbms_advisor.set_task_parameter(name, 'START_SNAPSHOT', &amp;&amp;awr_begin_snap);</span>
<span class="line">    dbms_advisor.set_task_parameter(name, 'END_SNAPSHOT', &amp;&amp;awr_end_snap);</span>
<span class="line">    dbms_advisor.set_task_parameter(name, 'INSTANCE', &amp;&amp;awr_inst_num);</span>
<span class="line">    dbms_advisor.set_task_parameter(name, 'DB_ID', &amp;&amp;awr_dbid);</span>
<span class="line">    dbms_advisor.execute_task(name);</span>
<span class="line">  exception</span>
<span class="line">    when others then</span>
<span class="line">      null;</span>
<span class="line">  end;</span>
<span class="line">  select dbms_advisor.get_task_report(name, 'TEXT', 'TYPICAL')</span>
<span class="line">    into addmrpt</span>
<span class="line">    from sys.dual;</span>
<span class="line">  dbms_output.enable(20000000000);</span>
<span class="line">  for i in 1 .. (DBMS_LOB.GETLENGTH(addmrpt) /</span> <span class="number">2000</span> + <span class="number">1</span>) loop</span>
<span class="line">    dbms_output.put_line(<span class="keyword">substr</span>(addmrpt, <span class="number">1900</span> * (i - <span class="number">1</span>) + <span class="number">1</span>, <span class="number">1900</span>));</span>
<span class="line">  end loop;</span>
<span class="line">  dbms_output.put_line(<span class="string">''</span>);</span>
<span class="line">  begin</span>
<span class="line">    dbms_advisor.delete_task(name);</span>
<span class="line">  exception</span>
<span class="line">    <span class="keyword">when</span> others then</span>
<span class="line">      null;</span>
<span class="line">  end;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line">spool off;</span>
<span class="line"></span>
<span class="line">exit;</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> scripts </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[收获不止SQL优化读书笔记 - 第三章 循规蹈矩--如何读懂SQL执行计划]]></title>
      <url>/2017/07/28/oracle/%E6%94%B6%E8%8E%B7%E4%B8%8D%E6%AD%A2SQL%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/03_%E6%94%B6%E8%8E%B7%E4%B8%8D%E6%AD%A2SQL%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<h2 id="执行计划分析概述"><a href="#执行计划分析概述" class="headerlink" title="执行计划分析概述"></a>执行计划分析概述</h2><h3 id="SQL执行计划"><a href="#SQL执行计划" class="headerlink" title="SQL执行计划"></a>SQL执行计划</h3><p>同一条SQL词句，可以有不同的执行计划，但一次只能有一种访问路径。<br>哪种执行开销更低，性能更好，速度更快，就选哪一种，这个过程叫作Oracle的解析过程。<br>解析后的SQL执行计划保存到SGA的Shared Pool里，后续再执行同样的SQL只需要在Shared Pool里获取，不需要再次分析了。<br>SQL执行计划选定选定依据是统计信息</p>
<h3 id="查看表和索引的统计信息"><a href="#查看表和索引的统计信息" class="headerlink" title="查看表和索引的统计信息"></a>查看表和索引的统计信息</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 表的相关统计信息</span></span>
<span class="line"><span class="keyword">select</span> table_name,num_rows,blocks,last_analyzed from user_tables</span>
<span class="line">where table_name in (<span class="string">'&amp;table_name'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 索引的相关统计信息</span></span>
<span class="line"><span class="keyword">select</span> table_name,index_name,blevel,num_rows,leaf_blocks,last_analyzed from user_indexes</span>
<span class="line">where table_name in (<span class="string">'&amp;table_name'</span>);</span>
</pre></td></tr></table></figure>
<h3 id="数据库统计信息的收集"><a href="#数据库统计信息的收集" class="headerlink" title="数据库统计信息的收集"></a>数据库统计信息的收集</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 收集表统计信息</span></span>
<span class="line"><span class="keyword">exec</span> dbms_stats.gather_table_stats(<span class="string">ownname=&gt;</span><span class="string">'&amp;owner'</span>,<span class="string">tabname=&gt;</span><span class="string">'&amp;table_name'</span>,<span class="string">estimate_percent=&gt;</span><span class="number">10</span>,<span class="string">method_opt=&gt;</span><span class="string">'for all indexed columns'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 收集索引统计信息</span></span>
<span class="line"><span class="keyword">exec</span> dbms_stats.gather_index_stats(<span class="string">ownname=&gt;</span><span class="string">'&amp;owner'</span>,<span class="string">indname=&gt;</span><span class="string">'&amp;index_name'</span>,<span class="string">estimate_percent=&gt;</span><span class="string">'10'</span>,<span class="string">degree=&gt;</span><span class="string">'4'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 收集表和索引统计信息</span></span>
<span class="line"><span class="keyword">exec</span> dbms_stats.gather_table_stats(<span class="string">ownname=&gt;</span><span class="string">'&amp;owner'</span>,<span class="string">tabname=&gt;</span><span class="string">'&amp;table_name'</span>,<span class="string">estimate_percent=&gt;</span><span class="number">10</span>,<span class="string">method_opt=&gt;</span><span class="string">'for all indexed columns'</span>,<span class="string">cascade=&gt;</span>TRUE);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 收集分区表指定分区统计信息</span></span>
<span class="line"><span class="keyword">exec</span> dbms_stats.gather_table_stats(<span class="string">ownname=&gt;</span><span class="string">'&amp;owner'</span>,<span class="string">tabname=&gt;</span><span class="string">'&amp;table_name'</span>,partname=<span class="string">'&amp;partition_name'</span>,<span class="string">estimate_percent=&gt;</span><span class="number">10</span>,<span class="string">method_opt=&gt;</span><span class="string">'for all indexed columns'</span>,<span class="string">cascade=&gt;</span>TRUE);</span>
</pre></td></tr></table></figure>
<h2 id="读懂执行计划的关键"><a href="#读懂执行计划的关键" class="headerlink" title="读懂执行计划的关键"></a>读懂执行计划的关键</h2><h2 id="从案例中辨别低效SQL"><a href="#从案例中辨别低效SQL" class="headerlink" title="从案例中辨别低效SQL"></a>从案例中辨别低效SQL</h2>]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> sql优化 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[收获不止SQL优化读书笔记 - 第二章 风驰电掣--SQL优化过程]]></title>
      <url>/2017/07/25/oracle/%E6%94%B6%E8%8E%B7%E4%B8%8D%E6%AD%A2SQL%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/02_%E6%94%B6%E8%8E%B7%E4%B8%8D%E6%AD%A2SQL%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<h2 id="SQL调优时间都去哪儿了"><a href="#SQL调优时间都去哪儿了" class="headerlink" title="SQL调优时间都去哪儿了"></a>SQL调优时间都去哪儿了</h2><ol>
<li><strong>不善于批处理频频忙交互</strong>：尽量一次性获取SQL调优前所需的信息，如SQL执行计划、SQL执行频率、对应的表和索引尺寸、表和索引的统计信息、表和索引的类型等。</li>
<li><strong>无法抓住主要矛盾瞎折腾</strong>：首先要判断出是整体问题，还是局部问题。</li>
<li><strong>未能明确需求目标自费劲</strong>：一切以客户的需求为前提。局部问题时，虽慢用户满意即是快，虽快用户不满意即是慢。但是，整体问题必须解决，无论用户感觉是慢还是慢。</li>
<li><strong>没有分析操作难度乱调优</strong>：SQL调优前首先要知道这个SOL返回记录有多少，如果很少，就说明调优空间很大，反之就要考虑特殊手段了。 SQL的执行频次、执行时长以及服务器的配置高低也要了解清楚。</li>
</ol>
<a id="more"></a>
<h2 id="如何缩短SQL调优时间"><a href="#如何缩短SQL调优时间" class="headerlink" title="如何缩短SQL调优时间"></a>如何缩短SQL调优时间</h2><ol>
<li>先获取有助调优的数据库整体信息</li>
<li>快速获取SQL运行台前信息</li>
<li>快速拿到SQL关联幕后信息</li>
</ol>
<p>相关脚本：</p>
<ul>
<li><a href="/2017/07/28/oracle/Scripts/一键获取数据库整体信息脚本/">一键获取数据库整体信息脚本</a></li>
<li><a href="/2017/07/28/oracle/Scripts/按SQLID一键获取执行计划索引分区等信息的脚本/">按SQLID一键获取执行计划索引分区等信息的脚本</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> sql优化 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[收获不止SQL优化读书笔记 - 第一章 全局在胸--用工具对SQL整体优化]]></title>
      <url>/2017/07/25/oracle/%E6%94%B6%E8%8E%B7%E4%B8%8D%E6%AD%A2SQL%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/01_%E6%94%B6%E8%8E%B7%E4%B8%8D%E6%AD%A2SQL%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<h2 id="SQL优化不同场景对应工具"><a href="#SQL优化不同场景对应工具" class="headerlink" title="SQL优化不同场景对应工具"></a>SQL优化不同场景对应工具</h2><h3 id="数据库的整体分析调优工具"><a href="#数据库的整体分析调优工具" class="headerlink" title="数据库的整体分析调优工具"></a>数据库的整体分析调优工具</h3><ol>
<li><strong>AWR</strong>：关注数据库的整体性能报告，主要关注点<ul>
<li>DB Time：这个指标主要用来判断当前系统有没有遇到相关瓶颈，是否较为繁忙导致等待时长很长</li>
<li>load profile：这个指标主要用来展现当前系统的一些指示性能的总体参数</li>
<li>efficiency percentages：是一些命中率指标，其中Buffer Hit、Library Hit等都表示SGA(System global area)的命中率</li>
<li>Top 10 Foreground Events by Total Wait Time：等待事件是衡量数据库整体优化情况的重要指标</li>
<li>SQL Statistics：分别从几个维度来罗列出TOP的SQL</li>
<li>Segment Statistics</li>
</ul>
</li>
<li><strong>ASH</strong>：数据库中的等待事件与哪些SQL具体对应的报告，时间更精准</li>
<li><strong>ADDM</strong>：Oracle给出的一些建议</li>
<li><strong>AWRDD</strong>：不同时段的性能对比报告<ul>
<li>不同时期load profile的比较</li>
<li>不同时期等待事件的比较</li>
<li>不同时期TOP SQL的比较</li>
</ul>
</li>
<li><strong>AWRSQRPT</strong>：sql在某两个快照间隔内，SQL的统计信息（总消耗的cpu时间，执行次数，逻辑读，物理读等）与执行计划的报告</li>
</ol>
<a id="more"></a>
<h3 id="数据库的局部分析调优工具"><a href="#数据库的局部分析调优工具" class="headerlink" title="数据库的局部分析调优工具"></a>数据库的局部分析调优工具</h3><ol>
<li>explain plan for</li>
<li>set autotrace on</li>
<li>statistics_level=all</li>
<li>直接通过sql_id获取</li>
<li>10046 trace</li>
<li>awrrpt.sql</li>
</ol>
<h2 id="五大性能报告的获取"><a href="#五大性能报告的获取" class="headerlink" title="五大性能报告的获取"></a>五大性能报告的获取</h2><h3 id="AWR"><a href="#AWR" class="headerlink" title="AWR"></a>AWR</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">@?/rdbms/admin/awrrpt.sql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line">set pagesize <span class="number">0</span></span>
<span class="line">set linesize <span class="number">121</span></span>
<span class="line">spool /tmp/awr.html</span>
<span class="line"><span class="keyword">select</span> output from table(dbms_workload_repository.awr_report_html</span>
<span class="line">(<span class="number">98185708</span>, <span class="number">1</span> , <span class="number">27488</span>, <span class="number">27490</span>));</span>
<span class="line">spool off</span>
<span class="line"><span class="comment"># 98185708  =  dbid</span></span>
<span class="line"><span class="comment"># 1         =  instance_number</span></span>
<span class="line"><span class="comment"># 27488     =  min_snap_id</span></span>
<span class="line"><span class="comment"># 27490     =  max_snap_id</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 手工生成断点</span></span>
<span class="line"><span class="keyword">exec</span> dbms_workload_repository.create_snapshot();</span>
</pre></td></tr></table></figure>
<blockquote>
<p><strong>小经验：</strong></p>
<ol>
<li>AWR报告DB Time中，Elapsed时间乘以CPU个数的时间如果大于DB Time，系统压力不大，反之则压力较大。</li>
<li>AWR报告load profile中，Redo size就是用来显示平均每秒的日志尺寸和平均每个事务的日志尺寸，结合Transactions这个每秒事务数的指标，就可以分析出当前事务的繁忙程度。 Transactions一般在200上下比较正常，超过1000就属于非常繁忙了。</li>
<li>AWR报告的efficiency percentages中Soft Parse指标表示共享池的软解析率，在OLTP系统中如果该指标低于90%应当引起你的注意， 这表示存在未使用绑定变量的情况</li>
<li>AWR报告Top 10 Foreground Events中Event和%DB time两列，可以非常直观地看出当前数据库面临的主要等待事件是什么。</li>
<li>AWR报告Tablespace IO Stats中Av Rd(ms)项表示平均一次物理读花费的时间，Av Rd(ms)的值大于7一般就说明系统有严重的IO问题</li>
</ol>
</blockquote>
<h3 id="ASH"><a href="#ASH" class="headerlink" title="ASH"></a>ASH</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">@?/rdbms/admin/ashrpt.sql</span>
<span class="line"><span class="comment"># 说明：</span></span>
<span class="line"><span class="comment">## 1. 如果一路回车，就是获取最近5分钟的ASH报告。</span></span>
<span class="line"><span class="comment">## 2. 如果根据Oldest ASH sample available时间，然后回车，选择的是目前可收集的最长ASH运行情况。</span></span>
<span class="line"><span class="comment">## 3. 可以选择Oldest ASH sample available和Latest ASH sample available之间时间，</span></span>
<span class="line"><span class="comment">##    然后输入时长，比如30 表示30 分钟，取你要取的任何时段的ASH 报告。</span></span>
<span class="line"><span class="comment">## 4. ASH 报告的获取不同于AWR 的地方在于，快照之间有无重启动作不影响报告的获取。</span></span>
<span class="line"></span>
<span class="line">set pagesize <span class="number">0</span></span>
<span class="line">set linesize <span class="number">121</span></span>
<span class="line">spool /tmp/ash_rpt.html</span>
<span class="line"><span class="keyword">select</span> output from table(dbms_workload_repository.ash_report_html(<span class="number">977587123</span>,<span class="number">1</span>,SYSDATE- <span class="number">30</span>/<span class="number">1440</span> , SYSDATE-<span class="number">1</span>/<span class="number">1440</span>));</span>
<span class="line">spool off</span>
</pre></td></tr></table></figure>
<h3 id="ADDM"><a href="#ADDM" class="headerlink" title="ADDM"></a>ADDM</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">@?/rdbms/admin/addmrpt.sql</span>
<span class="line"></span>
<span class="line">SELECT dbms_advisor.get_task_report(<span class="string">'TASK_30670'</span>,<span class="string">'TEXT'</span>,<span class="string">'ALL'</span>) FROM DUAL ;</span>
</pre></td></tr></table></figure>
<h3 id="AWRDD"><a href="#AWRDD" class="headerlink" title="AWRDD"></a>AWRDD</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">@?/rdbms/admin/awrddrpt.sql</span>
<span class="line"></span>
<span class="line">SELECT dbms_advisor.get_task_report(<span class="string">'TASK_30670'</span>,<span class="string">'TEXT'</span>,<span class="string">'ALL'</span>) FROM DUAL ;</span>
</pre></td></tr></table></figure>
<h3 id="AWRDD-1"><a href="#AWRDD-1" class="headerlink" title="AWRDD"></a>AWRDD</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 获取AWR SQRPT 报告的关键之处在于，交互部分要输入所要分析的SOL的SOL_ID(可以从AWR 报告中获取)</span></span>
<span class="line">@?/rdbms/admin/awrsqrpt.sql</span>
<span class="line"></span>
<span class="line">SELECT dbms_advisor.get_task_report(<span class="string">'TASK_30670'</span>,<span class="string">'TEXT'</span>,<span class="string">'ALL'</span>) FROM DUAL ;</span>
</pre></td></tr></table></figure>]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> sql优化 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-11 灾备维护经验总结]]></title>
      <url>/2017/07/14/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/11_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="不影响主库，模拟备库Failover，恢复主备数据同步的过程"><a href="#不影响主库，模拟备库Failover，恢复主备数据同步的过程" class="headerlink" title="不影响主库，模拟备库Failover，恢复主备数据同步的过程"></a>不影响主库，模拟备库Failover，恢复主备数据同步的过程</h2><h3 id="删除备库dg-broker配置"><a href="#删除备库dg-broker配置" class="headerlink" title="删除备库dg broker配置"></a>删除备库dg broker配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">$ tnsping dgtp</span>
<span class="line"></span>
<span class="line">TNS Ping Utility <span class="keyword">for</span> Linux: Version <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - Production on <span class="number">13</span>-JUL-<span class="number">2017</span> <span class="number">18</span>:<span class="number">31</span>:<span class="number">27</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1997</span>, <span class="number">2016</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Used parameter files:</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1/network/admin/sqlnet.ora</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Used TNSNAMES adapter to resolve the alias</span>
<span class="line">Attempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.174</span>)(PORT = <span class="number">1521</span>)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = dgtp)))</span>
<span class="line">OK (<span class="number">0</span> msec)</span>
<span class="line"></span>
<span class="line">$ vi $ORACLE_HOME/network/admin/tnsnames.ora</span>
<span class="line"><span class="comment"># 修改端口号为任意没开通的</span></span>
<span class="line">DGTP =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.174</span>)(PORT = <span class="number">15211</span>))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = dgtp)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">$ tnsping dgtp</span>
<span class="line"></span>
<span class="line">TNS Ping Utility <span class="keyword">for</span> Linux: Version <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - Production on <span class="number">13</span>-JUL-<span class="number">2017</span> <span class="number">18</span>:<span class="number">34</span>:<span class="number">37</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1997</span>, <span class="number">2016</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Used parameter files:</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1/network/admin/sqlnet.ora</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Used TNSNAMES adapter to resolve the alias</span>
<span class="line">Attempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.174</span>)(PORT = <span class="number">15211</span>)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = dgtp)))</span>
<span class="line">TNS-<span class="number">12541</span>: TNS:<span class="keyword">no</span> listener</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭dg broker</span></span>
<span class="line">SQL&gt; show parameter dg</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">cell_offloadgroup_name               string</span>
<span class="line">dg_broker_config_file1               string      /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span></span>
<span class="line">                                                 /db_1/dbs/dr1DGTS.dat</span>
<span class="line">dg_broker_config_file2               string      /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span></span>
<span class="line">                                                 /db_1/dbs/dr2DGTS.dat</span>
<span class="line">dg_broker_start                      boolean     TRUE</span>
<span class="line">inmemory_adg_enabled                 boolean     TRUE</span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> set dg_broker_start=false;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除DG broker配置文件</span></span>
<span class="line">! rm /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1/dbs/dr1DGTS.dat</span>
<span class="line">! rm /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1/dbs/dr2DGTS.dat</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="手工failover"><a href="#手工failover" class="headerlink" title="手工failover"></a>手工failover</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在备库上记录current_scn</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> current_scn from v$database;</span>
<span class="line"></span>
<span class="line">CURRENT_SCN</span>
<span class="line">-----------</span>
<span class="line">    <span class="number">5651932</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE</span>
<span class="line">--------------------</span>
<span class="line">READ ONLY WITH APPLY</span>
<span class="line"></span>
<span class="line"><span class="comment"># 手工failover</span></span>
<span class="line">SQL&gt; recover managed standby database finish force;</span>
<span class="line">Media recovery complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE</span>
<span class="line">--------------------</span>
<span class="line">MOUNTED</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database commit to switchover to primary;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode, database_role from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE            DATABASE_ROLE</span>
<span class="line">-------------------- ----------------</span>
<span class="line">READ WRITE           PRIMARY</span>
<span class="line"></span>
<span class="line"><span class="comment"># 这时备库就可以做读写操作了</span></span>
<span class="line">SQL&gt; create table test as <span class="keyword">select</span> * from all_objects;</span>
</pre></td></tr></table></figure>
<h3 id="恢复主备数据同步"><a href="#恢复主备数据同步" class="headerlink" title="恢复主备数据同步"></a>恢复主备数据同步</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; alter database <span class="keyword">close</span>;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode, database_role from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE            DATABASE_ROLE</span>
<span class="line">-------------------- ----------------</span>
<span class="line">MOUNTED              PRIMARY</span>
<span class="line"></span>
<span class="line">SQL&gt; flashback database to scn <span class="number">5651932</span>;</span>
<span class="line"></span>
<span class="line">Flashback complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database convert to physical standby;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode, database_role from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE            DATABASE_ROLE</span>
<span class="line">-------------------- ----------------</span>
<span class="line">MOUNTED              PHYSICAL STANDBY</span>
<span class="line"></span>
<span class="line">SQL&gt; recover managed standby database disconnect from session;</span>
<span class="line">Media recovery complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> set dg_broker_start=true;</span>
<span class="line"></span>
<span class="line">$ vi $ORACLE_HOME/network/admin/tnsnames.ora</span>
<span class="line"><span class="comment"># 修改端口号修改成原先的1521</span></span>
<span class="line">DGTP =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.174</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = dgtp)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode, database_role from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE            DATABASE_ROLE</span>
<span class="line">-------------------- ----------------</span>
<span class="line">READ ONLY WITH APPLY PHYSICAL STANDBY</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看ADG配置已自已应用成功</span></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">58</span> seconds ago)</span>
</pre></td></tr></table></figure>
<h2 id="12cR2-SQL-PLUS里新增命令HISTORY"><a href="#12cR2-SQL-PLUS里新增命令HISTORY" class="headerlink" title="12cR2 SQL/PLUS里新增命令HISTORY"></a>12cR2 SQL/PLUS里新增命令HISTORY</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show hist</span>
<span class="line">set hist off</span>
<span class="line">set hist on</span>
<span class="line">set hist <span class="number">500</span></span>
<span class="line">hist</span>
<span class="line">hist <span class="number">3</span> del</span>
<span class="line">hist <span class="number">1</span> run</span>
<span class="line">hist <span class="number">1</span> edit</span>
<span class="line">hist clear</span>
</pre></td></tr></table></figure>
<h2 id="主库闪回数据库后备库恢复同步"><a href="#主库闪回数据库后备库恢复同步" class="headerlink" title="主库闪回数据库后备库恢复同步"></a>主库闪回数据库后备库恢复同步</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主库上执行</span></span>
<span class="line">create restore point fb_recover_trunc guarantee flashback database;</span>
<span class="line"></span>
<span class="line">col NAME <span class="keyword">for</span> a2<span class="number">0</span></span>
<span class="line">col TIME <span class="keyword">for</span> a35</span>
<span class="line">set lines <span class="number">200</span></span>
<span class="line">col STORAGE_SIZE <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">SELECT NAME, SCN, TIME, DATABASE_INCARNATION<span class="comment"># DI,GUARANTEE_FLASHBACK_DATABASE, STORAGE_SIZE/1024/1024/1024 </span></span>
<span class="line">  FROM V$RESTORE_POINT WHERE GUARANTEE_FLASHBACK_DATABASE=<span class="string">'YES'</span>;</span>
<span class="line"></span>
<span class="line">NAME                        SCN TIME                                        DI GUA STORAGE_SIZE/<span class="number">1024</span>/<span class="number">1024</span>/<span class="number">1024</span></span>
<span class="line">-------------------- ---------- ----------------------------------- ---------- --- ---------------------------</span>
<span class="line">FB_RECOVER_TRUNC        <span class="number">5633353</span> <span class="number">13</span>-JUL-<span class="number">17</span> <span class="number">04</span>.<span class="number">45.02</span>.<span class="number">000000000</span> PM              <span class="number">5</span> YES                    .<span class="number">1953125</span></span>
<span class="line"></span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line"></span>
<span class="line">conn lyj/lyj@pdb1</span>
<span class="line"><span class="keyword">select</span> * from cat;</span>
<span class="line"></span>
<span class="line">TABLE_NAME           TABLE_TYPE</span>
<span class="line">-------------------- -----------</span>
<span class="line">TEST                 TABLE</span>
<span class="line">TEST2                TABLE</span>
<span class="line"></span>
<span class="line">create table test_trunc as <span class="keyword">select</span> * from all_objects;</span>
<span class="line"><span class="keyword">select</span> count(*) from test_trunc;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">56327</span></span>
<span class="line"></span>
<span class="line">drop table TEST purge;</span>
<span class="line">drop table TEST2 purge;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from cat;</span>
<span class="line"></span>
<span class="line">TABLE_NAME           TABLE_TYPE</span>
<span class="line">-------------------- -----------</span>
<span class="line">TEST_TRUNC           TABLE</span>
<span class="line"></span>
<span class="line"><span class="comment"># 主库做闪回数据库操作</span></span>
<span class="line">conn / as sysdba</span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line">startup mount</span>
<span class="line">flashback database to restore point fb_recover_trunc;</span>
<span class="line">alter database <span class="keyword">open</span> resetlogs;</span>
<span class="line"></span>
<span class="line">alter session set container=pdb1;</span>
<span class="line"><span class="keyword">select</span> TABLE_NAME from all_tables where OWNER=<span class="string">'LYJ'</span>;</span>
<span class="line"></span>
<span class="line">TABLE_NAME</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">TEST</span>
<span class="line">TEST2</span>
<span class="line"></span>
<span class="line"><span class="comment"># 备库状态</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> database_role,open_mode from v$database;</span>
<span class="line"></span>
<span class="line">DATABASE_ROLE    OPEN_MODE</span>
<span class="line">---------------- --------------------</span>
<span class="line">PHYSICAL STANDBY READ ONL      <span class="comment"># ADG状态已停止</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 主备库数据不同步</span></span>
<span class="line">alter session set container=pdb1;</span>
<span class="line"><span class="keyword">select</span> TABLE_NAME from all_tables where OWNER=<span class="string">'LYJ'</span>;</span>
<span class="line"></span>
<span class="line">TABLE_NAME</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">TEST_TRUNC</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在备库执行闪回数据库（用闪回点的SCN号5633353）</span></span>
<span class="line">conn / as sysdba</span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line">startup mount</span>
<span class="line">recover managed standby database cancel;  <span class="comment"># 视情况可不执行</span></span>
<span class="line">flashback database to scn <span class="number">5633353</span>;</span>
<span class="line"></span>
<span class="line">dgmgrl sys/Center08@dgtp</span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Physical standby database </span>
<span class="line">      Error: ORA-<span class="number">16810</span>: multiple errors <span class="keyword">or</span> warnings detected <span class="keyword">for</span> the member</span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">ERROR   (status updated <span class="number">13</span> seconds ago)</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; enable configuration;</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">1</span> second ago)</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> database_role,open_mode from v$database;</span>
<span class="line"></span>
<span class="line">DATABASE_ROLE    OPEN_MODE</span>
<span class="line">---------------- --------------------</span>
<span class="line">PHYSICAL STANDBY MOUNTED</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> database_role,open_mode from v$database;</span>
<span class="line"></span>
<span class="line">DATABASE_ROLE    OPEN_MODE</span>
<span class="line">---------------- --------------------</span>
<span class="line">PHYSICAL STANDBY READ ONLY WITH APPLY</span>
</pre></td></tr></table></figure>
<h2 id="闪回数据库是无法闪回到datafile收缩前的状态"><a href="#闪回数据库是无法闪回到datafile收缩前的状态" class="headerlink" title="闪回数据库是无法闪回到datafile收缩前的状态"></a>闪回数据库是无法闪回到datafile收缩前的状态</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将已有的数据文件收缩到190M</span></span>
<span class="line">alter session set container=pdb1;</span>
<span class="line">col TABLESPACE_NAME <span class="keyword">for</span> a1<span class="number">0</span></span>
<span class="line">col FILE_NAME <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> TABLESPACE_NAME,FILE_NAME,BYTES/<span class="number">1024</span>/<span class="number">1024</span> size_m from dba_data_files;</span>
<span class="line"></span>
<span class="line">TABLESPACE FILE_NAME                                              SIZE_M</span>
<span class="line">---------- -------------------------------------------------- ----------</span>
<span class="line">SYSTEM     /u01/app/oracle/oradata/dgt/pdb1/system01.dbf             <span class="number">260</span></span>
<span class="line">SYSAUX     /u01/app/oracle/oradata/dgt/pdb1/sysaux01.dbf             <span class="number">420</span></span>
<span class="line">UNDOTBS1   /u01/app/oracle/oradata/dgt/pdb1/undotbs01.dbf            <span class="number">100</span></span>
<span class="line">USERS      /u01/app/oracle/oradata/dgt/pdb1/users01.dbf             <span class="number">22.5</span></span>
<span class="line"></span>
<span class="line">alter tablespace USERS add datafile <span class="string">'/u01/app/oracle/oradata/dgt/pdb1/users02.dbf'</span> size <span class="number">200</span><span class="keyword">m</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> sysdate from dual;</span>
<span class="line"></span>
<span class="line">SYSDATE</span>
<span class="line">-------------------</span>
<span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">14</span> <span class="number">13</span>:<span class="number">35</span>:<span class="number">18</span></span>
<span class="line"></span>
<span class="line">alter database datafile <span class="string">'/u01/app/oracle/oradata/dgt/pdb1/users02.dbf'</span> resize <span class="number">190</span>M;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> sysdate from dual;</span>
<span class="line"></span>
<span class="line">SYSDATE</span>
<span class="line">-------------------</span>
<span class="line"><span class="number">2017</span>-<span class="number">07</span>-<span class="number">14</span> <span class="number">13</span>:<span class="number">38</span>:<span class="number">07</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 按以下步骤是无法闪回数据库的</span></span>
<span class="line">recover managed standby database cancel;</span>
<span class="line">alter database <span class="keyword">close</span>;</span>
<span class="line">flashback database to timestamp to_timestamp(<span class="string">'2017-07-14 13:35:18'</span>,<span class="string">'yyyy-mm-dd hh24:mi:ss'</span>);</span>
<span class="line">flashback database to timestamp to_timestamp(<span class="string">'2017-07-14 13:35:18'</span>,<span class="string">'yyyy-mm-dd hh24:mi:ss'</span>)</span>
<span class="line">*</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">38766</span>: cannot flashback data file <span class="number">13</span>; file resized smaller</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">13</span>: <span class="string">'/u01/app/oracle/oradata/dgt/pdb1/users02.dbf'</span></span>
</pre></td></tr></table></figure>
<h2 id="开启12c-Data-Guard压缩归档"><a href="#开启12c-Data-Guard压缩归档" class="headerlink" title="开启12c Data Guard压缩归档"></a>开启12c Data Guard压缩归档</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">edit database dgtp set property RedoCompression = <span class="string">'ENABLE'</span>;</span>
<span class="line"><span class="comment"># 关闭压缩归档</span></span>
<span class="line">edit database dgtp set property RedoCompression = <span class="string">'DISABLE'</span>;</span>
</pre></td></tr></table></figure>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sqlplus -<span class="keyword">s</span> / as sysdba &lt;&lt;EOF</span>
<span class="line"><span class="keyword">select</span> name, decode(cdb, <span class="string">'YES'</span>, <span class="string">'Multitenant Option enabled'</span>, <span class="string">'Regular 12c Database: '</span>) <span class="string">"Multitenant Option"</span> , open_mode, con_id from v\$database;</span>
<span class="line">show pdbs;</span>
<span class="line">set linesize <span class="number">200</span></span>
<span class="line">col name <span class="keyword">format</span> a1<span class="number">0</span></span>
<span class="line">col open_time <span class="keyword">format</span> a35</span>
<span class="line"><span class="keyword">select</span> con_id,dbid,con_uid,name,open_mode,open_time,trunc(total_size/<span class="number">1024</span>/<span class="number">1024</span>) size_MB from v\$pdbs;</span>
<span class="line">EOF</span>
<span class="line"></span>
<span class="line">sqlplus -<span class="keyword">s</span> / as sysdba &lt;&lt;EOF</span>
<span class="line"><span class="keyword">select</span> sess.con_id,pdbs.name,count(*)from v\$session sess,v\$pdbs pdbs where pdbs.con_id=sess.con_id group by sess.con_id,pdbs.name;</span>
<span class="line">EOF</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-10 容灾切换和故障演练实践总结]]></title>
      <url>/2017/07/04/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/10_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="练习DG-Broker-switchover和failover的过程"><a href="#练习DG-Broker-switchover和failover的过程" class="headerlink" title="练习DG Broker switchover和failover的过程"></a>练习DG Broker switchover和failover的过程</h2><h3 id="练习switchover"><a href="#练习switchover" class="headerlink" title="练习switchover"></a>练习switchover</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># switchover可以在主或备库上运行</span></span>
<span class="line"><span class="comment"># 使用TNS的方式登陆DG Broker</span></span>
<span class="line">$ dgmgrl sys/Center08@dgtp</span>
<span class="line">DGMGRL <span class="keyword">for</span> Linux: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - Production on Tue Jul <span class="number">4</span> <span class="number">15</span>:<span class="number">01</span>:<span class="number">13</span> <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Welcome to DGMGRL, type <span class="string">"help"</span> <span class="keyword">for</span> information.</span>
<span class="line">Connected to <span class="string">"DGTP"</span></span>
<span class="line">Connected as SYSDBA.</span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">13</span> seconds ago)</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<p>switchover测试<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># switchover到备库dgts</span></span>
<span class="line">DGMGRL&gt; switchover to dgts;</span>
<span class="line">Performing switchover NOW, please wait...</span>
<span class="line">Operation requires a connection to database <span class="string">"dgts"</span></span>
<span class="line">Connecting ...</span>
<span class="line">Connected to <span class="string">"DGTS"</span></span>
<span class="line">Connected as SYSDBA.</span>
<span class="line">New primary database <span class="string">"dgts"</span> is opening...</span>
<span class="line">Operation requires start up of instance <span class="string">"dgt"</span> on database <span class="string">"dgtp"</span></span>
<span class="line">Starting instance <span class="string">"dgt"</span>...</span>
<span class="line">ORACLE instance started.</span>
<span class="line">Database mounted.</span>
<span class="line">Database opened.</span>
<span class="line">Connected to <span class="string">"DGTP"</span></span>
<span class="line">Switchover succeeded, new primary is <span class="string">"dgts"</span></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgts - Primary database</span>
<span class="line">    dgtp - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">71</span> seconds ago)</span>
<span class="line"></span>
<span class="line"><span class="comment"># switchover到原主库dgtp</span></span>
<span class="line">DGMGRL&gt; switchover to dgtp;</span>
<span class="line">Performing switchover NOW, please wait...</span>
<span class="line">Operation requires a connection to database <span class="string">"dgtp"</span></span>
<span class="line">Connecting ...</span>
<span class="line">Connected to <span class="string">"DGTP"</span></span>
<span class="line">Connected as SYSDBA.</span>
<span class="line">New primary database <span class="string">"dgtp"</span> is opening...</span>
<span class="line">Operation requires start up of instance <span class="string">"dgt"</span> on database <span class="string">"dgts"</span></span>
<span class="line">Starting instance <span class="string">"dgt"</span>...</span>
<span class="line">ORACLE instance started.</span>
<span class="line">Database mounted.</span>
<span class="line">Database opened.</span>
<span class="line">Connected to <span class="string">"DGTS"</span></span>
<span class="line">Switchover succeeded, new primary is <span class="string">"dgtp"</span></span>
</pre></td></tr></table></figure></p>
<h3 id="练习failover"><a href="#练习failover" class="headerlink" title="练习failover"></a>练习failover</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 模拟主库宕机</span></span>
<span class="line">sqlplus sys/Center08@dgtp as sysdba</span>
<span class="line"><span class="keyword">shutdown</span> abort</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在备库上执行failover，failover只能在备库上运行</span></span>
<span class="line">dgmgrl sys/Center08@dgts</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    Error: ORA-<span class="number">1034</span>: ORACLE <span class="keyword">not</span> available</span>
<span class="line"></span>
<span class="line">    dgts - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">ERROR   (status updated <span class="number">0</span> seconds ago)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 成功执行failover</span></span>
<span class="line">DGMGRL&gt; failover to dgts;</span>
<span class="line">Performing failover NOW, please wait...</span>
<span class="line">Failover succeeded, new primary is <span class="string">"dgts"</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 提示要原主库需要执行reinstated操作，才能变更为物理备库</span></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgts - Primary database</span>
<span class="line">    dgtp - Physical standby database (disabled)</span>
<span class="line">      ORA-<span class="number">16661</span>: the standby database needs to be reinstated</span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">16</span> seconds ago)</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># 主库恢复后是无法直接打开</span></span>
<span class="line">SQL&gt; startup</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">3992977408</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">8800136</span> bytes</span>
<span class="line">Variable Size            <span class="number">1056966776</span> bytes</span>
<span class="line">Database Buffers         <span class="number">2919235584</span> bytes</span>
<span class="line">Redo Buffers                <span class="number">7974912</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">ORA-<span class="number">16649</span>: possible failover to another database prevents this database from</span>
<span class="line">being opened</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE</span>
<span class="line">--------------------</span>
<span class="line">MOUNTED</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在备库执行reinstate database，将原主库变为备库</span></span>
<span class="line">DGMGRL&gt; reinstate database dgtp;</span>
<span class="line">Reinstating database <span class="string">"dgtp"</span>, please wait...</span>
<span class="line">Reinstatement of database <span class="string">"dgtp"</span> succeeded</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgts - Primary database</span>
<span class="line">    dgtp - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">44</span> seconds ago)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看原主库状态</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode,database_role from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE            DATABASE_ROLE</span>
<span class="line">-------------------- ----------------</span>
<span class="line">READ ONLY WITH APPLY PHYSICAL STANDBY</span>
</pre></td></tr></table></figure>
<h2 id="练习自动化切换-Fast-Start-Failover"><a href="#练习自动化切换-Fast-Start-Failover" class="headerlink" title="练习自动化切换 Fast-Start Failover"></a>练习自动化切换 Fast-Start Failover</h2><h3 id="配置开启Fast-Start-Failover"><a href="#配置开启Fast-Start-Failover" class="headerlink" title="配置开启Fast-Start Failover"></a>配置开启Fast-Start Failover</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED   <span class="comment">#  初始自动化切换是DISABLED</span></span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">18</span> seconds ago)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 1. 查看主/备库是否开启闪回数据库</span></span>
<span class="line"><span class="comment">## 备库开启闪回数据库用以下命令</span></span>
<span class="line">recover managed standby database cancel;</span>
<span class="line">alter database flashback on;</span>
<span class="line">recover managed standby database disconnect from session;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 2. LISTENER中要配置GLOBAL_DBNAME=db_unique_name_DGMGRL，如</span></span>
<span class="line">   (SID_DESC =</span>
<span class="line">      (GLOBAL_DBNAME = DGTP_DGMGRL)</span>
<span class="line">      (ORACLE_HOME = <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1)</span>
<span class="line">      (SID_NAME = dgt)</span>
<span class="line">    )</span>
<span class="line"></span>
<span class="line"><span class="comment"># 3. 在DG BROKER中设置主备库的FastStartFailoverTarget</span></span>
<span class="line">DGMGRL&gt; edit database dgtp set property FastStartFailoverTarget=<span class="string">'dgts'</span>;</span>
<span class="line">Property <span class="string">"faststartfailovertarget"</span> updated</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; edit database dgts set property FastStartFailoverTarget=<span class="string">'dgtp'</span>;</span>
<span class="line">Property <span class="string">"faststartfailovertarget"</span> updated</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show database verbose dgtp;</span>
<span class="line">.....</span>
<span class="line">LogXptMode                      = <span class="string">'ASYNC'</span>   <span class="comment"># Protection Mode: MaxPerformance</span></span>
<span class="line">.....</span>
<span class="line">FastStartFailoverTarget         = <span class="string">'dgts'</span></span>
<span class="line">.....</span>
<span class="line"></span>
<span class="line"><span class="comment"># 4. 如果主备的设置为最大高可用保护模式，则需要设置LogXptMode为sync，最大性能保护模式，则需要设置LogXptMode为async</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 满足以上4个条件后，使用以下命令启用Fast-Start Failover</span></span>
<span class="line">DGMGRL&gt; enable fast_start failover;</span>
<span class="line">Enabled.</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; start observer;</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">04</span>.<span class="number">06</span>] FSFO target standby is dgts</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">06</span>.<span class="number">22</span>] Observer trace level is set to USER</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">06</span>.<span class="number">22</span>] Try to <span class="keyword">connect</span> to the primary.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">06</span>.<span class="number">22</span>] Try to <span class="keyword">connect</span> to the primary dgtp.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">06</span>.<span class="number">23</span>] The standby dgts is ready to be a FSFO target</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:08.<span class="number">23</span>] Connection to the primary restored!</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:09.<span class="number">23</span>] Disconnecting from database dgtp.</span>
<span class="line"></span>
<span class="line"><span class="comment"># 不要关闭上面的窗口，重新打开一个</span></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - (*) Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: ENABLED    <span class="comment"># 状态已经是ENABLED了</span></span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">10</span> seconds ago)</span>
</pre></td></tr></table></figure>
<h3 id="模拟Fast-Start-Failover"><a href="#模拟Fast-Start-Failover" class="headerlink" title="模拟Fast-Start Failover"></a>模拟Fast-Start Failover</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主库shutdown abort</span></span>
<span class="line"><span class="keyword">shutdown</span> abort</span>
<span class="line"></span>
<span class="line"><span class="comment"># observer上</span></span>
<span class="line">DGMGRL&gt; start observer;</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">04</span>.<span class="number">06</span>] FSFO target standby is dgts</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">06</span>.<span class="number">22</span>] Observer trace level is set to USER</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">06</span>.<span class="number">22</span>] Try to <span class="keyword">connect</span> to the primary.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">06</span>.<span class="number">22</span>] Try to <span class="keyword">connect</span> to the primary dgtp.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">06</span>.<span class="number">23</span>] The standby dgts is ready to be a FSFO target</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:08.<span class="number">23</span>] Connection to the primary restored!</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">13</span>:09.<span class="number">23</span>] Disconnecting from database dgtp.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">36.48</span>] Primary database cannot be reached.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">36.48</span>] Fast-Start Failover threshold has <span class="keyword">not</span> exceeded. Retry <span class="keyword">for</span> the <span class="keyword">next</span> <span class="number">30</span> seconds</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">37.48</span>] Try to <span class="keyword">connect</span> to the primary.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">39.56</span>] Primary database cannot be reached.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">16</span>:<span class="number">40.56</span>] Try to <span class="keyword">connect</span> to the primary.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">04</span>.<span class="number">15</span>] Primary database cannot be reached.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">04</span>.<span class="number">15</span>] Fast-Start Failover threshold has <span class="keyword">not</span> exceeded. Retry <span class="keyword">for</span> the <span class="keyword">next</span> <span class="number">2</span> seconds</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">05</span>.<span class="number">15</span>] Try to <span class="keyword">connect</span> to the primary.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">07</span>.<span class="number">23</span>] Primary database cannot be reached.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">07</span>.<span class="number">23</span>] Fast-Start Failover threshold has expired.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">07</span>.<span class="number">23</span>] Try to <span class="keyword">connect</span> to the standby.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">07</span>.<span class="number">23</span>] Making a <span class="keyword">last</span> connection attempt to primary database before proceeding with Fast-Start Failover.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">07</span>.<span class="number">23</span>] Check <span class="keyword">if</span> the standby is ready <span class="keyword">for</span> failover.</span>
<span class="line">[S002 <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">07</span>.<span class="number">23</span>] Fast-Start Failover started...</span>
<span class="line"></span>
<span class="line"><span class="number">16</span>:<span class="number">17</span>:<span class="number">07</span>.<span class="number">23</span>  Tuesday, July <span class="number">04</span>, <span class="number">2017</span></span>
<span class="line">Initiating Fast-Start Failover to database <span class="string">"dgts"</span>...</span>
<span class="line">[S002 <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">07</span>.<span class="number">23</span>] Initiating Fast-start Failover.</span>
<span class="line">Performing failover NOW, please wait...</span>
<span class="line">Failover succeeded, new primary is <span class="string">"dgts"</span></span>
<span class="line"><span class="number">16</span>:<span class="number">17</span>:<span class="number">18.42</span>  Tuesday, July <span class="number">04</span>, <span class="number">2017</span></span>
<span class="line">[S002 <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">18.42</span>] Fast-Start Failover finished...</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">18.42</span>] Failover succeeded. Restart pinging.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">18.43</span>] Primary database has changed to dgts.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">18.49</span>] Try to <span class="keyword">connect</span> to the primary.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">18.49</span>] Try to <span class="keyword">connect</span> to the primary dgts.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">19.59</span>] Connection to the primary restored!</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">19.60</span>] The standby dgtp needs to be reinstated</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">19.60</span>] Try to <span class="keyword">connect</span> to the new standby dgtp.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">20.60</span>] Disconnecting from database dgts.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">22.60</span>] Connection to the new standby restored!</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">16</span>:<span class="number">17</span>:<span class="number">22.61</span>] Failed to ping the new standby.</span>
<span class="line">.....</span>
<span class="line"></span>
<span class="line"><span class="comment"># 主库恢复后，自动Reinstate</span></span>
<span class="line">SQL&gt; startup</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">3992977408</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">8800136</span> bytes</span>
<span class="line">Variable Size            <span class="number">1056966776</span> bytes</span>
<span class="line">Database Buffers         <span class="number">2919235584</span> bytes</span>
<span class="line">Redo Buffers                <span class="number">7974912</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">ORA-<span class="number">16649</span>: possible failover to another database prevents this database from</span>
<span class="line">being opened</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line">ORA-<span class="number">16795</span>: the standby database needs to be re-created</span>
<span class="line"></span>
<span class="line">Configuration details cannot be determined by DGMGRL</span>
<span class="line"></span>
<span class="line"><span class="comment"># observer上</span></span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">30.30</span>] Try to <span class="keyword">connect</span> to the primary dgts.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">32.31</span>] Connection to the primary restored!</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">33.31</span>] Wait <span class="keyword">for</span> new primary to be ready to reinstate.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">34.31</span>] New primary is now ready to reinstate.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">34.31</span>] Issuing REINSTATE command.      <span class="comment"># 提示开始自动做REINSTATE</span></span>
<span class="line"></span>
<span class="line"><span class="number">17</span>:<span class="number">10</span>:<span class="number">34.31</span>  Tuesday, July <span class="number">04</span>, <span class="number">2017</span></span>
<span class="line">Initiating reinstatement <span class="keyword">for</span> database <span class="string">"dgtp"</span>...</span>
<span class="line">Reinstating database <span class="string">"dgtp"</span>, please wait...</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">46.45</span>] The standby dgtp is ready to be a FSFO target</span>
<span class="line">Reinstatement of database <span class="string">"dgtp"</span> succeeded</span>
<span class="line"><span class="number">17</span>:<span class="number">10</span>:<span class="number">56.69</span>  Tuesday, July <span class="number">04</span>, <span class="number">2017</span></span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">57.46</span>] Successfully reinstated database dgtp.</span>
<span class="line">[W00<span class="number">0</span> <span class="number">07</span>/<span class="number">04</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">58.46</span>] The reinstatement of standby dgtp was just done</span>
<span class="line">.....</span>
<span class="line"></span>
<span class="line">[oracle@dgtp12 ~]$ sqlplus sys/Center08@dgtp as sysdba</span>
<span class="line"></span>
<span class="line">SQL*Plus: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> Production on Tue Jul <span class="number">4</span> <span class="number">17</span>:<span class="number">14</span>:<span class="number">27</span> <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2016</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Connected to:</span>
<span class="line">Oracle Database <span class="number">12</span>c Enterprise Edition Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - <span class="number">64</span>bit Production</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> open_mode,database_role from v$database;</span>
<span class="line"></span>
<span class="line">OPEN_MODE            DATABASE_ROLE</span>
<span class="line">-------------------- ----------------</span>
<span class="line">READ ONLY WITH APPLY PHYSICAL STANDBY</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">[oracle@dgtp12 ~]$ dgmgrl sys/Center08@dgtp</span>
<span class="line">DGMGRL <span class="keyword">for</span> Linux: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - Production on Tue Jul <span class="number">4</span> <span class="number">17</span>:<span class="number">15</span>:<span class="number">33</span> <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Welcome to DGMGRL, type <span class="string">"help"</span> <span class="keyword">for</span> information.</span>
<span class="line">Connected to <span class="string">"DGTP"</span></span>
<span class="line">Connected as SYSDBA.</span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgts - Primary database</span>
<span class="line">    dgtp - (*) Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: ENABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">42</span> seconds ago)</span>
</pre></td></tr></table></figure>
<h2 id="练习Active-Data-Guard连接会话保留的特性"><a href="#练习Active-Data-Guard连接会话保留的特性" class="headerlink" title="练习Active Data Guard连接会话保留的特性"></a>练习Active Data Guard连接会话保留的特性</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; show parameter standby</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">enabled_PDBs_on_standby              string      *</span>
<span class="line">standby_archive_dest                 string      ?<span class="comment">#/dbs/arch</span></span>
<span class="line">standby_db_preserve_states           string      NONE</span>
<span class="line">standby_file_management              string      AUTO</span>
<span class="line"></span>
<span class="line"><span class="comment"># 主备库都执行</span></span>
<span class="line">alter <span class="keyword">system</span> set standby_db_preserve_states=all scope=spfile;</span>
<span class="line"></span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line">startup</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在备库上</span></span>
<span class="line">$ sqlplus <span class="keyword">system</span>/Center08@dgts</span>
<span class="line"></span>
<span class="line">SQL*Plus: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> Production on Tue Jul <span class="number">4</span> <span class="number">17</span>:<span class="number">36</span>:<span class="number">03</span> <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2016</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Connected to:</span>
<span class="line">Oracle Database <span class="number">12</span>c Enterprise Edition Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - <span class="number">64</span>bit Production</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from cat;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">       <span class="number">153</span></span>
<span class="line"></span>
<span class="line">SQL&gt; set timing on</span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from cat;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">       <span class="number">153</span></span>
<span class="line"></span>
<span class="line">Elapsed: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>.<span class="number">03</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 另开一个窗口做switchover</span></span>
<span class="line">$ dgmgrl sys/Center08@dgts</span>
<span class="line">DGMGRL <span class="keyword">for</span> Linux: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - Production on Tue Jul <span class="number">4</span> <span class="number">17</span>:<span class="number">35</span>:08 <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Welcome to DGMGRL, type <span class="string">"help"</span> <span class="keyword">for</span> information.</span>
<span class="line">Connected to <span class="string">"DGTS"</span></span>
<span class="line">Connected as SYSDBA.</span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - (*) Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: ENABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">27</span> seconds ago)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 回到上面的会话，在会话中执行查询</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from cat;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">       <span class="number">153</span></span>
<span class="line"></span>
<span class="line">Elapsed: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>.<span class="number">02</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from cat;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">       <span class="number">153</span></span>
<span class="line"></span>
<span class="line">Elapsed: <span class="number">00</span>:<span class="number">00</span>:<span class="number">02</span>.<span class="number">80</span>    <span class="comment"># 有2秒延迟，但会话不中断</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from cat;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">       <span class="number">153</span></span>
<span class="line"></span>
<span class="line">Elapsed: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>.<span class="number">07</span></span>
</pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="DG-BROKER中新增的validate命令"><a href="#DG-BROKER中新增的validate命令" class="headerlink" title="DG BROKER中新增的validate命令"></a>DG BROKER中新增的validate命令</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">DGMGRL&gt; validate database verbose dgtp;</span>
<span class="line"></span>
<span class="line">  Database Role:    Primary database</span>
<span class="line"></span>
<span class="line">  Ready <span class="keyword">for</span> Switchover:  Yes</span>
<span class="line"></span>
<span class="line">  Flashback Database Status:</span>
<span class="line">    dgtp:  On</span>
<span class="line"></span>
<span class="line">  Capacity Information:</span>
<span class="line">    Database  Instances        Threads        </span>
<span class="line">    dgtp      <span class="number">1</span>                <span class="number">1</span>              </span>
<span class="line"></span>
<span class="line">  Managed by Clusterware:</span>
<span class="line">    dgtp:  NO             </span>
<span class="line">    Warning: Ensure primary database <span class="keyword">s</span> StaticConnectIdentifier property</span>
<span class="line">    is configured properly so that the primary database can be restarted</span>
<span class="line">    by DGMGRL after switchover</span>
<span class="line"></span>
<span class="line">  Temporary Tablespace File Information:</span>
<span class="line">    dgtp TEMP Files:  <span class="number">3</span></span>
<span class="line"></span>
<span class="line">  Data file Online Move in Progress:</span>
<span class="line">    dgtp:  No</span>
<span class="line"></span>
<span class="line">  Transport-Related Information:</span>
<span class="line">    Transport On:  Yes</span>
<span class="line"></span>
<span class="line">  Log Files Cleared:</span>
<span class="line">    dgtp Standby Redo Log Files:  Cleared</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; validate database verbose dgts;</span>
<span class="line"></span>
<span class="line">  Database Role:     Physical standby database</span>
<span class="line">  Primary Database:  dgtp</span>
<span class="line"></span>
<span class="line">  Ready <span class="keyword">for</span> Switchover:  Yes</span>
<span class="line">  Ready <span class="keyword">for</span> Failover:    Yes (Primary Running)</span>
<span class="line"></span>
<span class="line">  Flashback Database Status:</span>
<span class="line">    dgtp:  On</span>
<span class="line">    dgts:  Off</span>
<span class="line"></span>
<span class="line">  Capacity Information:</span>
<span class="line">    Database  Instances        Threads        </span>
<span class="line">    dgtp      <span class="number">1</span>                <span class="number">1</span>              </span>
<span class="line">    dgts      <span class="number">1</span>                <span class="number">1</span>              </span>
<span class="line"></span>
<span class="line">  Managed by Clusterware:</span>
<span class="line">    dgtp:  NO             </span>
<span class="line">    dgts:  NO             </span>
<span class="line">    Warning: Ensure primary database <span class="keyword">s</span> StaticConnectIdentifier property</span>
<span class="line">    is configured properly so that the primary database can be restarted</span>
<span class="line">    by DGMGRL after switchover</span>
<span class="line"></span>
<span class="line">  Temporary Tablespace File Information:</span>
<span class="line">    dgtp TEMP Files:  <span class="number">3</span></span>
<span class="line">    dgts TEMP Files:  <span class="number">3</span></span>
<span class="line"></span>
<span class="line">  Data file Online Move in Progress:</span>
<span class="line">    dgtp:  No</span>
<span class="line">    dgts:  No</span>
<span class="line"></span>
<span class="line">  Standby Apply-Related Information:</span>
<span class="line">    Apply State:      Running</span>
<span class="line">    Apply Lag:        <span class="number">0</span> seconds (computed <span class="number">1</span> second ago)</span>
<span class="line">    Apply Delay:      <span class="number">0</span> minutes</span>
<span class="line"></span>
<span class="line">  Transport-Related Information:</span>
<span class="line">    Transport On:      Yes</span>
<span class="line">    Gap Status:        No Gap</span>
<span class="line">    Transport Lag:     <span class="number">0</span> seconds (computed <span class="number">1</span> second ago)</span>
<span class="line">    Transport Status:  Success</span>
<span class="line"></span>
<span class="line">  Log Files Cleared:</span>
<span class="line">    dgtp Standby Redo Log Files:  Cleared</span>
<span class="line">    dgts Online Redo Log Files:   Cleared</span>
<span class="line">    dgts Standby Redo Log Files:  Available</span>
<span class="line"></span>
<span class="line">  Current Log File Groups Configuration:</span>
<span class="line">    Thread <span class="comment">#  Online Redo Log Groups  Standby Redo Log Groups Status       </span></span>
<span class="line">              (dgtp)                  (dgts)                               </span>
<span class="line">    <span class="number">1</span>         <span class="number">3</span>                       <span class="number">2</span>                       Insufficient SRLs</span>
<span class="line"></span>
<span class="line">  Future Log File Groups Configuration:</span>
<span class="line">    Thread <span class="comment">#  Online Redo Log Groups  Standby Redo Log Groups Status       </span></span>
<span class="line">              (dgts)                  (dgtp)                               </span>
<span class="line">    <span class="number">1</span>         <span class="number">3</span>                       <span class="number">2</span>                       Insufficient SRLs</span>
<span class="line"></span>
<span class="line">  Current Configuration Log File Sizes:</span>
<span class="line">    Thread <span class="comment">#   Smallest Online Redo      Smallest Standby Redo    </span></span>
<span class="line">               Log File Size             Log File Size            </span>
<span class="line">               (dgtp)                    (dgts)                   </span>
<span class="line">    <span class="number">1</span>          <span class="number">200</span> MBytes                <span class="number">200</span> MBytes               </span>
<span class="line"></span>
<span class="line">  Future Configuration Log File Sizes:</span>
<span class="line">    Thread <span class="comment">#   Smallest Online Redo      Smallest Standby Redo    </span></span>
<span class="line">               Log File Size             Log File Size            </span>
<span class="line">               (dgts)                    (dgtp)                   </span>
<span class="line">    <span class="number">1</span>          <span class="number">200</span> MBytes                <span class="number">200</span> MBytes               </span>
<span class="line"></span>
<span class="line">  Apply-Related Property Settings:</span>
<span class="line">    Property                        dgtp Value               dgts Value</span>
<span class="line">    DelayMins                       <span class="number">0</span>                        <span class="number">0</span></span>
<span class="line">    ApplyParallel                   AUTO                     AUTO</span>
<span class="line">    ApplyInstances                  <span class="number">0</span>                        <span class="number">0</span></span>
<span class="line"></span>
<span class="line">  Transport-Related Property Settings:</span>
<span class="line">    Property                        dgtp Value               dgts Value</span>
<span class="line">    LogXptMode                      ASYNC                    ASYNC</span>
<span class="line">    Dependency                      &lt;empty&gt;                  &lt;empty&gt;</span>
<span class="line">    DelayMins                       <span class="number">0</span>                        <span class="number">0</span></span>
<span class="line">    Binding                         optional                 optional</span>
<span class="line">    MaxFailure                      <span class="number">0</span>                        <span class="number">0</span></span>
<span class="line">    MaxConnections                  <span class="number">1</span>                        <span class="number">1</span></span>
<span class="line">    ReopenSecs                      <span class="number">300</span>                      <span class="number">300</span></span>
<span class="line">    NetTimeout                      <span class="number">30</span>                       <span class="number">30</span></span>
<span class="line">    RedoCompression                 DISABLE                  DISABLE</span>
<span class="line">    LogShipping                     ON                       ON</span>
</pre></td></tr></table></figure>
<h3 id="开启备库的闪回数据库"><a href="#开启备库的闪回数据库" class="headerlink" title="开启备库的闪回数据库"></a>开启备库的闪回数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> db_unique_name,open_mode,database_role,flashback_on from v$database;</span>
<span class="line"></span>
<span class="line">DB_UNIQUE_NAME                 OPEN_MODE            DATABASE_ROLE    FLASHBACK_ON</span>
<span class="line">------------------------------ -------------------- ---------------- ------------------</span>
<span class="line">DGTS                           READ ONLY WITH APPLY PHYSICAL STANDBY NO</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">SQL&gt; alter database flashback on;</span>
<span class="line">alter database flashback on</span>
<span class="line">*</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">01153</span>: an incompatible media recovery is active</span>
<span class="line"></span>
<span class="line">SQL&gt; recover managed standby database cancel;</span>
<span class="line">Media recovery complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database flashback on;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; recover managed standby database disconnect from session;</span>
<span class="line">Media recovery complete.</span>
<span class="line"></span>
<span class="line">DB_UNIQUE_NAME                 OPEN_MODE            DATABASE_ROLE    FLASHBACK_ON</span>
<span class="line">------------------------------ -------------------- ---------------- ------------------</span>
<span class="line">DGTS                           READ ONLY WITH APPLY PHYSICAL STANDBY YES</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-09 12c 灾备环境搭建]]></title>
      <url>/2017/07/02/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/09_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="Snapshot-Standby"><a href="#Snapshot-Standby" class="headerlink" title="Snapshot Standby"></a>Snapshot Standby</h2><h3 id="查看数据库状态"><a href="#查看数据库状态" class="headerlink" title="查看数据库状态"></a>查看数据库状态</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主库状态</span></span>
<span class="line">set line <span class="number">150</span></span>
<span class="line">col DB_UNIQUE_NAME <span class="keyword">for</span> a15</span>
<span class="line">col FORCE_LOGGING <span class="keyword">for</span> a15</span>
<span class="line"><span class="keyword">select</span> name,db_unique_name,open_mode,database_role,flashback_on,force_logging,log_mode from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME  OPEN_MODE            DATABASE_ROLE    FLASHBACK_ON       FORCE_LOGGING   LOG_MODE</span>
<span class="line">--------- --------------- -------------------- ---------------- ------------------ --------------- ------------</span>
<span class="line">DGT       DGTP            READ WRITE           PRIMARY          YES                YES             ARCHIVELOG</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备库状态</span></span>
<span class="line">set line <span class="number">150</span></span>
<span class="line">col DB_UNIQUE_NAME <span class="keyword">for</span> a15</span>
<span class="line">col FORCE_LOGGING <span class="keyword">for</span> a15</span>
<span class="line"><span class="keyword">select</span> name,db_unique_name,open_mode,database_role,flashback_on,force_logging,log_mode from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME  OPEN_MODE            DATABASE_ROLE    FLASHBACK_ON       FORCE_LOGGING   LOG_MODE</span>
<span class="line">--------- --------------- -------------------- ---------------- ------------------ --------------- ------------</span>
<span class="line">DGT       DGTS            READ ONLY WITH APPLY PHYSICAL STANDBY YES                YES             ARCHIVELOG</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="切换到Snapshot-Standby"><a href="#切换到Snapshot-Standby" class="headerlink" title="切换到Snapshot Standby"></a>切换到Snapshot Standby</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在主库上执行</span></span>
<span class="line">dgmgrl sys/Center08@dgtp</span>
<span class="line">DGMGRL <span class="keyword">for</span> Linux: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - Production on Fri Jun <span class="number">30</span> <span class="number">11</span>:<span class="number">18</span>:<span class="number">13</span> <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Welcome to DGMGRL, type <span class="string">"help"</span> <span class="keyword">for</span> information.</span>
<span class="line">Connected to <span class="string">"dgts"</span></span>
<span class="line">Connected as SYSDG.</span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">49</span> seconds ago)</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; help convert</span>
<span class="line"></span>
<span class="line">Converts a database from one type to another</span>
<span class="line"></span>
<span class="line">Syntax:</span>
<span class="line"></span>
<span class="line">  CONVERT DATABASE &lt;database name&gt; TO</span>
<span class="line">     &#123; SNAPSHOT STANDBY | PHYSICAL STANDBY &#125;;</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; convert database dgts to snapshot standby;</span>
<span class="line">Converting database <span class="string">"dgts"</span> to a Snapshot Standby database, please wait...</span>
<span class="line">Database <span class="string">"dgts"</span> converted successfully</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Snapshot standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">33</span> seconds ago)</span>
</pre></td></tr></table></figure>
<h3 id="在SNAPSHOT-STANDBY上增加测试数据"><a href="#在SNAPSHOT-STANDBY上增加测试数据" class="headerlink" title="在SNAPSHOT STANDBY上增加测试数据"></a>在SNAPSHOT STANDBY上增加测试数据</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主库PDB1下表</span></span>
<span class="line">conn lyj/lyj@pdb1</span>
<span class="line"><span class="keyword">select</span> * from cat;</span>
<span class="line"></span>
<span class="line">TABLE_NAME                                         TABLE_TYPE</span>
<span class="line">-------------------------------------------------- -----------</span>
<span class="line">TEST                                               TABLE</span>
<span class="line"></span>
<span class="line"><span class="comment"># 备库tnsnames中添加pdb1备库地址</span></span>
<span class="line">SPDB1 =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">  (ADDRESS_LIST =</span>
<span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.175</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">  )</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = pdb1)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备库状态</span></span>
<span class="line">conn / as sysdba</span>
<span class="line">set line <span class="number">150</span></span>
<span class="line">col DB_UNIQUE_NAME <span class="keyword">for</span> a15</span>
<span class="line">col FORCE_LOGGING <span class="keyword">for</span> a15</span>
<span class="line"><span class="keyword">select</span> name,db_unique_name,open_mode,database_role,flashback_on,force_logging,log_mode from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME  OPEN_MODE            DATABASE_ROLE    FLASHBACK_ON       FORCE_LOGGING   LOG_MODE</span>
<span class="line">--------- --------------- -------------------- ---------------- ------------------ --------------- ------------</span>
<span class="line">DGT       DGTS            READ WRITE           SNAPSHOT STANDBY YES                YES             ARCHIVELOG</span>
<span class="line"></span>
<span class="line">show pdbs</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line"></span>
<span class="line">conn lyj/lyj@spdb1</span>
<span class="line"></span>
<span class="line">create table test1 as <span class="keyword">select</span> * from all_objects;</span>
<span class="line"><span class="keyword">select</span> count(*) from test1;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">56326</span></span>
<span class="line"></span>
<span class="line">drop table test purge;</span>
<span class="line">Table dropped.</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from cat;</span>
<span class="line"></span>
<span class="line">TABLE_NAME                                         TABLE_TYPE</span>
<span class="line">-------------------------------------------------- -----------</span>
<span class="line">TEST1                                              TABLE</span>
</pre></td></tr></table></figure>
<h3 id="备库切换回PHYSICAL-STANDBY"><a href="#备库切换回PHYSICAL-STANDBY" class="headerlink" title="备库切换回PHYSICAL STANDBY"></a>备库切换回PHYSICAL STANDBY</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在主库上执行</span></span>
<span class="line">dgmgrl sys/Center08@dgtp</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; convert database dgts to physical standby;</span>
<span class="line">Converting database <span class="string">"dgts"</span> to a Physical Standby database, please wait...</span>
<span class="line">Operation requires shut down of instance <span class="string">"dgt"</span> on database <span class="string">"dgts"</span></span>
<span class="line">Shutting down instance <span class="string">"dgt"</span>...</span>
<span class="line">Connected to <span class="string">"DGTS"</span></span>
<span class="line">Database closed.</span>
<span class="line">Database dismounted.</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line">Operation requires start up of instance <span class="string">"dgt"</span> on database <span class="string">"dgts"</span></span>
<span class="line">Starting instance <span class="string">"dgt"</span>...</span>
<span class="line">ORACLE instance started.</span>
<span class="line">Database mounted.</span>
<span class="line">Connected to <span class="string">"DGTS"</span></span>
<span class="line">Continuing to convert database <span class="string">"dgts"</span> ...</span>
<span class="line">Database <span class="string">"dgts"</span> converted successfully</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备库状态</span></span>
<span class="line">set line <span class="number">150</span></span>
<span class="line">col DB_UNIQUE_NAME <span class="keyword">for</span> a15</span>
<span class="line">col FORCE_LOGGING <span class="keyword">for</span> a15</span>
<span class="line"><span class="keyword">select</span> name,db_unique_name,open_mode,database_role,flashback_on,force_logging,log_mode from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME  OPEN_MODE            DATABASE_ROLE    FLASHBACK_ON       FORCE_LOGGING   LOG_MODE</span>
<span class="line">--------- --------------- -------------------- ---------------- ------------------ --------------- ------------</span>
<span class="line">DGT       DGTS            READ ONLY WITH APPLY PHYSICAL STANDBY YES                YES             ARCHIVELOG</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看刚才创建和删除的表都没有了，数据和主库保持一致</span></span>
<span class="line">conn lyj/lyj@spdb1</span>
<span class="line"></span>
<span class="line">TABLE_NAME                                         TABLE_TYPE</span>
<span class="line">-------------------------------------------------- -----------</span>
<span class="line">TEST                                               TABLE</span>
</pre></td></tr></table></figure>
<h2 id="跳归档恢复"><a href="#跳归档恢复" class="headerlink" title="跳归档恢复"></a>跳归档恢复</h2><h3 id="查看主库redo和归档状态"><a href="#查看主库redo和归档状态" class="headerlink" title="查看主库redo和归档状态"></a>查看主库redo和归档状态</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> GROUP<span class="comment">#,STATUS from v$log;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment"># STATUS</span></span>
<span class="line">---------- ----------------</span>
<span class="line">         <span class="number">1</span> ACTIVE</span>
<span class="line">         <span class="number">2</span> CURRENT</span>
<span class="line">         <span class="number">3</span> INACTIVE</span>
<span class="line"></span>
<span class="line"><span class="comment"># 最后一个归档编号40</span></span>
<span class="line">RMAN&gt; crosscheck archivelog all;</span>
<span class="line">......</span>
<span class="line">archived <span class="keyword">log</span> file name=<span class="regexp">/u01/app</span><span class="regexp">/oracle/fast</span>_recovery_area/dgt/DGTP/archivelog/<span class="number">2017_07_02</span>/o1_mf_1_40_dokd56wz<span class="number">_</span>.arc RECID=<span class="number">71</span> STAMP=<span class="number">948299815</span></span>
<span class="line">Crosschecked <span class="number">39</span> objects</span>
</pre></td></tr></table></figure>
<h3 id="停止备库模拟主库归档丢失"><a href="#停止备库模拟主库归档丢失" class="headerlink" title="停止备库模拟主库归档丢失"></a>停止备库模拟主库归档丢失</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在主库创建测试数据</span></span>
<span class="line">conn lyj/lyj@pdb1</span>
<span class="line">create table test2 as <span class="keyword">select</span> * from test;</span>
<span class="line">conn / as sysdba</span>
<span class="line">alter <span class="keyword">system</span> switch logfile;</span>
<span class="line">SQL&gt; <span class="keyword">select</span> GROUP<span class="comment">#,STATUS from v$log;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment"># STATUS</span></span>
<span class="line">---------- ----------------</span>
<span class="line">         <span class="number">1</span> INACTIVE</span>
<span class="line">         <span class="number">2</span> ACTIVE</span>
<span class="line">         <span class="number">3</span> CURRENT</span>
<span class="line">alter <span class="keyword">system</span> switch logfile;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 模拟归档丢失</span></span>
<span class="line">cd /u01/app/oracle/fast_recovery_area/dgt/DGTP/archivelog/<span class="number">2017_07_02</span></span>
<span class="line">ll</span>
<span class="line">total <span class="number">634884</span></span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">177589760</span> Jul  <span class="number">2</span> <span class="number">02</span>:<span class="number">33</span> o1_mf_1_37_dohtqjkb<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">174428672</span> Jul  <span class="number">2</span> 08:<span class="number">13</span> o1_mf_1_38_dojgp4kz<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">174482432</span> Jul  <span class="number">2</span> <span class="number">14</span>:<span class="number">00</span> o1_mf_1_39_dok2znlx<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">109455360</span> Jul  <span class="number">2</span> <span class="number">16</span>:<span class="number">36</span> o1_mf_1_40_dokd56wz<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall  <span class="number">14153728</span> Jul  <span class="number">2</span> <span class="number">16</span>:<span class="number">48</span> o1_mf_1_41_dokdvmw8<span class="number">_</span>.arc  <span class="comment"># 模拟丢失这个归档</span></span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall    <span class="number">198656</span> Jul  <span class="number">2</span> <span class="number">16</span>:<span class="number">52</span> o1_mf_1_42_dokf32hs<span class="number">_</span>.arc</span>
<span class="line"></span>
<span class="line">mv o1_mf_1_41_dokdvmw8<span class="number">_</span>.arc o1_mf_1_41_dokdvmw8<span class="number">_</span>.arc.bak</span>
<span class="line"></span>
<span class="line"><span class="comment"># 备库打开mount状态</span></span>
<span class="line">startup mount</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备库归档目录，发现41号归档没有传输到备库</span></span>
<span class="line">ll</span>
<span class="line">total <span class="number">625064</span></span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">177589760</span> Jul  <span class="number">2</span> <span class="number">02</span>:<span class="number">33</span> o1_mf_1_37_dohtqjnk<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">174428672</span> Jul  <span class="number">2</span> 08:<span class="number">13</span> o1_mf_1_38_dojgp4o6<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">174482432</span> Jul  <span class="number">2</span> <span class="number">14</span>:<span class="number">00</span> o1_mf_1_39_dok2znov<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">109455360</span> Jul  <span class="number">2</span> <span class="number">16</span>:<span class="number">36</span> o1_mf_1_40_dokd570y<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall    <span class="number">198656</span> Jul  <span class="number">2</span> <span class="number">16</span>:<span class="number">55</span> o1_mf_1_42_dokf85kk<span class="number">_</span>.arc</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall   <span class="number">3896832</span> Jul  <span class="number">2</span> <span class="number">16</span>:<span class="number">55</span> o1_mf_1_43_dokf85jr<span class="number">_</span>.arc</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看DG BROKER状态，有GAP Error</span></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    Error: ORA-<span class="number">16810</span>: multiple errors <span class="keyword">or</span> warnings detected <span class="keyword">for</span> the member</span>
<span class="line"></span>
<span class="line">    dgts - Physical standby database </span>
<span class="line">      Warning: ORA-<span class="number">16809</span>: multiple warnings detected <span class="keyword">for</span> the member</span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">ERROR   (status updated <span class="number">39</span> seconds ago)</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show database verbose dgtp;</span>
<span class="line"></span>
<span class="line">Database - dgtp</span>
<span class="line"></span>
<span class="line">  Role:               PRIMARY</span>
<span class="line">  Intended State:     TRANSPORT-ON</span>
<span class="line">  Instance(<span class="keyword">s</span>):</span>
<span class="line">    dgt</span>
<span class="line">      Error: ORA-<span class="number">16737</span>: the <span class="keyword">redo</span> transport service <span class="keyword">for</span> member <span class="string">"dgts"</span> has an error</span>
<span class="line"></span>
<span class="line">  Database Error(<span class="keyword">s</span>):</span>
<span class="line">    ORA-<span class="number">16783</span>: cannot resolve gap <span class="keyword">for</span> member dgts</span>
<span class="line">......</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备库当前SCN号</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> current_scn from v$database;</span>
<span class="line"></span>
<span class="line">CURRENT_SCN</span>
<span class="line">-----------</span>
<span class="line">    <span class="number">2606427</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看主库当前SCN号</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> current_scn from v$database;</span>
<span class="line"></span>
<span class="line">CURRENT_SCN</span>
<span class="line">-----------</span>
<span class="line">    <span class="number">2615063</span></span>
</pre></td></tr></table></figure>
<h3 id="跳归档恢复-1"><a href="#跳归档恢复-1" class="headerlink" title="跳归档恢复"></a>跳归档恢复</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># SCN增量备份，同时创建备库控制文件</span></span>
<span class="line">rman target /</span>
<span class="line">backup incremental from scn <span class="number">2606427</span> database <span class="keyword">format</span> <span class="string">'/tmp/incre_%U'</span> tag <span class="string">'for_standby'</span>;</span>
<span class="line">alter database create standby controlfile as <span class="string">'/tmp/std_con.ctl'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 将备份集和备库控制文件拷贝到备份</span></span>
<span class="line">cd /tmp</span>
<span class="line">scp incre* dgts12:<span class="regexp">/tmp/incre</span>_backup  <span class="comment"># 没有这个目录的话可以先创建</span></span>
<span class="line">scp std_con.ctl dgts12:<span class="regexp">/tmp</span>
<span class="line"></span>
<span class="line"># 启动备库到nomount</span>
<span class="line">shutdown immediate</span>
<span class="line">startup nomount</span>
<span class="line"></span>
<span class="line"># 恢复控制文件</span>
<span class="line">RMAN&gt; restore controlfile from '/tmp</span><span class="regexp">/std_con.ctl';</span>
<span class="line"></span>
<span class="line">Starting restore at 2017-07-02 17:26:37</span>
<span class="line">using target database control file instead of recovery catalog</span>
<span class="line">allocated channel: ORA_DISK_1</span>
<span class="line">channel ORA_DISK_1: SID=743 device type=DISK</span>
<span class="line"></span>
<span class="line">channel ORA_DISK_1: copied control file copy</span>
<span class="line">output file name=/u</span>01/app/oracle/oradata/dgt/control01.ctl</span>
<span class="line">output file name=<span class="regexp">/u01/app</span><span class="regexp">/oracle/fast</span>_recovery_area/dgt/control02.ctl</span>
<span class="line">Finished restore at <span class="number">2017</span>-<span class="number">07</span>-<span class="number">02</span> <span class="number">17</span>:<span class="number">26</span>:<span class="number">39</span></span>
<span class="line"></span>
<span class="line">RMAN&gt; alter database mount;</span>
<span class="line"></span>
<span class="line">Statement processed</span>
<span class="line">released channel: ORA_DISK_1</span>
<span class="line"></span>
<span class="line">RMAN&gt; catalog start with <span class="string">'/tmp/incre_backup'</span>;</span>
<span class="line">......</span>
<span class="line">File Name: <span class="regexp">/u01/app</span><span class="regexp">/oracle/fast</span>_recovery_area/dgt/DGTS/autobackup/<span class="number">2017_06_30</span>/o1_mf_s_948045937_dod8mk3g<span class="number">_</span>.bkp</span>
<span class="line"></span>
<span class="line">searching <span class="keyword">for</span> all files that match the pattern /tmp/incre_backup</span>
<span class="line"></span>
<span class="line">List of Files Unknown to the Database</span>
<span class="line"></span>
<span class="line">File Name: <span class="regexp">/tmp/incre</span>_backup/incre_3gs8bs72_1_1</span>
<span class="line">File Name: <span class="regexp">/tmp/incre</span>_backup/incre_3hs8bs79_1_1</span>
<span class="line">File Name: <span class="regexp">/tmp/incre</span>_backup/incre_3js8bs7c_1_1</span>
<span class="line"></span>
<span class="line">Do you really want to catalog the above files (enter YES <span class="keyword">or</span> NO)? yes</span>
<span class="line">cataloging files...</span>
<span class="line">cataloging done</span>
<span class="line"></span>
<span class="line">List of Cataloged Files</span>
<span class="line"></span>
<span class="line">File Name: <span class="regexp">/tmp/incre</span>_backup/incre_3gs8bs72_1_1</span>
<span class="line">File Name: <span class="regexp">/tmp/incre</span>_backup/incre_3hs8bs79_1_1</span>
<span class="line">File Name: <span class="regexp">/tmp/incre</span>_backup/incre_3js8bs7c_1_1</span>
<span class="line"></span>
<span class="line">RMAN&gt; recover database noredo;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 开启恢复模式</span></span>
<span class="line">recover managed standby database disconnect from session;</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[SQL优化--dbms_sqltune应用实例]]></title>
      <url>/2017/06/28/oracle/SQL%E4%BC%98%E5%8C%96--dbms_sqltune%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B/</url>
      <content type="html"><![CDATA[<h2 id="需要优化的SQL"><a href="#需要优化的SQL" class="headerlink" title="需要优化的SQL"></a>需要优化的SQL</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SELECT a.sjhm</span>
<span class="line">FROM    bfcrm8.hyk_hyxx  b,</span>
<span class="line">        bfcrm8.hyk_grxx  a,</span>
<span class="line">        bfcrm8.hyxfjl    c,</span>
<span class="line">        bfcrm8.hyxfjl_sp d</span>
<span class="line">WHERE   a.hyid         =b.hyid</span>
<span class="line">        AND a.hyid     =c.hyid</span>
<span class="line">        AND c.xfjlid   =d.xfjlid</span>
<span class="line">        AND b.hyktype IN (<span class="string">'101'</span>)</span>
<span class="line">        AND b.status  &gt;=<span class="number">0</span></span>
<span class="line">        AND a.sex      =<span class="string">'1'</span></span>
<span class="line">        AND d.bmdm LIKE <span class="string">'010104%'</span></span>
<span class="line">        AND TO_CHAR(sysdate,<span class="string">'YYYY'</span>) - TO_CHAR(a.csrq,<span class="string">'YYYY'</span>)&gt;=<span class="string">'20'</span></span>
<span class="line">        AND TO_CHAR(sysdate,<span class="string">'YYYY'</span>) - TO_CHAR(a.csrq,<span class="string">'YYYY'</span>) &lt;<span class="string">'41'</span></span>
<span class="line">GROUP BY a.sjhm</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="重新收集相关表的统计信息"><a href="#重新收集相关表的统计信息" class="headerlink" title="重新收集相关表的统计信息"></a>重新收集相关表的统计信息</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">col OBJECT_NAME <span class="keyword">for</span> a3<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> OBJECT_NAME,OBJECT_TYPE from dba_objects where OBJECT_NAME in (<span class="string">'HYK_HYXX'</span>,<span class="string">'HYK_GRXX'</span>,<span class="string">'HYXFJL'</span>,<span class="string">'HYXFJL_SP'</span>) <span class="keyword">and</span> OWNER=<span class="string">'BFCRM8'</span>;</span>
<span class="line"></span>
<span class="line">OBJECT_NAME                    OBJECT_TYPE</span>
<span class="line">------------------------------ -------------------</span>
<span class="line">HYK_GRXX                       VIEW    <span class="comment"># 需要找到对应的表</span></span>
<span class="line">HYK_HYXX                       TABLE</span>
<span class="line">HYXFJL                         TABLE</span>
<span class="line">HYXFJL_SP                      TABLE</span>
<span class="line"></span>
<span class="line">desc dbms_metadata</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------</span></span>
<span class="line">......</span>
<span class="line">FUNCTION GET_DDL RETURNS CLOB</span>
<span class="line"> Argument Name                  Type                    In/Out Default?</span>
<span class="line"> ------------------------------ ----------------------- ------ --------</span>
<span class="line"> OBJECT_TYPE                    VARCHAR2                IN</span>
<span class="line"> NAME                           VARCHAR2                IN</span>
<span class="line"> SCHEMA                         VARCHAR2                IN     DEFAULT</span>
<span class="line"> VERSION                        VARCHAR2                IN     DEFAULT</span>
<span class="line"> MODEL                          VARCHAR2                IN     DEFAULT</span>
<span class="line"> TRANSFORM                      VARCHAR2                IN     DEFAULT</span>
<span class="line">......</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> dbms_metadata.get_ddl(<span class="string">'VIEW'</span>,<span class="string">'HYK_GRXX'</span>,<span class="string">'BFCRM8'</span>) from dual;</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------</span></span>
<span class="line">......</span>
<span class="line">from BFCRM8.HYK_HYXX X,BFCRM8.HYK_GKDA A</span>
<span class="line">  where X.GKID=A.GKID</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 需要重新收集以下4张表</span></span>
<span class="line"><span class="keyword">exec</span> dbms_stats.gather_table_stats(<span class="string">'BFCRM8'</span>,<span class="string">'HYK_HYXX'</span>,<span class="string">cascade=&gt;</span>true,<span class="string">method_opt=&gt;</span><span class="string">'for all columns size 1'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_stats.gather_table_stats(<span class="string">'BFCRM8'</span>,<span class="string">'HYK_GKDA'</span>,<span class="string">cascade=&gt;</span>true,<span class="string">method_opt=&gt;</span><span class="string">'for all columns size 1'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_stats.gather_table_stats(<span class="string">'BFCRM8'</span>,<span class="string">'HYXFJL'</span>,<span class="string">cascade=&gt;</span>true,<span class="string">method_opt=&gt;</span><span class="string">'for all columns size 1'</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_stats.gather_table_stats(<span class="string">'BFCRM8'</span>,<span class="string">'HYXFJL_SP'</span>,<span class="string">cascade=&gt;</span>true,<span class="string">method_opt=&gt;</span><span class="string">'for all columns size 1'</span>);</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> TABLE_NAME,NUM_ROWS from dba_tables </span>
<span class="line">where OWNER=<span class="string">'BFCRM8'</span> <span class="keyword">and</span> TABLE_NAME in (<span class="string">'HYK_HYXX'</span>,<span class="string">'HYK_GKDA'</span>,<span class="string">'HYXFJL'</span>,<span class="string">'HYXFJL_SP'</span>);</span>
<span class="line">TABLE_NAME                       NUM_ROWS</span>
<span class="line">------------------------------ ----------</span>
<span class="line">HYXFJL_SP                        <span class="number">86697233</span></span>
<span class="line">HYXFJL                           <span class="number">27315713</span></span>
<span class="line">HYK_HYXX                          <span class="number">5962417</span></span>
<span class="line">HYK_GKDA                           <span class="number">587940</span></span>
</pre></td></tr></table></figure>
<h2 id="查找对应的SQL-ID"><a href="#查找对应的SQL-ID" class="headerlink" title="查找对应的SQL_ID"></a>查找对应的SQL_ID</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> sql_id from v$sql where sql_text like <span class="string">'SELECT a.sjhm%'</span>;</span>
<span class="line"></span>
<span class="line">SQL_ID</span>
<span class="line">-------------</span>
<span class="line">bgfs0u4xch7wu</span>
</pre></td></tr></table></figure>
<h2 id="根据SQL-ID进行优化"><a href="#根据SQL-ID进行优化" class="headerlink" title="根据SQL_ID进行优化"></a>根据SQL_ID进行优化</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set serveroutput on</span>
<span class="line">declare</span>
<span class="line">l_tuning_task varchar2(<span class="number">30</span>);</span>
<span class="line">begin</span>
<span class="line"> l_tuning_task := dbms_sqltune.create_tuning_task(<span class="string">sql_id =&gt;</span> <span class="string">'&amp;SQL_ID'</span>);</span>
<span class="line"> dbms_sqltune.execute_tuning_task(l_tuning_task);</span>
<span class="line"> dbms_output.put_line(l_tuning_task);</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">Enter value for sql_id: bgfs0u4xch7wu</span>
<span class="line">old   4:  l_tuning_task := dbms_sqltune.create_tuning_task(sql_id =&gt; '&amp;SQL_ID');</span>
<span class="line">new   4:  l_tuning_task := dbms_sqltune.create_tuning_task(sql_id =&gt; 'bgfs0u4xch7wu');</span>
<span class="line">TASK_40161</span>
<span class="line"></span>
<span class="line">PL/</span>SQL procedure successfully completed.</span>
</pre></td></tr></table></figure>
<h2 id="查看优化建议报告"><a href="#查看优化建议报告" class="headerlink" title="查看优化建议报告"></a>查看优化建议报告</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 内容比较多，建议使用客端工具查看，格式化显示也比较好</span></span>
<span class="line">set long <span class="number">10000</span></span>
<span class="line"><span class="keyword">select</span> dbms_sqltune.report_tuning_task(<span class="string">'&amp;TASK_ID'</span>) as re from dual;</span>
<span class="line"></span>
<span class="line">GENERAL INFORMATION SECTION</span>
<span class="line">-------------------------------------------------------------------------------</span>
<span class="line">Tuning Task Name   : TASK_40161</span>
<span class="line">Tuning Task Owner  : SYS</span>
<span class="line">Workload Type      : Single SQL Statement</span>
<span class="line">Scope              : COMPREHENSIVE</span>
<span class="line">Time Limit(seconds): <span class="number">1800</span></span>
<span class="line">Completion Status  : COMPLETED</span>
<span class="line">Started at         : <span class="number">06</span>/<span class="number">28</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">03</span>:<span class="number">21</span></span>
<span class="line">Completed at       : <span class="number">06</span>/<span class="number">28</span>/<span class="number">2017</span> <span class="number">16</span>:<span class="number">03</span>:<span class="number">56</span></span>
<span class="line"></span>
<span class="line">-------------------------------------------------------------------------------</span>
<span class="line">Schema Name: SYS</span>
<span class="line">SQL ID     : bgfs0u4xch7wu</span>
<span class="line">SQL Text   : SELECT a.sjhm</span>
<span class="line">             FROM    bfcrm8.hyk_hyxx  b,</span>
<span class="line">                     bfcrm8.hyk_grxx  a,</span>
<span class="line">                     bfcrm8.hyxfjl    c,</span>
<span class="line">                     bfcrm8.hyxfjl_sp d</span>
<span class="line">             WHERE   a.hyid         =b.hyid</span>
<span class="line">                     AND a.hyid     =c.hyid</span>
<span class="line">                     AND c.xfjlid   =d.xfjlid</span>
<span class="line">                     AND b.hyktype IN (<span class="string">'101'</span>)</span>
<span class="line">                     AND b.status  &gt;=<span class="number">0</span></span>
<span class="line">                     AND a.sex      =<span class="string">'1'</span></span>
<span class="line">                     AND d.bmdm LIKE <span class="string">'010104%'</span></span>
<span class="line">                     AND TO_CHAR(sysdate,<span class="string">'YYYY'</span>) -</span>
<span class="line">             TO_CHAR(a.csrq,<span class="string">'YYYY'</span>)&gt;=<span class="string">'20'</span></span>
<span class="line">                     AND TO_CHAR(sysdate,<span class="string">'YYYY'</span>) - TO_CHAR(a.csrq,<span class="string">'YYYY'</span>)</span>
<span class="line">             &lt;<span class="string">'41'</span></span>
<span class="line">             GROUP BY a.sjhm</span>
<span class="line"></span>
<span class="line">-------------------------------------------------------------------------------</span>
<span class="line">FINDINGS SECTION (<span class="number">2</span> findings)</span>
<span class="line">-------------------------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="number">1</span>- SQL Profile Finding (see explain plans section below)</span>
<span class="line">--------------------------------------------------------</span>
<span class="line">  为此语句找到了性能更好的执行计划 <span class="number">2</span>。选择以下 SQL 概要文件之一进行实施。</span>
<span class="line"></span>
<span class="line">  Recommendation (estimated benefit: <span class="number">90.68</span>%)</span>
<span class="line">  ------------------------------------------</span>
<span class="line">  - 考虑接受推荐的 SQL 概要文件。</span>
<span class="line">    execute dbms_sqltune.accept_sql_profile(<span class="string">task_name =&gt;</span> <span class="string">'TASK_40161'</span>,</span>
<span class="line">            <span class="string">task_owner =&gt;</span> <span class="string">'SYS'</span>, <span class="string">replace =&gt;</span> TRUE);</span>
<span class="line"></span>
<span class="line">  Recommendation (estimated benefit: <span class="number">99.83</span>%)</span>
<span class="line">  ------------------------------------------</span>
<span class="line">  - 考虑接受建议的 SQL 概要文件, 以便对此语句使用并行执行。</span>
<span class="line">    execute dbms_sqltune.accept_sql_profile(<span class="string">task_name =&gt;</span> <span class="string">'TASK_40161'</span>,</span>
<span class="line">            <span class="string">task_owner =&gt;</span> <span class="string">'SYS'</span>, <span class="string">replace =&gt;</span> TRUE, <span class="string">profile_type =&gt;</span></span>
<span class="line">            DBMS_SQLTUNE.PX_PROFILE);</span>
<span class="line"></span>
<span class="line">  与 DOP <span class="number">64</span> 并行执行此查询会使 SQL 概要文件计划上的响应时间缩短 <span class="number">98.26</span>%。但是, 启用并行执行时要付出一些代价。它将增加语句的资源消耗</span>
<span class="line">  (预计为 <span class="number">11.07</span>%), 这会导致系统吞吐量降低。此外, 由于在非常短的持续时间内消耗了这些资源, 因此如果没有足够可用的硬件容量,</span>
<span class="line">  并发语句的响应时间将受到负面影响。</span>
<span class="line"></span>
<span class="line">  The following data shows some sampled statistics <span class="keyword">for</span> this SQL from the past</span>
<span class="line">  week <span class="keyword">and</span> projected weekly <span class="keyword">values</span> <span class="keyword">when</span> parallel execution is enabled.</span>
<span class="line"></span>
<span class="line">                                 Past week sampled statistics <span class="keyword">for</span> this SQL</span>
<span class="line">                                 -----------------------------------------</span>
<span class="line">  Number of executions                                                   <span class="number">0</span> </span>
<span class="line">  Percent of total activity                                              <span class="number">0</span> </span>
<span class="line">  Percent of samples with <span class="comment">#Active Sessions &gt; 2*CPU                       0 </span></span>
<span class="line">  Weekly DB <span class="keyword">time</span> (in sec)                                                <span class="number">0</span> </span>
<span class="line"></span>
<span class="line">                              Projected statistics with Parallel Execution</span>
<span class="line">                              --------------------------------------------</span>
<span class="line">  Weekly DB <span class="keyword">time</span> (in sec)                                                <span class="number">0</span> </span>
<span class="line"></span>
<span class="line"><span class="number">2</span>- Index Finding (see explain plans section below)</span>
<span class="line">--------------------------------------------------</span>
<span class="line">  通过创建一个或多个索引可以改进此语句的执行计划。</span>
<span class="line"></span>
<span class="line">  Recommendation (estimated benefit: <span class="number">99.33</span>%)</span>
<span class="line">  ------------------------------------------</span>
<span class="line">  - 考虑运行可以改进物理方案设计的访问指导或者创建推荐的索引。</span>
<span class="line">    create <span class="keyword">index</span> BFCRM8.IDX$$_9CE10001 on BFCRM8.HYXFJL_SP(<span class="string">"BMDM"</span>,<span class="string">"XFJLID"</span>);</span>
<span class="line"></span>
<span class="line">  Rationale</span>
<span class="line">  ---------</span>
<span class="line">    创建推荐的索引可以显著地改进此语句的执行计划。但是, 使用典型的 SQL 工作量运行 <span class="string">"访问指导"</span></span>
<span class="line">    可能比单个语句更可取。通过这种方法可以获得全面的索引建议案, 包括计算索引维护的开销和附加的空间消耗。</span>
<span class="line">.....</span>
</pre></td></tr></table></figure>
<h2 id="结合优化建议报告手动执行优化"><a href="#结合优化建议报告手动执行优化" class="headerlink" title="结合优化建议报告手动执行优化"></a>结合优化建议报告手动执行优化</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从报告文件可以看出，自动调优优化器生成了更优的执行计划，主要方案有以下两种（生产环境中不建议开并行）</span></span>
<span class="line"><span class="comment">## SQL Profile</span></span>
<span class="line">execute dbms_sqltune.accept_sql_profile(<span class="string">task_name =&gt;</span> <span class="string">'TASK_40161'</span>,<span class="string">task_owner =&gt;</span> user, <span class="string">replace =&gt;</span> TRUE, <span class="string">force_match =&gt;</span> true);</span>
<span class="line"></span>
<span class="line"><span class="comment">## Index</span></span>
<span class="line">create <span class="keyword">index</span> BFCRM8.IDX$$_9CE10001 on BFCRM8.HYXFJL_SP(<span class="string">"BMDM"</span>,<span class="string">"XFJLID"</span>) tablespace crm2_index;</span>
</pre></td></tr></table></figure>
<h2 id="使用OEM的SQL优化指导"><a href="#使用OEM的SQL优化指导" class="headerlink" title="使用OEM的SQL优化指导"></a>使用OEM的SQL优化指导</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># SQL优化指导 -&gt; 选择优化方案 -&gt; 实施 —&gt; 显示SQL</span></span>
<span class="line">declare</span>
<span class="line">cmd varchar2(<span class="number">400</span>);</span>
<span class="line">sname varchar2(<span class="number">400</span>);</span>
<span class="line">begin</span>
<span class="line">cmd := <span class="string">'create  index BFCRM8.IDX$$_9CE10001 on BFCRM8.HYXFJL_SP("BMDM","XFJLID") TABLESPACE "CRM2_INDEX"'</span>;</span>
<span class="line">EXECUTE IMMEDIATE cmd;</span>
<span class="line">sname := dbms_sqltune.accept_sql_profile(<span class="string">task_name =&gt;</span> <span class="string">'TASK_40161'</span>, <span class="string">object_id =&gt;</span> <span class="number">1</span>);</span>
<span class="line">END;</span>
<span class="line"><span class="regexp">/</span></span>
</pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.2cto.com/database/201503/385677.html" target="_blank" rel="external">sql_tuneadvisor的使用</a></li>
<li><a href="http://www.2cto.com/database/201401/270997.html" target="_blank" rel="external">ORACLE概要文件–sqlprofile</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_61cd89f60102edi3.html" target="_blank" rel="external">SQL优化—-dbms_sqltune详解</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> sql优化 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-08 容灾简介和环境搭建]]></title>
      <url>/2017/06/23/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/08_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="搭建12c的Data-Guard环境"><a href="#搭建12c的Data-Guard环境" class="headerlink" title="搭建12c的Data Guard环境"></a>搭建12c的Data Guard环境</h2><h3 id="主备库环境配置"><a href="#主备库环境配置" class="headerlink" title="主备库环境配置"></a>主备库环境配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主库已安数据，备库只安装了数据库软件，环境配置如下</span></span>
<span class="line">cat /etc/hosts</span>
<span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span>
<span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span>
<span class="line"><span class="number">10.240</span>.<span class="number">4.174</span>  dgtp12  dgtp12.ydgwng.cn</span>
<span class="line"><span class="number">10.240</span>.<span class="number">4.175</span>  dgts12  dgts12.ydgwng.cn</span>
<span class="line"></span>
<span class="line">echo <span class="string">"export ORACLE_SID=dgt"</span> &gt;&gt; <span class="regexp">/home/oracle</span><span class="regexp">/.bash_profile</span>
<span class="line">echo "export ORACLE_BASE=/u</span>01/app/oracle<span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>export ORACLE_HOME=\$ORACLE_BASE/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1<span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>export LD_LIBRARY_PATH=\$ORACLE_HOME/lib<span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>export PATH=\$PATH:\$HOME/bin:\$ORACLE_HOME/bin:\$ORACLE_HOME/OPatch<span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK<span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>export NLS_DATE_FORMAT=<span class="string">'yyyy-mm-dd hh24:mi:ss'</span><span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>alias sqlplus=<span class="string">'rlwrap sqlplus'</span><span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>alias asmcmd=<span class="string">'rlwrap asmcmd'</span><span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>alias rman=<span class="string">'rlwrap rman'</span><span class="string">" &gt;&gt; /home/oracle/.bash_profile</span>
<span class="line">echo "</span>alias dgmgrl=<span class="string">'rlwrap dgmgrl'</span><span class="string">" &gt;&gt; /home/oracle/.bash_profile</span></span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="查看-修改主库配置"><a href="#查看-修改主库配置" class="headerlink" title="查看/修改主库配置"></a>查看/修改主库配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> name,db_unique_name,open_mode,database_role from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME                 OPEN_MODE            DATABASE_ROLE</span>
<span class="line">--------- ------------------------------ -------------------- ----------------</span>
<span class="line">DGT       dgt                            READ WRITE           PRIMARY</span>
<span class="line"></span>
<span class="line">alter <span class="keyword">system</span> set db_unique_name=<span class="string">"dgtp"</span> scope=spfile; </span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> LOG_MODE,FORCE_LOGGING from v$database;</span>
<span class="line"></span>
<span class="line">LOG_MODE     FORCE_LOGGING</span>
<span class="line">------------ ---------------------------------------</span>
<span class="line">NOARCHIVELOG NO</span>
<span class="line"></span>
<span class="line">alter database force logging;</span>
<span class="line">sthutdown immediate</span>
<span class="line">startup mount</span>
<span class="line">alter database archivelog;</span>
<span class="line">alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> NAME,DB_UNIQUE_NAME,LOG_MODE,FORCE_LOGGING from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME                 LOG_MODE     FORCE_LOGGING</span>
<span class="line">--------- ------------------------------ ------------ ---------------------------------------</span>
<span class="line">DGT       DGTP                           ARCHIVELOG   YES</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> MEMBERS,BYTES/<span class="number">1024</span>/<span class="number">1024</span> from v$log;</span>
<span class="line"></span>
<span class="line">   MEMBERS BYTES/<span class="number">1024</span>/<span class="number">1024</span></span>
<span class="line">---------- ---------------</span>
<span class="line">         <span class="number">1</span>             <span class="number">200</span></span>
<span class="line">         <span class="number">1</span>             <span class="number">200</span></span>
<span class="line">         <span class="number">1</span>             <span class="number">200</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> MEMBER from v$logfile;</span>
<span class="line"></span>
<span class="line">MEMBER</span>
<span class="line">--------------------------------------------------</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/dgt/redo</span>03.log</span>
<span class="line">/u01/app/oracle/oradata/dgt/redo02.log</span>
<span class="line">/u01/app/oracle/oradata/dgt/redo01.log        </span>
<span class="line"></span>
<span class="line">alter database add standby logfile group <span class="number">4</span> <span class="string">'/u01/app/oracle/oradata/dgt/redo04.log'</span> size <span class="number">200</span><span class="keyword">m</span>;</span>
<span class="line">alter database add standby logfile group <span class="number">5</span> <span class="string">'/u01/app/oracle/oradata/dgt/redo05.log'</span> size <span class="number">200</span><span class="keyword">m</span>;</span>
<span class="line">alter database add standby logfile group <span class="number">6</span> <span class="string">'/u01/app/oracle/oradata/dgt/redo06.log'</span> size <span class="number">200</span><span class="keyword">m</span>;</span>
<span class="line">alter database add standby logfile group <span class="number">7</span> <span class="string">'/u01/app/oracle/oradata/dgt/redo07.log'</span> size <span class="number">200</span><span class="keyword">m</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> TYPE,MEMBER from v$logfile;</span>
<span class="line"></span>
<span class="line">TYPE    MEMBER</span>
<span class="line">------- --------------------------------------------------</span>
<span class="line">ONLINE  /u01/app/oracle/oradata/dgt/redo03.log</span>
<span class="line">ONLINE  /u01/app/oracle/oradata/dgt/redo02.log</span>
<span class="line">ONLINE  /u01/app/oracle/oradata/dgt/redo01.log</span>
<span class="line">STANDBY /u01/app/oracle/oradata/dgt/redo04.log</span>
<span class="line">STANDBY /u01/app/oracle/oradata/dgt/redo05.log</span>
<span class="line">STANDBY /u01/app/oracle/oradata/dgt/redo06.log</span>
<span class="line">STANDBY /u01/app/oracle/oradata/dgt/redo07.log</span>
<span class="line"></span>
<span class="line">alter <span class="keyword">system</span> set standby_file_management=auto;</span>
</pre></td></tr></table></figure>
<h3 id="配置备库pfile和orapwd"><a href="#配置备库pfile和orapwd" class="headerlink" title="配置备库pfile和orapwd"></a>配置备库pfile和orapwd</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在主库上</span></span>
<span class="line">create pfile from spfile;</span>
<span class="line"></span>
<span class="line">cd $ORACLE_HOME/dbs</span>
<span class="line">scp initdgt.ora <span class="number">10.240</span>.<span class="number">4.175</span>:$ORACLE_HOME/dbs/</span>
<span class="line">scp orapwdgt <span class="number">10.240</span>.<span class="number">4.175</span>:$ORACLE_HOME/dbs/</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在备库上</span></span>
<span class="line">vi $ORACLE_HOME/dbs/initdgt.ora</span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line"><span class="comment"># 修改</span></span>
<span class="line">*.db_unique_name=<span class="string">'dgts'</span></span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建所需目录</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/admin/dgt/adump</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/oradata/dgt</span>
</pre></td></tr></table></figure>
<h3 id="配置主备库LISTENER和tnsname"><a href="#配置主备库LISTENER和tnsname" class="headerlink" title="配置主备库LISTENER和tnsname"></a>配置主备库LISTENER和tnsname</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd $ORACLE_HOME/network/admin</span>
<span class="line">vi listener.ora</span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line"><span class="comment">#添加</span></span>
<span class="line">SID_LIST_LISTENER =</span>
<span class="line">  (SID_LIST =</span>
<span class="line">    (SID_DESC =</span>
<span class="line">      (GLOBAL_DBNAME = dgtp)</span>
<span class="line">      (ORACLE_HOME = <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1)</span>
<span class="line">      (SID_NAME = dgt)</span>
<span class="line">    )</span>
<span class="line">    (SID_DESC =</span>
<span class="line">      (GLOBAL_DBNAME = dgtp_DGB)</span>
<span class="line">      (ORACLE_HOME = <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1)</span>
<span class="line">      (SID_NAME = dgt)</span>
<span class="line">    )</span>
<span class="line">    (SID_DESC =</span>
<span class="line">      (GLOBAL_DBNAME = DGTP_DGMGRL)</span>
<span class="line">      (ORACLE_HOME = <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1)</span>
<span class="line">      (SID_NAME = dgt)</span>
<span class="line">    )</span>
<span class="line">    (SID_DESC =</span>
<span class="line">      (GLOBAL_DBNAME = pdb1)</span>
<span class="line">      (ORACLE_HOME = <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1)</span>
<span class="line">      (SID_NAME = dgt)</span>
<span class="line">    )</span>
<span class="line">)</span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">lsnrctl reload</span>
<span class="line"></span>
<span class="line">vi tnsnames.ora </span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line"><span class="comment"># 变为</span></span>
<span class="line">DGTP =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.174</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = dgtp)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">DGTS =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.175</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = dgts)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">PDB1 = </span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">  (ADDRESS_LIST =</span>
<span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.174</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.240</span>.<span class="number">4.175</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">  )</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = pdb1)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">scp tnsnames.ora <span class="number">10.240</span>.<span class="number">4.175</span>:$ORACLE_HOME/network/admin/</span>
<span class="line">scp listener.ora <span class="number">10.240</span>.<span class="number">4.175</span>:$ORACLE_HOME/network/admin/</span>
<span class="line"></span>
<span class="line"><span class="comment"># 备库listener.ora中将dgtp改成dgts，然后重启监听</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 验证配置</span></span>
<span class="line">tnsping dgtp</span>
<span class="line">tnsping dgts</span>
<span class="line"></span>
<span class="line">sqlplus sys/Center08@dgtp as sysdba</span>
<span class="line">sqlplus sys/Center08@dgts as sysdba</span>
</pre></td></tr></table></figure>
<h3 id="在主库的PDB1下面创建测试数据"><a href="#在主库的PDB1下面创建测试数据" class="headerlink" title="在主库的PDB1下面创建测试数据"></a>在主库的PDB1下面创建测试数据</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         2 PDB$SEED                       READ ONLY  NO</span>
<span class="line">         3 PDB1    </span>
<span class="line">alter pluggable database pdb1 open;</span>
<span class="line">alter pluggable database pdb1 save state;</span>
<span class="line">alter session set container=pdb1;</span>
<span class="line">create user lyj identified by lyj default tablespace users;</span>
<span class="line">grant connect,resource to lyj;</span>
<span class="line">alter user lyj quota unlimited on users;</span>
<span class="line"></span>
<span class="line">conn lyj/lyj@pdb1</span>
<span class="line">create table test as select * from all_objects;</span>
</pre></td></tr></table></figure>
<h3 id="创建备库"><a href="#创建备库" class="headerlink" title="创建备库"></a>创建备库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备库上，根据pfile创建spfile</span></span>
<span class="line">sqlplus / as sysdba</span>
<span class="line">create spfile from pfile;</span>
<span class="line">startup nomount</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在备库上执行</span></span>
<span class="line">rman target sys/Center08@dgtp auxiliary sys/Center08@dgts nocatalog</span>
<span class="line"></span>
<span class="line">Recovery Manager: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - Production on Fri Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">05</span>:<span class="number">14</span> <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates.  All rights reserved.</span>
<span class="line"></span>
<span class="line">connected to target database: DGT (DBID=<span class="number">1555489009</span>)</span>
<span class="line">using target database control file instead of recovery catalog</span>
<span class="line">connected to auxiliary database: DGT (<span class="keyword">not</span> mounted)</span>
<span class="line"></span>
<span class="line">duplicate target database <span class="keyword">for</span> standby from active database nofilenamecheck;</span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line">ORACLE error from auxiliary database: ORA-<span class="number">19527</span>: physical standby <span class="keyword">redo</span> <span class="keyword">log</span> must be renamed</span>
<span class="line">ORA-<span class="number">00312</span>: online <span class="keyword">log</span> <span class="number">1</span> thread <span class="number">1</span>: <span class="string">'/u01/app/oracle/oradata/dgt/redo01.log'</span></span>
<span class="line"></span>
<span class="line">RMAN-<span class="number">05535</span>: warning: All <span class="keyword">redo</span> <span class="keyword">log</span> files were <span class="keyword">not</span> <span class="keyword">defined</span> properly.</span>
<span class="line">ORACLE error from auxiliary database: ORA-<span class="number">19527</span>: physical standby <span class="keyword">redo</span> <span class="keyword">log</span> must be renamed</span>
<span class="line">ORA-<span class="number">00312</span>: online <span class="keyword">log</span> <span class="number">2</span> thread <span class="number">1</span>: <span class="string">'/u01/app/oracle/oradata/dgt/redo02.log'</span></span>
<span class="line"></span>
<span class="line">RMAN-<span class="number">05535</span>: warning: All <span class="keyword">redo</span> <span class="keyword">log</span> files were <span class="keyword">not</span> <span class="keyword">defined</span> properly.</span>
<span class="line">ORACLE error from auxiliary database: ORA-<span class="number">19527</span>: physical standby <span class="keyword">redo</span> <span class="keyword">log</span> must be renamed</span>
<span class="line">ORA-<span class="number">00312</span>: online <span class="keyword">log</span> <span class="number">3</span> thread <span class="number">1</span>: <span class="string">'/u01/app/oracle/oradata/dgt/redo03.log'</span></span>
<span class="line"></span>
<span class="line">RMAN-<span class="number">05535</span>: warning: All <span class="keyword">redo</span> <span class="keyword">log</span> files were <span class="keyword">not</span> <span class="keyword">defined</span> properly.</span>
<span class="line">ORACLE error from auxiliary database: ORA-<span class="number">19527</span>: physical standby <span class="keyword">redo</span> <span class="keyword">log</span> must be renamed</span>
<span class="line">ORA-<span class="number">00312</span>: online <span class="keyword">log</span> <span class="number">4</span> thread <span class="number">0</span>: <span class="string">'/u01/app/oracle/oradata/dgt/redo04.log'</span></span>
<span class="line"></span>
<span class="line">RMAN-<span class="number">05535</span>: warning: All <span class="keyword">redo</span> <span class="keyword">log</span> files were <span class="keyword">not</span> <span class="keyword">defined</span> properly.</span>
<span class="line">ORACLE error from auxiliary database: ORA-<span class="number">19527</span>: physical standby <span class="keyword">redo</span> <span class="keyword">log</span> must be renamed</span>
<span class="line">ORA-<span class="number">00312</span>: online <span class="keyword">log</span> <span class="number">5</span> thread <span class="number">0</span>: <span class="string">'/u01/app/oracle/oradata/dgt/redo05.log'</span></span>
<span class="line"></span>
<span class="line">RMAN-<span class="number">05535</span>: warning: All <span class="keyword">redo</span> <span class="keyword">log</span> files were <span class="keyword">not</span> <span class="keyword">defined</span> properly.</span>
<span class="line">ORACLE error from auxiliary database: ORA-<span class="number">19527</span>: physical standby <span class="keyword">redo</span> <span class="keyword">log</span> must be renamed</span>
<span class="line">ORA-<span class="number">00312</span>: online <span class="keyword">log</span> <span class="number">6</span> thread <span class="number">0</span>: <span class="string">'/u01/app/oracle/oradata/dgt/redo06.log'</span></span>
<span class="line"></span>
<span class="line">RMAN-<span class="number">05535</span>: warning: All <span class="keyword">redo</span> <span class="keyword">log</span> files were <span class="keyword">not</span> <span class="keyword">defined</span> properly.</span>
<span class="line">ORACLE error from auxiliary database: ORA-<span class="number">19527</span>: physical standby <span class="keyword">redo</span> <span class="keyword">log</span> must be renamed</span>
<span class="line">ORA-<span class="number">00312</span>: online <span class="keyword">log</span> <span class="number">7</span> thread <span class="number">0</span>: <span class="string">'/u01/app/oracle/oradata/dgt/redo07.log'</span></span>
<span class="line"></span>
<span class="line">RMAN-<span class="number">05535</span>: warning: All <span class="keyword">redo</span> <span class="keyword">log</span> files were <span class="keyword">not</span> <span class="keyword">defined</span> properly.</span>
<span class="line">Finished Duplicate Db at <span class="number">2017</span>-<span class="number">06</span>-<span class="number">23</span> <span class="number">18</span>:<span class="number">06</span>:<span class="number">15</span></span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 解决办法</span></span>
<span class="line">vi $ORACLE_HOME/dbs/initdgt.ora</span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line">添加</span>
<span class="line">*.log_file_name_convert=<span class="string">'/u01/app/oracle/oradata/dgt'</span>,<span class="string">'/u01/app/oracle/oradata/dgt'</span> </span>
<span class="line">*.db_file_name_convert=<span class="string">'/u01/app/oracle/oradata/dgt'</span>,<span class="string">'/u01/app/oracle/oradata/dgt'</span></span>
<span class="line"><span class="comment">#--------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除相关文件后再次重新执行成功</span></span>
<span class="line">cd /u01/app/oracle/oradata/dgt/</span>
<span class="line">rm -rf *</span>
<span class="line"></span>
<span class="line">sqlplus / as sysdba</span>
<span class="line">create spfile from pfile;</span>
<span class="line">startup nomount</span>
<span class="line"></span>
<span class="line">rman target sys/Center08@dgtp auxiliary sys/Center08@dgts nocatalog</span>
<span class="line">duplicate target database <span class="keyword">for</span> standby from active database nofilenamecheck;</span>
<span class="line"></span>
<span class="line">pwd</span>
<span class="line">/u01/app/oracle/oradata/dgt</span>
<span class="line">[oracle@dgts12 dgt]$ ll</span>
<span class="line">total <span class="number">2842396</span></span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall  <span class="number">18726912</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">26</span> control01.ctl</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall  <span class="number">18726912</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">26</span> control02.ctl</span>
<span class="line">drwxr-<span class="keyword">x</span>---. <span class="number">2</span> oracle oinstall        <span class="number">82</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> pdb1</span>
<span class="line">drwxr-<span class="keyword">x</span>---. <span class="number">2</span> oracle oinstall        <span class="number">64</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> pdbseed</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">209715712</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> redo01.log</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">209715712</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> redo02.log</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">209715712</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> redo03.log</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">209715712</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> redo04.log</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">209715712</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> redo05.log</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">209715712</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> redo06.log</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">209715712</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> redo07.log</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">492838912</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> sysaux01.dbf</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">838868992</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> system01.dbf</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall  <span class="number">68165632</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> undotbs01.dbf</span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall   <span class="number">5251072</span> Jun <span class="number">23</span> <span class="number">18</span>:<span class="number">20</span> users01.dbf</span>
<span class="line"></span>
<span class="line"><span class="comment"># root用户下</span></span>
<span class="line">vi /etc/oratab </span>
<span class="line"><span class="comment">#-----------------------------------------------------------------</span></span>
<span class="line">dgt:<span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1:N</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------</span></span>
<span class="line"><span class="comment">#</span></span>
<span class="line"><span class="comment">#</span></span>
<span class="line">[oracle@dgts12 dgt]$ </span>
<span class="line"></span>
<span class="line">sqlplus / as sysdba</span>
<span class="line">SQL&gt; <span class="keyword">select</span> name,db_unique_name,open_mode,database_role from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME                 OPEN_MODE            DATABASE_ROLE</span>
<span class="line">--------- ------------------------------ -------------------- ----------------</span>
<span class="line">DGT       DGTS                           MOUNTED              PHYSICAL STANDBY</span>
<span class="line"></span>
<span class="line">alter database <span class="keyword">open</span>;</span>
</pre></td></tr></table></figure>
<h3 id="配置dg-broker"><a href="#配置dg-broker" class="headerlink" title="配置dg_broker"></a>配置dg_broker</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在主备库上同时设置</span></span>
<span class="line">alter <span class="keyword">system</span> set dg_broker_start=true;</span>
<span class="line"></span>
<span class="line">dgmgrl /</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line">ORA-<span class="number">16532</span>: Oracle Data Guard broker configuration does <span class="keyword">not</span> exist</span>
<span class="line"></span>
<span class="line">Configuration details cannot be determined by DGMGRL</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; help create</span>
<span class="line"></span>
<span class="line">Creates a broker configuration</span>
<span class="line"></span>
<span class="line">Syntax:</span>
<span class="line"></span>
<span class="line">  CREATE CONFIGURATION &lt;configuration name&gt; [AS] </span>
<span class="line">    PRIMARY DATABASE IS &lt;database name&gt;</span>
<span class="line">    CONNECT IDENTIFIER IS &lt;<span class="keyword">connect</span> identifier&gt;;</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; help add</span>
<span class="line"></span>
<span class="line">Adds a member to the broker configuration</span>
<span class="line"></span>
<span class="line">Syntax:</span>
<span class="line"></span>
<span class="line">  ADD &#123; RECOVERY_APPLIANCE | DATABASE | FAR_SYNC &#125; &lt;object name&gt;</span>
<span class="line">    [AS CONNECT IDENTIFIER IS &lt;<span class="keyword">connect</span> identifier&gt;];</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建配置文件</span></span>
<span class="line">DGMGRL&gt; create CONFIGURATION dgt_dg as PRIMARY DATABASE IS dgtp CONNECT IDENTIFIER IS dgtp;</span>
<span class="line">Configuration <span class="string">"dgt_dg"</span> created with primary database <span class="string">"dgtp"</span></span>
<span class="line">DGMGRL&gt; add DATABASE dgts AS CONNECT IDENTIFIER IS dgts maintained as physical;</span>
<span class="line">Database <span class="string">"dgts"</span> added</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">DISABLED</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; enable configuration;</span>
<span class="line"></span>
<span class="line">DGMGRL&gt; show configuration;</span>
<span class="line"></span>
<span class="line">Configuration - dgt_dg</span>
<span class="line"></span>
<span class="line">  Protection Mode: MaxPerformance</span>
<span class="line">  Members:</span>
<span class="line">  dgtp - Primary database</span>
<span class="line">    dgts - Physical standby database </span>
<span class="line"></span>
<span class="line">Fast-Start Failover: DISABLED</span>
<span class="line"></span>
<span class="line">Configuration Status:</span>
<span class="line">SUCCESS   (status updated <span class="number">0</span> seconds ago)</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> name,db_unique_name,open_mode,database_role from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME                 OPEN_MODE            DATABASE_ROLE</span>
<span class="line">--------- ------------------------------ -------------------- ----------------</span>
<span class="line">DGT       dgts                           READ ONLY WITH APPLY PHYSICAL STANDBY</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-07 升级数据库至12c]]></title>
      <url>/2017/06/16/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/07_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="11g升级到12-2"><a href="#11g升级到12-2" class="headerlink" title="11g升级到12.2"></a>11g升级到12.2</h2><h3 id="查看当前系统环境"><a href="#查看当前系统环境" class="headerlink" title="查看当前系统环境"></a>查看当前系统环境</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">df -hT</span>
<span class="line">Filesystem           Type   Size  Used Avail Use% Mounted on</span>
<span class="line">/dev/mapper/VolGroup-lv_root</span>
<span class="line">                     ext4    <span class="number">43</span>G   <span class="number">20</span>G   <span class="number">22</span>G  <span class="number">48</span>% <span class="regexp">/</span>
<span class="line">tmpfs                tmpfs  3.9G  109M  3.8G   3% /dev</span><span class="regexp">/shm</span>
<span class="line">/dev</span><span class="regexp">/sda1            ext4   477M   85M  364M  19% /boot</span></span>
<span class="line"></span>
<span class="line">free</span>
<span class="line">             total       used       free     shared    buffers     cached</span>
<span class="line">Mem:       <span class="number">8174784</span>    <span class="number">5810232</span>    <span class="number">2364552</span>     <span class="number">111112</span>     <span class="number">196636</span>     <span class="number">731784</span></span>
<span class="line">-<span class="regexp">/+ buffers/cache</span>:    <span class="number">4881812</span>    <span class="number">3292972</span></span>
<span class="line">Swap:     <span class="number">16777212</span>          <span class="number">0</span>   <span class="number">16777212</span></span>
<span class="line"></span>
<span class="line">su - grid</span>
<span class="line">opatch lspatches</span>
<span class="line"><span class="number">22502505</span>;ACFS Patch Set Update : <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.160419</span> (<span class="number">22502505</span>)</span>
<span class="line"><span class="number">23054319</span>;OCW Patch Set Update : <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.160719</span> (<span class="number">23054319</span>)</span>
<span class="line"><span class="number">24732075</span>;Database Patch Set Update : <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.170418</span> (<span class="number">24732075</span>)</span>
<span class="line"></span>
<span class="line"><span class="keyword">exit</span></span>
<span class="line">su - oracle</span>
<span class="line">sqlplus / as sysdba</span>
<span class="line"><span class="keyword">select</span> PROPERTY_VALUE from database_properties where PROPERTY_NAME=<span class="string">'NLS_RDBMS_VERSION'</span>;</span>
<span class="line"></span>
<span class="line">PROPERTY_VALUE</span>
<span class="line">--------------------------------------------------</span>
<span class="line"><span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> name,db_unique_name,open_mode,database_role from v$database;</span>
<span class="line"></span>
<span class="line">NAME      DB_UNIQUE_NAME                 OPEN_MODE            DATABASE_ROLE</span>
<span class="line">--------- ------------------------------ -------------------- ----------------</span>
<span class="line">DGT       dgts                           READ WRITE           PRIMARY</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="升级GI"><a href="#升级GI" class="headerlink" title="升级GI"></a>升级GI</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 关闭数据库 </span></span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line">cd /oradata/software</span>
<span class="line">unzip V83996<span class="number">0</span>-<span class="number">01</span>.zip</span>
<span class="line"></span>
<span class="line"><span class="comment"># root用户下，安装cvuqdisk</span></span>
<span class="line"><span class="comment">## cvuqdisk存于oracle安装介质的rpm目录下，解压缩database的安装介质即可看到此包</span></span>
<span class="line">cd /oradata/software/database/rpm/</span>
<span class="line">export CVUQDISK_GRP=asmadmin</span>
<span class="line">rpm -ivh cvuqdisk-<span class="number">1.0</span>.<span class="number">10</span>-<span class="number">1</span>.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建GI的新HOME目录</span></span>
<span class="line">su - grid</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/<span class="number">12.2</span>.<span class="number">0</span>/grid</span>
<span class="line"><span class="keyword">chown</span> -R grid:oinstall /u01/app/<span class="number">12.2</span>.<span class="number">0</span></span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">775</span> /u01/app/<span class="number">12.2</span>.<span class="number">0</span></span>
<span class="line"></span>
<span class="line">cd /u01/app/<span class="number">12.2</span>.<span class="number">0</span>/grid</span>
<span class="line">unzip /oradata/software/V840012-<span class="number">01</span>.zip</span>
<span class="line"></span>
<span class="line">sqlplus / as sysasm</span>
<span class="line"><span class="comment"># 如果不设置这个参数，11.2默认是到/dev/raw/*查找asm disk，但12C 默认是到/dev/sd*去查</span></span>
<span class="line">alter <span class="keyword">system</span> set asm_diskstring=<span class="string">'/dev/raw/*'</span> scope=both;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 不修改compatible安装时会报错</span></span>
<span class="line">col COMPATIBILITY form a1<span class="number">0</span></span>
<span class="line">col DATABASE_COMPATIBILITY form a1<span class="number">0</span></span>
<span class="line">col NAME form a2<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> group_number, name,compatibility, database_compatibility from v$asm_diskgroup;</span>
<span class="line">GROUP_NUMBER NAME                 COMPATIBIL DATABASE_C</span>
<span class="line">------------ -------------------- ---------- ----------</span>
<span class="line">           <span class="number">1</span> DATA                 <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> <span class="number">10.1</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">           <span class="number">2</span> FRA                  <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span> <span class="number">10.1</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span></span>
<span class="line"></span>
<span class="line">asmcmd setattr -G DATA compatible.asm <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span></span>
<span class="line">asmcmd setattr -G FRA compatible.asm <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> group_number, name,compatibility, database_compatibility from v$asm_diskgroup;</span>
<span class="line"></span>
<span class="line">GROUP_NUMBER NAME                 COMPATIBIL DATABASE_C</span>
<span class="line">------------ -------------------- ---------- ----------</span>
<span class="line">           <span class="number">1</span> DATA                 <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> <span class="number">10.1</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">           <span class="number">2</span> FRA                  <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> <span class="number">10.1</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 开始图形化安装</span></span>
<span class="line">export DISPLAY=<span class="number">10.240</span>.<span class="number">4.150</span>:<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">unset ORACLE_HOME</span>
<span class="line">unset ORACLE_BASE</span>
<span class="line">unset ORACLE_SID</span>
<span class="line">cd /u01/app/<span class="number">12.2</span>.<span class="number">0</span>/grid</span>
<span class="line">./gridSetup.sh</span>
</pre></td></tr></table></figure>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_01.png" alt=""><br>确保数据库实例已经关闭后，点YES<br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_02.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_03.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_04.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_05.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_06.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_07.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_08.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户下执行，交互确认都输入y，时间较长，耐心等待完成</span></span>
<span class="line">/u01/app/<span class="number">12.2</span>.<span class="number">0</span>/grid/rootupgrade.sh</span>
<span class="line">Overwrite it? (<span class="regexp">y/n) y # </span>
<span class="line">...</span>
<span class="line">2017/06/</span><span class="number">21</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">31</span> CLSRSC-<span class="number">482</span>: Running command: <span class="string">'srvctl upgrade model -s 11.2.0.4.0 -d 12.2.0.1.0 -p first'</span></span>
<span class="line"><span class="number">2017</span>/<span class="number">06</span>/<span class="number">21</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">46</span> CLSRSC-<span class="number">482</span>: Running command: <span class="string">'srvctl upgrade model -s 11.2.0.4.0 -d 12.2.0.1.0 -p last'</span></span>
<span class="line"></span>
<span class="line">dgts     <span class="number">2017</span>/<span class="number">06</span>/<span class="number">21</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">48</span>     /u01/app/<span class="number">12.2</span>.<span class="number">0</span>/grid/cdata/dgts/backup_20170621_174548.olr     <span class="number">0</span>     </span>
<span class="line"></span>
<span class="line">dgts     <span class="number">2017</span>/<span class="number">06</span>/08 <span class="number">18</span>:<span class="number">10</span>:<span class="number">20</span>     /u01/app/<span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/grid/cdata/dgts/backup_20170608_18102<span class="number">0</span>.olr     -     </span>
<span class="line">CRS-<span class="number">2791</span>: Starting <span class="keyword">shutdown</span> of Oracle High Availability Services-managed resources on <span class="string">'dgts'</span></span>
<span class="line">CRS-<span class="number">2673</span>: Attempting to stop <span class="string">'ora.evmd'</span> on <span class="string">'dgts'</span></span>
<span class="line">CRS-<span class="number">2677</span>: Stop of <span class="string">'ora.evmd'</span> on <span class="string">'dgts'</span> succeeded</span>
<span class="line">CRS-<span class="number">2793</span>: Shutdown of Oracle High Availability Services-managed resources on <span class="string">'dgts'</span> has completed</span>
<span class="line">CRS-<span class="number">4133</span>: Oracle High Availability Services has been stopped.</span>
<span class="line">CRS-<span class="number">4123</span>: Oracle High Availability Services has been started.</span>
<span class="line"></span>
<span class="line"><span class="number">2017</span>/<span class="number">06</span>/<span class="number">21</span> <span class="number">18</span>:<span class="number">03</span>:<span class="number">27</span> CLSRSC-<span class="number">327</span>: Successfully configured Oracle Restart <span class="keyword">for</span> a standalone server</span>
</pre></td></tr></table></figure></p>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_09.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_10.png" alt=""></p>
<p>注：若之前不修改compatible安装时检查会报以下错<br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_11.png" alt=""></p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root 用户下，完成后修改Grid帐号下的ORACLE_HOME值</span></span>
<span class="line">vi /home/grid/.bash_profile</span>
<span class="line">export ORACLE_HOME=<span class="regexp">/u01/app</span><span class="regexp">/12.2.0/grid</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改root帐号下GRID_HOME值</span></span>
<span class="line">vi /root/.bash_profile</span>
<span class="line">export GRID_HOME=<span class="regexp">/u01/app</span><span class="regexp">/12.2.0/grid</span></span>
<span class="line">export PATH=$PATH:$GRID_HOME/bin:$GRID_HOME/OPatch</span>
<span class="line"></span>
<span class="line">su - grid</span>
<span class="line">opatch lsinventory</span>
<span class="line"></span>
<span class="line"><span class="comment"># 可以使用asmca工具查看asm状态</span></span>
<span class="line">export DISPLAY=<span class="number">10.240</span>.<span class="number">4.150</span>:<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">asmca</span>
</pre></td></tr></table></figure>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_12.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看GI状态</span></span>
<span class="line">crsctl <span class="keyword">stat</span> res -t</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">Name           Target  State        Server                   State details       </span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">Local Resources</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">ora.DATA.dg</span>
<span class="line">               ONLINE  ONLINE       dgts                     STABLE</span>
<span class="line">ora.FRA.dg</span>
<span class="line">               ONLINE  ONLINE       dgts                     STABLE</span>
<span class="line">ora.LISTENER.lsnr</span>
<span class="line">               ONLINE  ONLINE       dgts                     STABLE</span>
<span class="line">ora.asm</span>
<span class="line">               ONLINE  ONLINE       dgts                     Started,STABLE</span>
<span class="line">ora.ons</span>
<span class="line">               OFFLINE OFFLINE      dgts                     STABLE</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">Cluster Resources</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line">ora.cssd</span>
<span class="line">      <span class="number">1</span>        ONLINE  ONLINE       dgts                     STABLE</span>
<span class="line">ora.diskmon</span>
<span class="line">      <span class="number">1</span>        OFFLINE OFFLINE                               STABLE</span>
<span class="line">ora.evmd</span>
<span class="line">      <span class="number">1</span>        ONLINE  ONLINE       dgts                     STABLE</span>
<span class="line">--------------------------------------------------------------------------------</span>
</pre></td></tr></table></figure></p>
<h3 id="安装12c数据库软件"><a href="#安装12c数据库软件" class="headerlink" title="安装12c数据库软件"></a>安装12c数据库软件</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># oracle用户下，创建oracle软件安装的HOME目录</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1</span>
<span class="line"><span class="keyword">chown</span> -R oracle:oinstall /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span></span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">775</span> /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span></span>
<span class="line"></span>
<span class="line">cd /oradata/software/database</span>
<span class="line">export DISPLAY=<span class="number">10.240</span>.<span class="number">4.150</span>:<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">unset ORACLE_BASE</span>
<span class="line">unset ORACLE_HOME</span>
<span class="line">unset ORACLE_SID</span>
<span class="line">./runInstaller</span>
<span class="line"></span>
<span class="line"><span class="comment"># 注意修改软件安装目录为/u01/app/oracle/product/12.2.0/db_1</span></span>
<span class="line"><span class="comment"># 只安装database software，单实例数据库，这步没什么特别的，就不上图了</span></span>
</pre></td></tr></table></figure>
<h3 id="升级数据库"><a href="#升级数据库" class="headerlink" title="升级数据库"></a>升级数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 执行预升级脚本检查</span></span>
<span class="line">java -jar $ORACLE_BASE/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1/rdbms/admin/preupgrade.jar</span>
<span class="line">Preupgrade generated files:</span>
<span class="line">    <span class="regexp">/u01/app</span><span class="regexp">/oracle/cfgtoollogs</span><span class="regexp">/dgts/preupgrade</span><span class="regexp">/preupgrade.log</span>
<span class="line">    /u</span>01/app/oracle/cfgtoollogs/dgts/preupgrade/preupgrade_fixups.sql</span>
<span class="line">    /u01/app/oracle/cfgtoollogs/dgts/preupgrade/postupgrade_fixups.sql</span>
<span class="line"></span>
<span class="line">SQL&gt; @/u01/app/oracle/cfgtoollogs/dgts/preupgrade/preupgrade_fixups.sql</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------</span></span>
<span class="line">Executing Oracle PRE-Upgrade Fixup Script</span>
<span class="line"></span>
<span class="line">Auto-Generated by:       Oracle Preupgrade Script</span>
<span class="line">                         Version: <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> Build: <span class="number">1</span></span>
<span class="line">Generated on:            <span class="number">2017</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">00</span>:<span class="number">54</span>:<span class="number">45</span></span>
<span class="line"></span>
<span class="line">For Source Database:     DGT</span>
<span class="line">Source Database Version: <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span></span>
<span class="line">For Upgrade to Version:  <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span></span>
<span class="line"></span>
<span class="line">                          Fixup</span>
<span class="line">Check Name                Status  Further DBA Action</span>
<span class="line">----------                ------  ------------------</span>
<span class="line">dictionary_stats          Passed  None</span>
<span class="line"></span>
<span class="line">PL/SQL procedure successfully completed.</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用dbua图形化工具升级DB</span></span>
<span class="line">cd /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1/bin</span>
<span class="line">export DISPLAY=<span class="number">10.240</span>.<span class="number">4.150</span>:<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">./dbua</span>
</pre></td></tr></table></figure>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_14.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_15.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_16.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_17.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_18.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_19.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_20.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_21.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0616_12c_upgrade_22.png" alt=""></p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 没有执行preupgrade_fixups.sql，按提示手动执行以下命令</span></span>
<span class="line">EXECUTE DBMS_STATS.GATHER_DICTIONARY_STATS;</span>
<span class="line">EXECUTE DBMS_STATS.GATHER_FIXED_OBJECTS_STATS;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 停止原11g数据库</span></span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
<span class="line"></span>
<span class="line">vi /home/oracle/.bash_profile</span>
<span class="line">export ORACLE_HOME=$ORACLE_BASE/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1</span>
<span class="line"></span>
<span class="line">sqlplus / as sysdba</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------</span></span>
<span class="line">SQL*Plus: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> Production on Sat Jun <span class="number">17</span> <span class="number">01</span>:<span class="number">50</span>:<span class="number">54</span> <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2016</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Connected to:</span>
<span class="line">Oracle Database <span class="number">12</span>c Enterprise Edition Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - <span class="number">64</span>bit Production</span>
<span class="line">SQL&gt; </span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">col COMP_ID <span class="keyword">for</span> a1<span class="number">0</span></span>
<span class="line">col COMP_NAME <span class="keyword">for</span> a4<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> <span class="keyword">substr</span>(comp_id,<span class="number">1</span>,<span class="number">15</span>) comp_id,<span class="keyword">substr</span>(comp_name,<span class="number">1</span>,<span class="number">30</span>)</span>
<span class="line">      comp_name,<span class="keyword">substr</span>(version,<span class="number">1</span>,<span class="number">10</span>) version,status</span>
<span class="line">from dba_registry order by modified;</span>
<span class="line"></span>
<span class="line">COMP_ID    COMP_NAME                                VERSION              STATUS</span>
<span class="line">---------- ---------------------------------------- -------------------- ----------------------</span>
<span class="line">CATALOG    Oracle Database Catalog Views            <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span>           VALID</span>
<span class="line">CATPROC    Oracle Database Packages <span class="keyword">and</span> T           <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span>           INVALID</span>
<span class="line">OWM        Oracle Workspace Manager                 <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span>           VALID</span>
<span class="line">XDB        Oracle XML Database                      <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span>           VALID</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># 检查orattab</span></span>
<span class="line">cat /etc/oratab</span>
<span class="line">+ASM:<span class="regexp">/u01/app</span><span class="regexp">/12.2.0/grid</span>:N             <span class="comment"># line added by Agent</span></span>
<span class="line">dgts:<span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1:N</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-06 PDB备份与恢复]]></title>
      <url>/2017/06/10/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/06_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="模拟4种完全恢复场景"><a href="#模拟4种完全恢复场景" class="headerlink" title="模拟4种完全恢复场景"></a>模拟4种完全恢复场景</h2><h3 id="数据库open状态，普通表空间损坏"><a href="#数据库open状态，普通表空间损坏" class="headerlink" title="数据库open状态，普通表空间损坏"></a>数据库open状态，普通表空间损坏</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 备份整个数据库</span></span>
<span class="line">rman target /</span>
<span class="line">RMAN&gt; backup database </span>
<span class="line"><span class="keyword">format</span> <span class="string">'/u01/app/rmanbackup/bak_%d_%T_%s_%U'</span>;</span>
<span class="line"></span>
<span class="line">SQL&gt; show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line"></span>
<span class="line">SQL&gt; conn lyj/lyj@pdb1</span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from test;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">    <span class="number">272404</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> FILE_NAME,TABLESPACE_NAME from dba_data_files;</span>
<span class="line"></span>
<span class="line">FILE_NAME                                          TABLESPACE_NAME</span>
<span class="line">-------------------------------------------------- ------------------------------</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl1/pdb</span>1/system01.dbf    SYSTEM</span>
<span class="line">/u01/app/oracle/oradata/orcl1/pdb1/sysaux01.dbf    SYSAUX</span>
<span class="line">/u01/app/oracle/oradata/orcl1/pdb1/undotbs01.dbf   UNDOTBS1</span>
<span class="line">/u01/app/oracle/oradata/orcl1/pdb1/users01.dbf     USERS</span>
<span class="line"></span>
<span class="line"><span class="comment"># 模拟普通表空间损坏</span></span>
<span class="line">SQL&gt; !rm /u01/app/oracle/oradata/orcl1/pdb1/users01.dbf</span>
<span class="line"></span>
<span class="line"><span class="comment"># 可以创建表并插入数据都可以正常完成</span></span>
<span class="line">create table test1 (id <span class="keyword">int</span>, name varchar2(<span class="number">10</span>));</span>
<span class="line">insert into test1 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'aaaa'</span>);</span>
<span class="line">insert into test1 <span class="keyword">values</span> (<span class="number">2</span>,<span class="string">'bbbb'</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">SQL&gt; col SEGMENT_NAME <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> SEGMENT_NAME,TABLESPACE_NAME from user_segments;</span>
<span class="line"></span>
<span class="line">SEGMENT_NAME                                       TABLESPACE_NAME</span>
<span class="line">-------------------------------------------------- ------------------------------</span>
<span class="line">TEST                                               USERS</span>
<span class="line">TEST1                                              USERS</span>
<span class="line"></span>
<span class="line"><span class="comment"># 再创建一个大表时报错</span></span>
<span class="line">SQL&gt; create table test2 as <span class="keyword">select</span> * from all_objects;</span>
<span class="line">create table test2 as <span class="keyword">select</span> * from all_objects</span>
<span class="line">                                    *</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">30</span>: <span class="string">'/u01/app/oracle/oradata/orcl1/pdb1/users01.dbf'</span></span>
<span class="line">ORA-<span class="number">01116</span>: error in opening database file <span class="number">30</span></span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">30</span>: <span class="string">'/u01/app/oracle/oradata/orcl1/pdb1/users01.dbf'</span></span>
<span class="line">ORA-<span class="number">27041</span>: unable to <span class="keyword">open</span> file</span>
<span class="line">Linux-x86_64 Error: <span class="number">2</span>: No such file <span class="keyword">or</span> directory</span>
<span class="line">Additional information: <span class="number">3</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 打开另一个session窗口</span></span>
<span class="line">conn / as sysdba</span>
<span class="line">SQL&gt; show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line"></span>
<span class="line">alter pluggable database pdb1 <span class="keyword">close</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 这时直接打开肯定也会报错</span></span>
<span class="line">SQL&gt; alter pluggable database pdb1 <span class="keyword">open</span>;</span>
<span class="line">alter pluggable database pdb1 <span class="keyword">open</span></span>
<span class="line">*</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">01157</span>: cannot identify/lock data file <span class="number">30</span> - see DBWR trace file</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">30</span>: <span class="string">'/u01/app/oracle/oradata/orcl1/pdb1/users01.dbf'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用RMAN恢复PDB</span></span>
<span class="line">rman target /</span>
<span class="line">restore pluggable database pdb1;</span>
<span class="line">recover pluggable database pdb1;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 这时pdb1就可以OPEN了</span></span>
<span class="line">alter pluggable database pdb1 <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除表空间文件后，创建的表也恢复成功</span></span>
<span class="line">conn lyj/lyj@pdb1</span>
<span class="line"><span class="keyword">select</span> count(*) from test1;</span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">         <span class="number">2</span></span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="数据库关闭状态，系统表空间损坏"><a href="#数据库关闭状态，系统表空间损坏" class="headerlink" title="数据库关闭状态，系统表空间损坏"></a>数据库关闭状态，系统表空间损坏</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter pluggable database pdb1 <span class="keyword">close</span>;</span>
<span class="line"><span class="comment"># 模拟系统表空间损坏</span></span>
<span class="line">!rm /u01/app/oracle/oradata/orcl1/pdb1/system01.dbf</span>
<span class="line"></span>
<span class="line">SQL&gt; alter pluggable database pdb1 <span class="keyword">open</span>;</span>
<span class="line">alter pluggable database pdb1 <span class="keyword">open</span></span>
<span class="line">*</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">01157</span>: cannot identify/lock data file <span class="number">27</span> - see DBWR trace file</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">27</span>: <span class="string">'/u01/app/oracle/oradata/orcl1/pdb1/system01.dbf'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用RMAN恢复系统表空间</span></span>
<span class="line">rman target /</span>
<span class="line">restore tablespace pdb1:<span class="keyword">system</span>;</span>
<span class="line">recover tablespace pdb1:<span class="keyword">system</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 恢复后，PDB数据库正常OPEN</span></span>
<span class="line">alter pluggable database pdb1 <span class="keyword">open</span>;</span>
</pre></td></tr></table></figure>
<h3 id="数据库关闭状态，普通表空间损坏"><a href="#数据库关闭状态，普通表空间损坏" class="headerlink" title="数据库关闭状态，普通表空间损坏"></a>数据库关闭状态，普通表空间损坏</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter pluggable database pdb1 <span class="keyword">close</span>;</span>
<span class="line">!rm /u01/app/oracle/oradata/orcl1/pdb1/users01.dbf</span>
<span class="line"></span>
<span class="line">SQL&gt; alter pluggable database pdb1 <span class="keyword">open</span>;</span>
<span class="line">alter pluggable database pdb1 <span class="keyword">open</span></span>
<span class="line">*</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">01157</span>: cannot identify/lock data file <span class="number">30</span> - see DBWR trace file</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">30</span>: <span class="string">'/u01/app/oracle/oradata/orcl1/pdb1/users01.dbf'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用RMAN恢复普通用户表空间</span></span>
<span class="line">rman target /</span>
<span class="line">restore tablespace pdb1:users;</span>
<span class="line">recover tablespace pdb1:users;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 恢复后，PDB数据库正常OPEN</span></span>
<span class="line">SQL&gt; alter pluggable database pdb1 <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Pluggable database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; conn lyj/lyj@pdb1</span>
<span class="line">Connected.</span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from test1;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">        <span class="number">10</span></span>
</pre></td></tr></table></figure>
<h3 id="数据库open状态，未备份的数据文件恢复"><a href="#数据库open状态，未备份的数据文件恢复" class="headerlink" title="数据库open状态，未备份的数据文件恢复"></a>数据库open状态，未备份的数据文件恢复</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line">alter session set container=pdb1;</span>
<span class="line">create tablespace bi datafile <span class="string">'/u01/app/oracle/oradata/orcl1/pdb1/bi01.dbf'</span> size <span class="number">100</span><span class="keyword">m</span>;</span>
<span class="line">create user bi identified by bi default tablespace bi;</span>
<span class="line">grant dba to bi;</span>
<span class="line">conn bi/bi@pdb1</span>
<span class="line">create table test as <span class="keyword">select</span> * from all_objects;</span>
<span class="line"></span>
<span class="line">!rm /u01/app/oracle/oradata/orcl1/pdb1/bi01.dbf</span>
<span class="line"></span>
<span class="line">SQL&gt; create table test1 as <span class="keyword">select</span> * from all_objects;</span>
<span class="line">create table test1 as <span class="keyword">select</span> * from all_objects</span>
<span class="line">                                    *</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">01116</span>: error in opening database file <span class="number">31</span></span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">31</span>: <span class="string">'/u01/app/oracle/oradata/orcl1/pdb1/bi01.dbf'</span></span>
<span class="line">ORA-<span class="number">27041</span>: unable to <span class="keyword">open</span> file</span>
<span class="line">Linux-x86_64 Error: <span class="number">2</span>: No such file <span class="keyword">or</span> directory</span>
<span class="line">Additional information: <span class="number">3</span></span>
<span class="line"></span>
<span class="line">conn / as sysdba</span>
<span class="line">alter pluggable database pdb1 <span class="keyword">close</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用RMAN恢复PDB数据库</span></span>
<span class="line">rman target /</span>
<span class="line">restore pluggable database pdb1;</span>
<span class="line">recover pluggable database pdb1;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 恢复成功后打开PDB数据库，并验证数据</span></span>
<span class="line">SQL&gt; alter pluggable database pdb1 <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Pluggable database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; conn bi/bi@pdb1</span>
<span class="line">Connected.</span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from test;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68103</span></span>
</pre></td></tr></table></figure>
<h2 id="模拟不完全恢复场景（drop-user）"><a href="#模拟不完全恢复场景（drop-user）" class="headerlink" title="模拟不完全恢复场景（drop user）"></a>模拟不完全恢复场景（drop user）</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> systimestamp from dual;</span>
<span class="line"></span>
<span class="line">SYSTIMESTAMP</span>
<span class="line">---------------------------------------------------------------------------</span>
<span class="line"><span class="number">12</span>-JUN-<span class="number">17</span> <span class="number">04</span>.09.<span class="number">11.763875</span> PM +08:<span class="number">00</span></span>
<span class="line"></span>
<span class="line">drop user bi cascade;</span>
<span class="line"></span>
<span class="line">SQL&gt; conn bi/bi@pdb1</span>
<span class="line">ERROR:</span>
<span class="line">ORA-<span class="number">01017</span>: invalid username/password; logon denied</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Warning: You are <span class="keyword">no</span> longer connected to ORACLE.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">alter pluggable database pdb1 <span class="keyword">close</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用rman进行不完全恢复</span></span>
<span class="line">rman target /</span>
<span class="line"></span>
<span class="line"><span class="comment"># 不加AUXILIARY DESTINATION '/tmp'报错</span></span>
<span class="line">run </span>
<span class="line">&#123; </span>
<span class="line">  set <span class="keyword">until</span> <span class="keyword">time</span> <span class="string">"to_date('2017-06-12 16:09:11','YYYY-MM-DD HH24:MI:SS')"</span>; </span>
<span class="line">  restore pluggable database pdb1; </span>
<span class="line">  recover pluggable database pdb1 AUXILIARY DESTINATION <span class="string">'/tmp'</span>;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">conn / as sysdba</span>
<span class="line">alter pluggable database pdb1 <span class="keyword">open</span> resetlogs;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 用户恢复成功</span></span>
<span class="line">SQL&gt; conn bi/bi@pdb1</span>
<span class="line">Connected.</span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from test;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68103</span></span>
</pre></td></tr></table></figure>
<h2 id="RMAN配置总结"><a href="#RMAN配置总结" class="headerlink" title="RMAN配置总结"></a>RMAN配置总结</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># RMAN常用配置命令</span></span>
<span class="line">SHOW ALL;</span>
<span class="line">CONFIGURE RETENTION POLICY TO REDUNDANCY <span class="number">1</span>;</span>
<span class="line">CONFIGURE RETENTION POLICY TO recovery window of <span class="number">3</span> days</span>
<span class="line">CONFIGURE DEFAULT DEVICE TYPE TO DISK;</span>
<span class="line">CONFIGURE CONTROLFILE AUTOBACKUP OFF|ON;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 备份分片</span></span>
<span class="line">CONFIGURE CHANNEL DEVICE TYPE DISK MAXPIECESIZE <span class="number">50</span> M;</span>
<span class="line">CONFIGURE CHANNEL <span class="number">1</span> DEVICE TYPE DISK maxpiecesize <span class="number">100</span>M <span class="keyword">format</span> <span class="string">'/u02/ora11g/flash_recovery_area/TEST/full_bak_%U'</span>;</span>
<span class="line">backup filesperset = <span class="number">5</span> as compressed backupset database <span class="keyword">format</span> <span class="string">'/tmp/full_db_%U'</span>;</span>
<span class="line">backup filesperset = <span class="number">5</span> as compressed backupset pluggable database FF <span class="keyword">format</span> <span class="string">'/tmp/ff_db_%U'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 1个channel和多个channel</span></span>
<span class="line">CONFIGURE CHANNEL <span class="number">1</span> DEVICE TYPE DISK MAXPIECESIZE <span class="number">50</span> M FORMAT <span class="string">'/u02/ora11g/flash_recovery_area/TEST/full_bak_%U'</span>;</span>
<span class="line">CONFIGURE CHANNEL <span class="number">2</span> DEVICE TYPE DISK MAXPIECESIZE <span class="number">50</span> M FORMAT <span class="string">'/u02/ora11g/flash_recovery_area/TEST/full_bak_%U'</span>;</span>
<span class="line">configure channel <span class="number">2</span> device type disk clear;</span>
<span class="line">show device type;</span>
<span class="line">show default device type;</span>
<span class="line">configure channel <span class="number">1</span> device type disk <span class="keyword">format</span> <span class="string">'/home/oracle/%U'</span>;</span>
<span class="line">configure channel <span class="number">1</span> device type disk clear;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 显示和报告</span></span>
<span class="line">list backup;</span>
<span class="line">list expired backup;</span>
<span class="line">list backupset summary;</span>
<span class="line">list backup of spfile;</span>
<span class="line">list backup of controlfile</span>
<span class="line">report schema;</span>
<span class="line">report need backup days <span class="number">3</span>;</span>
<span class="line">report need backup;</span>
<span class="line">report obsolete;</span>
<span class="line"></span>
<span class="line">list backup of pluggable database tcymob1_new12c;</span>
<span class="line">list backup of tablespace data;</span>
<span class="line">list backup of tablespace tcymob1_new12c:<span class="keyword">system</span></span>
<span class="line">list backup of datafile <span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 检测失效及删除</span></span>
<span class="line">crosscheck copy;</span>
<span class="line">crosscheck backup;</span>
<span class="line">crosscheck archivelog all;</span>
<span class="line"><span class="keyword">delete</span> noprompt expired copy;</span>
<span class="line"><span class="keyword">delete</span> noprompt expired backup;</span>
<span class="line"><span class="keyword">delete</span> noprompt expired archivelog all;</span>
<span class="line"><span class="keyword">delete</span> noprompt obsolete;</span>
<span class="line">backup database plus archivelog skip inaccessible <span class="keyword">delete</span> input;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 手工注册归档日志</span></span>
<span class="line">catalog start with <span class="string">'/u01/app/oracle/archive'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># Block change track</span></span>
<span class="line">alter database enable block change tracking using file <span class="string">'/u01/app/oracle/change_tracking'</span>;</span>
<span class="line">alter database disable block change tracking;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 增量备份</span></span>
<span class="line">backup incremental level=<span class="number">0</span> database;</span>
<span class="line">backup incremental level=<span class="number">1</span> database;</span>
<span class="line">backup incremental level=<span class="number">2</span> database;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 其他</span></span>
<span class="line">backup as compressed backupset database <span class="keyword">format</span> <span class="string">'/oradata/rmanbakcup/bak_%d_%T_%s_%U'</span>;</span>
<span class="line">CONFIGURE CONTROLFILE AUTOBACKUP FORMAT FOR DEVICE TYPE DISK TO <span class="string">'/oradata/rmanbakcup/ctl_%F'</span>;</span>
</pre></td></tr></table></figure>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><h3 id="数据恢复的原理"><a href="#数据恢复的原理" class="headerlink" title="数据恢复的原理"></a>数据恢复的原理</h3><ul>
<li>SCN 数据库对自身变化的一个标记</li>
<li>系统级（checkpoint_change# v$database）</li>
<li>数据文件级 (file#,checkpoint_change# v$datafile)</li>
<li>结束SCN(file#,last_change# v$datafile）</li>
<li>数据文件头部 (name,checkpoint_change# v$datafile_header)</li>
<li>12c中 v$database con_id=0</li>
</ul>
<h3 id="RMAN的核心"><a href="#RMAN的核心" class="headerlink" title="RMAN的核心"></a>RMAN的核心</h3><ul>
<li>recover.bsq</li>
<li>Dbms_rcvman</li>
<li>Dbms_backup_restore</li>
</ul>
<h3 id="12c-RMAN过期的命令"><a href="#12c-RMAN过期的命令" class="headerlink" title="12c RMAN过期的命令"></a>12c RMAN过期的命令</h3><p><a href="http://docs.oracle.com/database/122/RCMRF/deprecated-rman-syntax.htm#RCMRF910" target="_blank" rel="external">http://docs.oracle.com/database/122/RCMRF/deprecated-rman-syntax.htm#RCMRF910 </a></p>
<h3 id="RMAN还原恢复数据库"><a href="#RMAN还原恢复数据库" class="headerlink" title="RMAN还原恢复数据库"></a>RMAN还原恢复数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># CDB级别的数据还原恢复</span></span>
<span class="line">startup nomount</span>
<span class="line">restore controlfile from ‘xxxx’;</span>
<span class="line">alter database mount;</span>
<span class="line">catalog start with ‘xxxxx’;</span>
<span class="line">restore database;</span>
<span class="line"></span>
<span class="line"><span class="comment"># PDB级别的数据备份</span></span>
<span class="line">backup pluggable database tcymob<span class="number">0</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># PDB级别的数据还原恢复</span></span>
<span class="line">catalog start with ‘xxxxx’;</span>
<span class="line">restore pluggable database xx;</span>
<span class="line">recover tablespace pdb1:<span class="keyword">system</span>;</span>
</pre></td></tr></table></figure>
<h3 id="rman连接方式"><a href="#rman连接方式" class="headerlink" title="rman连接方式"></a>rman连接方式</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rman target /</span>
<span class="line">rman target sys/oracle</span>
<span class="line">rman target sys/oracle@orcl catalog rman/rman@emrep</span>
<span class="line"></span>
<span class="line"><span class="keyword">connect</span> target sys/oracle</span>
<span class="line"><span class="keyword">connect</span> target pdb_mgr/oracle@pdb</span>
</pre></td></tr></table></figure>
<h3 id="删除了所有的数据文件，日志文件，控制文件的恢复"><a href="#删除了所有的数据文件，日志文件，控制文件的恢复" class="headerlink" title="删除了所有的数据文件，日志文件，控制文件的恢复"></a>删除了所有的数据文件，日志文件，控制文件的恢复</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">restore controlfile from autobackup;</span>
<span class="line">restore controlfile from <span class="string">'/u02/oracle/flash_recovery_area/TEST10G/ctl_c-1135735312-20150802-0b'</span>;</span>
<span class="line">run&#123;</span>
<span class="line">  restore database; </span>
<span class="line">  recover database; </span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">run&#123; </span>
<span class="line">  set <span class="keyword">until</span> sequence <span class="number">1</span>; </span>
<span class="line">  recover database; </span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">alter database <span class="keyword">open</span> resetlogs;</span>
</pre></td></tr></table></figure>
<h3 id="恢复相关的修改隐含参数"><a href="#恢复相关的修改隐含参数" class="headerlink" title="恢复相关的修改隐含参数"></a>恢复相关的修改隐含参数</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">_allow_resetlogs_corruption=true</span>
<span class="line">_corrupted_rollback_segments=true</span>
<span class="line">_offline_rollback_segments=true</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-05 PDB迁移和克隆]]></title>
      <url>/2017/06/02/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/05_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="本地克隆创建PDB"><a href="#本地克隆创建PDB" class="headerlink" title="本地克隆创建PDB"></a>本地克隆创建PDB</h2><h3 id="创建一个新的PDB-from-SEED"><a href="#创建一个新的PDB-from-SEED" class="headerlink" title="创建一个新的PDB from SEED"></a>创建一个新的PDB from SEED</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter session set container=PDB$SEED;</span>
<span class="line"><span class="keyword">select</span> file_name from dba_data_files;</span>
<span class="line"></span>
<span class="line">FILE_NAME</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl1/pdbseed</span><span class="regexp">/system01.dbf</span>
<span class="line">/u</span>01/app/oracle/oradata/orcl1/pdbseed/sysaux01.dbf</span>
<span class="line">/u01/app/oracle/oradata/orcl1/pdbseed/undotbs01.dbf</span>
<span class="line"></span>
<span class="line">conn / as sysdba</span>
<span class="line">create pluggable database pdb2</span>
<span class="line">  admin user pdb_mgr identified by oracle</span>
<span class="line">  file_name_convert=(<span class="string">'/u01/app/oracle/oradata/orcl1/pdbseed'</span>,<span class="string">'/u01/app/oracle/oradata/orcl1/pdb2'</span>);</span>
<span class="line"></span>
<span class="line">alter pluggable database pdb2 <span class="keyword">open</span>;</span>
<span class="line">show pdbs</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line">         <span class="number">4</span> PDB2                           READ WRITE NO</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="克隆一个已有的PDB"><a href="#克隆一个已有的PDB" class="headerlink" title="克隆一个已有的PDB"></a>克隆一个已有的PDB</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line">create pluggable database pdb3 from pdb2</span>
<span class="line">  file_name_convert=(<span class="string">'/u01/app/oracle/oradata/orcl1/pdb2'</span>,<span class="string">'/u01/app/oracle/oradata/orcl1/pdb3'</span>);</span>
<span class="line"></span>
<span class="line">alter pluggable database pdb3 <span class="keyword">open</span>;</span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line">         <span class="number">4</span> PDB2                           READ WRITE NO</span>
<span class="line">         <span class="number">5</span> PDB3                           READ WRITE NO</span>
</pre></td></tr></table></figure>
<h2 id="远程克隆创建PDB"><a href="#远程克隆创建PDB" class="headerlink" title="远程克隆创建PDB"></a>远程克隆创建PDB</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">源端CDB: orcl1    源端PDB: pdb2</span>
<span class="line">目标CDB: orcl2    目标PDB: pdb2_new</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在源端</span></span>
<span class="line">alter session set container=pdb2;</span>
<span class="line">create tablespace users datafile <span class="string">'/u01/app/oracle/oradata/orcl1/pdb2/users01.dbf'</span> size <span class="number">1</span>g;</span>
<span class="line">create user lyj identified by lyj default tablespace users;</span>
<span class="line">grant <span class="keyword">connect</span>,resource to lyj;</span>
<span class="line">grant unlimited tablespace to lyj;</span>
<span class="line">conn lyj/lyj@pdb2</span>
<span class="line">create table test as <span class="keyword">select</span> * from all_objects;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在目标</span></span>
<span class="line">conn / as sysdba</span>
<span class="line">create public database <span class="keyword">link</span> orcl1_pdb2_lyj </span>
<span class="line">  <span class="keyword">connect</span> to lyj identified by lyj</span>
<span class="line">  using <span class="string">'(DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.245.231.205)(PORT = 1521))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = pdb2)</span>
<span class="line">    ))'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 如tnsnames.ora中已有配置，也可以换成以下写法</span></span>
<span class="line">create public database <span class="keyword">link</span> orcl1_pdb2_lyj </span>
<span class="line">  <span class="keyword">connect</span> to lyj identified by lyj</span>
<span class="line">  using <span class="string">'PDB2'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 验证DBLINK创建是否成功</span></span>
<span class="line"><span class="keyword">select</span> count(*) from test@orcl1_pdb2_lyj;  </span>
<span class="line"></span>
<span class="line"><span class="comment"># 注意：file_name_convert中第一个是源端的目录地址</span></span>
<span class="line">create pluggable database pdb2_new from pdb2@orcl1_pdb2_lyj</span>
<span class="line">  file_name_convert=(<span class="string">'/u01/app/oracle/oradata/orcl1/pdb2'</span>,<span class="string">'/u01/app/oracle/oradata/orcl2/pdb2_new'</span>);</span>
<span class="line"></span>
<span class="line">alter pluggable database pdb2_new <span class="keyword">open</span>;</span>
<span class="line">alter session set container=pdb2_new;</span>
<span class="line"><span class="keyword">select</span> count(*) from lyj.test;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">56325</span></span>
</pre></td></tr></table></figure>
<h2 id="远程克隆NON-CDB创建PDB"><a href="#远程克隆NON-CDB创建PDB" class="headerlink" title="远程克隆NON-CDB创建PDB"></a>远程克隆NON-CDB创建PDB</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建一个NON-CDB</span></span>
<span class="line">dbca -silent -createDatabase -templateName $ORACLE_HOME/assistants/dbca/templates/General_Purpose.dbc \</span>
<span class="line">-gdbname noncdb -sid noncdb -characterSet ZHS16GBK -sysPassword oracle -systemPassword oracle</span>
<span class="line"></span>
<span class="line">export ORACLE_SID=noncdb</span>
<span class="line">sqlplus / as sysdba</span>
<span class="line"><span class="keyword">select</span> name,cdb,con_id from v$database;</span>
<span class="line">NAME      CDB     CON_ID</span>
<span class="line">--------- --- ----------</span>
<span class="line">NONCDB    NO           <span class="number">0</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 在目标CDB中创建DB LINK</span></span>
<span class="line">export ORACLE_SID=orcl2</span>
<span class="line">sqlplus / as sysdba</span>
<span class="line"></span>
<span class="line">create public database <span class="keyword">link</span> noncdb_link <span class="keyword">connect</span> to <span class="keyword">system</span> identified by oracle </span>
<span class="line">  using <span class="string">'(DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = 10.245.231.205)(PORT = 1521))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = noncdb)</span>
<span class="line">    ))'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 验证DBLINK创建是否成功</span></span>
<span class="line"><span class="keyword">select</span> name,cdb,con_id from v$database@noncdb_link;</span>
<span class="line">NAME      CDB     CON_ID</span>
<span class="line">--------- --- ----------</span>
<span class="line">NONCDB    NO           <span class="number">0</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> file_name from dba_data_files@noncdb_link;</span>
<span class="line">FILE_NAME</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/noncdb/users</span>01.dbf</span>
<span class="line">/u01/app/oracle/oradata/noncdb/undotbs01.dbf</span>
<span class="line">/u01/app/oracle/oradata/noncdb/system01.dbf</span>
<span class="line">/u01/app/oracle/oradata/noncdb/sysaux01.dbf</span>
<span class="line"></span>
<span class="line"><span class="comment"># 克隆non-cdb</span></span>
<span class="line">create pluggable database noncdb_new from noncdb@noncdb_link</span>
<span class="line">  file_name_convert=(<span class="string">'/u01/app/oracle/oradata/noncdb'</span>,<span class="string">'/u01/app/oracle/oradata/orcl2/noncdb_new'</span>);</span>
<span class="line"></span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB2_NEW                       READ WRITE NO</span>
<span class="line">         <span class="number">4</span> NONCDB_NEW                     MOUNTED</span>
<span class="line"></span>
<span class="line"><span class="comment"># 从NON-CDB克隆完后直接OPEN报错</span></span>
<span class="line">alter pluggable database noncdb_new <span class="keyword">open</span>;</span>
<span class="line">Warning: PDB altered with errors.</span>
<span class="line"></span>
<span class="line"><span class="comment"># 执行noncdb_to_pdb脚本</span></span>
<span class="line">alter pluggable database noncdb_new <span class="keyword">close</span>;</span>
<span class="line">alter session set container=noncdb_new;</span>
<span class="line">@?/rdbms/admin/noncdb_to_pdb.sql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 这个过程较慢，执行期间可以查看alert.log，其中可以看到类似的以下信息</span></span>
<span class="line">tail -f $ORACLE_BASE/diag/rdbms/<span class="string">"$ORACLE_SID"</span>/<span class="string">"$ORACLE_SID"</span>/trace/alert<span class="number">_</span><span class="string">"$ORACLE_SID"</span>.log </span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">04</span>T13:<span class="number">52</span>:<span class="number">11.740697</span>+08:<span class="number">00</span></span>
<span class="line">NONCDB_NEW(<span class="number">4</span>):Resize operation completed <span class="keyword">for</span> file<span class="comment"># 15, old size 517120K, new size 522240K</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">04</span>T13:<span class="number">52</span>:<span class="number">15.526573</span>+08:<span class="number">00</span></span>
<span class="line">NONCDB_NEW(<span class="number">4</span>):Resize operation completed <span class="keyword">for</span> file<span class="comment"># 15, old size 522240K, new size 527360K</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">04</span>T13:<span class="number">52</span>:<span class="number">17.018421</span>+08:<span class="number">00</span></span>
<span class="line">NONCDB_NEW(<span class="number">4</span>):Resize operation completed <span class="keyword">for</span> file<span class="comment"># 15, old size 527360K, new size 532480K</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">04</span>T13:<span class="number">52</span>:<span class="number">20.209732</span>+08:<span class="number">00</span></span>
<span class="line">NONCDB_NEW(<span class="number">4</span>):Resize operation completed <span class="keyword">for</span> file<span class="comment"># 15, old size 532480K, new size 537600K</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">06</span>-<span class="number">04</span>T13:<span class="number">52</span>:<span class="number">28.960499</span>+08:<span class="number">00</span></span>
<span class="line">NONCDB_NEW(<span class="number">4</span>):Resize operation completed <span class="keyword">for</span> file<span class="comment"># 15, old size 537600K, new size 542720K</span></span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">4</span> NONCDB_NEW                     READ WRITE NO</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在克隆non-cdb创建PDB时，如果报以下错误，可能是NON-CDB数据库的SGA过大导致（超过目标端）</span></span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------------</span></span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">65169</span>: error encountered <span class="keyword">while</span> attempting to copy file</span>
<span class="line">ORA-<span class="number">12801</span>: error signaled in parallel query server</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h2 id="练习PDB的plugging和unpluged操作"><a href="#练习PDB的plugging和unpluged操作" class="headerlink" title="练习PDB的plugging和unpluged操作"></a>练习PDB的plugging和unpluged操作</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 练习一：datafile原位置插拔</span></span>
<span class="line"><span class="comment"># unplug PDB</span></span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line">         <span class="number">4</span> PDB2                           READ WRITE NO</span>
<span class="line">         <span class="number">5</span> PDB3                           READ WRITE NO</span>
<span class="line"></span>
<span class="line">alter pluggable database pdb3 <span class="keyword">close</span>;</span>
<span class="line">alter pluggable database pdb3 unplug into <span class="string">'/tmp/pdb3.xml'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除PDB(不含文件)</span></span>
<span class="line">drop pluggable database pdb3;</span>
<span class="line"></span>
<span class="line"><span class="comment"># plug PDB</span></span>
<span class="line">create pluggable database pdb3 using <span class="string">'/tmp/pdb3.xml'</span> nocopy;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 练习二：datafile位置改变</span></span>
<span class="line">export ORACLE_SID=orcl2</span>
<span class="line">sqlplus / as sysdba</span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB2_NEW                       READ WRITE NO</span>
<span class="line">         <span class="number">4</span> NONCDB_NEW                     READ WRITE NO</span>
<span class="line"></span>
<span class="line">alter pluggable database PDB2_NEW <span class="keyword">close</span>;</span>
<span class="line">alter pluggable database PDB2_NEW unplug into <span class="string">'/tmp/pdb2_new.xml'</span>;</span>
<span class="line"></span>
<span class="line">export ORACLE_SID=orcl1</span>
<span class="line">sqlplus / as sysdba</span>
<span class="line">create pluggable database pdb2_new using <span class="string">'/tmp/pdb2_new.xml'</span> copy</span>
<span class="line">  file_name_convert=(<span class="string">'/u01/app/oracle/oradata/orcl2/pdb2_new'</span>,<span class="string">'/u01/app/oracle/oradata/orcl1/pdb2_new'</span>);</span>
<span class="line"></span>
<span class="line">alter pluggable database PDB3 <span class="keyword">open</span>;</span>
<span class="line">alter pluggable database PDB2_NEW <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line">         <span class="number">4</span> PDB2                           READ WRITE NO</span>
<span class="line">         <span class="number">5</span> PDB3                           READ WRITE NO</span>
<span class="line">         <span class="number">6</span> PDB2_NEW                       READ WRITE NO</span>
<span class="line"></span>
<span class="line"><span class="comment"># nocopy选项</span></span>
<span class="line">CREATE PLUGGABLE DATABASE salespdb USING <span class="string">'/disk1/usr/salespdb.xml'</span> NOCOPY TEMPFILE REUSE;</span>
<span class="line"></span>
<span class="line"><span class="comment"># clone,nocopy选项</span></span>
<span class="line">CREATE PLUGGABLE DATABASE salespdb AS CLONE USING <span class="string">'/disk1/usr/salespdb.xml'</span> NOCOPY TEMPFILE REUSE;</span>
</pre></td></tr></table></figure>
<h3 id="多租户环境中相关的数据字典"><a href="#多租户环境中相关的数据字典" class="headerlink" title="多租户环境中相关的数据字典"></a>多租户环境中相关的数据字典</h3><ul>
<li>[G]V$SYSSTAT</li>
<li>[G]V$SYS_TIME_MODEL</li>
<li>[G]V$SYSTEM_EVENT</li>
<li>[G]V$SYSTEM_WAIT_CLASS</li>
<li>[G]V$CON_SYSSTAT</li>
<li>[G]V$CON_SYS_TIME_MODEL</li>
<li>[G]V$CON_SYSTEM_EVENT</li>
<li>[G]V$CON_SYSTEM_WAIT_CLASS</li>
</ul>
<h3 id="sqlnet-ora中的兼容设置"><a href="#sqlnet-ora中的兼容设置" class="headerlink" title="sqlnet.ora中的兼容设置"></a>sqlnet.ora中的兼容设置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 参数用来限制可以连接到数据库服务器上的最小客户端版本，</span></span>
<span class="line"><span class="comment"># 比如设置值为10，即10g，11g等以上客户端版本可以连接到数据库服务器上</span></span>
<span class="line">SQLNET.ALLOWED_LOGON_VERSION_SERVER=<span class="number">10</span></span>
<span class="line">SQLNET.ALLOWED_LOGON_VERSION_CLIENT=<span class="number">10</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># sec_case_sensitive_logon的值不能是false</span></span>
<span class="line">SQL&gt; show parameter sensitive</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">sec_case_sensitive_logon             boolean     TRUE</span>
</pre></td></tr></table></figure>
<h3 id="多租户环境中相关的视图"><a href="#多租户环境中相关的视图" class="headerlink" title="多租户环境中相关的视图"></a>多租户环境中相关的视图</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SELECT SYS_CONTEXT (<span class="string">'USERENV'</span>, <span class="string">'CON_NAME'</span>) FROM DUAL; </span>
<span class="line"><span class="keyword">select</span> CON_NAME_TO_ID(<span class="string">'CDB$ROOT'</span>) from dual;</span>
<span class="line"></span>
<span class="line">alter session set container=pd1;</span>
<span class="line">alter <span class="keyword">system</span> set max_iops=<span class="number">1000</span> container=current;</span>
</pre></td></tr></table></figure>
<h3 id="多租户环境中的PDB状态"><a href="#多租户环境中的PDB状态" class="headerlink" title="多租户环境中的PDB状态"></a>多租户环境中的PDB状态</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter pluggable database tcymob<span class="number">0</span> save <span class="keyword">state</span>;</span>
<span class="line">alter pluggable database all save <span class="keyword">state</span>;</span>
<span class="line">alter pluggable database pdbhr1 discard <span class="keyword">state</span>;</span>
<span class="line">alter pluggable database ALL EXCEPT hrpdb2, hrpdb1 save <span class="keyword">state</span>;</span>
</pre></td></tr></table></figure>
<h3 id="多租户环境下的批量数据变更"><a href="#多租户环境下的批量数据变更" class="headerlink" title="多租户环境下的批量数据变更"></a>多租户环境下的批量数据变更</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">UPDATE CONTAINERS(sales.customers) ctab </span>
<span class="line">SET ctab.city_name=<span class="string">'MIAMI'</span> </span>
<span class="line">WHERE ctab.CON_ID IN(<span class="number">7</span>,<span class="number">8</span>) AND CUSTOMER_ID=<span class="number">3425</span>;</span>
</pre></td></tr></table></figure>
<h3 id="克隆远程PDB常见错误1"><a href="#克隆远程PDB常见错误1" class="headerlink" title="克隆远程PDB常见错误1"></a>克隆远程PDB常见错误1</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ORA-<span class="number">17628</span>: Oracle error <span class="number">65035</span> returned by remote Oracle server</span>
<span class="line">ORA-<span class="number">65035</span>: unable to create pluggable database from</span>
<span class="line"></span>
<span class="line">$ oerr ora <span class="number">65035</span></span>
<span class="line"><span class="number">65035</span>, <span class="number">00000</span>, <span class="string">"unable to create pluggable database from %s"</span></span>
<span class="line">// *Cause: An attempt was made to clone a pluggable database that did <span class="keyword">not</span> have</span>
<span class="line">// <span class="keyword">local</span> undo enabled.</span>
<span class="line">// *Action: Enable <span class="keyword">local</span> undo <span class="keyword">for</span> the PDB <span class="keyword">and</span> <span class="keyword">and</span> retry the operation.</span>
<span class="line"></span>
<span class="line"><span class="comment"># 解决办法：share undo 转local undo</span></span>
<span class="line"><span class="keyword">select</span> PROPERTY_NAME,PROPERTY_VALUE from database_properties where property_name=<span class="string">'LOCAL_UNDO_ENABLED'</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">shutdown</span> immediate;</span>
<span class="line">startup upgrade;</span>
<span class="line">show con_name</span>
<span class="line">alter database <span class="keyword">local</span> undo on;</span>
<span class="line"><span class="keyword">shutdown</span> immediate;</span>
<span class="line">startup;</span>
<span class="line">show pdbs</span>
<span class="line">alter session set container=tcymob1;</span>
<span class="line"><span class="keyword">select</span> name from v$datafile where name like ‘%undo%‘;</span>
</pre></td></tr></table></figure>
<h3 id="克隆远程PDB常见错误2"><a href="#克隆远程PDB常见错误2" class="headerlink" title="克隆远程PDB常见错误2"></a>克隆远程PDB常见错误2</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">17627</span>: ORA-<span class="number">01033</span>: ORACLE initialization <span class="keyword">or</span> <span class="keyword">shutdown</span> in progress</span>
<span class="line">ORA-<span class="number">17629</span>: Cannot <span class="keyword">connect</span> to the remote database server</span>
</pre></td></tr></table></figure>
<h3 id="克隆远程PDB常见错误3"><a href="#克隆远程PDB常见错误3" class="headerlink" title="克隆远程PDB常见错误3"></a>克隆远程PDB常见错误3</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">65005</span>: missing <span class="keyword">or</span> invalid file name pattern <span class="keyword">for</span> file -</span>
<span class="line"><span class="regexp">/U01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/new12c/</span>NEW12C/tcymob1/system01.dbf</span>
</pre></td></tr></table></figure>
<h3 id="克隆远程PDB常见错误4"><a href="#克隆远程PDB常见错误4" class="headerlink" title="克隆远程PDB常见错误4"></a>克隆远程PDB常见错误4</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ORA-<span class="number">19504</span>: failed to create file <span class="string">"/U01/app/oracle/oradata/test12cs/tcymob1"</span></span>
<span class="line">ORA-<span class="number">27038</span>: created file already <span class="keyword">exists</span></span>
<span class="line">Additional information: <span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 文件映射路径问题，文件夹—文件夹 文件—文件</span></span>
<span class="line">CREATE PLUGGABLE DATABASE tcymob1_test12cs FROM tcymob1@tcymob1_new12c</span>
<span class="line">file_name_convert=(<span class="string">'/U01/app/oracle/oradata/new12c/NEW12C/tcymob0/NEW12C/4FB0C84834AE542DE0537D857F0AE8F5/datafile/o1_mf_undo_1_dloqnnn9_.dbf'</span>,<span class="string">'/U01/app/oracle/oradata/test12cs/tcymob1/undotbs1.dbf'</span>,<span class="string">'/U01/app/oracle/oradata/new12c/NEW12C/tcymob1'</span>,<span class="string">'/U01/app/oracle/oradata/test12cs/tcymob1'</span>) ;</span>
</pre></td></tr></table></figure>
<h3 id="Plugging-in-non-cdb"><a href="#Plugging-in-non-cdb" class="headerlink" title="Plugging in non-cdb"></a>Plugging in non-cdb</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SET SERVEROUTPUT ON</span>
<span class="line">DECLARE compatible CONSTANT VARCHAR2(<span class="number">3</span>) := CASE</span>
<span class="line">DBMS_PDB.CHECK_PLUG_COMPATIBILITY( <span class="string">pdb_descr_file =&gt;</span> <span class="string">'/tmp/ncdb12c_actvdb.xml'</span>, <span class="string">pdb_name =&gt;</span> <span class="string">'NCDB12C'</span>)</span>
<span class="line">WHEN TRUE THEN <span class="string">'YES'</span> ELSE <span class="string">'NO'</span></span>
<span class="line">END;</span>
<span class="line">BEGIN</span>
<span class="line">DBMS_OUTPUT.PUT_LINE(compatible);</span>
<span class="line">END;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">select name,cause,type,message,status from PDB_PLUG_IN_VIOLATIONS where name='NCDB12C';</span></span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在DELL R730物理机上安装配置Oracle Linux 7.3图解]]></title>
      <url>/2017/05/24/linux/20170524_%E5%9C%A8DELL_R730%E7%89%A9%E7%90%86%E6%9C%BA%E4%B8%8A%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEOracle_Linux_7.3/</url>
      <content type="html"><![CDATA[<p>Oracle Linux 7.3（Oracle Linux 7 Update 3）在2016.11.10发布。Oracle Linux全称为Oracle Enterprise Linux，是由Oracle公司提供支持的企业级Linux发行。这是第一个包含UEK版本 4（UEK R4）的 Oracle Linux 7 ISO，新安装的 Oracle Linux 7 Update 3 将默认安装和引导 UEK R4 内核。<br><strong>显著更新：</strong><br>UEFI 安全引导支持 - 此更新允许您在已启用 UEFI 安全引导的系统上安装和使用 Oracle Linux 7，这在 Oracle Linux 7 Update 3 上完全支持。<br><a id="more"></a></p>
<h2 id="系统安装"><a href="#系统安装" class="headerlink" title="系统安装"></a>系统安装</h2><p>Oracle Linux 7.X较6.X版本变动较大，图形化安装也有较大变化，默认使用英文<br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_01.png" alt=""><br>所有配置项都集中放在一起，根据需求，依次配置相关设置<br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_10.png" alt=""><br>操作系统安装位置/磁盘配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_02.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_03.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_04.png" alt=""><br>如果不想设置efi分区，需要在服务器BIOS里关闭UEFI功能<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_10.png" alt=""></p>
<p>网络/主机名配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_06.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_07.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_08.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_09.png" alt=""><br>在配置项集中页，点开始安装<br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_11.png" alt=""><br>设置root密码<br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_12.png" alt=""><br>安装完后重启<br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_13.png" alt=""><br>安装成功，登陆<br><img src="http://oligvdnzp.bkt.clouddn.com/0524_DellR730_Oracle_7_3_install_14.png" alt=""></p>
]]></content>
      
        
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-04 CDB PDB对象管理]]></title>
      <url>/2017/05/24/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/04_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="在多PDB环境中，创建common-user，并赋予权限"><a href="#在多PDB环境中，创建common-user，并赋予权限" class="headerlink" title="在多PDB环境中，创建common user，并赋予权限"></a>在多PDB环境中，创建common user，并赋予权限</h2><p>查看状态<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> pdbs;</span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line"><span class="comment">---------- ------------------------------ ---------- ----------</span></span>
<span class="line">         2 PDB$SEED                       READ ONLY  NO</span>
<span class="line">         3 PDB1                           READ WRITE NO</span>
<span class="line">         4 PDB2                           READ WRITE NO</span>
<span class="line"></span>
<span class="line"><span class="keyword">show</span> con_name</span>
<span class="line">CON_NAME</span>
<span class="line"><span class="comment">------------------------------</span></span>
<span class="line">CDB$ROOT</span>
</pre></td></tr></table></figure></p>
<a id="more"></a>
<p>创建common user<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 创建时报错</span></span>
<span class="line"><span class="keyword">create</span> <span class="keyword">user</span> c##cdbadmin <span class="keyword">identified</span> <span class="keyword">by</span> <span class="keyword">oracle</span> <span class="keyword">default</span> <span class="keyword">tablespace</span> <span class="keyword">users</span> <span class="keyword">temporary</span> <span class="keyword">tablespace</span> temp;</span>
<span class="line"><span class="keyword">create</span> <span class="keyword">user</span> c##cdbadmin <span class="keyword">identified</span> <span class="keyword">by</span> <span class="keyword">oracle</span> <span class="keyword">default</span> <span class="keyword">tablespace</span> <span class="keyword">users</span> <span class="keyword">temporary</span> <span class="keyword">tablespace</span> temp</span>
<span class="line">*</span>
<span class="line"><span class="keyword">ERROR</span> <span class="keyword">at</span> line <span class="number">1</span>:</span>
<span class="line">ORA<span class="number">-65048</span>: <span class="keyword">error</span> encountered <span class="keyword">when</span> processing the <span class="keyword">current</span> <span class="keyword">DDL</span> <span class="keyword">statement</span> <span class="keyword">in</span> <span class="keyword">pluggable</span> <span class="keyword">database</span> PDB1</span>
<span class="line">ORA<span class="number">-00959</span>: <span class="keyword">tablespace</span> <span class="string">'USERS'</span> does <span class="keyword">not</span> exist</span>
<span class="line"></span>
<span class="line"><span class="comment">-- 上面报错的原因是指定了CDB用户默认的表空间时，要求所有的PDB用户存在该表空间</span></span>
<span class="line"><span class="comment">-- 给pdb1和pdb2添加users表空间</span></span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> <span class="keyword">container</span>=pdb1;</span>
<span class="line"></span>
<span class="line">col FILE_NAME for a50</span>
<span class="line"><span class="keyword">select</span> file_name <span class="keyword">from</span> dba_data_files;</span>
<span class="line">FILE_NAME</span>
<span class="line"><span class="comment">--------------------------------------------------</span></span>
<span class="line">/u01/app/oracle/oradata/orcl2/pdb1/system01.dbf</span>
<span class="line">/u01/app/oracle/oradata/orcl2/pdb1/sysaux01.dbf</span>
<span class="line">/u01/app/oracle/oradata/orcl2/pdb1/undotbs01.dbf</span>
<span class="line"></span>
<span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> <span class="keyword">users</span> <span class="keyword">datafile</span> <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/users01.dbf'</span> <span class="keyword">size</span> <span class="number">1</span>G;</span>
<span class="line"></span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">session</span> <span class="keyword">set</span> <span class="keyword">container</span>=pdb2;</span>
<span class="line"><span class="keyword">select</span> file_name <span class="keyword">from</span> dba_data_files;</span>
<span class="line">FILE_NAME</span>
<span class="line"><span class="comment">--------------------------------------------------</span></span>
<span class="line">/u01/app/oracle/oradata/orcl2/pdb2/system01.dbf</span>
<span class="line">/u01/app/oracle/oradata/orcl2/pdb2/sysaux01.dbf</span>
<span class="line">/u01/app/oracle/oradata/orcl2/pdb2/undotbs01.dbf</span>
<span class="line"></span>
<span class="line"><span class="keyword">create</span> <span class="keyword">tablespace</span> <span class="keyword">users</span> <span class="keyword">datafile</span> <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/users01.dbf'</span> <span class="keyword">size</span> <span class="number">1</span>G;</span>
<span class="line"></span>
<span class="line"><span class="comment">--重新执行创建成功</span></span>
<span class="line">conn / as sysdba</span>
<span class="line"><span class="keyword">create</span> <span class="keyword">user</span> c##cdbadmin <span class="keyword">identified</span> <span class="keyword">by</span> <span class="keyword">oracle</span> <span class="keyword">default</span> <span class="keyword">tablespace</span> <span class="keyword">users</span> <span class="keyword">temporary</span> <span class="keyword">tablespace</span> temp;</span>
<span class="line"></span>
<span class="line"><span class="comment">-- 授权</span></span>
<span class="line"><span class="keyword">grant</span> <span class="keyword">connect</span>,<span class="keyword">resource</span> <span class="keyword">to</span> c##cdbadmin;</span>
<span class="line"><span class="keyword">grant</span> <span class="keyword">connect</span>,<span class="keyword">resource</span> <span class="keyword">to</span> c##cdbadmin <span class="keyword">container</span>=all;</span>
</pre></td></tr></table></figure></p>
<p>用新创建的common user测试登陆<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登陆CDB</span></span>
<span class="line">sqlplus c<span class="comment">##cdbadmin/oracle@orcl2</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆PDB</span></span>
<span class="line">sqlplus c<span class="comment">##cdbadmin/oracle@pdb1</span></span>
</pre></td></tr></table></figure></p>
<h2 id="模拟测试12-2中的move-tablespace-online，简单总结"><a href="#模拟测试12-2中的move-tablespace-online，简单总结" class="headerlink" title="模拟测试12.2中的move tablespace online，简单总结"></a>模拟测试12.2中的move tablespace online，简单总结</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 连接到PDB1中，创建测试数据</span></span>
<span class="line">conn lyj/lyj@pdb1</span>
<span class="line">create table test_mv tablespace users as <span class="keyword">select</span> * from all_objects;</span>
<span class="line">insert into test_mv <span class="keyword">select</span> * from test_mv;  <span class="comment">#多执行几次</span></span>
<span class="line">commit;</span>
<span class="line">set timing on</span>
<span class="line"><span class="keyword">select</span> count(*) from test_mv;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">   <span class="number">2180000</span></span>
<span class="line"></span>
<span class="line">Elapsed: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>.<span class="number">16</span></span>
<span class="line"></span>
<span class="line">create <span class="keyword">index</span> ind_test_mv_objid on test_mv(object_id) tablespace users;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看segment所占空间</span></span>
<span class="line"><span class="keyword">select</span> SEGMENT_NAME,TABLESPACE_NAME,BYTES/<span class="number">1024</span>/<span class="number">1024</span> SIZE_M from user_segments;</span>
<span class="line"></span>
<span class="line">SEGMENT_NAME                   TABLESPACE_NAME                    SIZE_M</span>
<span class="line">------------------------------ ------------------------------ ----------</span>
<span class="line">IND_TEST_MV_OBJID              USERS                                  <span class="number">39</span></span>
<span class="line">TEST_MV                        USERS                                 <span class="number">336</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> OBJECT_NAME,STATUS from user_objects;</span>
<span class="line"></span>
<span class="line">OBJECT_NAME                                        STATUS</span>
<span class="line">-------------------------------------------------- -------</span>
<span class="line">IND_TEST_MV_OBJID                                  VALID</span>
<span class="line">TEST_MV                                            VALID</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除数据后查看segment所占空间，没有任何变动，查询的时间也没有变短</span></span>
<span class="line"><span class="keyword">delete</span> from test_mv where object_id&lt;&gt;<span class="number">2</span>;</span>
<span class="line"><span class="number">2179968</span> rows deleted</span>
<span class="line">Elapsed: <span class="number">00</span>:<span class="number">00</span>:<span class="number">37.29</span></span>
<span class="line"></span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> SEGMENT_NAME,TABLESPACE_NAME,BYTES/<span class="number">1024</span>/<span class="number">1024</span> SIZE_M from user_segments;</span>
<span class="line"></span>
<span class="line">SEGMENT_NAME                   TABLESPACE_NAME                    SIZE_M</span>
<span class="line">------------------------------ ------------------------------ ----------</span>
<span class="line">IND_TEST_MV_OBJID              USERS                                  <span class="number">39</span></span>
<span class="line">TEST_MV                        USERS                                 <span class="number">336</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> count(*) from test_mv;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">        <span class="number">32</span></span>
<span class="line"></span>
<span class="line">Elapsed: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>.<span class="number">26</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 执行move table online后，segment所占空间空小，表查询速度变快</span></span>
<span class="line">alter table test_mv move tablespace users online;</span>
<span class="line"><span class="comment"># 或</span></span>
<span class="line">alter table test_mv move online;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> SEGMENT_NAME,TABLESPACE_NAME,BYTES/<span class="number">1024</span>/<span class="number">1024</span> SIZE_M from user_segments;</span>
<span class="line"></span>
<span class="line">SEGMENT_NAME                   TABLESPACE_NAME                    SIZE_M</span>
<span class="line">------------------------------ ------------------------------ ----------</span>
<span class="line">IND_TEST_MV_OBJID              USERS                               .<span class="number">0625</span></span>
<span class="line">TEST_MV                        USERS                               .<span class="number">0625</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> count(*) from test_mv;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">        <span class="number">32</span></span>
<span class="line"></span>
<span class="line">Elapsed: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>.<span class="number">00</span></span>
</pre></td></tr></table></figure>
<p>总结：12.2执行在线表移动后，不用像在11g时还需要rebuild index</p>
<h2 id="创建一个序列test-seq-把它的nextval值修改为2017"><a href="#创建一个序列test-seq-把它的nextval值修改为2017" class="headerlink" title="创建一个序列test_seq,把它的nextval值修改为2017"></a>创建一个序列test_seq,把它的nextval值修改为2017</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建序列 起始编号是1，增量为1，最大值10000000</span></span>
<span class="line">create sequence test_seq start with <span class="number">1</span> increment by <span class="number">1</span> maxvalue <span class="number">10000000</span>;</span>
<span class="line"><span class="keyword">select</span> test_seq.nextval from dual;</span>
<span class="line"></span>
<span class="line">   NEXTVAL</span>
<span class="line">----------</span>
<span class="line">         <span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> <span class="number">2017</span> - test_seq.nextval - <span class="number">1</span> seq_id from dual;</span>
<span class="line">    SEQ_ID</span>
<span class="line">----------</span>
<span class="line">      <span class="number">2014</span></span>
<span class="line"></span>
<span class="line">alter sequence test_seq increment by <span class="number">2014</span>;</span>
<span class="line"></span>
<span class="line">SELECT test_seq.nextval FROM dual;</span>
<span class="line"></span>
<span class="line">   NEXTVAL</span>
<span class="line">----------</span>
<span class="line">      <span class="number">2016</span></span>
<span class="line"></span>
<span class="line">SELECT test_seq.currval FROM dual;</span>
<span class="line"></span>
<span class="line">   CURRVAL</span>
<span class="line">----------</span>
<span class="line">      <span class="number">2016</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 以下SQL脚本可以实现自动重置序列</span></span>
<span class="line">vi reset_sequence.sql</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------</span></span>
<span class="line">UNDEFINE seq_name</span>
<span class="line">UNDEFINE reset_to</span>
<span class="line">PROMPT <span class="string">"sequence name"</span> ACCEPT <span class="string">'&amp;&amp;seq_name'</span></span>
<span class="line">PROMPT <span class="string">"reset to value"</span> ACCEPT &amp;&amp;reset_to</span>
<span class="line">COL seq_id NEW_VALUE hold_seq_id</span>
<span class="line">COL min_id NEW_VALUE hold_min_id</span>
<span class="line">--</span>
<span class="line">SELECT &amp;&amp;reset_to - &amp;&amp;seq_name..nextval - <span class="number">1</span> seq_id</span>
<span class="line">FROM dual;</span>
<span class="line">--</span>
<span class="line">SELECT &amp;&amp;hold_seq_id - <span class="number">1</span> min_id FROM dual;</span>
<span class="line">--</span>
<span class="line">ALTER SEQUENCE &amp;&amp;seq_name INCREMENT BY &amp;hold_seq_id MINVALUE &amp;hold_min_id;</span>
<span class="line">--</span>
<span class="line">SELECT &amp;&amp;seq_name..nextval FROM dual;</span>
<span class="line">--</span>
<span class="line">ALTER SEQUENCE &amp;&amp;seq_name INCREMENT BY <span class="number">1</span>;</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h2 id="新知识总结"><a href="#新知识总结" class="headerlink" title="新知识总结"></a>新知识总结</h2><h3 id="数据字典"><a href="#数据字典" class="headerlink" title="数据字典"></a>数据字典</h3><ul>
<li>CDB_   All of the objects in the CDB across all PDBs</li>
<li>DBA_   All of the objects in a container or PDB</li>
<li>ALL_   Objects accessible by the current user</li>
<li>USER_  Objects owned by the current user</li>
</ul>
<h3 id="Application-Container中的表"><a href="#Application-Container中的表" class="headerlink" title="Application Container中的表"></a>Application Container中的表</h3><ul>
<li>sharing=data</li>
<li>sharing=metadata</li>
<li>sharing=extended data</li>
</ul>
]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用Dell iDRAC服务器远程控制安装操作系统简要图解]]></title>
      <url>/2017/05/23/tools/Dell%20iDRAC%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%9B%BE%E8%A7%A3/</url>
      <content type="html"><![CDATA[<p>iDRAC又称为Integrated Dell Remote Access Controller，也就是集成戴尔远程控制卡，这是戴尔服务器的独有功能，iDRAC卡相当于是附加在服务器上的一计算机，可以实现一对一的服务器远程管理与监控，通过与服务器主板上的管理芯片BMC进行通信，监控与管理服务器的硬件状态信息。它拥有自己的系统和IP地址，与服务器上的OS无关。是管理员进行远程访问和管理的利器，戴尔服务器集成了iDRAC控制卡，我们就可以扔掉价格昂贵的KVM设备了。<br><a id="more"></a><br>iDRAC的网口在服务器的背面，一般都标注iDRAC的字样(下面以DELL R730为例)<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_r730_01.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_r730_02.png" alt=""></p>
<p>一般情况下，iDRAC功能默认都是关闭，需要在BIOS里面启用，首先我们先重启计算机，按F2然后进入BIOS。<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_02.png" alt=""><br>选择iDRAC Setting<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_03.png" alt=""><br>进入iDRAC Setting之后，可以看到很多详细的设置，一般情况下只要设置网络Network就可以了<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_04.png" alt=""><br>首先需要先启用iDRAC功能，在Enable NC选项中选择Enable，NC Selection选项中选择Dedicated，而Auto Negotiation中选择iDRAC网络接口的速率和全双工和半双工模式，一般情况下选择on，也就是自动设置<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_05.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_06.png" alt=""><br>然后就该是iDRAC的网络参数设置了，选择IPV4 SETTINGS(当IPV6普及的时候我们就可以使用IPV6的地址了)。IP地址设置方式有DHCP和静态地址两种，为了方便维护和管理，建议选择静态固定IP的方式。把Enable DHCP给Disable掉，就可以设置IP地址了。如果是局域网控制的话就填写局域网的IP地址，如果是远程控制的话则需要输入已有的IP地址，并且还要设置默认网关和DNS地址，这样不仅可以实现远程控制，并且一旦出现问题(例如冗余电源罢工或者服务器被入侵)，iDRAC就会发送消息到预先设定的电子邮箱里面。<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_07.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_08.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_09.png" alt=""><br>设置好iDRAC的网络参数后，我们就可以使用iDRAC来远程控制和维护远程的服务器了。在浏览器中输入上面设置好的IP地址，随后就出现了iDRAC的登录界面，默认的用户名是<code>root</code>和密码是<code>calvin</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_13.png" alt=""><br>登陆后界面，在主界面上，我们就可以看到各个硬件组件的状态。在快速启动任务栏中，可以对系统电源进行操作，如开机、关机等。安装操作系统，在虚拟控制台预览处点击<code>&gt;启动</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_14.png" alt=""><br>按照浏览器出现的提示确定安装控件等，最后点<code>运行</code>即可打开虚拟控制台<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_15.png" alt=""><br>点虚拟介质-&gt;连接虚拟介质-&gt;映射CD/DVD<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_16.png" alt=""><br>选择系统安装光盘映射设备<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_17.png" alt=""><br>下次引导-&gt;虚拟CD/DVD/ISO，确定变更<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_18.png" alt=""><br>电源-&gt;打开系统电源-&gt;确定<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_19.png" alt=""><br>可以开始在虚拟控制台中安装OS了<br><img src="http://oligvdnzp.bkt.clouddn.com/0523_dell_idrac_20.png" alt=""></p>
<p>好了，等待光盘加载完后就开始远程安装服务器操作系统吧 ^_^</p>
]]></content>
      
        
        <tags>
            
            <tag> iDARC </tag>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-03 创建与管理CDB和PDB]]></title>
      <url>/2017/05/17/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/03_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="手工创建cdb数据库-create-database语句"><a href="#手工创建cdb数据库-create-database语句" class="headerlink" title="手工创建cdb数据库(create database语句)"></a>手工创建cdb数据库(create database语句)</h2><h3 id="创建前的准备工作"><a href="#创建前的准备工作" class="headerlink" title="创建前的准备工作"></a>创建前的准备工作</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建密码文件</span></span>
<span class="line">orapwd file=$ORACLE_HOME/dbs/orapworcl1 password=oracle force=<span class="keyword">y</span> <span class="keyword">format</span>=<span class="number">12</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建参数文件</span></span>
<span class="line">vi spfileorcl1.ora</span>
<span class="line"><span class="comment">#---------------------------------------------------</span></span>
<span class="line">db_name=orcl1</span>
<span class="line">sga_target=<span class="number">2048</span>M</span>
<span class="line">db_create_file_dest=<span class="string">'/u01/app/oracle/oradata/orcl1'</span></span>
<span class="line">enable_pluggable_database=true</span>
<span class="line"><span class="comment">#---------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建所需目录</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/oradata/orcl1</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="手工创建数据库"><a href="#手工创建数据库" class="headerlink" title="手工创建数据库"></a>手工创建数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># OMF方式创建数据库</span></span>
<span class="line">export ORACLE_SID=orcl1</span>
<span class="line">sqlplus / as sysdba</span>
<span class="line">startup nomount</span>
<span class="line">CREATE DATABASE orcl1</span>
<span class="line">    USER SYS IDENTIFIED BY oracle</span>
<span class="line">    USER SYSTEM IDENTIFIED BY oracle</span>
<span class="line">    EXTENT MANAGEMENT LOCAL</span>
<span class="line">    DEFAULT TABLESPACE users</span>
<span class="line">    DEFAULT TEMPORARY TABLESPACE temp</span>
<span class="line">    UNDO TABLESPACE undotbs1</span>
<span class="line">    ENABLE PLUGGABLE DATABASE</span>
<span class="line">    SEED</span>
<span class="line">        SYSTEM DATAFILES SIZE <span class="number">125</span>M AUTOEXTEND ON NEXT <span class="number">10</span>M MAXSIZE UNLIMITED</span>
<span class="line">        SYSAUX DATAFILES SIZE <span class="number">100</span>M;</span>
<span class="line"></span>
<span class="line">show con_name</span>
<span class="line"></span>
<span class="line">CON_NAME</span>
<span class="line">------------------------------</span>
<span class="line">CDB$ROOT</span>
<span class="line"></span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line"></span>
<span class="line"><span class="comment"># 非OMF方式创建数据库</span></span>
<span class="line">CREATE DATABASE newcdb</span>
<span class="line">  USER SYS IDENTIFIED BY sys_password</span>
<span class="line">  USER SYSTEM IDENTIFIED BY system_password</span>
<span class="line">  LOGFILE GROUP <span class="number">1</span> (<span class="string">'/u01/logs/my/redo01a.log'</span>,<span class="string">'/u02/logs/my/redo01b.log'</span>)</span>
<span class="line">             SIZE <span class="number">100</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">          GROUP <span class="number">2</span> (<span class="string">'/u01/logs/my/redo02a.log'</span>,<span class="string">'/u02/logs/my/redo02b.log'</span>)</span>
<span class="line">             SIZE <span class="number">100</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">          GROUP <span class="number">3</span> (<span class="string">'/u01/logs/my/redo03a.log'</span>,<span class="string">'/u02/logs/my/redo03b.log'</span>)</span>
<span class="line">             SIZE <span class="number">100</span>M BLOCKSIZE <span class="number">512</span></span>
<span class="line">  MAXLOGHISTORY <span class="number">1</span></span>
<span class="line">  MAXLOGFILES <span class="number">16</span></span>
<span class="line">  MAXLOGMEMBERS <span class="number">3</span></span>
<span class="line">  MAXDATAFILES <span class="number">1024</span></span>
<span class="line">  CHARACTER SET AL32UTF8</span>
<span class="line">  NATIONAL CHARACTER SET AL16UTF16</span>
<span class="line">  EXTENT MANAGEMENT LOCAL</span>
<span class="line">  DATAFILE <span class="string">'/u01/app/oracle/oradata/newcdb/system01.dbf'</span></span>
<span class="line">    SIZE <span class="number">700</span>M REUSE AUTOEXTEND ON NEXT <span class="number">10240</span>K MAXSIZE UNLIMITED</span>
<span class="line">  SYSAUX DATAFILE <span class="string">'/u01/app/oracle/oradata/newcdb/sysaux01.dbf'</span></span>
<span class="line">    SIZE <span class="number">550</span>M REUSE AUTOEXTEND ON NEXT <span class="number">10240</span>K MAXSIZE UNLIMITED</span>
<span class="line">  DEFAULT TABLESPACE deftbs</span>
<span class="line">    DATAFILE <span class="string">'/u01/app/oracle/oradata/newcdb/deftbs01.dbf'</span></span>
<span class="line">    SIZE <span class="number">500</span>M REUSE AUTOEXTEND ON MAXSIZE UNLIMITED</span>
<span class="line">  DEFAULT TEMPORARY TABLESPACE tempts1</span>
<span class="line">    TEMPFILE <span class="string">'/u01/app/oracle/oradata/newcdb/temp01.dbf'</span></span>
<span class="line">    SIZE <span class="number">20</span>M REUSE AUTOEXTEND ON NEXT <span class="number">640</span>K MAXSIZE UNLIMITED</span>
<span class="line">  UNDO TABLESPACE undotbs1</span>
<span class="line">    DATAFILE <span class="string">'/u01/app/oracle/oradata/newcdb/undotbs01.dbf'</span></span>
<span class="line">    SIZE <span class="number">200</span>M REUSE AUTOEXTEND ON NEXT <span class="number">5120</span>K MAXSIZE UNLIMITED</span>
<span class="line">  ENABLE PLUGGABLE DATABASE</span>
<span class="line">    SEED</span>
<span class="line">    FILE_NAME_CONVERT = (<span class="string">'/u01/app/oracle/oradata/newcdb/'</span>,</span>
<span class="line">                         <span class="string">'/u01/app/oracle/oradata/pdbseed/'</span>)</span>
<span class="line">    SYSTEM DATAFILES SIZE <span class="number">125</span>M AUTOEXTEND ON NEXT <span class="number">10</span>M MAXSIZE UNLIMITED</span>
<span class="line">    SYSAUX DATAFILES SIZE <span class="number">100</span>M</span>
<span class="line">  USER_DATA TABLESPACE usertbs</span>
<span class="line">    DATAFILE <span class="string">'/u01/app/oracle/oradata/pdbseed/usertbs01.dbf'</span></span>
<span class="line">    SIZE <span class="number">200</span>M REUSE AUTOEXTEND ON MAXSIZE UNLIMITED;</span>
</pre></td></tr></table></figure>
<h3 id="创建后的补充工作"><a href="#创建后的补充工作" class="headerlink" title="创建后的补充工作"></a>创建后的补充工作</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat $ORACLE_HOME/rdbms/admin/catcdb.sql</span>
<span class="line">vi /etc/oratab</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">orcl1:<span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1:Y</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">export ORACLE_SID=orcl1</span>
<span class="line">export PERL5LIB=$ORACLE_HOME/rdbms/admin:$PERL5LIB</span>
<span class="line">export PATH=$ORACLE_HOME/bin:$ORACLE_HOME/perl/bin:$PATH</span>
<span class="line">cd $ORACLE_HOME/perl/lib/<span class="number">5.22</span>.<span class="number">0</span>/x86_64-linux-thread-multi/Hash</span>
<span class="line"><span class="comment"># 建软链接，否则会出现找不到文件提示</span></span>
<span class="line">ln -<span class="keyword">s</span> Util.pm util.pm</span>
<span class="line">sqlplus / as sysdba</span>
<span class="line">@?/rdbms/admin/catcdb.sql</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">......</span>
<span class="line">SQL&gt; host perl -I &amp;&amp;rdbms_admin &amp;&amp;rdbms_admin_catcdb --logDirectory &amp;&amp;<span class="number">1</span> --logFilename &amp;&amp;<span class="number">2</span></span>
<span class="line">Enter value <span class="keyword">for</span> <span class="number">1</span>: <span class="regexp">/home/oracle</span>           <span class="comment"># 输入日志目录</span></span>
<span class="line">Enter value <span class="keyword">for</span> <span class="number">2</span>: <span class="regexp">/home/oracle</span><span class="regexp">/a.log     # 输入日志文件名字</span>
<span class="line">Enter new password for SYS: oracle</span>
<span class="line">Enter new password for SYSTEM: oracle</span>
<span class="line">Enter temporary tablespace name: temp</span>
<span class="line">No options to container mapping specified, no options will be installed in any containers</span>
<span class="line">catcon: ALL catcon-related output will be written to [/home</span><span class="regexp">/oracle/catalog</span>_catcon_339.lst]</span>
<span class="line">catcon: See [<span class="regexp">/home/oracle</span><span class="regexp">/catalog*.log] files for output generated by scripts</span>
<span class="line">catcon: See [/home</span><span class="regexp">/oracle/catalog</span><span class="number">_</span>*.lst] files <span class="keyword">for</span> spool files, <span class="keyword">if</span> any</span>
<span class="line">...</span>
<span class="line">catcon: ALL catcon-related output will be written to [<span class="regexp">/home/oracle</span><span class="regexp">/utlrp_catcon_2672.lst]</span>
<span class="line">catcon: See [/home</span><span class="regexp">/oracle/utlrp</span>*.log] files <span class="keyword">for</span> output generated by scripts</span>
<span class="line">catcon: See [<span class="regexp">/home/oracle</span><span class="regexp">/utlrp_*.lst] files for spool files, if any</span>
<span class="line">catcon.pl: completed successfully</span>
<span class="line">#-----------------------------------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">create spfile from pfile;</span></span>
</pre></td></tr></table></figure>
<h2 id="DBCA创建CDB"><a href="#DBCA创建CDB" class="headerlink" title="DBCA创建CDB"></a>DBCA创建CDB</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">dbca -silent -createDatabase -templateName $ORACLE_HOME/assistants/dbca/templates/General_Purpose.dbc \</span>
<span class="line">-gdbname orcl2 -sid orcl2 -characterSet ZHS16GBK -sysPassword oracle -systemPassword oracle \</span>
<span class="line">-createAsContainerDatabase true</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">[WARNING] [DBT-<span class="number">0620</span>8] The <span class="string">'SYS'</span> password entered does <span class="keyword">not</span> conform to the Oracle recommended standards.</span>
<span class="line">   CAUSE: </span>
<span class="line">a. Oracle recommends that the password entered should be at least <span class="number">8</span> characters in <span class="keyword">length</span>, contain at least <span class="number">1</span> uppercase character, <span class="number">1</span> lower case character <span class="keyword">and</span> <span class="number">1</span> digit [<span class="number">0</span>-<span class="number">9</span>].</span>
<span class="line">b.The password entered is a keyword that Oracle does <span class="keyword">not</span> recommend to be used as password</span>
<span class="line">   ACTION: Specify a strong password. If required refer Oracle documentation <span class="keyword">for</span> guidelines.</span>
<span class="line">[WARNING] [DBT-<span class="number">0620</span>8] The <span class="string">'SYSTEM'</span> password entered does <span class="keyword">not</span> conform to the Oracle recommended standards.</span>
<span class="line">   CAUSE: </span>
<span class="line">a. Oracle recommends that the password entered should be at least <span class="number">8</span> characters in <span class="keyword">length</span>, contain at least <span class="number">1</span> uppercase character, <span class="number">1</span> lower case character <span class="keyword">and</span> <span class="number">1</span> digit [<span class="number">0</span>-<span class="number">9</span>].</span>
<span class="line">b.The password entered is a keyword that Oracle does <span class="keyword">not</span> recommend to be used as password</span>
<span class="line">   ACTION: Specify a strong password. If required refer Oracle documentation <span class="keyword">for</span> guidelines.</span>
<span class="line">Copying database files</span>
<span class="line"><span class="number">1</span>% complete</span>
<span class="line"><span class="number">2</span>% complete</span>
<span class="line"><span class="number">18</span>% complete</span>
<span class="line"><span class="number">33</span>% complete</span>
<span class="line">Creating <span class="keyword">and</span> starting Oracle instance</span>
<span class="line"><span class="number">35</span>% complete</span>
<span class="line"><span class="number">40</span>% complete</span>
<span class="line"><span class="number">41</span>% complete</span>
<span class="line"><span class="number">42</span>% complete</span>
<span class="line"><span class="number">46</span>% complete</span>
<span class="line"><span class="number">51</span>% complete</span>
<span class="line"><span class="number">52</span>% complete</span>
<span class="line"><span class="number">53</span>% complete</span>
<span class="line"><span class="number">55</span>% complete</span>
<span class="line">Completing Database Creation</span>
<span class="line"><span class="number">56</span>% complete</span>
<span class="line"><span class="number">58</span>% complete</span>
<span class="line"><span class="number">59</span>% complete</span>
<span class="line"><span class="number">62</span>% complete</span>
<span class="line"><span class="number">65</span>% complete</span>
<span class="line"><span class="number">66</span>% complete</span>
<span class="line">Executing Post Configuration Actions</span>
<span class="line"><span class="number">100</span>% complete</span>
<span class="line">Look at the <span class="keyword">log</span> file <span class="string">"/u01/app/oracle/cfgtoollogs/dbca/orcl2/orcl2.log"</span> <span class="keyword">for</span> further details</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h2 id="创建3个PDB，用多种方法实现"><a href="#创建3个PDB，用多种方法实现" class="headerlink" title="创建3个PDB，用多种方法实现"></a>创建3个PDB，用多种方法实现</h2><h3 id="通过种子容器创建pdb"><a href="#通过种子容器创建pdb" class="headerlink" title="通过种子容器创建pdb"></a>通过种子容器创建pdb</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">export ORACLE_SID=orcl2</span>
<span class="line">sqlplus / as sysdba</span>
<span class="line"><span class="comment"># 需要指定文件存放位置，可通过如下两种方式</span></span>
<span class="line">create pluggable database pdb1 admin user pdb1 identified by oracle</span>
<span class="line"> file_name_convert=(<span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed'</span>,<span class="string">'/u01/app/oracle/oradata/orcl2/pdb1'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 或者修改pdb_file_name_convert参数</span></span>
<span class="line">alter session set pdb_file_name_convert=<span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed'</span>,<span class="string">'/u01/app/oracle/oradata/orcl2/pdb2'</span>;</span>
<span class="line">create pluggable database pdb2 admin user pdb2 identified by oracle;</span>
</pre></td></tr></table></figure>
<h3 id="克隆一个本地PDB"><a href="#克隆一个本地PDB" class="headerlink" title="克隆一个本地PDB"></a>克隆一个本地PDB</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter pluggable database pdb2 <span class="keyword">open</span>;</span>
<span class="line">create pluggable database pdb3 from pdb2</span>
<span class="line"> file_name_convert=(<span class="string">'/u01/app/oracle/oradata/orcl2/pdb2'</span>,<span class="string">'/u01/app/oracle/oradata/orcl2/pdb3'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment">#查看PDB</span></span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line">         <span class="number">4</span> PDB2                           READ WRITE NO</span>
<span class="line">         <span class="number">6</span> PDB3                           MOUNTED</span>
</pre></td></tr></table></figure>
<h3 id="使用DBCA图形化方式创建PDB"><a href="#使用DBCA图形化方式创建PDB" class="headerlink" title="使用DBCA图形化方式创建PDB"></a>使用DBCA图形化方式创建PDB</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">dbca</span>
</pre></td></tr></table></figure>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_01.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_02.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_03.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_04.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_05.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_06.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_07.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_08.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0519_oracle12c_createpdb_09.png" alt=""></p>
<h2 id="熟练掌握PDB的基本管理"><a href="#熟练掌握PDB的基本管理" class="headerlink" title="熟练掌握PDB的基本管理"></a>熟练掌握PDB的基本管理</h2><h3 id="容器查看和切换"><a href="#容器查看和切换" class="headerlink" title="容器查看和切换"></a>容器查看和切换</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> name, decode(cdb, <span class="string">'YES'</span>, <span class="string">'Multitenant Option enabled'</span>, <span class="string">'Regular 12c Database: '</span>) <span class="string">"Multitenant Option"</span>, </span>
<span class="line"> open_mode, con_id from v$database;</span>
<span class="line"></span>
<span class="line">NAME      Multitenant Option         OPEN_MODE                CON_ID</span>
<span class="line">--------- -------------------------- -------------------- ----------</span>
<span class="line">ORCL2     Multitenant Option enabled READ WRITE                    <span class="number">0</span></span>
<span class="line"></span>
<span class="line">show pdbs;</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">2</span> PDB$SEED                       READ ONLY  NO</span>
<span class="line">         <span class="number">3</span> PDB1                           READ WRITE NO</span>
<span class="line">         <span class="number">4</span> PDB2                           READ WRITE NO</span>
<span class="line">         <span class="number">5</span> PDB4                           READ WRITE NO</span>
<span class="line">         <span class="number">6</span> PDB3                           READ WRITE NO</span>
<span class="line"></span>
<span class="line">alter session set container=pdb1;</span>
</pre></td></tr></table></figure>
<h3 id="启停PDB数据库"><a href="#启停PDB数据库" class="headerlink" title="启停PDB数据库"></a>启停PDB数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 以下以PDB3为例</span></span>
<span class="line">alter pluggable database pdb3 <span class="keyword">open</span>;</span>
<span class="line">alter pluggable database pdb3 <span class="keyword">close</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 或切换到pdb3内执行</span></span>
<span class="line">alter session set container=pdb3;</span>
<span class="line">show pdbs</span>
<span class="line"></span>
<span class="line">    CON_ID CON_NAME                       OPEN MODE  RESTRICTED</span>
<span class="line">---------- ------------------------------ ---------- ----------</span>
<span class="line">         <span class="number">6</span> PDB3                           MOUNTED</span>
<span class="line"></span>
<span class="line">alter database <span class="keyword">open</span>;</span>
<span class="line"><span class="keyword">shutdown</span> immediate</span>
</pre></td></tr></table></figure>
<h3 id="删除PDB数据库"><a href="#删除PDB数据库" class="headerlink" title="删除PDB数据库"></a>删除PDB数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line">alter pluggable database pdb4 <span class="keyword">close</span>;</span>
<span class="line">drop pluggable database pdb4 including datafiles;</span>
</pre></td></tr></table></figure>
<h2 id="完成CDB-PDB的网络监听配置"><a href="#完成CDB-PDB的网络监听配置" class="headerlink" title="完成CDB,PDB的网络监听配置"></a>完成CDB,PDB的网络监听配置</h2><h3 id="配置LISTENER"><a href="#配置LISTENER" class="headerlink" title="配置LISTENER"></a>配置LISTENER</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd $ORACLE_HOME/network/admin</span>
<span class="line">vi listener.ora</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">LISTENER =</span>
<span class="line">  (DESCRIPTION_LIST =</span>
<span class="line">    (DESCRIPTION =</span>
<span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = orcl12)(PORT = <span class="number">1521</span>))</span>
<span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">SID_LIST_LISTENER =</span>
<span class="line">  (SID_LIST =</span>
<span class="line">    (SID_DESC =</span>
<span class="line">      (GLOBAL_DBNAME = pdb1)</span>
<span class="line">      (ORACLE_HOME = <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1)</span>
<span class="line">      (SID_NAME = orcl2)</span>
<span class="line">    )</span>
<span class="line">    (SID_DESC =</span>
<span class="line">      (GLOBAL_DBNAME = pdb2)</span>
<span class="line">      (ORACLE_HOME = <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1)</span>
<span class="line">      (SID_NAME = orcl2)</span>
<span class="line">    )</span>
<span class="line">    (SID_DESC =</span>
<span class="line">      (GLOBAL_DBNAME = pdb3)</span>
<span class="line">      (ORACLE_HOME = <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1)</span>
<span class="line">      (SID_NAME = orcl2)</span>
<span class="line">    )</span>
<span class="line">)</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="配置tnsnames"><a href="#配置tnsnames" class="headerlink" title="配置tnsnames"></a>配置tnsnames</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /etc/hosts</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span>
<span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span>
<span class="line"><span class="number">10.245</span>.<span class="number">231.205</span> orcl12</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">vi tnsnames.ora</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">ORCL2 =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.245</span>.<span class="number">231.205</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = orcl2)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">PDB1 =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.245</span>.<span class="number">231.205</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = pdb1)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">PDB2 =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.245</span>.<span class="number">231.205</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = pdb2)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">PDB3 =</span>
<span class="line">  (DESCRIPTION =</span>
<span class="line">    (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.245</span>.<span class="number">231.205</span>)(PORT = <span class="number">1521</span>))</span>
<span class="line">    (CONNECT_DATA =</span>
<span class="line">      (SERVER = DEDICATED)</span>
<span class="line">      (SERVICE_NAME = pdb3)</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 验证配置</span></span>
<span class="line">tnsping pdb1</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">TNS Ping Utility <span class="keyword">for</span> Linux: Version <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - Production on <span class="number">19</span>-MAY-<span class="number">2017</span> <span class="number">16</span>:<span class="number">41</span>:<span class="number">53</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1997</span>, <span class="number">2016</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Used parameter files:</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Used TNSNAMES adapter to resolve the alias</span>
<span class="line">Attempting to contact (DESCRIPTION = (ADDRESS = (PROTOCOL = TCP)(HOST = <span class="number">10.245</span>.<span class="number">231.205</span>)(PORT = <span class="number">1521</span>)) (CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = pdb1)))</span>
<span class="line">OK (<span class="number">0</span> msec)</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">sqlplus pdb1/oracle@pdb1</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">SQL*Plus: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> Production on Fri May <span class="number">19</span> <span class="number">16</span>:<span class="number">42</span>:08 <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2016</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Last Successful login <span class="keyword">time</span>: Fri May <span class="number">19</span> <span class="number">2017</span> <span class="number">16</span>:<span class="number">40</span>:<span class="number">02</span> +08:<span class="number">00</span></span>
<span class="line"></span>
<span class="line">Connected to:</span>
<span class="line">Oracle Database <span class="number">12</span>c Enterprise Edition Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - <span class="number">64</span>bit Production</span>
<span class="line"></span>
<span class="line">SQL&gt; show con_name</span>
<span class="line"></span>
<span class="line">CON_NAME</span>
<span class="line">------------------------------</span>
<span class="line">PDB1</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><h3 id="手工模拟DBCA创建CDB数据库"><a href="#手工模拟DBCA创建CDB数据库" class="headerlink" title="手工模拟DBCA创建CDB数据库"></a>手工模拟DBCA创建CDB数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 只生成建库脚本</span></span>
<span class="line">dbca -silent -templateName $ORACLE_HOME/assistants/dbca/templates/General_Purpose.dbc -gdbname orcl2 -sid orcl2 \</span>
<span class="line">-characterSet ZHS16GBK -sysPassword oracle -systemPassword oracle -createAsContainerDatabase true -generateScripts</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">Database creation script generation</span>
<span class="line"><span class="number">1</span>% complete</span>
<span class="line"><span class="number">2</span>% complete</span>
<span class="line"><span class="number">18</span>% complete</span>
<span class="line"><span class="number">33</span>% complete</span>
<span class="line"><span class="number">35</span>% complete</span>
<span class="line"><span class="number">40</span>% complete</span>
<span class="line"><span class="number">41</span>% complete</span>
<span class="line"><span class="number">42</span>% complete</span>
<span class="line"><span class="number">46</span>% complete</span>
<span class="line"><span class="number">51</span>% complete</span>
<span class="line"><span class="number">52</span>% complete</span>
<span class="line"><span class="number">55</span>% complete</span>
<span class="line"><span class="number">56</span>% complete</span>
<span class="line"><span class="number">60</span>% complete</span>
<span class="line"><span class="number">63</span>% complete</span>
<span class="line"><span class="number">66</span>% complete</span>
<span class="line"><span class="number">100</span>% complete</span>
<span class="line">Look at the <span class="keyword">log</span> file <span class="string">"/u01/app/oracle/admin/orcl2/scripts/orcl2.log"</span> <span class="keyword">for</span> further details.</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看分析建库脚本</span></span>
<span class="line">cd /u01/app/oracle/admin/orcl2/scripts</span>
<span class="line">ll</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">total <span class="number">18348</span></span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">1891</span> May <span class="number">19</span> 08:<span class="number">59</span> cloneDBCreation.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall      <span class="number">833</span> May <span class="number">19</span> 08:<span class="number">59</span> CloneRmanRestore.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">2227</span> May <span class="number">19</span> 08:<span class="number">59</span> init.ora</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">2238</span> May <span class="number">19</span> 08:<span class="number">59</span> initorcl2TempOMF.ora</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">2343</span> May <span class="number">19</span> 08:<span class="number">59</span> initorcl2Temp.ora</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall      <span class="number">548</span> May <span class="number">19</span> 08:<span class="number">59</span> lockAccount.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall      <span class="number">521</span> May <span class="number">19</span> 08:<span class="number">59</span> orcl2.log</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> oracle oinstall      <span class="number">785</span> May <span class="number">19</span> 08:<span class="number">59</span> orcl2.sh</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> oracle oinstall      <span class="number">612</span> May <span class="number">19</span> 08:<span class="number">59</span> orcl2.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">3635</span> May <span class="number">19</span> 08:<span class="number">59</span> plug_PDBSeed.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall      <span class="number">810</span> May <span class="number">19</span> 08:<span class="number">59</span> postDBCreation.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall     <span class="number">1852</span> May <span class="number">19</span> 08:<span class="number">59</span> postScripts.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall      <span class="number">101</span> May <span class="number">19</span> 08:<span class="number">59</span> rmanPDBCleanUpDatafiles.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall      <span class="number">377</span> May <span class="number">19</span> 08:<span class="number">59</span> rmanPDBRestoreDatafiles.sql</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> oracle oinstall      <span class="number">560</span> May <span class="number">19</span> 08:<span class="number">59</span> rmanRestoreDatafiles.sql</span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">18726912</span> May <span class="number">19</span> 08:<span class="number">59</span> tempControl.ctl</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">cat orcl2.sh</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="comment">#!/bin/sh</span></span>
<span class="line"></span>
<span class="line">OLD_UMASK=<span class="string">`umask`</span></span>
<span class="line"><span class="keyword">umask</span> <span class="number">0027</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/admin/orcl2/adump</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/admin/orcl2/dpdump</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/admin/orcl2/pfile</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/audit</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/cfgtoollogs/dbca/orcl2</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/oradata/orcl2</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/oradata/orcl2/pdbseed</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1/dbs</span>
<span class="line"><span class="keyword">umask</span> $&#123;OLD_UMASK&#125;</span>
<span class="line">PERL5LIB=$ORACLE_HOME/rdbms/admin:$PERL5LIB; export PERL5LIB</span>
<span class="line">ORACLE_SID=orcl2; export ORACLE_SID</span>
<span class="line">PATH=$ORACLE_HOME/bin:$ORACLE_HOME/perl/bin:$PATH; export PATH</span>
<span class="line">echo You should Add this entry in the /etc/oratab: orcl2:<span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1:Y</span>
<span class="line">/u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1/bin/sqlplus /nolog @/u01/app/oracle/admin/orcl2/scripts/orcl2.sql</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">cat orcl2.sql</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">set verify off</span>
<span class="line">ACCEPT sysPassword CHAR PROMPT <span class="string">'Enter new password for SYS: '</span> HIDE</span>
<span class="line">ACCEPT systemPassword CHAR PROMPT <span class="string">'Enter new password for SYSTEM: '</span> HIDE</span>
<span class="line">host /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1/bin/orapwd file=<span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1/dbs/orapworcl2 force=<span class="keyword">y</span> <span class="keyword">format</span>=<span class="number">12</span></span>
<span class="line">@/u01/app/oracle/admin/orcl2/scripts/CloneRmanRestore.sql</span>
<span class="line">@/u01/app/oracle/admin/orcl2/scripts/cloneDBCreation.sql</span>
<span class="line">@/u01/app/oracle/admin/orcl2/scripts/plug_PDBSeed.sql</span>
<span class="line">@/u01/app/oracle/admin/orcl2/scripts/postScripts.sql</span>
<span class="line">@/u01/app/oracle/admin/orcl2/scripts/lockAccount.sql</span>
<span class="line">@/u01/app/oracle/admin/orcl2/scripts/postDBCreation.sql</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="通过控制文件查看cdb的结构"><a href="#通过控制文件查看cdb的结构" class="headerlink" title="通过控制文件查看cdb的结构"></a>通过控制文件查看cdb的结构</h3><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">database</span> <span class="keyword">backup</span> <span class="keyword">controlfile</span> <span class="keyword">to</span> <span class="keyword">trace</span>;</span>
<span class="line">col VALUE for a80</span>
<span class="line"><span class="keyword">select</span> INST_ID,<span class="keyword">VALUE</span> <span class="keyword">from</span> v$diag_info <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'Default Trace File'</span>;</span>
<span class="line"></span>
<span class="line">   INST_ID VALUE</span>
<span class="line"><span class="comment">---------- --------------------------------------------------------------------------------</span></span>
<span class="line">         1 /u01/app/oracle/diag/rdbms/orcl2/orcl2/trace/orcl2_ora_16951.trc</span>
</pre></td></tr></table></figure>
<p>查看生成的Trace File<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /u01/app/oracle/diag/rdbms/orcl2/orcl2/trace/orcl2_ora_16951.trc</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
<span class="line">Trace file /u01/app/oracle/diag/rdbms/orcl2/orcl2/trace/orcl2_ora_16951.trc</span>
<span class="line">Oracle Database <span class="number">12</span>c Enterprise Edition Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - <span class="number">64</span>bit Production</span>
<span class="line">Build label:    RDBMS_12.<span class="number">2.0</span>.<span class="number">1.0_</span>LINUX.X64_170125</span>
<span class="line">ORACLE_HOME:    <span class="regexp">/u01/app</span><span class="regexp">/oracle/product</span><span class="regexp">/12.2.0/db</span>_1</span>
<span class="line">System name:    Linux</span>
<span class="line">Node name:      orcl12</span>
<span class="line">Release:        <span class="number">4.1</span>.<span class="number">12</span>-<span class="number">61.1</span>.<span class="number">18</span>.el7uek.x86_64</span>
<span class="line">Version:        <span class="comment">#2 SMP Fri Nov 4 15:48:30 PDT 2016</span></span>
<span class="line">Machine:        x86_64</span>
<span class="line">Instance name: orcl2</span>
<span class="line">Redo thread mounted by this instance: <span class="number">1</span></span>
<span class="line">Oracle process number: <span class="number">27</span></span>
<span class="line">Unix process pid: <span class="number">16951</span>, image: oracle@orcl12 (TNS V1-V3)</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">*** <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">19</span>:<span class="number">27.267587</span>+08:<span class="number">00</span> (PDB4(<span class="number">5</span>))</span>
<span class="line">*** SESSION ID:(<span class="number">397.57468</span>) <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">19</span>:<span class="number">27.267655</span>+08:<span class="number">00</span></span>
<span class="line">*** CLIENT ID:() <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">19</span>:<span class="number">27.267666</span>+08:<span class="number">00</span></span>
<span class="line">*** SERVICE NAME:(SYS$USERS) <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">19</span>:<span class="number">27.267675</span>+08:<span class="number">00</span></span>
<span class="line">*** MODULE NAME:(sqlplus@orcl12 (TNS V1-V3)) <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">19</span>:<span class="number">27.267685</span>+08:<span class="number">00</span></span>
<span class="line">*** ACTION NAME:() <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">19</span>:<span class="number">27.267694</span>+08:<span class="number">00</span></span>
<span class="line">*** CLIENT DRIVER:(SQL*PLUS) <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">19</span>:<span class="number">27.267703</span>+08:<span class="number">00</span></span>
<span class="line">*** CONTAINER ID:(<span class="number">5</span>) <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">19</span>:<span class="number">27.267712</span>+08:<span class="number">00</span></span>
<span class="line"> </span>
<span class="line">JIT: pid <span class="number">16951</span> requesting stop</span>
<span class="line"></span>
<span class="line">*** <span class="number">2017</span>-<span class="number">05</span>-<span class="number">19</span>T16:<span class="number">21</span>:<span class="number">04</span>.<span class="number">923126</span>+08:<span class="number">00</span> (CDB$ROOT(<span class="number">1</span>))</span>
<span class="line">-- The following are current System-scope REDO Log Archival related</span>
<span class="line">-- parameters <span class="keyword">and</span> can be included in the database initialization file.</span>
<span class="line">--</span>
<span class="line">-- LOG_ARCHIVE_DEST=<span class="string">''</span></span>
<span class="line">-- LOG_ARCHIVE_DUPLEX_DEST=<span class="string">''</span></span>
<span class="line">--</span>
<span class="line">-- LOG_ARCHIVE_FORMAT=%t_%s_%r.dbf</span>
<span class="line">--</span>
<span class="line">-- DB_UNIQUE_NAME=<span class="string">"orcl2"</span></span>
<span class="line">--</span>
<span class="line">-- LOG_ARCHIVE_CONFIG=<span class="string">'SEND, RECEIVE, NODG_CONFIG'</span></span>
<span class="line">-- LOG_ARCHIVE_MAX_PROCESSES=<span class="number">4</span></span>
<span class="line">-- STANDBY_FILE_MANAGEMENT=MANUAL</span>
<span class="line">-- STANDBY_ARCHIVE_DEST=?<span class="comment">#/dbs/arch</span></span>
<span class="line">-- FAL_CLIENT=<span class="string">''</span></span>
<span class="line">-- FAL_SERVER=<span class="string">''</span></span>
<span class="line">--</span>
<span class="line">-- LOG_ARCHIVE_DEST_1=<span class="string">'LOCATION=/u01/app/oracle/product/12.2.0/db_1/dbs/arch'</span></span>
<span class="line">-- LOG_ARCHIVE_DEST_1=<span class="string">'MANDATORY NOREOPEN NODELAY'</span></span>
<span class="line">-- LOG_ARCHIVE_DEST_1=<span class="string">'ARCH NOAFFIRM NOVERIFY SYNC'</span></span>
<span class="line">-- LOG_ARCHIVE_DEST_1=<span class="string">'NOREGISTER NOALTERNATE NODEPENDENCY'</span></span>
<span class="line">-- LOG_ARCHIVE_DEST_1=<span class="string">'NOMAX_FAILURE NOQUOTA_SIZE NOQUOTA_USED NODB_UNIQUE_NAME'</span></span>
<span class="line">-- LOG_ARCHIVE_DEST_1=<span class="string">'VALID_FOR=(PRIMARY_ROLE,ONLINE_LOGFILES)'</span></span>
<span class="line">-- LOG_ARCHIVE_DEST_STATE_1=ENABLE</span>
<span class="line">--</span>
<span class="line">-- Below are two sets of SQL statements, <span class="keyword">each</span> of which creates a new</span>
<span class="line">-- control file <span class="keyword">and</span> uses it to <span class="keyword">open</span> the database. The first set opens</span>
<span class="line">-- the database with the NORESETLOGS option <span class="keyword">and</span> should be used only <span class="keyword">if</span></span>
<span class="line">-- the current versions of all online logs are available. The second</span>
<span class="line">-- set opens the database with the RESETLOGS option <span class="keyword">and</span> should be used</span>
<span class="line">-- <span class="keyword">if</span> online logs are unavailable.</span>
<span class="line">-- The appropriate set of statements can be copied from the trace into</span>
<span class="line">-- a script file, edited as necessary, <span class="keyword">and</span> executed <span class="keyword">when</span> there is a</span>
<span class="line">-- need to re-create the control file.</span>
<span class="line">--</span>
<span class="line">--     Set <span class="comment">#1. NORESETLOGS case</span></span>
<span class="line">--</span>
<span class="line">-- The following commands will create a new control file <span class="keyword">and</span> <span class="keyword">use</span> it</span>
<span class="line">-- to <span class="keyword">open</span> the database.</span>
<span class="line">-- Data used by Recovery Manager will be lost.</span>
<span class="line">-- Additional logs may be required <span class="keyword">for</span> media recovery of offline</span>
<span class="line">-- Use this only <span class="keyword">if</span> the current versions of all online logs are</span>
<span class="line">-- available.</span>
<span class="line">-- After mounting the created controlfile, the following SQL</span>
<span class="line">-- statement will place the database in the appropriate</span>
<span class="line">-- protection mode:</span>
<span class="line">--  ALTER DATABASE SET STANDBY DATABASE TO MAXIMIZE PERFORMANCE</span>
<span class="line">STARTUP NOMOUNT</span>
<span class="line">CREATE CONTROLFILE REUSE DATABASE <span class="string">"ORCL2"</span> NORESETLOGS  NOARCHIVELOG</span>
<span class="line">    MAXLOGFILES <span class="number">16</span></span>
<span class="line">    MAXLOGMEMBERS <span class="number">3</span></span>
<span class="line">    MAXDATAFILES <span class="number">1024</span></span>
<span class="line">    MAXINSTANCES <span class="number">8</span></span>
<span class="line">    MAXLOGHISTORY <span class="number">292</span></span>
<span class="line">LOGFILE</span>
<span class="line">  GROUP <span class="number">1</span> <span class="string">'/u01/app/oracle/oradata/orcl2/redo01.log'</span>  SIZE <span class="number">200</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">  GROUP <span class="number">2</span> <span class="string">'/u01/app/oracle/oradata/orcl2/redo02.log'</span>  SIZE <span class="number">200</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">  GROUP <span class="number">3</span> <span class="string">'/u01/app/oracle/oradata/orcl2/redo03.log'</span>  SIZE <span class="number">200</span>M BLOCKSIZE <span class="number">512</span></span>
<span class="line">-- STANDBY LOGFILE</span>
<span class="line">DATAFILE</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/users01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb3/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb3/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb3/undotbs01.dbf'</span></span>
<span class="line">CHARACTER SET ZHS16GBK</span>
<span class="line">;</span>
<span class="line">-- Commands to re-create incarnation table</span>
<span class="line">-- Below <span class="keyword">log</span> names MUST be changed to existing filenames on</span>
<span class="line">-- disk. Any one <span class="keyword">log</span> file from <span class="keyword">each</span> branch can be used to</span>
<span class="line">-- re-create incarnation records.</span>
<span class="line">-- ALTER DATABASE REGISTER LOGFILE <span class="string">'/u01/app/oracle/product/12.2.0/db_1/dbs/arch1_1_934293149.dbf'</span>;</span>
<span class="line">-- ALTER DATABASE REGISTER LOGFILE <span class="string">'/u01/app/oracle/product/12.2.0/db_1/dbs/arch1_1_944407156.dbf'</span>;</span>
<span class="line">-- Recovery is required <span class="keyword">if</span> any of the datafiles are restored backups,</span>
<span class="line">-- <span class="keyword">or</span> <span class="keyword">if</span> the <span class="keyword">last</span> <span class="keyword">shutdown</span> was <span class="keyword">not</span> normal <span class="keyword">or</span> immediate.</span>
<span class="line">RECOVER DATABASE</span>
<span class="line">-- Database can now be opened normally.</span>
<span class="line">ALTER DATABASE OPEN;</span>
<span class="line">-- Open all the PDBs.</span>
<span class="line">ALTER PLUGGABLE DATABASE ALL OPEN;</span>
<span class="line">-- Commands to add tempfiles to temporary tablespaces.</span>
<span class="line">-- Online tempfiles have complete space information.</span>
<span class="line">-- Other tempfiles may <span class="keyword">require</span> adjustment.</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/temp01.dbf'</span></span>
<span class="line">     SIZE <span class="number">34603008</span>  REUSE AUTOEXTEND ON NEXT <span class="number">655360</span>  MAXSIZE <span class="number">32767</span>M;</span>
<span class="line">ALTER SESSION SET CONTAINER = PDB$SEED;</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed/temp012017-05-19_15-19-57-248-PM.dbf'</span></span>
<span class="line">     SIZE <span class="number">67108864</span>  REUSE AUTOEXTEND ON NEXT <span class="number">655360</span>  MAXSIZE <span class="number">32767</span>M;</span>
<span class="line">ALTER SESSION SET CONTAINER = PDB1;</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/temp012017-05-19_15-19-57-248-PM.dbf'</span></span>
<span class="line">     SIZE <span class="number">67108864</span>  REUSE AUTOEXTEND ON NEXT <span class="number">655360</span>  MAXSIZE <span class="number">32767</span>M;</span>
<span class="line">ALTER SESSION SET CONTAINER = PDB2;</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/temp012017-05-19_15-19-57-248-PM.dbf'</span> REUSE;</span>
<span class="line">ALTER SESSION SET CONTAINER = PDB3;</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/pdb3/temp012017-05-19_15-19-57-248-PM.dbf'</span></span>
<span class="line">     SIZE <span class="number">67108864</span>  REUSE AUTOEXTEND ON NEXT <span class="number">655360</span>  MAXSIZE <span class="number">32767</span>M;</span>
<span class="line">ALTER SESSION SET CONTAINER = CDB$ROOT;</span>
<span class="line">-- End of tempfile additions.</span>
<span class="line">--</span>
<span class="line">--     Set <span class="comment">#2. RESETLOGS case</span></span>
<span class="line">--</span>
<span class="line">-- The following commands will create a new control file <span class="keyword">and</span> <span class="keyword">use</span> it</span>
<span class="line">-- to <span class="keyword">open</span> the database.</span>
<span class="line">-- Data used by Recovery Manager will be lost.</span>
<span class="line">-- The contents of online logs will be lost <span class="keyword">and</span> all backups will</span>
<span class="line">-- be invalidated. Use this only <span class="keyword">if</span> online logs are damaged.</span>
<span class="line">-- After mounting the created controlfile, the following SQL</span>
<span class="line">-- statement will place the database in the appropriate</span>
<span class="line">-- protection mode:</span>
<span class="line">--  ALTER DATABASE SET STANDBY DATABASE TO MAXIMIZE PERFORMANCE</span>
<span class="line">STARTUP NOMOUNT</span>
<span class="line">CREATE CONTROLFILE REUSE DATABASE <span class="string">"ORCL2"</span> RESETLOGS  NOARCHIVELOG</span>
<span class="line">    MAXLOGFILES <span class="number">16</span></span>
<span class="line">    MAXLOGMEMBERS <span class="number">3</span></span>
<span class="line">    MAXDATAFILES <span class="number">1024</span></span>
<span class="line">    MAXINSTANCES <span class="number">8</span></span>
<span class="line">    MAXLOGHISTORY <span class="number">292</span></span>
<span class="line">LOGFILE</span>
<span class="line">  GROUP <span class="number">1</span> <span class="string">'/u01/app/oracle/oradata/orcl2/redo01.log'</span>  SIZE <span class="number">200</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">  GROUP <span class="number">2</span> <span class="string">'/u01/app/oracle/oradata/orcl2/redo02.log'</span>  SIZE <span class="number">200</span>M BLOCKSIZE <span class="number">512</span>,</span>
<span class="line">  GROUP <span class="number">3</span> <span class="string">'/u01/app/oracle/oradata/orcl2/redo03.log'</span>  SIZE <span class="number">200</span>M BLOCKSIZE <span class="number">512</span></span>
<span class="line">-- STANDBY LOGFILE</span>
<span class="line">DATAFILE</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/users01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/undotbs01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb3/system01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb3/sysaux01.dbf'</span>,</span>
<span class="line">  <span class="string">'/u01/app/oracle/oradata/orcl2/pdb3/undotbs01.dbf'</span></span>
<span class="line">CHARACTER SET ZHS16GBK</span>
<span class="line">;</span>
<span class="line">-- Commands to re-create incarnation table</span>
<span class="line">-- Below <span class="keyword">log</span> names MUST be changed to existing filenames on</span>
<span class="line">-- disk. Any one <span class="keyword">log</span> file from <span class="keyword">each</span> branch can be used to</span>
<span class="line">-- re-create incarnation records.</span>
<span class="line">-- ALTER DATABASE REGISTER LOGFILE <span class="string">'/u01/app/oracle/product/12.2.0/db_1/dbs/arch1_1_934293149.dbf'</span>;</span>
<span class="line">-- ALTER DATABASE REGISTER LOGFILE <span class="string">'/u01/app/oracle/product/12.2.0/db_1/dbs/arch1_1_944407156.dbf'</span>;</span>
<span class="line">-- Recovery is required <span class="keyword">if</span> any of the datafiles are restored backups,</span>
<span class="line">-- <span class="keyword">or</span> <span class="keyword">if</span> the <span class="keyword">last</span> <span class="keyword">shutdown</span> was <span class="keyword">not</span> normal <span class="keyword">or</span> immediate.</span>
<span class="line">RECOVER DATABASE USING BACKUP CONTROLFILE</span>
<span class="line">-- Database can now be opened zeroing the online logs.</span>
<span class="line">ALTER DATABASE OPEN RESETLOGS;</span>
<span class="line">-- Open all the PDBs.</span>
<span class="line">ALTER PLUGGABLE DATABASE ALL OPEN;</span>
<span class="line">-- Commands to add tempfiles to temporary tablespaces.</span>
<span class="line">-- Online tempfiles have complete space information.</span>
<span class="line">-- Other tempfiles may <span class="keyword">require</span> adjustment.</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/temp01.dbf'</span></span>
<span class="line">     SIZE <span class="number">34603008</span>  REUSE AUTOEXTEND ON NEXT <span class="number">655360</span>  MAXSIZE <span class="number">32767</span>M;</span>
<span class="line">ALTER SESSION SET CONTAINER = PDB$SEED;</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/pdbseed/temp012017-05-19_15-19-57-248-PM.dbf'</span></span>
<span class="line">     SIZE <span class="number">67108864</span>  REUSE AUTOEXTEND ON NEXT <span class="number">655360</span>  MAXSIZE <span class="number">32767</span>M;</span>
<span class="line">ALTER SESSION SET CONTAINER = PDB1;</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/pdb1/temp012017-05-19_15-19-57-248-PM.dbf'</span></span>
<span class="line">     SIZE <span class="number">67108864</span>  REUSE AUTOEXTEND ON NEXT <span class="number">655360</span>  MAXSIZE <span class="number">32767</span>M;</span>
<span class="line">ALTER SESSION SET CONTAINER = PDB2;</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/pdb2/temp012017-05-19_15-19-57-248-PM.dbf'</span> REUSE;</span>
<span class="line">ALTER SESSION SET CONTAINER = PDB3;</span>
<span class="line">ALTER TABLESPACE TEMP ADD TEMPFILE <span class="string">'/u01/app/oracle/oradata/orcl2/pdb3/temp012017-05-19_15-19-57-248-PM.dbf'</span></span>
<span class="line">     SIZE <span class="number">67108864</span>  REUSE AUTOEXTEND ON NEXT <span class="number">655360</span>  MAXSIZE <span class="number">32767</span>M;</span>
<span class="line">ALTER SESSION SET CONTAINER = CDB$ROOT;</span>
<span class="line">-- End of tempfile additions.</span>
<span class="line">--</span>
<span class="line"><span class="comment">#-----------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hugepage计算脚本]]></title>
      <url>/2017/05/08/oracle/hugepage%E8%AE%A1%E7%AE%97%E8%84%9A%E6%9C%AC/</url>
      <content type="html"><![CDATA[<h2 id="REQUIREMENTS"><a href="#REQUIREMENTS" class="headerlink" title="REQUIREMENTS"></a>REQUIREMENTS</h2><ol>
<li>Oracle Database instance(s) are up and running</li>
<li>Oracle Database 11g Automatic Memory Management (AMM) is not setup  (See Note 749851.1)</li>
<li>The shared memory segments can be listed by command “ipcs -m”</li>
<li>Oracle Linux</li>
<li>Package ‘bc’ installed<a id="more"></a>
</li>
</ol>
<h2 id="CONFIGURING"><a href="#CONFIGURING" class="headerlink" title="CONFIGURING"></a>CONFIGURING</h2><ol>
<li>Create a text file named hugepages_settings.sh</li>
<li><p>Copy the contents below in the file</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span>
<span class="line"><span class="comment">#</span></span>
<span class="line"><span class="comment"># hugepages_settings.sh</span></span>
<span class="line"><span class="comment">#</span></span>
<span class="line"><span class="comment"># Linux bash script to compute values for the</span></span>
<span class="line"><span class="comment"># recommended HugePages/HugeTLB configuration</span></span>
<span class="line"><span class="comment"># on Oracle Linux</span></span>
<span class="line"><span class="comment">#</span></span>
<span class="line"><span class="comment"># Note: This script does calculation for all shared memory</span></span>
<span class="line"><span class="comment"># segments available when the script is run, no matter it</span></span>
<span class="line"><span class="comment"># is an Oracle RDBMS shared memory segment or not.</span></span>
<span class="line"><span class="comment">#</span></span>
<span class="line"><span class="comment"># This script is provided by Doc ID 401749.1 from My Oracle Support </span></span>
<span class="line"><span class="comment"># http://support.oracle.com</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># Welcome text</span></span>
<span class="line">echo <span class="string">"</span>
<span class="line">This script is provided by Doc ID 401749.1 from My Oracle Support </span>
<span class="line">(http://support.oracle.com) where it is intended to compute values for </span>
<span class="line">the recommended HugePages/HugeTLB configuration for the current shared </span>
<span class="line">memory segments on Oracle Linux. Before proceeding with the execution please note following:</span>
<span class="line"> * For ASM instance, it needs to configure ASMM instead of AMM.</span>
<span class="line"> * The 'pga_aggregate_target' is outside the SGA and </span>
<span class="line">   you should accommodate this while calculating SGA size.</span>
<span class="line"> * In case you changes the DB SGA size, </span>
<span class="line">   as the new SGA will not fit in the previous HugePages configuration, </span>
<span class="line">   it had better disable the whole HugePages, </span>
<span class="line">   start the DB with new SGA size and run the script again.</span>
<span class="line">And make sure that:</span>
<span class="line"> * Oracle Database instance(s) are up and running</span>
<span class="line"> * Oracle Database 11g Automatic Memory Management (AMM) is not setup </span>
<span class="line">   (See Doc ID 749851.1)</span>
<span class="line"> * The shared memory segments can be listed by command:</span>
<span class="line">     # ipcs -m</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Press Enter to proceed..."</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">read</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># Check for the kernel version</span></span>
<span class="line">KERN=<span class="string">`uname -r | awk -F. '&#123; printf("%d.%d\n",$1,$2); &#125;'`</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># Find out the HugePage size</span></span>
<span class="line">HPG_SZ=<span class="string">`grep Hugepagesize /proc/meminfo | awk '&#123;print $2&#125;'`</span></span>
<span class="line"><span class="keyword">if</span> [ -z <span class="string">"$HPG_SZ"</span> ];then</span>
<span class="line">    echo <span class="string">"The hugepages may not be supported in the system where the script is being executed."</span></span>
<span class="line">    <span class="keyword">exit</span> <span class="number">1</span></span>
<span class="line">fi</span>
<span class="line"></span>
<span class="line"><span class="comment"># Initialize the counter</span></span>
<span class="line">NUM_PG=<span class="number">0</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># Cumulative number of pages required to handle the running shared memory segments</span></span>
<span class="line"><span class="keyword">for</span> SEG_BYTES in <span class="string">`ipcs -m | cut -c44-300 | awk '&#123;print $1&#125;' | grep "[0-9][0-9]*"`</span></span>
<span class="line"><span class="keyword">do</span></span>
<span class="line">    MIN_PG=<span class="string">`echo "$SEG_BYTES/($HPG_SZ*1024)" | bc -q`</span></span>
<span class="line">    <span class="keyword">if</span> [ $MIN_PG -<span class="keyword">gt</span> <span class="number">0</span> ]; then</span>
<span class="line">        NUM_PG=<span class="string">`echo "$NUM_PG+$MIN_PG+1" | bc -q`</span></span>
<span class="line">    fi</span>
<span class="line">done</span>
<span class="line"></span>
<span class="line">RES_BYTES=<span class="string">`echo "$NUM_PG * $HPG_SZ * 1024" | bc -q`</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># An SGA less than 100MB does not make sense</span></span>
<span class="line"><span class="comment"># Bail out if that is the case</span></span>
<span class="line"><span class="keyword">if</span> [ $RES_BYTES -<span class="keyword">lt</span> <span class="number">100000000</span> ]; then</span>
<span class="line">    echo <span class="string">"***********"</span></span>
<span class="line">    echo <span class="string">"** ERROR **"</span></span>
<span class="line">    echo <span class="string">"***********"</span></span>
<span class="line">    echo <span class="string">"Sorry! There are not enough total of shared memory segments allocated for </span>
<span class="line">HugePages configuration. HugePages can only be used for shared memory segments </span>
<span class="line">that you can list by command:</span>
<span class="line"></span>
<span class="line">    # ipcs -m</span>
<span class="line"></span>
<span class="line">of a size that can match an Oracle Database SGA. Please make sure that:</span>
<span class="line"> * Oracle Database instance is up and running </span>
<span class="line"> * Oracle Database 11g Automatic Memory Management (AMM) is not configured"</span></span>
<span class="line">    <span class="keyword">exit</span> <span class="number">1</span></span>
<span class="line">fi</span>
<span class="line"></span>
<span class="line"><span class="comment"># Finish with results</span></span>
<span class="line">case $KERN in</span>
<span class="line">    <span class="string">'2.2'</span>) echo <span class="string">"Kernel version $KERN is not supported. Exiting."</span> ;;</span>
<span class="line">    <span class="string">'2.4'</span>) HUGETLB_POOL=<span class="string">`echo "$NUM_PG*$HPG_SZ/1024" | bc -q`</span>;</span>
<span class="line">           echo <span class="string">"Recommended setting: vm.hugetlb_pool = $HUGETLB_POOL"</span> ;;</span>
<span class="line">    <span class="string">'2.6'</span>) echo <span class="string">"Recommended setting: vm.nr_hugepages = $NUM_PG"</span> ;;</span>
<span class="line">    <span class="string">'3.8'</span>) echo <span class="string">"Recommended setting: vm.nr_hugepages = $NUM_PG"</span> ;;</span>
<span class="line">    <span class="string">'3.10'</span>) echo <span class="string">"Recommended setting: vm.nr_hugepages = $NUM_PG"</span> ;;</span>
<span class="line">    <span class="string">'4.1'</span>) echo <span class="string">"Recommended setting: vm.nr_hugepages = $NUM_PG"</span> ;;</span>
<span class="line">esac</span>
<span class="line"></span>
<span class="line"><span class="comment"># End</span></span>
</pre></td></tr></table></figure>
</li>
<li><p>Run:</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">chmod</span> +<span class="keyword">x</span> hugepages_settings.sh</span>
<span class="line">./hugepages_settings.sh</span>
</pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-02 数据库环境初始化]]></title>
      <url>/2017/05/08/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/02_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="静默安装12c软件"><a href="#静默安装12c软件" class="headerlink" title="静默安装12c软件"></a>静默安装12c软件</h2><h3 id="系统检查"><a href="#系统检查" class="headerlink" title="系统检查"></a>系统检查</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">uname –a</span>
<span class="line">cat /etc/redhat-release</span>
<span class="line"><span class="keyword">grep</span> MemTotal /proc/meminfo</span>
<span class="line"><span class="keyword">grep</span> SwapTotal /proc/meminfo</span>
<span class="line">df -hT</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="安装前的准备"><a href="#安装前的准备" class="headerlink" title="安装前的准备"></a>安装前的准备</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装依赖包</span></span>
<span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line">mount /dev/cdrom /media/disk</span>
<span class="line">cp /etc/yum.repos.d/public-yum-ol7.repo /etc/yum.repos.d/public-yum-ol7.repo_old</span>
<span class="line">vi /etc/yum.repos.d/public-yum-ol7.repo</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">[ol7_latest]</span>
<span class="line">name=Oracle Linux $releasever Latest ($basearch)</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span></span>
<span class="line">gpgcheck=<span class="number">0</span></span>
<span class="line">enabled=<span class="number">1</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">yum -<span class="keyword">y</span> install oracle-database-server-<span class="number">12</span>cR2-preinstall.x86_64</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置hosts</span></span>
<span class="line">vi /etc/hosts</span>
<span class="line"></span>
<span class="line"><span class="comment"># 禁用防火墙和selinux</span></span>
<span class="line">systemctl stop firewalld</span>
<span class="line">systemctl disable firewalld</span>
<span class="line"></span>
<span class="line">setenforce <span class="number">0</span></span>
<span class="line">vi /etc/selinux/config</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line">SELINUX=disabled</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 内核参数</span></span>
<span class="line">sysctl -p</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.shmall = <span class="number">1073741824</span></span>
<span class="line">kernel.shmmax = <span class="number">4398046511104</span>      <span class="comment"># 物理内存的50%、60%  如(8G*1024*1024*1024*1024)*50%=</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">net.ipv4.conf.all.rp_filter = <span class="number">2</span></span>
<span class="line">net.ipv4.conf.default.rp_filter = <span class="number">2</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">sysctl -p</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置limit</span></span>
<span class="line">vi /etc/security/limits.conf</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">oracle   soft   nofile    <span class="number">1024</span></span>
<span class="line">oracle   hard   nofile    <span class="number">65536</span></span>
<span class="line">oracle   soft   nproc     <span class="number">2047</span></span>
<span class="line">oracle   hard   nproc     <span class="number">16384</span></span>
<span class="line">oracle   soft   stack     <span class="number">10240</span></span>
<span class="line">oracle   hard   stack     <span class="number">32768</span></span>
<span class="line">oracle   hard   memlock   <span class="number">134217728</span></span>
<span class="line">oracle   soft   memlock   <span class="number">134217728</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 大页设置</span></span>
<span class="line">cat /sys/kernel/mm/transparent_hugepage/enabled</span>
<span class="line">cat /proc/meminfo | <span class="keyword">grep</span> Huge</span>
<span class="line">vi /etc/sysctl.conf </span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">vm.nr_hugepages=<span class="number">2564</span></span>
<span class="line"><span class="comment"># sga_target=5G  大页的内存要大于SGA大小  计算使用Oracle官网提供的脚本，文档 ID 401749.1</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 安装常用工具</span></span>
<span class="line">yum -<span class="keyword">y</span> install kernel-devel <span class="keyword">readline</span>-devel.x86_64  tigervnc-server.x86_64 lrzsz gcc bc</span>
<span class="line">yum -<span class="keyword">y</span> localinstall --nogpgcheck jdk-<span class="number">8</span>u131-linux-x64.rpm</span>
<span class="line">tar xvpf rlwrap-<span class="number">0</span>.<span class="number">42</span>.tar.gz </span>
<span class="line">cd rlwrap-<span class="number">0</span>.<span class="number">42</span></span>
<span class="line">./configure</span>
<span class="line">make &amp;&amp; make install</span>
</pre></td></tr></table></figure>
<h3 id="用户环境配置"><a href="#用户环境配置" class="headerlink" title="用户环境配置"></a>用户环境配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">id oracle</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">uid=<span class="number">54321</span>(oracle) gid=<span class="number">54321</span>(oinstall) groups=<span class="number">54321</span>(oinstall),<span class="number">54322</span>(dba)</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">echo <span class="string">"oracle"</span> | passwd --stdin oracle</span>
<span class="line"></span>
<span class="line">chattr +i /etc/passwd /etc/shadow    <span class="comment"># 增加安全性</span></span>
<span class="line">chattr -i /etc/passwd /etc/shadow    <span class="comment"># 需要修改时执行</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle</span>
<span class="line"><span class="keyword">chown</span> -R oracle:oinstall /u01</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">775</span> /u01/</span>
<span class="line"></span>
<span class="line">vi /home/oracle/.bash_profile</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">export ORACLE_SID=orcl12</span>
<span class="line">export ORACLE_BASE=<span class="regexp">/u01/app</span><span class="regexp">/oracle</span>
<span class="line">export ORACLE_HOME=$ORACLE_BASE/product</span><span class="regexp">/12.2.0/db</span>_1</span>
<span class="line">export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin:$ORACLE_HOME/OPatch:<span class="regexp">/usr/local</span><span class="regexp">/bin</span>
<span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib</span>:$LD_LIBRARY_PATH</span>
<span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span>
<span class="line">export NLS_DATE_FORMAT=<span class="string">'yyyy/mm/dd hh24:mi:ss'</span></span>
<span class="line"></span>
<span class="line">alias sqlplus=<span class="string">'rlwrap sqlplus'</span></span>
<span class="line">alias rman=<span class="string">'rlwrap rman'</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="配置静默安装响应文件"><a href="#配置静默安装响应文件" class="headerlink" title="配置静默安装响应文件"></a>配置静默安装响应文件</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd database/response/</span>
<span class="line">cp db_install.rsp db_install_new.rsp</span>
<span class="line">vi db_install_new.rsp</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">oracle.install.option=INSTALL_DB_SWONLY</span>
<span class="line">UNIX_GROUP_NAME=dba</span>
<span class="line">INVENTORY_LOCATION=<span class="regexp">/u01/app</span><span class="regexp">/oraInventory</span>
<span class="line">ORACLE_HOME=/u</span>01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1</span>
<span class="line">ORACLE_BASE=<span class="regexp">/u01/app</span><span class="regexp">/oracle</span>
<span class="line">oracle.install.db.InstallEdition=EE</span>
<span class="line">oracle.install.db.OSDBA_GROUP=dba</span>
<span class="line">oracle.install.db.OSOPER_GROUP=dba</span>
<span class="line">oracle.install.db.OSBACKUPDBA_GROUP=dba</span>
<span class="line">oracle.install.db.OSDGDBA_GROUP=dba</span>
<span class="line">oracle.install.db.OSKMDBA_GROUP=dba</span>
<span class="line">oracle.install.db.OSRACDBA_GROUP=dba</span>
<span class="line">DECLINE_SECURITY_UPDATES=true</span>
<span class="line">#------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="静默安装12c软件-1"><a href="#静默安装12c软件-1" class="headerlink" title="静默安装12c软件"></a>静默安装12c软件</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd ..</span>
<span class="line">./runInstaller -silent -responseFile /tmp/database/response/db_install_new.rsp -ignoreSysPrereqs</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">As a root user, execute the following script(<span class="keyword">s</span>):</span>
<span class="line">        <span class="number">1</span>. /u01/app/oraInventory/orainstRoot.sh</span>
<span class="line">        <span class="number">2</span>. /u01/app/oracle/product/<span class="number">12.2</span>.<span class="number">0</span>/db_1/root.sh   <span class="comment"># 在root用户下执行这两个脚本</span></span>
<span class="line"></span>
<span class="line">Successfully Setup Software.</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h2 id="dbca静默安装12c容器数据库"><a href="#dbca静默安装12c容器数据库" class="headerlink" title="dbca静默安装12c容器数据库"></a>dbca静默安装12c容器数据库</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">dbca -silent -createDatabase -templateName $ORACLE_HOME/assistants/dbca/templates/General_Purpose.dbc \</span>
<span class="line">-gdbname orcl12 -sid orcl12 -characterSet ZHS16GBK \</span>
<span class="line">-createAsContainerDatabase true \</span>
<span class="line">-sysPassword Center08 -systemPassword Center08</span>
</pre></td></tr></table></figure>
<h2 id="对于环境安装过程中的问题总结"><a href="#对于环境安装过程中的问题总结" class="headerlink" title="对于环境安装过程中的问题总结"></a>对于环境安装过程中的问题总结</h2><h3 id="卸载已有的数据库软件"><a href="#卸载已有的数据库软件" class="headerlink" title="卸载已有的数据库软件"></a>卸载已有的数据库软件</h3><h4 id="使用deinstall工具"><a href="#使用deinstall工具" class="headerlink" title="使用deinstall工具"></a>使用deinstall工具</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd $ORACLE_HOME/deinstall</span>
<span class="line">./deinstall</span>
</pre></td></tr></table></figure>
<h4 id="手工删除"><a href="#手工删除" class="headerlink" title="手工删除"></a>手工删除</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ep -ef | <span class="keyword">grep</span> smon</span>
<span class="line"></span>
<span class="line"><span class="comment"># shutdown数据库</span></span>
<span class="line">sqlplus / as sysdba</span>
<span class="line"><span class="keyword">shutdown</span> abort</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除相应的数据文件和参数文件（可选）</span></span>
<span class="line">$ORACLE_BASE/oradata</span>
<span class="line">$ORACLE_HOME/dbs</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除相应的配置文件(root用户)，多实例时作相应的修改</span></span>
<span class="line">/etc/oratab</span>
<span class="line">/etc/oraInst.loc</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除ORACLE_HOME</span></span>
<span class="line"><span class="comment"># 修改oraInventory</span></span>
</pre></td></tr></table></figure>
<h3 id="ORACLE的补丁CPU-PSU"><a href="#ORACLE的补丁CPU-PSU" class="headerlink" title="ORACLE的补丁CPU/PSU"></a>ORACLE的补丁CPU/PSU</h3><ul>
<li>Oracle CPU的全称是Critical Patch Update, Oracle对于其产品每个季度发行一次安全补丁包，通常是为了修复产品中的安全隐患。</li>
<li>Oracle PSU的全称是Patch Set Update，Oracle对于其产品每个季度发行一次的补丁包，包含了bug的修复。Oracle选取被用户下载数量多，且被验证过具有较低风险的补丁放入到每个季度的PSU中。在每个PSU中不但包含Bug的修复而且还包含了最新的CPU。PSU通常随CPU一起发布。</li>
<li>2016年1月份Oracle推出了对 PSU、SPU、Bundle Patch 新的命名规则。新的命名规则为（以11.2.0.4为例）：11.2.0.4.YYMMDD。YYMMDD 会对应为patch （PSU、SPU、Bundle）发布的具体日期。具体可以参见MOS文档（Doc ID 1454618.1）</li>
</ul>
<h3 id="数据库软件克隆安装方法"><a href="#数据库软件克隆安装方法" class="headerlink" title="数据库软件克隆安装方法"></a>数据库软件克隆安装方法</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 解压压缩包后(物理拷贝)进行编译(relink)，方法如下</span></span>
<span class="line"><span class="comment">## 10g</span></span>
<span class="line">$ORACLE_HOME/oui/bin/runInstaller -clone -silent -ignorePreReq ORACLE_HOME=<span class="string">"$ORACLE_HOME"</span> ORACLE_HOME_NAME=<span class="string">"OraDb12c_home1"</span></span>
<span class="line"></span>
<span class="line"><span class="comment">## 11g,12c</span></span>
<span class="line">cd $ORACLE_HOME/clone/bin</span>
<span class="line">perl clone.pl ORACLE_BASE=$ORACLE_BASE ORACLE_HOME=$ORACLE_HOME ORACLE_HOME_NAME=OraDb12c_home1</span>
</pre></td></tr></table></figure>
<h3 id="建库模板"><a href="#建库模板" class="headerlink" title="建库模板"></a>建库模板</h3><p>模板类型主要有seed和noseed两种，主要的区别在于是否包含数据文件。简单来说，seed就是从RMAN备份中恢复数据库，由于是恢复所以也不能做其他更多的定制修改，但是最大的特点是创建速度快，OLTP和OLAP的模板就属于seed模板类型；而“定制数据库”则属于nonseed模板，不包含数据文件，需要使用create database命令创建数据库，创建时间要稍微长一些，对于大部分系统业务来说，需要根据自己的需求来选择合适的模板类型。</p>
]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle 12c特性解读-容器数据库和灾备-01 Oracle 12c体系结构]]></title>
      <url>/2017/05/05/oracle/Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/01_Oracle_12c%E7%89%B9%E6%80%A7%E8%A7%A3%E8%AF%BB-%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E7%81%BE%E5%A4%87/</url>
      <content type="html"><![CDATA[<h2 id="安装部署12c"><a href="#安装部署12c" class="headerlink" title="安装部署12c"></a>安装部署12c</h2><h3 id="官网下载12cr2的安装包"><a href="#官网下载12cr2的安装包" class="headerlink" title="官网下载12cr2的安装包"></a>官网下载12cr2的安装包</h3><p>下载地址：<a href="http://www.oracle.com/technetwork/database/enterprise-edition/downloads/index.html" target="_blank" rel="external">http://www.oracle.com/technetwork/database/enterprise-edition/downloads/index.html </a><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_01.png" alt=""></p>
<p>有MOS帐号也可以去edelivery下载：<a href="https://edelivery.oracle.com" target="_blank" rel="external">https://edelivery.oracle.com</a></p>
<a id="more"></a>
<h3 id="系统环境要求RHEL6或者以上，Oracle-Enterprise-Linux也可以。"><a href="#系统环境要求RHEL6或者以上，Oracle-Enterprise-Linux也可以。" class="headerlink" title="系统环境要求RHEL6或者以上，Oracle Enterprise Linux也可以。"></a>系统环境要求RHEL6或者以上，Oracle Enterprise Linux也可以。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /etc/redhat-release</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">Red Hat Enterprise Linux Server release <span class="number">7.3</span> (Maipo)</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="使用图形方式安装部署，给出基本的步骤和错误总结"><a href="#使用图形方式安装部署，给出基本的步骤和错误总结" class="headerlink" title="使用图形方式安装部署，给出基本的步骤和错误总结"></a>使用图形方式安装部署，给出基本的步骤和错误总结</h3><h4 id="Hardware-Checklist"><a href="#Hardware-Checklist" class="headerlink" title="Hardware Checklist"></a>Hardware Checklist</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">df -hT</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">Filesystem           Type   Size  Used Avail Use% Mounted on</span>
<span class="line">/dev/mapper/VolGroup-lv_root</span>
<span class="line">                     ext4    <span class="number">43</span>G  <span class="number">3.2</span>G   <span class="number">38</span>G   <span class="number">8</span>% <span class="regexp">/</span>
<span class="line">tmpfs                tmpfs  3.9G   72K  3.9G   1% /dev</span><span class="regexp">/shm</span>
<span class="line">/dev</span><span class="regexp">/sda1            ext4   477M   82M  366M  19% /boot</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">free</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">              total        used        free      shared  buff/cache   available</span>
<span class="line">Mem:        <span class="number">8174072</span>      <span class="number">124584</span>     <span class="number">7913700</span>        <span class="number">8676</span>      <span class="number">135788</span>     <span class="number">7973288</span></span>
<span class="line">Swap:      <span class="number">16777212</span>           <span class="number">0</span>    <span class="number">16777212</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">cat /proc/cpuinfo</span>
<span class="line"></span>
<span class="line">cat /sys/kernel/mm/transparent_hugepage/enabled</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">always madvise [never]      <span class="comment"># 停用transparent hugepage</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="Operating-System-Checklist"><a href="#Operating-System-Checklist" class="headerlink" title="Operating System Checklist"></a>Operating System Checklist</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查安装依赖包</span></span>
<span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line">mount /dev/cdrom /media/disk</span>
<span class="line">cp /etc/yum.repos.d/public-yum-ol7.repo /etc/yum.repos.d/public-yum-ol7.repo_old</span>
<span class="line">vi /etc/yum.repos.d/public-yum-ol7.repo</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">[ol7_latest]</span>
<span class="line">name=Oracle Linux $releasever Latest ($basearch)</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span></span>
<span class="line">gpgcheck=<span class="number">0</span></span>
<span class="line">enabled=<span class="number">1</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">yum -<span class="keyword">y</span> install oracle-database-server-<span class="number">12</span>cR2-preinstall.x86_64</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置IP/HOSTS</span></span>
<span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens16<span class="number">0</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">TYPE=Ethernet</span>
<span class="line">BOOTPROTO=static</span>
<span class="line">DEFROUTE=yes</span>
<span class="line">PEERDNS=yes</span>
<span class="line">PEERROUTES=yes</span>
<span class="line">IPV4_FAILURE_FATAL=<span class="keyword">no</span></span>
<span class="line">IPV6INIT=<span class="keyword">no</span></span>
<span class="line">IPV6_AUTOCONF=yes</span>
<span class="line">IPV6_DEFROUTE=yes</span>
<span class="line">IPV6_PEERDNS=yes</span>
<span class="line">IPV6_PEERROUTES=yes</span>
<span class="line">IPV6_FAILURE_FATAL=<span class="keyword">no</span></span>
<span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span>
<span class="line">NAME=ens16<span class="number">0</span></span>
<span class="line">UUID=<span class="number">198</span>f69b3-<span class="number">91</span>b8-<span class="number">4</span>b19-<span class="number">9312</span>-<span class="number">50</span>b3a75820a7</span>
<span class="line">DEVICE=ens16<span class="number">0</span></span>
<span class="line">ONBOOT=yes</span>
<span class="line">IPADDR=<span class="number">10.245</span>.<span class="number">231.205</span></span>
<span class="line">PREFIX=<span class="number">24</span></span>
<span class="line">GATEWAY=<span class="number">10.245</span>.<span class="number">231.254</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">vi /etc/hosts</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="number">10.245</span>.<span class="number">231.205</span> orcl12</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置主机名</span></span>
<span class="line">hostnamectl --static set-hostname orcl12</span>
<span class="line"></span>
<span class="line"><span class="comment"># 禁用SELINUX</span></span>
<span class="line">setenforce <span class="number">0</span></span>
<span class="line">vi /etc/selinux/config</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line">SELINUX=disabled</span>
<span class="line"><span class="comment">#-----------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 禁用防火墙</span></span>
<span class="line">systemctl stop firewalld</span>
<span class="line">systemctl disable firewalld</span>
<span class="line">systemctl status firewalld</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置内核参数</span></span>
<span class="line">vi /etc/sysctl.conf </span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">vm.nr_hugepages=<span class="number">3072</span></span>
<span class="line"><span class="comment"># sga_target=5G  大页的内存要大于SGA大小  计算方法：5G+1G=6G=6*1024M / 2=3072</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">sysctl -p</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.shmall = <span class="number">1073741824</span></span>
<span class="line">kernel.shmmax = <span class="number">4398046511104</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">net.ipv4.conf.all.rp_filter = <span class="number">2</span></span>
<span class="line">net.ipv4.conf.default.rp_filter = <span class="number">2</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">vi /etc/security/limits.conf</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">oracle   soft   nofile    <span class="number">1024</span></span>
<span class="line">oracle   hard   nofile    <span class="number">65536</span></span>
<span class="line">oracle   soft   nproc     <span class="number">2047</span></span>
<span class="line">oracle   hard   nproc     <span class="number">16384</span></span>
<span class="line">oracle   soft   stack     <span class="number">10240</span></span>
<span class="line">oracle   hard   stack     <span class="number">32768</span></span>
<span class="line">oracle   hard   memlock   unlimited</span>
<span class="line">oracle   soft   memlock   unlimited</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 安装常用工具</span></span>
<span class="line">yum -<span class="keyword">y</span> install kernel-devel <span class="keyword">readline</span>-devel.x86_64  tigervnc-server.x86_64 lrzsz gcc</span>
<span class="line">yum -<span class="keyword">y</span> localinstall --nogpgcheck jdk-<span class="number">8</span>u131-linux-x64.rpm</span>
<span class="line">java -version</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">java version <span class="string">"1.8.0_131"</span></span>
<span class="line">Java(TM) SE Runtime Environment (build <span class="number">1.8</span>.<span class="number">0_131</span>-b11)</span>
<span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM (build <span class="number">25.131</span>-b11, mixed mode)</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">tar xvpf rlwrap-<span class="number">0</span>.<span class="number">42</span>.tar.gz </span>
<span class="line">cd rlwrap-<span class="number">0</span>.<span class="number">42</span></span>
<span class="line">./configure</span>
<span class="line">make &amp;&amp; make install</span>
</pre></td></tr></table></figure>
<h4 id="Oracle-User-Environment-Configuration"><a href="#Oracle-User-Environment-Configuration" class="headerlink" title="Oracle User Environment Configuration"></a>Oracle User Environment Configuration</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">id oracle</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">uid=<span class="number">54321</span>(oracle) gid=<span class="number">54321</span>(oinstall) groups=<span class="number">54321</span>(oinstall),<span class="number">54322</span>(dba)</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">echo <span class="string">"oracle"</span> | passwd --stdin oracle</span>
<span class="line"></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/app/oracle</span>
<span class="line"><span class="keyword">chown</span> -R oracle:oinstall /u01</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">775</span> /u01/</span>
<span class="line"></span>
<span class="line">vi /home/oracle/.bash_profile</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">export ORACLE_SID=orcl12</span>
<span class="line">export ORACLE_BASE=<span class="regexp">/u01/app</span><span class="regexp">/oracle</span>
<span class="line">export ORACLE_HOME=$ORACLE_BASE/product</span><span class="regexp">/12.2.0/db</span>_1</span>
<span class="line">export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin:$ORACLE_HOME/OPatch:<span class="regexp">/usr/local</span><span class="regexp">/bin</span>
<span class="line">export LD_LIBRARY_PATH=$ORACLE_HOME/lib</span>:$LD_LIBRARY_PATH</span>
<span class="line">export NLS_LANG=AMERICAN_AMERICA.ZHS16GBK</span>
<span class="line">export NLS_DATE_FORMAT=<span class="string">'yyyy/mm/dd hh24:mi:ss'</span></span>
<span class="line"></span>
<span class="line">alias sqlplus=<span class="string">'rlwrap sqlplus'</span></span>
<span class="line">alias rman=<span class="string">'rlwrap rman'</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="Installing-and-Configuring-Oracle-Database"><a href="#Installing-and-Configuring-Oracle-Database" class="headerlink" title="Installing and Configuring Oracle Database"></a>Installing and Configuring Oracle Database</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">su - oracle</span>
<span class="line"></span>
<span class="line"><span class="comment"># 进入解压后的数据库安装文件目录，客户端打开xmanager</span></span>
<span class="line">cd database</span>
<span class="line">export DISPLAY=<span class="number">10.245</span>.<span class="number">4.90</span>:<span class="number">0</span>.<span class="number">0</span></span>
<span class="line">./runInstaller</span>
</pre></td></tr></table></figure>
<p>先安装数据库软件<br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_02.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_03.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_04.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_05.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_06.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_07.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_08.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_09.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_10.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_11.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_12.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_13.png" alt=""></p>
<p>创建数据库<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dbca</span>
</pre></td></tr></table></figure></p>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_14.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_15.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_16.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_17.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_18.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_19.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_20.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_21.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_22.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_23.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_24.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_25.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_26.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_27.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_28.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_29.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0505_oracle12c_install_30.png" alt=""></p>
<h3 id="安装成功的基本检查"><a href="#安装成功的基本检查" class="headerlink" title="安装成功的基本检查"></a>安装成功的基本检查</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">[oracle@orcl12 database]$ sqlplus / as sysdba</span>
<span class="line"></span>
<span class="line">SQL*Plus: Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> Production on Fri May <span class="number">5</span> <span class="number">18</span>:<span class="number">57</span>:<span class="number">32</span> <span class="number">2017</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1982</span>, <span class="number">2016</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Connected to:</span>
<span class="line">Oracle Database <span class="number">12</span>c Enterprise Edition Release <span class="number">12.2</span>.<span class="number">0</span>.<span class="number">1.0</span> - <span class="number">64</span>bit Production</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> name, cdb from v$database;</span>
<span class="line"></span>
<span class="line">NAME      CDB</span>
<span class="line">--------- ---</span>
<span class="line">ORCL12    YES</span>
<span class="line"></span>
<span class="line">SQL&gt; set line <span class="number">100</span></span>
<span class="line">SQL&gt; col NAME <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> con_id, name from v$containers;</span>
<span class="line"></span>
<span class="line">    CON_ID NAME</span>
<span class="line">---------- --------------------------------------------------</span>
<span class="line">         <span class="number">1</span> CDB$ROOT</span>
<span class="line">         <span class="number">2</span> PDB$SEED</span>
<span class="line">         <span class="number">3</span> POS</span>
<span class="line"></span>
<span class="line">SQL&gt; col file_name <span class="keyword">for</span> a8<span class="number">0</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> con_id, file_name from cdb_data_files order by <span class="number">1</span>;</span>
<span class="line"></span>
<span class="line">    CON_ID FILE_NAME</span>
<span class="line">---------- --------------------------------------------------------------------------------</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl12/system01.dbf</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl12/users01.dbf</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl12/undotbs01.dbf</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl12/sysaux01.dbf</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl12/<span class="keyword">pos</span>/system01.dbf</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl12/<span class="keyword">pos</span>/users01.dbf</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl12/<span class="keyword">pos</span>/undotbs01.dbf</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl12/<span class="keyword">pos</span>/sysaux01.dbf</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle 12c特性解读-容器数据库和灾备 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL-DBA从小白到大神实战-15 MySQL源码初探]]></title>
      <url>/2017/05/02/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/15-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="通过gdb工具分析mysqld进程启动的过程"><a href="#通过gdb工具分析mysqld进程启动的过程" class="headerlink" title="通过gdb工具分析mysqld进程启动的过程"></a>通过gdb工具分析mysqld进程启动的过程</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">gdb --args /u01/mysql/bin/mysqld</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------</span></span>
<span class="line">GNU gdb (GDB) Red Hat Enterprise Linux (<span class="number">7.2</span>-<span class="number">90</span>.el6)</span>
<span class="line">Copyright (C) <span class="number">2010</span> Free Software Foundation, Inc.</span>
<span class="line">License GPLv3+: GNU GPL version <span class="number">3</span> <span class="keyword">or</span> later &lt;http:<span class="regexp">//gnu</span>.org/licenses/gpl.html&gt;</span>
<span class="line">This is free software: you are free to change <span class="keyword">and</span> redistribute it.</span>
<span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span>
<span class="line"><span class="keyword">and</span> <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span>
<span class="line">This GDB was configured as <span class="string">"x86_64-redhat-linux-gnu"</span>.</span>
<span class="line">For bug reporting instructions, please see:</span>
<span class="line">&lt;http:<span class="regexp">//www</span>.gnu.org/software/gdb/bugs/&gt;...</span>
<span class="line">Reading symbols from /u01/mysql/bin/mysqld...done.</span>
<span class="line">(gdb) b mysqld_main   <span class="comment"># 设置断点</span></span>
<span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x58c0e4</span>: file /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span>/sql/mysqld.cc, line <span class="number">5245</span>.</span>
<span class="line">(gdb) r   <span class="comment"># 运行</span></span>
<span class="line">Starting program: <span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysqld</span> </span>
<span class="line">[Thread debugging using libthread_db enabled]</span>
<span class="line"></span>
<span class="line">Breakpoint <span class="number">1</span>, mysqld_main (argc=<span class="number">1</span>, argv=<span class="number">0x7fffffffe668</span>) at /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span>/sql/mysqld.cc:<span class="number">5245</span></span>
<span class="line"><span class="number">5245</span>    &#123;</span>
<span class="line">Missing separate debuginfos, <span class="keyword">use</span>: debuginfo-install glibc-<span class="number">2.12</span>-<span class="number">1.192</span>.el6.x86_64 keyutils-libs-<span class="number">1.4</span>-<span class="number">5.0</span>.<span class="number">1</span>.el6.x86_64 </span>
<span class="line">krb5-libs-<span class="number">1.10</span>.<span class="number">3</span>-<span class="number">57</span>.el6.x86_64 libcom_err-<span class="number">1.42</span>.<span class="number">8</span>-<span class="number">1.0</span>.<span class="number">2</span>.el6.x86_64 libgcc-<span class="number">4.4</span>.<span class="number">7</span>-<span class="number">17</span>.el6.x86_64 </span>
<span class="line">libselinux-<span class="number">2.0</span>.<span class="number">94</span>-<span class="number">7</span>.el6.x86_64  libstdc++-<span class="number">4.4</span>.<span class="number">7</span>-<span class="number">17</span>.el6.x86_64 nss-softokn-freebl-<span class="number">3.14</span>.<span class="number">3</span>-<span class="number">23</span>.el6_7.x86_64 </span>
<span class="line">openssl-<span class="number">1.0</span>.<span class="number">1</span>e-<span class="number">48</span>.el6.x86_64 zlib-<span class="number">1.2</span>.<span class="number">3</span>-<span class="number">29</span>.el6.x86_64</span>
<span class="line">(gdb) n   <span class="comment"># 向下</span></span>
<span class="line"><span class="number">5250</span>      my_progname= argv[<span class="number">0</span>];</span>
<span class="line">(gdb) n</span>
<span class="line"><span class="number">5254</span>      <span class="keyword">if</span> (my_init())                 // init my_sys library &amp; pthreads</span>
<span class="line">(gdb) <span class="keyword">s</span>   <span class="comment"># 看源码位置</span></span>
<span class="line">my_init () at /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span>/mysys/my_init.c:<span class="number">69</span></span>
<span class="line"><span class="number">69</span>        <span class="keyword">if</span> (my_init_done)</span>
<span class="line">(gdb) n</span>
<span class="line"><span class="number">74</span>        my_umask= <span class="number">0660</span>;                       <span class="regexp">/* Default umask for new files */</span></span>
<span class="line">(gdb) n</span>
<span class="line"><span class="number">75</span>        my_umask_dir= <span class="number">0700</span>;                   <span class="regexp">/* Default umask for new directories */</span></span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<a id="more"></a>
<p>查看<code>/u01/mysql-5.6.35/sql/mysqld.cc</code>的line 5245<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">&#123;</span>
<span class="line">  <span class="regexp">/*</span>
<span class="line">    Perform basic thread library and malloc initialization,</span>
<span class="line">    to be able to read defaults files and parse options.</span>
<span class="line">  */</span></span>
<span class="line">  my_progname= argv[<span class="number">0</span>];</span>
</pre></td></tr></table></figure></p>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><h3 id="MySQL代码结构"><a href="#MySQL代码结构" class="headerlink" title="MySQL代码结构"></a>MySQL代码结构</h3><ol>
<li><strong>Client：客户端工具集合</strong><br>比如mysql，mysqldump，mysqlbinlog等等</li>
<li><strong>Myisam：myisam引擎相关的代码</strong><br>mi_open.c：打开文件<br>mi_close.c：关闭文件<br>mi_update.c：更新记录</li>
<li><strong>Mysys：系统工具代码</strong><br>比如charset.c，mf_qsort.c等</li>
<li><strong>Sql：MySQL核心代码</strong><br>sql_lex.cc：词法解析<br>sql_yacc.yy: 语法解析<br>sql_select.c, sql_update, sql_delete.c, sql_insert.c等文件</li>
<li><strong>Vio：网络通信代码</strong><br>viosocket.c：socket通信</li>
<li><strong>第三方开源库</strong><br>Dbug，pstack，regex，strings，zlib</li>
<li><strong>Innobase</strong><br>InnoDB引擎代码</li>
<li><strong>Mysql-test</strong><br>MySQL testcase</li>
<li><strong>Scripts</strong><br>mysql_install_db，mysql_system_tables.sql</li>
<li><strong>win</strong><br>windows用到的</li>
</ol>
<h3 id="源码查看工具sourceinsight"><a href="#源码查看工具sourceinsight" class="headerlink" title="源码查看工具sourceinsight"></a>源码查看工具sourceinsight</h3><p>下载地址：<a href="http://pan.baidu.com/s/1bprLzZL" target="_blank" rel="external">http://pan.baidu.com/s/1bprLzZL </a></p>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL-DBA从小白到大神实战-14 运维MySQL过程中线上故障分析与排查]]></title>
      <url>/2017/04/25/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/14-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="MySQL常见故障"><a href="#MySQL常见故障" class="headerlink" title="MySQL常见故障"></a>MySQL常见故障</h2><ol>
<li>数据库连接数爆满</li>
<li>大事务导致数据库挂死</li>
<li>MySQL 主库crash</li>
<li>大规模行锁竞争</li>
<li>线上执行update报错</li>
<li>主从库不一致,复制中止<a id="more"></a>
</li>
</ol>
<h2 id="重现故障5，并处理"><a href="#重现故障5，并处理" class="headerlink" title="重现故障5，并处理"></a>重现故障5，并处理</h2><h3 id="构建测试环境数据"><a href="#构建测试环境数据" class="headerlink" title="构建测试环境数据"></a>构建测试环境数据</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/insert.lua \</span>
<span class="line">--oltp-table-size=<span class="number">10000000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=lyj \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">1</span> --report-interval=<span class="number">10</span> --threads=<span class="number">1</span> prepare</span>
<span class="line"></span>
<span class="line"><span class="comment"># 主从库查看表数据</span></span>
<span class="line">mysql&gt; <span class="keyword">select</span> count(*) from sbtest1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">| <span class="number">10000000</span> |</span>
<span class="line">+----------+</span>
</pre></td></tr></table></figure>
<h3 id="修改主从库innodb-buffer-pool-size的值"><a href="#修改主从库innodb-buffer-pool-size的值" class="headerlink" title="修改主从库innodb_buffer_pool_size的值"></a>修改主从库innodb_buffer_pool_size的值</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%innodb_buffer_pool_size%'</span>;</span>
<span class="line">+-------------------------+-----------+</span>
<span class="line">| Variable_name           | Value     |</span>
<span class="line">+-------------------------+-----------+</span>
<span class="line">| innodb_buffer_pool_size | <span class="number">134217728</span> |  <span class="comment"># 原先是128M</span></span>
<span class="line">+-------------------------+-----------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭主从数据库修改参数文件中的值</span></span>
<span class="line">vi /u01/conf/my3306.cnf</span>
<span class="line">innodb_buffer_pool_size= <span class="number">1</span>M</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动主从数据库后查看参数值</span></span>
<span class="line">show variables like <span class="string">'%innodb_buffer_pool_size%'</span>;</span>
<span class="line">+-------------------------+---------+</span>
<span class="line">| Variable_name           | Value   |</span>
<span class="line">+-------------------------+---------+</span>
<span class="line">| innodb_buffer_pool_size | <span class="number">5242880</span> |   <span class="comment"># 虽在my3306.cnf参数中设置成1M，但设置成小于5M时，仍会变为5M</span></span>
<span class="line">+-------------------------+---------+</span>
</pre></td></tr></table></figure>
<h3 id="在主库执行批量更新语句报错"><a href="#在主库执行批量更新语句报错" class="headerlink" title="在主库执行批量更新语句报错"></a>在主库执行批量更新语句报错</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; update sbtest1 set pad=<span class="string">'408658831-01630576472-82254536572-63286619302-57396238088'</span> where id&gt;<span class="number">5000</span> <span class="keyword">and</span> id&lt;<span class="number">10000000</span>;</span>
<span class="line">mysql&gt; ERROR <span class="number">1206</span> (HY00<span class="number">0</span>): The total number of locks exceeds the lock table size    <span class="comment"># 出现报错信息</span></span>
</pre></td></tr></table></figure>
<h3 id="解决故障"><a href="#解决故障" class="headerlink" title="解决故障"></a>解决故障</h3><p>1.关闭从库，修改innodb_buffer_pool_size后重启<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /u01/conf/my3306.cnf</span>
<span class="line">innodb_buffer_pool_size= <span class="number">2</span>G</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启查看参数修改已生效</span></span>
<span class="line">show variables like <span class="string">'%innodb_buffer_pool_size%'</span>;</span>
<span class="line">+-------------------------+------------+</span>
<span class="line">| Variable_name           | Value      |</span>
<span class="line">+-------------------------+------------+</span>
<span class="line">| innodb_buffer_pool_size | <span class="number">2147483648</span> |</span>
<span class="line">+-------------------------+------------+</span>
</pre></td></tr></table></figure></p>
<p>2.登陆mha server在线切换主从库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看mha状态</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">app (pid:<span class="number">7760</span>) is running(<span class="number">0</span>:PING_OK), master:mydb1</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在主库mydb1上</span></span>
<span class="line">set global event_scheduler=off;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在mha server上关闭管理进程并切换</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_stop --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_master_switch --master_state=alive --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line">Wed Apr <span class="number">26</span> <span class="number">17</span>:<span class="number">41</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="string">'mydb2 or 10.245.231.203'</span>, MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE=<span class="string">'binlog.000019'</span>, MASTER_LOG_POS=<span class="number">120</span>, MASTER_USER=<span class="string">'rep'</span>, MASTER_PASSWORD=<span class="string">'xxx'</span>;</span>
<span class="line"></span>
<span class="line">Wed Apr <span class="number">26</span> <span class="number">17</span>:<span class="number">41</span>:<span class="number">47</span> <span class="number">2017</span> - [info] Switching master to mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) completed successfully</span>
<span class="line">...</span>
<span class="line"><span class="comment">#------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看新主库状态</span></span>
<span class="line">mysql&gt; show master status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">00001</span>9</span>
<span class="line">         Position: <span class="number">120</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在新从库上开启同步</span></span>
<span class="line">CHANGE MASTER TO</span>
<span class="line">  MASTER_HOST=<span class="string">'10.245.231.203'</span>,</span>
<span class="line">  MASTER_PORT=<span class="number">3306</span>,</span>
<span class="line">  MASTER_LOG_FILE=<span class="string">'binlog.000019'</span>,</span>
<span class="line">  MASTER_LOG_POS=<span class="number">120</span>,</span>
<span class="line">  MASTER_USER=<span class="string">'rep'</span>,</span>
<span class="line">  MASTER_PASSWORD=<span class="string">'rep123'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动同步</span></span>
<span class="line">start slave;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 显示从库状态</span></span>
<span class="line">mysql&gt; show slave status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.203</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">00001</span>9</span>
<span class="line">          Read_Master_Log_Pos: <span class="number">120</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">280</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">00001</span>9</span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: Yes</span>
<span class="line">.....</span>
</pre></td></tr></table></figure></p>
<p>3.关闭新从库（原主库），修改innodb_buffer_pool_size后重启<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /u01/conf/my3306.cnf</span>
<span class="line">innodb_buffer_pool_size= <span class="number">2</span>G</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启查看参数修改已生效</span></span>
<span class="line">show variables like <span class="string">'%innodb_buffer_pool_size%'</span>;</span>
<span class="line">+-------------------------+------------+</span>
<span class="line">| Variable_name           | Value      |</span>
<span class="line">+-------------------------+------------+</span>
<span class="line">| innodb_buffer_pool_size | <span class="number">2147483648</span> |</span>
<span class="line">+-------------------------+------------+</span>
</pre></td></tr></table></figure></p>
<p>4.重复步骤2<br>5.执行批量update<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">use</span> lyj</span>
<span class="line">mysql&gt; update sbtest1 set pad=<span class="string">'408658831-01630576472-82254536572-63286619302-57396238088'</span> where id&gt;<span class="number">5000</span> <span class="keyword">and</span> id&lt;<span class="number">10000000</span>;</span>
<span class="line">ERROR <span class="number">1197</span> (HY00<span class="number">0</span>): Multi-statement transaction required more than <span class="string">'max_binlog_cache_size'</span> bytes of storage; increase this mysqld variable <span class="keyword">and</span> try again   <span class="comment"># 又出现报错</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 按上面步骤修改max_binlog_cache_size的大小</span></span>
<span class="line">show variables like <span class="string">'%max_binlog_cache_size%'</span>;</span>
<span class="line">+-----------------------+------------+</span>
<span class="line">| Variable_name         | Value      |</span>
<span class="line">+-----------------------+------------+</span>
<span class="line">| max_binlog_cache_size | <span class="number">4294967296</span> |</span>
<span class="line">+-----------------------+------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 再次执行更新</span></span>
<span class="line">mysql&gt; update sbtest1 set pad=<span class="string">'408658831-01630576472-82254536572-63286619302-57396238088'</span> where id&gt;<span class="number">5000</span> <span class="keyword">and</span> id&lt;<span class="number">10000000</span>;</span>
<span class="line">Query OK, <span class="number">9994999</span> rows affected (<span class="number">2</span> min <span class="number">24.62</span> sec)</span>
<span class="line">Rows matched: <span class="number">9994999</span>  Changed: <span class="number">9994999</span>  Warnings: <span class="number">0</span></span>
</pre></td></tr></table></figure></p>
<h2 id="请给出MySQL数据丢失的最佳解决方案"><a href="#请给出MySQL数据丢失的最佳解决方案" class="headerlink" title="请给出MySQL数据丢失的最佳解决方案"></a>请给出MySQL数据丢失的最佳解决方案</h2><h3 id="误删除导致丢失数据的解决方案"><a href="#误删除导致丢失数据的解决方案" class="headerlink" title="误删除导致丢失数据的解决方案"></a>误删除导致丢失数据的解决方案</h3><p>利用备份和mysqlbinlog工具进行恢复</p>
<h3 id="宕机导致InnoDB事务数据丢失数据的解决方案"><a href="#宕机导致InnoDB事务数据丢失数据的解决方案" class="headerlink" title="宕机导致InnoDB事务数据丢失数据的解决方案"></a>宕机导致InnoDB事务数据丢失数据的解决方案</h3><ol>
<li>设置<code>innodb_flush_log_at_trx_commit = 1</code>，在每次事务提交的时候，都把log buffer刷到文件系统中去，并且调用文件系统的<code>flush</code>操作将缓存刷新到磁盘上去，最大限度保证事务的redo日志刷到磁盘。</li>
<li>设置<code>sync_binlog = 1</code>，在每次事务提交之后，MySQL将进行一次fsync之类的磁盘同步指令来将binlog_cache中的数据强制写入磁盘。即使系统Crash，也最多丢失binlog_cache中未完成的一个事务。</li>
</ol>
<h3 id="数据库复制导致数据丢失的解决方案"><a href="#数据库复制导致数据丢失的解决方案" class="headerlink" title="数据库复制导致数据丢失的解决方案"></a>数据库复制导致数据丢失的解决方案</h3><p>确保binlog全部传到从库</p>
<ol>
<li>使用semi sync（半同步）方式，事务提交后，必须要传到slave，事务才能算结束。对性能影响很大，依赖网络适合小tps系统。</li>
<li>双写binlog，通过DBDR OS层的文件系统复制到备机，或者使用共享盘保存binlog日志。</li>
<li>在数据层做文章，比如保证数据库写成功后，再异步队列的方式写一份，部分业务可以借助设计和数据流解决</li>
</ol>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-13 深入分析Online DDL原理]]></title>
      <url>/2017/04/21/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/13-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="用oak对表sbtest1做添加字段和增加索引的Online-DDL"><a href="#用oak对表sbtest1做添加字段和增加索引的Online-DDL" class="headerlink" title="用oak对表sbtest1做添加字段和增加索引的Online DDL"></a>用oak对表sbtest1做添加字段和增加索引的Online DDL</h2><h3 id="用sysbench工具准备测试环境"><a href="#用sysbench工具准备测试环境" class="headerlink" title="用sysbench工具准备测试环境"></a>用sysbench工具准备测试环境</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建数据库</span></span>
<span class="line">mysql&gt; create database lyj;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 用sysbench工具准备测试环境</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/insert.lua \</span>
<span class="line">--oltp-table-size=<span class="number">1000000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=lyj \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">2</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> prepare</span>
<span class="line"></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/insert.lua \</span>
<span class="line">--oltp-table-size=<span class="number">1000000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=lyj \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">2</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> run</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="查看测试数据及表结构"><a href="#查看测试数据及表结构" class="headerlink" title="查看测试数据及表结构"></a>查看测试数据及表结构</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">use</span> lyj</span>
<span class="line">mysql&gt; <span class="keyword">select</span> count(*) from sbtest1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|  <span class="number">1000000</span> |</span>
<span class="line">+----------+</span>
<span class="line"></span>
<span class="line">mysql&gt; desc sbtest1;</span>
<span class="line">+-------+------------------+------+-----+---------+----------------+</span>
<span class="line">| Field | Type             | Null | Key | Default | Extra          |</span>
<span class="line">+-------+------------------+------+-----+---------+----------------+</span>
<span class="line">| id    | <span class="keyword">int</span>(<span class="number">10</span>) unsigned | NO   | PRI | NULL    | auto_increment |</span>
<span class="line">| k     | <span class="keyword">int</span>(<span class="number">10</span>) unsigned | NO   | MUL | <span class="number">0</span>       |                |</span>
<span class="line">| c     | char(<span class="number">120</span>)        | NO   |     |         |                |</span>
<span class="line">| pad   | char(<span class="number">60</span>)         | NO   |     |         |                |</span>
<span class="line">+-------+------------------+------+-----+---------+----------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; show create table sbtest1\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">       Table: sbtest1</span>
<span class="line">Create Table: CREATE TABLE <span class="string">`sbtest1`</span> (</span>
<span class="line">  <span class="string">`id`</span> <span class="keyword">int</span>(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span>
<span class="line">  <span class="string">`k`</span> <span class="keyword">int</span>(<span class="number">10</span>) unsigned NOT NULL DEFAULT <span class="string">'0'</span>,</span>
<span class="line">  <span class="string">`c`</span> char(<span class="number">120</span>) NOT NULL DEFAULT <span class="string">''</span>,</span>
<span class="line">  <span class="string">`pad`</span> char(<span class="number">60</span>) NOT NULL DEFAULT <span class="string">''</span>,</span>
<span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span>
<span class="line">  KEY <span class="string">`k_1`</span> (<span class="string">`k`</span>)</span>
<span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1176193</span> DEFAULT CHARSET=utf8 MAX_ROWS=<span class="number">1000000</span></span>
</pre></td></tr></table></figure>
<h3 id="下载OAK工具"><a href="#下载OAK工具" class="headerlink" title="下载OAK工具"></a>下载OAK工具</h3><p>OAK全称是Openark–kit，工具包其中的oak-online-alter-table小工具是用来实现Online DDL的。<br>官网地址：<a href="http://code.openark.org/forge/openark-kit" target="_blank" rel="external">http://code.openark.org/forge/openark-kit </a><br>google code在中国无法下载，国内下载地址：<a href="http://pan.baidu.com/s/1pLpuC91" target="_blank" rel="external">http://pan.baidu.com/s/1pLpuC91 </a></p>
<p>下载OAK工具包后解压<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">tar xvpf openark-kit-<span class="number">196</span>.tar.gz</span>
<span class="line">cd openark-kit-<span class="number">196</span>/scripts</span>
<span class="line">ll</span>
<span class="line">total <span class="number">240</span></span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span> <span class="number">11014</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-apply-ri</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span> <span class="number">10993</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-block-account</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span> <span class="number">23920</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-chunk-<span class="keyword">print</span></span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span> <span class="number">29484</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-chunk-update</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span>  <span class="number">5495</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-get-slave-lag</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span> <span class="number">18175</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-hook-general-<span class="keyword">log</span></span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span>  <span class="number">6308</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-<span class="keyword">kill</span>-slow-queries</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span>  <span class="number">5624</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-modify-charset</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span> <span class="number">39186</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-online-alter-table     <span class="comment"># 这个就是用来实现Online DDL的</span></span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span>  <span class="number">7803</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-prepare-<span class="keyword">shutdown</span></span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span> <span class="number">15039</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-purge-master-logs</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span>  <span class="number">8365</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-repeat-query</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span> <span class="number">19306</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-security-audit</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span>  <span class="number">5904</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-show-limits</span>
<span class="line">-rw-r--r-- <span class="number">1</span> <span class="number">1000</span> <span class="number">1000</span>  <span class="number">8648</span> May  <span class="number">6</span>  <span class="number">2013</span> oak-show-replication-status</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用这个工具，需要安装MySQL-python包</span></span>
<span class="line">yum -<span class="keyword">y</span> install MySQL-python</span>
</pre></td></tr></table></figure></p>
<h3 id="用oak对表sbtest1做添加字段和索引的Online-DDL"><a href="#用oak对表sbtest1做添加字段和索引的Online-DDL" class="headerlink" title="用oak对表sbtest1做添加字段和索引的Online DDL"></a>用oak对表sbtest1做添加字段和索引的Online DDL</h3><h4 id="确认该表是否符合oak-online-alter-table的执行条件"><a href="#确认该表是否符合oak-online-alter-table的执行条件" class="headerlink" title="确认该表是否符合oak-online-alter-table的执行条件"></a>确认该表是否符合oak-online-alter-table的执行条件</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 检查是否是单列唯一索引（联合索引和联合主键是不可以的）</span></span>
<span class="line">show create table sbtest1\G;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 检查有无触发器</span></span>
<span class="line">SELECT TRIGGER_SCHEMA,TRIGGER_NAME,EVENT_OBJECT_SCHEMA,EVENT_OBJECT_TABLE FROM information_schema.TRIGGERS</span>
<span class="line">  WHERE event_object_schema= <span class="string">'lyj'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 检查有无外键</span></span>
<span class="line"><span class="keyword">select</span> * from information_schema.key_column_usage </span>
<span class="line"> where table_schema=<span class="string">'lyj'</span> <span class="keyword">and</span> table_name=<span class="string">'sbtest1'</span> <span class="keyword">and</span> referenced_table_name is <span class="keyword">not</span> null;</span>
<span class="line"><span class="keyword">select</span> * from information_schema.key_column_usage</span>
<span class="line">  where referenced_table_schema=<span class="string">'lyj'</span> <span class="keyword">and</span> referenced_table_name=<span class="string">'sbtest1'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 要确保无大查询</span></span>
</pre></td></tr></table></figure>
<h4 id="用OAK执行Online-DDL脚本"><a href="#用OAK执行Online-DDL脚本" class="headerlink" title="用OAK执行Online DDL脚本"></a>用OAK执行Online DDL脚本</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">python oak-online-alter-table -u root --ask-<span class="keyword">pass</span> -S /u01/run/<span class="number">3306</span>/mysql.sock -d lyj -t sbtest1 -g new_sbtest1 -a <span class="string">"add last_update_time timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,add key last_update_time(last_update_time)"</span> --sleep=<span class="number">300</span> --skip-delete-<span class="keyword">pass</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------------------------------------</span></span>
<span class="line">-- Connecting to MySQL</span>
<span class="line">Password:      <span class="comment"># 输入root用户密码</span></span>
<span class="line">-- Table lyj.sbtest1 <span class="keyword">is</span> of engine innodb</span>
<span class="line">-- Checking <span class="keyword">for</span> UNIQUE columns on lyj.sbtest1, by which to chunk</span>
<span class="line">-- Possible UNIQUE KEY column names <span class="keyword">in</span> lyj.sbtest1:</span>
<span class="line">-- - id</span>
<span class="line">-- Table lyj.new_sbtest1 has been created</span>
<span class="line">-- Table lyj.new_sbtest1 has been altered</span>
<span class="line">-- Checking <span class="keyword">for</span> UNIQUE columns on lyj.new_sbtest1, by which to chunk</span>
<span class="line">-- Possible UNIQUE KEY column names <span class="keyword">in</span> lyj.new_sbtest1:</span>
<span class="line">-- - id</span>
<span class="line">-- Checking <span class="keyword">for</span> UNIQUE columns on lyj.sbtest1, by which to chunk</span>
<span class="line">-- - Found following possible unique keys:</span>
<span class="line">-- - id (int)</span>
<span class="line">-- Chosen unique key <span class="keyword">is</span> <span class="string">'id'</span></span>
<span class="line">-- Shared columns: c, pad, k, id</span>
<span class="line">-- Created AD trigger    <span class="comment"># 创建sbtest1 -&gt; new_sbtest1的触发器</span></span>
<span class="line">-- Created AU trigger</span>
<span class="line">-- Created AI trigger</span>
<span class="line">-- Attempting to lock tables</span>
<span class="line"></span>
<span class="line">-- Tables locked WRITE</span>
<span class="line">-- id (min, max) values: ([<span class="number">1L</span>], [<span class="number">1000000L</span>])</span>
<span class="line">-- Tables unlocked</span>
<span class="line">-- - Reminder: altering lyj.sbtest1: add last_update_time timestamp...</span>
<span class="line">-- Copying range (<span class="number">1</span>), (<span class="number">1000</span>), progress: <span class="number">0</span>%</span>
<span class="line">.......</span>
<span class="line">-- + Will sleep <span class="keyword">for</span> <span class="number">0.3</span> seconds</span>
<span class="line">-- Copying range <span class="number">100</span>% complete. Number of rows: <span class="number">1000000</span></span>
<span class="line">-- Ghost table creation completed. Note that triggers on lyj.sbtest1 were <span class="keyword">not</span> removed</span>
<span class="line"><span class="comment">#----------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="数据一致性校验"><a href="#数据一致性校验" class="headerlink" title="数据一致性校验"></a>数据一致性校验</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># OAK在Online DDL进行前后，都可以正常对原表进行DML操作，完成后可使用以下命令进行数据一致性检验</span></span>
<span class="line"><span class="keyword">select</span> sum(crc32(concat(ifnull(id,<span class="string">'NULL'</span>),ifnull(k,<span class="string">'NULL'</span>)))) as sum from sbtest1</span>
<span class="line">union all</span>
<span class="line"><span class="keyword">select</span> sum(crc32(concat(ifnull(id,<span class="string">'NULL'</span>),ifnull(k,<span class="string">'NULL'</span>)))) as sum from new_sbtest1;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> count(*) from sbtest1</span>
<span class="line">union all</span>
<span class="line"><span class="keyword">select</span> count(*) from new_sbtest1;</span>
<span class="line"></span>
<span class="line">desc sbtest1;</span>
<span class="line">desc new_sbtest1;</span>
<span class="line">+------------------+------------------+------+-----+-------------------+-----------------------------+</span>
<span class="line">| Field            | Type             | Null | Key | Default           | Extra                       |</span>
<span class="line">+------------------+------------------+------+-----+-------------------+-----------------------------+</span>
<span class="line">| id               | <span class="keyword">int</span>(<span class="number">10</span>) unsigned | NO   | PRI | NULL              | auto_increment              |</span>
<span class="line">| k                | <span class="keyword">int</span>(<span class="number">10</span>) unsigned | NO   | MUL | <span class="number">0</span>                 |                             |</span>
<span class="line">| c                | char(<span class="number">120</span>)        | NO   |     |                   |                             |</span>
<span class="line">| pad              | char(<span class="number">60</span>)         | NO   |     |                   |                             |</span>
<span class="line">| last_update_time | timestamp        | NO   | MUL | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |   <span class="comment"># 新增加的字段</span></span>
<span class="line">+------------------+------------------+------+-----+-------------------+-----------------------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; show create table new_sbtest1\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">       Table: new_sbtest1</span>
<span class="line">Create Table: CREATE TABLE <span class="string">`new_sbtest1`</span> (</span>
<span class="line">  <span class="string">`id`</span> <span class="keyword">int</span>(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span>
<span class="line">  <span class="string">`k`</span> <span class="keyword">int</span>(<span class="number">10</span>) unsigned NOT NULL DEFAULT <span class="string">'0'</span>,</span>
<span class="line">  <span class="string">`c`</span> char(<span class="number">120</span>) NOT NULL DEFAULT <span class="string">''</span>,</span>
<span class="line">  <span class="string">`pad`</span> char(<span class="number">60</span>) NOT NULL DEFAULT <span class="string">''</span>,</span>
<span class="line">  <span class="string">`last_update_time`</span> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span>
<span class="line">  PRIMARY KEY (<span class="string">`id`</span>),</span>
<span class="line">  KEY <span class="string">`k_1`</span> (<span class="string">`k`</span>), </span>
<span class="line">  KEY <span class="string">`last_update_time`</span> (<span class="string">`last_update_time`</span>)     <span class="comment"># 新增加的索引</span></span>
<span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">1000001</span> DEFAULT CHARSET=utf8 MAX_ROWS=<span class="number">1000000</span></span>
</pre></td></tr></table></figure>
<h4 id="表切换"><a href="#表切换" class="headerlink" title="表切换"></a>表切换</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> lyj;</span>
<span class="line">set names utf8;</span>
<span class="line"><span class="keyword">rename</span> table sbtest1 to old_sbtest1,new_sbtest1 to sbtest1;</span>
<span class="line">drop trigger sbtest1_AI_oak;</span>
<span class="line">drop trigger sbtest1_AU_oak;</span>
<span class="line">drop trigger sbtest1_AD_oak;</span>
<span class="line">drop table old_sbtest1;</span>
</pre></td></tr></table></figure>
<h2 id="用oak做Online-DDL，如果rename那一步操作错了，在从库上rename了怎么恢复？"><a href="#用oak做Online-DDL，如果rename那一步操作错了，在从库上rename了怎么恢复？" class="headerlink" title="用oak做Online DDL，如果rename那一步操作错了，在从库上rename了怎么恢复？"></a>用oak做Online DDL，如果rename那一步操作错了，在从库上rename了怎么恢复？</h2><p>用oak做Online DDL，若上面表切换的步骤中错在从库上rename了，并且也进行了旧表删除和trigger删除，主库上也有新的数据插入，这时两个库的状态如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 主库</span></span>
<span class="line">insert into sbtest1 <span class="keyword">values</span>(<span class="number">3000000</span>,<span class="number">3000000</span>,<span class="string">'aaaaaa'</span>,<span class="string">'aaaaaa'</span>);</span>
<span class="line">insert into sbtest1 <span class="keyword">values</span>(<span class="number">3000001</span>,<span class="number">3000001</span>,<span class="string">'aaaaaa'</span>,<span class="string">'aaaaaa'</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">show tables;</span>
<span class="line">+---------------+</span>
<span class="line">| Tables_in_lyj |</span>
<span class="line">+---------------+</span>
<span class="line">| new_sbtest1   |</span>
<span class="line">| sbtest1       |</span>
<span class="line">| sbtest2       |</span>
<span class="line">+---------------+</span>
<span class="line"></span>
<span class="line">SELECT TRIGGER_SCHEMA,TRIGGER_NAME,EVENT_OBJECT_SCHEMA,EVENT_OBJECT_TABLE FROM information_schema.TRIGGERS</span>
<span class="line">  WHERE event_object_schema= <span class="string">'lyj'</span>;</span>
<span class="line">+----------------+----------------+---------------------+--------------------+</span>
<span class="line">| TRIGGER_SCHEMA | TRIGGER_NAME   | EVENT_OBJECT_SCHEMA | EVENT_OBJECT_TABLE |</span>
<span class="line">+----------------+----------------+---------------------+--------------------+</span>
<span class="line">| lyj            | sbtest1_AI_oak | lyj                 | sbtest1            |</span>
<span class="line">| lyj            | sbtest1_AU_oak | lyj                 | sbtest1            |</span>
<span class="line">| lyj            | sbtest1_AD_oak | lyj                 | sbtest1            |</span>
<span class="line">+----------------+----------------+---------------------+--------------------+</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> count(*) from sbtest1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|  <span class="number">1000002</span> |</span>
<span class="line">+----------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 从库</span></span>
<span class="line">show tables;</span>
<span class="line">+---------------+</span>
<span class="line">| Tables_in_lyj |</span>
<span class="line">+---------------+</span>
<span class="line">| sbtest1       |</span>
<span class="line">| sbtest2       |</span>
<span class="line">+---------------+</span>
<span class="line"></span>
<span class="line">SELECT TRIGGER_SCHEMA,TRIGGER_NAME,EVENT_OBJECT_SCHEMA,EVENT_OBJECT_TABLE FROM information_schema.TRIGGERS</span>
<span class="line">   WHERE event_object_schema= <span class="string">'lyj'</span>;</span>
<span class="line">Empty set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> count(*) from sbtest1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|  <span class="number">1000000</span> |</span>
<span class="line">+----------+</span>
<span class="line"></span>
<span class="line">desc sbtest1;</span>
<span class="line">+------------------+------------------+------+-----+-------------------+-----------------------------+</span>
<span class="line">| Field            | Type             | Null | Key | Default           | Extra                       |</span>
<span class="line">+------------------+------------------+------+-----+-------------------+-----------------------------+</span>
<span class="line">| id               | <span class="keyword">int</span>(<span class="number">10</span>) unsigned | NO   | PRI | NULL              | auto_increment              |</span>
<span class="line">| k                | <span class="keyword">int</span>(<span class="number">10</span>) unsigned | NO   | MUL | <span class="number">0</span>                 |                             |</span>
<span class="line">| c                | char(<span class="number">120</span>)        | NO   |     |                   |                             |</span>
<span class="line">| pad              | char(<span class="number">60</span>)         | NO   |     |                   |                             |</span>
<span class="line">| last_update_time | timestamp        | NO   | MUL | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |</span>
<span class="line">+------------------+------------------+------+-----+-------------------+-----------------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># slave状态</span></span>
<span class="line">show slave status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">00001</span>9</span>
<span class="line">          Read_Master_Log_Pos: <span class="number">385847848</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000021</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">385847426</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">00001</span>9</span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: No            <span class="comment"># 同步已经停止了</span></span>
<span class="line">              Replicate_Do_DB: </span>
<span class="line">          Replicate_Ignore_DB: </span>
<span class="line">           Replicate_Do_Table: </span>
<span class="line">       Replicate_Ignore_Table: </span>
<span class="line">      Replicate_Wild_Do_Table: </span>
<span class="line">  Replicate_Wild_Ignore_Table: </span>
<span class="line">                   Last_Errno: <span class="number">1146</span></span>
<span class="line">                   Last_Error: Error executing row event: <span class="string">'Table '</span>lyj.new_sbtest1<span class="string">' doesn'</span>t exist<span class="string">'  # 停掉同步的原因是没有lyj.new_sbtest1表</span>
<span class="line">                 Skip_Counter: 0</span>
<span class="line">          Exec_Master_Log_Pos: 385847266</span>
<span class="line">              Relay_Log_Space: 2764989916</span>
<span class="line">              Until_Condition: None</span>
<span class="line">               Until_Log_File: </span>
<span class="line">                Until_Log_Pos: 0</span>
<span class="line">           Master_SSL_Allowed: No</span>
<span class="line">           Master_SSL_CA_File: </span>
<span class="line">           Master_SSL_CA_Path: </span>
<span class="line">              Master_SSL_Cert: </span>
<span class="line">            Master_SSL_Cipher: </span>
<span class="line">               Master_SSL_Key: </span>
<span class="line">        Seconds_Behind_Master: NULL</span>
<span class="line">Master_SSL_Verify_Server_Cert: No</span>
<span class="line">                Last_IO_Errno: 0</span>
<span class="line">                Last_IO_Error: </span>
<span class="line">               Last_SQL_Errno: 1146</span>
<span class="line">               Last_SQL_Error: Error executing row event: '</span>Table <span class="string">'lyj.new_sbtest1'</span> doesn<span class="string">'t exist'</span></span>
</pre></td></tr></table></figure></p>
<p>恢复步骤如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在主库上查看trigger创建脚本</span></span>
<span class="line">show create trigger sbtest1_AI_oak\G;</span>
<span class="line">show create trigger sbtest1_AU_oak\G;</span>
<span class="line">show create trigger sbtest1_AD_oak\G;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在从库用sbtest1重建new_sbtest1</span></span>
<span class="line">create table new_sbtest1 as <span class="keyword">select</span> * from sbtest1;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在从库上生成trigger(使用上面查到的创建脚本)</span></span>
<span class="line">CREATE DEFINER=<span class="string">`root`</span>@`localhost<span class="string">` TRIGGER lyj.sbtest1_AI_oak AFTER INSERT ON lyj.sbtest1</span>
<span class="line">        FOR EACH ROW</span>
<span class="line">            REPLACE INTO lyj.new_sbtest1 (`</span>c<span class="string">`, `</span>pad<span class="string">`, `</span>k<span class="string">`, `</span>id<span class="string">`) VALUES (NEW.`</span>c<span class="string">`, NEW.`</span>pad<span class="string">`, NEW.`</span>k<span class="string">`, NEW.`</span>id<span class="string">`);</span>
<span class="line"></span>
<span class="line">DELIMITER //</span>
<span class="line">CREATE TRIGGER lyj.sbtest1_AU_oak AFTER UPDATE ON lyj.sbtest1</span>
<span class="line">        FOR EACH ROW</span>
<span class="line">        BEGIN</span>
<span class="line">            DELETE FROM lyj.new_sbtest1 WHERE (id) = (OLD.id);</span>
<span class="line">            REPLACE INTO lyj.new_sbtest1 (`</span>c<span class="string">`, `</span>pad<span class="string">`, `</span>k<span class="string">`, `</span>id<span class="string">`) VALUES (NEW.`</span>c<span class="string">`, NEW.`</span>pad<span class="string">`, NEW.`</span>k<span class="string">`, NEW.`</span>id<span class="string">`);</span>
<span class="line">        END;</span>
<span class="line">//</span>
<span class="line">DELIMITER ;</span>
<span class="line">## Mysql解释器一遇到;号时就结束，回车以后就执行，所以加delimiter关键字，delimiter作用就是把;分号替换成指定的符号。</span>
<span class="line"></span>
<span class="line">CREATE DEFINER=`</span>root<span class="string">`@`</span>localhost<span class="string">` TRIGGER lyj.sbtest1_AD_oak AFTER DELETE ON lyj.sbtest1</span>
<span class="line">        FOR EACH ROW</span>
<span class="line">            DELETE FROM lyj.new_sbtest1 WHERE (id) = (OLD.id);</span>
<span class="line"></span>
<span class="line"># 在从库上启动slave同步</span>
<span class="line">start slave;</span>
<span class="line"></span>
<span class="line"># 查看slave状态</span>
<span class="line">show slave status\G;</span>
<span class="line">*************************** 1. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting for master to send event</span>
<span class="line">                  Master_Host: 10.245.231.202</span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: 3306</span>
<span class="line">                Connect_Retry: 60</span>
<span class="line">              Master_Log_File: binlog.000019</span>
<span class="line">          Read_Master_Log_Pos: 385848190</span>
<span class="line">               Relay_Log_File: relaylog.000021</span>
<span class="line">                Relay_Log_Pos: 385848350</span>
<span class="line">        Relay_Master_Log_File: binlog.000019</span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: Yes      # 可以看到同步已恢复</span>
<span class="line"></span>
<span class="line"># 可以在主库上插入数据测试同步</span>
<span class="line">insert into sbtest1 values(3000002,3000002,'aaaaaa','aaaaaa');</span>
<span class="line">insert into sbtest1 values(3000003,3000003,'aaaaaa','aaaaaa');</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line"># 重新在主库上执行表切换</span>
<span class="line">use lyj;</span>
<span class="line">set names utf8;</span>
<span class="line">rename table sbtest1 to old_sbtest1,new_sbtest1 to sbtest1;</span>
<span class="line">drop trigger sbtest1_AI_oak;</span>
<span class="line">drop trigger sbtest1_AU_oak;</span>
<span class="line">drop trigger sbtest1_AD_oak;</span>
<span class="line">drop table old_sbtest1;</span></span>
</pre></td></tr></table></figure></p>
<h2 id="笔记"><a href="#笔记" class="headerlink" title="笔记"></a>笔记</h2><h3 id="MySQL-5-6-Online-DDL概述"><a href="#MySQL-5-6-Online-DDL概述" class="headerlink" title="MySQL 5.6 Online DDL概述"></a>MySQL 5.6 Online DDL概述</h3><p>官方文档：<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-overview.html" target="_blank" rel="external">https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-overview.html </a><br>Online DDL主要是解决DDL锁表的问题，保证了在进行表变更的时候不会阻塞线上业务的读写，数据库仍能正常对外提供访问。</p>
<h3 id="OnlineDDL-SOP"><a href="#OnlineDDL-SOP" class="headerlink" title="OnlineDDL SOP"></a>OnlineDDL SOP</h3><ol>
<li>确认该表是否符合oak-online-alter-table 的执行条件<ul>
<li>单列唯一索引（联合索引和联合主键是不可以的，促发mysql一个bug）</li>
<li>没有foreign key</li>
<li>没有定义触发器（有也先删除了）</li>
</ul>
</li>
<li>已有触发器？检查触发器 -&gt; 备份触发器 -&gt; 删除触发器</li>
<li>执行oak 命令，至于执行时间，如果表有1亿，大概要执行12 个小时，就需要在一周业务量少的时候执行</li>
<li>Online DDL之后要进行数据一致性校验：如果DDL改变了表字段类型，可能导致表数据变化</li>
<li>表切换</li>
<li>删除触发器</li>
<li>删除表</li>
</ol>
<h3 id="online-DDL-checklist功能"><a href="#online-DDL-checklist功能" class="headerlink" title="online DDL checklist功能"></a>online DDL checklist功能</h3><ol>
<li>检查是否有大查询</li>
<li>检查是否有外键和触发器</li>
</ol>
<h3 id="MySQL5-6-Online-DDL可以做到DDL-DML-SELECT同时进行"><a href="#MySQL5-6-Online-DDL可以做到DDL-DML-SELECT同时进行" class="headerlink" title="MySQL5.6 Online DDL可以做到DDL\DML\SELECT同时进行"></a>MySQL5.6 Online DDL可以做到DDL\DML\SELECT同时进行</h3><p>官方文档：<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-concurrency.html" target="_blank" rel="external">https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-concurrency.html </a></p>
<ul>
<li><p>Locking Options for Online DDL</p>
<ul>
<li>LOCK=DEFAULT</li>
<li>LOCK=NONE</li>
<li>LOCK=SHARED</li>
<li>LOCK=EXCLUSIVE</li>
</ul>
</li>
<li><p>Performance of In-Place versus Table-Copying DDL Operations</p>
<ul>
<li>ALGORITHM=DEFAULT</li>
<li>ALGORITHM=INPLACE</li>
<li>ALGORITHM=COPY</li>
</ul>
</li>
</ul>
<h3 id="COPY与INPLACE的原理"><a href="#COPY与INPLACE的原理" class="headerlink" title="COPY与INPLACE的原理"></a>COPY与INPLACE的原理</h3><h4 id="copy方式"><a href="#copy方式" class="headerlink" title="copy方式"></a>copy方式</h4><ol>
<li>新建带索引（主键索引）的临时表</li>
<li>锁原表，禁止DML，允许查询</li>
<li>将原表数据拷贝到临时表</li>
<li>禁止读写,进行rename，升级字典锁</li>
<li>完成创建索引操作</li>
</ol>
<h4 id="inplace方式"><a href="#inplace方式" class="headerlink" title="inplace方式"></a>inplace方式</h4><ol>
<li>创建索引(二级索引)数据字典</li>
<li>加共享表锁，禁止DML，允许查询</li>
<li>读取聚簇索引，构造新的索引项，排序并插入新索引</li>
<li>等待打开当前表的所有只读事务提交</li>
<li>创建索引结束</li>
</ol>
<h3 id="Online-DDL-实现细节"><a href="#Online-DDL-实现细节" class="headerlink" title="Online DDL 实现细节"></a>Online DDL 实现细节</h3><h4 id="Prepare阶段"><a href="#Prepare阶段" class="headerlink" title="Prepare阶段"></a>Prepare阶段</h4><ol>
<li>创建临时frm文件</li>
<li>持有EXCLUSIVE-MDL锁，禁止读写  （不能有长查询）</li>
<li>根据ALTER类型，确定执行方式(copy,online-rebuild,online-norebuild)</li>
<li>更新数据字典的内存对象</li>
<li>分配row_log对象记录增量，大小设置参数innodb_online_alter_log_max_size</li>
<li>生成临时ibd文件</li>
</ol>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%log_max_size%'</span>;</span>
<span class="line">+----------------------------------+-----------+</span>
<span class="line">| Variable_name                    | Value     |</span>
<span class="line">+----------------------------------+-----------+</span>
<span class="line">| innodb_online_alter_log_max_size | <span class="number">134217728</span> |    <span class="comment"># ddl的过程中，记录DML操作日志，默认大小128M</span></span>
<span class="line">+----------------------------------+-----------+</span>
</pre></td></tr></table></figure>
<h4 id="ddl执行阶段"><a href="#ddl执行阶段" class="headerlink" title="ddl执行阶段"></a>ddl执行阶段</h4><ol>
<li>降级EXCLUSIVE-MDL锁，允许读写</li>
<li>扫描原表的聚簇索引每条记录</li>
<li>遍历新表的聚簇索引和二级索引，逐一处理</li>
<li>根据记录构造对应的索引项</li>
<li>将构造索引项插入sort_buffer块</li>
<li>将sort_buffer块插入新的索引</li>
<li>处理ddl执行过程中产生的增量(仅rebuild类型需要)</li>
</ol>
<h4 id="commit阶段"><a href="#commit阶段" class="headerlink" title="commit阶段"></a>commit阶段</h4><ol>
<li>升级到EXCLUSIVE-MDL锁，禁止读写</li>
<li>应用最后row_log中产的日志</li>
<li>更新innodb的数据字典表</li>
<li>提交事务(刷事务的redo日志)</li>
<li>修改统计信息</li>
<li>rename临时idb文件，frm文件</li>
<li>变更完成</li>
</ol>
<h3 id="Mysql的Online-DDL测试"><a href="#Mysql的Online-DDL测试" class="headerlink" title="Mysql的Online DDL测试"></a>Mysql的Online DDL测试</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 用sysbench工具准备测试环境</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/insert.lua \</span>
<span class="line">--oltp-table-size=<span class="number">1000000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=lyj \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">2</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> prepare</span>
<span class="line"></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/insert.lua \</span>
<span class="line">--oltp-table-size=<span class="number">1000000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=lyj \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">2</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> run</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 1:</span></span>
<span class="line">alter table sbtest1 add name varchar(<span class="number">10</span>);</span>
<span class="line"><span class="comment"># session 2:</span></span>
<span class="line"><span class="keyword">delete</span> from sbtest1 where id&lt;<span class="number">1000</span>;</span>
<span class="line">Query OK, <span class="number">999</span> rows affected (<span class="number">0</span>.<span class="number">02</span> sec)    <span class="comment"># 可以并发执行DML操作，执行速度很快</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># session 1:</span></span>
<span class="line">alter table sbtest2 add name varchar(<span class="number">10</span>),ALGORITHM=INPLACE,LOCK=NONE;</span>
<span class="line"><span class="comment"># session 2:</span></span>
<span class="line"><span class="keyword">delete</span> from sbtest2 where id&lt;<span class="number">1000</span>;</span>
<span class="line">Query OK, <span class="number">999</span> rows affected (<span class="number">0</span>.<span class="number">93</span> sec)    <span class="comment"># 可以并发执行DML操作，执行速度较上面的慢些</span></span>
</pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://seanlook.com/2016/05/24/mysql-online-ddl-concept/" target="_blank" rel="external">mysql 5.6 原生Online DDL解析</a></p>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[那些12c中惹祸的特性关闭列表]]></title>
      <url>/2017/04/18/oracle/%E9%82%A3%E4%BA%9B12c%E4%B8%AD%E6%83%B9%E7%A5%B8%E7%9A%84%E7%89%B9%E6%80%A7%E5%85%B3%E9%97%AD%E5%88%97%E8%A1%A8/</url>
      <content type="html"><![CDATA[<p>12cR2已经发布一段时间，这里给出一张12c下新出现的可能惹祸特性的列表，可以结合<a href="http://ol3rzmg8c.bkt.clouddn.com/%E9%82%A3%E4%BA%9B11gR2%E4%B8%AD%E6%83%B9%E7%A5%B8%E7%9A%84%E7%89%B9%E6%80%A7%E5%85%B3%E9%97%AD%E5%88%97%E8%A1%A8.pdf" target="_blank" rel="external">11g的列表</a>一起使用。<br>我们的宗旨不是要废掉所有新特性，只是把那些还不太成熟的又默认自动生效的积极特性关起来。<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_optimizer_aggr_groupby_elim"</span>=<span class="literal">false</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_drop_stat_segment"</span>=<span class="number">1</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_common_data_view_enabled"</span>=<span class="literal">false</span>; </span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_optimizer_dsdir_usage_control"</span>=<span class="number">0</span>;    // disable SQL Plan Directive</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> optimizer_adaptive_features=<span class="literal">false</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_optimizer_adaptive_plans"</span>=<span class="literal">false</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_optimizer_gather_feedback"</span>=<span class="literal">false</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_optimizer_enable_extended_stats"</span>=<span class="literal">false</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_optimizer_ads_use_result_cache"</span>=<span class="literal">false</span>;</span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">set</span> <span class="string">"_use_single_log_writer"</span>=<span class="literal">true</span> <span class="keyword">scope</span>=<span class="keyword">spfile</span>; //Multiple log writers feature in Oracle Database 12c can cause instance recovery fails and unexpected</span>
</pre></td></tr></table></figure></p>
<blockquote>
<p>转载自：<a href="http://www.askmaclean.com/" target="_blank" rel="external">AskMaclean</a></p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 12c </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-12 MySQL构架设计与容量规划]]></title>
      <url>/2017/04/13/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/12-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="用sysbench压测MySQL，通过orzdba监控工具分析机器的容量"><a href="#用sysbench压测MySQL，通过orzdba监控工具分析机器的容量" class="headerlink" title="用sysbench压测MySQL，通过orzdba监控工具分析机器的容量"></a>用sysbench压测MySQL，通过orzdba监控工具分析机器的容量</h2><h3 id="编译安装sysbench"><a href="#编译安装sysbench" class="headerlink" title="编译安装sysbench"></a>编译安装sysbench</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装依赖包（在上节中的mha机器上安装）</span></span>
<span class="line">yum -<span class="keyword">y</span> install make automake libtool pkgconfig libaio-devel vim-common</span>
<span class="line">yum -<span class="keyword">y</span> install mysql-devel</span>
<span class="line"></span>
<span class="line"><span class="comment"># 编译源码安装，下载地址：https://codeload.github.com/akopytov/Sysbench/zip/1.0.5</span></span>
<span class="line">unzip sysbench-<span class="number">1.0</span>.<span class="number">5</span>.zip</span>
<span class="line">cd sysbench-<span class="number">1.0</span>.<span class="number">5</span></span>
<span class="line">./autogen.sh</span>
<span class="line">./configure --with-mysql-includes=<span class="regexp">/usr/include</span><span class="regexp">/mysql --with-mysql-libs=/usr</span><span class="regexp">/lib64/mysql</span>   <span class="comment"># 注意修改路径</span></span>
<span class="line">make &amp;&amp; make install</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="在压测的MySQL上创建一个空的test数据库"><a href="#在压测的MySQL上创建一个空的test数据库" class="headerlink" title="在压测的MySQL上创建一个空的test数据库"></a>在压测的MySQL上创建一个空的test数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 已有test库的话先drop掉</span></span>
<span class="line">drop database test;</span>
<span class="line">create database test;</span>
</pre></td></tr></table></figure>
<h3 id="在压测的MySQL机开启orzdba监控工具"><a href="#在压测的MySQL机开启orzdba监控工具" class="headerlink" title="在压测的MySQL机开启orzdba监控工具"></a>在压测的MySQL机开启orzdba监控工具</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建压测MySQL用户（不要加密码）</span></span>
<span class="line">grant all privileges on *.* to <span class="string">'lyj'</span>@'localhost<span class="string">' identified by '</span><span class="string">';</span>
<span class="line">grant all privileges on *.* to '</span>lyj<span class="string">'@'</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="string">' identified by '</span><span class="string">';</span>
<span class="line"></span>
<span class="line"># orzdba下载地址：http://pan.baidu.com/S/1migCOa8</span>
<span class="line">vi orzdba</span>
<span class="line">#---------------------------------------------------------</span>
<span class="line">my $user = '</span>lyj<span class="string">';     # -u   : mysql user</span>
<span class="line">my $MYSQL    = qq&#123;mysql -s --skip-column-names -u$user -P$port &#125;;</span>
<span class="line">#---------------------------------------------------------</span>
<span class="line">chmod +x orzdba</span>
<span class="line"></span>
<span class="line">./orzdba -lazy</span>
<span class="line">#-------------------------------------------------------------------------------------------------------------------------------</span>
<span class="line">.=================================================.</span>
<span class="line">|       Welcome to use the orzdba tool !          | </span>
<span class="line">|          Yep...Chinese English~                 |</span>
<span class="line">'</span>=============== Date : <span class="number">2017</span>-<span class="number">04</span>-<span class="number">13</span> ===============<span class="string">'</span>
<span class="line"></span>
<span class="line">HOST: mydb1   IP: 10.245.231.202</span>
<span class="line">DB  : edu|lyj|lyj1|performance_schema</span>
<span class="line">Var : port[3306] read_only[OFF] version[5.6.35-log] </span>
<span class="line">      </span>
<span class="line">      binlog_format[ROW] max_binlog_cache_size[2G] max_binlog_size[500M] </span>
<span class="line">      max_connect_errors[100] max_connections[214] max_user_connections[2800] </span>
<span class="line">      open_files_limit[1024] sync_binlog[100] table_definition_cache[600] </span>
<span class="line">      table_open_cache[400] thread_cache_size[10] </span>
<span class="line"></span>
<span class="line">      innodb_adaptive_flushing[ON] innodb_adaptive_hash_index[ON] innodb_buffer_pool_instances[8] </span>
<span class="line">      innodb_buffer_pool_size[128M] innodb_file_per_table[ON] innodb_flush_log_at_trx_commit[1] </span>
<span class="line">      innodb_flush_method[O_DIRECT] innodb_io_capacity[1000] innodb_lock_wait_timeout[10] </span>
<span class="line">      innodb_log_buffer_size[64M] innodb_log_file_size[1000M] innodb_log_files_in_group[4] </span>
<span class="line">      innodb_max_dirty_pages_pct[60] innodb_open_files[400] innodb_read_io_threads[4] </span>
<span class="line">      innodb_stats_on_metadata[OFF] innodb_thread_concurrency[0] innodb_write_io_threads[10] </span>
<span class="line">      </span>
<span class="line"></span>
<span class="line">-------- -----load-avg---- ---cpu-usage--- ---swap---                     -QPS- -TPS-         -Hit%- ------threads------ </span>
<span class="line">  time  |  1m    5m   15m |usr sys idl iow|   si   so|  ins   upd   del    sel   iud|     lor    hit| run  con  cre  cac|</span>
<span class="line">15:02:05| 0.00  0.01  0.05|  0   0 100   0|    0    0|    0     0     0      0     0|       0 100.00|   0    0    0    0|</span>
<span class="line">#-------------------------------------------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="在装sysbench机上执行压测命令"><a href="#在装sysbench机上执行压测命令" class="headerlink" title="在装sysbench机上执行压测命令"></a>在装sysbench机上执行压测命令</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># prepare准备阶段，构建压测环境</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/select.lua \</span>
<span class="line">--oltp-table-size=<span class="number">20000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=test \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">20</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> prepare</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line">Creating table <span class="string">'sbtest1'</span>...</span>
<span class="line">Inserting <span class="number">20000</span> records into <span class="string">'sbtest1'</span></span>
<span class="line">Creating secondary indexes on <span class="string">'sbtest1'</span>...</span>
<span class="line">Creating table <span class="string">'sbtest2'</span>...</span>
<span class="line">Inserting <span class="number">20000</span> records into <span class="string">'sbtest2'</span></span>
<span class="line">Creating secondary indexes on <span class="string">'sbtest2'</span>...</span>
<span class="line">Creating table <span class="string">'sbtest3'</span>...</span>
<span class="line">Inserting <span class="number">20000</span> records into <span class="string">'sbtest3'</span></span>
<span class="line">......</span>
<span class="line">Creating table <span class="string">'sbtest20'</span>...</span>
<span class="line">Inserting <span class="number">20000</span> records into <span class="string">'sbtest20'</span></span>
<span class="line">Creating secondary indexes on <span class="string">'sbtest20'</span>...</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 开始压测</span></span>
<span class="line">sysbench /usr/<span class="keyword">local</span>/share/sysbench/tests/include/oltp_legacy/select.lua \</span>
<span class="line">--oltp-table-size=<span class="number">20000</span> --mysql-table-engine=innodb --db-driver=mysql \</span>
<span class="line">--mysql-user=root --mysql-password=root123 --mysql-port=<span class="number">3306</span> \</span>
<span class="line">--mysql-host=<span class="number">10.245</span>.<span class="number">231.202</span> --mysql-db=test \</span>
<span class="line">--events=<span class="number">0</span> --<span class="keyword">time</span>=<span class="number">60</span> --oltp-tables-count=<span class="number">20</span> --report-interval=<span class="number">10</span> --threads=<span class="number">2</span> run</span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------------------</span></span>
<span class="line">Running the test with following options:</span>
<span class="line">Number of threads: <span class="number">2</span></span>
<span class="line">Report intermediate results every <span class="number">10</span> second(<span class="keyword">s</span>)</span>
<span class="line">Initializing random number generator from current <span class="keyword">time</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Initializing worker threads...</span>
<span class="line"></span>
<span class="line">Threads started!</span>
<span class="line"></span>
<span class="line">[ <span class="number">10</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">5987.78</span> qps: <span class="number">5987.78</span> (r/w/o: <span class="number">5987.78</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">41</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">20</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">7711.35</span> qps: <span class="number">7711.35</span> (r/w/o: <span class="number">7711.35</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">35</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">30</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">7751.22</span> qps: <span class="number">7751.22</span> (r/w/o: <span class="number">7751.22</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">35</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">40</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">7710.81</span> qps: <span class="number">7710.81</span> (r/w/o: <span class="number">7710.81</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">39</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">50</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">10138.07</span> qps: <span class="number">10138.07</span> (r/w/o: <span class="number">10138.07</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">31</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line">[ <span class="number">60</span><span class="keyword">s</span> ] thds: <span class="number">2</span> tps: <span class="number">8729.18</span> qps: <span class="number">8729.18</span> (r/w/o: <span class="number">8729.18</span>/<span class="number">0</span>.<span class="number">00</span>/<span class="number">0</span>.<span class="number">00</span>) lat (ms,<span class="number">95</span>%): <span class="number">0</span>.<span class="number">33</span> err/S: <span class="number">0</span>.<span class="number">00</span> reconn/S: <span class="number">0</span>.<span class="number">00</span></span>
<span class="line"></span>
<span class="line">SQL statistics:</span>
<span class="line">    queries performed:</span>
<span class="line">        <span class="keyword">read</span>:                            <span class="number">480290</span></span>
<span class="line">        <span class="keyword">write</span>:                           <span class="number">0</span></span>
<span class="line">        other:                           <span class="number">0</span></span>
<span class="line">        total:                           <span class="number">480290</span></span>
<span class="line">    transactions:                        <span class="number">480290</span> (<span class="number">8004.05</span> per sec.)</span>
<span class="line">    queries:                             <span class="number">480290</span> (<span class="number">8004.05</span> per sec.)</span>
<span class="line">    ignored errors:                      <span class="number">0</span>      (<span class="number">0</span>.<span class="number">00</span> per sec.)</span>
<span class="line">    reconnects:                          <span class="number">0</span>      (<span class="number">0</span>.<span class="number">00</span> per sec.)</span>
<span class="line"></span>
<span class="line">General statistics:</span>
<span class="line">    total <span class="keyword">time</span>:                          <span class="number">60.0012</span><span class="keyword">s</span></span>
<span class="line">    total number of events:              <span class="number">480290</span></span>
<span class="line"></span>
<span class="line">Latency (ms):</span>
<span class="line">         min:                                  <span class="number">0</span>.<span class="number">12</span></span>
<span class="line">         avg:                                  <span class="number">0</span>.<span class="number">25</span></span>
<span class="line">         max:                                  <span class="number">8.10</span></span>
<span class="line">         <span class="number">95</span>th percentile:                      <span class="number">0</span>.<span class="number">38</span></span>
<span class="line">         sum:                             <span class="number">119006.64</span></span>
<span class="line"></span>
<span class="line">Threads fairness:</span>
<span class="line">    events (avg/stddev):           <span class="number">240145.0000</span>/<span class="number">594.00</span></span>
<span class="line">    execution <span class="keyword">time</span> (avg/stddev):   <span class="number">59.5033</span>/<span class="number">0</span>.<span class="number">00</span></span>
<span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="通过orzdba监控工具分析查看机器的容量"><a href="#通过orzdba监控工具分析查看机器的容量" class="headerlink" title="通过orzdba监控工具分析查看机器的容量"></a>通过orzdba监控工具分析查看机器的容量</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/0413_sysbench_01.png" alt=""><br>附：<a href="http://olejf7dok.bkt.clouddn.com/orzdba%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E.pdf" target="_blank" rel="external">orzdba工具使用说明</a></p>
<h2 id="分库分表架构设计"><a href="#分库分表架构设计" class="headerlink" title="分库分表架构设计"></a>分库分表架构设计</h2><p>问题：在订单表中（分库分表），有70%查询是通过主键和userId字段查询(userId是分库分表策略字段)，有20%要通过order_num（订单号）查数据。</p>
<p><font color="red"><b>1. 请问order_num（订单号）要怎么设计才能快速找到订单记录是在哪个库的哪个表？</b></font><br>在订单号<code>order_num</code>中加入库序号和表序号，通过userid可以算出库序号和表序号，计算公式如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">中间变量=userId%(库数量*每个库的表数量)</span>
<span class="line">库序号=中间变量/每个库的表数量</span>
<span class="line">表序号=中间变量%每个库的表数量</span>
</pre></td></tr></table></figure></p>
<p><font color="red"><b>2. 有10%是非主键字段（比如：字段、渠道、商品，档期，品牌，收件人信息、金额等字段）去查记录，非主键字段要怎么设计才能快速定位到记录？</b></font><br>可以建立非主键字段索引表，索引表是主建与非主键字段的对应关系表，可根据非主键进行哈希取模，放到分库里面。在使用非主键字段进行查询时，先查出非主键对应的主键，再根据主键去对应的库表中查询订单数据。</p>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><h3 id="容量评估4个重要指标："><a href="#容量评估4个重要指标：" class="headerlink" title="容量评估4个重要指标："></a>容量评估4个重要指标：</h3><ol>
<li>LOAD：服务器的负载，在Linux中可以通过top命令查看<code>load average</code></li>
<li>CPU：CPU的使用率，在Linux中可以通过<code>top</code>和<code>cat /proc/Stat</code>命令查看</li>
<li>QPS：<code>Queries Per Second</code>意思是“每秒查询率”，是一台服务器每秒能够相应的查询次数，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。</li>
<li>TPS：<code>Transactions PerSecond</code>，也就是事务数/秒。它是软件测试结果的测量单位。一个事务是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数，最终利用这些信息来估计得分。客户机使用加权协函数平均方法来计算客户机的得分，测试软件就是利用客户机的这些信息使用加权协函数平均方法来计算服务器端的整体TPS得分。</li>
</ol>
<h3 id="容量评估-QPS评估"><a href="#容量评估-QPS评估" class="headerlink" title="容量评估-QPS评估"></a>容量评估-QPS评估</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">峰值QPS=(总的PV * <span class="number">80</span>%)/(<span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">20</span>%)</span>
<span class="line">机器数=总的峰值QPS/压测得出的单台机器极限QPS</span>
</pre></td></tr></table></figure>
<h3 id="MySQL构架设计"><a href="#MySQL构架设计" class="headerlink" title="MySQL构架设计"></a>MySQL构架设计</h3><h4 id="读写分离方案"><a href="#读写分离方案" class="headerlink" title="读写分离方案"></a>读写分离方案</h4><ul>
<li>海量数据的存储及访问，通过对数据库进行读写分离，来提升数据的处理能力。读写分离它的方案特点是数据库产生多个副本，数据库的写操作都集中到一个数据库上，而一些读的操作呢，可以分解到其它数据库上。这样，只要付出数据复制的成本，就可以使得数据库的处理压力分解到多个数据库上，从而大大提升数据处理能力。</li>
<li>优点：由于所有的数据库副本，都有数据的全拷贝，因此所有的数据库特性都可以实现，部分机器当机不影响系统的使用。</li>
<li>缺点：数据的复制同步是一个问题，要么采用数据库自身的复制方案，要么自行实现数据复制方案。需要考虑数据的迟滞性，一致性方面的问题。</li>
</ul>
<h4 id="数据分区（分库）方案"><a href="#数据分区（分库）方案" class="headerlink" title="数据分区（分库）方案"></a>数据分区（分库）方案</h4><ul>
<li>原来所有的数据都是在一个数据库上的，网络IO及文件IO都集中在一个数据库上的，因此CPU、内存、文件IO、网络IO都可能会成为系统瓶颈。而分区的方案就是把某一个或某几张相关的表的数据放在一个独立的数据库上，这样就可以把CPU、内存、文件IO、网络IO分解到多个机器中，从而提升系统处理能力。</li>
<li>优点：不存在数据库副本复制，性能更高。</li>
<li>缺点：分区策略必须经过充分考虑，避免多个分区之间的数据存在关联关系，每个分区都是单点，如果某个分区宕机，就会影响到系统的使用。</li>
</ul>
<h4 id="数据分表方案"><a href="#数据分表方案" class="headerlink" title="数据分表方案"></a>数据分表方案</h4><ul>
<li>不管是上面的读写分离方案还是数据分区方案，当数据量大到一定程度的时候，都会导致处理性能的不足，这个时候就没有办法了，只能进行分表处理。也就是把数据库当中数据根据按照分库原则分到多个数据表当中，这样，就可以把大表变成多个小表，不同的分表中数据不重复，从而提高处理效率。</li>
<li>优点：数据不存在多个副本，不必进行数据复制，性能更高。</li>
<li>缺点：分表之间的数据很少进行集合运算；分表都是单点，如果某个分表宕机，如果使用的数据不在此分表，不影响使用。</li>
</ul>
<p><strong>当单库单表无法满足大量写的请求时，需进行分表，分表方式有以下两种：</strong></p>
<ol>
<li><font color="red"><b>同库分表：所有的分表都在一个数据库中，由于数据库中表名不能重复，因此需要把数据表名起成不同的名字。</b></font><br>优点：由于都在一个数据库中，公共表，不必进行复制，处理更简单<br>缺点：由于还在一个数据库中，CPU、内存、文件IO、网络IO等瓶颈还是无法解决，只能降低单表中的数据记录数。表名不一致会导后续的处理复杂。</li>
<li><font color="red"><b>不同库分表：由于分表在不同的数据库中，这个时候就可以使用同样的表名。</b></font><br>优点：CPU、内存、文件IO、网络IO等瓶颈可以得到有效解决，表名相同，处理起来相对简单<br>缺点：公共表由于在所有的分表都要使用，因此要进行复制、同步。</li>
</ol>
<h3 id="开发-分库分表路线分析"><a href="#开发-分库分表路线分析" class="headerlink" title="开发-分库分表路线分析"></a>开发-分库分表路线分析</h3><ul>
<li>一种是对用户透明的方案，即用户只用像普通的JDBC数据源一样访问即可，由框架解决所有的数据访问问题。另外一种是应用层解决，具体一般是在Dao层进行封装。</li>
<li>JDBC层方案<ul>
<li>优点：开发人员使用非常方便，开发工作量比较小；可以实现数据库无关。</li>
<li>缺点：框架实现难度比较大，性能不一定能做到最优。</li>
<li>同样是JDBC方案，也有两种解决方案，一种是有代理模式，一种是无代理模式。<ul>
<li>有代理模式，有一台专门的代理服务器，来接收用户请求，然后发送请求给数据库集群中的数据，并对数据进行汇集后再提交给请求方。</li>
<li>无代理模式，就是说没有代理服务器，集群框架直接部署在应用访问端。</li>
<li>有代理模式，能够提供的功能更强大，甚至可买提供中间库进行数据处理，无代理模式处理性能较强有代理模式少一次网络访问，相对来说性能更好，但是功能性不如有代理模式。</li>
</ul>
</li>
</ul>
</li>
<li>DAO层方案<ul>
<li>优点：开发人员自由度非常大，性能调优更精准。</li>
<li>缺点：开发人员在一定程度上受影响，与具体的Dao技术实现相关，较难做到数据库无关。</li>
<li>由于需要对SQL脚本进行判断，然后进行路由，因此DAO层优化方案一般都是选用iBatis或Spring JdbcTemplate等方案进行封装，而对于Hibernate等高度封装的OR映射方案，实现起来就非常困难了。</li>
</ul>
</li>
</ul>
<h2 id="分库分表带来的限制"><a href="#分库分表带来的限制" class="headerlink" title="分库分表带来的限制"></a>分库分表带来的限制</h2><ol>
<li>条件查询、分页查询受到限制，查询必须带上分库分表所带上的id</li>
<li>事务可能跨多个库，数据一致性无法通过本地事务实现，无法使用外键</li>
<li>分库分表规则确定以后，扩展变更规则需要迁移数据</li>
</ol>
<p>业务痛点：<br><img src="http://oligvdnzp.bkt.clouddn.com/0414_fen_database_01.png" alt="业务痛点"><br>业内解决方案：<br><img src="http://oligvdnzp.bkt.clouddn.com/0414_fen_database_02.png" alt="业务痛点"><br><img src="http://oligvdnzp.bkt.clouddn.com/0414_fen_database_03.png" alt="Proxy方案对比"></p>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
            <tag> sysbench </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ORA-27086 unable to lock file - already in use]]></title>
      <url>/2017/04/13/oracle/ORA/ORA-27086/</url>
      <content type="html"><![CDATA[<p><strong>故障现象：</strong> nas存储通过nfs挂载到Linux主机上，使用expdp直接备份到nfs上时偶尔会报以下错误<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">;;; </span>
<span class="line">Export: Release <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4.0</span> - Production on Wed Apr <span class="number">12</span> <span class="number">16</span>:<span class="number">58</span>:<span class="number">22</span> <span class="number">2017</span></span>
<span class="line">......</span>
<span class="line">ORA-<span class="number">39000</span>: bad <span class="keyword">dump</span> file specification</span>
<span class="line">ORA-<span class="number">31641</span>: unable to create <span class="keyword">dump</span> file <span class="string">"/oradata/hknfs/erpnogg_expdp/erpnogg_expdp_20170412165822_01.dmp"</span></span>
<span class="line">ORA-<span class="number">27086</span>: unable to lock file - already in <span class="keyword">use</span></span>
<span class="line">Linux-x86_64 Error: <span class="number">37</span>: No locks available</span>
<span class="line">Additional information: <span class="number">10</span></span>
</pre></td></tr></table></figure></p>
<p><strong>解决办法：</strong> 卸载nfs挂载存储，重新挂载的时候加上<code>nolock</code>参数(存储上的锁文件功能也取消)<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">umount /oradata/hknfs</span>
<span class="line">mount -t nfs -o nolock <span class="number">10.230</span>.<span class="number">51.200</span>:<span class="regexp">/cybackup /oradata</span><span class="regexp">/hknfs</span>
<span class="line"></span>
<span class="line">vi /etc</span><span class="regexp">/fstab</span>
<span class="line">#------------------------------------------------------------------------</span>
<span class="line">10.230.51.200:/cybackup</span> /oradata/hknfs          nfs     nolock       <span class="number">1</span> <span class="number">1</span></span>
<span class="line"><span class="comment">#------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<p><strong>原因分析：</strong> nas存储将逻辑卷nfs共享出去，一旦服务器挂载使用，存储就会自动将该逻辑卷锁住，保护逻辑卷内不被其他服务器挂载，达到保护数据作用，但是数据库添加挂载目录中创建数据文件，数据库需要对该数据文件获取锁，但是该锁已经被存储占用，这个时候就需要设置存储在挂载的时候不锁住，使用nolock参数。</p>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> ORA- </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-11 构建高可用MySQL系统]]></title>
      <url>/2017/04/06/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/11-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="MHA部署"><a href="#MHA部署" class="headerlink" title="MHA部署"></a>MHA部署</h2><h3 id="主机名-IP规划"><a href="#主机名-IP规划" class="headerlink" title="主机名/IP规划"></a>主机名/IP规划</h3><table>
<thead>
<tr>
<th style="text-align:center">主机名</th>
<th style="text-align:center">IP地址</th>
<th style="text-align:center">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">mymha</td>
<td style="text-align:center">10.245.231.201</td>
<td style="text-align:center">Master</td>
</tr>
<tr>
<td style="text-align:center">mydb1</td>
<td style="text-align:center">10.245.231.202</td>
<td style="text-align:center">Slave</td>
</tr>
<tr>
<td style="text-align:center">mydb2</td>
<td style="text-align:center">10.245.231.203</td>
<td style="text-align:center">MHA manager</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">10.245.231.204</td>
<td style="text-align:center">VIP虚拟IP</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h3 id="系统基本配置"><a href="#系统基本配置" class="headerlink" title="系统基本配置"></a>系统基本配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /etc/issue</span>
<span class="line">racle Linux Server release <span class="number">6.8</span></span>
<span class="line">Kernel \r on an \<span class="keyword">m</span></span>
<span class="line"></span>
<span class="line">service iptables stop</span>
<span class="line">chkconfig iptables off</span>
<span class="line">chkconfig ip6tables off</span>
<span class="line">chkconfig bluetooth off</span>
<span class="line">chkconfig cups off</span>
<span class="line"></span>
<span class="line">sed -i <span class="string">"s/id:5/id:3/g"</span> /etc/inittab</span>
<span class="line">sed -i <span class="string">"s/SELINUX=enforcing/SELINUX=disabled/g"</span> /etc/selinux/config</span>
<span class="line"></span>
<span class="line">echo <span class="string">"10.245.231.201  mymha"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span>
<span class="line">echo <span class="string">"10.245.231.202  mydb1"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span>
<span class="line">echo <span class="string">"10.245.231.203  mydb2"</span> &gt;&gt; <span class="regexp">/etc/hosts</span></span>
<span class="line"></span>
<span class="line">vi /etc/sysctl.conf</span>
<span class="line"><span class="comment">#-------------------------------------------------</span></span>
<span class="line">kernel.shmmax = <span class="number">4398046511104</span>      <span class="comment"># 修改原值</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line"><span class="comment">#-------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">sysctl -p</span>
<span class="line"></span>
<span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line">mount /dev/cdrom /media/disk</span>
<span class="line"></span>
<span class="line">cp /etc/yum.repos.d/public-yum-ol6.repo /etc/yum.repos.d/public-yum-ol6.repo.bak</span>
<span class="line">vi /etc/yum.repos.d/public-yum-ol6.repo</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">[public_ol6_latest]</span>
<span class="line">name=Oracle Linux $releasever Latest ($basearch)</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span><span class="regexp">/Server</span>
<span class="line">gpgcheck=0</span>
<span class="line">enabled=1</span>
<span class="line">#------------------------------------------------</span>
<span class="line"></span>
<span class="line">yum install -y cmake gcc gcc-c++ ncurses-devel bison zlib libxml openssl openssl-devel lrzsz</span></span>
</pre></td></tr></table></figure>
<h3 id="编译安装MySQL"><a href="#编译安装MySQL" class="headerlink" title="编译安装MySQL"></a>编译安装MySQL</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mydb1/mydb2</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mysql</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/conf</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/data/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/run/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/tmp/<span class="number">3306</span></span>
<span class="line"></span>
<span class="line">groupadd -g <span class="number">501</span> mysql</span>
<span class="line">useradd -u <span class="number">501</span> mysql -g mysql</span>
<span class="line">echo <span class="string">"mysql123"</span> | passwd --stdin mysql</span>
<span class="line"></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">755</span> /u01</span>
<span class="line"></span>
<span class="line"><span class="comment"># 进入源码目录</span></span>
<span class="line">cd /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span></span>
<span class="line"></span>
<span class="line">cmake \</span>
<span class="line">-DCMAKE_INSTALL_PREFIX=<span class="regexp">/u01/mysql</span> \</span>
<span class="line">-DINSTALL_DATADIR=<span class="regexp">/u01/data</span><span class="regexp">/3306  \</span>
<span class="line">-DDEFAULT_CHARSET=utf8 \</span>
<span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span>
<span class="line">-DEXTRA_CHARSETS=all \</span>
<span class="line">-DWITH_SSL=yes \</span>
<span class="line">-DWITH_EMBEDDED_SERVER=1 \</span>
<span class="line">-DENABLED_LOCAL_INFILE=1 \</span>
<span class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span>
<span class="line">-DMYSQL_UNIX_ADDR=/u</span>01/run/<span class="number">3306</span>/mysql.sock \</span>
<span class="line">-DMYSQL_TCP_PORT=<span class="number">3306</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DSYSCONFDIR=<span class="regexp">/etc \</span>
<span class="line">-DWITH_READLINE=on</span>
<span class="line"></span>
<span class="line">make &amp;&amp; make install</span></span>
</pre></td></tr></table></figure>
<h3 id="配置MySQL参数配置"><a href="#配置MySQL参数配置" class="headerlink" title="配置MySQL参数配置"></a>配置MySQL参数配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/conf</span>
<span class="line">vi my3306.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">[client]</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line"></span>
<span class="line">[mysql]</span>
<span class="line">pid_file=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysqld</span>.pid</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">autocommit=<span class="number">0</span></span>
<span class="line">general_log=off</span>
<span class="line">explicit_defaults_for_timestamp=true</span>
<span class="line">transaction_isolation=<span class="keyword">read</span>-committed</span>
<span class="line"></span>
<span class="line"><span class="comment"># system</span></span>
<span class="line">basedir=<span class="regexp">/u01/mysql</span></span>
<span class="line">datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">max_allowed_packet=1g</span>
<span class="line">max_connections=3000</span>
<span class="line">max_user_connections=2800</span>
<span class="line">open_files_limit=65535</span>
<span class="line">pid_file=/u</span>01/run/<span class="number">3306</span>/mysqld.pid</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">server_id=<span class="number">101</span></span>
<span class="line">skip_name_resolve=ON</span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line">tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line"></span>
<span class="line">#binlog</span>
<span class="line">log_bin=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog</span>
<span class="line">binlog_cache_size=<span class="number">32768</span></span>
<span class="line">binlog_format=row</span>
<span class="line">expire_logs_days=<span class="number">7</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">max_binlog_size=<span class="number">524288000</span></span>
<span class="line">sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#logging</span></span>
<span class="line">log_error=<span class="regexp">/u01/log</span><span class="regexp">/3306/error</span>.log</span>
<span class="line">slow_query_log_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/slow</span>.log</span>
<span class="line">log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">slow_query_log=<span class="number">1</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#relay</span></span>
<span class="line">relay_log=<span class="regexp">/u01/log</span><span class="regexp">/3306/relaylog</span></span>
<span class="line">relay_log_index=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>.index</span>
<span class="line">relay_log_info_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>-log.info</span>
<span class="line"></span>
<span class="line"><span class="comment">#slave</span></span>
<span class="line">slave_load_tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line">slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line">#innodb</span>
<span class="line">innodb_data_home_dir=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line">innodb_log_group_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3306/iblog</span></span>
<span class="line">innodb_adaptive_flushing=ON</span>
<span class="line">innodb_adaptive_hash_index=ON</span>
<span class="line">innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#default</span></span>
<span class="line">innodb_change_buffering=inserts</span>
<span class="line">innodb_checksums=ON</span>
<span class="line">innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">innodb_doublewrite=ON</span>
<span class="line">innodb_file_format=Barracuda</span>
<span class="line">innodb_file_per_table=ON</span>
<span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">innodb_flush_method=O_DIRECT</span>
<span class="line">innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">innodb_open_files=<span class="number">60000</span></span>
<span class="line">innodb_purge_threads=<span class="number">1</span></span>
<span class="line">innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">innodb_stats_on_metadata=OFF</span>
<span class="line">innodb_support_xa=ON</span>
<span class="line">innodb_use_native_aio=OFF</span>
<span class="line">innodb_write_io_threads=<span class="number">10</span></span>
<span class="line"></span>
<span class="line">[mysqld_safe]</span>
<span class="line">datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">#----------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># server_id=101 在mydb2上修改成102</span></span>
</pre></td></tr></table></figure>
<h3 id="初始化并启动数据库"><a href="#初始化并启动数据库" class="headerlink" title="初始化并启动数据库"></a>初始化并启动数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">echo <span class="string">"export PATH=\$PATH:\$HOME/bin:/u01/mysql/bin"</span> &gt;&gt; <span class="regexp">/home/mysql</span><span class="regexp">/.bash_profile</span>
<span class="line">su - mysql</span>
<span class="line">cd /u</span>01/mysql/scripts</span>
<span class="line">./mysql_install_db --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf \</span>
<span class="line">--datadir=/u</span>01/data/<span class="number">3306</span> --basedir=<span class="regexp">/u01/mysql</span> --user=mysql</span>
<span class="line"></span>
<span class="line"><span class="comment">#启动数据库</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line"></span>
<span class="line">#登陆数据库</span>
<span class="line">mysql --socket=/u</span>01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭数据库</span></span>
<span class="line">mysqladmin --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock <span class="keyword">shutdown</span> &amp;</span>
</pre></td></tr></table></figure>
<h3 id="快速搭建MySQL一主一从"><a href="#快速搭建MySQL一主一从" class="headerlink" title="快速搭建MySQL一主一从"></a>快速搭建MySQL一主一从</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mydb1 mydb2</span></span>
<span class="line">grant all privileges on *.* to <span class="string">'root'</span>@'localhost<span class="string">' identified by '</span>root123<span class="string">' with grant option;</span>
<span class="line">grant all privileges on *.* to '</span>root<span class="string">'@'</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="string">' identified by '</span>root123<span class="string">' with grant option;</span>
<span class="line">grant all privileges on *.* to '</span>root<span class="string">'@'</span><span class="number">10.245</span>%' identified by <span class="string">'root123'</span> with grant option;</span>
<span class="line"></span>
<span class="line">grant replication slave on *.* to rep@'<span class="number">10.245</span>.<span class="number">231.202</span><span class="string">' identified by '</span>rep123<span class="string">';</span>
<span class="line">grant replication slave on *.* to rep@'</span><span class="number">10.245</span>.<span class="number">231.203</span><span class="string">' identified by '</span>rep123<span class="string">';</span>
<span class="line"></span>
<span class="line"># mydb1</span>
<span class="line">show master status\G;</span>
<span class="line">*************************** 1. row ***************************</span>
<span class="line">             File: binlog.000005</span>
<span class="line">         Position: 540</span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line">1 row in set (0.00 sec)</span>
<span class="line"></span>
<span class="line"># mydb2</span>
<span class="line">CHANGE MASTER TO </span>
<span class="line">    MASTER_HOST='</span><span class="number">10.245</span>.<span class="number">231.202</span><span class="string">',</span>
<span class="line">    MASTER_PORT=3306,</span>
<span class="line">    MASTER_USER='</span>rep<span class="string">',</span>
<span class="line">    MASTER_PASSWORD='</span>rep123<span class="string">',</span>
<span class="line">    MASTER_LOG_FILE='</span>binlog.<span class="number">000005</span><span class="string">', </span>
<span class="line">    MASTER_LOG_POS=540;</span>
<span class="line">start slave;</span>
<span class="line">show slave status\G;</span></span>
</pre></td></tr></table></figure>
<h3 id="设置SSH公钥免密码登录"><a href="#设置SSH公钥免密码登录" class="headerlink" title="设置SSH公钥免密码登录"></a>设置SSH公钥免密码登录</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户在mymha/mydb1/mydb2</span></span>
<span class="line">cd ~</span>
<span class="line">ssh-keygen -t rsa</span>
<span class="line">ll /root/.ssh</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">total <span class="number">8</span></span>
<span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Apr  <span class="number">8</span> 09:<span class="number">59</span> id_rsa</span>
<span class="line">-rw-r--r-- <span class="number">1</span> root root  <span class="number">392</span> Apr  <span class="number">8</span> 09:<span class="number">59</span> id_rsa.pub</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># mydb1</span></span>
<span class="line">scp ~<span class="regexp">/.ssh/id</span>_rsa.pub mymha:<span class="regexp">/root/</span>.ssh/id_rsa.pub.mydb1</span>
<span class="line"><span class="comment"># mydb2</span></span>
<span class="line">scp ~<span class="regexp">/.ssh/id</span>_rsa.pub mymha:<span class="regexp">/root/</span>.ssh/id_rsa.pub.mydb2</span>
<span class="line"><span class="comment"># mymha</span></span>
<span class="line">cat ~<span class="regexp">/.ssh/id</span>_rsa.pub &gt;&gt; ~<span class="regexp">/.ssh/authorized</span>_keys</span>
<span class="line">cat ~<span class="regexp">/.ssh/id</span>_rsa.pub.mydb1 &gt;&gt; ~<span class="regexp">/.ssh/authorized</span>_keys</span>
<span class="line">cat ~<span class="regexp">/.ssh/id</span>_rsa.pub.mydb2 &gt;&gt; ~<span class="regexp">/.ssh/authorized</span>_keys</span>
<span class="line"><span class="keyword">chmod</span> <span class="number">600</span> ~<span class="regexp">/.ssh/authorized</span>_keys</span>
<span class="line">rm -rf ~<span class="regexp">/.ssh/id</span>_rsa.pub.mydb*</span>
<span class="line">scp ~<span class="regexp">/.ssh/authorized</span>_keys mydb1:<span class="regexp">/root/</span>.ssh/</span>
<span class="line">scp ~<span class="regexp">/.ssh/authorized</span>_keys mydb2:<span class="regexp">/root/</span>.ssh/</span>
<span class="line"></span>
<span class="line">ssh mydb1</span>
<span class="line">ssh mydb2</span>
<span class="line">ssh mymha</span>
</pre></td></tr></table></figure>
<h3 id="安装mha4mysql-manager和mha4mysql-node"><a href="#安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="安装mha4mysql-manager和mha4mysql-node"></a>安装mha4mysql-manager和mha4mysql-node</h3><h4 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在三个节点（node 和 manager）安装perl-DBD-MySQL，用光盘作yum源</span></span>
<span class="line">yum -<span class="keyword">y</span> install perl-DBD-MySQL perl-DBI mysql-libs</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在管理节点安装，用光盘yum源</span></span>
<span class="line">yum install perl-Time-HiRes</span>
<span class="line"></span>
<span class="line"><span class="comment"># 下载管理节点所需依赖包并安装</span></span>
<span class="line"><span class="comment">## http://mirrors.sohu.com/centos/6.8/os/x86_64/Packages/</span></span>
<span class="line"><span class="comment">## http://dl.fedoraproject.org/pub/epel/6/x86_64/</span></span>
<span class="line"><span class="comment">## 可以从以上两个网载中找到所需依赖包，下载后打包分享地址 http://pan.baidu.com/s/1eSzfAsq</span></span>
<span class="line">rpm -ivh perl-Config-Tiny-<span class="number">2.12</span>-<span class="number">7.1</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Params-Validate-<span class="number">0</span>.<span class="number">92</span>-<span class="number">3</span>.el6.x86_64.rpm</span>
<span class="line">rpm -ivh perl-MIME-Types-<span class="number">1.28</span>-<span class="number">2</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Email-Date-Format-<span class="number">1.002</span>-<span class="number">5</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Mail-Sender-<span class="number">0</span>.<span class="number">8.16</span>-<span class="number">3</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Mail-Sendmail-<span class="number">0</span>.<span class="number">79</span>-<span class="number">12</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-TimeDate-<span class="number">1.16</span>-<span class="number">13</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-MailTools-<span class="number">2.04</span>-<span class="number">4</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-MIME-Lite-<span class="number">3.027</span>-<span class="number">2</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Log-Dispatch-<span class="number">2.27</span>-<span class="number">1</span>.el6.noarch.rpm</span>
<span class="line">rpm -ivh perl-Parallel-ForkManager-<span class="number">0</span>.<span class="number">7.9</span>-<span class="number">1</span>.el6.noarch.rpm</span>
</pre></td></tr></table></figure>
<h4 id="在所有节点安装node包"><a href="#在所有节点安装node包" class="headerlink" title="在所有节点安装node包"></a>在所有节点安装node包</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载地址：http://olg2mr2vf.bkt.clouddn.com/mha4mysql-manager-0.56.tar.gz</span></span>
<span class="line">tar xzvf mha4mysql-node-<span class="number">0</span>.<span class="number">56</span>.tar.gz</span>
<span class="line">cd mha4mysql-node-<span class="number">0</span>.<span class="number">56</span></span>
<span class="line">perl Makefile.PL</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line"></span>
<span class="line">ll /usr/<span class="keyword">local</span>/bin/</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">-r-xr-xr-<span class="keyword">x</span> <span class="number">1</span> root root <span class="number">16367</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">10</span> apply_diff_relay_logs</span>
<span class="line">-r-xr-xr-<span class="keyword">x</span> <span class="number">1</span> root root  <span class="number">4807</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">10</span> filter_mysqlbinlog</span>
<span class="line">-r-xr-xr-<span class="keyword">x</span> <span class="number">1</span> root root  <span class="number">8261</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">10</span> purge_relay_logs</span>
<span class="line">-r-xr-xr-<span class="keyword">x</span> <span class="number">1</span> root root  <span class="number">7525</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">10</span> save_binary_logs</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="在管理节点安装manager包"><a href="#在管理节点安装manager包" class="headerlink" title="在管理节点安装manager包"></a>在管理节点安装manager包</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 下载地址：http://olg2mr2vf.bkt.clouddn.com/mha4mysql-node-0.56.tar.gz</span></span>
<span class="line">tar xzvf mha4mysql-manager-<span class="number">0</span>.<span class="number">56</span>.tar.gz</span>
<span class="line">cd mha4mysql-manager-<span class="number">0</span>.<span class="number">56</span></span>
<span class="line">perl Makefile.PL</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line"></span>
<span class="line">ll /usr/<span class="keyword">local</span>/bin/</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root <span class="number">16367</span> Apr  <span class="number">8</span> <span class="number">11</span>:08 apply_diff_relay_logs</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">4807</span> Apr  <span class="number">8</span> <span class="number">11</span>:08 filter_mysqlbinlog</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">1995</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_check_repl</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">1779</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_check_ssh</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">1865</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_check_status</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">3201</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_conf_host</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">2517</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_manager</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">2165</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_master_monitor</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">2373</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_master_switch</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">5171</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_secondary_check</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">1739</span> Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">12</span> masterha_stop</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">8261</span> Apr  <span class="number">8</span> <span class="number">11</span>:08 purge_relay_logs</span>
<span class="line">-r-xr-xr-x. <span class="number">1</span> root root  <span class="number">7525</span> Apr  <span class="number">8</span> <span class="number">11</span>:08 save_binary_logs</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="mha-配置文件"><a href="#mha-配置文件" class="headerlink" title="mha 配置文件"></a>mha 配置文件</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/mha/etc</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/mha/<span class="keyword">log</span></span>
<span class="line">vi /u01/mha/etc/app.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">[server default]</span>
<span class="line">user = root</span>
<span class="line">password = root123</span>
<span class="line">ssh_user = root</span>
<span class="line">repl_user = rep</span>
<span class="line">repl_password = rep123</span>
<span class="line">ping_interval = <span class="number">1</span></span>
<span class="line">ping_type = SELECT</span>
<span class="line"></span>
<span class="line">manager_workdir=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span></span>
<span class="line">manager_log=<span class="regexp">/u01/mha</span><span class="regexp">/log/manager</span>.log</span>
<span class="line">remote_workdir=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span></span>
<span class="line">master_binlog_dir=<span class="string">"/u01/log/3306/binlog"</span></span>
<span class="line"></span>
<span class="line">master_ip_failover_script=<span class="string">"/u01/mha/etc/master_ip_failover"</span></span>
<span class="line">master_ip_online_change_script=<span class="string">"/u01/mha/etc/master_ip_failover"</span></span>
<span class="line"></span>
<span class="line">shutdown_script=<span class="string">""</span></span>
<span class="line"></span>
<span class="line">report_script=<span class="string">""</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#check_repl_delay=0</span></span>
<span class="line"></span>
<span class="line">[server1]</span>
<span class="line">hostname=mydb1</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">master_binlog_dir=<span class="string">"/u01/log/3306/binlog"</span></span>
<span class="line">candidate_master=<span class="number">1</span></span>
<span class="line">ignore_fail=<span class="number">1</span></span>
<span class="line"></span>
<span class="line">[server2]</span>
<span class="line">hostname=mydb2</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">master_binlog_dir=<span class="string">"/u01/log/3306/binlog"</span></span>
<span class="line">candidate_master=<span class="number">1</span></span>
<span class="line">ignore_fail=<span class="number">1</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h4 id="master-ip-failover脚本"><a href="#master-ip-failover脚本" class="headerlink" title="master_ip_failover脚本"></a>master_ip_failover脚本</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /u01/mha/etc/master_ip_failover</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"><span class="comment">#!/usr/bin/env perl</span></span>
<span class="line"><span class="keyword">use</span> strict;</span>
<span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">use</span> Getopt::Long;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">my</span> (</span>
<span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span>
<span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span>
<span class="line">);</span>
<span class="line"> </span>
<span class="line"><span class="keyword">my</span> $vip = <span class="string">'10.245.231.204/24'</span>;</span>
<span class="line"><span class="comment"># Virtual IP</span></span>
<span class="line"><span class="keyword">my</span> $key = <span class="string">"1"</span>;</span>
<span class="line"><span class="keyword">my</span> $int = <span class="string">"eth0"</span>;</span>
<span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">"/sbin/ifconfig $int:$key $vip"</span>;</span>
<span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">"/sbin/ifconfig $int:$key down"</span>;</span>
<span class="line"><span class="keyword">my</span> $arp_effect = <span class="string">"/sbin/arping -Uq -s 10.245.231.204 -I $int 10.245.231.254 -c 3"</span>;</span>
<span class="line"><span class="comment"># Virtual IP and gateway</span></span>
<span class="line"><span class="comment">#my $test = "echo successfull &gt;/tmp/test.txt";</span></span>
<span class="line">$ssh_user = <span class="string">"root"</span>;</span>
<span class="line">GetOptions(</span>
<span class="line">    <span class="string">'command=s'</span>          =&gt; \$command,</span>
<span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \$ssh_user,</span>
<span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \$orig_master_host,</span>
<span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \$orig_master_ip,</span>
<span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \$orig_master_port,</span>
<span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span>
<span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \$new_master_ip,</span>
<span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \$new_master_port,</span>
<span class="line">);</span>
<span class="line"> </span>
<span class="line"><span class="keyword">exit</span> &amp;main();</span>
<span class="line"> </span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span>
<span class="line"> </span>
<span class="line">    <span class="keyword">print</span> <span class="string">"\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n"</span>;</span>
<span class="line"> </span>
<span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">"stop"</span> || $command eq <span class="string">"stopssh"</span> ) &#123;</span>
<span class="line"> </span>
<span class="line">        <span class="comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span></span>
<span class="line">        <span class="comment"># If you manage master ip address at global catalog database,</span></span>
<span class="line">        <span class="comment"># invalidate orig_master_ip here.</span></span>
<span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span>
<span class="line">        <span class="keyword">eval</span> &#123;</span>
<span class="line">            <span class="keyword">print</span> <span class="string">"Disabling the VIP on old master: $orig_master_host \n"</span>;</span>
<span class="line">            &amp;stop_vip();</span>
<span class="line">            $exit_code = <span class="number">0</span>;</span>
<span class="line">        &#125;;</span>
<span class="line">        <span class="keyword">if</span> ($@) &#123;</span>
<span class="line">            <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span>
<span class="line">            <span class="keyword">exit</span> $exit_code;</span>
<span class="line">        &#125;</span>
<span class="line">        <span class="keyword">exit</span> $exit_code;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"start"</span> ) &#123;</span>
<span class="line"> </span>
<span class="line">        <span class="comment"># all arguments are passed.</span></span>
<span class="line">        <span class="comment"># If you manage master ip address at global catalog database,</span></span>
<span class="line">        <span class="comment"># activate new_master_ip here.</span></span>
<span class="line">        <span class="comment"># You can also grant write access (create user, set read_only=0, etc) here.</span></span>
<span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span>
<span class="line">        <span class="keyword">eval</span> &#123;</span>
<span class="line">            <span class="keyword">print</span> <span class="string">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;</span>
<span class="line">            &amp;start_vip();</span>
<span class="line">            $exit_code = <span class="number">0</span>;</span>
<span class="line">        &#125;;</span>
<span class="line">        <span class="keyword">if</span> ($@) &#123;</span>
<span class="line">            <span class="keyword">warn</span> $@;</span>
<span class="line">            <span class="keyword">exit</span> $exit_code;</span>
<span class="line">        &#125;</span>
<span class="line">        <span class="keyword">exit</span> $exit_code;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"status"</span> ) &#123;</span>
<span class="line">        <span class="keyword">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span>
<span class="line">        <span class="comment">#`ssh $ssh_user\@cluster1 \" $ssh_start_vip \"`;</span></span>
<span class="line">        &amp;status();</span>
<span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">else</span> &#123;</span>
<span class="line">        &amp;usage();</span>
<span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
<span class="line"> </span>
<span class="line"><span class="comment"># A simple system call that enable the VIP on the new master</span></span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span>
<span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span>
<span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $arp_effect \"`</span>;</span>
<span class="line"><span class="comment">#    `ssh $ssh_user\@$new_master_host \" $test \"`;</span></span>
<span class="line">&#125;</span>
<span class="line"><span class="comment"># A simple system call that disable the VIP on the old_master</span></span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span>
<span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">status</span>() </span>&#123;</span>
<span class="line">    <span class="keyword">print</span> <span class="string">`ssh $ssh_user\@$orig_master_host \" ip add show $int \"`</span>;</span>
<span class="line">&#125;</span>
<span class="line"> </span>
<span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span>
<span class="line">    <span class="keyword">print</span></span>
<span class="line">    <span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_maste</span>
<span class="line">r_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span>
<span class="line">&#125;</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">chmod</span> +<span class="keyword">x</span> /u01/mha/etc/master_ip_failover</span>
</pre></td></tr></table></figure>
<h4 id="vip-add-配置"><a href="#vip-add-配置" class="headerlink" title="vip add 配置"></a>vip add 配置</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在master mydb1上执行下面命令（第一次启用可以手动配置vip address，不配置的话，自动切换后可生成）</span></span>
<span class="line">ifconfig eth<span class="number">0</span>:<span class="number">1</span> <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span></span>
</pre></td></tr></table></figure>
<h4 id="检测-启动-关闭MHA"><a href="#检测-启动-关闭MHA" class="headerlink" title="检测/启动/关闭MHA"></a>检测/启动/关闭MHA</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_ssh --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_repl --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf &amp;</span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_stop --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"></span>
<span class="line"><span class="comment"># 检测ssh等价性配置</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_ssh --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [info] Reading application default configuration from /u01/mha/etc/app.cnf..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [info] Reading server configuration from /u01/mha/etc/app.cnf..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [info] Starting SSH connection tests..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:09 <span class="number">2017</span> - [debug]  Connecting via SSH from root@mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">22</span>) to root@mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">22</span>)..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug]   ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug]  Connecting via SSH from root@mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">22</span>) to root@mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">22</span>)..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [debug]   ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">42</span>:<span class="number">10</span> <span class="number">2017</span> - [info] All SSH connection tests passed successfully.   <span class="comment"># successfully代表SSH等价性配置成功</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 检测MHA</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_repl --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"><span class="comment">## 检测问题和解决办法</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"><span class="comment"># 问题1：</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">15</span> <span class="number">2017</span> - [info]  read_only=<span class="number">1</span> is <span class="keyword">not</span> set on slave mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>).</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">15</span> <span class="number">2017</span> - [warning]  relay_log_purge=<span class="number">0</span> is <span class="keyword">not</span> set on slave mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)</span>
<span class="line"><span class="comment"># 问题2：</span></span>
<span class="line">Can <span class="keyword">not</span> <span class="keyword">exec</span> <span class="string">"mysqlbinlog"</span>: No such file <span class="keyword">or</span> directory at /usr/<span class="keyword">local</span>/share/perl5/MHA/BinlogManager.pm line <span class="number">106</span>.</span>
<span class="line">mysqlbinlog version command failed with rc <span class="number">1</span>:<span class="number">0</span>, please verify PATH, LD_LIBRARY_PATH, <span class="keyword">and</span> client options  at /usr/<span class="keyword">local</span>/bin/apply_diff_relay_logs line <span class="number">493</span></span>
<span class="line"><span class="comment"># 问题3：</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">17</span> <span class="number">2017</span> - [error][<span class="regexp">/usr/local</span><span class="regexp">/share/perl</span>5/MHA/MasterMonitor.pm, ln205] Slaves settings check failed!</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">17</span> <span class="number">2017</span> - [error][<span class="regexp">/usr/local</span><span class="regexp">/share/perl</span>5/MHA/MasterMonitor.pm, ln413] Slave configuration failed.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">17</span> <span class="number">2017</span> - [error][<span class="regexp">/usr/local</span><span class="regexp">/share/perl</span>5/MHA/MasterMonitor.pm, ln424] Error happened on checking configurations.  at /usr/<span class="keyword">local</span>/bin/masterha_check_repl line <span class="number">48</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">11</span>:<span class="number">44</span>:<span class="number">17</span> <span class="number">2017</span> - [error][<span class="regexp">/usr/local</span><span class="regexp">/share/perl</span>5/MHA/MasterMonitor.pm, ln523] Error happened on monitoring servers.</span>
<span class="line">....</span>
<span class="line">MySQL Replication Health is NOT OK!   <span class="comment"># NOT OK，MHA有问题需要解决，以下是解决步骤</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># mydb2</span></span>
<span class="line">set global read_only=<span class="number">1</span>;  </span>
<span class="line">set global relay_log_purge=<span class="number">0</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># mydb1/mydb2</span></span>
<span class="line">ln -<span class="keyword">s</span> /u01/mysql/bin/mysqlbinlog /usr/bin/mysqlbinlog</span>
<span class="line">ln -<span class="keyword">s</span> /u01/mysql/bin/mysql /usr/bin/mysql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 解决问题后再检测时状态是OK</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">33</span> <span class="number">2017</span> - [info]  OK.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">33</span> <span class="number">2017</span> - [warning] shutdown_script is <span class="keyword">not</span> defined.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Got <span class="keyword">exit</span> code <span class="number">0</span> (Not master dead).</span>
<span class="line"></span>
<span class="line">MySQL Replication Health is OK.</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动MHA后查看状态</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf &amp;</span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">app (pid:<span class="number">10163</span>) is running(<span class="number">0</span>:PING_OK), master:mydb1</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_stop --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
</pre></td></tr></table></figure>
<h2 id="MHA-failover故障切换"><a href="#MHA-failover故障切换" class="headerlink" title="MHA failover故障切换"></a>MHA failover故障切换</h2><h3 id="模拟主库宕机"><a href="#模拟主库宕机" class="headerlink" title="模拟主库宕机"></a>模拟主库宕机</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ssh mydb1 <span class="string">"killall -r mysqld"</span></span>
</pre></td></tr></table></figure>
<h3 id="查看管理节点日志，可以看到VIP已经漂移"><a href="#查看管理节点日志，可以看到VIP已经漂移" class="headerlink" title="查看管理节点日志，可以看到VIP已经漂移"></a>查看管理节点日志，可以看到VIP已经漂移</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /u01/mha/<span class="keyword">log</span>/manager.log |<span class="keyword">grep</span> -i vip</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Disabling the VIP on old master: mydb1 </span>
<span class="line">Enabling the VIP - <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span> on the new master - mydb2 </span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="验证VIP是否位于节点mydb2"><a href="#验证VIP是否位于节点mydb2" class="headerlink" title="验证VIP是否位于节点mydb2"></a>验证VIP是否位于节点mydb2</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ssh mydb2 <span class="string">"ifconfig |grep 231.204 -B1"</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">eth<span class="number">0</span>:<span class="number">1</span>    Link encap:Ethernet  HWaddr <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:A<span class="number">0</span>:<span class="number">35</span>:C<span class="number">0</span>  </span>
<span class="line">          inet addr:<span class="number">10.245</span>.<span class="number">231.204</span>  Bcast:<span class="number">10.245</span>.<span class="number">231.255</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 若VIP没有自动切换，可以使用以下命令手动切换（不建议）</span></span>
<span class="line">ifconfig eth<span class="number">0</span>:<span class="number">1</span> <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span></span>
<span class="line">arping -Uq -<span class="keyword">s</span> <span class="number">10.245</span>.<span class="number">231.204</span> -I eth<span class="number">0</span> <span class="number">10.245</span>.<span class="number">231.254</span> -c <span class="number">3</span></span>
<span class="line">ifconfig eth<span class="number">0</span>:<span class="number">1</span> down</span>
</pre></td></tr></table></figure>
<h3 id="查看管理节点MHA切换日志"><a href="#查看管理节点MHA切换日志" class="headerlink" title="查看管理节点MHA切换日志"></a>查看管理节点MHA切换日志</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">tail /u01/mha/<span class="keyword">log</span>/manager.log</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Started automated(non-interactive) failover.</span>
<span class="line">Invalidated master IP address on mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)</span>
<span class="line">The latest slave mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) has all relay logs <span class="keyword">for</span> recovery.</span>
<span class="line">Selected mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) as a new master.</span>
<span class="line">mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>): OK: Applying all logs succeeded.</span>
<span class="line">mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>): OK: Activated master IP address.</span>
<span class="line">Generating relay diff files from the latest slave succeeded.</span>
<span class="line">mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>): Resetting slave info succeeded.</span>
<span class="line">Master failover to mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) completed successfully.</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="new-master-old-slave"><a href="#new-master-old-slave" class="headerlink" title="new master(old slave)"></a>new master(old slave)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show master status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000007</span></span>
<span class="line">         Position: <span class="number">120</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure>
<h3 id="new-slave-old-master"><a href="#new-slave-old-master" class="headerlink" title="new slave(old:master)"></a>new slave(old:master)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开MySQL</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line">mysql -uroot -proot123 --socket=/u</span>01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line"><span class="comment"># 检查数据库</span></span>
<span class="line">mysql&gt; show master status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000013</span></span>
<span class="line">         Position: <span class="number">120</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; show slave  status\G</span>
<span class="line">Empty set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在管理节点日志中查主库的日志文件和位置</span></span>
<span class="line">cat /u01/mha/<span class="keyword">log</span>/manager.log |<span class="keyword">grep</span> -i change</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">14</span>:<span class="number">55</span>:<span class="number">24</span> <span class="number">2017</span> - [info]  All other slaves should start replication from here. </span>
<span class="line">Statement should be: CHANGE MASTER TO MASTER_HOST=<span class="string">'mydb2 or 10.245.231.203'</span>, MASTER_PORT=<span class="number">3306</span>, </span>
<span class="line">MASTER_LOG_FILE=<span class="string">'binlog.000007'</span>, MASTER_LOG_POS=<span class="number">120</span>, MASTER_USER=<span class="string">'rep'</span>, MASTER_PASSWORD=<span class="string">'xxx'</span>;</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 在slave连接master</span></span>
<span class="line">CHANGE MASTER TO</span>
<span class="line">  MASTER_HOST=<span class="string">'10.245.231.203'</span>,</span>
<span class="line">  MASTER_PORT=<span class="number">3306</span>,</span>
<span class="line">  MASTER_LOG_FILE=<span class="string">'binlog.000007'</span>,</span>
<span class="line">  MASTER_LOG_POS=<span class="number">120</span>,</span>
<span class="line">  MASTER_USER=<span class="string">'rep'</span>,</span>
<span class="line">  MASTER_PASSWORD=<span class="string">'rep123'</span>;</span>
<span class="line"></span>
<span class="line">start slave;</span>
</pre></td></tr></table></figure>
<h3 id="启动管理节点"><a href="#启动管理节点" class="headerlink" title="启动管理节点"></a>启动管理节点</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf &amp;</span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf  --ignore_last_failover &amp;</span>
</pre></td></tr></table></figure>
<h2 id="MHA-switchover线上切换"><a href="#MHA-switchover线上切换" class="headerlink" title="MHA switchover线上切换"></a>MHA switchover线上切换</h2><h3 id="master：关闭event-scheduler"><a href="#master：关闭event-scheduler" class="headerlink" title="master：关闭event_scheduler"></a>master：关闭event_scheduler</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># master mydb2</span></span>
<span class="line">/usr/<span class="keyword">local</span>/bin/masterha_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">app (pid:<span class="number">3793</span>) is running(<span class="number">0</span>:PING_OK), master:mydb2</span>
<span class="line"></span>
<span class="line"><span class="comment"># mydb2</span></span>
<span class="line">set global event_scheduler=off;</span>
</pre></td></tr></table></figure>
<h3 id="manager：关闭管理进程"><a href="#manager：关闭管理进程" class="headerlink" title="manager：关闭管理进程"></a>manager：关闭管理进程</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_stop --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
</pre></td></tr></table></figure>
<h3 id="manager：检查配置文件"><a href="#manager：检查配置文件" class="headerlink" title="manager：检查配置文件"></a>manager：检查配置文件</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 有没有被修改破坏。如果破坏需要重新编辑正确配置文件：/u01/mha/etc/app.cnf</span></span>
<span class="line">cp /u01/mha/etc/app.cnf.bak /u01/mha/etc/app.cnf</span>
</pre></td></tr></table></figure>
<h3 id="开始切换"><a href="#开始切换" class="headerlink" title="开始切换"></a>开始切换</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_master_switch --master_state=alive --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line"></span>
<span class="line">at Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] MHA::MasterRotate version <span class="number">0</span>.<span class="number">56</span>.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Starting online master switch..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Reading application default configuration from /u01/mha/etc/app.cnf..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Reading server configuration from /u01/mha/etc/app.cnf..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">0</span></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Current Alive Master: mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Alive Slaves:</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info]   mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)  Version=<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> (oldest major version between slaves) <span class="keyword">log</span>-bin:enabled</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">10.245</span>.<span class="number">231.203</span>(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">00</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span>
<span class="line"></span>
<span class="line">It is better to execute FLUSH NO_WRITE_TO_BINLOG TABLES on the master before switching. Is it ok to execute on mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)? (YES/<span class="keyword">no</span>): yes  <span class="comment"># 输yes</span></span>
<span class="line"></span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Executing FLUSH NO_WRITE_TO_BINLOG TABLES. This may take long time..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Checking MHA is <span class="keyword">not</span> monitoring <span class="keyword">or</span> doing failover..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Checking replication health on mydb1..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Searching new master from slaves..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  Candidate masters from the configuration file:</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]   mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)  Version=<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> (oldest major version between slaves) <span class="keyword">log</span>-bin:enabled</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">10.245</span>.<span class="number">231.203</span>(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]   mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>)  Version=<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> <span class="keyword">log</span>-bin:enabled</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  Non-candidate masters:</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  Searching from candidate_master slaves which have received the latest relay <span class="keyword">log</span> events..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">11</span> <span class="number">2017</span> - [info] </span>
<span class="line">From:</span>
<span class="line">mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) (current master)</span>
<span class="line"> +--mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)</span>
<span class="line"></span>
<span class="line">To:</span>
<span class="line">mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>) (new master)</span>
<span class="line"></span>
<span class="line">Starting master switch from mydb2(<span class="number">10.245</span>.<span class="number">231.203</span>:<span class="number">3306</span>) to mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>)? (yes/NO): yes   <span class="comment"># 输yes</span></span>
<span class="line">......</span>
<span class="line">IN SCRIPT TEST====<span class="regexp">/sbin/ifconfig</span> eth<span class="number">0</span>:<span class="number">1</span> down==<span class="regexp">/sbin/ifconfig</span> eth<span class="number">0</span>:<span class="number">1</span> <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span>===</span>
<span class="line"></span>
<span class="line">Enabling the VIP - <span class="number">10.245</span>.<span class="number">231.204</span>/<span class="number">24</span> on the new master - mydb1 </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] * Switching slaves in parallel..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Unlocking all tables on the orig master:</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing UNLOCK TABLES..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  ok.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] All new slave servers switched successfully.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] </span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  mydb1: Resetting slave info succeeded.</span>
<span class="line">Sat Apr  <span class="number">8</span> <span class="number">15</span>:<span class="number">23</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Switching master to mydb1(<span class="number">10.245</span>.<span class="number">231.202</span>:<span class="number">3306</span>) completed successfully.</span>
</pre></td></tr></table></figure>
<h3 id="new-master-old-slave-1"><a href="#new-master-old-slave-1" class="headerlink" title="new master(old slave)"></a>new master(old slave)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show master status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000013</span></span>
<span class="line">         Position: <span class="number">936</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; show slave status\G</span>
<span class="line">Empty set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure>
<h3 id="new-slave-old-master-1"><a href="#new-slave-old-master-1" class="headerlink" title="new slave(old master)"></a>new slave(old master)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">CHANGE MASTER TO</span>
<span class="line">  MASTER_HOST=<span class="string">'10.245.231.202'</span>,</span>
<span class="line">  MASTER_PORT=<span class="number">3306</span>,</span>
<span class="line">  MASTER_LOG_FILE=<span class="string">'binlog.000013'</span>,</span>
<span class="line">  MASTER_LOG_POS=<span class="number">936</span>,</span>
<span class="line">  MASTER_USER=<span class="string">'rep'</span>,</span>
<span class="line">  MASTER_PASSWORD=<span class="string">'rep123'</span>;</span>
<span class="line"></span>
<span class="line">mysql&gt; start slave;</span>
<span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0</span>.<span class="number">01</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; show slave status\G</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000013</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">936</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">280</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000013</span></span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: Yes</span>
</pre></td></tr></table></figure>
<h3 id="启动管理节点-1"><a href="#启动管理节点-1" class="headerlink" title="启动管理节点"></a>启动管理节点</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">/usr/<span class="keyword">local</span>/bin/masterha_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf &amp;</span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_manager --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf --remove_dead_master_conf --ignore_last_failover &amp;</span>
<span class="line"></span>
<span class="line"><span class="regexp">/usr/local</span><span class="regexp">/bin/masterha</span>_check_status --conf=<span class="regexp">/u01/mha</span><span class="regexp">/etc/app</span>.cnf</span>
<span class="line">app (pid:<span class="number">4463</span>) is running(<span class="number">0</span>:PING_OK), master:mydb1</span>
</pre></td></tr></table></figure>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><p>MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，是日本的一位MySQL专家采用Perl语言编写的一个脚本管理工具，目的在于维持MySQL Replication中<font color="red">Master库的高可用性</font>，其最大特点是可以修复多个Slave之间的差异日志，最终使所有Slave保持数据一致，然后从中选择一个充当新的Master，并将其它Slave指向它。</p>
<p>MHA集群架构图<br><img src="http://oligvdnzp.bkt.clouddn.com/0406_mha_01.png" alt=""></p>
<h3 id="MHA监控"><a href="#MHA监控" class="headerlink" title="MHA监控"></a>MHA监控</h3><ul>
<li>MHA监控最主要的就是监控master，每<code>ping_interval</code>秒监控master一次。</li>
<li>MHA自身提供了两种监控方式：SELECT和CONNECT，控制参数<code>ping_type</code></li>
<li>MHA调用SSH脚本对所有Node执行检查，包括：<ul>
<li>Master服务器是否可以SSH连通</li>
<li>MySQL实例是否可以连接</li>
<li>检查SQL Thread的状态</li>
<li>检查哪些Server死掉了，哪些Server是活动的，以及活动的Slave实例</li>
<li>检查Slave实例的配置及复制过滤规则</li>
</ul>
</li>
<li>MHA监控检查Master Node异常时操作：<ol>
<li>SQL Thread alive? NO: Restart it</li>
<li>调用<code>master_ip_failover_script</code>关闭VIP</li>
<li>检查各个Slave，获取最近的和最旧的<code>binary log file</code>和<code>position</code>，并检查各个Slave成为Master的优先级</li>
<li>若dead master所在服务器依然可以通过SSH连通，则提取dead master的binary log。另外，MHA还要对各个Slave节点SSH连通性进行检查。</li>
<li>调用<code>apply_diff_relay_logs</code>命令恢复Slave的差异日志，即各个Slave之间的relay log</li>
<li>差异日志恢复到New Master上，然后获取New Master的binlogname和position，最后会开启New Master的写权限</li>
<li>清理New Master其实就是重置slave info，即取消原来的Slave信息</li>
</ol>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hexo文章的密码访问]]></title>
      <url>/2017/03/31/tools/Hexo%E6%96%87%E7%AB%A0%E7%9A%84%E5%AF%86%E7%A0%81%E8%AE%BF%E9%97%AE/</url>
      <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>工作中有些文档中的部分内容，虽然机密性不高，但也不便在网上直接公开发布。 这时可以通过以下的小技巧来实现<code>简单</code>的文档密码保护。</p>
<h2 id="方法实现"><a href="#方法实现" class="headerlink" title="方法实现"></a>方法实现</h2><p>因Hexo中Markdown语言和html是混用的，所以可直接在Markdown中直接插入以下这段<code>script</code>(建议放到<code>&lt;!-- more --&gt;</code>段后面)。<br>这里用到了windows对象的<code>alert()</code>方法和<code>prompt()</code>方法。<code>prompt()</code>方法的作用即是显示一个可提示用户输入的对话框，而其本身的返回值就是你输入的那个字符串。因此只需要将其与你默认的密码比较一下就好，如果不正确，则直接将当前页面的loaction属性设为上一个页面即可。<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span>
<span class="line">    <span class="keyword">if</span>(<span class="string">"123"</span>==prompt(<span class="string">"请输入文档密码"</span>))</span>
<span class="line">    &#123;</span>
<span class="line">        alert(<span class="string">"密码正确"</span>);</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">else</span></span>
<span class="line">    &#123;</span>
<span class="line">        alert(<span class="string">"密码错误返回主页"</span>);</span>
<span class="line">        location=<span class="string">"/"</span>;</span>
<span class="line">    &#125;</span>
<span class="line">&lt;<span class="regexp">/script&gt;</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[数据库GI PSU，SPU(CPU)，Bundle Patches 和 Patchsets 补丁号码快速参考 (文档 ID 1922396.1)]]></title>
      <url>/2017/03/31/oracle/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A5%E4%B8%81%E5%8F%B7%E7%A0%81%E5%BF%AB%E9%80%9F%E5%8F%82%E8%80%83%20(%E6%96%87%E6%A1%A3%20ID%201922396.1)/</url>
      <content type="html"><![CDATA[<p>原文件地址(需登陆MOS)：<br><a href="https://support.oracle.com/epmos/faces/DocumentDisplay?_afrLoop=247921994816714&amp;id=1922396.1" target="_blank" rel="external">https://support.oracle.com/epmos/faces/DocumentDisplay?_afrLoop=247921994816714&amp;id=1922396.1 </a></p>
<h2 id="Base-Releases"><a href="#Base-Releases" class="headerlink" title="Base Releases"></a>Base Releases</h2><blockquote>
<p>12.2.0.1.0  12.2.0.1.0 Download Page<br>12.1.0.1.0  开一个非技术SR来获取物理介质或下载链接,根据Doc ID 1071023.1<br>11.2.0.1.0  11.2.0.1.0 Download Page<br>Older Versions  开一个非技术SR来获取物理介质或下载链接,根据Doc ID 1071023.1<br> 注意: 对于11.2.0.2或者更高的patchsets, 请参照patch的readme中”Software Availability”部分下的”Table 1 Installation Types and Associated Zip Files”来查找具体哪些zip文件需要下载。</p>
</blockquote>
<a id="more"></a>
<h2 id="Patchsets"><a href="#Patchsets" class="headerlink" title="Patchsets"></a>Patchsets</h2><p> l12.1.0.2 (12.1.0.2.0 PATCH SET FOR ORACLE DATABASE SERVER)     21419221<br> 11.2.0.4 (11.2.0.4.0 PATCH SET FOR ORACLE DATABASE SERVER)  13390677<br> 11.2.0.3 (11.2.0.3.0 PATCH SET FOR ORACLE DATABASE SERVER)  10404530<br> 11.2.0.2 (11.2.0.2.0 PATCH SET FOR ORACLE DATABASE SERVER)  10098816<br> 11.1.0.7 (11.1.0.7.0 PATCH SET FOR ORACLE DATABASE SERVER)  6890831<br> 10.2.0.5 (10.2.0.5 PATCH SET FOR ORACLE DATABASE SERVER)    8202632<br> d10.2.0.4 (10.2.0.4.0 PATCH SET FOR ORACLE DATABASE SERVER)     6810189<br> e10.2.0.3 (10.2.0.3 PATCH SET FOR ORACLE DATABASE SERVER)   5337014<br> 10.2.0.2 (10.2.0.2 PATCH SET FOR ORACLE DATABASE SERVER)    4547817<br> 10.1.0.5 (10.1.0.5 PATCH SET FOR ORACLE DATABASE SERVER)<br> 4505133<br> 10.1.0.4 (10.1.0.4 PATCH SET FOR ORACLE DATABASE SERVER)<br> 4163362<br> 10.1.0.3 (10.1.0.3 PATCH SET FOR ORACLE DATABASE SERVER)<br> 3761843<br> 9.2.0.8 (9.2.0.8 PATCH SET FOR ORACLE DATABASE SERVER)<br> 4547809<br> 9.2.0.7 (9.2.0.7 PATCH SET FOR ORACLE DATABASE SERVER)<br> 4163445<br> 9.2.0.6 (9.2.0.6 PATCH SET FOR ORACLE DATABASE SERVER)<br> 3948480<br> 9.2.0.5 (ORACLE 9I DATABASE SERVER RELEASE 2 - PATCH SET 4 VERSION 9.2.0.5.0)<br> 3501955<br> 9.2.0.4 (9.2.0.4 PATCH SET FOR ORACLE DATABASE SERVER)<br> 3095277<br> 9.2.0.3 (9.2.0.3 PATCH SET FOR ORACLE DATABASE SERVER)<br> 2761332<br> 9.2.0.2 (9.2.0.2 PATCH SET FOR ORACLE DATABASE SERVER)<br> 2632931<br> 9.0.1.5 (9.0.1.5 PATCHSET)<br> 3301544<br> 9.0.1.4 (9.0.1.4 PATCH SET FOR ORACLE DATABASE SERVER)<br> 2517300<br> 9.0.1.3 (9.0.1.3. PATCH SET FOR ORACLE DATA SERVER)<br> 2271678<br> 8.1.7.4 (8.1.7.4 PATCH SET FOR ORACLE DATA SERVER)<br> 2376472<br> 8.1.7.3 (8.1.7.3 PATCH SET FOR ORACLE DATA SERVER)<br> 2189751<br> 8.1.7.2 (8.1.7.2.1 PATCH SET FOR ORACLE DATA SERVER)<br> 1909158</p>
<p>PSU, SPU(CPU), Bundle Patches</p>
<p>12.1.0.2</p>
<p> Description     PSU       GI PSU   Proactive Bundle Patch   Bundle Patch (Windows 32bit &amp; 64bit)<br> JAN2017     24732082 (12.1.0.2.170117)  24917825 (12.1.0.2.170117)  24968615 (12.1.0.2.170117)  25115951 (12.1.0.2.170117)<br> OCT2016     24006101 (12.1.0.2.161018)  24412235 (12.1.0.2.161018)  24448103 (12.1.0.2.161018)  24591642 (12.1.0.2.161018)<br> JUL2016     23054246 (12.1.0.2.160719)  23273629 (12.1.0.2.160719)  23273686 (12.1.0.2.160719)  23530387 (12.1.0.2.160719)<br> APR2016     22291127 (12.1.0.2.160419)  22646084 (12.1.0.2.160419)  22899531    22809813 (12.1.0.2.160419)<br> JAN2016     21948354 (12.1.0.2.160119)  22191349 (12.1.0.2.160119)  22243551    22310559 (12.1.0.2.160119)<br> OCT2015     21359755 (12.1.0.2.5)   21523234 (12.1.0.2.5)   21744410 (12.1.0.2.13)  21821214 (12.1.0.2.10)<br> JUL2015     20831110 (12.1.0.2.4)   20996835 (12.1.0.2.4)   21188742 (12.1.0.2.10)  21126814 (12.1.0.2.7)<br> APR2015     20299023 (12.1.0.2.3)   20485724 (12.1.0.2.3)   20698050 (12.1.0.2.7)   20684004 (12.1.0.2.4)<br> JAN2015     19769480 (12.1.0.2.2)   19954978 (12.1.0.2.2)   20141343 (12.1.0.2.4)   19720843 (12.1.0.2.1)<br> OCT2014     19303936 (12.1.0.2.1)   19392646 (12.1.0.2.1)   19404326 (12.1.0.2.1)   N/A</p>
<p>12.1.0.1</p>
<p> Description     PSU     GI PSU   Bundle Patch (Windows64bit)    Bundle Patch (Windows32bit)<br> JUL2016     23054354 (12.1.0.1.160719)  i23273935 / k23273958  (12.1.0.1.160719)   23530410 (12.1.0.1.160719)<br> APR2016     22291141 (12.1.0.1.160419)  i22654153 / k22654166 (12.1.0.1.160419)    22617408 (12.1.0.1.160419)<br> JAN2016     21951844 (12.1.0.1.160119)  j22191492 / k22191511 (12.1.0.1.160119)    22494866 (12.1.0.2.160119)<br> OCT2015     21352619 (12.1.0.1.9)   j21551666 / k21551685 (12.1.0.1.9) 21744907 (12.1.0.1.21)<br> JUL2015     20831107 (12.1.0.1.8)    j20996901 / k20996911 (12.1.0.1.8)    21076681  (12.1.0.1.20)<br> APR2015     20299016 (12.1.0.1.7)    j20485762 / k19971331 (12.1.0.1.7)    20558101 (12.1.0.1.18)<br> JAN2015     19769486 (12.1.0.1.6)   j19971324 / k19971331 (12.1.0.1.6) 20160748 (12.1.0.1.16)<br> OCT2014     19121550 (12.1.0.1.5)   j19392372 / k19392451 (12.1.0.1.5) 19542943 (12.1.0.1.14)<br> JUL2014     18522516 (12.1.0.1.4)   j18705901 / k18705972 (12.1.0.1.4) 19062327 (12.1.0.1.11)<br> APR2014     18031528 (12.1.0.1.3)   j18139660 / k18413105  (12.1.0.1.3)    18448604 (12.1.0.1.7)<br> JAN2014     17552800 (12.1.0.1.2)   17735306 (12.1.0.1.2)  17977915 (12.1.0.1.3)<br> OCT2013     17027533 (12.1.0.1.1)   17272829 (12.1.0.1.1)   17363796 (12.1.0.1.1)   17363795 (12.1.0.1.1)</p>
<p>11.2.0.4</p>
<p> Description     PSU     SPU(CPU)    GI PSU  Bundle Patch (Windows 32bit &amp; 64bit)<br> mJAN2017    N/A     N/A     N/A     N/A<br> OCT2016     24006111 (11.2.0.4.161018)  24433711 (11.2.0.4.161018)  24436338 (11.2.0.4.161018)  24922870 (11.2.0.4.161118)<br> JUL2016     23054359 (11.2.0.4.160719)  23177648 (11.2.0.4.160719)  23274134 (11.2.0.4.160719)  23530402 (11.2.0.4.160719)<br> APR2016     22502456 (11.2.0.4.160419)  22502493 (11.2.0.4.160419)  22646198 (11.2.0.4.160419)  22839608 (11.2.0.4.160419)<br> JAN2016     21948347 (11.2.0.4.160119)  21972320 (11.2.0.4.160119)  22191577 (11.2.0.4.160119)  22310544 (11.2.0.4.160119)<br> OCT2015     21352635 (11.2.0.4.8)   21352646    21523375 (11.2.0.4.8)   21821802 (11.2.0.4.20)<br> JUL2015     20760982 (11.2.0.4.7)   20803583    20996923 (11.2.0.4.7)   21469106 (11.2.0.4.18)<br> APR2015     20299013 (11.2.0.4.6)   20299015    20485808 (11.2.0.4.6)   20544696 (11.2.0.4.15)<br> JAN2015     19769489 (11.2.0.4.5)   19854503    19955028 (11.2.0.4.5)   20127071 (11.2.0.4.12)<br> OCT2014     19121551 (11.2.0.4.4)   19271443    19380115 (11.2.0.4.4)   19651773 (11.2.0.4.10)<br> JUL2014     18522509 (11.2.0.4.3)   18681862    18706472 (11.2.0.4.3)   18842982 (11.2.0.4.7)<br> APR2014     18031668 (11.2.0.4.2)   18139690    18139609 (11.2.0.4.2)   18296644 (11.2.0.4.4)<br> JAN2014     17478514 (11.2.0.4.1)   17551709    N/A     17987366 (11.2.0.4.1)</p>
<p>11.2.0.3</p>
<p> Description     PSU     SPU(CPU)    GI PSU  Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br> aJUL2015    20760997 (11.2.0.3.15)  20803576    20996944 (11.2.0.3.15)  21104036    21104035<br> APR2015     20299017 (11.2.0.3.14)  20299010    20485830 (11.2.0.3.14)  20420395    20420394<br> JAN2015     19769496 (11.2.0.3.13)  19854461    19971343 (11.2.0.3.13)  20233168    20233167<br> OCT2014     19121548 (11.2.0.3.12)  19271438    19440385 (11.2.0.3.12)  19618575    19618574<br> JUL2014     18522512 (11.2.0.3.11)  18681866    18706488 (11.2.0.3.11)  18940194    18940193<br> APR2014     18031683 (11.2.0.3.10)  18139695    18139678 (11.2.0.3.10)  18372244    18372243<br> JAN2014     17540582 (11.2.0.3.9)   17478415    17735354 (11.2.0.3.9)   18075406    17906981<br> OCT2013     16902043 (11.2.0.3.8)   17082364    17272731 (11.2.0.3.8)   17363850    17363844<br> JUL2013     16619892 (11.2.0.3.7)   16742095    16742216 (11.2.0.3.7)   16803775    16803774<br> APR2013     16056266 (11.2.0.3.6)   16294378    16083653 (11.2.0.3.6)   16345834    16345833<br> JAN2013     14727310 (11.2.0.3.5)   14841409    14727347 (11.2.0.3.5)   16042648    16042647<br> OCT2012     14275605 (11.2.0.3.4)   14390252    14275572 (11.2.0.3.4)   14613223    14613222<br> JUL2012     13923374 (11.2.0.3.3)   14038787    13919095 (11.2.0.3.3)   14223718    14223717<br> APR2012     13696216 (11.2.0.3.2)   13632717    13696251 (11.2.0.3.2)   13885389    13885388<br> JAN2012     13343438 (11.2.0.3.1)   13466801    13348650 (11.2.0.3.1)   13413168    13413167</p>
<p>11.2.0.2</p>
<p> Description     PSU      SPU(CPU)   GI PSU  Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br> aOCT2013    17082367 (11.2.0.2.12)  17082375    17272753 (11.2.0.2.12)  17363838    17363837<br> JUL2013     16619893 (11.2.0.2.11)  16742100    16742320 (11.2.0.2.11)  16345852    16345851<br> APR2013     16056267 (11.2.0.2.10)  16294412    16166868 (11.2.0.2.10)  16345846    16345845<br> JAN2013     14727315 (11.2.0.2.9)   14841437    14841385 (11.2.0.2.9)   16100399    16100398<br> OCT2012     14275621 (11.2.0.2.8)   14390377    14390437 (11.2.0.2.8)   14672268    14672267<br> JUL2012     13923804 (11.2.0.2.7)   14038791    14192201 (11.2.0.2.7)   14134043    14134042<br> APR2012     13696224 (11.2.0.2.6)   13632725    13696242 (11.2.0.2.6)   13697074    13697073<br> JAN2012     13343424 (11.2.0.2.5)   13343244    13653086 (11.2.0.2.5)   13413155    13413154<br> OCT2011     12827726 (11.2.0.2.4)   12828071    12827731 (11.2.0.2.4)   13038788    13038787<br> JUL2011     12419331 (11.2.0.2.3)   12419321    12419353 (11.2.0.2.3)   12714463    12714462<br> APR2011     11724916 (11.2.0.2.2)   11724984    12311357 (11.2.0.2.2)   11896292    11896290<br> JAN2011     10248523 (11.2.0.2.1)   N/A     N/A     10432053    10432052</p>
<p>11.2.0.1</p>
<p> Description     PSU     CPU     Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br> aJUL2011    12419378 (11.2.0.1.6)   12419278    12429529    12429528<br> APR2011     11724930 (11.2.0.1.5)   11724991    11731176    11883240<br> JAN2011     10248516 (11.2.0.1.4)   10249532    10432045    10432044<br> OCT2010     9952216 (11.2.0.1.3)    9952260     10100101    10100100<br> JUL2010     9654983 (11.2.0.1.2)    9655013     9736865     9736864<br> APR2010     9352237 (11.2.0.1.1)    9369797     N/A     N/A</p>
<p>11.1.0.7</p>
<p> Description     PSU     SPU(CPU)    Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br>JUL2015  20761024 (11.1.0.7.24)  20803573    21104030    21104029<br>APR2015  20299012 (11.1.0.7.23)  20299020    20420391    20420390<br>JAN2015  19769499 (11.1.0.7.22)  19854433    20126915    20126914<br>OCT2014  19152553 (11.1.0.7.21)  19274522    19609034    19609032<br>JUL2014  18522513 (11.1.0.7.20)  18681875    18944208    18944207<br>APR2014  18031726 (11.1.0.7.19)  18139703    18372258    18372257<br>JAN2014  17465583 (11.1.0.7.18)  17551415    17906936    17906935<br>OCT2013  17082366 (11.1.0.7.17)  17082374    17363760    17363759<br>JUL2013  16619896 (11.1.0.7.16)  16742110    16803788    16803787<br>APR2013  16056268 (11.1.0.7.15)  16308394    16345862    16345861<br>JAN2013  14739378 (11.1.0.7.14)  14841452    15848067    15848066<br>OCT2012  14275623 (11.1.0.7.13)  14390384    14672313    14672312<br> JUL2012     13923474 (11.1.0.7.12)  14038803    14109868    14109867<br> APR2012     13621679 (11.1.0.7.11)  13632731    13715810    13715809<br> JAN2012     13343461 (11.1.0.7.10)  13343453    13460956    13460955<br> OCT2011     12827740 (11.1.0.7.9)   12828097    12914916    12914915<br> JUL2011     12419384 (11.1.0.7.8)   12419265    12695278    12695277<br> APR2011     11724936 (11.1.0.7.7)   11724999    11741170    11741169<br> JAN2011     10248531 (11.1.0.7.6)   10249534    10350788    10350787<br> OCT2010     9952228  (11.1.0.7.5)   9952269     9773825     9773817<br> JUL2010     9654987 (11.1.0.7.4)    9655014     9869912     9869911<br> APR2010     9352179 (11.1.0.7.3)    9369783     9392335     9392331<br> JAN2010     9209238 (11.1.0.7.2)    9114072     9166861     9166858<br> OCT2009     8833297 (11.1.0.7.1)    8836375     8928977     8928976<br> JUL2009     N/A     8534338     8553515     8553512<br> APR2009     N/A     8290478     8343070     8343061</p>
<p>11.1.0.6</p>
<p> Description     CPU     Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)<br> aJUL2009    8534378     8563155     8563154<br> APR2009     8290402     8333657     8333655<br> JAN2009     7592335     7631981     7631980<br> OCT2008     7375639     7378393     7378392<br> JUL2008     7150417     7210197     7210195<br> APR2008     6864063     6867180     6867178 </p>
<p>10.2.0.5</p>
<p> Description     PSU     SPU(CPU)    Bundle Patch (Windows64bit)     Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> bJUL2015    20299014 (10.2.0.5.19)  20299021    20420387    20420386    N/A<br> APR2015     N/A     N/A     N/A     N/A     N/A<br> JAN2015     19769505 (10.2.0.5.18)  19854436    20126868    20126867    N/A<br> OCT2014     19274523 (10.2.0.5.17)  19274521    19618565    19618563    N/A<br> JUL2014     18522511 (10.2.0.5.16)  18681879    18940198    18940196    N/A<br> APR2014     18031728 (10.2.0.5.15)  18139709    18372261    18372259    N/A<br> JAN2014     17465584 (10.2.0.5.14)  17551414    17906974    17906972    N/A<br> OCT2014     17082365 (10.2.0.5.13)  17082371    N/A     17363822    N/A<br> JUL2013     16619894 (10.2.0.5.12)  16742123    16803782    16803780    16803781<br> APR2013     16056270 (10.2.0.5.11)  16270946    16345857    16345855    16345856<br> JAN2013     14727319 (10.2.0.5.10)  14841459    15848062    15848060    15848061<br> OCT2012     14275629 (10.2.0.5.9)   14390396    14553358    14553356    14553357<br> JUL2012     13923855 (10.2.0.5.8)   14038805    14134053    14134051    14134052<br> APR2012     13632743 (10.2.0.5.7)   13632738    13654815    13654814    13870404<br> JAN2012     13343471 (10.2.0.5.6)   13343467    13460968   13460967     N/A<br> OCT2011     12827745 (10.2.0.5.5)   12828105    c12914913   12914911    N/A<br> JUL2011     12419392 (10.2.0.5.4)   12419258    12429524    12429523    N/A<br> APR2011     11724962 (10.2.0.5.3)   11725006    12328269    12328268    N/A<br> JAN2011     10248542 (10.2.0.5.2)   10249537    10352673    10352672    N/A<br> OCT2010     9952230 (10.2.0.5.1)    9952270     10099855    10058290    N/A</p>
<p>10.2.0.4</p>
<p> Description     PSU     SPU(CPU)    Bundle Patch (Windows32bit)     Bundle Patch (Windows64bit)     Bundle Patch (WindowsItanium)<br> gJUL2013    16619897 (10.2.0.4.17)  16742253    N/A     N/A     N/A<br> gAPR2013    16056269 (10.2.0.4.16)  16270931    N/A     N/A     N/A<br> gJAN2013    14736542 (10.2.0.4.15)  14841471    N/A     N/A     N/A<br>gOCT2012     14275630 (10.2.0.4.14)  14390410    N/A     N/A     N/A<br>gJUL2012     13923851 (10.2.0.4.13)  14038814    N/A     N/A     N/A<br> aAPR2012    12879933 (10.2.0.4.12)  12879926    13928775    13928776    N/A<br> JAN2012     12879929 (10.2.0.4.11)  12879912    b13654060   N/A     N/A<br> OCT2011     12827778 (10.2.0.4.10)  12828112    12914908    12914910    12914909<br> JUL2011     12419397 (10.2.0.4.9)   12419249    12429519    12429521    12429520<br> APR2011     11724977 (10.2.0.4.8)   11725015    12328501    12328503    12328502<br> JAN2011     10248636 (10.2.0.4.7)   10249540    10349197    10349200    10349198<br> OCT2010     9952234 (10.2.0.4.6)    9952272     10084980    10084982    10084981<br> JUL2010     9654991 (10.2.0.4.5)    9655017     9777076     9777078     9777077<br> APR2010     9352164 (10.2.0.4.4)    9352191     9393548     9393550     9393549<br> JAN2010     9119284 (10.2.0.4.3)    9119226     9169457     9169460     9169458<br> OCT2009     8833280 (10.2.0.4.2)    8836308     8880857     8880861     8880858<br> JUL2009     8576156 (10.2.0.4.1)    8534387     8559466     8559467     8541782<br> APR2009     N/A     8290506     8307237     8307238     8333678<br> JAN2009     N/A     7592346     7584866     7584867     N/A<br> OCT2008     N/A     7375644     7386320     7386321     N/A<br> JUL2008     N/A     7150470     7218676     7218677     N/A</p>
<p>10.2.0.3</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)   Bundle Patch (Windows64bit)<br> aJAN2009    7592354     7631956     7631958     7631957<br> OCT2008     7369190     7353782     7353784     7353785<br> JUL2008     7150622     7252496     7252497     7252498<br> APR2008     6864068     6867054     6867055     6867056<br> JAN2008     6646853     6637237     6637238     6637239<br> OCT2007     6394981     6430171     6430173     6430174<br> JUL2007     6079591     6116131     6038242     6116139<br> APR2007     5901891     5948242     5916262     5948243<br> JAN2007     5881721     5846376     5846377     5846378</p>
<p>10.2.0.2</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)      Bundle Patch (Windows64bit)    Bundle Patch (WindowsItanium)<br> iJAN2009    7592355     N/A     N/A     N/A<br> hOCT2008    7375660     N/A     N/A     N/A<br> hJUL2008    7154083     N/A     N/A     N/A<br> hAPR2008    6864071     N/A     N/A     N/A<br> aJAN2008    6646850     N/A     N/A     N/A<br> fOCT2007    6394997     6397028     6397030     6397029<br> JUL2007     6079588     6013105     6013121     6013118<br> APR2007     5901881     5912173     5912179     5912176<br> JAN2007     5689957     5716143     5699839     5699824<br> OCT2006     5490848     5502226     5500921     5500894<br> JUL2006     5225799     5251025     5251028     5251026<br> APR2006     5079037     5140461     5140567     5140508</p>
<p>10.2.0.1</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (Windows64bit)     Bundle Patch (WindowsItanium)<br> APR2007     5901880     N/A     N/A     N/A<br> JAN2007     5689937     5695784     5695786     5695785<br> OCT2006     5490846     5500927     5500954     5500951<br> JUL2006     5225798     5239698     5239701     5239699<br> APR2006     5049080     5059238     5059261     5059251<br> JAN2006     4751931     4751539     4770480     4751549</p>
<p>10.1.0.5</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)      Bundle Patch (WindowsItanium)<br> JAN2012     13343482    13413002    13413003<br> OCT2011     12828135    12914905    12914906<br> JUL2011     12419228    12429517    12429518<br> APR2011     11725035    11731119    11731120<br> JAN2011     N/A     N/A     N/A<br> OCT2010     9952279     10089559    10089560<br> JUL2010     9655023     9683651     9683652<br> APR2010     9352208     9390288     9390289<br> JAN2010     9119261     9187104     9187105<br> OCT2009     8836540     8785211     8785212<br> JUL2009     8534394     8656224     8656226<br> APR2009     8290534     8300356     8300360<br> JAN2009     7592360     7486619     7586049<br> OCT2008     7375686     7367493     7367494<br> JUL2008     7154097     7047034     7047037<br> APR2008     6864078     6867107     6867108<br> JAN2008     6647005     6637274     6637275<br> OCT2007     6395024     6408393     6408394<br> JUL2007     6079585     6115804     6115818<br> APR2007     5901877     5907304     5907305<br> JAN2007     5689908     5716295     5634747<br> OCT2006     5490845     5500883     5500885<br> JUL2006     5225797     5251148     5251140<br> APR2006     5049074     5057606     5057609<br> JAN2006     4751932     4882231     4882236</p>
<p>10.1.0.4</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> APR2007     5901876     5909871     5909879<br> JAN2007     5689894     5695771     5695772<br> OCT2006     5490844     5500878     5500880<br> JUL2006     5225796     5239736     5239737<br> APR2006     5049067     5059200     5059227<br> JAN2006     4751928     4751259     4745040<br> OCT2005     4567866     4579182     4579188<br> JUL2005     4392423     4440706     4404600<br> APR2005     4210374     4287619     4287611</p>
<p>10.1.0.3</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> JAN2007     5923277     N/A     N/A<br> OCT2006     5566825     N/A     N/A<br> JUL2006     5435164     N/A     N/A<br> APR2006     5158022     N/A     N/A<br> JAN2006     4751926     4741077     4741084<br> OCT2005     4567863     4567518     4567523<br> JUL2005     4392409     4389012     4389014<br> APR2005     4193286     4269715     4158888<br> JAN2005     4003062     4074232     3990812</p>
<p>10.1.0.2</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> APR2005     4193293     4181849     4213305<br> JUL2005     4400766     4388944     4388948<br> JAN2005     4003051     4104364     4083038</p>
<p>9.2.0.8</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> JUL2010     9655027     9683644     9683645<br> APR2010     9352224     9390286     N/A<br> JAN2010     9119275     9187106     N/A<br> OCT2009     8836758     8785185     8785186<br> JUL2009     8534403     8427417     8427418<br> APR2009     8290549     8300340     8300346<br> JAN2009     7592365     7703210     7703212<br> OCT2008     7375695     7394394     7394402<br> JUL2008     7154111     7047026     7047029<br> APR2008     6864082     6867138     6867139<br> JAN2008     6646842     6637265     6637266<br> OCT2007     6395038     6417013     6417014<br> JUL2007     6079582     6130293     6130295<br> APR2007     5901875     5916268     5916275<br> JAN2007     N/A     N/A     N/A<br> OCT2006     5490859     5652380     5639519</p>
<p>9.2.0.7</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> JUL2007     6079579     6146759     6146748<br> APR2007     5901872     5907274     5907275<br> JAN2007     5689875     5654905     5654909<br> OCT2006     5490841     5500873     5500874<br> JUL2006     5225794     5250980     5250981<br> APR2006     5049060     5064365     5064364<br> JAN2006     4751923     4751528     4741074<br> OCT2005     4567854     4579590     4579599<br> JUL2005     4547566     N/A     N/A   </p>
<p>9.2.0.6</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> OCT2006     5490840     5500865     5500871<br> JUL2006     5225793     5239794     5239793<br> APR2006     5049051     5059614     5059615<br> JAN2006     4751921     4751261     4751262<br> OCT2005     4567846     4579093     4579097<br> JUL2005     4392392     4445852     4401917<br> APR2005     4193295     4269928     4213298</p>
<p>9.2.0.5</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> OCT2006     5689708     N/A     N/A<br> JUL2006     5435138     N/A     N/A<br> APR2006     5219762     N/A     N/A<br> OCT2005     4560421     N/A     N/A<br> JUL2005     4392256     4387563     4391819<br> APR2005     4193299     4195791     4214192<br> JAN2005     4003006     4104374     3990809</p>
<p>9.2.0.4</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)     Bundle Patch (WindowsItanium)<br> JAN2005     4002994     4104369     4083202</p>
<p>8.1.7.4</p>
<p> Description     CPU (Unix/Linux)    Bundle Patch (Windows32bit)<br> JAN2007     5689799     5686514<br> OCT2006     5490835     5496067<br> JUL2006     5225788     5236412<br> APR2006     5045247     5057601<br> JAN2006     4751906     4751570<br> OCT2005     4560405     4554818<br> JUL2005     4392446     4437058<br> APR2005     4193312     4180163<br> JAN2005     4002909     3921893<br>OJVM PSU Patches</p>
<p>12.1.0.2</p>
<p> Description     OJVM PSU (Linux/Unix)   OJVM BP (Windows)   Combo OJVM + DB PSU     Combo OJVM + GI PSU     Generic JDBC<br> JAN2017     24917972 (12.1.0.2.170117)  25112498 (12.1.0.2.170117)  24917069 (12.1.0.2.170117)  24917916 (12.1.0.2.170117)  Included in OJVM PSU<br> OCT2016     24315824 (12.1.0.2.161018)  24591630 (12.1.0.2.161018)  24433133 (12.1.0.2.161018)  24433148 (12.1.0.2.161018)  Included in OJVM PSU<br> JUL2016     23177536 (12.1.0.2.160719)  23515290 (12.1.0.2.160719)  23615289 (12.1.0.2.160719)  23615308 (12.1.0.2.160719)  23727148 (Included in OJVM PSU)<br> APR2016     22674709 (12.1.0.2.160419)  22839633 (12.1.0.2.160419)  22738582 (12.1.0.2.160419)  22738641 (12.1.0.2.160419)<br> JAN2016     22139226 (12.1.0.2.160119)  22311086 (12.1.0.2.160119)  22191659 (12.1.0.2.160119)  22191676 (12.1.0.2.160119)<br> OCT2015     21555660 (12.1.0.2.5)   21788394 (12.1.0.2.4)   21520444    21523260<br> JUL2015     21068507 (12.1.0.2.4)   21153530 (12.1.0.2.3)   21150768    21150782<br> APR2015     20415564 (12.1.0.2.3)   20391199 (12.1.0.2.2)   20834354    20834538<br> JAN2015     19877336 (12.1.0.2.2)   20225938 (12.1.0.2.1)   20132434    20132450<br> OCT2014 (12.1.0.2.1)    19282028        19791366    19791375</p>
<p>12.1.0.1</p>
<p> Description     OJVM PSU (Linux/Unix)   OJVM BP (Windows)   Combo OJVM + DB PSU     Combo OJVM + GI PSU     Generic JDBC<br> JUL2016 (12.1.0.1.160719)   23177541    23515285    23615355    23615368<br> 23727043 (Included in OJVM PSU)</p>
<p> APR2016 (12.1.0.1.160419)   22674703    22839627    22738678    22738715    Included in OJVM PSU<br> JAN2016 (12.1.0.1.160119)   22139235    22311072    22191711    22191721<br> OCT2015 (12.1.0.1.5)    21555669    21788365    21744318    21744328<br> JUL2015 (12.1.0.1.4)    21068523    21153513    21150806    21150817<br> APR2015 (12.1.0.1.3)    20406245    20225909    20834568    20834579<br> JAN2015 (12.1.0.1.2)    19877342    20225916    20132482    20132489<br> OCT2014 (12.1.0.1.1)    19282024    19801531    19791363    19791360    19852357</p>
<p>11.2.0.4</p>
<p> Description     OJVM PSU (Linux/Unix)   OJVM BP (Windows)    Combo OJVM + DB PSU    Combo OJVM + DB SPU     Combo OJVM + GI PSU     Generic JDBC<br> JAN2017 (11.2.0.4.170117)   24917954    25043019    24918033    25367810    24918228<br> Included in OJVM PSU</p>
<p> OCT2016 (11.2.0.4.161018)   24315821    24591637    24436313    24433791    24436346<br> Included in OJVM PSU</p>
<p> JUL2016 (11.2.0.4.160719)   23177551    23515277    23615392    23615381    23615403<br> 23727132 (Included in OJVM PSU)</p>
<p> APR2016 (11.2.0.4.160419)   22674697    22839614    22738777    22738732    22738793   Included in OJVM PSU<br> JAN2016 (11.2.0.4.160119)   22139245    22311053    22378146    22378121    22378167<br> OCT2015 (11.2.0.4.5)    21555791    21788344    21744343    21744335    21744348<br> JUL2015 (11.2.0.4.4)    21068539    21153498    21150851    21150829    21150864<br> APR2015 (11.2.0.4.3)    20406239    20225988    20834611    20834597    20834621<br> JAN2015 (11.2.0.4.2)    19877440    20225982    20132580    20132517    20132615<br> OCT2014 (11.2.0.4.1)    19282021   19799291     19791364    19791358    19791420    19852360</p>
<p>11.2.0.3</p>
<p> Description     OJVM PSU (Linux/Unix)   OJVM BP (Windows)  Combo OJVM + DB PSU  Combo OJVM + DB SPU    Combo OJVM + GI PSU  Generic JDBC<br> JUL2015 (11.2.0.3.4)   21068553     21153470   21150891    21150885     21150904   </p>
<p> Included in OJVM PSU</p>
<p> APR2015 (11.2.0.3.3)   20406220     20391185   20834670    20834653     20834686<br> JAN2015 (11.2.0.3.2)   19877443     20227195   20132646    20132635     20132651<br> OCT2014 (11.2.0.3.1)   19282015     19806120   19791427    19791426    19791428    19852361</p>
<p>11.1.0.7</p>
<p>Description OJVM PSU (Linux/Unix)    OJVM BP (Windows)  Combo OJVM + DB PSU Combo OJVM + DB SPU  Combo OJVM + GI PSU    Generic JDBC<br> JUL2015 (11.1.0.7.4)    21068565    21153423    21150939    21150929     N/A   </p>
<p>  Included in OJVM PSU</p>
<p> APR2015 (11.1.0.7.3)    20406213    20391156    20834724    20834712     N/A<br> JAN2015 (11.1.0.7.2)    19877446    20227146    20132677    20132669     N/A<br> OCT2014 (11.1.0.7.1)    19282002    19806118    19791436    19791434     N/A    19852363</p>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[GoldenGate 12.1.2 新特性参数部分解释]]></title>
      <url>/2017/03/31/oracle/goldengate/GoldenGate%2012.1.2%20%E6%96%B0%E7%89%B9%E6%80%A7%E5%8F%82%E6%95%B0%E9%83%A8%E5%88%86%E8%A7%A3%E9%87%8A/</url>
      <content type="html"><![CDATA[<h2 id="LOGALLSUPCOLS"><a href="#LOGALLSUPCOLS" class="headerlink" title="LOGALLSUPCOLS"></a>LOGALLSUPCOLS</h2><p>Writes all supplementally logged columns to the trail, including those required for conflict detection and resolution and the scheduling columns required to support integrated Replicat. (Scheduling columns are primary key, unique index, and foreign key columns.) You configure the database to log these columns with GGSCI commands.<br>使用该参数可以记录所有附加日志信息并写入trail文件中。</p>
<h2 id="UPDATERECORDFORMAT-COMPACT"><a href="#UPDATERECORDFORMAT-COMPACT" class="headerlink" title="UPDATERECORDFORMAT COMPACT"></a>UPDATERECORDFORMAT COMPACT</h2><p>Combines the before and after images of an UPDATE operation into a single record in the trail. This parameter is valid for Oracle databases version 12c and later to support Replicat in integrated mode. Although not a required parameter, UPDATERECORDFORMAT COMPACT is a best practice and significantly improves Replicat performance.<br>UPDATERECORDFORMAT参数可以控制抽取进程兼容更新操作的前镜像和后镜像信息并写入到一个trail文件中，但是一定要注意的是该参数必须在数据库版本是11.2.0.4或者12c版本。</p>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> goldengate </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle Database 11g工作中常用的命令和脚本整理]]></title>
      <url>/2017/03/31/oracle/Oracle%2011g%E5%B7%A5%E4%BD%9C%E4%B8%AD%E5%B8%B8%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E5%92%8C%E8%84%9A%E6%9C%AC%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="设置Oracle用户密码永不过期"><a href="#设置Oracle用户密码永不过期" class="headerlink" title="设置Oracle用户密码永不过期"></a>设置Oracle用户密码永不过期</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter profile default limit PASSWORD_LIFE_TIME unlimited;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看设置</span></span>
<span class="line"><span class="keyword">select</span> * from dba_profiles where resource_name like <span class="string">'PASSWORD_LIFE_TIME%'</span>;</span>
</pre></td></tr></table></figure>
<h2 id="设置Oracle用户登陆失败次数限制"><a href="#设置Oracle用户登陆失败次数限制" class="headerlink" title="设置Oracle用户登陆失败次数限制"></a>设置Oracle用户登陆失败次数限制</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置登陆失败次数限制为100，错误登陆数超过100会导致用户被锁</span></span>
<span class="line">alter profile default limit FAILED_LOGIN_ATTEMPTS <span class="number">100</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 无限制</span></span>
<span class="line">alter profile default limit FAILED_LOGIN_ATTEMPTS unlimited;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看登陆失败限制设置</span></span>
<span class="line"><span class="keyword">select</span> * from dba_profiles where resource_name like <span class="string">'FAILED_LOGIN_ATTEMPTS%'</span>;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="系统进程PID查找对应SQLTEXT"><a href="#系统进程PID查找对应SQLTEXT" class="headerlink" title="系统进程PID查找对应SQLTEXT"></a>系统进程PID查找对应SQLTEXT</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sql_text <span class="keyword">FROM</span> v$sqltext a </span>
<span class="line">  <span class="keyword">WHERE</span> (a.hash_value, a.address) <span class="keyword">IN</span> (<span class="keyword">SELECT</span> <span class="keyword">DECODE</span> (sql_hash_value,<span class="number">0</span>, prev_hash_value,sql_hash_value),</span>
<span class="line">        <span class="keyword">DECODE</span> (sql_hash_value, <span class="number">0</span>, prev_sql_addr, sql_address)</span>
<span class="line">    <span class="keyword">FROM</span> v$<span class="keyword">session</span> b <span class="keyword">WHERE</span> b.paddr = (<span class="keyword">SELECT</span> addr <span class="keyword">FROM</span> v$process c <span class="keyword">WHERE</span> c.spid =&amp;pid)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> piece <span class="keyword">ASC</span>;</span>
</pre></td></tr></table></figure>
<h2 id="查找长事务对应的SQLTEXT"><a href="#查找长事务对应的SQLTEXT" class="headerlink" title="查找长事务对应的SQLTEXT"></a>查找长事务对应的SQLTEXT</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">with ltr as ( </span>
<span class="line"><span class="keyword">select</span> to_char(<span class="keyword">sysdate</span>,<span class="string">'YYYYMMDDHH24MISS'</span>) TM, </span>
<span class="line">       s.sid, </span>
<span class="line">       s.sql_id, </span>
<span class="line">       s.sql_child_number, </span>
<span class="line">       s.prev_sql_id, </span>
<span class="line">       xid, </span>
<span class="line">       to_char(t.start_date,<span class="string">'YYYYMMDDHH24MISS'</span>) start_time, </span>
<span class="line">       e.TYPE,e.block, </span>
<span class="line">       e.ctime, </span>
<span class="line">       <span class="keyword">decode</span>(e.CTIME, <span class="number">0</span>, (<span class="keyword">sysdate</span> - t.start_date) * <span class="number">3600</span>*<span class="number">24</span>, e.ctime) el_second </span>
<span class="line">  <span class="keyword">from</span> v$<span class="keyword">transaction</span> t, v$<span class="keyword">session</span> s,v$transaction_enqueue e</span>
<span class="line"> <span class="keyword">where</span> t.start_date &lt;= <span class="keyword">sysdate</span> - <span class="built_in">interval</span> <span class="string">'200'</span> <span class="keyword">second</span></span>
<span class="line">   <span class="keyword">and</span> t.addr = s.taddr </span>
<span class="line">   <span class="keyword">and</span> t.addr = e.addr(+) ) </span>
<span class="line">  <span class="keyword">select</span> ltr.* , (<span class="keyword">select</span> q1.sql_text <span class="keyword">from</span> v$<span class="keyword">sql</span> q1 <span class="keyword">where</span> ltr.prev_sql_id = q1.sql_id(+)</span>
<span class="line">   <span class="keyword">and</span> <span class="keyword">rownum</span> = <span class="number">1</span>) prev_sql_text , </span>
<span class="line">  (<span class="keyword">select</span> q1.sql_text <span class="keyword">from</span> v$<span class="keyword">sql</span> q1 <span class="keyword">where</span> ltr.sql_id = q1.sql_id(+) </span>
<span class="line">   <span class="keyword">and</span> ltr.sql_child_number = q1.CHILD_NUMBER(+)) sql_text </span>
<span class="line">   <span class="keyword">from</span> ltr ltr;</span>
</pre></td></tr></table></figure>
<h2 id="永久设置sql-plus的环境变量"><a href="#永久设置sql-plus的环境变量" class="headerlink" title="永久设置sql*plus的环境变量"></a>永久设置sql*plus的环境变量</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">echo <span class="string">"set pagesize 9999"</span> &gt;&gt; $ORACLE_HOME/sqlplus/admin/glogin.sql</span>
<span class="line">echo <span class="string">"set line 150"</span> &gt;&gt; $ORACLE_HOME/sqlplus/admin/glogin.sql</span>
<span class="line">echo <span class="string">"set long 5000"</span> &gt;&gt; $ORACLE_HOME/sqlplus/admin/glogin.sql</span>
</pre></td></tr></table></figure>
<h2 id="查找非系统用户中无主键表"><a href="#查找非系统用户中无主键表" class="headerlink" title="查找非系统用户中无主键表"></a>查找非系统用户中无主键表</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> at.TABLE_NAME, at.OWNER, at.NUM_ROWS</span>
<span class="line"><span class="keyword">from</span> </span>
<span class="line">  (<span class="keyword">SELECT</span> owner,table_name <span class="keyword">FROM</span> all_tables <span class="keyword">WHERE</span> owner <span class="keyword">in</span> </span>
<span class="line">   (<span class="keyword">select</span> username <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>))</span>
<span class="line"><span class="keyword">MINUS</span></span>
<span class="line">  <span class="keyword">SELECT</span> owner,table_name <span class="keyword">FROM</span> all_constraints <span class="keyword">WHERE</span> owner <span class="keyword">in</span> </span>
<span class="line">   (<span class="keyword">select</span> username <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>)) </span>
<span class="line">  <span class="keyword">AND</span> constraint_type = <span class="string">'P'</span> ) vn, all_tables <span class="keyword">at</span></span>
<span class="line"><span class="keyword">where</span> vn.TABLE_NAME=at.TABLE_NAME <span class="keyword">and</span> vn.OWNER=at.OWNER <span class="keyword">and</span> at.TABLE_NAME <span class="keyword">not</span> <span class="keyword">like</span> <span class="string">'%$%'</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span>,<span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h2 id="查询有Object的schema"><a href="#查询有Object的schema" class="headerlink" title="查询有Object的schema"></a>查询有Object的schema</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> OWNER,<span class="keyword">count</span>(OBJECT_NAME) OBJECT_NUM <span class="keyword">from</span> dba_objects <span class="keyword">where</span> OWNER <span class="keyword">in</span></span>
<span class="line">    (<span class="keyword">select</span> username <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>)) <span class="keyword">and</span> OBJECT_TYPE=<span class="string">'TABLE'</span></span>
<span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> OWNER;</span>
</pre></td></tr></table></figure>
<h2 id="动态性能视图授权普通用户查看权限"><a href="#动态性能视图授权普通用户查看权限" class="headerlink" title="动态性能视图授权普通用户查看权限"></a>动态性能视图授权普通用户查看权限</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> v_$<span class="keyword">session</span> <span class="keyword">to</span> &lt;<span class="keyword">schema</span>&gt;;</span>
<span class="line"><span class="keyword">grant</span> <span class="keyword">select</span> <span class="keyword">on</span> v_$locked_object <span class="keyword">to</span> &lt;<span class="keyword">schema</span>&gt;;</span>
</pre></td></tr></table></figure>
<h2 id="查看并kill掉锁对象"><a href="#查看并kill掉锁对象" class="headerlink" title="查看并kill掉锁对象"></a>查看并kill掉锁对象</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> v$locked_object;</span>
<span class="line"><span class="keyword">select</span> object_name,object_type <span class="keyword">from</span> dba_objects <span class="keyword">where</span> object_id=&amp;object_id;</span>
<span class="line"><span class="keyword">select</span> <span class="keyword">sid</span>, <span class="built_in">serial</span>#, machine, program <span class="keyword">from</span> v$<span class="keyword">session</span> <span class="keyword">where</span> <span class="keyword">sid</span>=&amp;<span class="keyword">sid</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">set</span> line <span class="number">150</span></span>
<span class="line"><span class="keyword">col</span> OWNER <span class="keyword">for</span> a20</span>
<span class="line"><span class="keyword">col</span> OBJECT_NAME <span class="keyword">for</span> a20</span>
<span class="line"><span class="keyword">select</span> s.SID,s.SERIAL#,lo.PROCESS,lo.LOCKED_MODE,do.OWNER,do.OBJECT_NAME,do.OBJECT_TYPE</span>
<span class="line">  <span class="keyword">from</span> v$locked_object lo, dba_objects <span class="keyword">do</span>, v$<span class="keyword">session</span> s</span>
<span class="line">  <span class="keyword">where</span> lo.OBJECT_ID=do.OBJECT_ID <span class="keyword">and</span> lo.SESSION_ID=s.SID;</span>
<span class="line"></span>
<span class="line"><span class="keyword">alter</span> <span class="keyword">system</span> <span class="keyword">kill</span> <span class="keyword">session</span> <span class="string">'&amp;sid,&amp;serial'</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> <span class="keyword">sid</span>,<span class="keyword">type</span>,lmode,request,ctime <span class="keyword">from</span> v$<span class="keyword">lock</span></span>
<span class="line">  <span class="keyword">where</span> <span class="keyword">type</span> <span class="keyword">in</span> (<span class="string">'TM'</span>,<span class="string">'TX'</span>) <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>,<span class="number">2</span>;</span>
</pre></td></tr></table></figure>
<h2 id="生成删除所有普通用户及其数据脚本"><a href="#生成删除所有普通用户及其数据脚本" class="headerlink" title="生成删除所有普通用户及其数据脚本"></a>生成删除所有普通用户及其数据脚本</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'drop user '</span> || username || <span class="string">' cascade;'</span> <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>);</span>
</pre></td></tr></table></figure>
<h2 id="启动-关闭数据库"><a href="#启动-关闭数据库" class="headerlink" title="启动/关闭数据库"></a>启动/关闭数据库</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">startup</span>
<span class="line">startup nomount</span>
<span class="line">startup mount</span>
<span class="line">startup open read only;</span>
<span class="line">startup restrict</span>
</pre></td></tr></table></figure>
<h2 id="查看创建表等数据库对象时的DDL语句"><a href="#查看创建表等数据库对象时的DDL语句" class="headerlink" title="查看创建表等数据库对象时的DDL语句"></a>查看创建表等数据库对象时的DDL语句</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">desc dbms_metadata</span>
<span class="line"><span class="comment">------------------------------------------------------------------------------------------</span></span>
<span class="line">FUNCTION GET_DDL RETURNS CLOB</span>
<span class="line"> Argument Name                  Type                    In/Out Default?</span>
<span class="line"> <span class="comment">------------------------------ ----------------------- ------ --------</span></span>
<span class="line"> OBJECT_TYPE                    VARCHAR2                IN</span>
<span class="line"> NAME                           VARCHAR2                IN</span>
<span class="line"> SCHEMA                         VARCHAR2                IN     DEFAULT</span>
<span class="line"> VERSION                        VARCHAR2                IN     DEFAULT</span>
<span class="line"> MODEL                          VARCHAR2                IN     DEFAULT</span>
<span class="line"> TRANSFORM                      VARCHAR2                IN     DEFAULT</span>
<span class="line"><span class="comment">------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">set</span> <span class="keyword">long</span> <span class="number">9999</span></span>
<span class="line"><span class="keyword">set</span> pagesize <span class="number">9999</span></span>
<span class="line"><span class="keyword">select</span> dbms_metadata.get_ddl(<span class="string">'&amp;OBJECT_TYPE'</span>,<span class="string">'&amp;NAME'</span>,<span class="string">'&amp;SCHEMA'</span>) <span class="keyword">from</span> dual;</span>
<span class="line"></span>
<span class="line">Enter value for object_type: TABLE</span>
<span class="line">Enter value for name: YTHYHDZ</span>
<span class="line">Enter value for schema: BFBHDD9</span>
</pre></td></tr></table></figure>
<h2 id="实现将SYS用户的操作信息记录到操作系统日志中"><a href="#实现将SYS用户的操作信息记录到操作系统日志中" class="headerlink" title="实现将SYS用户的操作信息记录到操作系统日志中"></a>实现将SYS用户的操作信息记录到操作系统日志中</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter <span class="keyword">system</span> set audit_syslog_level=<span class="string">'USER.NOTICE'</span> scope=spfile;</span>
<span class="line">alter <span class="keyword">system</span> set audit_sys_operations=TRUE scope=spfile;</span>
<span class="line">alter <span class="keyword">system</span> set audit_trail=none scope=spfile;</span>
<span class="line"><span class="comment"># 调整后的参数生效需重启数据库</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看系统日志</span></span>
<span class="line">tail -<span class="number">100</span>f /var/<span class="keyword">log</span>/messages</span>
</pre></td></tr></table></figure>
<h2 id="查找数据库中无效对象"><a href="#查找数据库中无效对象" class="headerlink" title="查找数据库中无效对象"></a>查找数据库中无效对象</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">col OWNER for a15</span>
<span class="line">col OBJECT_NAME for a50</span>
<span class="line"><span class="keyword">select</span> OWNER,OBJECT_NAME,OBJECT_TYPE,<span class="keyword">STATUS</span> <span class="keyword">from</span> dba_objects </span>
<span class="line">  <span class="keyword">where</span> OWNER <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYS'</span>,<span class="string">'SYSTEM'</span>) <span class="keyword">and</span> <span class="keyword">STATUS</span>=<span class="string">'INVALID'</span>;</span>
</pre></td></tr></table></figure>
<h2 id="统计数据库中各类用户对象的数量"><a href="#统计数据库中各类用户对象的数量" class="headerlink" title="统计数据库中各类用户对象的数量"></a>统计数据库中各类用户对象的数量</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> o.owner,o.OBJECT_TYPE,<span class="keyword">COUNT</span>(*) </span>
<span class="line"><span class="keyword">from</span> dba_objects o, </span>
<span class="line">(<span class="keyword">select</span> username <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'DBSNMP'</span>)) u</span>
<span class="line"><span class="keyword">where</span> u.username=o.owner <span class="keyword">group</span> <span class="keyword">by</span> o.owner,o.OBJECT_TYPE <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>,<span class="number">2</span>;</span>
</pre></td></tr></table></figure>
<h2 id="列出数据库中指定类型对象列表"><a href="#列出数据库中指定类型对象列表" class="headerlink" title="列出数据库中指定类型对象列表"></a>列出数据库中指定类型对象列表</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">col object_name for a50</span>
<span class="line"><span class="keyword">select</span> owner,object_name,object_type</span>
<span class="line"><span class="keyword">from</span> dba_objects o,</span>
<span class="line">(<span class="keyword">select</span> username <span class="keyword">from</span> dba_users <span class="keyword">where</span> account_status=<span class="string">'OPEN'</span> <span class="keyword">and</span> username <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'SYSTEM'</span>,<span class="string">'SYS'</span>,<span class="string">'GOLDENGATE'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'DBSNMP'</span>)) u</span>
<span class="line"><span class="keyword">where</span> o.owner=u.username <span class="keyword">and</span> object_type <span class="keyword">in</span> (<span class="string">'TRIGGER'</span>,<span class="string">'PROCEDURE'</span>,<span class="string">'JOB'</span>)</span>
<span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>;</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> 常用命令与脚本 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> scripts </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle expdp中INCLUDE参数限制4000个字符的解决办法]]></title>
      <url>/2017/03/31/oracle/Oracle_DataPump_INCLUDE_%E5%8F%82%E6%95%B0%E9%99%90%E5%88%B64000%E4%B8%AA%E5%AD%97%E7%AC%A6%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/</url>
      <content type="html"><![CDATA[<p>使用expdp的include参数，当需要包含大量表时，一旦字符超4000时就会报错<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">expdp DADM/passwd DIRECTORY=DMP_DIR SCHEMAS=DADM</span>
<span class="line">DUMPFILE=dadm_tables_data.dmp CONTENT=DATA_ONLY </span>
<span class="line">INCLUDE=TABLE:<span class="string">"IN ('CBTRFCC','CBTFCCN','CGTGCDD','CGDSALC',</span>
<span class="line">...</span>
<span class="line">'CGTRSGR','CBTFCCE','CGTREPD','CPDORPG')"</span></span>
<span class="line"></span>
<span class="line">UDE-<span class="number">00014</span> : invalid value <span class="keyword">for</span> parameter, <span class="string">'include'</span>.</span>
</pre></td></tr></table></figure></p>
<p>使用以下技巧可以解决<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">CREATE TABLE list_of_tables ( tbl_name VARCHAR2(<span class="number">30</span>) );</span>
<span class="line">INSERT INTO list_of_tables ( <span class="string">'CBTRFCC'</span> );</span>
<span class="line">INSERT INTO list_of_tables ( <span class="string">'CBTFCCN'</span> );</span>
<span class="line">...</span>
<span class="line">INSERT INTO list_of_tables ( <span class="string">'CPDORPG'</span> );</span>
<span class="line">COMMIT;</span>
<span class="line"></span>
<span class="line">expdp DADM/passwd DIRECTORY=DMP_DIR SCHEMAS=DADM DUMPFILE=dadm_data.dmp </span>
<span class="line">CONTENT=DATA_ONLY include=TABLE:<span class="string">"IN (SELECT tbl_name FROM list_of_tables)"</span></span>
</pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> expdp </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-10 深入理解MySQL主从复制]]></title>
      <url>/2017/03/31/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/10-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="如何解决主从复制延迟的问题？"><a href="#如何解决主从复制延迟的问题？" class="headerlink" title="如何解决主从复制延迟的问题？"></a>如何解决主从复制延迟的问题？</h2><ol>
<li>加大主从库之间网络带宽</li>
<li>使用SSD盘</li>
<li>使用缓存服务器Redis/memcached</li>
</ol>
<a id="more"></a>
<h2 id="如何判断主从复制是否同步？"><a href="#如何判断主从复制是否同步？" class="headerlink" title="如何判断主从复制是否同步？"></a>如何判断主从复制是否同步？</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在从库上查看同步状态</span></span>
<span class="line">show slave status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.201</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000037</span>     <span class="comment"># I/O线程 接收的binlog文件</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">1653</span>              <span class="comment"># I/O线程 binlog文件偏移量</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span>   </span>
<span class="line">                Relay_Log_Pos: <span class="number">604</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000037</span>     <span class="comment"># SQL线程 已应用的binlog文件</span></span>
<span class="line">             Slave_IO_Running: Yes</span>
<span class="line">            Slave_SQL_Running: Yes</span>
<span class="line">            ......</span>
<span class="line">          Exec_Master_Log_Pos: <span class="number">1653</span>              <span class="comment"># SQL线程 已应用的binlog文件偏移量</span></span>
<span class="line">         ......</span>
<span class="line">        Seconds_Behind_Master: <span class="number">0</span>                 <span class="comment"># 从库和主库延迟时间</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 如果主库实例正常，同时查看主库状态</span></span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000037</span></span>
<span class="line">         Position: <span class="number">1653</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure>
<p>查看主库<code>File</code>和从库I/O线程<code>Master_Log_File</code>和SQL线程<code>Relay_Master_Log_File</code>是不是相同，如果不同（如<code>Relay_Master_Log_File</code>小），说明有延迟；如果相等，再比较主库的<code>Position</code>和从库的<code>Read_Master_Log_Pos</code>和<code>Exec_Master_Log_Pos</code>是不是相同，如果偏移量也相同，说明主从复制是同步的。</p>
<h2 id="sql-slave-skip-counter-参数设为1怎么理解？"><a href="#sql-slave-skip-counter-参数设为1怎么理解？" class="headerlink" title="[sql_slave_skip_counter]参数设为1怎么理解？"></a>[sql_slave_skip_counter]参数设为1怎么理解？</h2><blockquote>
<p>set global sql_slave_skip_counter = N</p>
<p><font color="red">This statement skips the next N events from the master.</font></p>
<p><font color="blue">即是跳过N个events，这里最重要的是理解event的含义!在mysql中,对于sql的 binary log 实际上是由一连串的event组成的一个组,即事务组。</font><br>在备库上设置<code>global sql_slave_skip_counter =N</code>会跳过当前时间来自于master的之后N个事件，这对于恢复由某条SQL语句引起的从库复制有效。<br>此语句只在当<code>slave threads</code>是停止时才有效，每忽略一个事务，N减一，直到N减为0！</p>
</blockquote>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 当slave threads停止时，跳过1个事务</span></span>
<span class="line">set global sql_slave_skip_counter=<span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h2 id="线上快速搭建Mysql主从复制流程"><a href="#线上快速搭建Mysql主从复制流程" class="headerlink" title="线上快速搭建Mysql主从复制流程"></a>线上快速搭建Mysql主从复制流程</h2><ol>
<li>初始化mysql主从库</li>
<li>主创建复制帐号，授权</li>
<li>修改主和从的<code>server_id</code>(全局中要唯一)</li>
<li>主库做全备(初始化没数据的库可以省略此步)</li>
<li>从库做恢复(初始化没数据的库可以省略此步)</li>
<li>备库执行<code>change master</code>设置复制</li>
<li>备库启动复制(I/O线程、SQL线程)</li>
<li>查看复制状态</li>
</ol>
<p><img src="http://oligvdnzp.bkt.clouddn.com/0331_mysql_master_slave_01.png" alt=""></p>
<h3 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">prompt my3306-&gt; </span>
<span class="line">grant replication slave,replication client on *.* to rep@'%' identified by <span class="string">'rep123'</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%server_id%'</span>;</span>
<span class="line">+----------------+-------+</span>
<span class="line">| Variable_name  | Value |</span>
<span class="line">+----------------+-------+</span>
<span class="line">| server_id      | <span class="number">101</span>   |   <span class="comment"># 保证全局唯一</span></span>
<span class="line">| server_id_bits | <span class="number">32</span>    |</span>
<span class="line">+----------------+-------+</span>
<span class="line"></span>
<span class="line">show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| jfedu              |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">+--------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用mysqldump工具备份jfedu数据库</span></span>
<span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P3306 -uroot -pmysqlroot --single-transaction --master-data=<span class="number">2</span>  &gt; <span class="regexp">/tmp/all</span>.sql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 测试备份后DML操作</span></span>
<span class="line"><span class="keyword">use</span> jfedu</span>
<span class="line">show tables;</span>
<span class="line">+-----------------+</span>
<span class="line">| Tables_in_jfedu |</span>
<span class="line">+-----------------+</span>
<span class="line">| gyj_t1          |</span>
<span class="line">| gyj_t2          |</span>
<span class="line">| t1              |</span>
<span class="line">+-----------------+</span>
<span class="line"></span>
<span class="line">create table gyj_t3 (id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">insert into gyj_t3 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'AAAAA'</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">show tables;</span>
<span class="line">+-----------------+</span>
<span class="line">| Tables_in_jfedu |</span>
<span class="line">+-----------------+</span>
<span class="line">| gyj_t1          |</span>
<span class="line">| gyj_t2          |</span>
<span class="line">| gyj_t3          |</span>
<span class="line">| t1              |</span>
<span class="line">+-----------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看从库配置复制时需用到的CHANGE MASTER内容</span></span>
<span class="line">cat /tmp/jfedu.sql | <span class="keyword">grep</span> <span class="string">'CHANGE MASTER'</span></span>
<span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'binlog.000037'</span>, MASTER_LOG_POS=<span class="number">1329</span>;</span>
</pre></td></tr></table></figure>
<h3 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /u01/conf/my3307.cnf</span>
<span class="line">------------------------</span>
<span class="line"><span class="comment"># 修改从库server_id，确保全局唯一</span></span>
<span class="line">server_id=<span class="number">102</span></span>
<span class="line">------------------------</span>
<span class="line"></span>
<span class="line">prompt my3307-&gt; </span>
<span class="line">set global server_id=<span class="number">102</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%server_id%'</span>;</span>
<span class="line">+----------------+-------+</span>
<span class="line">| Variable_name  | Value |</span>
<span class="line">+----------------+-------+</span>
<span class="line">| server_id      | <span class="number">102</span>   |</span>
<span class="line">| server_id_bits | <span class="number">32</span>    |</span>
<span class="line">+----------------+-------+</span>
<span class="line"></span>
<span class="line">show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">| test               |</span>
<span class="line">+--------------------+</span>
<span class="line"></span>
<span class="line">create database jfedu default character set utf8;</span>
<span class="line"><span class="keyword">use</span> jfedu</span>
<span class="line">source /tmp/jfedu.sql</span>
<span class="line"></span>
<span class="line">show tables;</span>
<span class="line">+-----------------+</span>
<span class="line">| Tables_in_jfedu |</span>
<span class="line">+-----------------+</span>
<span class="line">| gyj_t1          |</span>
<span class="line">| gyj_t2          |</span>
<span class="line">| t1              |</span>
<span class="line">+-----------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置复制</span></span>
<span class="line">CHANGE MASTER TO </span>
<span class="line">    MASTER_HOST=<span class="string">'10.245.231.201'</span>,</span>
<span class="line">    MASTER_PORT=<span class="number">3306</span>,</span>
<span class="line">    MASTER_USER=<span class="string">'rep'</span>,</span>
<span class="line">    MASTER_PASSWORD=<span class="string">'rep123'</span>,</span>
<span class="line">    MASTER_LOG_FILE=<span class="string">'binlog.000037'</span>, </span>
<span class="line">    MASTER_LOG_POS=<span class="number">1329</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 开启slave</span></span>
<span class="line">start slave;</span>
<span class="line"><span class="comment">## 或者分两条</span></span>
<span class="line">start slave io_thread;</span>
<span class="line">start slave sql_thread;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 主库备份后的表已经传到从库</span></span>
<span class="line">show tables;</span>
<span class="line">+-----------------+</span>
<span class="line">| Tables_in_jfedu |</span>
<span class="line">+-----------------+</span>
<span class="line">| gyj_t1          |</span>
<span class="line">| gyj_t2          |</span>
<span class="line">| gyj_t3          |</span>
<span class="line">| t1              |</span>
<span class="line">+-----------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看slave状态</span></span>
<span class="line">show slave status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">10.245</span>.<span class="number">231.201</span></span>
<span class="line">                  Master_User: rep</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000037</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">1653</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">604</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000037</span></span>
<span class="line">             Slave_IO_Running: Yes       <span class="comment"># 状态需为YES</span></span>
<span class="line">            Slave_SQL_Running: Yes       <span class="comment"># 状态需为YES</span></span>
<span class="line">              Replicate_Do_DB: </span>
<span class="line">          Replicate_Ignore_DB: </span>
<span class="line">           Replicate_Do_Table: </span>
<span class="line">       Replicate_Ignore_Table: </span>
<span class="line">      Replicate_Wild_Do_Table: </span>
<span class="line">  Replicate_Wild_Ignore_Table: </span>
<span class="line">                   Last_Errno: <span class="number">0</span></span>
<span class="line">                   Last_Error: </span>
<span class="line">                 Skip_Counter: <span class="number">0</span></span>
<span class="line">          Exec_Master_Log_Pos: <span class="number">1653</span></span>
<span class="line">              Relay_Log_Space: <span class="number">770</span></span>
<span class="line">              Until_Condition: None</span>
<span class="line">               Until_Log_File: </span>
<span class="line">                Until_Log_Pos: <span class="number">0</span></span>
<span class="line">           Master_SSL_Allowed: No</span>
<span class="line">           Master_SSL_CA_File: </span>
<span class="line">           Master_SSL_CA_Path: </span>
<span class="line">              Master_SSL_Cert: </span>
<span class="line">            Master_SSL_Cipher: </span>
<span class="line">               Master_SSL_Key: </span>
<span class="line">        Seconds_Behind_Master: <span class="number">0</span></span>
<span class="line">Master_SSL_Verify_Server_Cert: No</span>
<span class="line">                Last_IO_Errno: <span class="number">0</span></span>
<span class="line">                Last_IO_Error: </span>
<span class="line">               Last_SQL_Errno: <span class="number">0</span></span>
<span class="line">               Last_SQL_Error: </span>
<span class="line">  Replicate_Ignore_Server_Ids: </span>
<span class="line">             Master_Server_Id: <span class="number">101</span></span>
<span class="line">                  Master_UUID: <span class="number">3049</span>e83f-fef5-<span class="number">11</span>e6-<span class="number">9165</span>-<span class="number">005056</span>a02d56</span>
<span class="line">             Master_Info_File: <span class="regexp">/u01/data</span><span class="regexp">/3307/master</span>.info</span>
<span class="line">                    SQL_Delay: <span class="number">0</span></span>
<span class="line">          SQL_Remaining_Delay: NULL</span>
<span class="line">      Slave_SQL_Running_State: Slave has <span class="keyword">read</span> all relay <span class="keyword">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it</span>
<span class="line">           Master_Retry_Count: <span class="number">86400</span></span>
<span class="line">                  Master_Bind: </span>
<span class="line">      Last_IO_Error_Timestamp: </span>
<span class="line">     Last_SQL_Error_Timestamp: </span>
<span class="line">               Master_SSL_Crl: </span>
<span class="line">           Master_SSL_Crlpath: </span>
<span class="line">           Retrieved_Gtid_Set: </span>
<span class="line">            Executed_Gtid_Set: </span>
<span class="line">                Auto_Position: <span class="number">0</span></span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">ERROR: </span>
<span class="line">No query specified</span>
<span class="line"></span>
<span class="line"><span class="comment"># 停用slave</span></span>
<span class="line">stop slave;</span>
</pre></td></tr></table></figure>
<h2 id="主从复制的详细过程分析"><a href="#主从复制的详细过程分析" class="headerlink" title="主从复制的详细过程分析"></a>主从复制的详细过程分析</h2><p><img src="http://oligvdnzp.bkt.clouddn.com/0331_mysql_master_slave_02.png" alt=""><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">my3306-&gt; show processlist\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">     Id: <span class="number">258167</span></span>
<span class="line">   User: root</span>
<span class="line">   Host: localhost</span>
<span class="line">     db: jfedu</span>
<span class="line">Command: Query</span>
<span class="line">   Time: <span class="number">0</span></span>
<span class="line">  State: init</span>
<span class="line">   Info: show processlist</span>
<span class="line">*************************** <span class="number">2</span>. row ***************************</span>
<span class="line">     Id: <span class="number">260791</span></span>
<span class="line">   User: rep</span>
<span class="line">   Host: <span class="number">10.245</span>.<span class="number">231.201</span>:<span class="number">33130</span></span>
<span class="line">     db: NULL</span>
<span class="line">Command: Binlog Dump     <span class="comment"># Dump线程会发送所有binlog日志到从库</span></span>
<span class="line">   Time: <span class="number">2101</span></span>
<span class="line">  State: Master has sent all binlog to slave; waiting <span class="keyword">for</span> binlog to be updated</span>
<span class="line">   Info: NULL</span>
<span class="line"><span class="number">2</span> rows in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">my3306-&gt; show master status\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">             File: binlog.<span class="number">000037</span>   <span class="comment"># binlog位置</span></span>
<span class="line">         Position: <span class="number">1653</span></span>
<span class="line">     Binlog_Do_DB: </span>
<span class="line"> Binlog_Ignore_DB: </span>
<span class="line">Executed_Gtid_Set: </span>
<span class="line"></span>
<span class="line">my3306-&gt; show binlog events in <span class="string">'binlog.000037'</span>;</span>
<span class="line"></span>
<span class="line">my3307-&gt; show processlist;</span>
<span class="line">+----+-------------+-----------+-------+---------+------+-----------------------------------------------------------------------------+------------------+</span>
<span class="line">| Id | User        | Host      | db    | Command | Time | State                                                                       | Info             |</span>
<span class="line">+----+-------------+-----------+-------+---------+------+-----------------------------------------------------------------------------+------------------+</span>
<span class="line">|  <span class="number">5</span> | root        | localhost | jfedu | Query   |    <span class="number">0</span> | init                                                                        | show processlist |</span>
<span class="line">|  <span class="number">6</span> | <span class="keyword">system</span> user |           | NULL  | Connect | <span class="number">2307</span> | Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event                                            | NULL             |</span>
<span class="line">|  <span class="number">7</span> | <span class="keyword">system</span> user |           | NULL  | Connect | <span class="number">4181</span> | Slave has <span class="keyword">read</span> all relay <span class="keyword">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it | NULL             |</span>
<span class="line">+----+-------------+-----------+-------+---------+------+-----------------------------------------------------------------------------+------------------+</span>
<span class="line"></span>
<span class="line">mysqlbinlog -vv /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog.<span class="number">000037</span></span>
<span class="line">mysqlbinlog -vv /u01/<span class="keyword">log</span>/<span class="number">3307</span>/binlog/binlog.<span class="number">000017</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 从库生成binlog以下参数需要开启</span></span>
<span class="line">show variables like <span class="string">'sql_log_bin'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| sql_log_bin   | ON    |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">cat /u01/data/<span class="number">3307</span>/master.info</span>
<span class="line">cat /u01/<span class="keyword">log</span>/<span class="number">3307</span>/relay-log.info</span>
</pre></td></tr></table></figure></p>
<h2 id="主从复制相关参数"><a href="#主从复制相关参数" class="headerlink" title="主从复制相关参数"></a>主从复制相关参数</h2><h3 id="Master"><a href="#Master" class="headerlink" title="Master"></a>Master</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">server_id          <span class="comment"># 全局唯一</span></span>
<span class="line">read_only=OFF      <span class="comment"># 主库设置成OFF关闭</span></span>
<span class="line">sql_log_bin=ON     <span class="comment"># 默认是开启</span></span>
<span class="line">binlog_format=ROW</span>
<span class="line">binlog_cache_size  <span class="comment"># 有大事务时设置大些</span></span>
<span class="line">max_binlog_size</span>
<span class="line">expire_logs_days   <span class="comment"># binlog日志保留时间</span></span>
<span class="line">binlog-<span class="keyword">do</span>-db</span>
<span class="line">binlog-ignore-db</span>
</pre></td></tr></table></figure>
<h3 id="Slave"><a href="#Slave" class="headerlink" title="Slave"></a>Slave</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">server_id          <span class="comment"># 全局唯一</span></span>
<span class="line">read_only=ON       <span class="comment"># 非级联时设置ON</span></span>
<span class="line">sql_log_bin=ON     <span class="comment"># 默认是开启</span></span>
<span class="line">log_slave_updates</span>
<span class="line">replicate-<span class="keyword">do</span>-db</span>
<span class="line">replicate-ignore-db</span>
<span class="line">replicate-<span class="keyword">do</span>-table</span>
<span class="line">replicate-ignore-table</span>
</pre></td></tr></table></figure>
<h2 id="Binlog日志格式"><a href="#Binlog日志格式" class="headerlink" title="Binlog日志格式"></a>Binlog日志格式</h2><p><img src="http://oligvdnzp.bkt.clouddn.com/0331_mysql_master_slave_03.png" alt=""></p>
<h2 id="Semi-sync半同步复制"><a href="#Semi-sync半同步复制" class="headerlink" title="Semi-sync半同步复制"></a>Semi-sync半同步复制</h2><ul>
<li>Semi-sync最早是由Google实现的一个补丁</li>
<li>Semi-sync性能比较差（尤其是在网络慢且大并发时），在主数据库宕机后，Semi-sync能减少数据丢失的可能性，但不能绝对保证数据不丢失</li>
<li>Semi-sync就是保证主库将日志先传输到备库，然后再返回给应用事务提交成功，流程如下:<br><img src="http://oligvdnzp.bkt.clouddn.com/0331_mysql_master_slave_04.png" alt=""></li>
</ul>
<p>开启步骤<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ll /u01/mysql/lib/plugin/semi*</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> mysql mysql <span class="number">424735</span> Feb <span class="number">24</span> <span class="number">10</span>:<span class="number">00</span> /u01/mysql/lib/plugin/semisync_master.so</span>
<span class="line">-rwxr-xr-<span class="keyword">x</span> <span class="number">1</span> mysql mysql <span class="number">247911</span> Feb <span class="number">24</span> <span class="number">10</span>:<span class="number">00</span> /u01/mysql/lib/plugin/semisync_slave.so</span>
<span class="line"></span>
<span class="line"><span class="comment"># 主库上执行</span></span>
<span class="line">install plugin rpl_semi_sync_master soname <span class="string">'semisync_master.so'</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%semi%'</span>;</span>
<span class="line">+------------------------------------+-------+</span>
<span class="line">| Variable_name                      | Value |</span>
<span class="line">+------------------------------------+-------+</span>
<span class="line">| rpl_semi_sync_master_enabled       | OFF   | <span class="comment"># 需要设置成ON</span></span>
<span class="line">| rpl_semi_sync_master_timeout       | <span class="number">10000</span> |</span>
<span class="line">| rpl_semi_sync_master_trace_level   | <span class="number">32</span>    |</span>
<span class="line">| rpl_semi_sync_master_wait_no_slave | ON    |</span>
<span class="line">+------------------------------------+-------+</span>
<span class="line"><span class="number">4</span> rows in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">set global rpl_semi_sync_master_enabled=on;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 从库上执行</span></span>
<span class="line">install plugin rpl_semi_sync_slave soname <span class="string">'semisync_slave.so'</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%semi%'</span>;</span>
<span class="line">+---------------------------------+-------+</span>
<span class="line">| Variable_name                   | Value |</span>
<span class="line">+---------------------------------+-------+</span>
<span class="line">| rpl_semi_sync_slave_enabled     | OFF   |  <span class="comment"># 需要设置成ON</span></span>
<span class="line">| rpl_semi_sync_slave_trace_level | <span class="number">32</span>    |</span>
<span class="line">+---------------------------------+-------+</span>
<span class="line"></span>
<span class="line">set global rpl_semi_sync_slave_enabled=on;</span>
</pre></td></tr></table></figure></p>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><ol>
<li>Mysql主从复制是异步复制  问题：数据会丢失  课题：怎么解决数据丢失？</li>
<li>Mysql支持一主多从复制</li>
<li>Mysql支持级联复制</li>
<li>Mysql支持双向复制</li>
<li>Mysql 5.7开始可以多主一从，可以做多元复制，5.7以前只能有一个master</li>
<li>主服务器 写数据  binlog  –&gt;  从服务器  I/O线程（接收binlog，写到中继日志）  SQL线程（读relay log，event 应用日志写到从服务器数据库）</li>
</ol>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[VMWare CentOS 虚拟机根分区磁盘扩容(基于LVM)]]></title>
      <url>/2017/03/24/linux/20170324_Vmware_centos_%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A0%B9%E5%88%86%E5%8C%BA%E7%A3%81%E7%9B%98%E6%89%A9%E5%AE%B9(%E5%9F%BA%E4%BA%8ELVM)/</url>
      <content type="html"><![CDATA[<h2 id="关闭虚拟机并修改虚拟机配置，增大磁盘大小"><a href="#关闭虚拟机并修改虚拟机配置，增大磁盘大小" class="headerlink" title="关闭虚拟机并修改虚拟机配置，增大磁盘大小"></a>关闭虚拟机并修改虚拟机配置，增大磁盘大小</h2><p><img src="http://oligvdnzp.bkt.clouddn.com/0324_lvm_resize_01.png" alt=""></p>
<a id="more"></a>
<h2 id="启动虚拟机后查看磁盘状态"><a href="#启动虚拟机后查看磁盘状态" class="headerlink" title="启动虚拟机后查看磁盘状态"></a>启动虚拟机后查看磁盘状态</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">df -hT</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">Filesystem           Type   Size  Used Avail Use% Mounted on</span>
<span class="line">/dev/mapper/VolGroup-lv_root</span>
<span class="line">                     ext4    <span class="number">43</span>G  <span class="number">3.2</span>G   <span class="number">38</span>G   <span class="number">8</span>% <span class="regexp">/</span>
<span class="line">tmpfs                tmpfs  3.9G     0  3.9G   0% /dev</span><span class="regexp">/shm</span>
<span class="line">/dev</span><span class="regexp">/sda1            ext4   477M   82M  366M  19% /boot</span></span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">fdisk -l /dev/sda</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">Disk /dev/sda: <span class="number">214.7</span> GB, <span class="number">214748364800</span> bytes             <span class="comment"># 磁盘sda已扩展到200G</span></span>
<span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">26108</span> cylinders</span>
<span class="line">Units = cylinders of <span class="number">16065</span> * <span class="number">512</span> = <span class="number">8225280</span> bytes</span>
<span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span>
<span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span>
<span class="line">Disk identifier: <span class="number">0x00070abb</span></span>
<span class="line"></span>
<span class="line">   Device Boot      Start         End      Blocks   Id  System</span>
<span class="line">/dev/sda1   *           <span class="number">1</span>          <span class="number">64</span>      <span class="number">512000</span>   <span class="number">83</span>  Linux</span>
<span class="line">Partition <span class="number">1</span> does <span class="keyword">not</span> end on cylinder boundary.</span>
<span class="line">/dev/sda2              <span class="number">64</span>        <span class="number">7833</span>    <span class="number">62401536</span>   <span class="number">8</span>e  Linux LVM</span>
<span class="line">------------------------------------------------------------</span>
</pre></td></tr></table></figure>
<h2 id="查看lvm状态"><a href="#查看lvm状态" class="headerlink" title="查看lvm状态"></a>查看lvm状态</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">pvs</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  PV         VG       Fmt  Attr PSize  PFree</span>
<span class="line">  /dev/sda2  VolGroup lvm2 a--u <span class="number">59.51</span>g    <span class="number">0</span> </span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">vgs</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  VG       <span class="comment">#PV #LV #SN Attr   VSize  VFree</span></span>
<span class="line">  VolGroup   <span class="number">1</span>   <span class="number">2</span>   <span class="number">0</span> wz--n- <span class="number">59.51</span>g    <span class="number">0</span> </span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">lvs</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  LV      VG       Attr       LSize  Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span>
<span class="line">  lv_root VolGroup -wi-ao---- <span class="number">43.74</span>g                                                    </span>
<span class="line">  lv_swap VolGroup -wi-ao---- <span class="number">15.77</span>g </span>
<span class="line">------------------------------------------------------------</span>
</pre></td></tr></table></figure>
<h2 id="创建新分区"><a href="#创建新分区" class="headerlink" title="创建新分区"></a>创建新分区</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">fdisk /dev/sda</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">WARNING: DOS-compatible mode is deprecated. Its strongly recommended to</span>
<span class="line">         switch off the mode (command <span class="string">'c'</span>) <span class="keyword">and</span> change display units to</span>
<span class="line">         sectors (command <span class="string">'u'</span>).</span>
<span class="line"></span>
<span class="line">Command (<span class="keyword">m</span> <span class="keyword">for</span> help): n       <span class="comment"># 输入n开始创建分区</span></span>
<span class="line">Command action</span>
<span class="line">   e   extended</span>
<span class="line">   p   primary partition (<span class="number">1</span>-<span class="number">4</span>)</span>
<span class="line">p</span>
<span class="line">Partition number (<span class="number">1</span>-<span class="number">4</span>): <span class="number">3</span>     <span class="comment"># 输入3创建sda3</span></span>
<span class="line">First cylinder (<span class="number">7833</span>-<span class="number">26108</span>, default <span class="number">7833</span>): </span>
<span class="line">Using default value <span class="number">7833</span></span>
<span class="line">Last cylinder, +cylinders <span class="keyword">or</span> +size&#123;K,M,G&#125; (<span class="number">7833</span>-<span class="number">26108</span>, default <span class="number">26108</span>): </span>
<span class="line">Using default value <span class="number">26108</span></span>
<span class="line"></span>
<span class="line">Command (<span class="keyword">m</span> <span class="keyword">for</span> help): w       <span class="comment"># 写入分区表</span></span>
<span class="line">The partition table has been altered!</span>
<span class="line"></span>
<span class="line">Calling ioctl() to re-<span class="keyword">read</span> partition table.</span>
<span class="line"></span>
<span class="line">WARNING: Re-reading the partition table failed with error <span class="number">16</span>: Device <span class="keyword">or</span> resource busy.</span>
<span class="line">The kernel still uses the old table. The new table will be used at</span>
<span class="line">the <span class="keyword">next</span> reboot <span class="keyword">or</span> after you run partprobe(<span class="number">8</span>) <span class="keyword">or</span> kpartx(<span class="number">8</span>)</span>
<span class="line">Syncing disks.    <span class="comment"># 需要重启后才能生效</span></span>
<span class="line">------------------------------------------------------------</span>
</pre></td></tr></table></figure>
<h2 id="重启虚拟机-格式化新分区"><a href="#重启虚拟机-格式化新分区" class="headerlink" title="重启虚拟机 格式化新分区"></a>重启虚拟机 格式化新分区</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">fdisk -l /dev/sda</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">Disk /dev/sda: <span class="number">214.7</span> GB, <span class="number">214748364800</span> bytes</span>
<span class="line"><span class="number">255</span> heads, <span class="number">63</span> sectors/track, <span class="number">26108</span> cylinders</span>
<span class="line">Units = cylinders of <span class="number">16065</span> * <span class="number">512</span> = <span class="number">8225280</span> bytes</span>
<span class="line">Sector size (logical/physical): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span>
<span class="line">I/O size (minimum/optimal): <span class="number">512</span> bytes / <span class="number">512</span> bytes</span>
<span class="line">Disk identifier: <span class="number">0x00070abb</span></span>
<span class="line"></span>
<span class="line">   Device Boot      Start         End      Blocks   Id  System</span>
<span class="line">/dev/sda1   *           <span class="number">1</span>          <span class="number">64</span>      <span class="number">512000</span>   <span class="number">83</span>  Linux</span>
<span class="line">Partition <span class="number">1</span> does <span class="keyword">not</span> end on cylinder boundary.</span>
<span class="line">/dev/sda2              <span class="number">64</span>        <span class="number">7833</span>    <span class="number">62401536</span>   <span class="number">8</span>e  Linux LVM</span>
<span class="line">/dev/sda3            <span class="number">7833</span>       <span class="number">26108</span>   <span class="number">146797950</span>   <span class="number">83</span>  Linux</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">mkfs.ext4 /dev/sda3</span>
</pre></td></tr></table></figure>
<h2 id="lvm扩容"><a href="#lvm扩容" class="headerlink" title="lvm扩容"></a>lvm扩容</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">pvcreate /dev/sda3</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  Physical volume <span class="string">"/dev/sda3"</span> successfully created</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">pvs</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  PV         VG       Fmt  Attr PSize   PFree  </span>
<span class="line">  /dev/sda2  VolGroup lvm2 a--u  <span class="number">59.51</span>g      <span class="number">0</span> </span>
<span class="line">  /dev/sda3           lvm2 ---- <span class="number">140.00</span>g <span class="number">140.00</span>g</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">ll /dev/mapper/</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">total <span class="number">0</span></span>
<span class="line">crw-rw----. <span class="number">1</span> root root <span class="number">10</span>, <span class="number">236</span> Mar <span class="number">24</span> <span class="number">11</span>:<span class="number">49</span> control</span>
<span class="line">lrwxrwxrwx. <span class="number">1</span> root root       <span class="number">7</span> Mar <span class="number">24</span> <span class="number">11</span>:<span class="number">49</span> VolGroup-lv_root -&gt; ../dm-<span class="number">0</span></span>
<span class="line">lrwxrwxrwx. <span class="number">1</span> root root       <span class="number">7</span> Mar <span class="number">24</span> <span class="number">11</span>:<span class="number">49</span> VolGroup-lv_swap -&gt; ../dm-<span class="number">1</span></span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">vgextend /dev/mapper/VolGroup /dev/sda3</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  Volume group <span class="string">"VolGroup"</span> successfully extended</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">lvextend -l +<span class="number">100</span>%FREE /dev/VolGroup/lv_root /dev/sda3</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">  Size of logical volume VolGroup/lv_root changed from <span class="number">43.74</span> GiB (<span class="number">11198</span> extents) to <span class="number">183.74</span> GiB (<span class="number">47037</span> extents).</span>
<span class="line">  Logical volume lv_root successfully resized.</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line">resize2fs /dev/VolGroup/lv_root</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">resize2fs <span class="number">1.43</span>-WIP (<span class="number">20</span>-Jun-<span class="number">2013</span>)</span>
<span class="line">Filesystem at /dev/VolGroup/lv_root is mounted on /; on-line resizing required</span>
<span class="line">old_desc_blocks = <span class="number">3</span>, new_desc_blocks = <span class="number">12</span></span>
<span class="line">The filesystem on /dev/VolGroup/lv_root is now <span class="number">48165888</span> blocks long.</span>
<span class="line">------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 扩容后查看磁盘使用情况</span></span>
<span class="line">df -h</span>
<span class="line">------------------------------------------------------------</span>
<span class="line">Filesystem            Size  Used Avail Use% Mounted on</span>
<span class="line">/dev/mapper/VolGroup-lv_root</span>
<span class="line">                      <span class="number">181</span>G  <span class="number">3.3</span>G  <span class="number">170</span>G   <span class="number">2</span>% <span class="regexp">/</span>
<span class="line">tmpfs                 3.9G     0  3.9G   0% /dev</span><span class="regexp">/shm</span>
<span class="line">/dev</span><span class="regexp">/sda1             477M   82M  366M  19% /boot</span></span>
<span class="line">------------------------------------------------------------</span>
</pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> Linux </tag>
            
            <tag> lvm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-09 MySQL性能优化的关键点]]></title>
      <url>/2017/03/22/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/09-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="服务器参数调优，有哪些关键点？"><a href="#服务器参数调优，有哪些关键点？" class="headerlink" title="服务器参数调优，有哪些关键点？"></a>服务器参数调优，有哪些关键点？</h2><ol>
<li>优化Linux内核参数，如关闭SWAP，调优网络参数、文件限制等</li>
<li>是否关闭NUMA</li>
<li>多网卡是否绑定</li>
<li>磁盘调度算法的选择</li>
<li>挂载磁盘时考虑添加的参数，如<code>noatime</code>和<code>nobarrier</code>等<a id="more"></a>
</li>
</ol>
<h2 id="MySQL性能调优有哪些关键点-经验？"><a href="#MySQL性能调优有哪些关键点-经验？" class="headerlink" title="MySQL性能调优有哪些关键点/经验？"></a>MySQL性能调优有哪些关键点/经验？</h2><h3 id="应用访问的优化"><a href="#应用访问的优化" class="headerlink" title="应用访问的优化"></a>应用访问的优化</h3><ol>
<li>减少数据访问（减少磁盘访问），如尽量让应用去访问数据库的缓存服务器(Redis/Memcached)，性能提升1~1000倍，优化成本低</li>
<li>返回更少数据（减少网络传输或磁盘访问），性能提升1~100倍，优化成本低</li>
<li>减少交互次数（减少网络传输），性能提升1~10倍，优化成本低</li>
</ol>
<h3 id="服务器硬件的选型"><a href="#服务器硬件的选型" class="headerlink" title="服务器硬件的选型"></a>服务器硬件的选型</h3><p>跟据业务需求来最终选择确定MYSQL服务器的配件配置，如CPU的processor数，内存的大小，以及SSD+SAS的组合（活跃数据/随机访问的data文件放到SSD盘中，冷数据/顺序访问的binlog文件放到SAS磁盘中）等。</p>
<h3 id="操作系统优化"><a href="#操作系统优化" class="headerlink" title="操作系统优化"></a>操作系统优化</h3><h4 id="使用推荐的Linux"><a href="#使用推荐的Linux" class="headerlink" title="使用推荐的Linux"></a>使用推荐的Linux</h4><ul>
<li>CentOS</li>
<li>Redhat</li>
<li>SUSE</li>
</ul>
<h4 id="关闭SWAP"><a href="#关闭SWAP" class="headerlink" title="关闭SWAP"></a>关闭SWAP</h4><blockquote>
<p><strong>注意：</strong> 在CentOS 6.4及更新版本的内核中设置vm.swappiness=0，有可能会导致MySQL数据库所在的系统出现内存溢出(OOM)，建议将vm.swappiness设置成1</p>
</blockquote>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在CentOS 5.x/6.x中</span></span>
<span class="line">vi /etc/sysctl.conf</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">vm.swappiness=<span class="number">1</span></span>
<span class="line">----------------------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># CentOS 7.x中</span></span>
<span class="line"><span class="comment">## 查找到存在vm.swappiness参数的配置文件</span></span>
<span class="line">find /usr/lib/tuned -name <span class="string">'*.conf'</span> -type f -<span class="keyword">exec</span> <span class="keyword">grep</span> <span class="string">"vm.swappiness"</span> &#123;&#125; \+</span>
<span class="line">----------------------------------------------------------</span>
<span class="line"><span class="regexp">/usr/lib</span><span class="regexp">/tuned/latency</span>-performance/tuned.conf:vm.swappiness=<span class="number">10</span></span>
<span class="line">/usr/lib/tuned/throughput-performance/tuned.conf:vm.swappiness=<span class="number">10</span></span>
<span class="line">/usr/lib/tuned/virtual-guest/tuned.conf:vm.swappiness = <span class="number">30</span></span>
<span class="line">----------------------------------------------------------</span>
<span class="line"><span class="comment"># 把以上3个文件中的vm.swappiness的值都修改为0或1</span></span>
</pre></td></tr></table></figure>
<h4 id="关闭NUMA"><a href="#关闭NUMA" class="headerlink" title="关闭NUMA"></a>关闭NUMA</h4><blockquote>
<p><strong>NUMA：</strong> 非统一内存访问架构(Non Uniform Memory Access Architecture)。<br>NUMA是一种用于多处理器的电脑记忆体设计，内存访问时间取决于处理器的内存位置。 在安装有多个CPU的计算机中，NUMA硬件可以通过将专用内存与CPU配对来显著提高性能。在NUMA下，处理器访问它自己的本地存储器的速度比非本地存储器(存储器的地方到另一个处理器之间共享的处理器或存储器)快一些。</p>
<p><strong>SMP：</strong> 共享存储型多处理机(Shared Memory mulptiProcessors), 也称为对称型多处理机(Symmetry MultiProcessors)。<br>SMP模式将多个处理器与一个集中的存储器相连。在SMP模式下，所有处理器都可以访问同一个系统物理存储器，这就意味着SMP系统只运行操作系统的一个拷贝。因此SMP系统有时也被称为一致存储器访问(UMA)结构体系，一致性意指无论在什么时候，处理器只能为内存的每个数据保持或共享唯一一个数值。很显然，SMP的缺点是可伸缩性有限，因为在存储器接口达到饱和的时候，增加处理器并不能获得更高的性能。</p>
</blockquote>
<p>SMP和NUMA架构对比图<br><img src="http://oligvdnzp.bkt.clouddn.com/0321_numa_smp.png" alt=""></p>
<p><strong><font color="red">MySQL采用了线程模式，对于NUMA特性的支持并不好，如果单机只运行一个MySQL实例，建议关闭NUMA，方法有以下几种：</font></strong><br>1.BIOS中设置关闭（推荐）<br>2.OS内核中设置关闭<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Centos 7参照以下方法</span></span>
<span class="line">grubby --update-kernel=ALL --args=<span class="string">"numa=off"</span></span>
<span class="line"><span class="comment"># 若要移除上面的修改，使用以下命令</span></span>
<span class="line">grubby --update-kernel=ALL --remove-args=<span class="string">"numa=off"</span></span>
</pre></td></tr></table></figure></p>
<p>3.启动MySQL时关闭<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">numactl --interleave=all mysqld</span>
</pre></td></tr></table></figure></p>
<blockquote>
<p>如果单机运行多个MySQL实例，可以将MySQL绑定在不同的CPU节点上，并且采用绑定的内存分配策略，强制在本节点内分配内存，这样既可以充分利用硬件的NUMA特性，又避免了单实例MySQL对多核CPU利用率不高的问题。详细可参考：<a href="http://www.hellodb.net/2011/06/mysql_multi_instance.html" target="_blank" rel="external">MySQL单机多实例方案</a></p>
</blockquote>
<h4 id="网卡优化"><a href="#网卡优化" class="headerlink" title="网卡优化"></a>网卡优化</h4><p>1.双网卡做成bond0<br>2.调整网络参数<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有可调参数命令是sysctl -a，根据服务器配置调整以下参数</span></span>
<span class="line">vi /etc/sysctl.conf</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.ipv4.tcp_moderate_rcvbuf = <span class="number">1</span></span>
<span class="line">net.ipv4.tcp_wmem = <span class="number">4096</span>        <span class="number">16384</span>   <span class="number">4194304</span></span>
<span class="line">----------------------------------------------------------</span>
</pre></td></tr></table></figure></p>
<h4 id="磁盘调度设置"><a href="#磁盘调度设置" class="headerlink" title="磁盘调度设置"></a>磁盘调度设置</h4><p>MYSQL服务器IO调度算法一般要设置成NOOP或Deadline，推荐使用是<code>Deadline</code>算法。</p>
<ul>
<li>NOOP算法：全写为No Operation。 该算法实现了最简单的FIFO队列，所有IO请求大致按照先来后到的顺序进行操作。</li>
<li>CFQ算法：全写为Completely Fair Queuing。 该算法的特点是按照IO请求的地址进行排序，而不是按照先来后到的顺序来进行响应。</li>
<li>DEADLINE：在CFQ的基础上，解决了IO请求饿死的极端情况。除了CFQ本身具有的IO排序队列之外，DEADLINE额外分别为读IO和写IO提供了FIFO队列。</li>
<li>Anticipatory算法：CFQ和DEADLINE考虑的焦点在于满足零散IO请求上。对于连续的IO请求，比如顺序读，并没有做优化。为了满足随机IO和顺序IO混合的场景，Linux还支持ANTICIPATORY调度算法。</li>
</ul>
<p>查看和修改系统IO的调度方法<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看操作系统的IO调度方法(CentOS Linux)</span></span>
<span class="line">dmesg | <span class="keyword">grep</span> -i scheduler</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">[    <span class="number">1.508820</span>] io scheduler noop registered</span>
<span class="line">[    <span class="number">1.508827</span>] io scheduler deadline registered (default)</span>
<span class="line">[    <span class="number">1.508850</span>] io scheduler cfq registered</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">cat /sys/block/sda/queue/scheduler </span>
<span class="line"></span>
<span class="line"><span class="comment"># 临地更改I/O调度方法 </span></span>
<span class="line">echo deadline &gt; <span class="regexp">/sys/block</span><span class="regexp">/sda/queue</span><span class="regexp">/scheduler</span>
<span class="line"></span>
<span class="line"># 永久的更改I/</span>O调度方法(重启后生效)</span>
<span class="line"><span class="comment">## Centos 7参照以下方法</span></span>
<span class="line">grubby --info=ALL</span>
<span class="line">grubby --update-kernel=ALL --args=<span class="string">"elevator=deadline"</span></span>
<span class="line"></span>
<span class="line"><span class="comment">## Centos 5/6参照以下方法 </span></span>
<span class="line">vi /boot/grub/grub.conf </span>
<span class="line">----------------------------------------------------------</span>
<span class="line"><span class="comment"># 添加elevator=deadline到下行</span></span>
<span class="line">kernel /vmlinuz-<span class="number">2.6</span>.<span class="number">18</span>-<span class="number">274</span>.el5 ro root=LABEL=<span class="regexp">/ elevator=deadline rhgb quiet</span>
<span class="line">----------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h4 id="使用推荐的文件系统"><a href="#使用推荐的文件系统" class="headerlink" title="使用推荐的文件系统"></a>使用推荐的文件系统</h4><p>1.推荐用xfs/ext4<br>2.挂载盘时添加<code>noatime</code>和<code>nobarrier</code>参数，设置方法如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/fstab</span>
<span class="line">----------------------------------------------------------</span>
<span class="line"><span class="regexp">/dev/mapper</span><span class="regexp">/cl-root     /</span>                       xfs     defaults,noatime,nobarrier        <span class="number">0</span> <span class="number">0</span></span>
<span class="line">----------------------------------------------------------</span>
</pre></td></tr></table></figure></p>
<blockquote>
<p>　　当文件被创建，修改和访问时，Linux系统会记录这些时间信息。当系统的读文件操作频繁时，记录文件最近一次被读取的时间信息，将是一笔不少的开销。所以，为了提高系统的性能，我们可以在读取文件时不修改文件的<code>atime</code>属性。可以通过在加载文件系统时使用<code>noatime</code>选项来做到这一点。当以<code>noatime</code>选项加载（mount）文件系统时，对文件的读取不会更新文件属性中的<code>atime</code>信息。设置<code>noatime</code>的重要性是消除了文件系统对文件的写操作，文件只是简单地被系统读取。由于写操作相对读来说要更消耗系统资源，所以这样设置可以明显提高服务器的性能。注意wtime信息仍然有效，任何时候文件被写，该信息仍被更新。</p>
<p>　　现在的很多文件系统会在数据提交时强制底层设备刷新cache，避免数据丢失，称之为<code>write barriers</code>。 但是，其实我们数据库服务器底层存储设备要么采用RAID卡，RAID卡本身的电池可以掉电保护；要么采用Flash卡，它也有自我保护机制，保证数据不会丢失。 所以我们可以安全的使用<code>nobarrier</code>挂载文件系统。对于<code>ext3</code>、<code>ext4</code>和<code>reiserfs</code>文件系统可以在mount时指定<code>barrier=0</code>；对于<code>xfs</code>可以指定<code>nobarrier</code>选项。</p>
</blockquote>
<h3 id="数据库优化"><a href="#数据库优化" class="headerlink" title="数据库优化"></a>数据库优化</h3><h4 id="实例优化，修改参数"><a href="#实例优化，修改参数" class="headerlink" title="实例优化，修改参数"></a>实例优化，修改参数</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">innodb_buffer_pool_size        <span class="comment"># 相当于Oracle的SGA，一般设置为物理内存的70%-80%，设置的过大，会导致system的swap空间被占用，导致操作系统变慢，从而减低sql查询的效率</span></span>
<span class="line">innodb_thread_concurrency      <span class="comment"># 一般设置成小于CPU的核心数</span></span>
<span class="line">query_cache_type = <span class="number">0</span>           <span class="comment"># =0 关闭结果集缓存</span></span>
<span class="line">query_cache_size =<span class="number">0</span>            <span class="comment"># =0 关闭结果集缓存</span></span>
<span class="line">max_used_connections           <span class="comment"># 最大的连接数，根据应用实际情况来设置</span></span>
<span class="line">interactive_timeout            <span class="comment"># 应用交互超时等待</span></span>
<span class="line">wait_timeout                   <span class="comment"># 连接池超时等待</span></span>
<span class="line">innodb_io_capacity=<span class="number">20000</span>       <span class="comment"># innodb IO容量的设置，一般设置成IOPS的75%左右</span></span>
<span class="line">innodb_flush_log_at_trx_commit <span class="comment"># =1 每一次事务提交或事务外的指令都需要把日志写入（flush）硬盘</span></span>
<span class="line">sync_binlog                    <span class="comment"># =1 与innodb_flush_log_at_trx_commit=1 双1设置，提高数据安全性</span></span>
<span class="line">innodb_log_file_size           <span class="comment"># 日志文件的大小，日志放到SSD建议设4-8G，放到SAS盘建议设成1-2G</span></span>
<span class="line">innodb_log_files_in_group      <span class="comment"># 日志文件的数量</span></span>
<span class="line">innodb_flush_method            <span class="comment"># 有三个值：fdatasync(默认)，O_DSYNC，O_DIRECT，详细</span></span>
<span class="line">innodb_max_dirty_pages_pct     <span class="comment"># =50 用来控制在 InnoDB Buffer Pool 中可以不用写入数据文件中的Dirty Page的比例(已经被修但还没有从内存中写入到数据文件的脏数据)</span></span>
<span class="line">Innodb_flush_neighbors         <span class="comment"># =0或1 相邻的数据合并，SSD盘关闭此设置，SAS盘开启此设置</span></span>
<span class="line">transaction_isolation          <span class="comment"># 事务隔离级别，生产环境设置为READ-COMMITTED</span></span>
</pre></td></tr></table></figure>
<p>内存分配<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">All thread buffer =              <span class="comment"># 会话/线程级内存分配总和</span></span>
<span class="line">    max_threads * (              <span class="comment"># 当前活跃连接数</span></span>
<span class="line">      read_buffer_size           <span class="comment"># 顺序读缓冲，提高顺序读效率</span></span>
<span class="line">    + read_rnd_buffer_size       <span class="comment"># 随机读缓冲，提高随机读效率</span></span>
<span class="line">    + sort_buffer_size           <span class="comment"># 排序缓冲，提高排序效率</span></span>
<span class="line">    + join_buffer_size           <span class="comment"># 表连接缓冲，提高表连接效率</span></span>
<span class="line">    + binlog_cache_size          <span class="comment"># 二进制日志缓冲，提高二进制日志写入效率</span></span>
<span class="line">    + tmp_table_size             <span class="comment"># 内存临时表，提高临时表存储效率</span></span>
<span class="line">    + thread_stack               <span class="comment"># 线程堆栈，暂时寄存SQL语句/存储过程</span></span>
<span class="line">    + thread_cache_size          <span class="comment"># 线程缓存，降低多次反复打开线程开销</span></span>
<span class="line">    + net_buffer_length          <span class="comment"># 线程持连接缓冲以及读取结果缓冲</span></span>
<span class="line">    + bulk_insert_buffer_size    <span class="comment"># MyISAM表批量写入数据缓冲</span></span>
<span class="line">)</span>
<span class="line"></span>
<span class="line">global buffer =                  <span class="comment"># 全局内存分配总和 </span></span>
<span class="line">      innodb_buffer_pool_size    <span class="comment"># InnoDB高速缓冲，行数据、索引缓冲，以及事务锁、自适应哈希等</span></span>
<span class="line">    + innodb_additional_mem_pool_size <span class="comment"># InnoDB数据字典额外内存，缓存所有表数据字典</span></span>
<span class="line">    + innodb_log_buffer_size     <span class="comment"># InnoDB REDO日志缓冲，提高REDO日志写入效率</span></span>
<span class="line">    + key_buffer_size            <span class="comment"># MyISAM表索引高速缓冲，提高MyISAM表索引读写效率</span></span>
<span class="line">    + query_cache_size           <span class="comment"># 查询高速缓存，缓存查询结果，提高反复查询返回效率</span></span>
<span class="line">    + table_cahce                <span class="comment"># 表空间文件描述符缓存，提高数据表打开效率 </span></span>
<span class="line">    + table_definition_cache     <span class="comment"># 表定义文件描述符缓存，提高数据表打开效率</span></span>
</pre></td></tr></table></figure></p>
<p>innodb_flush_method参数<br><img src="http://oligvdnzp.bkt.clouddn.com/0322_innodb_flush_method.png" alt=""></p>
<h4 id="SQL优化"><a href="#SQL优化" class="headerlink" title="SQL优化"></a>SQL优化</h4><ol>
<li><font color="red">禁止多于3表join</font>，尽量用单表查询</li>
<li>SELECT语句只获取需要的字段，禁止使用<code>select * from</code>语句，这是有效防止新增字段对应用逻辑的影响，还能减少对性能的影响</li>
<li>InnoDB表避免使用<code>COUNT(*)</code>操作，计数统计实时要求较强可以使用<code>memcache</code>或者<code>redis</code>，非实时统计可以使用单独统计表，定时更新</li>
<li>避免多余的排序。使用<code>GROUP BY</code>时，默认会进行排序，当你不需要排序时，可以使用<code>order by null</code>，例如<code>select a.OwnerUserID,count(*) cnt from DP_MessageList a group by a.OwnerUserID order by null;</code></li>
<li>新增排序要求：不鼓励在DB里排序，尽量放到app server上排序，app server有上百台，而DB仅仅个位数的服务器数量，排序都在DB，会把DB压垮</li>
<li>全模糊查询无法使用INDEX，应当尽可能避免，如：select * from table where name like ‘%hotgirl%;’，不建议使用%前缀模糊查询，例如LIKE ‘%weibo’。</li>
<li>使用IN代替OR。SQL语句中IN包含的值不应过多，应少于1000个</li>
<li>禁止隐式转换。数值类型禁止加引号；字符串类型必须加引号</li>
<li>禁止使用负向查询，例如not in、!=、not like</li>
<li><font color="red">select for update语法，必须重点review流程</font></li>
<li>尽量少用<code>or</code>，当<code>where</code>子句中存在多个条件以“或”并存的时候，MySQL的优化器并没有很好的解决其执行计划优化的问题，再加上MySQL特有的SQL与Storage分层架构方式，造成了其性能比较低下，很多时候使用<code>union all</code>或者<code>union</code>(必要的时候)的方式来代替<code>or</code>会得到更好的效果</li>
<li>尽量用<code>union all</code>代替<code>union</code>，<code>union</code>和<code>union all</code>的差异主要是前者需要将两个（或者多个）结果集合并后再进行唯一性过滤操作，这就会涉及到排序，增加大量的CPU运算，加大资源消耗及延迟。所以当我们可以确认不可能出现重复结果集或者不在乎重复结果集的时候，尽量使用union all而不是union</li>
<li>尽量早过滤，这一优化策略其实最常见于索引的优化设计中（将过滤性更好的字段放得更靠前），尽量用join代替子查询</li>
<li>禁止在主库上执行后台管理和统计类功能的QUERY，必要时申请统计类从库</li>
</ol>
<p>查看SQL执行计划示例<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; explain</span>
<span class="line">    -&gt; <span class="keyword">select</span> id,name from t2 where id=<span class="number">5</span>;</span>
<span class="line">+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span>
<span class="line">| id | select_type | table | type  | possible_keys | key     | key_len | <span class="keyword">ref</span>   | rows | Extra |</span>
<span class="line">+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | t2    | const | PRIMARY       | PRIMARY | <span class="number">4</span>       | const |    <span class="number">1</span> | NULL  |</span>
<span class="line">+----+-------------+-------+-------+---------------+---------+---------+-------+------+-------+</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; explain</span>
<span class="line">    -&gt; <span class="keyword">select</span> id,name from t2 where name=<span class="string">'C'</span>;</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+</span>
<span class="line">| id | select_type | table | type | possible_keys | key  | key_len | <span class="keyword">ref</span>   | rows | Extra                    |</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+</span>
<span class="line">|  <span class="number">1</span> | SIMPLE      | t2    | <span class="keyword">ref</span>  | name          | name | <span class="number">33</span>      | const |    <span class="number">1</span> | Using where; Using <span class="keyword">index</span> |</span>
<span class="line">+----+-------------+-------+------+---------------+------+---------+-------+------+--------------------------+</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
</pre></td></tr></table></figure></p>
<h4 id="索引设计"><a href="#索引设计" class="headerlink" title="索引设计"></a>索引设计</h4><h5 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h5><ol>
<li>查询谓词都能够通过index进行扫描</li>
<li>排序谓词都能够利用index的有序性</li>
<li>index包含了查询所需要的所有字段</li>
</ol>
<h5 id="不能使用索引"><a href="#不能使用索引" class="headerlink" title="不能使用索引"></a>不能使用索引</h5><ol>
<li>不要给选择率低的字段建索引(通过索引扫描的记录数超过30%，变成全表扫描)</li>
<li>联合索引中：第一个索引列使用范围查询,第一个查询条件不是最左索引列</li>
<li>Like查询条件列最左以通配符% 开始</li>
<li>两个独立索引，其中一个用于检索，一个用于排序（索引不是越多越好，尽量合并索引）</li>
<li>表关联字段类型不一样（也包括长度不一样）</li>
<li>索引字段条件上使用函数</li>
<li>不要使用外健约束</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.ipcpu.com/2016/11/grub2-centos7/" target="_blank" rel="external">Grub2相对Grub的一些改进和注意事项（CentOS7）</a></li>
<li><a href="https://linux.cn/article-3479-1.html" target="_blank" rel="external">LINUX上MYSQL优化三板斧</a></li>
</ul>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-08 MySQL监控系统之Zabbix]]></title>
      <url>/2017/03/20/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/08-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="部署zabbix监控"><a href="#部署zabbix监控" class="headerlink" title="部署zabbix监控"></a>部署zabbix监控</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>zabbix（音同 zbix）是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。<br>zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。<br>zabbix由2部分构成，zabbix server与可选组件zabbix agent。zabbix server可以通过SNMP，zabbix agent，ping，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它可以运行在Linux，Solaris，HP-UX，AIX，Free BSD，Open BSD，OS X等平台上。</p>
<p>为了使用最新3.2版本的Zabbix，本次部署选用的Linux OS是最新的CentOS7.3（php版本为5.4）。<br>CentOS6.X和CentOS7.X的安装和使用均有较大变化，为便于今后的学习和工作，下面将CentOS7.3的安装和基本配置也记录到本文中。</p>
<h3 id="安装CentOS7-3"><a href="#安装CentOS7-3" class="headerlink" title="安装CentOS7.3"></a>安装CentOS7.3</h3><p>详见：<a href="/2017/03/18/linux/20170318_CentOS7.3安装图解/">CentOS7.3安装图解</a><br><a id="more"></a></p>
<h3 id="CentOS7-X系统的基本配置和使用"><a href="#CentOS7-X系统的基本配置和使用" class="headerlink" title="CentOS7.X系统的基本配置和使用"></a>CentOS7.X系统的基本配置和使用</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看系统版本</span></span>
<span class="line">cat /etc/redhat-release</span>
<span class="line">-----------------------------------------------</span>
<span class="line">CentOS Linux release <span class="number">7.3</span>.<span class="number">1611</span> (Core) </span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置IP</span></span>
<span class="line">vi /etc/sysconfig/network-scripts/ifcfg-ens16<span class="number">0</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">TYPE=Ethernet</span>
<span class="line">BOOTPROTO=static</span>
<span class="line">DEFROUTE=yes</span>
<span class="line">PEERDNS=yes</span>
<span class="line">PEERROUTES=yes</span>
<span class="line">IPV4_FAILURE_FATAL=yes</span>
<span class="line">IPV6INIT=<span class="keyword">no</span></span>
<span class="line">NAME=ens16<span class="number">0</span></span>
<span class="line">UUID=<span class="number">38</span>e983c8-b6ad-<span class="number">40</span>cf-<span class="number">9592</span>-<span class="number">3</span>a3652cf8c6d</span>
<span class="line">DEVICE=ens16<span class="number">0</span></span>
<span class="line">ONBOOT=yes</span>
<span class="line">IPADDR=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">PREFIX=<span class="number">24</span></span>
<span class="line">GATEWAY=<span class="number">10.245</span>.<span class="number">231.254</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启网络，使配置生效</span></span>
<span class="line">service network restart</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置主机名</span></span>
<span class="line">hostnamectl status</span>
<span class="line">-----------------------------------------------</span>
<span class="line">   Static hostname: localhost.localdomain</span>
<span class="line">         Icon name: computer-vm</span>
<span class="line">           Chassis: vm</span>
<span class="line">        Machine ID: <span class="number">5</span>f66fc1b61374082a7e6e595fc7669c5</span>
<span class="line">           Boot ID: <span class="number">269679</span>da89c54fd4a736c6968b8644f3</span>
<span class="line">    Virtualization: vmware</span>
<span class="line">  Operating System: CentOS Linux <span class="number">7</span> (Core)</span>
<span class="line">       CPE OS Name: cpe:<span class="regexp">/o:centos:centos:7</span>
<span class="line">            Kernel: Linux 3.10.0-514.el7.x86_64</span>
<span class="line">      Architecture: x86-64</span>
<span class="line">-----------------------------------------------</span>
<span class="line">hostnamectl --static set-hostname zabbix</span>
<span class="line"></span>
<span class="line"># 禁用SELINUX</span>
<span class="line">setenforce 0</span>
<span class="line">vi /etc</span><span class="regexp">/selinux/config</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">SELINUX=disabled</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 禁用防火墙</span></span>
<span class="line">systemctl disable firewalld</span>
<span class="line">systemctl status firewalld</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置内核参数(mysql需要)</span></span>
<span class="line">vi /etc/sysctl.d/<span class="number">99</span>-sysctl.conf</span>
<span class="line">-----------------------------------------------</span>
<span class="line">kernel.shmmax = <span class="number">2199023255552</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使内核参数生效</span></span>
<span class="line">sysctl -p</span>
<span class="line"></span>
<span class="line"><span class="comment"># 常用CentOS7.x命令</span></span>
<span class="line"><span class="comment">## 查看所有系统服务状态</span></span>
<span class="line">systemctl list-unit-files -t service </span>
<span class="line"></span>
<span class="line"><span class="comment">## 查看系统启动以来的message信息(类似dmesg)</span></span>
<span class="line">journalctl -b</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看网络配置</span></span>
<span class="line">ip a</span>
<span class="line">-----------------------------------------------</span>
<span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue <span class="keyword">state</span> UNKNOWN qlen <span class="number">1</span></span>
<span class="line">    <span class="keyword">link</span>/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span>
<span class="line">    inet <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>/<span class="number">8</span> scope host lo</span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">    inet6 ::<span class="number">1</span>/<span class="number">128</span> scope host </span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line"><span class="number">2</span>: ens16<span class="number">0</span>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc mq <span class="keyword">state</span> UP qlen <span class="number">1000</span></span>
<span class="line">    <span class="keyword">link</span>/ether <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:a<span class="number">0</span>:<span class="number">1</span>d:b1 brd ff:ff:ff:ff:ff:ff</span>
<span class="line">    inet <span class="number">10.245</span>.<span class="number">231.202</span>/<span class="number">24</span> brd <span class="number">10.245</span>.<span class="number">231.255</span> scope global ens16<span class="number">0</span></span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">    inet6 fe8<span class="number">0</span>::<span class="number">250</span>:<span class="number">56</span>ff:fea<span class="number">0</span>:<span class="number">1</span>db1/<span class="number">64</span> scope <span class="keyword">link</span> </span>
<span class="line">       valid_lft forever preferred_lft forever</span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure>
<h3 id="源码编译安装mysql"><a href="#源码编译安装mysql" class="headerlink" title="源码编译安装mysql"></a>源码编译安装mysql</h3><p>参见博文：<a href="/2017/02/23/mysql/MySQL-DBA从小白到大神实战课程学习/02-MySQL-DBA从小白到大神实战/#详细描述MySQL编译安装的过程（截图安装步骤）">MySQL DBA从小白到大神实战-02 MySQL标准化、自动化部署</a></p>
<h3 id="安装和配置zabbix-server"><a href="#安装和配置zabbix-server" class="headerlink" title="安装和配置zabbix server"></a>安装和配置zabbix server</h3><h4 id="建zabbix用户、组和安装目录"><a href="#建zabbix用户、组和安装目录" class="headerlink" title="建zabbix用户、组和安装目录"></a>建zabbix用户、组和安装目录</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">groupadd zabbix</span>
<span class="line">useradd -g zabbix zabbix</span>
<span class="line">echo <span class="string">"zabbix"</span> | passwd --stdin zabbix</span>
<span class="line"></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/zabbix</span>
<span class="line"><span class="keyword">chown</span> -R zabbix:zabbix /u01/zabbix</span>
</pre></td></tr></table></figure>
<h4 id="安装编译基础依赖包"><a href="#安装编译基础依赖包" class="headerlink" title="安装编译基础依赖包"></a>安装编译基础依赖包</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line">mount /dev/cdrom /media/disk</span>
<span class="line"></span>
<span class="line">cd /etc/yum.repos.d/</span>
<span class="line">-----------------------------------------------</span>
<span class="line">cp CentOS-Base.repo CentOS-Base.repo.bak</span>
<span class="line">vi /etc/yum.repos.d/CentOS-Base.repo</span>
<span class="line">[base]</span>
<span class="line">name=CentOS-$releasever - Base</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span></span>
<span class="line">gpgcheck=<span class="number">0</span></span>
<span class="line">enabled=<span class="number">1</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line">yum -<span class="keyword">y</span> install wget unzip libxml2 libxml2-devel httpd php php-mysql php-common php-gd \</span>
<span class="line">php-odbc php-pear curl curl-devel net-snmp net-snmp-devel perl-DBI php-xml ntpdate  \</span>
<span class="line">zlib-devel glibc-devel curl-devel gcc automake openssl-devel net-snmp-devel rpm-devel \</span>
<span class="line">lrzsz ncurses-devel <span class="keyword">readline</span>-devel</span>
<span class="line"></span>
<span class="line"><span class="comment"># http://mirrors.sohu.com/centos/7.3.1611/os/x86_64/Packages/ 下载以下包并上传到服务器/tmp目录下</span></span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">126576</span> Mar <span class="number">14</span> <span class="number">11</span>:<span class="number">58</span> libidn-devel-<span class="number">1.28</span>-<span class="number">4</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">176988</span> Mar <span class="number">14</span> <span class="number">13</span>:<span class="number">46</span> OpenIPMI-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">136452</span> Mar <span class="number">14</span> <span class="number">11</span>:<span class="number">58</span> OpenIPMI-devel-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">513864</span> Mar <span class="number">14</span> <span class="number">13</span>:<span class="number">42</span> OpenIPMI-libs-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root  <span class="number">15440</span> Mar <span class="number">14</span> <span class="number">13</span>:<span class="number">45</span> OpenIPMI-modalias-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root  <span class="number">58488</span> Mar <span class="number">14</span> <span class="number">11</span>:<span class="number">57</span> php-bcmath-<span class="number">5.4</span>.<span class="number">16</span>-<span class="number">42</span>.el7.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">516620</span> Mar <span class="number">14</span> <span class="number">11</span>:<span class="number">57</span> php-mbstring-<span class="number">5.4</span>.<span class="number">16</span>-<span class="number">42</span>.el7.x86_64.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 手动安装包</span></span>
<span class="line">cd /tmp</span>
<span class="line">rpm -ivh libidn*.rpm</span>
<span class="line">rpm -ivh php*.rpm</span>
<span class="line">rpm -ivh OpenIPMI-modalias-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">rpm -ivh OpenIPMI-libs-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">rpm -ivh OpenIPMI-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line">rpm -ivh OpenIPMI-devel-<span class="number">2.0</span>.<span class="number">19</span>-<span class="number">15</span>.el7.x86_64.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看php和apache版本</span></span>
<span class="line">php --version</span>
<span class="line">-----------------------------------------------</span>
<span class="line">PHP <span class="number">5.4</span>.<span class="number">16</span> (cli) (built: Nov  <span class="number">6</span> <span class="number">2016</span> <span class="number">00</span>:<span class="number">29</span>:<span class="number">02</span>) </span>
<span class="line">Copyright (c) <span class="number">1997</span>-<span class="number">2013</span> The PHP Group</span>
<span class="line">Zend Engine v2.<span class="number">4.0</span>, Copyright (c) <span class="number">1998</span>-<span class="number">2013</span> Zend Technologies</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line">httpd -version</span>
<span class="line">-----------------------------------------------</span>
<span class="line">Server version: Apache/<span class="number">2.4</span>.<span class="number">6</span> (CentOS)</span>
<span class="line">Server built:   Nov <span class="number">14</span> <span class="number">2016</span> <span class="number">18</span>:<span class="number">04</span>:<span class="number">44</span></span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure>
<h4 id="源码编译安装zabbix"><a href="#源码编译安装zabbix" class="headerlink" title="源码编译安装zabbix"></a>源码编译安装zabbix</h4><p>从官岗下载zabbix源码包：<a href="http://www.zabbix.com/download" target="_blank" rel="external">http://www.zabbix.com/download </a><br>上传到服务器/tmp目录后解压<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /tmp/</span>
<span class="line">tar -zxvf zabbix-<span class="number">3.2</span>.<span class="number">4</span>.tar.gz</span>
</pre></td></tr></table></figure></p>
<p>编译安装，相关步骤参考<a href="https://www.zabbix.com/documentation/3.2/manual/installation/install" target="_blank" rel="external">官网安装手册</a><br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span></span>
<span class="line">./configure --prefix=<span class="regexp">/u01/zabbix</span> --enable-server --enable-agent \</span>
<span class="line">--with-mysql=<span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysql</span>_config \</span>
<span class="line">--with-net-snmp --with-libcurl --with-libxml2</span>
<span class="line"></span>
<span class="line">make &amp;&amp; make install</span>
</pre></td></tr></table></figure></p>
<h4 id="创建所需数据库并授权用户"><a href="#创建所需数据库并授权用户" class="headerlink" title="创建所需数据库并授权用户"></a>创建所需数据库并授权用户</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line">mysql</span>
<span class="line"></span>
<span class="line">create database zabbix default character set utf8;</span>
<span class="line">grant all privileges on *.* to <span class="string">'zabbix'</span>@'%' identified by <span class="string">'zabbix'</span>;</span>
<span class="line">grant all privileges on *.* to <span class="string">'zabbix'</span>@'localhost<span class="string">' identified by '</span>zabbix<span class="string">';</span>
<span class="line"></span>
<span class="line">show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">| test               |</span>
<span class="line">| zabbix             |</span>
<span class="line">+--------------------+</span>
<span class="line"></span>
<span class="line">use zabbix</span>
<span class="line">select database();</span>
<span class="line">+------------+</span>
<span class="line">| database() |</span>
<span class="line">+------------+</span>
<span class="line">| zabbix     |</span>
<span class="line">+------------+</span></span>
</pre></td></tr></table></figure>
<h4 id="导入zabbix定义的表结构和数据"><a href="#导入zabbix定义的表结构和数据" class="headerlink" title="导入zabbix定义的表结构和数据"></a>导入zabbix定义的表结构和数据</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">source /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span>/database/mysql/schema.sql</span>
<span class="line">source /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span>/database/mysql/data.sql</span>
<span class="line">source /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span>/database/mysql/images.sql</span>
</pre></td></tr></table></figure>
<h4 id="修改相关配置文件"><a href="#修改相关配置文件" class="headerlink" title="修改相关配置文件"></a>修改相关配置文件</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户下</span></span>
<span class="line"><span class="comment"># 修改zabbix server配置文件</span></span>
<span class="line">vi /u01/zabbix/etc/zabbix_server.conf</span>
<span class="line">-----------------------------------------------</span>
<span class="line">ListenPort=<span class="number">10051</span></span>
<span class="line">DBHost=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">DBName=zabbix</span>
<span class="line">DBUser=zabbix</span>
<span class="line">DBPassword=zabbix</span>
<span class="line">DBPort=<span class="number">3306</span></span>
<span class="line">PidFile=<span class="regexp">/tmp/zabbix</span>_server.pid</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改php配置文件</span></span>
<span class="line">cp /etc/php.ini /etc/php.ini.zabbixbak</span>
<span class="line">sed -i <span class="string">'s/max_execution_time = 30/max_execution_time = 300/g'</span> /etc/php.ini</span>
<span class="line">sed -i <span class="string">'/date.timezone =/a\date.timezone = Asia/Shanghai'</span> /etc/php.ini</span>
<span class="line">sed -i <span class="string">'/max_input_time =/s/60/300/'</span> /etc/php.ini</span>
<span class="line">sed -i <span class="string">'/mbstring.func_overload = 0/a\mbstring.func_overload = 1'</span> /etc/php.ini</span>
<span class="line">sed -i <span class="string">'/post_max_size =/s/8M/32M/'</span> /etc/php.ini</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改apache配置文件</span></span>
<span class="line">sed -i <span class="string">'/ServerName/a\ServerName zabbix:80'</span> /etc/httpd/conf/httpd.conf</span>
</pre></td></tr></table></figure>
<h4 id="拷贝zabbix的web界面程序文件"><a href="#拷贝zabbix的web界面程序文件" class="headerlink" title="拷贝zabbix的web界面程序文件"></a>拷贝zabbix的web界面程序文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir /var/www/html/zabbix</span>
<span class="line">cp -rf /tmp/zabbix-3.2.4/frontends/php/* /var/www/html/zabbix</span>
<span class="line">chown -R apache.apache /var/www/html/zabbix</span>
</pre></td></tr></table></figure>
<h4 id="启动apache和zabbix-server"><a href="#启动apache和zabbix-server" class="headerlink" title="启动apache和zabbix server"></a>启动apache和zabbix server</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">systemctl enable httpd.service</span>
<span class="line">systemctl start httpd.service</span>
<span class="line">systemctl status httpd.service</span>
<span class="line">-----------------------------------------------</span>
<span class="line">● httpd.service - The Apache HTTP Server</span>
<span class="line">   Loaded: loaded (<span class="regexp">/usr/lib</span><span class="regexp">/systemd/system</span><span class="regexp">/httpd.service; enabled; vendor preset: disabled)</span>
<span class="line">   Active: active (running) since Thu 2017-03-16 15:12:59 CST; 15s ago</span>
<span class="line">     Docs: man:httpd(8)</span>
<span class="line">           man:apachectl(8)</span>
<span class="line">  Process: 762 ExecStop=/bin</span><span class="regexp">/kill -WINCH $&#123;MAINPID&#125; (code=exited, status=0/</span>SUCCESS)</span>
<span class="line"> Main PID: <span class="number">773</span> (httpd)</span>
<span class="line">   Status: <span class="string">"Total requests: 0; Current requests/sec: 0; Current traffic:   0 B/sec"</span></span>
<span class="line">   CGroup: <span class="regexp">/system.slice/httpd</span>.service</span>
<span class="line">           ├─<span class="number">773</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           ├─<span class="number">775</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           ├─<span class="number">776</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           ├─<span class="number">777</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           ├─<span class="number">779</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line">           └─<span class="number">780</span> /usr/sbin/httpd -DFOREGROUND</span>
<span class="line"></span>
<span class="line">Mar <span class="number">16</span> <span class="number">15</span>:<span class="number">12</span>:<span class="number">59</span> zabbix systemd[<span class="number">1</span>]: Starting The Apache HTTP Server...</span>
<span class="line">Mar <span class="number">16</span> <span class="number">15</span>:<span class="number">12</span>:<span class="number">59</span> zabbix systemd[<span class="number">1</span>]: Started The Apache HTTP Server.</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动zabbix server</span></span>
<span class="line">/u01/zabbix/sbin/zabbix_server -c /u01/zabbix/etc/zabbix_server.conf</span>
<span class="line"></span>
<span class="line"><span class="comment"># 添加到系统启动</span></span>
<span class="line">cd /tmp/zabbix-<span class="number">3.2</span>.<span class="number">4</span></span>
<span class="line">cp misc/init.d/fedora/core/zabbix_server /etc/init.d/zabbix_server</span>
<span class="line">cp misc/init.d/fedora/core/zabbix_agentd /etc/init.d/zabbix_agentd</span>
<span class="line"></span>
<span class="line">chkconfig --add zabbix_server</span>
<span class="line">chkconfig --add zabbix_agentd</span>
<span class="line">chkconfig zabbix_server on</span>
<span class="line">chkconfig zabbix_agentd on</span>
<span class="line"></span>
<span class="line">vi /etc/init.d/zabbix_server</span>
<span class="line">-----------------------------------------------</span>
<span class="line">BASEDIR=<span class="regexp">/u01/zabbix</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line">vi /etc/init.d/zabbix_agentd</span>
<span class="line">-----------------------------------------------</span>
<span class="line">BASEDIR=<span class="regexp">/u01/zabbix</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动zabbix_server</span></span>
<span class="line">systemctl start zabbix_server.service</span>
</pre></td></tr></table></figure>
<h4 id="通过WEB界面安装配置zabbix"><a href="#通过WEB界面安装配置zabbix" class="headerlink" title="通过WEB界面安装配置zabbix"></a>通过WEB界面安装配置zabbix</h4><p>在浏览器中输入：<a href="http://10.245.231.202/zabbix" target="_blank" rel="external">http://10.245.231.202/zabbix</a>，打开图形界面 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_01.png" alt=""><br>确保所有项都是OK状态 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_02.png" alt=""><br>配置数据库连接 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_03.png" alt=""><br>配置zabbix server信息 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_04.png" alt=""><br>确认信息 -&gt; 下一步<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_05.png" alt=""><br>下载配置文件，按要求保存到指定位置<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_06.png" alt=""><br>配置文件内容如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /var/www/html/zabbix/conf/zabbix.conf.php</span>
<span class="line">-----------------------------------------------</span>
<span class="line">&lt;?php</span>
<span class="line">// Zabbix GUI configuration file.</span>
<span class="line">global $DB;</span>
<span class="line"></span>
<span class="line">$DB[<span class="string">'TYPE'</span>]     = <span class="string">'MYSQL'</span>;</span>
<span class="line">$DB[<span class="string">'SERVER'</span>]   = <span class="string">'10.245.231.202'</span>;</span>
<span class="line">$DB[<span class="string">'PORT'</span>]     = <span class="string">'3306'</span>;</span>
<span class="line">$DB[<span class="string">'DATABASE'</span>] = <span class="string">'zabbix'</span>;</span>
<span class="line">$DB[<span class="string">'USER'</span>]     = <span class="string">'zabbix'</span>;</span>
<span class="line">$DB[<span class="string">'PASSWORD'</span>] = <span class="string">'zabbix'</span>;</span>
<span class="line"></span>
<span class="line"><span class="regexp">//</span> Schema name. Used <span class="keyword">for</span> IBM DB2 <span class="keyword">and</span> PostgreSQL.</span>
<span class="line">$DB[<span class="string">'SCHEMA'</span>] = <span class="string">''</span>;</span>
<span class="line"></span>
<span class="line">$ZBX_SERVER      = <span class="string">'10.245.231.202'</span>;</span>
<span class="line">$ZBX_SERVER_PORT = <span class="string">'10051'</span>;</span>
<span class="line">$ZBX_SERVER_NAME = <span class="string">'zabbix'</span>;</span>
<span class="line"></span>
<span class="line">$IMAGE_FORMAT_DEFAULT = IMAGE_FORMAT_PNG;</span>
<span class="line"></span>
<span class="line">systemctl restart httpd</span>
<span class="line">The default user name is Admin, password zabbix.</span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure></p>
<p>结束安装<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_07.png" alt=""><br>默认的用户名是<code>admin</code>，密码是<code>zabbix</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_08.png" alt=""><br>登陆后，可以将显示语言设置为中文(英文好的，不建议修改，而且zabbix汉化不是很完全和准确)<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_09.png" alt=""><br>选择中文，点update<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_10.png" alt=""></p>
<h3 id="配置启动zabbix-agent"><a href="#配置启动zabbix-agent" class="headerlink" title="配置启动zabbix agent"></a>配置启动zabbix agent</h3><p>修改配置文件并启动agent<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /u01/zabbix/etc/zabbix_agentd.conf</span>
<span class="line"><span class="comment"># 修改以下内容</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">Server=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">ServerActive=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">Hostname=zabbix</span>
<span class="line">-----------------------------------------------</span>
<span class="line"><span class="comment"># 启动</span></span>
<span class="line">/u01/zabbix/sbin/zabbix_agentd</span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line">systemctl restart zabbix_agentd.service</span>
</pre></td></tr></table></figure></p>
<p>在zabbix web界面中配置主机中，点击【停用的】<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_11.png" alt=""><br>确定，启用主机<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_12.png" alt=""><br>这时状态已变为【启用】，但可用状态异常<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_16.png" alt=""><br>点击主机名<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_14.png" alt=""><br>将主机IP变更为实际的 -&gt; 更新<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_15.png" alt=""><br>重新刷新页面，稍等一会可用性状态正常了<br><img src="http://oligvdnzp.bkt.clouddn.com/0316_zabbix_17.png" alt=""></p>
<h2 id="监控MySQL实例状态"><a href="#监控MySQL实例状态" class="headerlink" title="监控MySQL实例状态"></a>监控MySQL实例状态</h2><blockquote>
<p><strong>监控思路：</strong><br>在要监控的MySQL服务器上安装zabbix agent，然后在zabbix主机web界面里配置要监控的MySQL服务器的信息，添加zabbix自带的Template App MySQL模版。</p>
</blockquote>
<h3 id="在监控的mysql服务器上安装并启动zabbix-agent"><a href="#在监控的mysql服务器上安装并启动zabbix-agent" class="headerlink" title="在监控的mysql服务器上安装并启动zabbix agent"></a>在监控的mysql服务器上安装并启动zabbix agent</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 系统环境</span></span>
<span class="line">yum -<span class="keyword">y</span> install gcc* make vim</span>
<span class="line">setenforce <span class="number">0</span></span>
<span class="line">systemctl stop firewalld.service</span>
<span class="line"></span>
<span class="line"><span class="comment"># 添加zabbix帐号</span></span>
<span class="line">groupadd zabbix</span>
<span class="line">useradd zabbix -g zabbix -<span class="keyword">s</span> /sbin/nologin</span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置hosts(非必须)</span></span>
<span class="line">vi /etc/hosts</span>
<span class="line">-----------------------------------------------</span>
<span class="line"><span class="number">10.245</span>.<span class="number">231.201</span> mysql</span>
<span class="line"><span class="number">10.245</span>.<span class="number">231.202</span> zabbix</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 上传rpm包到/tmp目录后开始安装</span></span>
<span class="line">rpm -ivh zabbix-agent-<span class="number">3.2</span>.<span class="number">4</span>-<span class="number">1</span>.el6.x86_64.rpm</span>
<span class="line"></span>
<span class="line"><span class="comment"># 也可以按以下步骤在解压后的源码目录编译安装</span></span>
<span class="line">./configure --enable-agent</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line">cp misc/init.d/fedora/core/zabbix_agentd /etc/init.d/zabbix_agentd</span>
<span class="line">chkconfig --add zabbix_agentd</span>
<span class="line">chkconfig zabbix_agentd on</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改agent配置文件(注意下面都是zabbix_agent rpm包安装后的目录，源码安装的话请注意修改)</span></span>
<span class="line">vi /etc/zabbix/zabbix_agentd.conf</span>
<span class="line">-----------------------------------------------</span>
<span class="line">Server=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">ServerActive=<span class="number">10.245</span>.<span class="number">231.202</span></span>
<span class="line">Hostname=zabbix</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动agent</span></span>
<span class="line">/usr/sbin/zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf</span>
</pre></td></tr></table></figure>
<h3 id="建立mysql-host-groups组"><a href="#建立mysql-host-groups组" class="headerlink" title="建立mysql host groups组"></a>建立mysql host groups组</h3><p>模板是zabbix系统提供的，进入zabbix web后台，Configuration–&gt;Hosts groups–&gt;点击Create host group–&gt;选择template选项卡，选择模板TemplateApp MySQL，Templdate OS Linux，Group name设置成Mysql_Servers，最后点击add<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_01.png" alt=""></p>
<h3 id="建立hosts"><a href="#建立hosts" class="headerlink" title="建立hosts"></a>建立hosts</h3><p>configuration–&gt;hosts–&gt;Create hosts，然后按图配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_02.png" alt=""><br>选择template选项卡–&gt;select–&gt;选择模板Template App MySQL,Templdate OS Linux，最后点击下边的Add按钮<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_03.png" alt=""><br>确认模板已添加，点Add按钮<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_04.png" alt=""><br>稍等一会，确保状态和可用性都正常<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_05.png" alt=""></p>
<h3 id="使用自带模板监控mysql"><a href="#使用自带模板监控mysql" class="headerlink" title="使用自带模板监控mysql"></a>使用自带模板监控mysql</h3><p>在监控的mysql服务器上给zabbix agent配置数据库账号<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">GRANT PROCESS,SUPER,REPLICATION CLIENT ON *.* TO zabbix@'<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="string">' IDENTIFIED BY '</span>zabbix123456<span class="string">';</span>
<span class="line">GRANT PROCESS,SUPER,REPLICATION CLIENT ON *.* TO zabbix@'</span>localhost<span class="string">' IDENTIFIED BY '</span>zabbix123456<span class="string">';</span></span>
</pre></td></tr></table></figure></p>
<p>创建/etc/zabbix/.my.cnf,并在里面写入mysql服务器的密码<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /etc/zabbix/.my.cnf</span>
<span class="line">-----------------------------------------------</span>
<span class="line">[mysql]</span>
<span class="line">user=zabbix</span>
<span class="line">password=zabbix123456</span>
<span class="line"></span>
<span class="line">[mysqladmin]</span>
<span class="line">user=zabbix</span>
<span class="line">password=zabbix123456</span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure></p>
<p>修改监控mysql相关的用户参数文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /etc/zabbix/zabbix_agentd.d/</span>
<span class="line">vi userparameter_mysql.conf</span>
<span class="line"><span class="comment"># 修改以下方面：</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">HOME=<span class="regexp">/var/lib</span><span class="regexp">/zabbix    替换成     HOME=/etc</span><span class="regexp">/zabbix</span>
<span class="line">mysql                   补全路径   /u</span>01/mysql/bin/mysql</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启zabbix agent</span></span>
<span class="line">ps -ef | <span class="keyword">grep</span> <span class="string">'zabbix_agentd'</span> | <span class="keyword">grep</span> -v <span class="keyword">grep</span> | awk <span class="string">'&#123;print $2&#125;'</span> | xargs <span class="keyword">kill</span> -<span class="number">9</span></span>
<span class="line">/usr/sbin/zabbix_agentd -c /etc/zabbix/zabbix_agentd.conf</span>
</pre></td></tr></table></figure></p>
<p>然后在zabbix-server服务器上测试是否可以获取到mysql的status信息<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/zabbix/bin/</span>
<span class="line">./zabbix_get -<span class="keyword">s</span> <span class="number">10.245</span>.<span class="number">231.201</span> -p1005<span class="number">0</span> -k mysql.ping</span>
<span class="line"><span class="number">1</span></span>
<span class="line"></span>
<span class="line">./zabbix_get -<span class="keyword">s</span> <span class="number">10.245</span>.<span class="number">231.201</span> -p1005<span class="number">0</span> -k mysql.version</span>
<span class="line">/u01/mysql/bin/mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.6</span>.<span class="number">35</span>, <span class="keyword">for</span> Linux (x86_64) using  EditLine wrapper</span>
<span class="line"></span>
<span class="line">./zabbix_get -<span class="keyword">s</span> <span class="number">10.245</span>.<span class="number">231.201</span> -p1005<span class="number">0</span> -k mysql.status[Com_insert]</span>
<span class="line"><span class="number">3</span></span>
</pre></td></tr></table></figure></p>
<p>zabbix自带的mysql模板共可监测以下14项<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_06.png" alt=""><br>按下图可以查看监控mysql的情况，也可以图形化显示<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_07.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_08.png" alt=""></p>
<h3 id="自定义zabbix模板监控mysql"><a href="#自定义zabbix模板监控mysql" class="headerlink" title="自定义zabbix模板监控mysql"></a>自定义zabbix模板监控mysql</h3><p>点击Configuration–&gt;Templates–&gt;create template，参照下图中配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_09.png" alt=""><br>点Applications–&gt;Create Applications<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_10.png" alt=""><br>输入监控的应用名称Mysql<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_11.png" alt=""><br>添加成功，点【Items】，然后点击左上的【Create Items】<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_12.png" alt=""><br>按下图所示填写后点下方add<br><img src="http://oligvdnzp.bkt.clouddn.com/0317_zabbix_mysql_13.png" alt=""><br>创建监控脚本文件并参数文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> /etc/zabbix/scripts</span>
<span class="line">vi /etc/zabbix/scripts/check_mysql_status_3306.sh</span>
<span class="line">-----------------------------------------------</span>
<span class="line"><span class="comment">#!/bin/bash</span></span>
<span class="line">host=localhost</span>
<span class="line">username=zabbix</span>
<span class="line">password=zabbix</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">CHECK_TIME=<span class="number">3</span></span>
<span class="line"><span class="comment">#mysql  is working MYSQL_IS_OK is 1 , mysql down MYSQL_IS_OK is 0</span></span>
<span class="line">MYSQL_IS_OK=<span class="number">1</span></span>
<span class="line">function check_mysql_status ()&#123;</span>
<span class="line">    $MYSQL -u$username -p<span class="string">"$password"</span> -P$port -e <span class="string">"select user();"</span> &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span>
<span class="line">    <span class="keyword">if</span> [ $? = <span class="number">0</span> ] ;then</span>
<span class="line">    MYSQL_IS_OK=<span class="number">1</span></span>
<span class="line">    <span class="keyword">else</span></span>
<span class="line">    MYSQL_IS_OK=<span class="number">0</span></span>
<span class="line">    fi</span>
<span class="line">    <span class="keyword">return</span> $MYSQL_IS_OK </span>
<span class="line">&#125;</span>
<span class="line"><span class="keyword">while</span> [ $CHECK_TIME -<span class="keyword">ne</span> <span class="number">0</span> ]</span>
<span class="line"><span class="keyword">do</span></span>
<span class="line">    let <span class="string">"CHECK_TIME -= 1"</span></span>
<span class="line">    </span>
<span class="line">    check_mysql_status</span>
<span class="line"><span class="keyword">if</span> [ $MYSQL_IS_OK = <span class="number">1</span> ] ; then</span>
<span class="line">    CHECK_TIME=<span class="number">0</span></span>
<span class="line">    echo <span class="number">0</span></span>
<span class="line">    <span class="keyword">exit</span> <span class="number">0</span></span>
<span class="line">fi</span>
<span class="line"><span class="keyword">if</span> [ $MYSQL_IS_OK -eq <span class="number">0</span> ] &amp;&amp;  [ $CHECK_TIME -eq <span class="number">0</span> ]</span>
<span class="line">then</span>
<span class="line">    echo <span class="number">1</span></span>
<span class="line">    <span class="keyword">exit</span> <span class="number">1</span></span>
<span class="line">fi</span>
<span class="line"><span class="keyword">sleep</span> <span class="number">3</span></span>
<span class="line">done</span>
<span class="line">-----------------------------------------------</span>
<span class="line"></span>
<span class="line"><span class="keyword">chmod</span> +<span class="keyword">x</span> /etc/zabbix/scripts/check_mysql_status_3306.sh</span>
<span class="line">cd /etc/zabbix/zabbix_agentd.d/</span>
<span class="line">vi userparameter_mysql.conf</span>
<span class="line"><span class="comment"># 添加以下内容</span></span>
<span class="line">-----------------------------------------------</span>
<span class="line">UserParameter=my3306.check_mysql_status,<span class="regexp">/etc/zabbix</span><span class="regexp">/scripts/check</span>_mysql_status_3306.sh</span>
<span class="line">-----------------------------------------------</span>
</pre></td></tr></table></figure></p>
<p>参考：<a href="http://www.iyunv.com/forum.php?mod=viewthread&amp;tid=351608&amp;highlight=zabbix" target="_blank" rel="external">Centos7.2下搭建Zabbix3.2</a> </p>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
            <tag> zabbix </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CentOS7.3安装图解]]></title>
      <url>/2017/03/18/linux/20170318_CentOS7.3%E5%AE%89%E8%A3%85%E5%9B%BE%E8%A7%A3/</url>
      <content type="html"><![CDATA[<p>光标向上移动，选择<code>Install CentOS Linux</code>不测试安装光盘，节省安装时间<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_01.png" alt=""><br>直接回车开始<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_02.png" alt=""><br><a id="more"></a><br>选择语言，这里我就使用英文<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_03.png" alt=""><br>这里是跟CentOS6.X区别比较大的地方，所有的配置项都集中在一起，可以根据需要进行配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_05.png" alt=""><br>点击<code>DATE&amp;TIME</code>配置时区和时间<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_04.png" alt=""><br><code>KEYBOARD</code>和<code>LANGUAGE SUPPORT</code>前面已经设置过了，点击<code>SOFTWARE SELECTION</code>，选择服务器部署的类型（即都安装哪些软件包），我这里默认选择<code>Minimal Install</code>，如果你需要安装图形化界面，可以选择<code>Server with GUI</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_06.png" alt=""><br>点击<code>INSTALLATION DESTINATION</code>配置硬盘分区<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_07.png" alt=""><br>手动配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_08.png" alt=""><br>选<code>Click here to create them automatically</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_09.png" alt=""><br>在自动创建的分区上按业务(测试)需要进行修改，无误后点左上方的<code>Done</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_10.png" alt=""><br>同意变更<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_11.png" alt=""><br>点击<code>NETWORK&amp;HOSTNAME</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_12.png" alt=""><br>可在此界面进行网络和主机名配置，这里我先默认，不配置<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_13.png" alt=""><br>完成后，回到之前的配置集中页面，点击下方的<code>Begin Installation</code>，开始安装<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_14.png" alt=""><br>在安装的过程中，点击<code>ROOT PASSWORD</code>配置root用户密码<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_15.png" alt=""><br>设置完root密码后点<code>Done</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_16.png" alt=""><br>红色警告已标志已清除，等待软件包安装完成<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_17.png" alt=""><br>安装完成后，点击<code>Reboot</code>会重启服务器<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_18.png" alt=""><br>进入到字符界面，完成安装<br><img src="http://oligvdnzp.bkt.clouddn.com/0314_centos7_3_install_19.png" alt=""></p>
]]></content>
      
        
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Centos </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-07 MySQL锁机制与事务机制实现]]></title>
      <url>/2017/03/10/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/07-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="MySQL参数autocommit生产环境设1还是0？为什么？"><a href="#MySQL参数autocommit生产环境设1还是0？为什么？" class="headerlink" title="MySQL参数autocommit生产环境设1还是0？为什么？"></a>MySQL参数autocommit生产环境设1还是0？为什么？</h2><p>MySQL参数autocommit生产环境设成0，即不自动提交。 设置成不自动提交，事务能做rollback，以满足事务的原子性Atomicity的要求，设置方法：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set autocommit=<span class="number">0</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 也可以修改my.cnf配置文件</span></span>
<span class="line">autocommit=<span class="number">0</span></span>
</pre></td></tr></table></figure></p>
<h2 id="MySQL参数tx-isolation生产环境上大多数是设什么值，为什么？"><a href="#MySQL参数tx-isolation生产环境上大多数是设什么值，为什么？" class="headerlink" title="MySQL参数tx_isolation生产环境上大多数是设什么值，为什么？"></a>MySQL参数tx_isolation生产环境上大多数是设什么值，为什么？</h2><p>MySQL参数<code>tx_isolation</code>生产环境上大多数是设成<code>READ-COMMITED</code>。事务的隔离级别设置为<code>READ-COMMITED</code>时不会发生脏读现象，虽会出现不可重复读和幻读问题，但不会对业务应用造成影响。而设置成以下隔离级别会出现的问题如下：</p>
<ul>
<li>Read Uncommitted：会产生脏读、不可重复读、幻读现象，而脏读这在生产环境中是不被允许的</li>
<li>Repeatable Read：不会出现不可重复读和幻读问题，但此特性一般不符合应用业务需要，且并发性能也不好。</li>
<li>Serializable：所有事务全部串行执行（只允许同时一个事务操作，若有其他事务，也需要等前一个事务完成后才能开始），不能并发执行，这在生产环境中是不现实的。</li>
</ul>
<a id="more"></a>
<h2 id="与MySQL锁相关的有哪些因素？"><a href="#与MySQL锁相关的有哪些因素？" class="headerlink" title="与MySQL锁相关的有哪些因素？"></a>与MySQL锁相关的有哪些因素？</h2><ol>
<li>有无主键</li>
<li>有无索引，是不是唯一索引</li>
<li>事务的隔离级别是什么</li>
<li>SQL语句的执行计划</li>
</ol>
<h2 id="课堂笔记"><a href="#课堂笔记" class="headerlink" title="课堂笔记"></a>课堂笔记</h2><h3 id="事务的概念"><a href="#事务的概念" class="headerlink" title="事务的概念"></a>事务的概念</h3><p>事务定义了一个服务操作的序列，由服务器保证这些操作序列在多个客户并发访问和服务器出现故障情况下的原子性。<br>事务概念最初是在数据库管理系统领域发展起来的，是一种对共享数据库进行并发访问或错误处理的范型。<br>A transcation consists of a collection of DML statements that form a logical unit of work.<br>DDL statements will implicitly commit any outstanding transcation.</p>
<h3 id="事务的属性-ACID"><a href="#事务的属性-ACID" class="headerlink" title="事务的属性 ACID"></a>事务的属性 ACID</h3><ul>
<li><code>Atomicity</code>: Changes made by a transaction to the database are atomic, “all or nothing”.  [Redo &amp; Undo]</li>
<li><code>Consistency</code>: The transaction changes the state of the base from one coherent state to a new coherent state (conforming to integrity constraints). [Undo]</li>
<li><code>Isolation</code>: The transaction is isolated from other transactions and appears to be the only user on the system even though it is executing with other concurrent transaction. [lock]</li>
<li><code>Durability</code>(Durable): The committed changes by a transaction are persistent, capable of surviving machine crashes. [Redo]</li>
</ul>
<h3 id="并发会存在问题"><a href="#并发会存在问题" class="headerlink" title="并发会存在问题"></a>并发会存在问题</h3><ul>
<li>dirty read 脏读</li>
<li>unrepeatable read 不可重复读</li>
<li>phantom read 幻读</li>
</ul>
<h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h3><ul>
<li>Read Uncommitted：会出现脏读、不可重复读、幻读(隔离级别最低，并发性能高) </li>
<li>Read Committed：会出现不可重复读、幻读问题（锁定正在读取的行），Oracle的默认隔离级别</li>
<li>Repeatable Read：会出幻读（锁定所读取的所有行），Mysql的默认隔离级别，在Mysql Innodb上设置此隔离级别幻读也不会产生</li>
<li>Serializable：保证所有的情况不会发生（锁表）</li>
</ul>
<h3 id="事务编程不好习惯"><a href="#事务编程不好习惯" class="headerlink" title="事务编程不好习惯"></a>事务编程不好习惯</h3><ul>
<li>在循环中提交：提交<code>commit</code>应尽量放到循环外</li>
<li>使用自动提交：不使用自动提交，<code>set autocommit=0</code></li>
<li>使用自动回滚：MSSQL中关闭自动回滚 </li>
<li>大事务：尽量拆成小事务</li>
</ul>
<h3 id="锁的概念"><a href="#锁的概念" class="headerlink" title="锁的概念"></a>锁的概念</h3><h4 id="什么是锁"><a href="#什么是锁" class="headerlink" title="什么是锁"></a>什么是锁</h4><p>锁用于在多个事务访问同一个对象时根据这些操作访问同一对象的先后次序给事务排序。</p>
<h4 id="不同数据库的锁实现"><a href="#不同数据库的锁实现" class="headerlink" title="不同数据库的锁实现"></a>不同数据库的锁实现</h4><ul>
<li>InooDB 行级锁</li>
<li>Oracle 行级锁</li>
<li>MyISAM 表锁</li>
<li>Microsoft SQL Server 行级锁、锁升级</li>
</ul>
<h4 id="Lock与Latch的区别"><a href="#Lock与Latch的区别" class="headerlink" title="Lock与Latch的区别"></a>Lock与Latch的区别</h4><ul>
<li>对象：事务/线程</li>
<li>保护：数据库对象/内存结构对象</li>
<li>持续时间：长/短</li>
<li>模式：表锁行锁/互斥</li>
<li>死锁：有/无</li>
</ul>
<h4 id="InnoDB存储引擎中锁"><a href="#InnoDB存储引擎中锁" class="headerlink" title="InnoDB存储引擎中锁"></a>InnoDB存储引擎中锁</h4><ul>
<li>表级<ul>
<li>IS 意向共享锁</li>
<li>IX 意向排它锁</li>
</ul>
</li>
<li>行级<ul>
<li>S 行级共享锁</li>
<li>X 行级排它锁</li>
</ul>
</li>
</ul>
<p>update更新一行时，会在要更新的表上加IX锁，并在更新的行上加X锁，这时如果并发有用户drop table，看到表上有IX锁，就会立即报错</p>
<h4 id="InnoDB-row-lock-行锁-范围"><a href="#InnoDB-row-lock-行锁-范围" class="headerlink" title="InnoDB row lock(行锁)范围"></a>InnoDB row lock(行锁)范围</h4><ul>
<li>Record lock：行记录锁</li>
<li>Gap lock：间隙锁，在索引记录间隙上的锁，或者是第一条索引记录之前、最后一条索引记录之后上的间隙锁，只有隔离级别为Repeatable Read的普通索引才有Gap lock</li>
<li>Next-key lock：下一键锁，索引记录锁以及索引记录之间的间隙锁，前二者的组合锁</li>
</ul>
<h4 id="测试Record-Lock"><a href="#测试Record-Lock" class="headerlink" title="测试Record Lock"></a>测试Record Lock</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建测试表</span></span>
<span class="line">create table t2(id <span class="keyword">int</span>, name varchar(<span class="number">10</span>),primary key(id),key(name));</span>
<span class="line">insert into t2 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'A'</span>),(<span class="number">3</span>,<span class="string">'A'</span>),(<span class="number">5</span>,<span class="string">'C'</span>),(<span class="number">7</span>,<span class="string">'G'</span>),(<span class="number">10</span>,<span class="string">'I'</span>);</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> id,name from t2;</span>
<span class="line">+----+------+</span>
<span class="line">| id | name |</span>
<span class="line">+----+------+</span>
<span class="line">|  <span class="number">1</span> | A    |</span>
<span class="line">|  <span class="number">3</span> | A    |</span>
<span class="line">|  <span class="number">5</span> | C    |</span>
<span class="line">|  <span class="number">7</span> | G    |</span>
<span class="line">| <span class="number">10</span> | I    |</span>
<span class="line">+----+------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 测试一</span></span>
<span class="line"><span class="comment"># session 1:</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where name=<span class="string">'C'</span> <span class="keyword">for</span> update;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2:</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where id=<span class="number">5</span> lock in share mode;</span>
<span class="line"></span>
<span class="line"><span class="comment">#这时session 2被阻塞，查看锁信息</span></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks;</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| lock_id      | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| <span class="number">14789</span>:<span class="number">19</span>:<span class="number">3</span>:<span class="number">4</span> | <span class="number">14789</span>       | S         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |         <span class="number">19</span> |         <span class="number">3</span> |        <span class="number">4</span> | <span class="number">5</span>         |</span>
<span class="line">| <span class="number">14788</span>:<span class="number">19</span>:<span class="number">3</span>:<span class="number">4</span> | <span class="number">14788</span>       | X         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |         <span class="number">19</span> |         <span class="number">3</span> |        <span class="number">4</span> | <span class="number">5</span>         |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 测试二</span></span>
<span class="line"><span class="comment"># session 1:</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where id=<span class="number">5</span> <span class="keyword">and</span> name=<span class="string">'C'</span> <span class="keyword">for</span> update;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2:</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where id=<span class="number">5</span> <span class="keyword">and</span> name=<span class="string">'B'</span> <span class="keyword">for</span> update;</span>
<span class="line"></span>
<span class="line"><span class="comment">#这时session 2被阻塞，查看锁信息</span></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks;</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| lock_id      | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| <span class="number">14793</span>:<span class="number">19</span>:<span class="number">3</span>:<span class="number">4</span> | <span class="number">14793</span>       | X         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |         <span class="number">19</span> |         <span class="number">3</span> |        <span class="number">4</span> | <span class="number">5</span>         |</span>
<span class="line">| <span class="number">14792</span>:<span class="number">19</span>:<span class="number">3</span>:<span class="number">4</span> | <span class="number">14792</span>       | X         | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | PRIMARY    |         <span class="number">19</span> |         <span class="number">3</span> |        <span class="number">4</span> | <span class="number">5</span>         |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
</pre></td></tr></table></figure>
<h4 id="测试GAP-LOCK"><a href="#测试GAP-LOCK" class="headerlink" title="测试GAP LOCK"></a>测试GAP LOCK</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 测试一</span></span>
<span class="line"><span class="comment"># session 1</span></span>
<span class="line">set tx_isolation=<span class="string">'repeatable-read'</span>;</span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t2 where name=<span class="string">'C'</span> <span class="keyword">for</span> update;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line">set tx_isolation=<span class="string">'repeatable-read'</span>;</span>
<span class="line">begin;</span>
<span class="line">insert into t2 <span class="keyword">values</span> (<span class="number">6</span>,<span class="string">'C'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment">#这时session 2被阻塞，查看锁信息以下几种方法：</span></span>
<span class="line">show engine innodb status\G;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks;</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| lock_id      | lock_trx_id | lock_mode | lock_type | lock_table | lock_index | lock_space | lock_page | lock_rec | lock_data |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line">| <span class="number">14814</span>:<span class="number">19</span>:<span class="number">4</span>:<span class="number">5</span> | <span class="number">14814</span>       | X,GAP     | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | name       |         <span class="number">19</span> |         <span class="number">4</span> |        <span class="number">5</span> | <span class="string">'G'</span>, <span class="number">7</span>    |</span>
<span class="line">| <span class="number">14813</span>:<span class="number">19</span>:<span class="number">4</span>:<span class="number">5</span> | <span class="number">14813</span>       | X,GAP     | RECORD    | <span class="string">`lyj`</span>.<span class="string">`t2`</span> | name       |         <span class="number">19</span> |         <span class="number">4</span> |        <span class="number">5</span> | <span class="string">'G'</span>, <span class="number">7</span>    |</span>
<span class="line">+--------------+-------------+-----------+-----------+------------+------------+------------+-----------+----------+-----------+</span>
<span class="line"></span>
<span class="line">SELECT</span>
<span class="line">    r.trx_id waiting_trx_id,</span>
<span class="line">    r.trx_mysql_thread_id waiting_thread,</span>
<span class="line">    r.trx_query waiting_query,</span>
<span class="line">    b.trx_id blocking_trx_id,</span>
<span class="line">    b.trx_mysql_thread_id blocking_thread,</span>
<span class="line">    b.trx_query blocking_query</span>
<span class="line">FROM </span>
<span class="line">    information_schema.innodb_lock_waits w</span>
<span class="line">INNER JOIN information_schema.innodb_trx b on b.trx_id=w.blocking_trx_id </span>
<span class="line">INNER JOIN information_schema.innodb_trx r on r.trx_id=w.requesting_trx_id;</span>
<span class="line">+----------------+----------------+-------------------------------+-----------------+-----------------+----------------+</span>
<span class="line">| waiting_trx_id | waiting_thread | waiting_query                 | blocking_trx_id | blocking_thread | blocking_query |</span>
<span class="line">+----------------+----------------+-------------------------------+-----------------+-----------------+----------------+</span>
<span class="line">| <span class="number">14819</span>          |             <span class="number">30</span> | insert into t2 <span class="keyword">values</span> (<span class="number">6</span>,<span class="string">'C'</span>) | <span class="number">14813</span>           |              <span class="number">32</span> | NULL           |</span>
<span class="line">+----------------+----------------+-------------------------------+-----------------+-----------------+----------------+</span>
<span class="line"></span>
<span class="line">SELECT    </span>
<span class="line">        p2.<span class="string">`HOST`</span> Blockedhost,</span>
<span class="line">p2.<span class="string">`USER`</span> BlockedUser,</span>
<span class="line">r.trx_id BlockedTrxId,    </span>
<span class="line">        r.trx_mysql_thread_id BlockedThreadId,    </span>
<span class="line">        TIMESTAMPDIFF(    </span>
<span class="line">            SECOND,    </span>
<span class="line">            r.trx_wait_started,    </span>
<span class="line">            CURRENT_TIMESTAMP    </span>
<span class="line">        ) WaitTime,    </span>
<span class="line">        r.trx_query BlockedQuery,    </span>
<span class="line">        l.lock_table BlockedTable,  </span>
<span class="line">        m.<span class="string">`lock_mode`</span> BlockedLockMode,</span>
<span class="line">        m.<span class="string">`lock_type`</span> BlockedLockType,</span>
<span class="line">        m.<span class="string">`lock_index`</span> BlockedLockIndex,</span>
<span class="line">        m.<span class="string">`lock_space`</span> BlockedLockSpace,</span>
<span class="line">        m.lock_page BlockedLockPage,</span>
<span class="line">        m.lock_rec BlockedLockRec,</span>
<span class="line">        m.lock_data BlockedLockData, </span>
<span class="line">        p.<span class="string">`HOST`</span> blocking_host, </span>
<span class="line">        p.<span class="string">`USER`</span> blocking_user,</span>
<span class="line">        b.trx_id BlockingTrxid,    </span>
<span class="line">        b.trx_mysql_thread_id BlockingThreadId,</span>
<span class="line">        b.trx_query BlockingQuery,</span>
<span class="line">        l.<span class="string">`lock_mode`</span> BlockingLockMode,</span>
<span class="line">        l.<span class="string">`lock_type`</span> BlockingLockType,</span>
<span class="line">        l.<span class="string">`lock_index`</span> BlockingLockIndex,</span>
<span class="line">        l.<span class="string">`lock_space`</span> BlockingLockSpace,</span>
<span class="line">        l.lock_page BlockingLockPage,</span>
<span class="line">        l.lock_rec BlockingLockRec,</span>
<span class="line">        l.lock_data BlockingLockData,         </span>
<span class="line">       IF (p.COMMAND = <span class="string">'Sleep'</span>, CONCAT(p.TIME,<span class="string">' seconds'</span>), <span class="number">0</span>) idel_in_trx             </span>
<span class="line">    FROM    </span>
<span class="line">        information_schema.INNODB_LOCK_WAITS w    </span>
<span class="line">    INNER JOIN information_schema.INNODB_TRX b ON b.trx_id = w.blocking_trx_id    </span>
<span class="line">    INNER JOIN information_schema.INNODB_TRX r ON r.trx_id = w.requesting_trx_id    </span>
<span class="line">    INNER JOIN information_schema.INNODB_LOCKS l ON w.blocking_lock_id = l.lock_id  AND l.<span class="string">`lock_trx_id`</span>=b.<span class="string">`trx_id`</span></span>
<span class="line">      INNER JOIN information_schema.INNODB_LOCKS <span class="keyword">m</span> ON m.<span class="string">`lock_id`</span>=w.<span class="string">`requested_lock_id`</span> AND m.<span class="string">`lock_trx_id`</span>=r.<span class="string">`trx_id`</span></span>
<span class="line">    INNER JOIN information_schema. PROCESSLIST p ON p.ID = b.trx_mysql_thread_id   </span>
<span class="line"> INNER JOIN information_schema. PROCESSLIST p2 ON p2.ID = r.trx_mysql_thread_id </span>
<span class="line">    ORDER BY    </span>
<span class="line">        WaitTime DESC \G;</span>
</pre></td></tr></table></figure>
<h4 id="分析一条SQL会加哪些锁"><a href="#分析一条SQL会加哪些锁" class="headerlink" title="分析一条SQL会加哪些锁"></a>分析一条SQL会加哪些锁</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set tx_isolation=<span class="string">'repeatable-read'</span>;</span>
<span class="line"></span>
<span class="line">create table t4 (</span>
<span class="line">  id <span class="keyword">int</span>(<span class="number">11</span>) <span class="keyword">not</span> null default <span class="string">'0'</span>,</span>
<span class="line">  user_id <span class="keyword">int</span>(<span class="number">11</span>) default null,</span>
<span class="line">  user_name varchar(<span class="number">10</span>) default null,</span>
<span class="line">  create_time varchar(<span class="number">10</span>) default null,</span>
<span class="line">  address varchar(<span class="number">10</span>) default null,</span>
<span class="line">  primary key (id),</span>
<span class="line">  key idx_time_name (create_time,user_name)</span>
<span class="line">);</span>
<span class="line"></span>
<span class="line">insert into t4 <span class="keyword">values</span> </span>
<span class="line">    (<span class="number">1</span>,<span class="number">101</span>,<span class="string">'tom'</span>,<span class="string">'20161010'</span>,<span class="string">''</span>),</span>
<span class="line">    (<span class="number">4</span>,<span class="number">104</span>,<span class="string">'joe'</span>,<span class="string">'20160305'</span>,<span class="string">''</span>),</span>
<span class="line">    (<span class="number">6</span>,<span class="number">106</span>,<span class="string">'tom'</span>,<span class="string">'20161231'</span>,<span class="string">''</span>),</span>
<span class="line">    (<span class="number">8</span>,<span class="number">108</span>,<span class="string">'tom'</span>,<span class="string">'20160515'</span>,<span class="string">'sh'</span>),</span>
<span class="line">    (<span class="number">10</span>,<span class="number">110</span>,<span class="string">'tom'</span>,<span class="string">'20160101'</span>,<span class="string">''</span>),</span>
<span class="line">    (<span class="number">100</span>,<span class="number">200</span>,<span class="string">'jack'</span>,<span class="string">'20161120'</span>,<span class="string">''</span>);</span>
<span class="line"></span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from t4</span>
<span class="line">  where create_time&gt;<span class="string">'20160101'</span></span>
<span class="line">  <span class="keyword">and</span> create_time&lt;<span class="string">'20161120'</span></span>
<span class="line">  <span class="keyword">and</span> user_name=<span class="string">'tom'</span></span>
<span class="line">  <span class="keyword">and</span> address!=<span class="string">''</span> <span class="keyword">for</span> update;</span>
</pre></td></tr></table></figure>
<p>下图为执行上面SQL语句后会加哪些锁的图示<br><img src="http://oligvdnzp.bkt.clouddn.com/0310_sql_lock.png" alt="SQL会加哪些锁"></p>
<h3 id="MDL锁"><a href="#MDL锁" class="headerlink" title="MDL锁"></a>MDL锁</h3><p>Mysql5.5版本引入了MDL锁(metadata lock)，用于解决或者保证DDL操作与DML操作之间的一致性。<br>在mysqldump的时候不能做DDL操作，会提示<code>wailing for table metadata lock</code>；在做DDL操作没办法保护事务，因此引入了<code>meta data lock</code>。</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># session 1</span></span>
<span class="line">begin;</span>
<span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line">drop table t1;</span>
<span class="line"></span>
<span class="line"><span class="comment">#这时session 2被阻塞，可以通过以下命令查看状态</span></span>
<span class="line">show processlist;</span>
<span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------+</span>
<span class="line">| Id | User | Host      | db   | Command | Time | State                           | Info             |</span>
<span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------+</span>
<span class="line">| <span class="number">38</span> | root | localhost | lyj  | Sleep   |  <span class="number">155</span> |                                 | NULL             |</span>
<span class="line">| <span class="number">39</span> | root | localhost | lyj  | Query   |  <span class="number">115</span> | Waiting <span class="keyword">for</span> table metadata lock | drop table t1    | <span class="comment"># 这个就是meta data lock</span></span>
<span class="line">| <span class="number">40</span> | root | localhost | NULL | Query   |    <span class="number">0</span> | init                            | show processlist |</span>
<span class="line">+----+------+-----------+------+---------+------+---------------------------------+------------------+</span>
</pre></td></tr></table></figure>
<p>解决meta data lock的策略：</p>
<ul>
<li>解决DDL高并发</li>
<li>线上DB不要轻易做alter table</li>
<li>干掉DDL会话<code>show processlist;</code> <code>kill id;</code></li>
</ul>
<h3 id="死锁的原理与分析"><a href="#死锁的原理与分析" class="headerlink" title="死锁的原理与分析"></a>死锁的原理与分析</h3><ol>
<li>产生回路<br>两个或两个以上的事务执行过程中，分别持有一把锁，然后加另一把锁（AB-BA），产生死锁。</li>
<li>加锁顺序不一致<br>两个或两个以上的事务并发执行（同一时刻），因争夺锁资源而造成的一种互相等待，产生死锁。</li>
</ol>
<h4 id="场景：产生回路导致死锁测试"><a href="#场景：产生回路导致死锁测试" class="headerlink" title="场景：产生回路导致死锁测试"></a>场景：产生回路导致死锁测试</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | aaaaa |</span>
<span class="line">|    <span class="number">2</span> | aaaaa |</span>
<span class="line">|    <span class="number">3</span> | cccc  |</span>
<span class="line">|    <span class="number">5</span> | eeeee |</span>
<span class="line">+------+-------+</span>
<span class="line"><span class="comment"># session 1</span></span>
<span class="line">begin;</span>
<span class="line">update t1 set name=<span class="string">'AAAAA'</span> where id=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line">begin;</span>
<span class="line">update t1 set name=<span class="string">'BBBBB'</span> where id=<span class="number">2</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 1</span></span>
<span class="line">update t1 set name=<span class="string">'CCCCC'</span> where id=<span class="number">2</span>;   <span class="comment"># 这时操作会被阻塞</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line">begin;</span>
<span class="line">update t1 set name=<span class="string">'DDDDD'</span> where id=<span class="number">1</span>;</span>
<span class="line">ERROR <span class="number">1213</span> (<span class="number">40001</span>): Deadlock found <span class="keyword">when</span> trying to get lock; try restarting transaction</span>
<span class="line"><span class="comment"># 这时session 2会报死锁错误，操作被rollback; 而session 1的事务阻塞解除，</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># session 1</span></span>
<span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | AAAAA |</span>
<span class="line">|    <span class="number">2</span> | CCCCC |</span>
<span class="line">|    <span class="number">3</span> | cccc  |</span>
<span class="line">|    <span class="number">5</span> | eeeee |</span>
<span class="line">+------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># session 2</span></span>
<span class="line"><span class="keyword">select</span> * from t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | aaaaa |</span>
<span class="line">|    <span class="number">2</span> | aaaaa |</span>
<span class="line">|    <span class="number">3</span> | cccc  |</span>
<span class="line">|    <span class="number">5</span> | eeeee |</span>
<span class="line">+------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 可以通过以下命令查看最后一次死锁解撤的信息：</span></span>
<span class="line">show engine innodb status\G;</span>
<span class="line">------------------------</span>
<span class="line">LATEST DETECTED DEADLOCK</span>
<span class="line">------------------------</span>
<span class="line"><span class="number">2017</span>-<span class="number">03</span>-<span class="number">10</span> <span class="number">14</span>:<span class="number">47</span>:<span class="number">38</span> <span class="number">7</span>f150d11a70<span class="number">0</span></span>
<span class="line">*** (<span class="number">1</span>) TRANSACTION:</span>
<span class="line">TRANSACTION <span class="number">14866</span>, ACTIVE <span class="number">63</span> sec fetching rows</span>
<span class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></span>
<span class="line">LOCK WAIT <span class="number">3</span> lock struct(<span class="keyword">s</span>), heap size <span class="number">1184</span>, <span class="number">2</span> row lock(<span class="keyword">s</span>), undo <span class="keyword">log</span> entries <span class="number">1</span></span>
<span class="line">MySQL thread id <span class="number">38</span>, OS thread handle <span class="number">0x7f150d0d9700</span>, query id <span class="number">1579</span> localhost root updating</span>
<span class="line">update t1 set name=<span class="string">'CCCCC'</span> where id=<span class="number">2</span></span>
<span class="line">*** (<span class="number">1</span>) WAITING FOR THIS LOCK TO BE GRANTED:</span>
<span class="line">RECORD LOCKS space id <span class="number">18</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">80</span> <span class="keyword">index</span> <span class="string">`GEN_CLUST_INDEX`</span> of table <span class="string">`lyj`</span>.<span class="string">`t1`</span> trx id <span class="number">14866</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span>
<span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">8</span> PHYSICAL RECORD: n_fields <span class="number">5</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></span>
<span class="line"> <span class="number">0</span>: len <span class="number">6</span>; <span class="keyword">hex</span> <span class="number">000000501013</span>; asc    P  ;;</span>
<span class="line"> <span class="number">1</span>: len <span class="number">6</span>; <span class="keyword">hex</span> <span class="number">000000003</span>a13; asc     : ;;</span>
<span class="line"> <span class="number">2</span>: len <span class="number">7</span>; <span class="keyword">hex</span> <span class="number">3</span>c0000093b011<span class="number">0</span>; asc &lt;   ;  ;;</span>
<span class="line"> <span class="number">3</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000002</span>; asc     ;;</span>
<span class="line"> <span class="number">4</span>: len <span class="number">5</span>; <span class="keyword">hex</span> <span class="number">4242424242</span>; asc BBBBB;;</span>
<span class="line">......</span>
<span class="line"></span>
<span class="line"><span class="comment"># innodb_print_all_deadlocks设置为ON时，会把死锁的信息记录到错误日志里</span></span>
<span class="line">show variables like <span class="string">'%dead%'</span>;</span>
<span class="line">+----------------------------+-------+</span>
<span class="line">| Variable_name              | Value |</span>
<span class="line">+----------------------------+-------+</span>
<span class="line">| innodb_print_all_deadlocks | OFF   |</span>
<span class="line">+----------------------------+-------+</span>
<span class="line"></span>
<span class="line">set global innodb_print_all_deadlocks=<span class="string">'ON'</span>;</span>
</pre></td></tr></table></figure>
<h3 id="减少Innodb死锁的方法"><a href="#减少Innodb死锁的方法" class="headerlink" title="减少Innodb死锁的方法"></a>减少Innodb死锁的方法</h3><ul>
<li>超时设置（参数<code>innodb_lock_wait_timout</code>)</li>
<li>尽快提交事务，小事务不容易发生死锁</li>
<li>加<code>FOR UPDATE</code>、<code>LOCK IN SHARE NODE</code>读锁时，最好<code>降低</code>事务隔离级别，例如用RC级别，降低死锁发生概率</li>
<li>事务中涉及多个表，或者涉及多行记录时，每个事务的操作顺序都要保持一致，降低死锁概率，最好用存储过程/存储函数固化</li>
<li>通过索引等方式优化SQL效率，降低死锁发生概率（减少扫描/锁范围，降低概率）</li>
</ul>
<h3 id="查找锁常用命令"><a href="#查找锁常用命令" class="headerlink" title="查找锁常用命令"></a>查找锁常用命令</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#查看innodb引擎</span></span>
<span class="line">show engine innodb status\G;</span>
<span class="line"></span>
<span class="line"><span class="comment">#查看锁</span></span>
<span class="line">SELECT</span>
<span class="line">    r.trx_id waiting_trx_id,</span>
<span class="line">    r.trx_mysql_thread_id waiting_thread,</span>
<span class="line">    r.trx_query waiting_query,</span>
<span class="line">    b.trx_id blocking_trx_id,</span>
<span class="line">    b.trx_mysql_thread_id blocking_thread,</span>
<span class="line">    b.trx_query blocking_query</span>
<span class="line">FROM information_schema.innodb_lock_waits w</span>
<span class="line">INNER JOIN information_schema.innodb_trx b</span>
<span class="line">ON b.trx_id= w.blocking_trx_id</span>
<span class="line">INNER JOIN information_schema.innodb_trx r</span>
<span class="line">ON r.trx_id= w.requesting_trx_id;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_trx\G;</span>
<span class="line"><span class="comment"># 表中几个最常用的字段：</span></span>
<span class="line">trx_id: InnoDB存储引擎内部唯一的事务ID</span>
<span class="line">trx_state: 当前事务的状态</span>
<span class="line">trx_started: 事务的开始时间</span>
<span class="line">trx_wait_started: 事务等待开始的时间</span>
<span class="line">trx_mysql_thread_id: Mysql中的线程ID,SHOW PROCESSLIST显示的结果</span>
<span class="line">trx_query: 事务运行的sql语句</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_locks\G;</span>
<span class="line"><span class="comment"># 表中几个最常用的字段：</span></span>
<span class="line">lock_id: 锁的ID</span>
<span class="line">lock_trx_id: 事务ID</span>
<span class="line">lock_mode: 锁的模式</span>
<span class="line">lock_type: 锁的类型，表锁还是行锁</span>
<span class="line">lock_table: 要加锁的表</span>
<span class="line">lock_index: 锁的索引</span>
<span class="line">lock_space: InnoDB存储引擎表空间的ID号</span>
<span class="line">lock_page: 被锁住的页的数量。若是表锁，则该值为NULL</span>
<span class="line">lock_rec: 被锁住的行的数量。若是表锁，则该值为NULL</span>
<span class="line">lock_data: 被锁住的行的主键值。当是表锁时，该值为NULL</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_lock_waits\G;</span>
<span class="line"><span class="comment"># 表中几个最常用的字段：</span></span>
<span class="line">requesting_trx_id: 申请锁资源的事务ID</span>
<span class="line">requesting_lock_id: 申请的锁的ID</span>
<span class="line">blocking_trx_id: 阻塞的锁的ID</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-06 深入浅出MySQL备份与恢复]]></title>
      <url>/2017/03/06/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/06-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="使用mydumper工具全库备份"><a href="#使用mydumper工具全库备份" class="headerlink" title="使用mydumper工具全库备份"></a>使用mydumper工具全库备份</h2><blockquote>
<p>mydumper是针对mysql数据库备份的一个轻量级第三方的开源工具，备份方式采用逻辑备份。<br>mydumper支持多线程，备份速度远高于原生态的mysqldump。</p>
</blockquote>
<h3 id="下载mydumper"><a href="#下载mydumper" class="headerlink" title="下载mydumper"></a>下载mydumper</h3><p>下载地址：<a href="https://launchpad.net/mydumper" target="_blank" rel="external">https://launchpad.net/mydumper </a><br><a id="more"></a></p>
<h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装编译所需的依赖包(参照：https://answers.launchpad.net/mydumper/+faq/349)</span></span>
<span class="line">yum install -<span class="keyword">y</span> glib2-devel mysql-devel zlib-devel pcre-devel</span>
<span class="line"></span>
<span class="line"><span class="comment"># 将下载的mydumper-0.9.1.tar.gz上传到服务器/tmp目录下，root用户执行以下命令</span></span>
<span class="line">cd /tmp</span>
<span class="line">tar -xvpf mydumper-<span class="number">0</span>.<span class="number">9.1</span>.tar.gz</span>
<span class="line">cd mydumper-<span class="number">0</span>.<span class="number">9.1</span></span>
<span class="line">cmake .</span>
<span class="line">make &amp;&amp; make install</span>
<span class="line"><span class="comment"># ------------------------------------------------------------------------------------------</span></span>
<span class="line">Scanning dependencies of target mydumper</span>
<span class="line">[ <span class="number">25</span>%] Building C object CMakeFiles/mydumper.dir/mydumper.c.o</span>
<span class="line">[ <span class="number">50</span>%] Building C object CMakeFiles/mydumper.dir/server_detect.c.o</span>
<span class="line">[ <span class="number">75</span>%] Building C object CMakeFiles/mydumper.dir/g_unix_signal.c.o</span>
<span class="line">Linking C executable mydumper</span>
<span class="line">[ <span class="number">75</span>%] Built target mydumper</span>
<span class="line">Scanning dependencies of target myloader</span>
<span class="line">[<span class="number">100</span>%] Building C object CMakeFiles/myloader.dir/myloader.c.o</span>
<span class="line">Linking C executable myloader</span>
<span class="line">[<span class="number">100</span>%] Built target myloader</span>
<span class="line">[ <span class="number">75</span>%] Built target mydumper</span>
<span class="line">[<span class="number">100</span>%] Built target myloader</span>
<span class="line">Install the project...</span>
<span class="line">-- Install configuration: <span class="string">""</span></span>
<span class="line">-- Installing: <span class="regexp">/usr/local</span><span class="regexp">/bin/mydumper</span></span>
<span class="line">-- Removed runtime path from <span class="string">"/usr/local/bin/mydumper"</span></span>
<span class="line">-- Installing: <span class="regexp">/usr/local</span><span class="regexp">/bin/myloader</span></span>
<span class="line">-- Removed runtime path from <span class="string">"/usr/local/bin/myloader"</span></span>
<span class="line"><span class="comment"># ------------------------------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="使用mydumper备份全库"><a href="#使用mydumper备份全库" class="headerlink" title="使用mydumper备份全库"></a>使用mydumper备份全库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/backup</span>
<span class="line"></span>
<span class="line">mydumper \</span>
<span class="line">    --user=root \</span>
<span class="line">    --password=<span class="string">''</span> \</span>
<span class="line">    --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock \</span>
<span class="line">    --regex <span class="string">'^(?!(mysql))'</span> \</span>
<span class="line">    --outputdir=<span class="regexp">/u01/backup</span><span class="regexp">/ \</span>
<span class="line">    --compress \</span>
<span class="line">    --verbose=3 \</span>
<span class="line">    --logfile=/u</span>01/backup/mydumper.log</span>
<span class="line"><span class="comment"># --regex '^(?!(mysql))' 这个正则表达式的意思是除了mysql数据库，其他数据库都备份</span></span>
</pre></td></tr></table></figure>
<p>查看备份结果<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/backup/</span>
<span class="line">ll</span>
<span class="line">total <span class="number">20</span></span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql  <span class="number">84</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> jfedu-schema-create.sql.gz</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql <span class="number">174</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> jfedu.t1-schema.sql.gz</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql <span class="number">153</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> jfedu.t1.sql.gz</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql <span class="number">134</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> metadata</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql <span class="number">969</span> Feb <span class="number">28</span> <span class="number">16</span>:<span class="number">43</span> mydumper.log</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备份日志，可以看出备份开启了多线程</span></span>
<span class="line">vi mydumper.log </span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Connected to a MySQL server</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Started <span class="keyword">dump</span> at: <span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span></span>
<span class="line"></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Written master status</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">1</span> connected using MySQL connection ID <span class="number">20</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">2</span> connected using MySQL connection ID <span class="number">21</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">3</span> connected using MySQL connection ID <span class="number">22</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">4</span> connected using MySQL connection ID <span class="number">23</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Non-InnoDB <span class="keyword">dump</span> complete, unlocking tables</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">1</span> dumping data <span class="keyword">for</span> <span class="string">`jfedu`</span>.<span class="string">`t1`</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">2</span> dumping schema <span class="keyword">for</span> <span class="string">`jfedu`</span>.<span class="string">`t1`</span></span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">3</span> shutting down</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">4</span> shutting down</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">1</span> shutting down</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Thread <span class="number">2</span> shutting down</span>
<span class="line"><span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span> [INFO] - Finished <span class="keyword">dump</span> at: <span class="number">2017</span>-<span class="number">02</span>-<span class="number">28</span> <span class="number">16</span>:<span class="number">43</span>:<span class="number">47</span></span>
</pre></td></tr></table></figure></p>
<h2 id="误操作truncate-table-gyj-t1-利用mysqldump的备份和binlog日志对表gyj-t1做完全恢复。"><a href="#误操作truncate-table-gyj-t1-利用mysqldump的备份和binlog日志对表gyj-t1做完全恢复。" class="headerlink" title="误操作truncate table gyj_t1;利用mysqldump的备份和binlog日志对表gyj_t1做完全恢复。"></a>误操作truncate table gyj_t1;利用mysqldump的备份和binlog日志对表gyj_t1做完全恢复。</h2><h3 id="测试场景构建"><a href="#测试场景构建" class="headerlink" title="测试场景构建"></a>测试场景构建</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> jfedu;</span>
<span class="line">create table gyj_t1(id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">insert into gyj_t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'AAAAA'</span>);</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure>
<h3 id="使用mysqldump全库备份"><a href="#使用mysqldump全库备份" class="headerlink" title="使用mysqldump全库备份"></a>使用mysqldump全库备份</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> --single-transaction --master-data=<span class="number">2</span> -P3306 -A &gt; <span class="regexp">/tmp/all</span>_database_20170302.sql</span>
</pre></td></tr></table></figure>
<h3 id="备份后DML操作再truncate"><a href="#备份后DML操作再truncate" class="headerlink" title="备份后DML操作再truncate"></a>备份后DML操作再truncate</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">insert into gyj_t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'BBBBBB'</span>);</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">truncate</span> table gyj_t1;</span>
</pre></td></tr></table></figure>
<h3 id="完全恢复表并验证数据"><a href="#完全恢复表并验证数据" class="headerlink" title="完全恢复表并验证数据"></a>完全恢复表并验证数据</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从备份文件中找出需要恢复表的建表语句：</span></span>
<span class="line">cat /tmp/all_database_20170302.sql | sed -e <span class="string">'/./&#123;H;$!d;&#125;'</span> -e <span class="string">'x;/CREATE TABLE `gyj_t1`/!d;q'</span> </span>
<span class="line"></span>
<span class="line"><span class="comment"># 从备份文件中找出需要恢复表的数据</span></span>
<span class="line">cat /tmp/all_database_20170302.sql | <span class="keyword">grep</span> --ignore-case  <span class="string">'insert into `gyj_t1`'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 恢复之前需要确认是否设置自动提交，若不是恢复前先执行以下命令修改</span></span>
<span class="line">set autocommit=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 因为是truncate表，表结构不需要恢复，只需要恢复数据即可</span></span>
<span class="line">cat /tmp/all_database_20170302.sql | <span class="keyword">grep</span> --ignore-case  <span class="string">'insert into `gyj_t1`'</span> | mysql -uroot -p jfedu</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看恢复的数据</span></span>
<span class="line"><span class="keyword">select</span> * from gyj_t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | AAAAA |</span>
<span class="line">+------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备份时binlog位置</span></span>
<span class="line"><span class="keyword">grep</span> MASTER /tmp/all_database_20170302.sql</span>
<span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'binlog.000030'</span>, MASTER_LOG_POS=<span class="number">1957</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 找出误操作语句的位置</span></span>
<span class="line">mysql --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock -e <span class="string">"show binlog events in 'binlog.000030'"</span> |<span class="keyword">grep</span> -i <span class="keyword">truncate</span></span>
<span class="line">binlog.<span class="number">000030</span>   <span class="number">2161</span>    Query   <span class="number">101</span>     <span class="number">2250</span>    <span class="keyword">use</span> <span class="string">`jfedu`</span>; <span class="keyword">truncate</span> table gyj_t1</span>
<span class="line"></span>
<span class="line"><span class="comment"># 用mysqlbinlog命令在binlog中找出相关记录</span></span>
<span class="line">mysqlbinlog -v --base64-output=decode-rows /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog.<span class="number">000030</span> &gt; <span class="regexp">/tmp/</span><span class="number">30</span>.sql</span>
<span class="line">vi /tmp/<span class="number">30</span>.sql</span>
<span class="line"><span class="comment"># ------------------------------------------------------------------------------------------</span></span>
<span class="line">......</span>
<span class="line"><span class="comment">#170302 13:46:20 server id 101  end_log_pos 1957 CRC32 0xfb6ea7a5       Xid = 512</span></span>
<span class="line">COMMIT/*!*<span class="regexp">/;</span>
<span class="line"># at 1957</span>
<span class="line">#170302 13:49:53 server id 101  end_log_pos 2030 CRC32 0x27b2b661       Query   thread_id=4     exec_time=0     error_code=0</span>
<span class="line">SET TIMESTAMP=1488433793/</span>*!*<span class="regexp">/;</span>
<span class="line">SET @@session.sql_mode=1073741824/</span>*!*<span class="regexp">/;</span>
<span class="line">BEGIN</span>
<span class="line">/</span>*!*<span class="regexp">/;</span>
<span class="line"># at 2030</span>
<span class="line">#170302 13:49:53 server id 101  end_log_pos 2083 CRC32 0x5e3da140       Table_map: `jfedu`.`gyj_t1` mapped to number 109</span>
<span class="line"># at 2083</span>
<span class="line">#170302 13:49:53 server id 101  end_log_pos 2130 CRC32 0xbb45eb36       Write_rows: table id 109 flags: STMT_END_F</span>
<span class="line">### INSERT INTO `jfedu`.`gyj_t1`</span>
<span class="line">### SET</span>
<span class="line">###   @1=2</span>
<span class="line">###   @2='BBBBBB'</span>
<span class="line"># at 2130</span>
<span class="line">#170302 13:49:53 server id 101  end_log_pos 2161 CRC32 0x54d510bc       Xid = 950</span>
<span class="line">COMMIT/</span>*!*<span class="regexp">/;    # 这个就是truancate前最后操作的位置</span>
<span class="line"># at 2161</span>
<span class="line">#170302 13:50:23 server id 101  end_log_pos 2250 CRC32 0xc37cd27b       Query   thread_id=4     exec_time=0     error_code=0</span>
<span class="line">SET TIMESTAMP=1488433823/</span>*!*<span class="regexp">/;</span>
<span class="line">truncate table gyj_t1</span>
<span class="line">/</span>*!*<span class="regexp">/;</span>
<span class="line"># at 2250</span>
<span class="line">......</span>
<span class="line"># ------------------------------------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># 使用mysqlbinlog恢复从备份到</span>
<span class="line">mysqlbinlog --start-position=1957 --stop-position=2161 /u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog.<span class="number">000030</span> | mysql -uroot -p</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from gyj_t1;</span>
<span class="line">+------+--------+</span>
<span class="line">| id   | name   |</span>
<span class="line">+------+--------+</span>
<span class="line">|    <span class="number">1</span> | AAAAA  |</span>
<span class="line">|    <span class="number">2</span> | BBBBBB |</span>
<span class="line">+------+--------+</span>
</pre></td></tr></table></figure>
<h2 id="利用Innobackupex的备份和binlog日志对MySQL数据库做完全恢复"><a href="#利用Innobackupex的备份和binlog日志对MySQL数据库做完全恢复" class="headerlink" title="利用Innobackupex的备份和binlog日志对MySQL数据库做完全恢复"></a>利用Innobackupex的备份和binlog日志对MySQL数据库做完全恢复</h2><blockquote>
<p><code>Xtrabackup</code>是一个对InnoDB做数据备份的工具，支持在线热备份（备份时不影响数据读写），是商业备份工具InnoDB Hotbackup的一个很好的替代品。Xtrabackup有两个主要的工具：<code>xtrabackup</code>、<code>innobackupex</code>。<br>（1）xtrabackup只能备份InnoDB和XtraDB两种数据表，而不能备份MyISAM数据表<br>（2）innobackupex是用perl脚本封装了xtrabackup，能同时备份处理innodb和myisam，但在处理myisam时需要加一个读锁<br>（3）相关帮助文档：<a href="https://www.percona.com/docs/wiki/index.html" target="_blank" rel="external">https://www.percona.com/docs/wiki/index.html </a></p>
</blockquote>
<h3 id="下载安装Xtrabackup（二进制）"><a href="#下载安装Xtrabackup（二进制）" class="headerlink" title="下载安装Xtrabackup（二进制）"></a>下载安装Xtrabackup（二进制）</h3><p><a href="https://www.percona.com/downloads/XtraBackup/LATEST/" target="_blank" rel="external">https://www.percona.com/downloads/XtraBackup/LATEST/ </a><br><img src="http://oligvdnzp.bkt.clouddn.com/0301_xtrabackup_01.png" alt="下载Xtrabackup"></p>
<p>上传并解压缩安装软件包<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /tmp</span>
<span class="line">tar -xvpf percona-xtrabackup-<span class="number">2.4</span>.<span class="number">6</span>-Linux-x86_64.tar.gz</span>
<span class="line">cd /tmp/percona-xtrabackup-<span class="number">2.4</span>.<span class="number">6</span>-Linux-x86_64/bin</span>
<span class="line">cp * <span class="regexp">/usr/local</span><span class="regexp">/bin/</span></span>
<span class="line">cd /tmp/percona-xtrabackup-<span class="number">2.4</span>.<span class="number">6</span>-Linux-x86_64/man/man1</span>
<span class="line">cp * <span class="regexp">/usr/share</span><span class="regexp">/man/man</span>1</span>
<span class="line"></span>
<span class="line"><span class="comment"># 可以使用以下命令查看帮助</span></span>
<span class="line">xtrabackup --help</span>
<span class="line">innobackupex --help</span>
<span class="line">man xtrabackup</span>
<span class="line">man innobackupex</span>
</pre></td></tr></table></figure></p>
<h3 id="测试场景构建-1"><a href="#测试场景构建-1" class="headerlink" title="测试场景构建"></a>测试场景构建</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create database lyj;</span>
<span class="line"><span class="keyword">use</span> lyj</span>
<span class="line">create table t1(id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'AAAAA'</span>);</span>
<span class="line">insert into t1 <span class="keyword">select</span> * from t1;</span>
<span class="line">......</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> count(*) from t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|       <span class="number">64</span> |</span>
<span class="line">+----------+</span>
</pre></td></tr></table></figure>
<h3 id="使用Innobackupex备份全库"><a href="#使用Innobackupex备份全库" class="headerlink" title="使用Innobackupex备份全库"></a>使用Innobackupex备份全库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/backup</span>
<span class="line"></span>
<span class="line">innobackupex \</span>
<span class="line">  --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf \</span>
<span class="line">  --user=root \</span>
<span class="line">  --password='' \</span>
<span class="line">  --socket=/u</span>01/run/<span class="number">3306</span>/mysql.sock \</span>
<span class="line">  --<span class="keyword">no</span>-timestamp \</span>
<span class="line">  /u01/backup/xtrabackup_20170302</span>
</pre></td></tr></table></figure>
<h3 id="应用备份期间日志"><a href="#应用备份期间日志" class="headerlink" title="应用备份期间日志"></a>应用备份期间日志</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">innobackupex \</span>
<span class="line">  --defaults-file=<span class="regexp">/u01/backup</span><span class="regexp">/xtrabackup_20170302/backup</span>-my.cnf \</span>
<span class="line">  --apply-<span class="keyword">log</span> \</span>
<span class="line">  --user=root \</span>
<span class="line">  --password=<span class="string">''</span> \</span>
<span class="line">  /u01/backup/xtrabackup_20170302</span>
<span class="line"><span class="comment"># --defaults-file 配置文件参数必须放在第一位，否则会报错</span></span>
<span class="line"><span class="comment"># --apply-log 应用备份期间日志</span></span>
</pre></td></tr></table></figure>
<h3 id="查看innobackupex备份结果"><a href="#查看innobackupex备份结果" class="headerlink" title="查看innobackupex备份结果"></a>查看innobackupex备份结果</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/backup/xtrabackup_20170302</span>
<span class="line">ll</span>
<span class="line">total <span class="number">4165684</span></span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql        <span class="number">434</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> backup-my.cnf</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql   <span class="number">33554432</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ibdata1</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql   <span class="number">16777216</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> ibdata2</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ib_logfile<span class="number">0</span></span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">31</span> ib_logfile1</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ib_logfile2</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ib_logfile3</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql   <span class="number">12582912</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">32</span> ibtmp1</span>
<span class="line">drwxr-<span class="keyword">x</span>--- <span class="number">2</span> mysql mysql       <span class="number">4096</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> jfedu</span>
<span class="line">drwxr-<span class="keyword">x</span>--- <span class="number">2</span> mysql mysql       <span class="number">4096</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> lyj</span>
<span class="line">drwxr-<span class="keyword">x</span>--- <span class="number">2</span> mysql mysql       <span class="number">4096</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> mysql</span>
<span class="line">drwxr-<span class="keyword">x</span>--- <span class="number">2</span> mysql mysql       <span class="number">4096</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> performance_schema</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql         <span class="number">20</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> xtrabackup_binlog_info</span>
<span class="line">-rw-rw-r-- <span class="number">1</span> mysql mysql         <span class="number">20</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">31</span> xtrabackup_binlog_pos_innodb</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql        <span class="number">113</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">31</span> xtrabackup_checkpoints        <span class="comment"># 检查点</span></span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql        <span class="number">572</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">23</span> xtrabackup_info</span>
<span class="line">-rw-r----- <span class="number">1</span> mysql mysql    <span class="number">8388608</span> Mar  <span class="number">2</span> <span class="number">10</span>:<span class="number">31</span> xtrabackup_logfile            <span class="comment"># log日志</span></span>
</pre></td></tr></table></figure>
<h3 id="备份后DML操作"><a href="#备份后DML操作" class="headerlink" title="备份后DML操作"></a>备份后DML操作</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">insert into t1 <span class="keyword">select</span> * from t1;</span>
<span class="line">......</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> count(*) from t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|     <span class="number">4096</span> |</span>
<span class="line">+----------+</span>
</pre></td></tr></table></figure>
<h3 id="摸拟rm误操作"><a href="#摸拟rm误操作" class="headerlink" title="摸拟rm误操作"></a>摸拟rm误操作</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rm -rf /u01/data/<span class="number">3306</span>/*</span>
<span class="line"><span class="comment"># 这时关闭数据库已不能正常启动了</span></span>
</pre></td></tr></table></figure>
<h3 id="拷备份数据到数据库目录"><a href="#拷备份数据到数据库目录" class="headerlink" title="拷备份数据到数据库目录"></a>拷备份数据到数据库目录</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cp -rf /u01/backup/xtrabackup_20170302/* <span class="regexp">/u01/data</span><span class="regexp">/3306/</span></span>
<span class="line"><span class="comment"># 注意文件权限，如果不是mysql，使用以下语句修改，xtrabackup_* 可以不拷贝</span></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01/data/<span class="number">3306</span>/</span>
</pre></td></tr></table></figure>
<h3 id="登陆数据库验证备份恢复"><a href="#登陆数据库验证备份恢复" class="headerlink" title="登陆数据库验证备份恢复"></a>登陆数据库验证备份恢复</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动数据库</span></span>
<span class="line"><span class="keyword">use</span> lyj</span>
<span class="line"><span class="keyword">select</span> count(*) from t1; </span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|       <span class="number">64</span> |</span>
<span class="line">+----------+</span>
<span class="line"><span class="comment"># 恢复了备份时（包括备份期间）的64条记录</span></span>
</pre></td></tr></table></figure>
<h3 id="使用mysqlbinlog完全恢复"><a href="#使用mysqlbinlog完全恢复" class="headerlink" title="使用mysqlbinlog完全恢复"></a>使用mysqlbinlog完全恢复</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cat /u01/backup/xtrabackup_20170302/xtrabackup_binlog_info</span>
<span class="line">binlog.<span class="number">000027</span>   <span class="number">28905477</span></span>
<span class="line"></span>
<span class="line">mysqlbinlog --start-position=<span class="number">28905477</span> /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog.<span class="number">000027</span> | mysql -uroot -p</span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆数据库</span></span>
<span class="line"><span class="keyword">select</span> count(*) from t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|     <span class="number">4096</span> |</span>
<span class="line">+----------+</span>
</pre></td></tr></table></figure>
<h2 id="随堂笔记"><a href="#随堂笔记" class="headerlink" title="随堂笔记"></a>随堂笔记</h2><h3 id="mysqldump常用参数及使用示例"><a href="#mysqldump常用参数及使用示例" class="headerlink" title="mysqldump常用参数及使用示例"></a>mysqldump常用参数及使用示例</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看帮助</span></span>
<span class="line">mysqldump --help</span>
<span class="line"></span>
<span class="line"><span class="comment"># 一些常用参数</span></span>
<span class="line">--single-transaction  <span class="comment"># 备份执行期间不阻塞DML，在生产环境备份时一定要加此参数</span></span>
<span class="line">-A, --all-databases Dump all the databases. This will be same as --databases <span class="comment"># 备份所有的数据库</span></span>
<span class="line">--master-data[=<span class="comment">#]   # --master-data=2 或 --master-data=1，一般做主从的时侯需要加此参数</span></span>
<span class="line">--add-drop-database Add a DROP DATABASE before <span class="keyword">each</span> create. <span class="comment"># 备份中不生成创建数据库命令</span></span>
<span class="line">--add-drop-table    Add a DROP TABLE before <span class="keyword">each</span> create.    <span class="comment"># 备份中不生成创建表命令</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 示例</span></span>
<span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> --single-transaction -P3306 -A &gt; <span class="regexp">/tmp/all</span>_database.sql</span>
<span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P3306 -uroot -p --single-transaction --master-data=<span class="number">2</span> jfedu &gt; <span class="regexp">/tmp/jfedu</span>.sql</span>
<span class="line"></span>
<span class="line">--single-transaction</span>
<span class="line"><span class="comment"># 创建一致性快照（only innodb）</span></span>
<span class="line"><span class="comment"># 不能存在其他操作：ALTER TABLE, DROP TABLE, RENAME TABLE,TRUNCATE TABLE</span></span>
<span class="line"><span class="comment"># 关闭--lock-tables</span></span>
<span class="line"></span>
<span class="line">--master-data</span>
<span class="line"><span class="number">1</span> ： 输出change master命令</span>
<span class="line"><span class="number">2</span> ： 注释输出change master命令</span>
<span class="line"></span>
<span class="line">--default-character-set</span>
<span class="line">binary</span>
<span class="line"></span>
<span class="line">mysqldump -u[USER] -p[PASSWORD] -h [HOST] -P[PORT] --single-transaction --master-data=<span class="number">2</span> [DB]| pv -<span class="keyword">q</span> -L <span class="number">10</span>M | gzip &gt; <span class="regexp">/tmp/test</span>.gzip</span>
<span class="line">备份 ：mysqldump</span>
<span class="line">限流 ：pv </span>
<span class="line">压缩 ：gzip</span>
<span class="line"></span>
<span class="line">gunzip -fc /tmp/test.gz | mysql -u[USER]-h[HOST] -P[PORT] DB </span>
<span class="line">解压 ： gunzip</span>
<span class="line">恢复 ：mysql</span>
<span class="line">主备： change master</span>
</pre></td></tr></table></figure>
<h3 id="分析mysqldump的执行流程"><a href="#分析mysqldump的执行流程" class="headerlink" title="分析mysqldump的执行流程"></a>分析mysqldump的执行流程</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 打开general.log（通常是关闭的）</span></span>
<span class="line">show variables like <span class="string">'%gen%'</span>;</span>
<span class="line">+------------------+--------------------------+</span>
<span class="line">| Variable_name    | Value                    |</span>
<span class="line">+------------------+--------------------------+</span>
<span class="line">| general_log      | OFF                      |</span>
<span class="line">| general_log_file | <span class="regexp">/u01/data</span><span class="regexp">/3306/mysql</span>.log |</span>
<span class="line">+------------------+--------------------------+</span>
<span class="line"></span>
<span class="line">set global general_log=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在新窗口追踪日志</span></span>
<span class="line">tail -f /u01/data/<span class="number">3306</span>/mysql.log</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用mysqldump备份jfedu数据库</span></span>
<span class="line">mysqldump -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -P3306 -uroot -p --single-transaction --master-data=<span class="number">2</span> jfedu &gt; <span class="regexp">/tmp/jfedu</span>.sql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 分析general.log，下面这段就是追踪到的mysqldump执行流程</span></span>
<span class="line"><span class="comment"># ------------------------------------------------------------------------------------------</span></span>
<span class="line"><span class="number">170228</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">29</span>     <span class="number">9</span> Connect   root@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> on </span>
<span class="line">                    <span class="number">9</span> Query     /*!<span class="number">40100</span> SET @@SQL_MODE=<span class="string">''</span> *<span class="regexp">/</span>
<span class="line">                    9 Query     /</span>*!<span class="number">40103</span> SET TIME_ZONE=<span class="string">'+00:00'</span> *<span class="regexp">/</span>
<span class="line">                    9 Query     FLUSH /</span>*!<span class="number">40101</span> LOCAL *<span class="regexp">/ TABLES</span>
<span class="line">                    9 Query     FLUSH TABLES WITH READ LOCK      # 数据库只读锁定命令</span>
<span class="line">                    9 Query     SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ</span>
<span class="line">                    9 Query     START TRANSACTION /</span>*!<span class="number">40100</span> WITH CONSISTENT SNAPSHOT *<span class="regexp">/</span>
<span class="line">                    9 Query     SHOW VARIABLES LIKE 'gtid\_mode'</span>
<span class="line">                    9 Query     SHOW MASTER STATUS</span>
<span class="line">                    9 Query     UNLOCK TABLES</span>
<span class="line">                    9 Query     SELECT LOGFILE_GROUP_NAME, FILE_NAME, TOTAL_EXTENTS, INITIAL_SIZE, ENGINE, EXTRA FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE = 'UNDO LOG' AND FILE_NAME IS NOT NULL AND LOGFILE_GROUP_NAME IN (SELECT DISTINCT LOGFILE_GROUP_NAME FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE = 'DATAFILE' AND TABLESPACE_NAME IN (SELECT DISTINCT TABLESPACE_NAME FROM INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA IN ('jfedu'))) GROUP BY LOGFILE_GROUP_NAME, FILE_NAME, ENGINE ORDER BY LOGFILE_GROUP_NAME</span>
<span class="line">                    9 Query     SELECT DISTINCT TABLESPACE_NAME, FILE_NAME, LOGFILE_GROUP_NAME, EXTENT_SIZE, INITIAL_SIZE, ENGINE FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE = 'DATAFILE' AND TABLESPACE_NAME IN (SELECT DISTINCT TABLESPACE_NAME FROM INFORMATION_SCHEMA.PARTITIONS WHERE TABLE_SCHEMA IN ('jfedu')) ORDER BY TABLESPACE_NAME, LOGFILE_GROUP_NAME</span>
<span class="line">                    9 Query     SHOW VARIABLES LIKE 'ndbinfo\_version'</span>
<span class="line">                    9 Init DB   jfedu</span>
<span class="line">                    9 Query     SAVEPOINT sp</span>
<span class="line">                    9 Query     show tables</span>
<span class="line">                    9 Query     show table status like 't1'</span>
<span class="line">                    9 Query     SET SQL_QUOTE_SHOW_CREATE=1</span>
<span class="line">                    9 Query     SET SESSION character_set_results = 'binary'</span>
<span class="line">                    9 Query     show create table `t1`</span>
<span class="line">                    9 Query     SET SESSION character_set_results = 'utf8'</span>
<span class="line">                    9 Query     show fields from `t1`</span>
<span class="line">                    9 Query     SELECT /</span>*!<span class="number">40001</span> SQL_NO_CACHE *<span class="regexp">/ * FROM `t1`</span>
<span class="line">                    9 Query     SET SESSION character_set_results = 'binary'</span>
<span class="line">                    9 Query     use `jfedu`</span>
<span class="line">                    9 Query     select @@collation_database</span>
<span class="line">                    9 Query     SHOW TRIGGERS LIKE 't1'</span>
<span class="line">                    9 Query     SET SESSION character_set_results = 'utf8'</span>
<span class="line">                    9 Query     ROLLBACK TO SAVEPOINT sp</span>
<span class="line">                    9 Query     RELEASE SAVEPOINT sp</span>
<span class="line">                    9 Quit</span>
<span class="line"># ------------------------------------------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># 关闭general.log</span>
<span class="line">set global general_log=0;</span></span>
</pre></td></tr></table></figure>
<h3 id="修改隔离级别"><a href="#修改隔离级别" class="headerlink" title="修改隔离级别"></a>修改隔离级别</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%iso%'</span>;</span>
<span class="line">+---------------+-----------------+</span>
<span class="line">| Variable_name | Value           |</span>
<span class="line">+---------------+-----------------+</span>
<span class="line">| tx_isolation  | REPEATABLE-READ |</span>
<span class="line">+---------------+-----------------+</span>
<span class="line"></span>
<span class="line">set global tx_isolation=<span class="string">'read-committed'</span>;   <span class="comment"># 重启mysql失效</span></span>
<span class="line">set session tx_isolation=<span class="string">'read-committed'</span>;  <span class="comment"># 只在当前会话中有效</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改my.cnf永久有效</span></span>
<span class="line">vi /etc/my.cnf</span>
<span class="line"><span class="comment">#-------------------------------------</span></span>
<span class="line">transaction_isolation=<span class="keyword">read</span>-committed</span>
<span class="line"><span class="comment">#-------------------------------------</span></span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%iso%'</span>;</span>
<span class="line">+---------------+----------------+</span>
<span class="line">| Variable_name | Value          |</span>
<span class="line">+---------------+----------------+</span>
<span class="line">| tx_isolation  | READ-COMMITTED |</span>
<span class="line">+---------------+----------------+</span>
</pre></td></tr></table></figure>
<h3 id="mydumper常用参数及使用示例"><a href="#mydumper常用参数及使用示例" class="headerlink" title="mydumper常用参数及使用示例"></a>mydumper常用参数及使用示例</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line">mydumper --help</span>
<span class="line"></span>
<span class="line"><span class="comment"># 常用参数解释</span></span>
<span class="line"><span class="comment"># </span></span>
<span class="line">statement-size ： sql语句最大长度</span>
<span class="line">rows ： 按照执行rows分割table数据。</span>
<span class="line">chunk-filesize ： 按照输出文件的大小分割table数据。</span>
<span class="line"><span class="keyword">no</span>-locks ： 不锁表</span>
<span class="line">binlogs ： 备份binlog日志</span>
<span class="line">threads ： 并发线程数</span>
<span class="line"></span>
<span class="line">mydumper -u [USER] -p [PASSWORD] -h [HOST] -P [PORT] -t [THREADS] -b -c -B [DB] -o /tmp/backup</span>
<span class="line"></span>
<span class="line">myloader</span>
<span class="line">  queries-per-transaction：每个事务包含的记录数</span>
<span class="line">  overwrite-tables ：drop table <span class="keyword">if</span> <span class="keyword">exists</span></span>
<span class="line">  enable-binlog：binlog恢复数据  </span>
<span class="line">  threads ： 并发线程数</span>
<span class="line"></span>
<span class="line">myloader -u [USER] -p [PASSWORD] -h [HOST] -P [PORT] -t [THREADS] -o /tmp/backup - -B [DB]</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hexo解决代码块空行自动删除问题]]></title>
      <url>/2017/03/02/tools/hexo%E8%A7%A3%E5%86%B3%E4%BB%A3%E7%A0%81%E5%9D%97%E7%A9%BA%E8%A1%8C%E8%87%AA%E5%8A%A8%E5%88%A0%E9%99%A4%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="修改hexo源码"><a href="#修改hexo源码" class="headerlink" title="修改hexo源码"></a>修改hexo源码</h2><p>将<code>node_modules\hexo-util\lib\highlight.js</code>文件中第<code>35</code>行<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 原</span></span>
<span class="line">    numbers += <span class="string">'&lt;div class="line"&gt;'</span> + (firstLine + i) + <span class="string">'&lt;/div&gt;\n'</span>;</span>
<span class="line">    content += <span class="string">'&lt;div class="line'</span>;</span>
<span class="line">    content += (mark.indexOf(firstLine + i) !== -<span class="number">1</span>) ? <span class="string">' marked'</span> : <span class="string">''</span>;</span>
<span class="line">    content += <span class="string">'"&gt;'</span> + line + <span class="string">'&lt;/div&gt;\n'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 改后</span></span>
<span class="line">    numbers += <span class="string">'&lt;span class="line"&gt;'</span> + (firstLine + i) + <span class="string">'&lt;/span&gt;\n'</span>;</span>
<span class="line">    content += <span class="string">'&lt;span class="line'</span>;</span>
<span class="line">    content += (mark.indexOf(firstLine + i) !== -<span class="number">1</span>) ? <span class="string">' marked'</span> : <span class="string">''</span>;</span>
<span class="line">    content += <span class="string">'"&gt;'</span> + line + <span class="string">'&lt;/span&gt;\n'</span>;</span>
</pre></td></tr></table></figure></p>
<h2 id="清理临时数据库并重启本地服务"><a href="#清理临时数据库并重启本地服务" class="headerlink" title="清理临时数据库并重启本地服务"></a>清理临时数据库并重启本地服务</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">hexo clean</span>
<span class="line">hexo <span class="keyword">s</span> -g</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="查看hexo版本信息"><a href="#查看hexo版本信息" class="headerlink" title="查看hexo版本信息"></a>查看hexo版本信息</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">$ hexo version</span>
<span class="line">hexo: <span class="number">3.2</span>.<span class="number">2</span></span>
<span class="line">hexo-cli: <span class="number">1.0</span>.<span class="number">2</span></span>
<span class="line">os: Windows_NT <span class="number">6.1</span>.<span class="number">7601</span> win32 x64</span>
<span class="line">http_parser: <span class="number">2.7</span>.<span class="number">0</span></span>
<span class="line">node: <span class="number">6.9</span>.<span class="number">4</span></span>
<span class="line">v8: <span class="number">5.1</span>.<span class="number">281.89</span></span>
<span class="line">uv: <span class="number">1.9</span>.<span class="number">1</span></span>
<span class="line">zlib: <span class="number">1.2</span>.<span class="number">8</span></span>
<span class="line">ares: <span class="number">1.10</span>.<span class="number">1</span>-DEV</span>
<span class="line">icu: <span class="number">57.1</span></span>
<span class="line">modules: <span class="number">48</span></span>
<span class="line">openssl: <span class="number">1.0</span>.<span class="number">2</span>j</span>
</pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> hexo </tag>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-05 MySQL DBA日常操作]]></title>
      <url>/2017/02/24/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/05-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="使用mysqld-mutil-start命令启动多实例3306、3307，使用mysqld-multi-report命令显示结果。"><a href="#使用mysqld-mutil-start命令启动多实例3306、3307，使用mysqld-multi-report命令显示结果。" class="headerlink" title="使用mysqld_mutil start命令启动多实例3306、3307，使用mysqld_multi report命令显示结果。"></a>使用mysqld_mutil start命令启动多实例3306、3307，使用mysqld_multi report命令显示结果。</h2><h3 id="规划多实例目录"><a href="#规划多实例目录" class="headerlink" title="规划多实例目录"></a>规划多实例目录</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/mysql             <span class="comment"># 程序目录</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/conf              <span class="comment"># 配置文件</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/data/<span class="number">3306</span>         </span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/data/<span class="number">3307</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3307</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/<span class="keyword">log</span>/<span class="number">3307</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/run/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/run/<span class="number">3307</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/tmp/<span class="number">3306</span></span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/tmp/<span class="number">3307</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">755</span> /u01</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="重新编译安装mysql"><a href="#重新编译安装mysql" class="headerlink" title="重新编译安装mysql"></a>重新编译安装mysql</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span></span>
<span class="line">rm -rf CMakeCache.txt</span>
<span class="line"></span>
<span class="line">cmake \</span>
<span class="line">-DCMAKE_INSTALL_PREFIX=<span class="regexp">/u01/mysql</span> \</span>
<span class="line">-DINSTALL_DATADIR=<span class="regexp">/u01/data</span><span class="regexp">/3306  \</span>
<span class="line">-DDEFAULT_CHARSET=utf8 \</span>
<span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span>
<span class="line">-DEXTRA_CHARSETS=all \</span>
<span class="line">-DWITH_SSL=yes \</span>
<span class="line">-DWITH_EMBEDDED_SERVER=1 \</span>
<span class="line">-DENABLED_LOCAL_INFILE=1 \</span>
<span class="line">-DWITH_MYISAM_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=1 \</span>
<span class="line">-DWITH_PARTITION_STORAGE_ENGINE=1 \</span>
<span class="line">-DMYSQL_UNIX_ADDR=/u</span>01/run/<span class="number">3306</span>/mysql.sock \</span>
<span class="line">-DMYSQL_TCP_PORT=<span class="number">3306</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DSYSCONFDIR=<span class="regexp">/etc \</span>
<span class="line">-DWITH_READLINE=on</span>
<span class="line"></span>
<span class="line">make &amp;&amp; make install</span></span>
</pre></td></tr></table></figure>
<h3 id="配置多实例独自参数文件"><a href="#配置多实例独自参数文件" class="headerlink" title="配置多实例独自参数文件"></a>配置多实例独自参数文件</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/conf</span>
<span class="line">vi my3306.cnf</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">[client]</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line"></span>
<span class="line">[mysql]</span>
<span class="line">pid_file=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysqld</span>.pid</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">autocommit=<span class="number">1</span></span>
<span class="line">general_log=off</span>
<span class="line">explicit_defaults_for_timestamp=true</span>
<span class="line"></span>
<span class="line"><span class="comment"># system</span></span>
<span class="line">basedir=<span class="regexp">/u01/mysql</span></span>
<span class="line">datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">max_allowed_packet=1g</span>
<span class="line">max_connections=3000</span>
<span class="line">max_user_connections=2800</span>
<span class="line">open_files_limit=65535</span>
<span class="line">pid_file=/u</span>01/run/<span class="number">3306</span>/mysqld.pid</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">server_id=<span class="number">3306</span></span>
<span class="line">skip_name_resolve=ON</span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line">tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line"></span>
<span class="line">#binlog</span>
<span class="line">log_bin=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/binlog/binlog</span>
<span class="line">binlog_cache_size=<span class="number">32768</span></span>
<span class="line">binlog_format=row</span>
<span class="line">expire_logs_days=<span class="number">7</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">max_binlog_size=<span class="number">524288000</span></span>
<span class="line">sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#logging</span></span>
<span class="line">log_error=<span class="regexp">/u01/log</span><span class="regexp">/3306/error</span>.log</span>
<span class="line">slow_query_log_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/slow</span>.log</span>
<span class="line">log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">slow_query_log=<span class="number">1</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#relay</span></span>
<span class="line">relay_log=<span class="regexp">/u01/log</span><span class="regexp">/3306/relaylog</span></span>
<span class="line">relay_log_index=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>.index</span>
<span class="line">relay_log_info_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>-log.info</span>
<span class="line"></span>
<span class="line"><span class="comment">#slave</span></span>
<span class="line">slave_load_tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line">slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line">#innodb</span>
<span class="line">innodb_data_home_dir=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/iblog</span>
<span class="line">innodb_log_group_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3306/iblog</span></span>
<span class="line">innodb_adaptive_flushing=ON</span>
<span class="line">innodb_adaptive_hash_index=ON</span>
<span class="line">innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#default</span></span>
<span class="line">innodb_change_buffering=inserts</span>
<span class="line">innodb_checksums=ON</span>
<span class="line">innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">innodb_doublewrite=ON</span>
<span class="line">innodb_file_format=Barracuda</span>
<span class="line">innodb_file_per_table=ON</span>
<span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">innodb_flush_method=O_DIRECT</span>
<span class="line">innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">innodb_open_files=<span class="number">60000</span></span>
<span class="line">innodb_purge_threads=<span class="number">1</span></span>
<span class="line">innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">innodb_stats_on_metadata=OFF</span>
<span class="line">innodb_support_xa=ON</span>
<span class="line">innodb_use_native_aio=OFF</span>
<span class="line">innodb_write_io_threads=<span class="number">10</span></span>
<span class="line"></span>
<span class="line">[mysqld_safe]</span>
<span class="line">datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">----------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># 将上面内容中3306替换成3307，server编辑保存my3307.cnf</span>
<span class="line">vi my3307.cnf</span></span>
</pre></td></tr></table></figure>
<h3 id="初始化多实例数据库"><a href="#初始化多实例数据库" class="headerlink" title="初始化多实例数据库"></a>初始化多实例数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改环境变量</span></span>
<span class="line">vi /home/mysql/.bash_profile</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">PATH=$PATH:$HOME/bin:<span class="regexp">/u01/mysql</span><span class="regexp">/bin</span>
<span class="line">----------------------------------------------------------</span>
<span class="line"></span>
<span class="line"># 初始化数据库实例</span>
<span class="line">cd /u</span>01/mysql/scripts</span>
<span class="line">./mysql_install_db --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf \</span>
<span class="line">--datadir=/u</span>01/data/<span class="number">3306</span> --basedir=<span class="regexp">/u01/mysql</span> --user=mysql</span>
<span class="line"></span>
<span class="line">./mysql_install_db --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3307.cnf \</span>
<span class="line">--datadir=/u</span>01/data/<span class="number">3307</span> --basedir=<span class="regexp">/u01/mysql</span> --user=mysql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用独立参数启动实例</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line">mysqld_safe --defaults-file=/u</span>01/conf/my3307.cnf &amp;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆3306实例</span></span>
<span class="line">mysql --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'port'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| port          | <span class="number">3306</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆3307实例</span></span>
<span class="line">mysql --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3307/mysql</span>.sock</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'port'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| port          | <span class="number">3307</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭实例</span></span>
<span class="line">mysqladmin --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock <span class="keyword">shutdown</span> &amp;</span>
<span class="line">mysqladmin --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3307/mysql</span>.sock <span class="keyword">shutdown</span> &amp;</span>
</pre></td></tr></table></figure>
<h3 id="修改-etc-my-cnf参数"><a href="#修改-etc-my-cnf参数" class="headerlink" title="修改/etc/my.cnf参数"></a>修改/etc/my.cnf参数</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># root用户下操作</span></span>
<span class="line">vi /etc/my.cnf</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">[mysqld_multi]</span>
<span class="line">    mysqld=<span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysqld</span>_safe</span>
<span class="line">    mysqladmin=<span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysqladmin</span></span>
<span class="line">    user=root</span>
<span class="line">    <span class="keyword">log</span>=<span class="regexp">/u01/log</span><span class="regexp">/multi.log</span>
<span class="line"></span>
<span class="line">[mysqld3306]</span>
<span class="line">    port=3306</span>
<span class="line">    basedir=/u</span>01/mysql</span>
<span class="line">    datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306</span>
<span class="line">    socket=/u</span>01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line">    server-id=<span class="number">3306</span></span>
<span class="line">    log_bin=<span class="regexp">/u01/log</span><span class="regexp">/3306/binlog</span><span class="regexp">/binlog</span>
<span class="line">    slow_query_log_file=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/slow.log</span>
<span class="line">    innodb_data_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3306/iblog</span></span>
<span class="line">    innodb_log_group_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3306/iblog</span></span>
<span class="line">    log_error=<span class="regexp">/u01/log</span><span class="regexp">/3306/error</span>.log</span>
<span class="line">    pid_file=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysqld</span>.pid</span>
<span class="line">    tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line">    relay_log=/u</span>01/<span class="keyword">log</span>/<span class="number">3306</span>/relaylog</span>
<span class="line">    relay_log_index=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>.index</span>
<span class="line">    relay_log_info_file=<span class="regexp">/u01/log</span><span class="regexp">/3306/relay</span>-log.info</span>
<span class="line">    slave_load_tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3306</span>
<span class="line"></span>
<span class="line">[mysqld3307]</span>
<span class="line">    port=3307</span>
<span class="line">    basedir=/u</span>01/mysql</span>
<span class="line">    datadir=<span class="regexp">/u01/data</span><span class="regexp">/3307</span>
<span class="line">    socket=/u</span>01/run/<span class="number">3307</span>/mysql.sock</span>
<span class="line">    server-id=<span class="number">3307</span></span>
<span class="line">    log_bin=<span class="regexp">/u01/log</span><span class="regexp">/3307/binlog</span><span class="regexp">/binlog</span>
<span class="line">    slow_query_log_file=/u</span>01/<span class="keyword">log</span>/<span class="number">3307</span>/slow.log</span>
<span class="line">    innodb_data_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3307/iblog</span></span>
<span class="line">    innodb_log_group_home_dir=<span class="regexp">/u01/log</span><span class="regexp">/3307/iblog</span></span>
<span class="line">    log_error=<span class="regexp">/u01/log</span><span class="regexp">/3307/error</span>.log</span>
<span class="line">    pid_file=<span class="regexp">/u01/run</span><span class="regexp">/3307/mysqld</span>.pid</span>
<span class="line">    tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3307</span>
<span class="line">    relay_log=/u</span>01/<span class="keyword">log</span>/<span class="number">3307</span>/relaylog</span>
<span class="line">    relay_log_index=<span class="regexp">/u01/log</span><span class="regexp">/3307/relay</span>.index</span>
<span class="line">    relay_log_info_file=<span class="regexp">/u01/log</span><span class="regexp">/3307/relay</span>-log.info</span>
<span class="line">    slave_load_tmpdir=<span class="regexp">/u01/tmp</span><span class="regexp">/3307</span>
<span class="line"></span>
<span class="line">[client]</span>
<span class="line">    port=3306</span>
<span class="line">    socket =/u</span>01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">    autocommit=<span class="number">1</span></span>
<span class="line">    general_log=off</span>
<span class="line">    explicit_defaults_for_timestamp=true</span>
<span class="line">    max_allowed_packet=<span class="number">1</span>g</span>
<span class="line">    max_connections=<span class="number">3000</span></span>
<span class="line">    max_user_connections=<span class="number">2800</span></span>
<span class="line">    open_files_limit=<span class="number">65535</span></span>
<span class="line">    skip_name_resolve=ON</span>
<span class="line"></span>
<span class="line">    <span class="comment">#binlog</span></span>
<span class="line">    binlog_cache_size=<span class="number">32768</span></span>
<span class="line">    binlog_format=row</span>
<span class="line">    expire_logs_days=<span class="number">7</span></span>
<span class="line">    log_slave_updates=ON</span>
<span class="line">    max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">    max_binlog_size=<span class="number">524288000</span></span>
<span class="line">    sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line">    log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">    slow_query_log=<span class="number">1</span></span>
<span class="line">    log_slave_updates=ON</span>
<span class="line">    log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">    long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line">    slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line">    innodb_adaptive_flushing=ON</span>
<span class="line">    innodb_adaptive_hash_index=ON</span>
<span class="line">    innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">    innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line">    <span class="comment">#default</span></span>
<span class="line">    innodb_change_buffering=inserts</span>
<span class="line">    innodb_checksums=ON</span>
<span class="line">    innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">    innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">    innodb_doublewrite=ON</span>
<span class="line">    innodb_file_format=Barracuda</span>
<span class="line">    innodb_file_per_table=ON</span>
<span class="line">    innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">    innodb_flush_method=O_DIRECT</span>
<span class="line">    innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">    innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">    innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">    innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">    innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">    innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">    innodb_open_files=<span class="number">60000</span></span>
<span class="line">    innodb_purge_threads=<span class="number">1</span></span>
<span class="line">    innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">    innodb_stats_on_metadata=OFF</span>
<span class="line">    innodb_support_xa=ON</span>
<span class="line">    innodb_use_native_aio=OFF</span>
<span class="line">    innodb_write_io_threads=<span class="number">10</span></span>
<span class="line">----------------------------------------------------------</span>
</pre></td></tr></table></figure>
<h3 id="mysqld-multi启动-关闭多实例，查看多实例运行状态"><a href="#mysqld-multi启动-关闭多实例，查看多实例运行状态" class="headerlink" title="mysqld_multi启动/关闭多实例，查看多实例运行状态"></a>mysqld_multi启动/关闭多实例，查看多实例运行状态</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 启动多实例数据库</span></span>
<span class="line">mysqld_multi start             <span class="comment"># 启动全部配置的多实例</span></span>
<span class="line">mysqld_multi start <span class="number">3306</span>        <span class="comment"># 启动指定server-id的实例</span></span>
<span class="line">mysqld_multi start <span class="number">3306</span>-<span class="number">3307</span>   <span class="comment"># 启动指定server-id连续的实例</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看多实例运行状态</span></span>
<span class="line">mysqld_multi report</span>
<span class="line">Reporting MySQL servers</span>
<span class="line">MySQL server from group: mysqld3306 is running</span>
<span class="line">MySQL server from group: mysqld3307 is running</span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭多实例数据库</span></span>
<span class="line">mysqld_multi stop</span>
<span class="line">mysqld_multi stop <span class="number">3306</span></span>
<span class="line">mysqld_multi stop <span class="number">3306</span>-<span class="number">3307</span></span>
</pre></td></tr></table></figure>
<h2 id="在线迁移MySQL-3306实例上的数据库jfedu到MySQL-3307上。"><a href="#在线迁移MySQL-3306实例上的数据库jfedu到MySQL-3307上。" class="headerlink" title="在线迁移MySQL 3306实例上的数据库jfedu到MySQL 3307上。"></a>在线迁移MySQL 3306实例上的数据库jfedu到MySQL 3307上。</h2><h3 id="登陆3306实例，创建jfedu数据库"><a href="#登陆3306实例，创建jfedu数据库" class="headerlink" title="登陆3306实例，创建jfedu数据库"></a>登陆3306实例，创建jfedu数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登陆3306实例</span></span>
<span class="line">mysql -S /u01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看port和server_id</span></span>
<span class="line">show variables like <span class="string">'port'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| port          | <span class="number">3306</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'server_id'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| server_id     | <span class="number">3306</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建jfedu数据库，创建表t1并插入数据</span></span>
<span class="line">create database jfedu;</span>
<span class="line"><span class="keyword">use</span> jfedu;</span>
<span class="line">create table t1(id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'AAAAA'</span>);</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure>
<h3 id="在3306实例上创建一个复制帐号"><a href="#在3306实例上创建一个复制帐号" class="headerlink" title="在3306实例上创建一个复制帐号"></a>在3306实例上创建一个复制帐号</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">grant replication slave,replication client on *.* to <span class="string">'repl'</span>@'%' identified by <span class="string">'repl4Slave'</span>;</span>
</pre></td></tr></table></figure>
<h3 id="备份jfedu数据库"><a href="#备份jfedu数据库" class="headerlink" title="备份jfedu数据库"></a>备份jfedu数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysqldump --single-transaction --master-data=<span class="number">2</span> -uroot jfedu &gt; <span class="regexp">/tmp/jfedu</span>.sql</span>
<span class="line"><span class="comment"># --single-transaction 不锁表</span></span>
<span class="line"><span class="comment"># --master-data=2 在备份文件中记录master_log_file和master_log_pos的值</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置主从复制时会用到master_log_file和master_log_pos的值</span></span>
<span class="line">cat /tmp/jfedu.sql | <span class="keyword">grep</span> MASTER_LOG_FILE</span>
<span class="line">-- CHANGE MASTER TO MASTER_LOG_FILE=<span class="string">'binlog.000022'</span>, MASTER_LOG_POS=<span class="number">750</span>;</span>
</pre></td></tr></table></figure>
<h3 id="在3307实例上恢复jfedu数据库"><a href="#在3307实例上恢复jfedu数据库" class="headerlink" title="在3307实例上恢复jfedu数据库"></a>在3307实例上恢复jfedu数据库</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 登陆3306实例</span></span>
<span class="line">mysql -S /u01/run/<span class="number">3307</span>/mysql.sock</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看port和server_id</span></span>
<span class="line">show variables like <span class="string">'port'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| port          | <span class="number">3307</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'server_id'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| server_id     | <span class="number">3307</span>  |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 在3307上创建jfedu数据库</span></span>
<span class="line">create database jfedu;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 恢复数据库</span></span>
<span class="line"><span class="keyword">use</span> jfedu;</span>
<span class="line">source /tmp/jfedu.sql;</span>
</pre></td></tr></table></figure>
<h3 id="3306实例在恢复时有数据插入"><a href="#3306实例在恢复时有数据插入" class="headerlink" title="3306实例在恢复时有数据插入"></a>3306实例在恢复时有数据插入</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> jfedu</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'BBBBB'</span>);</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure>
<h3 id="在3307实例上执行change-master设置主从复制，并启动复制"><a href="#在3307实例上执行change-master设置主从复制，并启动复制" class="headerlink" title="在3307实例上执行change master设置主从复制，并启动复制"></a>在3307实例上执行change master设置主从复制，并启动复制</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置主从复制</span></span>
<span class="line">change master to</span>
<span class="line">master_host=<span class="string">'127.0.0.1'</span>,</span>
<span class="line">master_port=<span class="number">3306</span>,</span>
<span class="line">master_user=<span class="string">'repl'</span>,</span>
<span class="line">master_password=<span class="string">'repl4Slave'</span>,</span>
<span class="line">master_log_file=<span class="string">'binlog.000022'</span>,</span>
<span class="line">master_log_pos=<span class="number">750</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 启动复制</span></span>
<span class="line">start slave;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看复制状态</span></span>
<span class="line">show slave status\G;</span>
<span class="line"></span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to <span class="keyword">send</span> event</span>
<span class="line">                  Master_Host: <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span></span>
<span class="line">                  Master_User: repl</span>
<span class="line">                  Master_Port: <span class="number">3306</span></span>
<span class="line">                Connect_Retry: <span class="number">60</span></span>
<span class="line">              Master_Log_File: binlog.<span class="number">000022</span></span>
<span class="line">          Read_Master_Log_Pos: <span class="number">949</span></span>
<span class="line">               Relay_Log_File: relaylog.<span class="number">000002</span></span>
<span class="line">                Relay_Log_Pos: <span class="number">479</span></span>
<span class="line">        Relay_Master_Log_File: binlog.<span class="number">000022</span></span>
<span class="line">             Slave_IO_Running: Yes               <span class="comment"># Yes表示复制正常</span></span>
<span class="line">            Slave_SQL_Running: Yes               <span class="comment"># Yes表示复制正常</span></span>
<span class="line">......</span>
<span class="line"></span>
<span class="line"><span class="comment"># 观察3307上数据是否复制过来</span></span>
<span class="line"><span class="keyword">select</span> * from jfedu.t1;</span>
<span class="line">+------+-------+</span>
<span class="line">| id   | name  |</span>
<span class="line">+------+-------+</span>
<span class="line">|    <span class="number">1</span> | AAAAA |</span>
<span class="line">|    <span class="number">2</span> | BBBBB |</span>
<span class="line">+------+-------+</span>
</pre></td></tr></table></figure>
<h3 id="3306实例设置成read-only"><a href="#3306实例设置成read-only" class="headerlink" title="3306实例设置成read only"></a>3306实例设置成read only</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'read_only'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| read_only     | OFF   |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">set global read_only=<span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h3 id="数据全部一致后，停止复制"><a href="#数据全部一致后，停止复制" class="headerlink" title="数据全部一致后，停止复制"></a>数据全部一致后，停止复制</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">stop slave;</span>
</pre></td></tr></table></figure>
<h2 id="MySQL5-6升级到MySQL5-7，正常登录到MySQL5-7，详细步骤。"><a href="#MySQL5-6升级到MySQL5-7，正常登录到MySQL5-7，详细步骤。" class="headerlink" title="MySQL5.6升级到MySQL5.7，正常登录到MySQL5.7，详细步骤。"></a>MySQL5.6升级到MySQL5.7，正常登录到MySQL5.7，详细步骤。</h2><h3 id="下载MySQL5-7"><a href="#下载MySQL5-7" class="headerlink" title="下载MySQL5.7"></a>下载MySQL5.7</h3><p>下载地址：<a href="https://dev.mysql.com/downloads/mysql" target="_blank" rel="external">https://dev.mysql.com/downloads/mysql </a><br><img src="http://oligvdnzp.bkt.clouddn.com/0224_mysql57_01.png" alt="mysql5.7下载"></p>
<h3 id="上传并解压软件包"><a href="#上传并解压软件包" class="headerlink" title="上传并解压软件包"></a>上传并解压软件包</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">[mysql@mysql ~]$ cd /u01</span>
<span class="line"><span class="comment">#选择下载的软件包上传</span></span>
<span class="line">[mysql@mysql u01]$ rz</span>
<span class="line">[mysql@mysql u01]$ ll</span>
<span class="line">total <span class="number">698668</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">2</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> <span class="number">11</span>:<span class="number">16</span> conf</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">4</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> 09:<span class="number">45</span> data</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">4</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> <span class="number">11</span>:<span class="number">00</span> <span class="keyword">log</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">13</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> <span class="number">10</span>:<span class="number">16</span> mysql</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>  <span class="number">35</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> <span class="number">10</span>:<span class="number">05</span> mysql-<span class="number">5.6</span>.<span class="number">35</span></span>
<span class="line">-rwxr-xr-x.  <span class="number">1</span> mysql mysql  <span class="number">32167628</span> Jan <span class="number">17</span> <span class="number">11</span>:<span class="number">16</span> mysql-<span class="number">5.6</span>.<span class="number">35</span>.tar.gz</span>
<span class="line">-rw-r--r--   <span class="number">1</span> mysql mysql <span class="number">683233280</span> Feb <span class="number">24</span> <span class="number">16</span>:<span class="number">36</span> mysql-<span class="number">5.7</span>.<span class="number">17</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar   <span class="comment"># 这个就是二进制mysql5.7软件</span></span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">4</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> 09:<span class="number">50</span> run</span>
<span class="line">drwxr-xr-<span class="keyword">x</span>   <span class="number">4</span> mysql mysql      <span class="number">4096</span> Feb <span class="number">24</span> 09:<span class="number">45</span> tmp</span>
<span class="line"></span>
<span class="line">tar -xpvf mysql-<span class="number">5.7</span>.<span class="number">17</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar</span>
<span class="line">tar -xpvf mysql-<span class="number">5.7</span>.<span class="number">17</span>-linux-glibc2.<span class="number">5</span>-x86_64.tar.gz</span>
<span class="line"></span>
<span class="line"><span class="comment"># 因为是二进制包，解压后就可以用了，文件夹名改短些</span></span>
<span class="line">mv mysql-<span class="number">5.7</span>.<span class="number">17</span>-linux-glibc2.<span class="number">5</span>-x86_64 mysql5.<span class="number">7</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改环境变量</span></span>
<span class="line">vi /home/mysql/.bash_profile</span>
<span class="line">PATH=$PATH:$HOME/bin:<span class="regexp">/u01/mysql</span>5.<span class="number">7</span>/bin</span>
</pre></td></tr></table></figure>
<h3 id="查看mysql版本信息"><a href="#查看mysql版本信息" class="headerlink" title="查看mysql版本信息"></a>查看mysql版本信息</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql -V</span>
<span class="line">--------------</span>
<span class="line">mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.7</span>.<span class="number">17</span>, <span class="keyword">for</span> linux-glibc2.<span class="number">5</span> (x86_64) using  EditLine wrapper</span>
<span class="line">--------------</span>
<span class="line"></span>
<span class="line">mysqld_multi start <span class="number">3306</span></span>
<span class="line">mysql -S /u01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line">status;</span>
<span class="line">--------------</span>
<span class="line">mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.7</span>.<span class="number">17</span>, <span class="keyword">for</span> linux-glibc2.<span class="number">5</span> (x86_64) using  EditLine wrapper</span>
<span class="line"></span>
<span class="line">Connection id:          <span class="number">7</span></span>
<span class="line">Current database:</span>
<span class="line">Current user:           root@localhost</span>
<span class="line">SSL:                    Not in <span class="keyword">use</span></span>
<span class="line">Current pager:          stdout</span>
<span class="line">Using outfile:          <span class="string">''</span></span>
<span class="line">Using delimiter:        ;</span>
<span class="line">Server version:         <span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> Source distribution</span>
<span class="line">Protocol version:       <span class="number">10</span></span>
<span class="line">Connection:             Localhost via UNIX <span class="keyword">socket</span></span>
<span class="line">Server characterset:    utf8</span>
<span class="line">Db     characterset:    utf8</span>
<span class="line">Client characterset:    utf8</span>
<span class="line">Conn.  characterset:    utf8</span>
<span class="line">UNIX <span class="keyword">socket</span>:            <span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line">Uptime:                 <span class="number">3</span> min <span class="number">57</span> sec</span>
<span class="line"></span>
<span class="line">Threads: <span class="number">2</span>  Questions: <span class="number">16</span>  Slow queries: <span class="number">0</span>  Opens: <span class="number">70</span>  Flush tables: <span class="number">1</span>  Open tables: <span class="number">63</span>  Queries per second avg: <span class="number">0</span>.<span class="number">067</span></span>
<span class="line">--------------</span>
</pre></td></tr></table></figure>
<h3 id="升级数据库字典"><a href="#升级数据库字典" class="headerlink" title="升级数据库字典"></a>升级数据库字典</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql_upgrade -S /u01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line">--------------</span>
<span class="line">Checking <span class="keyword">if</span> update is needed.</span>
<span class="line">Checking server version.</span>
<span class="line">Error: Server version (<span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span>) does <span class="keyword">not</span> match with the version of</span>
<span class="line">the server (<span class="number">5.7</span>.<span class="number">17</span>) with which this program was built/distributed. You can</span>
<span class="line"><span class="keyword">use</span> --skip-version-check to skip this check.</span>
<span class="line">--------------</span>
<span class="line"></span>
<span class="line">mysql_upgrade -S /u01/run/<span class="number">3306</span>/mysql.sock --skip-version-check</span>
<span class="line">--------------</span>
<span class="line">Checking <span class="keyword">if</span> update is needed.</span>
<span class="line">Running queries to upgrade MySQL server.</span>
<span class="line">mysql_upgrade: [ERROR] <span class="number">1726</span>: Storage engine <span class="string">'InnoDB'</span> does <span class="keyword">not</span> support <span class="keyword">system</span> tables. [mysql.plugin]</span>
<span class="line">--------------</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启下数据库</span></span>
<span class="line">mysqld_multi stop</span>
<span class="line">mysqld --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line">mysql_upgrade -S /u</span>01/run/<span class="number">3306</span>/mysql.sock --skip-version-check</span>
<span class="line">--------------</span>
<span class="line">Checking <span class="keyword">if</span> update is needed.</span>
<span class="line">Running queries to upgrade MySQL server.</span>
<span class="line">Checking <span class="keyword">system</span> database.</span>
<span class="line">mysql.columns_priv                                 OK</span>
<span class="line">mysql.db                                           OK</span>
<span class="line">mysql.engine_cost                                  OK</span>
<span class="line">mysql.event                                        OK</span>
<span class="line">mysql.func                                         OK</span>
<span class="line">mysql.general_log                                  OK</span>
<span class="line">mysql.gtid_executed                                OK</span>
<span class="line">mysql.help_category                                OK</span>
<span class="line">mysql.help_keyword                                 OK</span>
<span class="line">mysql.help_relation                                OK</span>
<span class="line">mysql.help_topic                                   OK</span>
<span class="line">mysql.innodb_index_stats                           OK</span>
<span class="line">mysql.innodb_table_stats                           OK</span>
<span class="line">mysql.ndb_binlog_index                             OK</span>
<span class="line">mysql.plugin                                       OK</span>
<span class="line">......</span>
<span class="line">Repairing tables</span>
<span class="line">mysql_old.innodb_index_stats</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">mysql_old.innodb_table_stats</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">mysql_old.slave_master_info</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">mysql_old.slave_relay_log_info</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">mysql_old.slave_worker_info</span>
<span class="line">Error    : Unknown error <span class="number">1146</span></span>
<span class="line">status   : Operation failed</span>
<span class="line">Upgrade process completed successfully.</span>
<span class="line">Checking <span class="keyword">if</span> update is needed.</span>
<span class="line">--------------</span>
</pre></td></tr></table></figure>
<h3 id="再查看mysql版本信息，升级完成"><a href="#再查看mysql版本信息，升级完成" class="headerlink" title="再查看mysql版本信息，升级完成"></a>再查看mysql版本信息，升级完成</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql -S /u01/run/<span class="number">3306</span>/mysql.sock</span>
<span class="line"></span>
<span class="line">mysql&gt; status;</span>
<span class="line">--------------</span>
<span class="line">mysql  Ver <span class="number">14.14</span> Distrib <span class="number">5.7</span>.<span class="number">17</span>, <span class="keyword">for</span> linux-glibc2.<span class="number">5</span> (x86_64) using  EditLine wrapper</span>
<span class="line"></span>
<span class="line">Connection id:          <span class="number">4</span></span>
<span class="line">Current database:</span>
<span class="line">Current user:           root@localhost</span>
<span class="line">SSL:                    Not in <span class="keyword">use</span></span>
<span class="line">Current pager:          stdout</span>
<span class="line">Using outfile:          <span class="string">''</span></span>
<span class="line">Using delimiter:        ;</span>
<span class="line">Server version:         <span class="number">5.7</span>.<span class="number">17</span>-<span class="keyword">log</span> MySQL Community Server (GPL)</span>
<span class="line">Protocol version:       <span class="number">10</span></span>
<span class="line">Connection:             Localhost via UNIX <span class="keyword">socket</span></span>
<span class="line">Server characterset:    latin1</span>
<span class="line">Db     characterset:    latin1</span>
<span class="line">Client characterset:    utf8</span>
<span class="line">Conn.  characterset:    utf8</span>
<span class="line">UNIX <span class="keyword">socket</span>:            <span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock</span>
<span class="line">Uptime:                 <span class="number">6</span> min <span class="number">3</span> sec</span>
<span class="line"></span>
<span class="line">Threads: <span class="number">1</span>  Questions: <span class="number">3174</span>  Slow queries: <span class="number">0</span>  Opens: <span class="number">368</span>  Flush tables: <span class="number">1</span>  Open tables: <span class="number">25</span>  Queries per second avg: <span class="number">8.743</span></span>
<span class="line">--------------</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> version();</span>
<span class="line">+------------+</span>
<span class="line">| version()  |</span>
<span class="line">+------------+</span>
<span class="line">| <span class="number">5.7</span>.<span class="number">17</span>-<span class="keyword">log</span> |</span>
<span class="line">+------------+</span>
</pre></td></tr></table></figure>
<h2 id="课堂笔记整理"><a href="#课堂笔记整理" class="headerlink" title="课堂笔记整理"></a>课堂笔记整理</h2><h3 id="MySQL启动"><a href="#MySQL启动" class="headerlink" title="MySQL启动"></a>MySQL启动</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 推荐启动方式</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line"></span>
<span class="line"># 编译安装可以使用的启动方式（很少用）</span>
<span class="line">cd /u</span>01/mysql/support-files/</span>
<span class="line">./mysql.server start</span>
<span class="line"></span>
<span class="line"><span class="comment"># rpm包安装可以使用的启动方式</span></span>
<span class="line">/etc/init.d/mysqld start</span>
<span class="line">service mysqld start</span>
<span class="line"></span>
<span class="line"><span class="comment"># mysqld的启动方式</span></span>
<span class="line">mysqld --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf &amp;</span>
<span class="line"></span>
<span class="line"># 多实例启动方式，需要先修改my.cnf参数，并放到/etc</span>目录下（建议单个实例维护）</span>
<span class="line">mysqld_mutil start</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看mysql启动时参数my.cnf查找顺序</span></span>
<span class="line">mysqld --verbose --help | <span class="keyword">grep</span> my.cnf</span>
<span class="line"></span>
<span class="line"><span class="comment"># mysqld_safe方式启动mysql后相关进程，mysqld_safe进程有监控mysqld进程的作用，mysqld异常终止时，mysqld_safe会重启mysqld</span></span>
<span class="line">ps -ef | <span class="keyword">grep</span> mysql | <span class="keyword">grep</span> -v bash | <span class="keyword">grep</span> -v <span class="keyword">grep</span> | <span class="keyword">grep</span> -v su | <span class="keyword">grep</span> -v ps</span>
<span class="line">mysql     <span class="number">5503</span> <span class="number">18586</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">33</span> pts/<span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /bin/sh /u01/mysql/bin/mysqld_safe --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf</span>
<span class="line">mysql     6342  5503  0 16:33 pts/</span><span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /u01/mysql/bin/mysqld --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf --basedir=/u</span>01/mysql --datadir=<span class="regexp">/u01/data</span><span class="regexp">/3306 --plugin-dir=/u</span>01/mysql/lib/plugin --<span class="keyword">log</span>-error=<span class="regexp">/u01/log</span><span class="regexp">/3306/error</span>.log --<span class="keyword">open</span>-files-limit=<span class="number">65535</span> --pid-file=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysqld</span>.pid --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock --port=<span class="number">3306</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># mysqld方式启动mysql后相关进程</span></span>
<span class="line">ps -ef | <span class="keyword">grep</span> mysql | <span class="keyword">grep</span> -v bash | <span class="keyword">grep</span> -v <span class="keyword">grep</span> | <span class="keyword">grep</span> -v su | <span class="keyword">grep</span> -v ps</span>
<span class="line">mysql     <span class="number">6401</span> <span class="number">18586</span>  <span class="number">2</span> <span class="number">16</span>:<span class="number">36</span> pts/<span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> mysqld --defaults-file=<span class="regexp">/u01/conf</span><span class="regexp">/my3306.cnf</span></span>
</pre></td></tr></table></figure>
<h3 id="MySQL关闭"><a href="#MySQL关闭" class="headerlink" title="MySQL关闭"></a>MySQL关闭</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用mysqld_safe和mysqld启动的关闭方式（推荐的方式）</span></span>
<span class="line">mysqladmin <span class="keyword">shutdown</span></span>
<span class="line">mysqladmin --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock <span class="keyword">shutdown</span> &amp;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 编译安装可以使用的关闭方式</span></span>
<span class="line">cd /u01/mysql/support-files/</span>
<span class="line">./mysql.server stop</span>
<span class="line"></span>
<span class="line"><span class="comment"># rpm安装可以使用的关闭方式</span></span>
<span class="line">/etc/init.d/mysqld stop</span>
<span class="line">service mysqld stop</span>
<span class="line"></span>
<span class="line"><span class="comment"># 多实例关闭方式</span></span>
<span class="line">mysqld_mutil stop</span>
<span class="line"></span>
<span class="line"><span class="comment"># kill进程</span></span>
<span class="line"><span class="keyword">kill</span> -<span class="number">9</span> pid</span>
</pre></td></tr></table></figure>
<h3 id="MySQL登陆"><a href="#MySQL登陆" class="headerlink" title="MySQL登陆"></a>MySQL登陆</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 本地登陆</span></span>
<span class="line">mysql</span>
<span class="line">mysql -u$username -p$password</span>
<span class="line"></span>
<span class="line"><span class="comment"># 远程登陆</span></span>
<span class="line">mysql -u$username -p$password -h$ip</span>
<span class="line"></span>
<span class="line"><span class="comment"># 多实例</span></span>
<span class="line">mysql -u$username -p$password -P$port</span>
<span class="line">mysql --<span class="keyword">socket</span>=<span class="regexp">/u01/run</span><span class="regexp">/3306/mysql</span>.sock --port=<span class="number">3306</span></span>
</pre></td></tr></table></figure>
<h3 id="帐户权限设置-创建-删除用户"><a href="#帐户权限设置-创建-删除用户" class="headerlink" title="帐户权限设置-创建/删除用户"></a>帐户权限设置-创建/删除用户</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> user,host,password from mysql.user;</span>
<span class="line">+------+-----------+----------+</span>
<span class="line">| user | host      | password |</span>
<span class="line">+------+-----------+----------+</span>
<span class="line">| root | localhost |          |     <span class="comment"># 密码都为空，不安全</span></span>
<span class="line">| root | mysql     |          |</span>
<span class="line">| root | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> |          |</span>
<span class="line">| root | ::<span class="number">1</span>       |          |</span>
<span class="line">|      | localhost |          |</span>
<span class="line">|      | mysql     |          |</span>
<span class="line">+------+-----------+----------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># insert方式创建用户(用insert方式创建的用户，需要刷新缓存)</span></span>
<span class="line">insert into mysql.user(user,host,password) <span class="keyword">values</span>(<span class="string">'mytt'</span>,<span class="string">'127.0.0.1'</span>,password(<span class="number">123456</span>));</span>
<span class="line">flush privileges;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> user,host,password from mysql.user;</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line">| user | host      | password                                  |</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line">| root | localhost |                                           |</span>
<span class="line">| root | mysql     |                                           |</span>
<span class="line">| root | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> |                                           |</span>
<span class="line">| root | ::<span class="number">1</span>       |                                           |</span>
<span class="line">|      | localhost |                                           |</span>
<span class="line">|      | mysql     |                                           |</span>
<span class="line">| mytt | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> | *<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># mytt登陆mysql命令如下</span></span>
<span class="line">mysql -umytt -p123456 -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> user();</span>
<span class="line">+----------------+</span>
<span class="line">| user()         |</span>
<span class="line">+----------------+</span>
<span class="line">| mytt@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> |</span>
<span class="line">+----------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># create方式创建用户</span></span>
<span class="line">create user lyj@'%' identified by <span class="string">'123456'</span>;  <span class="comment"># %代表可以从任意位置登陆</span></span>
<span class="line">mysql -ulyj -p123456 -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除用户</span></span>
<span class="line">drop user lyj;</span>
</pre></td></tr></table></figure>
<h3 id="帐户权限设置-用户授权"><a href="#帐户权限设置-用户授权" class="headerlink" title="帐户权限设置-用户授权"></a>帐户权限设置-用户授权</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建新用户并授权</span></span>
<span class="line">grant all privileges on *.* to lyj@'%' identified by <span class="string">'123456'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看用户权限</span></span>
<span class="line">show grants <span class="keyword">for</span> lyj@'%';</span>
<span class="line">+-------------------------------------------------------------------------------------------------------------+</span>
<span class="line">| Grants <span class="keyword">for</span> lyj@%                                                                                            |</span>
<span class="line">+-------------------------------------------------------------------------------------------------------------+</span>
<span class="line">| GRANT ALL PRIVILEGES ON *.* TO <span class="string">'lyj'</span>@'%' IDENTIFIED BY PASSWORD <span class="string">'*6BB4837EB74329105EE4568DDA7DC67ED2CA2AD9'</span> |</span>
<span class="line">+-------------------------------------------------------------------------------------------------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 给已有用户授权</span></span>
<span class="line">grant <span class="keyword">select</span> on *.* to mytt@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>;</span>
<span class="line">show grants <span class="keyword">for</span> mytt@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>;</span>
<span class="line">+--------------------------------------------------------------------------------------------------------------+</span>
<span class="line">| Grants <span class="keyword">for</span> mytt@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>                                                                                    |</span>
<span class="line">+--------------------------------------------------------------------------------------------------------------+</span>
<span class="line">| GRANT SELECT ON *.* TO <span class="string">'mytt'</span>@'<span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span><span class="string">' IDENTIFIED BY PASSWORD '</span>*<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9<span class="string">' |</span>
<span class="line">+--------------------------------------------------------------------------------------------------------------+</span></span>
</pre></td></tr></table></figure>
<h3 id="帐户权限设置-权限等级"><a href="#帐户权限设置-权限等级" class="headerlink" title="帐户权限设置-权限等级"></a>帐户权限设置-权限等级</h3><ol>
<li>核心开发权限 select/insert/delete/update</li>
<li>管理权限–表级 create table/drop table/lock table</li>
<li>管理权限–server级别 create database/create user等</li>
</ol>
<h3 id="MySQL数据库安全配置"><a href="#MySQL数据库安全配置" class="headerlink" title="MySQL数据库安全配置"></a>MySQL数据库安全配置</h3><p>1.禁用/删除多余的管理员帐号，设置用户密码<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除多余的帐号</span></span>
<span class="line"><span class="keyword">delete</span> from mysql.user where user !=<span class="string">'root'</span> <span class="keyword">and</span> password=<span class="string">''</span>;</span>
<span class="line">flush privileges;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用set方式设置root用户密码</span></span>
<span class="line">set password <span class="keyword">for</span> root@localhost = password(<span class="string">'123456'</span>);</span>
<span class="line">set password <span class="keyword">for</span> root@127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> = password(<span class="string">'123456'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用mysqladmin工具设置密码</span></span>
<span class="line"><span class="comment">## 格式: mysqladmin -u用户名 -p旧密码 password 新密码</span></span>
<span class="line"><span class="comment">## 密码为空时，直接输入回车确认</span></span>
<span class="line">mysqladmin -uroot -p password <span class="number">654321</span></span>
<span class="line">Enter password: </span>
<span class="line">Warning: Using a password on the command line interface can be insecure.</span>
<span class="line"></span>
<span class="line"><span class="comment">## 修改已有密码</span></span>
<span class="line">mysqladmin -uroot -p654321 password <span class="number">123456</span></span>
<span class="line"><span class="comment">## 执行后会出现如下警告提示，可以忽略：</span></span>
<span class="line"><span class="comment">## Warning: Using a password on the command line interface can be insecure.</span></span>
<span class="line"><span class="comment">## 翻译过来的意思：在命令行界面上使用密码是不安全的。</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 登陆mysql</span></span>
<span class="line">mysql -uroot -p123456</span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除所有密码为空的帐号</span></span>
<span class="line"><span class="keyword">delete</span> from mysql.user where password=<span class="string">''</span>;</span>
<span class="line">flush privileges;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 确保所有用户都有密码</span></span>
<span class="line"><span class="keyword">select</span> user,host,password from mysql.user;</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line">| user | host      | password                                  |</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
<span class="line">| root | localhost | *<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span>
<span class="line">| root | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> | *<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span>
<span class="line">| mytt | <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span> | *<span class="number">6</span>BB4837EB74329105EE4568DDA7DC67ED2CA2AD9 |</span>
<span class="line">+------+-----------+-------------------------------------------+</span>
</pre></td></tr></table></figure></p>
<p>2.删除掉db表数据(test权限)<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> mysql;</span>
<span class="line"><span class="keyword">truncate</span> table mysql.db;</span>
</pre></td></tr></table></figure></p>
<p>3.删除test库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">drop database test;</span>
</pre></td></tr></table></figure></p>
<p>4.修改管理员帐户名<br>5.密码复杂度要求<br>6.权限最小化</p>
<h3 id="表操作–线上可以直接删除表吗"><a href="#表操作–线上可以直接删除表吗" class="headerlink" title="表操作–线上可以直接删除表吗?"></a>表操作–线上可以直接删除表吗?</h3><p>生产环境上，不可以直接删除表，要删除表步骤如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 构建环境</span></span>
<span class="line">drop database lyj;</span>
<span class="line">create database lyj;</span>
<span class="line"><span class="keyword">use</span> lyj;</span>
<span class="line">create table t1 (id <span class="keyword">int</span>, name varchar(<span class="number">10</span>));</span>
<span class="line">insert into t1 <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">'lyj'</span>);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 1.查看表</span></span>
<span class="line">show tables;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 2.检查表是否被访问</span></span>
<span class="line">show processlist;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 3.重命名临时表</span></span>
<span class="line"><span class="keyword">rename</span> table t1 to t1_bak;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 4.备份临时表</span></span>
<span class="line">mysqldump -uroot -p123456 lyj t1_bak &gt; <span class="regexp">/tmp/lyj</span>_t1_bak_20170223.sql</span>
<span class="line"></span>
<span class="line"><span class="comment"># 5.一段时间后删除临时表</span></span>
<span class="line">drop table t1_bak;</span>
<span class="line">show tables from lyj like <span class="string">'%t1%'</span>;</span>
</pre></td></tr></table></figure></p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show databases;</span>
<span class="line"><span class="keyword">use</span> mysql;</span>
<span class="line">show tables;</span>
<span class="line"><span class="keyword">select</span> user,host,password from mysql.user;</span>
<span class="line">grant all privilege on *.* to test_1@'%';</span>
<span class="line">mysql -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -utest_1</span>
<span class="line"><span class="keyword">select</span> user();</span>
<span class="line">create database jianfeng;</span>
<span class="line">create table user(id <span class="keyword">int</span>,name varchar(<span class="number">10</span>));</span>
<span class="line">grant <span class="keyword">select</span> on jianfeng.user to test_1@'%';</span>
<span class="line">flush privileges;</span>
<span class="line">show master status\G;</span>
<span class="line">change master to xxx;</span>
<span class="line">show engine innodb status\G</span>
<span class="line">show tables from information_schema like <span class="string">'INNODB%'</span>;</span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf &amp;</span>
<span class="line">mysqladmin -S /u01/my3306/run/mysql.sock <span class="keyword">shutdown</span> &amp;</span>
<span class="line"></span>
<span class="line"><span class="regexp">/u01/mysql</span><span class="regexp">/bin/mysql</span>_secure_installation</span>
</pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-04 揭密MySQL databock and binlog的格式]]></title>
      <url>/2017/02/17/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/04-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="1-为什么创建一个InnoDB表只分配了96K而不是1M？"><a href="#1-为什么创建一个InnoDB表只分配了96K而不是1M？" class="headerlink" title="1. 为什么创建一个InnoDB表只分配了96K而不是1M？"></a>1. 为什么创建一个InnoDB表只分配了96K而不是1M？</h2><p>Mysql中<code>extent</code>(区)中是64个连续的<code>page</code>(页)，是分配空间的最小单位，标准大小是1M。 但在用户启用了参数<code>innodb_file_per_table=on</code>后，创建一个Innodb表时，初始分配的大小却是为96K。这是因为在每个段开始时，先用32个页大小的碎片页(fragment page)来存放数据，在使用完这些页之后才是64个连续页的申请。这样做的目的是，对于一些小表，或者是undo这类的段，可以在开始时申请较少的空间，节省磁盘容量的开销。 下面通过示例来显示InnoDB存储引擎对于区的申请方式。</p>
<a id="more"></a>
<h3 id="创建一个测试用的InnoDB表"><a href="#创建一个测试用的InnoDB表" class="headerlink" title="创建一个测试用的InnoDB表"></a>创建一个测试用的InnoDB表</h3><p>创建数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; create database lyj;</span>
</pre></td></tr></table></figure></p>
<p>查看数据库创建信息，并切换到lyj数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show create database lyj;</span>
<span class="line">+----------+--------------------------------------------------------------+</span>
<span class="line">| Database | Create Database                                              |</span>
<span class="line">+----------+--------------------------------------------------------------+</span>
<span class="line">| lyj      | CREATE DATABASE <span class="string">`lyj`</span> /*!<span class="number">40100</span> DEFAULT CHARACTER SET utf8 *<span class="regexp">/ |</span>
<span class="line">+----------+--------------------------------------------------------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; use lyj;</span>
<span class="line"></span>
<span class="line">mysql&gt; select database();</span>
<span class="line">+------------+</span>
<span class="line">| database() |</span>
<span class="line">+------------+</span>
<span class="line">| lyj        |</span>
<span class="line">+------------+</span></span>
</pre></td></tr></table></figure></p>
<p>查看是否启用独享表空间存储方式（innodb_file_per_table=ON），启用后每一个表会单独的生成一个<code>table_name.ibd</code>的文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%per_table%'</span>;</span>
<span class="line">+-----------------------+-------+</span>
<span class="line">| Variable_name         | Value |</span>
<span class="line">+-----------------------+-------+</span>
<span class="line">| innodb_file_per_table | ON    |</span>
<span class="line">+-----------------------+-------+</span>
</pre></td></tr></table></figure></p>
<p>在lyj数据库中创建一张表<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create table lyj_t1 </span>
<span class="line">  (col1 <span class="keyword">int</span> <span class="keyword">not</span> null auto_increment, </span>
<span class="line">   col2 varchar(<span class="number">7000</span>),</span>
<span class="line">   primary key (col1)</span>
<span class="line">  ) engine=innodb;</span>
<span class="line"><span class="comment"># 将col2字段设置为varchar(7000)，这样能保证一个页最多可以存放2条记录</span></span>
</pre></td></tr></table></figure></p>
<p>可通过以下命令查看表的创建信息<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show create table lyj_t1\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">       Table: lyj_t1</span>
<span class="line">Create Table: CREATE TABLE <span class="string">`lyj_t1`</span> (</span>
<span class="line">  <span class="string">`col1`</span> <span class="keyword">int</span>(<span class="number">11</span>) NOT NULL AUTO_INCREMENT,</span>
<span class="line">  <span class="string">`col2`</span> varchar(<span class="number">7000</span>) DEFAULT NULL,</span>
<span class="line">  PRIMARY KEY (<span class="string">`col1`</span>)</span>
<span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span>
</pre></td></tr></table></figure></p>
<h3 id="查验创建表时分配的初始大小为96K"><a href="#查验创建表时分配的初始大小为96K" class="headerlink" title="查验创建表时分配的初始大小为96K"></a>查验创建表时分配的初始大小为96K</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">[mysql@mysql lyj]$ pwd</span>
<span class="line">/u01/my3306/data/lyj</span>
<span class="line">[mysql@mysql lyj]$ ll</span>
<span class="line">total <span class="number">112</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql    <span class="number">61</span> Feb <span class="number">15</span> <span class="number">14</span>:<span class="number">20</span> db.opt</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">29070</span> Feb <span class="number">15</span> <span class="number">17</span>:<span class="number">07</span> lyj_t1.frm   <span class="comment"># frm 表定义</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">98304</span> Feb <span class="number">15</span> <span class="number">17</span>:<span class="number">07</span> lyj_t1.ibd   <span class="comment"># idb 数据和索引 创建初始分配大小是 98304/1024=96K</span></span>
</pre></td></tr></table></figure>
<h3 id="插入数据观察表空间大小变化"><a href="#插入数据观察表空间大小变化" class="headerlink" title="插入数据观察表空间大小变化"></a>插入数据观察表空间大小变化</h3><p>插入2条记录<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">insert into lyj_t1 <span class="keyword">select</span> null, repeat(<span class="string">'a'</span>,<span class="number">7000</span>);</span>
<span class="line">insert into lyj_t1 <span class="keyword">select</span> null, repeat(<span class="string">'a'</span>,<span class="number">7000</span>);</span>
<span class="line"></span>
<span class="line"><span class="keyword">system</span> ls -lh /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">96</span>K Feb <span class="number">15</span> <span class="number">17</span>:<span class="number">16</span> /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line"></span>
<span class="line"><span class="comment"># 这时可以通过py_innodb_page_info工具来查看表空间</span></span>
<span class="line"><span class="comment"># 根据之前对表的定义，插入的这两条记录应该位于同一个页中</span></span>
<span class="line"><span class="comment"># 所有记录都在一个页中，因此这时还没有非叶节点</span></span>
<span class="line">$ python py_innodb_page_info.py -v /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">page offset <span class="number">00000000</span>, page type &lt;File Space Header&gt;</span>
<span class="line">page offset <span class="number">00000001</span>, page type &lt;Insert Buffer Bitmap&gt;</span>
<span class="line">page offset <span class="number">00000002</span>, page type &lt;File Segment inode&gt;</span>
<span class="line">page offset <span class="number">00000003</span>, page type &lt;B-tree Node&gt;, page level &lt;<span class="number">0000</span>&gt;  <span class="comment"># 这个就是数据页，page level表示所在层，0表示页子节点</span></span>
<span class="line">page offset <span class="number">00000000</span>, page type &lt;Freshly Allocated Page&gt;</span>
<span class="line">page offset <span class="number">00000000</span>, page type &lt;Freshly Allocated Page&gt;</span>
<span class="line">Total number of page: <span class="number">6</span>:</span>
<span class="line">Freshly Allocated Page: <span class="number">2</span></span>
<span class="line">Insert Buffer Bitmap: <span class="number">1</span></span>
<span class="line">File Space Header: <span class="number">1</span></span>
<span class="line">B-tree Node: <span class="number">1</span></span>
<span class="line">File Segment inode: <span class="number">1</span></span>
</pre></td></tr></table></figure></p>
<blockquote>
<p><code>py_innodb_page_info</code>工具下载地址：<a href="http://olg2mr2vf.bkt.clouddn.com/py_innodb_page_type.zip" target="_blank" rel="external">py_innodb_page_type.zip</a></p>
</blockquote>
<p>再插入1条记录<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">insert into lyj_t1 <span class="keyword">select</span> null, repeat(<span class="string">'a'</span>,<span class="number">7000</span>);</span>
<span class="line"></span>
<span class="line">$ python py_innodb_page_info.py -v /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">page offset <span class="number">00000000</span>, page type &lt;File Space Header&gt;</span>
<span class="line">page offset <span class="number">00000001</span>, page type &lt;Insert Buffer Bitmap&gt;</span>
<span class="line">page offset <span class="number">00000002</span>, page type &lt;File Segment inode&gt;</span>
<span class="line">page offset <span class="number">00000003</span>, page type &lt;B-tree Node&gt;, page level &lt;<span class="number">0001</span>&gt;</span>
<span class="line">page offset <span class="number">00000004</span>, page type &lt;B-tree Node&gt;, page level &lt;<span class="number">0000</span>&gt;</span>
<span class="line">page offset <span class="number">00000005</span>, page type &lt;B-tree Node&gt;, page level &lt;<span class="number">0000</span>&gt;</span>
<span class="line">Total number of page: <span class="number">6</span>:</span>
<span class="line">Insert Buffer Bitmap: <span class="number">1</span></span>
<span class="line">File Space Header: <span class="number">1</span></span>
<span class="line">B-tree Node: <span class="number">3</span></span>
<span class="line">File Segment inode: <span class="number">1</span></span>
</pre></td></tr></table></figure></p>
<p>创建批量插入数据的存储过程<br><figure class="highlight"><table><tr><td class="code"><pre><span class="line">drop procedure if exists load_t1;</span>
<span class="line">delimiter //</span>
<span class="line">create procedure load_t1(count int unsigned)</span>
<span class="line">begin</span>
<span class="line">  declare s int unsigned default 1;</span>
<span class="line">  declare c varchar(7000) default repeat('a', 7000);</span>
<span class="line">    while s&lt;= count do</span>
<span class="line">    insert into lyj_t1 select null,c;</span>
<span class="line">    set s=s+1;</span>
<span class="line">  end while;</span>
<span class="line">end;</span>
<span class="line">//</span>
<span class="line">delimiter;</span>
</pre></td></tr></table></figure></p>
<p>调用存储过程，插入60条记录后观察表空间大小<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; call load_t1(<span class="number">60</span>);</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> count(*) from lyj_t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|       <span class="number">63</span> |</span>
<span class="line">+----------+</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">system</span> ls -lh /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">576</span>K Feb <span class="number">15</span> <span class="number">18</span>:<span class="number">10</span> /u01/my3306/data/lyj/lyj_t1.ibd</span>
</pre></td></tr></table></figure></p>
<p>再插入1条记录后观察表空间大小<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; call load_t1(<span class="number">1</span>);</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> count(*) from lyj_t1;</span>
<span class="line">+----------+</span>
<span class="line">| count(*) |</span>
<span class="line">+----------+</span>
<span class="line">|       <span class="number">64</span> |</span>
<span class="line">+----------+</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">system</span> ls -lh /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">2.0</span>M Feb <span class="number">15</span> <span class="number">18</span>:<span class="number">15</span> /u01/my3306/data/lyj/lyj_t1.ibd</span>
<span class="line"><span class="comment"># 因为已经用完了32个碎片页，新的页就会采用区的方式进行空间的申请</span></span>
</pre></td></tr></table></figure></p>
<h2 id="2-Innodb数据块解析，解析第2行记录格式"><a href="#2-Innodb数据块解析，解析第2行记录格式" class="headerlink" title="2. Innodb数据块解析，解析第2行记录格式"></a>2. Innodb数据块解析，解析第2行记录格式</h2><h3 id="创建测试表并插入数据"><a href="#创建测试表并插入数据" class="headerlink" title="创建测试表并插入数据"></a>创建测试表并插入数据</h3><p>创建测试用数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">drop database lyj;</span>
<span class="line">create database lyj DEFAULT CHARACTER SET gbk COLLATE gbk_chinese_ci;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看当前数据库中存在那些数据库，以及数据库创建信息</span></span>
<span class="line">show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| lyj                |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">| test               |</span>
<span class="line">+--------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 显示数据库创建信息，若加\G参数是格式化输出信息</span></span>
<span class="line">show create database lyj;</span>
<span class="line">+----------+-------------------------------------------------------------+</span>
<span class="line">| Database | Create Database                                             |</span>
<span class="line">+----------+-------------------------------------------------------------+</span>
<span class="line">| lyj      | CREATE DATABASE <span class="string">`lyj`</span> /*!<span class="number">40100</span> DEFAULT CHARACTER SET gbk *<span class="regexp">/ |</span>
<span class="line">+----------+-------------------------------------------------------------+</span>
<span class="line"></span>
<span class="line">show create database lyj\G</span>
<span class="line">*************************** 1. row ***************************</span>
<span class="line">       Database: lyj</span>
<span class="line">Create Database: CREATE DATABASE `lyj` /</span>*!<span class="number">40100</span> DEFAULT CHARACTER SET gbk *<span class="regexp">/</span></span>
</pre></td></tr></table></figure></p>
<p>使用lyj数据库<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> lyj</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看当前选择的数据库</span></span>
<span class="line"><span class="keyword">select</span> database();</span>
<span class="line">+------------+</span>
<span class="line">| database() |</span>
<span class="line">+------------+</span>
<span class="line">| lyj        |</span>
<span class="line">+------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># 若要删除数据库可使用以下命令</span></span>
<span class="line">drop database lyj;</span>
</pre></td></tr></table></figure></p>
<p>关闭自动提交<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%autocommit%'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| autocommit    | ON    |</span>
<span class="line">+---------------+-------+</span>
<span class="line"></span>
<span class="line">set autocommit = <span class="number">0</span>;</span>
<span class="line"></span>
<span class="line">show variables like <span class="string">'%autocommit%'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| autocommit    | OFF   |</span>
<span class="line">+---------------+-------+</span>
</pre></td></tr></table></figure></p>
<p>在lyj数据库中创建表并插入测试数据<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create table lyj_t1 </span>
<span class="line">  (id <span class="keyword">int</span>,name1 varchar(<span class="number">10</span>),name2 varchar(<span class="number">10</span>),name3 varchar(<span class="number">10</span>),name4 varchar(<span class="number">10</span>),name5 varchar(<span class="number">10</span>));</span>
<span class="line"></span>
<span class="line">show tables;</span>
<span class="line">+---------------+</span>
<span class="line">| Tables_in_lyj |</span>
<span class="line">+---------------+</span>
<span class="line">| lyj_t1        |</span>
<span class="line">+---------------+</span>
<span class="line"></span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'A'</span>,<span class="string">'BB'</span>,<span class="string">'CCC'</span>,<span class="string">'DDDD'</span>,null);</span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">'aaaaaaaaaa'</span>,<span class="string">'bbbbbbbbbb'</span>,<span class="string">'ccccc'</span>,<span class="string">''</span>,null);</span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">'aaaaaaaaaa'</span>,<span class="string">'bbbbbbbbbb'</span>,<span class="string">'ccccc'</span>,<span class="string">'dddddd'</span>,<span class="string">'e'</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">'aaaaaaaaaa'</span>,<span class="string">'bbbbbbbbbb'</span>,null,<span class="string">'dddddd'</span>,<span class="string">'e'</span>);</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from lyj_t1;</span>
<span class="line">+------+------------+------------+-------+--------+-------+</span>
<span class="line">| id   | name1      | name2      | name3 | name4  | name5 |</span>
<span class="line">+------+------------+------------+-------+--------+-------+</span>
<span class="line">|    <span class="number">1</span> | A          | BB         | CCC   | DDDD   | NULL  |</span>
<span class="line">|    <span class="number">2</span> | aaaaaaaaaa | bbbbbbbbbb | ccccc |        | NULL  |</span>
<span class="line">|    <span class="number">3</span> | aaaaaaaaaa | bbbbbbbbbb | ccccc | dddddd | e     |</span>
<span class="line">|    <span class="number">4</span> | aaaaaaaaaa | bbbbbbbbbb | NULL  | dddddd | e     |</span>
<span class="line">+------+------------+------------+-------+--------+-------+</span>
</pre></td></tr></table></figure></p>
<h3 id="解析数据块"><a href="#解析数据块" class="headerlink" title="解析数据块"></a>解析数据块</h3><h4 id="使用hexdump工具导出表空间文件前4个块"><a href="#使用hexdump工具导出表空间文件前4个块" class="headerlink" title="使用hexdump工具导出表空间文件前4个块"></a>使用hexdump工具导出表空间文件前4个块</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 一个page 16k, 导出的16进制文件一行是16byte ==&gt; 1个page在16制文件中有1024 row，即一个块是1024行</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 导出第1个块 File Space Header</span></span>
<span class="line">hexdump -C -v /u01/my3306/data/lyj/lyj_t1.ibd | head -n <span class="number">1024</span> &gt; <span class="regexp">/tmp/</span><span class="number">1</span>.txt</span>
<span class="line"></span>
<span class="line"><span class="comment"># 导出第2个块 Insert Buffer Bitmap</span></span>
<span class="line">hexdump -C -v /u01/my3306/data/lyj/lyj_t1.ibd | head -n <span class="number">2048</span> | tail -n <span class="number">1024</span> &gt; <span class="regexp">/tmp/</span><span class="number">2</span>.txt</span>
<span class="line"></span>
<span class="line"><span class="comment"># 导出第3个块 File Segment inode</span></span>
<span class="line">hexdump -C -v /u01/my3306/data/lyj/lyj_t1.ibd | head -n <span class="number">3072</span> | tail -n <span class="number">1024</span> &gt; <span class="regexp">/tmp/</span><span class="number">3</span>.txt</span>
<span class="line"></span>
<span class="line"><span class="comment"># 导出第4个块 Used Page，也就是行记录开始处</span></span>
<span class="line">hexdump -C -v /u01/my3306/data/lyj/lyj_t1.ibd | head -n <span class="number">4096</span> | tail -n <span class="number">1024</span> &gt; <span class="regexp">/tmp/</span><span class="number">4</span>.txt</span>
</pre></td></tr></table></figure>
<p>使用sz工具下载到windows本地查看，需要先secureCRT会话设置里先设置本地下载路径<br><img src="http://oligvdnzp.bkt.clouddn.com/securecrt_01.png" alt="secureCRT中本地地址路径设置"></p>
<p>下载命令<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">sz /tmp/<span class="number">1</span>.txt</span>
<span class="line">sz /tmp/<span class="number">2</span>.txt</span>
<span class="line">sz /tmp/<span class="number">3</span>.txt</span>
<span class="line">sz /tmp/<span class="number">4</span>.txt</span>
</pre></td></tr></table></figure></p>
<h4 id="查看导出块类型标识"><a href="#查看导出块类型标识" class="headerlink" title="查看导出块类型标识"></a>查看导出块类型标识</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/innodb_block_01.png" alt="第1个块 File Space Header    标识(偏移量19开始)：0x0008"> 第1个块类型标识：0x0008<br><img src="http://oligvdnzp.bkt.clouddn.com/innodb_block_02.png" alt="第2个块 Insert Buffer Bitmap 标识(偏移量19开始)：0x0005"> 第2个块类型标识：0x0005<br><img src="http://oligvdnzp.bkt.clouddn.com/innodb_block_03.png" alt="第3个块 File Segment inode   标识(偏移量19开始)：0x0003"> 第3个块类型标识：0x0003<br><img src="http://oligvdnzp.bkt.clouddn.com/innodb_block_04.png" alt="第4个块 Used Page            标识(偏移量19开始)：0x45BF"> 第4个块类型标识：0x45BF</p>
<h4 id="查看行记录格式"><a href="#查看行记录格式" class="headerlink" title="查看行记录格式"></a>查看行记录格式</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show table status like <span class="string">'%lyj_t1%'</span>\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">           Name: lyj_t1</span>
<span class="line">         Engine: InnoDB</span>
<span class="line">        Version: <span class="number">10</span></span>
<span class="line">     Row_format: Compact       <span class="comment"># 行的格式是Compact（简洁的）</span></span>
<span class="line">           Rows: <span class="number">4</span></span>
<span class="line"> Avg_row_length: <span class="number">4096</span></span>
<span class="line">    Data_length: <span class="number">16384</span></span>
<span class="line">Max_data_length: <span class="number">0</span></span>
<span class="line">   Index_length: <span class="number">0</span></span>
<span class="line">      Data_free: <span class="number">0</span></span>
<span class="line"> Auto_increment: NULL</span>
<span class="line">    Create_time: <span class="number">2017</span>-<span class="number">02</span>-<span class="number">16</span> <span class="number">10</span>:<span class="number">20</span>:<span class="number">15</span></span>
<span class="line">    Update_time: NULL</span>
<span class="line">     Check_time: NULL</span>
<span class="line">      Collation: gbk_chinese_ci</span>
<span class="line">       Checksum: NULL</span>
<span class="line"> Create_options: </span>
<span class="line">        Comment:</span>
</pre></td></tr></table></figure>
<h4 id="Compact行记录结构"><a href="#Compact行记录结构" class="headerlink" title="Compact行记录结构"></a>Compact行记录结构</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/compact.png" alt="Compact行记录结构"></p>
<h4 id="解析块头"><a href="#解析块头" class="headerlink" title="解析块头"></a>解析块头</h4><p>记录是放在第4个块中，下面详细解析<code>/tmp/4.txt</code>文件<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1    0000c000  51 07 91 31 00 00 00 03  ff ff ff ff ff ff ff ff  |Q..1............|</span>
<span class="line">2    0000c010  00 00 00 00 00 2b d4 0d  45 bf 00 00 00 00 00 00  |.....+..E.......|</span>
<span class="line">3    0000c020  00 00 00 00 00 13 00 02  01 5b 80 06 00 00 00 00  |.........[......|</span>
<span class="line">4    0000c030  01 29 00 02 00 03 00 04  00 00 00 00 00 00 00 00  |.)..............|</span>
<span class="line">5    0000c040  00 00 00 00 00 00 00 00  00 24 00 00 00 13 00 00  |.........$......|</span>
<span class="line">6    0000c050  00 02 00 f2 00 00 00 13  00 00 00 02 00 32 01 00  |.............2..|</span>
<span class="line">7    0000c060  02 00 1f 69 6e 66 69 6d  75 6d 00 05 00 0b 00 00  |...infimum......|</span>
<span class="line">8    0000c070  73 75 70 72 65 6d 75 6d  04 03 02 01 20 00 00 10  |supremum.... ...|</span>
<span class="line">9    0000c080  00 2b 00 00 00 00 02 0a  00 00 00 00 0e 56 95 00  |.+...........V..|</span>
<span class="line">10   0000c090  00 01 42 01 10 80 00 00  01 41 42 42 43 43 43 44  |..B......ABBCCCD|</span>
<span class="line">11   0000c0a0  44 44 44 00 05 0a 0a 20  00 00 18 00 3b 00 00 00  |DDD.... ....;...|</span>
<span class="line">12   0000c0b0  00 02 0b 00 00 00 00 0e  56 95 00 00 01 42 01 1e  |........V....B..|</span>
<span class="line">13   0000c0c0  80 00 00 02 61 61 61 61  61 61 61 61 61 61 62 62  |....aaaaaaaaaabb|</span>
<span class="line">14   0000c0d0  62 62 62 62 62 62 62 62  63 63 63 63 63 01 06 05  |bbbbbbbbccccc...|</span>
<span class="line">15   0000c0e0  0a 0a 00 00 00 20 00 41  00 00 00 00 02 0c 00 00  |..... .A........|</span>
<span class="line">16   0000c0f0  00 00 0e 56 95 00 00 01  42 01 2c 80 00 00 03 61  |...V....B.,....a|</span>
<span class="line">17   0000c100  61 61 61 61 61 61 61 61  61 62 62 62 62 62 62 62  |aaaaaaaaabbbbbbb|</span>
<span class="line">18   0000c110  62 62 62 63 63 63 63 63  64 64 64 64 64 64 65 01  |bbbcccccdddddde.|</span>
<span class="line">19   0000c120  06 0a 0a 08 00 00 28 ff  47 00 00 00 00 02 0d 00  |......(.G.......|</span>
<span class="line">20   0000c130  00 00 00 0e 5e 98 00 00  01 45 01 10 80 00 00 04  |....^....E......|</span>
<span class="line">21   0000c140  61 61 61 61 61 61 61 61  61 61 62 62 62 62 62 62  |aaaaaaaaaabbbbbb|</span>
<span class="line">22   0000c150  62 62 62 62 64 64 64 64  64 64 65 00 00 00 00 00  |bbbbdddddde.....|</span>
<span class="line">     ......</span>
<span class="line">1024 0000fff0  00 00 00 00 00 70 00 63  f2 c3 5d 27 00 2b d4 0d  |.....p.c..]&apos;.+..|</span>
</pre></td></tr></table></figure></p>
<ul>
<li>第1行中的<code>51 07 91 31</code>和最后一行的<code>f2 c3 5d 27</code>是checksum，调用mysql中的一个校验函数，若检验不一致判断该块有问题</li>
<li>第1行中的<code>00 00 00 03</code>，代表这是第几个page(0开始)，这里代表是第4个page</li>
<li>第1行中的<code>ff ff ff ff ff ff ff ff</code>中前4个字节代表记录上一页指针地址，后4个字节代表记录下一页指针地址，全是<code>f</code>代表上一页和下一页无记录</li>
<li>第2行中的<code>00 00 00 00 00 2b d4 0d</code>是日志地址，LSN(Log Segment Number)，其中后4个字节和块最后一行后4个字节<code>00 2b d4 0d</code>是一致的</li>
<li>第2行中的<code>45 bf</code>代表页（块）的类型</li>
<li>第3行中的<code>00 00 00 13</code>代表tablespace的编号</li>
<li>第3行中的<code>00 02</code>代表有两个slot，对应块最后一行尾部的<code>00 70 00 63</code>，每2个字节代表一个slot</li>
<li>第3行中的<code>01 5b</code>代表该页下一行的空闲开始位置，也就是<code>0000c15b</code></li>
<li>第3行中的<code>80 06</code>能算出块中有几行记录，compact中该值初始是8002，8006-8002=4，代表该页有4行记录</li>
<li>第3行中的<code>00 00 00 00</code>代表可重用字节，这里没有删除过记录，值都是0</li>
<li>第4行中的<code>01 29</code>代表最后一行记录的开始位置，也就是该块中第4行记录的开始位置</li>
<li>第4行中的<code>00 02 00 03</code>其中<code>00 02</code>为往右插，<code>00 03</code>为连续插入3次</li>
<li>第4行中的<code>00 04</code>代表有4行记录</li>
<li>第4行中的<code>00 00 00 00 00 00 00 00</code>代表页上最大事务数</li>
<li>第5行中的<code>00 00</code>代表page level <0000>，也就是叶子节点</0000></li>
<li>第5行中的<code>00 00 00 00 00 00 00 24</code>代表索引的ID</li>
<li>第5-6行中的<code>00 00 00 13 00 00 00 02 00 f2</code> 代表段头管理非叶节点的</li>
<li>第6行中的<code>00 00 00 13  00 00 00 02 00 32</code> 代表段头管理叶节点的</li>
<li>第6-7行中的<code>01 00 02 00 1f</code>代表最小虚拟值的行头，固定的5个节点</li>
<li>第7行中的<code>69 6e 66 69 6d 75 6d 00</code>代表的就是infimum，8个字节，后面的<code>00</code>占位</li>
<li>第7行中的<code>05 00 0b 00 00</code>代表最大虚拟值的行头，固定的5个节点</li>
<li>第8行中的<code>73 75 70 72 65 6d 75 6d</code>代表的就是supremum，8个字节</li>
</ul>
<h4 id="解析第1行记录"><a href="#解析第1行记录" class="headerlink" title="解析第1行记录"></a>解析第1行记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">8    0000c070  73 75 70 72 65 6d 75 6d  04 03 02 01 20 00 00 10  |supremum.... ...|</span>
<span class="line">9    0000c080  00 2b 00 00 00 00 02 0a  00 00 00 00 0e 56 95 00  |.+...........V..|</span>
<span class="line">10   0000c090  00 01 42 01 10 80 00 00  01 41 42 42 43 43 43 44  |..B......ABBCCCD|</span>
<span class="line">11   0000c0a0  44 44 44 00 05 0a 0a 20  00 00 18 00 3b 00 00 00  |DDD.... ....;...|</span>
</pre></td></tr></table></figure>
<ul>
<li>第8行中的<code>04 03 02 01</code>代表变长字段长度列表，逆序，表中5个字段类型为varchar，有NULL数据</li>
<li>第8行中的<code>20</code>代表null标志位，第1行记录有null值，十六进制<code>20</code>转成二进制是100000，逆序，表中一共6列，1表示第6列为null，0表示其他列有值</li>
<li>第8-9行中的<code>00 00 10 00 2b</code> 是记录头信息，固定5个字节  c078(本行记录开位置)+2b(偏移量)=c0a3(下一行记录开始位置)</li>
<li>第9行中的<code>00 00 00 00 02 0a</code> 是RowID，固定6个字节，表没有主键</li>
<li>第9行中的<code>00 00 00 00 0e 56</code> 是事务ID，固定6个字节</li>
<li>第9-10行中的<code>95 00 00 01 42 01 10</code> 回滚指针Roll Pointer，固定7个字节</li>
<li>第10行中的<code>80 00 00 01</code> 是ID列int 占4字节 值是1</li>
<li>第10-11行的<code>41 42 42 43 43 43 44 44 44 44</code>是列的数据，结合变长字段长度列表，可以算出varchar每列的值<ul>
<li>第2列 41</li>
<li>第3列 42 42 </li>
<li>第4列 43 43 43 </li>
<li>第5列 44 44 44 44</li>
<li>第6列 null</li>
</ul>
</li>
</ul>
<h4 id="解析第2行记录"><a href="#解析第2行记录" class="headerlink" title="解析第2行记录"></a>解析第2行记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">11   0000c0a0  44 44 44 00 05 0a 0a 20  00 00 18 00 3b 00 00 00  |DDD.... ....;...|</span>
<span class="line">12   0000c0b0  00 02 0b 00 00 00 00 0e  56 95 00 00 01 42 01 1e  |........V....B..|</span>
<span class="line">13   0000c0c0  80 00 00 02 61 61 61 61  61 61 61 61 61 61 62 62  |....aaaaaaaaaabb|</span>
<span class="line">14   0000c0d0  62 62 62 62 62 62 62 62  63 63 63 63 63 01 06 05  |bbbbbbbbccccc...|</span>
</pre></td></tr></table></figure>
<p>从第1行记录解析中，已可算出，第二行开始位置为c0a3</p>
<ul>
<li>第11行中的<code>00 05 0a 0a</code>代表变长字段长度列表，逆序，表中5个字段类型为varchar，有NULL数据</li>
<li>第11行中的<code>20</code>代表null标志位，第2行记录有null值，十六进制<code>20</code>转成二进制是100000，逆序，表中一共6列，1表示第6列为null，0表示其他列有值</li>
<li>第11行中的<code>00 00 18 00 3b</code> 是记录头信息，固定5个字节   c0a3(本行记录开位置)+3b(偏移量)=c0de(下一行记录开始位置)</li>
<li>第11-12行中的<code>00 00 00 00 02 0b</code> 是RowID，固定6个字节，表没有主键</li>
<li>第12行中的<code>00 00 00 00 0e 56</code> 是事务ID，固定6个字节</li>
<li>第12中的<code>95 00 00 01 42 01 1e</code> 回滚指针Roll Pointer，固定7个字节</li>
<li>第13行中的<code>80 00 00 02</code> 是ID列int 占4字节 值是2</li>
<li>第13-14行的<code>61 61 61 61 61 61 61 61 61 61 62 62 62 62 62 62 62 62 62 62 63 63 63 63 63</code>是列的数据，结合变长字段长度列表，可以算出varchar每列的值<ul>
<li>第2列 61 61 61 61 61 61 61 61 61 61</li>
<li>第3列 62 62 62 62 62 62 62 62 62 62 </li>
<li>第4列 63 63 63 63 63</li>
<li>第5列 空值</li>
<li>第6列 null</li>
</ul>
</li>
</ul>
<h4 id="解析第3行记录"><a href="#解析第3行记录" class="headerlink" title="解析第3行记录"></a>解析第3行记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">14   0000c0d0  62 62 62 62 62 62 62 62  63 63 63 63 63 01 06 05  |bbbbbbbbccccc...|</span>
<span class="line">15   0000c0e0  0a 0a 00 00 00 20 00 41  00 00 00 00 02 0c 00 00  |..... .A........|</span>
<span class="line">16   0000c0f0  00 00 0e 56 95 00 00 01  42 01 2c 80 00 00 03 61  |...V....B.,....a|</span>
<span class="line">17   0000c100  61 61 61 61 61 61 61 61  61 62 62 62 62 62 62 62  |aaaaaaaaabbbbbbb|</span>
<span class="line">18   0000c110  62 62 62 63 63 63 63 63  64 64 64 64 64 64 65 01  |bbbcccccdddddde.|</span>
</pre></td></tr></table></figure>
<ul>
<li>第14-15行中的<code>01 06 05 0a 0a</code>代表变长字段长度列表，逆序，表中5个字段类型为varchar，没有NULL数据</li>
<li>第15行中的<code>00</code>代表null标志位，00表示没有null值</li>
<li>第15行中的<code>00 00 20 00 41</code> 是记录头信息，固定5个字节</li>
<li>第15行中的<code>00 00 00 00 02 0c</code> 是RowID，固定6个字节，表没有主键</li>
<li>第15-16行中的<code>00 00 00 00 0e 56</code> 是事务ID，固定6个字节</li>
<li>第16中的<code>95 00 00 01 42 01 2c</code> 回滚指针Roll Pointer，固定7个字节</li>
<li>第16行中的<code>80 00 00 03</code> 是ID列int 占4字节 值是3</li>
<li>第16-18行的<code>61 61 61 61 61 61 61 61 61 61 62 62 62 62 62 62 62 62 62 62 63 63 63 63 63 64 64 64 64 64 64 65</code>是列的数据，结合变长字段长度列表，可以算出varchar每列的值<ul>
<li>第2列 61 61 61 61 61 61 61 61 61 61</li>
<li>第3列 62 62 62 62 62 62 62 62 62 62 </li>
<li>第4列 63 63 63 63 63</li>
<li>第5列 64 64 64 64 64 64</li>
<li>第6列 65</li>
</ul>
</li>
</ul>
<h4 id="解析第4行记录"><a href="#解析第4行记录" class="headerlink" title="解析第4行记录"></a>解析第4行记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">18   0000c110  62 62 62 63 63 63 63 63  64 64 64 64 64 64 65 01  |bbbcccccdddddde.|</span>
<span class="line">19   0000c120  06 0a 0a 08 00 00 28 ff  47 00 00 00 00 02 0d 00  |......(.G.......|</span>
<span class="line">20   0000c130  00 00 00 0e 5e 98 00 00  01 45 01 10 80 00 00 04  |....^....E......|</span>
<span class="line">21   0000c140  61 61 61 61 61 61 61 61  61 61 62 62 62 62 62 62  |aaaaaaaaaabbbbbb|</span>
<span class="line">22   0000c150  62 62 62 62 64 64 64 64  64 64 65 00 00 00 00 00  |bbbbdddddde.....|</span>
</pre></td></tr></table></figure>
<ul>
<li>第18-19行中的<code>01 06 0a 0a</code>代表变长字段长度列表，逆序，表中5个字段类型为varchar，有NULL数据</li>
<li>第19行中的<code>08</code>代表null标志位，十六进制<code>08</code>转成二进制是001000，逆序，表中一共6列，1表示第4列为null，0表示其他列有值</li>
<li>第19行中的<code>00 00 28 ff 47</code> 是记录头信息，固定5个字节</li>
<li>第19行中的<code>00 00 00 00 02 0d</code> 是RowID，固定6个字节，表没有主键</li>
<li>第19-20行中的<code>00 00 00 00 0e 5e</code> 是事务ID，固定6个字节，这里事务ID已经变化</li>
<li>第20中的<code>98 00 00  01 45 01 10</code> 回滚指针Roll Pointer，固定7个字节</li>
<li>第20行中的<code>80 00 00 04</code> 是ID列int 占4字节 值是4</li>
<li>第16-18行的<code>61 61 61 61 61 61 61 61  61 61 62 62 62 62 62 62 62 62 62 62 64 64 64 64  64 64 65</code>是列的数据，结合变长字段长度列表，可以算出varchar每列的值<ul>
<li>第2列 61 61 61 61 61 61 61 61 61 61</li>
<li>第3列 62 62 62 62 62 62 62 62 62 62 </li>
<li>第4列 NULL</li>
<li>第5列 64 64 64 64 64 64</li>
<li>第5列 65</li>
</ul>
</li>
</ul>
<h2 id="3-详细描述commit命令发出后，binlog日志从内存写到磁盘的过程？"><a href="#3-详细描述commit命令发出后，binlog日志从内存写到磁盘的过程？" class="headerlink" title="3.详细描述commit命令发出后，binlog日志从内存写到磁盘的过程？"></a>3.详细描述commit命令发出后，binlog日志从内存写到磁盘的过程？</h2><h3 id="重启数据库"><a href="#重启数据库" class="headerlink" title="重启数据库"></a>重启数据库</h3><p>重启数据库生成新的binlog，便于观察测试<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysqladmin <span class="keyword">shutdown</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf &amp;</span>
<span class="line"></span>
<span class="line">[mysql@mysql binlog]$ pwd</span>
<span class="line">/u01/my3306/<span class="keyword">log</span>/binlog</span>
<span class="line">[mysql@mysql binlog]$ ll</span>
<span class="line">total <span class="number">928</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">933537</span> Feb <span class="number">17</span> <span class="number">16</span>:<span class="number">38</span> binlog.<span class="number">000007</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql    <span class="number">391</span> Feb <span class="number">17</span> <span class="number">16</span>:<span class="number">54</span> binlog.<span class="number">00000</span>8</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql    <span class="number">120</span> Feb <span class="number">17</span> <span class="number">16</span>:<span class="number">54</span> binlog.<span class="number">00000</span>9</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql    <span class="number">111</span> Feb <span class="number">17</span> <span class="number">16</span>:<span class="number">54</span> binlog.index</span>
</pre></td></tr></table></figure></p>
<h3 id="用一个update事务做测试"><a href="#用一个update事务做测试" class="headerlink" title="用一个update事务做测试"></a>用一个update事务做测试</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> lyj;</span>
<span class="line">begin;</span>
<span class="line">update lyj_t1 set name1=<span class="string">'aaaaaaa'</span> where id=<span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h3 id="查看binlog"><a href="#查看binlog" class="headerlink" title="查看binlog"></a>查看binlog</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 未commit前</span></span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line">| Log_name      | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line">| binlog.<span class="number">00000</span>9 |   <span class="number">4</span> | Format_desc |       <span class="number">101</span> |         <span class="number">120</span> | Server ver: <span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span>, Binlog ver: <span class="number">4</span> |</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line"></span>
<span class="line"><span class="comment"># commit后</span></span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">show binlog events in <span class="string">'binlog.000009'</span>;</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line">| Log_name      | Pos | Event_type  | Server_id | End_log_pos | Info                                  |</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line">| binlog.<span class="number">00000</span>9 |   <span class="number">4</span> | Format_desc |       <span class="number">101</span> |         <span class="number">120</span> | Server ver: <span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span>, Binlog ver: <span class="number">4</span> |</span>
<span class="line">| binlog.<span class="number">00000</span>9 | <span class="number">120</span> | Query       |       <span class="number">101</span> |         <span class="number">191</span> | BEGIN                                 |</span>
<span class="line">| binlog.<span class="number">00000</span>9 | <span class="number">191</span> | Table_map   |       <span class="number">101</span> |         <span class="number">254</span> | table_id: <span class="number">70</span> (lyj.lyj_t1)             |</span>
<span class="line">| binlog.<span class="number">00000</span>9 | <span class="number">254</span> | Update_rows |       <span class="number">101</span> |         <span class="number">339</span> | table_id: <span class="number">70</span> flags: STMT_END_F        |</span>
<span class="line">| binlog.<span class="number">00000</span>9 | <span class="number">339</span> | Xid         |       <span class="number">101</span> |         <span class="number">370</span> | COMMIT /* xid=<span class="number">9</span> *<span class="regexp">/                    |</span>
<span class="line">+---------------+-----+-------------+-----------+-------------+---------------------------------------+</span>
<span class="line"></span>
<span class="line"># 也可用以下命令查看</span>
<span class="line">mysqlbinlog -v -v binlog.000009</span></span>
</pre></td></tr></table></figure>
<h3 id="Binlog日志生成的流程"><a href="#Binlog日志生成的流程" class="headerlink" title="Binlog日志生成的流程"></a>Binlog日志生成的流程</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/0217_binlog_01.png" alt="Binlog日志生成的流程"></p>
<ol>
<li>事务commit后，日志会被write到标准I/O cache里面，每个线程是单独缓存的，线程间的日志彼此独立，不能看到不同线程的日志，这时若发生crash，日志会丢失</li>
<li>write后，每个线程的日志会flush到OS file cache里，这时日志是全局可见的，每个线程都能看到这个日志，若此时crash，日志也会丢失</li>
<li>sync操作会从日志内存里把日志写到disk中，达到持久化。</li>
</ol>
<h3 id="相关的参数"><a href="#相关的参数" class="headerlink" title="相关的参数"></a>相关的参数</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'sync_binlog'</span>;</span>
<span class="line">+---------------+-------+</span>
<span class="line">| Variable_name | Value |</span>
<span class="line">+---------------+-------+</span>
<span class="line">| sync_binlog   | <span class="number">100</span>   |    <span class="comment"># 代表做100次commit再写binlog，一般设置成1，保证数据的一致性</span></span>
<span class="line">+---------------+-------+</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">00</span> sec)</span>
<span class="line"></span>
<span class="line">mysql&gt; show variables like <span class="string">'innodb_flush_log_at_trx_commit'</span>;</span>
<span class="line">+--------------------------------+-------+</span>
<span class="line">| Variable_name                  | Value |</span>
<span class="line">+--------------------------------+-------+</span>
<span class="line">| innodb_flush_log_at_trx_commit | <span class="number">1</span>     |   <span class="comment"># 一般设置成1，保证数据的一致性</span></span>
<span class="line">+--------------------------------+-------+</span>
<span class="line"><span class="number">1</span> row in set (<span class="number">0</span>.<span class="number">01</span> sec)</span>
</pre></td></tr></table></figure>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><h3 id="查看innodb默认块的大小"><a href="#查看innodb默认块的大小" class="headerlink" title="查看innodb默认块的大小"></a>查看innodb默认块的大小</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%innodb_page_size%'</span>;</span>
<span class="line">+------------------+-------+</span>
<span class="line">| Variable_name    | Value |</span>
<span class="line">+------------------+-------+</span>
<span class="line">| innodb_page_size | <span class="number">16384</span> |</span>
<span class="line">+------------------+-------+</span>
</pre></td></tr></table></figure>
<h3 id="查看文件格式"><a href="#查看文件格式" class="headerlink" title="查看文件格式"></a>查看文件格式</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%file_format%'</span>;</span>
<span class="line">+--------------------------+-----------+</span>
<span class="line">| Variable_name            | Value     |</span>
<span class="line">+--------------------------+-----------+</span>
<span class="line">| innodb_file_format       | Barracuda |    <span class="comment"># Barracuda[,bærə''kudə] 梭鱼类</span></span>
<span class="line">| innodb_file_format_check | ON        |</span>
<span class="line">| innodb_file_format_max   | Antelope  |    <span class="comment"># Antelope['æntɪlop] 羚羊 </span></span>
<span class="line">+--------------------------+-----------+</span>
</pre></td></tr></table></figure>
<p>从下图可以看出<code>Antelope</code>只包括<code>Redundant</code>（已废弃）和<code>Compact</code>，故建议将<code>innodb_file_format_max</code>也设置为<code>Barracuda</code><br><img src="http://oligvdnzp.bkt.clouddn.com/0216_file_format.png" alt="innodb文件格式"></p>
<h3 id="查看tablespace编号"><a href="#查看tablespace编号" class="headerlink" title="查看tablespace编号"></a>查看tablespace编号</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> * from information_schema.innodb_sys_tables where name like <span class="string">'%lyj_t1%'</span>;</span>
<span class="line">+----------+----------------------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line">| TABLE_ID | NAME                       | FLAG | N_COLS | SPACE | FILE_FORMAT | ROW_FORMAT | ZIP_PAGE_SIZE |</span>
<span class="line">+----------+----------------------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line">|       <span class="number">14</span> | SYS_DATAFILES              |    <span class="number">0</span> |      <span class="number">5</span> |     <span class="number">0</span> | Antelope    | Redundant  |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">11</span> | SYS_FOREIGN                |    <span class="number">0</span> |      <span class="number">7</span> |     <span class="number">0</span> | Antelope    | Redundant  |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">12</span> | SYS_FOREIGN_COLS           |    <span class="number">0</span> |      <span class="number">7</span> |     <span class="number">0</span> | Antelope    | Redundant  |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">13</span> | SYS_TABLESPACES            |    <span class="number">0</span> |      <span class="number">6</span> |     <span class="number">0</span> | Antelope    | Redundant  |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">27</span> | lyj/lyj_t1                 |    <span class="number">1</span> |      <span class="number">5</span> |    <span class="number">13</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">16</span> | mysql/innodb_index_stats   |    <span class="number">1</span> |     <span class="number">11</span> |     <span class="number">2</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">15</span> | mysql/innodb_table_stats   |    <span class="number">1</span> |      <span class="number">9</span> |     <span class="number">1</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">18</span> | mysql/slave_master_info    |    <span class="number">1</span> |     <span class="number">26</span> |     <span class="number">4</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">17</span> | mysql/slave_relay_log_info |    <span class="number">1</span> |     <span class="number">11</span> |     <span class="number">3</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">|       <span class="number">19</span> | mysql/slave_worker_info    |    <span class="number">1</span> |     <span class="number">15</span> |     <span class="number">5</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">+----------+----------------------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line"></span>
<span class="line">mysql&gt; <span class="keyword">select</span> * from information_schema.innodb_sys_tables where name like <span class="string">'%lyj_t1%'</span>;</span>
<span class="line">+----------+------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line">| TABLE_ID | NAME       | FLAG | N_COLS | SPACE | FILE_FORMAT | ROW_FORMAT | ZIP_PAGE_SIZE |</span>
<span class="line">+----------+------------+------+--------+-------+-------------+------------+---------------+</span>
<span class="line">|       <span class="number">30</span> | lyj/lyj_t1 |    <span class="number">1</span> |      <span class="number">5</span> |    <span class="number">16</span> | Antelope    | Compact    |             <span class="number">0</span> |</span>
<span class="line">+----------+------------+------+--------+-------+-------------+------------+---------------+</span>
</pre></td></tr></table></figure>
<h3 id="查看未提交事务ID"><a href="#查看未提交事务ID" class="headerlink" title="查看未提交事务ID"></a>查看未提交事务ID</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set autocommit = <span class="number">0</span>;</span>
<span class="line"></span>
<span class="line">insert into lyj_t1 <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">'aaaaaaaaaa'</span>,<span class="string">'bbbbbbbbbb'</span>,<span class="string">'ccccc'</span>,<span class="string">'dddddd'</span>,<span class="string">'e'</span>);</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from information_schema.innodb_sys_idx\G;</span>
<span class="line">*************************** <span class="number">1</span>. row ***************************</span>
<span class="line">                    trx_id: <span class="number">3694</span></span>
<span class="line">                 trx_state: RUNNING</span>
<span class="line">               trx_started: <span class="number">2017</span>-<span class="number">02</span>-<span class="number">17</span> <span class="number">15</span>:<span class="number">42</span>:<span class="number">41</span></span>
<span class="line">     trx_requested_lock_id: NULL</span>
<span class="line">          trx_wait_started: NULL</span>
<span class="line">                trx_weight: <span class="number">2</span></span>
<span class="line">       trx_mysql_thread_id: <span class="number">23</span></span>
<span class="line">                 trx_query: <span class="keyword">select</span> * from information_schema.innodb_trx</span>
<span class="line">       trx_operation_state: NULL</span>
<span class="line">         trx_tables_in_use: <span class="number">0</span></span>
<span class="line">         trx_tables_locked: <span class="number">0</span></span>
<span class="line">          trx_lock_structs: <span class="number">1</span></span>
<span class="line">     trx_lock_memory_bytes: <span class="number">360</span></span>
<span class="line">           trx_rows_locked: <span class="number">0</span></span>
<span class="line">         trx_rows_modified: <span class="number">1</span></span>
<span class="line">   trx_concurrency_tickets: <span class="number">0</span></span>
<span class="line">       trx_isolation_level: REPEATABLE READ</span>
<span class="line">         trx_unique_checks: <span class="number">1</span></span>
<span class="line">    trx_foreign_key_checks: <span class="number">1</span></span>
<span class="line">trx_last_foreign_key_error: NULL</span>
<span class="line"> trx_adaptive_hash_latched: <span class="number">0</span></span>
<span class="line"> trx_adaptive_hash_timeout: <span class="number">10000</span></span>
<span class="line">          trx_is_read_only: <span class="number">0</span></span>
<span class="line">trx_autocommit_non_locking: <span class="number">0</span></span>
<span class="line"></span>
<span class="line">rollback;</span>
</pre></td></tr></table></figure>
<h3 id="转换成16进制函数"><a href="#转换成16进制函数" class="headerlink" title="转换成16进制函数"></a>转换成16进制函数</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">hex</span>(<span class="string">'infimum'</span>);</span>
<span class="line">+----------------+</span>
<span class="line">| <span class="keyword">hex</span>(<span class="string">'infimum'</span>) |</span>
<span class="line">+----------------+</span>
<span class="line">| <span class="number">696</span>E66696D756D |</span>
<span class="line">+----------------+</span>
</pre></td></tr></table></figure>
<h3 id="文件结构图"><a href="#文件结构图" class="headerlink" title="文件结构图"></a>文件结构图</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/innodb_file_s.png" alt="文件结构"></p>
<h3 id="Page结构图"><a href="#Page结构图" class="headerlink" title="Page结构图"></a>Page结构图</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/innodb_page_s.png" alt="Page结构"></p>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[那些在11gR2中可能惹祸的新特性]]></title>
      <url>/2017/02/16/oracle/%E9%82%A3%E4%BA%9B%E5%9C%A811gR2%E4%B8%AD%E5%8F%AF%E8%83%BD%E6%83%B9%E7%A5%B8%E7%9A%84%E6%96%B0%E7%89%B9%E6%80%A7/</url>
      <content type="html"><![CDATA[<p>有很多朋友因为11gR2那些潜在的特性可能给升级后系统稳定运行带来麻烦而无法鼓足升级到11gR2的勇气，实际Oracle在开发新版本RDBMS软件时引入的一些特性有很好的理念的，但是往往这些理念会给已稳定的应用环境带来变数，最显著的就是10g/9i升级到11gR2时的执行计划稳定性，此外adaptive cursor sharing 自适应游标、automatic serial direct path自动判断串行直接路径读、deferred segment creation、GC read mostly DRM…….等等的一系列特性已经在大量的案例中被证明是不适合于大量国产Application的。</p>
<p>这篇文章里想做的是给出一张列表，能够将11gR2的优化器optimizer特性、和其他的如上列的这些可能引起问题的特性通过参数的方式给出一张列表，你可以选择性的禁用这些特性，前提是你的Applicaiton就该特性经过充分的测试，如果没有时间或者环境来测试这些新特性，那么还不如禁用这些特性，禁用新特性的结果也仅仅是回到老版本(一般是10gR2 10.2.0.4)的默认表现上来。<br><a id="more"></a><br>你肯定要问：“如果都禁用了11gR2的特性，那么我还升级做什么？”</p>
<p>回答是：首先这里给出的是一张禁用11gR2特性列表，如果你对部分特性已经很熟悉，那么你可以选择性而非全部地禁用这些特性，如果不熟悉也测试不了，那么无畏给稳定的系统引入不确定因素。其次这里列出的仅仅是11gR2部分默认已启用的可能”惹祸”的特性， 其他的一些特性例如flashback archive、securefile，它们默认不开启，本身需要你去手动打开才会生效，并不会受到这张列表的影响。</p>


	<div class="row">
    <embed src="http://ol3rzmg8c.bkt.clouddn.com/%E9%82%A3%E4%BA%9B11gR2%E4%B8%AD%E6%83%B9%E7%A5%B8%E7%9A%84%E7%89%B9%E6%80%A7%E5%85%B3%E9%97%AD%E5%88%97%E8%A1%A8.pdf" width="100%" height="550" type="application/pdf">
	</div>



<blockquote>
<p>转载自：<a href="http://www.askmaclean.com/" target="_blank" rel="external">AskMaclean</a></p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> 11g </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hexo更换主题并个性化定制]]></title>
      <url>/2017/02/10/tools/hexo%E6%9B%B4%E6%8D%A2%E4%B8%BB%E9%A2%98%E5%B9%B6%E4%B8%AA%E6%80%A7%E5%8C%96%E5%AE%9A%E5%88%B6/</url>
      <content type="html"><![CDATA[<blockquote>
<p>hexo系统默认的主题虽然也不错，但我更喜欢<a href="http://moxfive.xyz/yelee" target="_blank" rel="external">yelee</a>和<a href="https://github.com/litten/hexo-theme-yilia" target="_blank" rel="external">yilia</a>这两款主题</p>
</blockquote>
<h2 id="安装yelee主题"><a href="#安装yelee主题" class="headerlink" title="安装yelee主题"></a>安装yelee主题</h2><ol>
<li><p>主题说明文档：<a href="http://moxfive.coding.me/yelee" target="_blank" rel="external"><code>http://moxfive.coding.me/yelee/</code></a></p>
</li>
<li><p>在博客根目录下执行以下命令</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 克隆最新一次提交（git clone速度很慢，可只克隆最新一次提交）</span></span>
<span class="line">git clone --depth <span class="number">1</span> https:<span class="regexp">//github</span>.com/MOxFIVE/hexo-theme-yelee.git themes/yelee</span>
</pre></td></tr></table></figure>
</li>
<li><p>编辑修改根目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># theme: landscape</span></span>
<span class="line">theme: yelee</span>
</pre></td></tr></table></figure>
</li>
<li><p>更换主题后需要清理并重新生成静态页</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo g &amp;&amp; hexo s</span>
</pre></td></tr></table></figure>
</li>
<li><p>安装搜索插件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-generator-search --save</span>
</pre></td></tr></table></figure>
</li>
<li><p>参照文档修改<code>themes\yelee</code>目录下的<code>_config.yml</code>文件</p>
</li>
</ol>
<a id="more"></a>
<h2 id="安装yilia主题"><a href="#安装yilia主题" class="headerlink" title="安装yilia主题"></a>安装yilia主题</h2><ol>
<li><p>在博客根目录下执行以下命令</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">git clone https:<span class="regexp">//github</span>.com/litten/hexo-theme-yilia.git themes/yilia</span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line">git clone git@github.com:litten/hexo-theme-yilia.git themes/yilia</span>
<span class="line"></span>
<span class="line"><span class="comment"># 克隆最新一次提交（git clone速度很慢，可只克隆最新一次提交）</span></span>
<span class="line">git clone --depth <span class="number">1</span> https:<span class="regexp">//github</span>.com/litten/hexo-theme-yilia.git themes/yilia</span>
</pre></td></tr></table></figure>
</li>
<li><p>在博客根目录（注意不是yilia根目录）执行以下命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm i hexo-generator-json-content --save</span>
</pre></td></tr></table></figure>
</li>
<li><p>编辑修改根目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># theme: landscape</span></span>
<span class="line">theme: yilia</span>
<span class="line"></span>
<span class="line"><span class="comment"># 添加以下内容</span></span>
<span class="line"><span class="comment"># jsonContent</span></span>
<span class="line">jsonContent:</span>
<span class="line">    meta: false</span>
<span class="line">    pages: false</span>
<span class="line">    posts:</span>
<span class="line">      title: true</span>
<span class="line">      date: true</span>
<span class="line">      path: true</span>
<span class="line">      text: true</span>
<span class="line">      raw: false</span>
<span class="line">      content: false</span>
<span class="line">      slug: false</span>
<span class="line">      updated: false</span>
<span class="line">      comments: false</span>
<span class="line">      <span class="keyword">link</span>: false</span>
<span class="line">      permalink: false</span>
<span class="line">      excerpt: false</span>
<span class="line">      categories: false</span>
<span class="line">      tags: true</span>
</pre></td></tr></table></figure>
</li>
<li><p>更换主题后需要清理并重新生成静态页</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo clean</span>
<span class="line">hexo g</span>
<span class="line">hexo s</span>
</pre></td></tr></table></figure>
</li>
<li><p>更换后效果<br><img src="http://oligvdnzp.bkt.clouddn.com/update_theme.png" alt="update_theme.png"></p>
</li>
<li><p>编辑修改<code>themes\yilia</code>目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 修改menu</span></span>
<span class="line">menu:</span>
<span class="line">  主页: <span class="regexp">/</span>
<span class="line">  归档: /archives</span><span class="regexp">/</span>
<span class="line">  #随笔: /tags</span><span class="regexp">/随笔/</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改并注释掉不需要的项</span></span>
<span class="line"><span class="comment"># SubNav</span></span>
<span class="line">subnav:</span>
<span class="line">  github: <span class="string">"https://github.com/dbanote"</span></span>
<span class="line">  weibo: <span class="string">"http://weibo.com/foxbei"</span></span>
<span class="line">  <span class="comment">#rss: "#"</span></span>
<span class="line">  <span class="comment">#zhihu: "#"</span></span>
<span class="line">  qq: <span class="string">"http://sighttp.qq.com/msgrd?v=1&amp;uin=9320802"</span></span>
<span class="line">  <span class="comment">#weixin: "#"</span></span>
<span class="line">  <span class="comment">#jianshu: "#"</span></span>
<span class="line">  <span class="comment">#douban: "#"</span></span>
<span class="line">  mail: <span class="string">"mailto:15004618839@139.com"</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 文章太长，截断按钮文字</span></span>
<span class="line"><span class="comment"># 截断需要在文章中添加 &lt;!--more--&gt;</span></span>
<span class="line"><span class="comment">#excerpt_link: more</span></span>
<span class="line">excerpt_link: false</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置打赏二维码</span></span>
<span class="line"><span class="comment"># 打赏基础设定：0-关闭打赏； 1-文章对应的md文件里有reward:true属性，才有打赏； 2-所有文章均有打赏</span></span>
<span class="line">reward_type: <span class="number">2</span></span>
<span class="line"><span class="comment"># 打赏wording</span></span>
<span class="line">reward_wording: <span class="string">'喜欢的话，支付1元请我吃糖吧！'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 支付宝二维码图片地址，跟你设置头像的方式一样。比如：/assets/img/alipay.jpg</span></span>
<span class="line"><span class="comment"># 支付宝收款1元二维码图片</span></span>
<span class="line">alipay: <span class="regexp">/img/zhifubao</span>01.png</span>
<span class="line"><span class="comment"># 支付宝收款无金额设置二维码图片</span></span>
<span class="line"><span class="comment"># alipay: /img/zhifubao.png</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 微信二维码图片地址</span></span>
<span class="line"><span class="comment"># 微信收款1元二维码图片</span></span>
<span class="line">weixin: <span class="regexp">/img/weixin</span>01.png</span>
<span class="line"><span class="comment"># 微信收款无金额设置二维码图片</span></span>
<span class="line"><span class="comment"># alipay: /img/weixin.png</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 修改网站收藏夹图标</span></span>
<span class="line">favicon: <span class="regexp">/img/favicon</span>.png</span>
<span class="line"></span>
<span class="line"><span class="comment">#你的头像url</span></span>
<span class="line">avatar: <span class="regexp">/img/avatar</span>.jpg</span>
<span class="line"></span>
<span class="line"><span class="comment"># 根据需要修改以下内容</span></span>
<span class="line"><span class="comment"># 智能菜单</span></span>
<span class="line"><span class="comment"># 如不需要，将该对应项置为false</span></span>
<span class="line"><span class="comment"># 比如</span></span>
<span class="line"><span class="comment">#smart_menu:</span></span>
<span class="line"><span class="comment">#  friends: false</span></span>
<span class="line">smart_menu:</span>
<span class="line">  innerArchive: <span class="string">'所有文章'</span></span>
<span class="line">  friends: <span class="string">'常用网站'</span></span>
<span class="line">  aboutme: <span class="string">'关于我'</span></span>
<span class="line"></span>
<span class="line">friends:</span>
<span class="line">  My Oracle Support: https:<span class="regexp">//support</span>.oracle.com/</span>
<span class="line">  Oracle Edelivery: https:<span class="regexp">//edelivery</span>.oracle.com/</span>
<span class="line">  Oracle Help Center: http:<span class="regexp">//docs</span>.oracle.com/</span>
<span class="line">  练数成金: http:<span class="regexp">//www</span>.dataguru.cn/</span>
<span class="line">  三通IT论坛: http:<span class="regexp">//www</span>.santongit.com/</span>
<span class="line">  一起自学吧: http:<span class="regexp">//www</span>.<span class="number">17</span>zixueba.com/</span>
<span class="line"></span>
<span class="line">aboutme: DBA&lt;br&gt;&lt;br&gt;工作学习笔记&lt;br&gt;谢谢大家</span>
</pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> hexo </tag>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hexo博客添加常用插件]]></title>
      <url>/2017/02/10/tools/hexo%E5%8D%9A%E5%AE%A2%E6%B7%BB%E5%8A%A0%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6/</url>
      <content type="html"><![CDATA[<p>Hexo提供了诸多插件来增强博客体验，地址<a href="http://hexo.io/plugins/" target="_blank" rel="external"><code>http://hexo.io/plugins</code></a></p>
<h2 id="添加pdf浏览插件"><a href="#添加pdf浏览插件" class="headerlink" title="添加pdf浏览插件"></a>添加pdf浏览插件</h2><h3 id="安装hexo-pdf"><a href="#安装hexo-pdf" class="headerlink" title="安装hexo-pdf"></a>安装<a href="https://github.com/superalsrk/hexo-pdf" target="_blank" rel="external">hexo-pdf</a></h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cnpm install --save hexo-pdf</span>
</pre></td></tr></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">&#123;% pdf http:<span class="regexp">//</span><span class="number">7</span>xov2f.com1.z<span class="number">0</span>.glb.clouddn.com/bash_freshman.pdf %&#125;</span>
<span class="line">&#123;% pdf ./bash_freshman.pdf %&#125;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="添加生成文章目录插件hexo-toc"><a href="#添加生成文章目录插件hexo-toc" class="headerlink" title="添加生成文章目录插件hexo-toc"></a>添加生成文章目录插件hexo-toc</h2><ol>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-toc --save</span>
</pre></td></tr></table></figure>
</li>
<li><p>配置<br>在博客根目录下的<code>_config.yml</code>中如下配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">toc:</span>
<span class="line">  maxdepth: 3</span>
</pre></td></tr></table></figure>
</li>
<li><p>使用<br>在Markdown中需要显示文章目录的地方添加 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- toc --&gt;</span>
</pre></td></tr></table></figure>
</li>
</ol>
<h2 id="添加百度统计支持"><a href="#添加百度统计支持" class="headerlink" title="添加百度统计支持"></a>添加百度统计支持</h2><p><code>yilia</code>主题自带统计支持</p>
<ol>
<li><p>打开<a href="http://tongji.baidu.com/web/welcome/login" target="_blank" rel="external">百度统计</a>网站，注册账号<br><img src="http://oligvdnzp.bkt.clouddn.com/baidu_stat_01.png" alt="baidu_stat_01.png"></p>
</li>
<li><p>填写注册信息<br><img src="http://oligvdnzp.bkt.clouddn.com/baidu_stat_02.png" alt="baidu_stat_02.png"></p>
</li>
<li><p>记录百度统计ID号码<br><img src="http://oligvdnzp.bkt.clouddn.com/baidu_stat_03.png" alt="baidu_stat_03.png"></p>
</li>
<li><p>编辑修改<code>themes\yilia</code>目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Miscellaneous</span></span>
<span class="line">baidu_analytics: <span class="string">'xxxxxxxxxxxx'</span>   <span class="comment"># xxxxxx是刚获得的百度统计ID号码</span></span>
</pre></td></tr></table></figure>
</li>
<li><p>统计代码安装检查，确保代码安装正确<br><img src="http://oligvdnzp.bkt.clouddn.com/baidu_stat_04.png" alt="baidu_stat_04.png"></p>
</li>
</ol>
<h2 id="添加多说评论支持"><a href="#添加多说评论支持" class="headerlink" title="添加多说评论支持"></a>添加多说评论支持</h2><ol>
<li><p>打开<a href="http://duoshuo.com/" target="_blank" rel="external">多说</a>网站<br><img src="http://oligvdnzp.bkt.clouddn.com/duoshuo_01.png" alt="duoshuo_01.png"></p>
</li>
<li><p>选择微信登陆<br><img src="http://oligvdnzp.bkt.clouddn.com/duoshuo_02.png" alt="duoshuo_02.png"></p>
</li>
<li><p>点击<code>我要安装</code><br><img src="http://oligvdnzp.bkt.clouddn.com/duoshuo_03.png" alt="duoshuo_03.png"></p>
</li>
<li><p>填写相应信息<br><img src="http://oligvdnzp.bkt.clouddn.com/duoshuo_04.png" alt="duoshuo_04.png"></p>
</li>
<li><p>编辑修改<code>themes\yilia</code>目录下的<code>_config.yml</code>文件</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#是否开启多说评论，开启填写你在多说申请的项目的short_name: dbanote</span></span>
<span class="line"><span class="comment">#duoshuo: false</span></span>
<span class="line">duoshuo: dbanote</span>
</pre></td></tr></table></figure>
</li>
</ol>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul>
<li><a href="http://www.ituring.com.cn/article/199624" target="_blank" rel="external">Hexo站点中添加文章目录以及归档</a></li>
<li><a href="http://www.cnblogs.com/peihao/p/5269131.html" target="_blank" rel="external">hexo优化目录</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> hexo </tag>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[GIT常用命令整理]]></title>
      <url>/2017/02/10/tools/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="基本信息设置与查看"><a href="#基本信息设置与查看" class="headerlink" title="基本信息设置与查看"></a>基本信息设置与查看</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git config --global user.name &apos;dbanote&apos;</span>
<span class="line">git config --global user.email &apos;15004618839@139.com&apos;</span>
<span class="line"></span>
<span class="line">git config --list</span>
</pre></td></tr></table></figure>
<h2 id="初始化git仓库"><a href="#初始化git仓库" class="headerlink" title="初始化git仓库"></a>初始化git仓库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git init</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="向本地仓库中添加-修改文件"><a href="#向本地仓库中添加-修改文件" class="headerlink" title="向本地仓库中添加/修改文件"></a>向本地仓库中添加/修改文件</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加/修改/删除工作区文件后，保存变动内容到暂存区</span></span>
<span class="line">git add &lt;file&gt;</span>
<span class="line">git add *</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看暂存区状态</span></span>
<span class="line">git status</span>
<span class="line"></span>
<span class="line"><span class="comment"># 暂存区内容提交到git仓库</span></span>
<span class="line">git commit -<span class="keyword">m</span> <span class="string">"git init"</span></span>
</pre></td></tr></table></figure>
<h2 id="PUSH远程仓库"><a href="#PUSH远程仓库" class="headerlink" title="PUSH远程仓库"></a>PUSH远程仓库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git remote add origin git@github.com:dbanote/08_dbanote.git</span>
<span class="line">git push -u origin master</span>
</pre></td></tr></table></figure>
<h2 id="克隆远程仓库"><a href="#克隆远程仓库" class="headerlink" title="克隆远程仓库"></a>克隆远程仓库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone git@github.com:dbanote/08_dbanote.git</span>
</pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> tools </tag>
            
            <tag> git </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hexo+github搭建个人博客]]></title>
      <url>/2017/02/06/tools/hexo+github%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
      <content type="html"><![CDATA[<h2 id="前言：我的博客之旅"><a href="#前言：我的博客之旅" class="headerlink" title="前言：我的博客之旅"></a>前言：我的博客之旅</h2><p>我用<code>wordpress</code>写过一段时间博客，因租用的外国空间访问速度不理想，放弃！<br>我用<code>vimwiki</code>写过一段时间博客，因其配置、更新博客比较麻烦，且生成的html也需要存放到租用的空间上才能共享，放弃！<br>我在类似CSDN免费空间上也写过一段时间博客，因没有客户端工具，在线编辑功能受限，且本地不能保存备份博客，放弃！<br>这两年我一直用有道云笔记写博客，其本地编辑功能比较强大，有易用的分类目录和标签功能，单条博客也易于分享，但缺乏一个整体对外的窗口，文章中的代码也无法实现高亮显示，不够美观！<br>2017年初，偶然的机会知道了hexo，因有较强的markdown和git功底，决定开启hexo写博之旅。</p>
<blockquote>
<p><strong>hexo是什么?</strong><br>hexo是一款基于Node.js的静态博客框架。 hexo官网地址：<a href="https://hexo.io" target="_blank" rel="external">https://hexo.io</a></p>
</blockquote>
<a id="more"></a>
<h2 id="为什么选择Hexo"><a href="#为什么选择Hexo" class="headerlink" title="为什么选择Hexo"></a>为什么选择Hexo</h2><p>目前比较流行的静态博客框架有<a href="http://jekyllrb.com/" target="_blank" rel="external">Jekyll</a>，Hexo，Simple，Octopress，Pelican以及Lo·gecho等。 这些静态博客框架各有各的好处，之所以选择Hexo，最主要的原因如下：</p>
<ol>
<li>Hexo基于Node.js实现，在Windows上安装Node.js环境简单；而其他的静态博客框架如Jekyll基于Ruby实现，不建议在Windows下搭建的。</li>
<li>Hexo有本地WEB服务器，能实现本地预览，并直接发布到WEB容器(github)中实现同步；而Jekyll没有本地服务器，无法实现本地博文预览。</li>
<li>Hexo主题丰富，基本直接就可以用，不需要太多的修改。</li>
<li>支持Markdown语法。</li>
</ol>
<h2 id="搭建本地博客"><a href="#搭建本地博客" class="headerlink" title="搭建本地博客"></a>搭建本地博客</h2><h3 id="下载并安装git和Node-js"><a href="#下载并安装git和Node-js" class="headerlink" title="下载并安装git和Node.js"></a>下载并安装git和Node.js</h3><p>从以下地址下载所需的Windows版安装包，使用默认设置安装：</p>
<ul>
<li>Node.js: <a href="https://nodejs.org" target="_blank" rel="external">https://nodejs.org</a></li>
<li>git: <a href="https://git-scm.com" target="_blank" rel="external">https://git-scm.com</a></li>
</ul>
<p>安装成功后，可通过以下命令查看安装版本：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ node -v</span>
<span class="line">v6.9.4</span>
<span class="line"></span>
<span class="line">$ git --version</span>
<span class="line">git version 2.11.1.windows.1</span>
</pre></td></tr></table></figure></p>
<h3 id="配置Git-Bash样式（可选）"><a href="#配置Git-Bash样式（可选）" class="headerlink" title="配置Git Bash样式（可选）"></a>配置Git Bash样式（可选）</h3><p>新建<code>D:\08_dbanote</code>目录做为博客根目录，进入目录，右键选择Git Bash Here<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-here.jpg" alt="git-bash-here.jpg"></p>
<p>在弹出的窗口上右键选择Options，设置窗口样式<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-01.png" alt="git-bash-01.jpg"></p>
<p>设置显示字体<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-02.jpg" alt="git-bash-02.jpg"></p>
<p>设置窗口大小(需重新开启Git Bash方可生效)<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-03.jpg" alt="git-bash-03.jpg"></p>
<p>设置鼠标右健直接粘贴<br><img src="http://oligvdnzp.bkt.clouddn.com/git-bash-04.jpg" alt="git-bash-04.jpg"></p>
<h3 id="安装淘宝的cnpm源"><a href="#安装淘宝的cnpm源" class="headerlink" title="安装淘宝的cnpm源"></a>安装淘宝的cnpm源</h3><p>访问国外源速度较慢，建议安装淘宝的cnpm源，以后使用<code>cnpm</code>命令代替<code>npm</code><br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span>
</pre></td></tr></table></figure></p>
<h3 id="安装hexo-g-是全局化安装"><a href="#安装hexo-g-是全局化安装" class="headerlink" title="安装hexo (-g 是全局化安装)"></a>安装hexo (-g 是全局化安装)</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-cli -g</span>
</pre></td></tr></table></figure>
<h3 id="初始化hexo博客"><a href="#初始化hexo博客" class="headerlink" title="初始化hexo博客"></a>初始化hexo博客</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 确保当前目录为博客根目录</span></span>
<span class="line">cd D:\08_dbanote</span>
<span class="line">hexo init</span>
<span class="line">cnpm install</span>
</pre></td></tr></table></figure>
<h3 id="安装git部署包"><a href="#安装git部署包" class="headerlink" title="安装git部署包"></a>安装git部署包</h3><p>作用：通过<code>hexo d</code>这一条命令，将博客部署到git服务器上，如github<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cnpm install hexo-deployer-git --save</span>
</pre></td></tr></table></figure></p>
<h3 id="生成博客静态文件"><a href="#生成博客静态文件" class="headerlink" title="生成博客静态文件"></a>生成博客静态文件</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo g</span>
</pre></td></tr></table></figure>
<h3 id="启动本地服务器"><a href="#启动本地服务器" class="headerlink" title="启动本地服务器"></a>启动本地服务器</h3><p>确保4000端口没有被占用<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在windows命令行下执行</span></span>
<span class="line">netstat -ano | findstr <span class="string">"4000"</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>:<span class="number">0</span>              LISTENING       <span class="number">16360</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">53443</span>        ESTABLISHED     <span class="number">16360</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">63485</span>        CLOSE_WAIT      <span class="number">16360</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">53443</span>        <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         ESTABLISHED     <span class="number">14256</span></span>
<span class="line">  TCP    <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">63485</span>        <span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">4000</span>         FIN_WAIT_2      <span class="number">14256</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 4000端口被占用，查找进程号对应的程序</span></span>
<span class="line">tasklist | findstr <span class="string">"16360"</span></span>
<span class="line">FoxitProtect.exe             <span class="number">16360</span> Services                   <span class="number">0</span>     <span class="number">11</span>,<span class="number">628</span> K</span>
<span class="line"></span>
<span class="line"><span class="comment"># 结束该进程</span></span>
<span class="line">taskkill /f /t /im FoxitProtect.exe</span>
</pre></td></tr></table></figure></p>
<p>启动本地服务器<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">hexo <span class="keyword">s</span></span>
<span class="line"><span class="comment">#---------------------------------------------------------------------</span></span>
<span class="line">INFO  Start processing</span>
<span class="line">INFO  Hexo is running at http:<span class="regexp">//localhost</span>:<span class="number">4000</span>/. Press Ctrl+C to stop.</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------</span></span>
</pre></td></tr></table></figure></p>
<h3 id="本地预览博客"><a href="#本地预览博客" class="headerlink" title="本地预览博客"></a>本地预览博客</h3><p>打开浏览器，输入<a href="http://localhost:4000" target="_blank" rel="external">http://localhost:4000</a><br><img src="http://oligvdnzp.bkt.clouddn.com/hexo_init.png" alt="hexo_init.png"></p>
<h3 id="配置博客网站基本信息"><a href="#配置博客网站基本信息" class="headerlink" title="配置博客网站基本信息"></a>配置博客网站基本信息</h3><p>编辑修改根目录下的<code>_config.yml</code>文件<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 站点基本信息修改</span></span>
<span class="line"><span class="comment"># Site</span></span>
<span class="line">title: 一个DBA的工作学习笔记</span>
<span class="line">subtitle: 欲事之无繁，则必劳于始而逸于终</span>
<span class="line">author: 刘雅君</span>
<span class="line"></span>
<span class="line"><span class="comment"># 设置网站url</span></span>
<span class="line"><span class="comment"># URL</span></span>
<span class="line">url: http:<span class="regexp">//dbanote</span>.github.io</span>
<span class="line"></span>
<span class="line"><span class="comment"># 取消代码段行号显示</span></span>
<span class="line"><span class="comment"># Writing</span></span>
<span class="line">highlight:</span>
<span class="line">  enable: true</span>
<span class="line">  line_number: false</span>
</pre></td></tr></table></figure></p>
<h2 id="部署远程博客"><a href="#部署远程博客" class="headerlink" title="部署远程博客"></a>部署远程博客</h2><h3 id="注册Github账号"><a href="#注册Github账号" class="headerlink" title="注册Github账号"></a>注册Github账号</h3><p>因为是托管到<a href="https://github.com/" target="_blank" rel="external">Github</a>上，所以第一步需要注册一个账号。这里我新注册了一个dbanote的帐号，步骤很简单，这里不做赘述。</p>
<h3 id="建立和用户名对应的仓库"><a href="#建立和用户名对应的仓库" class="headerlink" title="建立和用户名对应的仓库"></a>建立和用户名对应的仓库</h3><p>建立和用户名相对应的仓库，这是什么意思呢？以我的例子来说，我的用户名是dbanote,那么我的博客仓库就必须是dbanote.github.io。<br><img src="http://oligvdnzp.bkt.clouddn.com/github_01.png" alt="创建新仓库"><br><img src="http://oligvdnzp.bkt.clouddn.com/github_02.png" alt="创建新仓库"></p>
<h3 id="配置SSH公钥"><a href="#配置SSH公钥" class="headerlink" title="配置SSH公钥"></a>配置SSH公钥</h3><p>远程代码是基于SSH的，所以需要SSH的相关配置。方法是现在本地生成SSH公钥，然后添加到Github上面。打开<code>git bash</code>，具体的操作如下：</p>
<h4 id="1-设置你的邮箱和用户名"><a href="#1-设置你的邮箱和用户名" class="headerlink" title="1. 设置你的邮箱和用户名"></a>1. 设置你的邮箱和用户名</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">git config --global user.name <span class="string">"dbanote"</span></span>
<span class="line">git config --global user.email <span class="string">"15004618839@139.com"</span></span>
</pre></td></tr></table></figure>
<h4 id="2-生成密钥，设置密码，输入的密码不显示（也可以不设置，按三次回车，密码为空）"><a href="#2-生成密钥，设置密码，输入的密码不显示（也可以不设置，按三次回车，密码为空）" class="headerlink" title="2. 生成密钥，设置密码，输入的密码不显示（也可以不设置，按三次回车，密码为空）"></a>2. 生成密钥，设置密码，输入的密码不显示（也可以不设置，按三次回车，密码为空）</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"15004618839@139.com"</span></span>
</pre></td></tr></table></figure>
<p>上述的命令成功后，会得到<code>id_rsa</code>和<code>id_rsa.pub</code>两个文件，一般在<code>C:\Users\&lt;用户名&gt;\.ssh</code>文件夹里，没有的话，就用Everything搜一下。</p>
<h4 id="3-把SSH密钥添加到Github上"><a href="#3-把SSH密钥添加到Github上" class="headerlink" title="3. 把SSH密钥添加到Github上"></a>3. 把SSH密钥添加到Github上</h4><p>登陆<code>Github</code>后，点击<code>settings</code>，然后进入<code>SSH keys</code>，把<code>id_rsa.pub</code>文件里内容添加进去就好了。 测试配置是否正确<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">$ ssh -T git@github.com</span>
<span class="line">Hi dbanote! You’ve successfully authenticated, but GitHub does <span class="keyword">not</span> provide shell access.</span>
</pre></td></tr></table></figure></p>
<h3 id="部署远程博客-1"><a href="#部署远程博客-1" class="headerlink" title="部署远程博客"></a>部署远程博客</h3><h4 id="1-编辑修改根目录下的-config-yml文件"><a href="#1-编辑修改根目录下的-config-yml文件" class="headerlink" title="1. 编辑修改根目录下的_config.yml文件"></a>1. 编辑修改根目录下的<code>_config.yml</code>文件</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置部署到github(https方式出现错误，使用ssh方式成功)</span></span>
<span class="line"><span class="comment"># Deployment</span></span>
<span class="line"><span class="comment">## Docs: https://hexo.io/docs/deployment.html</span></span>
<span class="line">deploy:</span>
<span class="line">  type: git</span>
<span class="line">  repository: git@github.com:dbanote/dbanote.github.io.git</span>
<span class="line">  branch: master</span>
</pre></td></tr></table></figure>
<h4 id="2-部署远程博客，输入以下命令"><a href="#2-部署远程博客，输入以下命令" class="headerlink" title="2. 部署远程博客，输入以下命令"></a>2. 部署远程博客，输入以下命令</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成静态页</span></span>
<span class="line">hexo g</span>
<span class="line"></span>
<span class="line"><span class="comment"># 部署到github上</span></span>
<span class="line">hexo d</span>
</pre></td></tr></table></figure>
<p>部署好了后，在浏览器地址栏中输入你的仓库名来访问，我的是<a href="http://dbanote.github.io" target="_blank" rel="external">dbanote.github.io</a>。注意一点，第一次部署的话，可能需要等待一会（一般不到10分钟就好了）才能生效，以后每次部署就可以直接访问。到这里基本的博客就搭建好了。</p>
<h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ol>
<li>注意一定要验证Github的验证邮件。</li>
<li><p>出现其他任何的问题，先删除博客目录下的<code>db.json</code>文件，然后清理再部署远程博客，操作时输入以下的命令</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">hexo clean</span>
<span class="line">hexo d -g</span>
</pre></td></tr></table></figure>
</li>
<li><p>Hexo的基本命令</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">hexo g = hexo generate  <span class="comment">#生成</span></span>
<span class="line">hexo <span class="keyword">s</span> = hexo server  <span class="comment">#启动本地预览</span></span>
<span class="line">hexo d = hexo deploy  <span class="comment">#远程部署</span></span>
<span class="line">hexo n <span class="string">"文章标题"</span> = hexo new <span class="string">"文章标题"</span>  <span class="comment">#新建一篇博文</span></span>
<span class="line"></span>
<span class="line">hexo <span class="keyword">s</span> -g  <span class="comment">#等同先输入hexo g，再输入hexo s</span></span>
<span class="line">hexo d -g  <span class="comment">#等同先输入hexo g，再输入hexo d</span></span>
</pre></td></tr></table></figure></li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> hexo </tag>
            
            <tag> tools </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Sublime Text 常用快捷键]]></title>
      <url>/2017/01/30/tools/Sublime%E5%B8%B8%E7%94%A8%E5%BF%AB%E6%8D%B7%E9%94%AE/</url>
      <content type="html"><![CDATA[<h2 id="通用"><a href="#通用" class="headerlink" title="通用"></a>通用</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">↑ ↓ ← →             上下左右移动光标</span>
<span class="line">Alt                 调出菜单</span>
<span class="line">Ctrl + Shift + P    调出命令板（Command Palette）</span>
<span class="line">Ctrl + `            调出控制台</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl + Enter            在当前行下面新增一行然后跳至该行</span>
<span class="line">Ctrl + Shift + Enter    在当前行上面增加一行并跳至该行</span>
<span class="line">Ctrl + ←/→              进行逐词移动</span>
<span class="line">Ctrl + Shift + ←/→      进行逐词选择</span>
<span class="line">Ctrl + ↑/↓              移动当前显示区域</span>
<span class="line">Ctrl + Shift + ↑/↓      移动当前行</span>
</pre></td></tr></table></figure>
<h2 id="选择"><a href="#选择" class="headerlink" title="选择"></a>选择</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl + D                选择当前光标所在的词并高亮该词所有出现的位置</span>
<span class="line">                        再次 Ctrl + D 选择该词出现的下一个位置，在多重选词的过程中</span>
<span class="line">                        使用 Ctrl + K 进行跳过，使用 Ctrl + U 进行回退，使用 Esc 退出多重编辑</span>
<span class="line">Ctrl + Shift + L        将当前选中区域打散</span>
<span class="line">Ctrl + J                把当前选中区域合并为一行</span>
<span class="line">Ctrl + M                在起始括号和结尾括号间切换</span>
<span class="line">Ctrl + Shift + M        快速选择括号间的内容</span>
<span class="line">Ctrl + Shift + J        快速选择同缩进的内容</span>
<span class="line">Ctrl + Shift + Space    快速选择当前作用域（Scope）的内容</span>
</pre></td></tr></table></figure>
<h2 id="查找-amp-替换"><a href="#查找-amp-替换" class="headerlink" title="查找&amp;替换"></a>查找&amp;替换</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">F3                  跳至当前关键字下一个位置</span>
<span class="line">Shift + F3          跳到当前关键字上一个位置</span>
<span class="line">Alt + F3            选中当前关键字出现的所有位置</span>
<span class="line">Ctrl + F/H          进行标准查找/替换，之后：</span>
<span class="line">Alt + C             切换大小写敏感（Case-sensitive）模式</span>
<span class="line">Alt + W             切换整字匹配（Whole matching）模式</span>
<span class="line">Alt + R             切换正则匹配（Regex matching）模式</span>
<span class="line">Ctrl + Shift + H    替换当前关键字</span>
<span class="line">Ctrl + Alt + Enter  替换所有关键字匹配</span>
<span class="line">Ctrl + Shift + F    多文件搜索&amp;替换</span>
</pre></td></tr></table></figure>
<h2 id="跳转"><a href="#跳转" class="headerlink" title="跳转"></a>跳转</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl + P        跳转到指定文件，输入文件名后可以：</span>
<span class="line">@ 符号跳转       输入@symbol跳转到symbol符号所在的位置</span>
<span class="line"># 关键字跳转     输入#keyword跳转到keyword所在的位置</span>
<span class="line">: 行号跳转       输入:12跳转到文件的第12行。</span>
<span class="line">Ctrl + R        跳转到指定符号</span>
<span class="line">Ctrl + G        跳转到指定行号</span>
</pre></td></tr></table></figure>
<h2 id="窗口"><a href="#窗口" class="headerlink" title="窗口"></a>窗口</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Ctrl + Shift + N    创建一个新窗口</span>
<span class="line">Ctrl + N            在当前窗口创建一个新标签</span>
<span class="line">Ctrl + W            关闭当前标签，当窗口内没有标签时会关闭该窗口</span>
<span class="line">Ctrl + Shift + T    恢复刚刚关闭的标签</span>
</pre></td></tr></table></figure>
<h2 id="屏幕"><a href="#屏幕" class="headerlink" title="屏幕"></a>屏幕</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">F11                             切换至普通全屏</span>
<span class="line">Shift + F11                     切换至无干扰全屏</span>
<span class="line">Alt+Shift+1       Single        切换至独屏</span>
<span class="line">Alt+Shift+2       Columns:2     切换至纵向二栏分屏</span>
<span class="line">Alt+Shift+3       Columns:3     切换至纵向三栏分屏</span>
<span class="line">Alt+Shift+4       Columns:4     切换至纵向四栏分屏</span>
<span class="line">Alt+Shift+8       Rows:2        切换至横向二栏分屏</span>
<span class="line">Alt+Shift+9       Rows:3        切换至横向三栏分屏</span>
<span class="line">Alt+Shift+5       Grid          切换至四格式分屏</span>
</pre></td></tr></table></figure>
<h2 id="插件”DeleteBlankLines”"><a href="#插件”DeleteBlankLines”" class="headerlink" title="插件”DeleteBlankLines”"></a>插件”DeleteBlankLines”</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># Windows/Linux</span>
<span class="line">Ctrl+Alt+Backspace          删除所有空行</span>
<span class="line">Ctrl+Alt+Shift+Backspace    删除多余空行</span>
<span class="line"></span>
<span class="line"># Mac OS</span>
<span class="line">Ctrl+Alt+Delete             删除所有空行</span>
<span class="line">Ctrl+Alt+Shift+Delete       删除多余空行</span>
</pre></td></tr></table></figure>
<h2 id="插件”SublimeTmpl”"><a href="#插件”SublimeTmpl”" class="headerlink" title="插件”SublimeTmpl”"></a>插件”SublimeTmpl”</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ctrl+alt+h          html</span>
<span class="line">ctrl+alt+j          javascript</span>
<span class="line">ctrl+alt+c          css</span>
<span class="line">ctrl+alt+p          php</span>
<span class="line">ctrl+alt+r          ruby</span>
<span class="line">ctrl+alt+shift+p    python</span>
</pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> tools </tag>
            
            <tag> sublime text </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-03 深入MySQL体系结构]]></title>
      <url>/2017/01/28/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/03-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="1-thread-pool的原理是什么？"><a href="#1-thread-pool的原理是什么？" class="headerlink" title="1. thread pool的原理是什么？"></a>1. thread pool的原理是什么？</h2><p>线程池的原理很简单，类似于操作系统中的缓冲区的概念，它的流程如下：先启动若干数量的线程，并让这些线程都处于睡眠状态，当客户端有一个新请求时，就会唤醒线程池中的某一个睡眠线程，让它来处理客户端的这个请求，当处理完这个请求后，线程又处于睡眠状态。</p>
<p>MySQL线程池只在MariaDB，Oracle MySQL企业版中提供，Oracle MySQL社区版并不提供。</p>
<p>在传统方式下，MySQL线程调度方式有两种：每个连接一个线程(one-thread-per-connection)和所有连接一个线程（no-threads）。在实际生产中，一般用的是前者。即每当有一个客户端连接到MySQL服务器，MySQL服务器都会为该客户端创建一个单独的线程，请求结束后，销毁线程。连接数越多，则相应的线程会越多。这种方式在高并发情况下，会导致线程的频繁创建和释放。</p>
<a id="more"></a>
<h2 id="2-为什么用double-write就能解决page坏的问题？"><a href="#2-为什么用double-write就能解决page坏的问题？" class="headerlink" title="2. 为什么用double write就能解决page坏的问题？"></a>2. 为什么用double write就能解决page坏的问题？</h2><p>InnoDB 的Page Size一般是16KB，其数据校验也是针对这16KB来计算的，将数据写入到磁盘是以Page为单位进行操作的，mysql的page size跟系统文件的page size是不一致的，在写数据的时候, 系统并不是把整个buffer pool page一次性写到disk上，在极端情况下（比如断电）往往并不能保证这一操作的原子性，16K的数据，写入4K时，发生了系统断电/OS crash ，只有一部分写是成功的，这种情况下就是partial page write问题。</p>
<p>mysql在恢复的过程中是检查page的checksum（检验和），checksum就是pgae的最后事务号，发生partial page write问题时，page已经损坏，找不到该page中的事务号，就无法恢复（redo里面是没有保留这个损坏page完全的镜像，就无法从REDO里恢复）。</p>
<p>为了解决 partial page write 问题 ，当mysql将脏数据flush到data file的时候, 先使用memcopy 将脏数据复制到内存中的double write buffer ，之后通过double write buffer再分2次，每次写入1MB到共享表空间，然后马上调用fsync函数，同步到磁盘上，避免缓冲带来的问题，在这个过程中，doublewrite是顺序写，开销并不大，在完成doublewrite写入后，在将double write buffer写入各表空间文件，这时是离散写入。如果发生了极端情况（断电），InnoDB再次启动后，发现了一个Page数据已经损坏，那么此时就可以从double write buffer中进行数据恢复了。</p>
<ul>
<li><strong>double write的优点是什么?</strong><br>double write解决了partial page write的问题，它能保证即使double write部分发生了partial page write但也能恢复。另外一个好处就是double write能减少redo log的量, 有了double write，redo log只记录了二进制的变化量，也就等同于binary log，而通过前段时间的测试确实发现，在double write关闭的情况下，redo log比binary logs要大。</li>
</ul>
<ul>
<li><strong>double write的缺点是什么?</strong><br>虽然mysql称double write是一个buffer, 但其实它是开在物理文件上的一个buffer, 其实也就是file, 所以它会导致系统有更多的fsync操作, 而我们知道硬盘的fsync性能是很慢的, 所以它会降低mysql的整体性能. 但是并不会降低到原来的50%. 这主要是因为: <ol>
<li>double write是一个连接的存储空间, 所以硬盘在写数据的时候是顺序写, 而不是随机写, 这样性能更高。 </li>
<li>另外将数据从double write buffer写到真正的segment中的时候, 系统会自动合并连接空间刷新的方式, 每次可以刷新多个pages。另外将数据从double write buffer写到真正的segment中的时候, 系统会自动合并连接空间刷新的方式, 每次可以刷新多个pages。</li>
</ol>
</li>
</ul>
<ul>
<li><strong>double write在恢复的时候是如何工作的?</strong><br>如果是写double write buffer本身失败，那么这些数据不会被写到磁盘，innodb此时会从磁盘载入原始的数据，然后通过innodb的事务日志来计算出正确的数据，重新写入到double write buffer。如果double write buffer写成功的话，但是写磁盘失败，innodb就不用通过事务日志来计算了，而是直接用buffer的数据再写一遍。在恢复的时候，innodb直接比较页面的checksum，如果不对的话，就从硬盘载入原始数据，再由事务日志开始推演出正确的数据，所以innodb的恢复通常需要较长的时间。</li>
</ul>
<ul>
<li><strong>查看是否开启double write</strong><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'%double%'</span>;</span>
<span class="line">+<span class="comment">--------------------+-------+</span></span>
<span class="line">| Variable_name      | Value |</span>
<span class="line">+<span class="comment">--------------------+-------+</span></span>
<span class="line">| innodb_doublewrite | ON    |</span>
<span class="line">+<span class="comment">--------------------+-------+</span></span>
</pre></td></tr></table></figure>
</li>
</ul>
<h2 id="3-InnoDB-redo-log与binlog有什么区别？有了InnoDB-redo-log为什么还要binlog"><a href="#3-InnoDB-redo-log与binlog有什么区别？有了InnoDB-redo-log为什么还要binlog" class="headerlink" title="3. InnoDB redo log与binlog有什么区别？有了InnoDB redo log为什么还要binlog?"></a>3. InnoDB redo log与binlog有什么区别？有了InnoDB redo log为什么还要binlog?</h2><ul>
<li>binlog会记录所有与MySQL数据库有关的日志记录，包括InnoDB、MyISAM、Heap等其他存储引擎的日志；而InnoDB存储引擎的redo log只记录有关该引擎本身的事务日志。</li>
<li>无论将binlog文件记录的格式设为STATEMENT还是ROW，又或是MIXED，其记录的都是关于一个事务的具体操作内容，即该日志是逻辑日志；而InnoDB存储引擎的redo log是关于每个页（page）更改的物理情况。</li>
<li>binlog文件仅在事务提交后进行写入，即只写磁盘一次，不论这时该事务多大；而在事务进行的过程中，却不断有重做日志条目（redo entry）被写入到重做日志文件中。</li>
</ul>
<p>binlog是MySQL Server层记录的日志，所有引擎产生的日志都会通过binlog进行封装；MySQL的特点就是支持多存储引擎，为了兼容绝大部分引擎来支持类似复制这样的特性，就需要采用binlog日志来用实现。简单的说，binlog 是mysqld 记录全局数据结构变化的log，用于复制和恢复；innodb redo log 是innodb 引擎自己记录事务过程的log，用于回滚和crash 恢复。</p>
<h2 id="4-课程笔记"><a href="#4-课程笔记" class="headerlink" title="4. 课程笔记"></a>4. 课程笔记</h2><ol>
<li>MySQL是单进程多线程</li>
<li>MySQL存储引擎是可插拔的，有InnoDB，MyISAM(早期)等</li>
<li>存储引擎是用来处理数据库相关的CRUD的操作</li>
<li>CRUD是指在做计算处理时的增加(Create)、读取(Retrieve)(重新得到数据)、更新(Update)和删除(Delete)几个单词的首字母简写</li>
<li>存储引擎的对象是表</li>
<li>MySQL数据库与实例的关系是一对一的</li>
<li>MySQL的数据库是物理操作系统文件或其他形式文件类型的集合，实例是由数据库后台进程/线程以及一个共享内存区组成</li>
<li><p>MySQL 5.6 InnoDB架构中Buffer Pool<br><img src="http://oligvdnzp.bkt.clouddn.com/mysql_innodb_architecture_00.jpg" alt="mysql_innodb_architecture_00"><br>(1) <code>index page</code>: 数据缓存放在index page里，因MySQL数据的存储结构是Btree，所以称index page，page的概念相当于oracle中的buffer，1 page默认大小16k<br>(2) <code>data dictionary</code>: 数据字典的缓冲，其文件是存放在iblog目录下的ibdata中，如<code>/u01/my3306/log/iblog/ibdata1</code><br><img src="http://oligvdnzp.bkt.clouddn.com/mysql_innodb_architecture_01.png" alt="mysql_innodb_architecture_01"><br>(3) <code>lock info</code>: 行锁放在lock info中，当行锁达到一定值的时候，行锁就会升级为表锁<br>(4) <code>undo page</code>: 缓存UNDO操作，DML操作修改前镜像放到undo page中，其文件也是存放在iblog目录下的ibdata中<br>(5) <code>insert buffer page</code>: 缓存二级索引（非唯一索引，或称辅助索引）<br>(6) <code>adaptive hash index</code>: 自适应哈希索引，InnoDB存储引擎会监控对表上索引的查找，如果观察到建立哈希索引可以带来速度的提升，则建立哈希索引，所以称之为自适应（adaptive）的。自适应哈希索引通过缓冲池的B+树构造而来，因此建立的速度很快。而且不需要将整个表都建哈希索引，InnoDB存储引擎会自动根据访问的频率和模式来为某些页建立哈希索引。<br>(7) <code>Buffer Pool</code>的大小一般设置为物理内存的60%-80%，在MySQL中可以通过以下命令查询：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like '%buffer_pool_size%';</span>
<span class="line">+-------------------------+-----------+</span>
<span class="line">| Variable_name           | Value     |</span>
<span class="line">+-------------------------+-----------+</span>
<span class="line">| innodb_buffer_pool_size | 134217728 |</span>
<span class="line">+-------------------------+-----------+</span>
</pre></td></tr></table></figure>
</li>
<li><p><code>redo log buffer</code>: 缓存redo log，通过redo log thead写到redo log文件中存放在iblog目录下的ibdata中，如<code>/u01/my3306/log/iblog/ib_logfile0</code></p>
</li>
<li>查找算法：链表遍历、二分查找、Btree查找、HASH查找</li>
<li><p>当数据库关闭时，把热块保存(缓存)到文件，在打开时再从文件加载到内存里，参数和设置方法如下：</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">show variables like <span class="string">'%dump%'</span>;</span>
<span class="line">+-------------------------------------+-------+</span>
<span class="line">| Variable_name                       | Value |</span>
<span class="line">+-------------------------------------+-------+</span>
<span class="line">| innodb_buffer_pool_dump_at_shutdown | OFF   |</span>
<span class="line">| innodb_buffer_pool_dump_now         | OFF   |</span>
<span class="line">+-------------------------------------+-------+</span>
<span class="line"></span>
<span class="line">set global innodb_buffer_pool_dump_at_shutdown=<span class="number">1</span>;</span>
<span class="line">set global innodb_buffer_pool_dump_now=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">exit</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 关闭数据库</span></span>
<span class="line">mysqladmin <span class="keyword">shutdown</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看缓存的文件</span></span>
<span class="line">ll /u01/my3306/<span class="keyword">log</span>/iblog/</span>
<span class="line">total <span class="number">4145172</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql        <span class="number">884</span> Jan <span class="number">24</span> <span class="number">17</span>:<span class="number">38</span> ib_buffer_pool   //这个就是缓存的文件</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql   <span class="number">33554432</span> Jan <span class="number">24</span> <span class="number">17</span>:<span class="number">38</span> ibdata1</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql   <span class="number">16777216</span> Jan <span class="number">24</span> <span class="number">17</span>:<span class="number">38</span> ibdata2</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Jan <span class="number">24</span> <span class="number">17</span>:<span class="number">38</span> ib_logfile<span class="number">0</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Jan <span class="number">17</span> <span class="number">17</span>:<span class="number">37</span> ib_logfile1</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Jan <span class="number">17</span> <span class="number">17</span>:<span class="number">37</span> ib_logfile2</span>
<span class="line">-rw-rw----. <span class="number">1</span> mysql mysql <span class="number">1048576000</span> Jan <span class="number">17</span> <span class="number">17</span>:<span class="number">37</span> ib_logfile3</span>
<span class="line"></span>
<span class="line"><span class="comment"># 指定参数启动数据库</span></span>
<span class="line">mysqld_safe --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf &amp;</span>
</pre></td></tr></table></figure>
</li>
<li><p>安装MySQL Utilities<br>(1)选择MySQL Utilities适合的版本下载：<a href="https://dev.mysql.com/downloads/utilities/" target="_blank" rel="external">https://dev.mysql.com/downloads/utilities/</a><br><img src="http://oligvdnzp.bkt.clouddn.com/mysql_utilities_download_00.png" alt="mysql_utilities_download_00"><br>(2)选择Connector/Python适合的版本下载（依赖包）：<a href="https://dev.mysql.com/downloads/connector/python/" target="_blank" rel="external">https://dev.mysql.com/downloads/connector/python/</a><br><img src="http://oligvdnzp.bkt.clouddn.com/mysql_utilities_download_01.png" alt="mysql_utilities_download_01"><br>(3)上传安装包到服务器/tmp目录，并安装（root用户下）</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ll</span>
<span class="line">total <span class="number">32836</span></span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root    <span class="number">258776</span> Jan <span class="number">25</span> <span class="number">11</span>:<span class="number">50</span> mysql-connector-python-<span class="number">2.1</span>.<span class="number">5</span>-<span class="number">1</span>.el6.x86_64.rpm</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root    <span class="number">892500</span> Jan <span class="number">25</span> <span class="number">11</span>:<span class="number">39</span> mysql-utilities-<span class="number">1.6</span>.<span class="number">4</span>-<span class="number">1</span>.el6.noarch.rpm</span>
<span class="line"></span>
<span class="line">rpm -ivh mysql-connector-python-<span class="number">2.1</span>.<span class="number">5</span>-<span class="number">1</span>.el6.x86_64.rpm</span>
<span class="line">rpm -ivh mysql-utilities-<span class="number">1.6</span>.<span class="number">4</span>-<span class="number">1</span>.el6.noarch.rpm</span>
</pre></td></tr></table></figure>
<p>(4)MySQL Utilities–mysqlfrm</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 以诊断模式查看表结构定义文件</span></span>
<span class="line">mysqlfrm --diagnostic user.frm</span>
</pre></td></tr></table></figure>
</li>
<li><p>查看错误日志所在位置</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%log_error%'</span>;</span>
<span class="line">+---------------------+---------------------------+</span>
<span class="line">| Variable_name       | Value                     |</span>
<span class="line">+---------------------+---------------------------+</span>
<span class="line">| binlog_error_action | IGNORE_ERROR              |</span>
<span class="line">| log_error           | <span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/error.log |  <span class="comment"># 错误日志所在位置</span></span>
<span class="line">+---------------------+---------------------------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>开启慢查询</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%slow%'</span>;</span>
<span class="line">+---------------------------+--------------------------+</span>
<span class="line">| Variable_name             | Value                    |</span>
<span class="line">+---------------------------+--------------------------+</span>
<span class="line">| log_slow_admin_statements | ON                       |</span>
<span class="line">| log_slow_slave_statements | OFF                      |</span>
<span class="line">| slow_launch_time          | <span class="number">2</span>                        |</span>
<span class="line">| slow_query_log            | ON                       |   <span class="comment"># 开启慢查询</span></span>
<span class="line">| slow_query_log_file       | <span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/slow.log |   <span class="comment"># 慢查询日志位置</span></span>
<span class="line">+---------------------------+--------------------------+ </span>
<span class="line"></span>
<span class="line">mysql&gt; show variables like <span class="string">'%query_time%'</span>;</span>
<span class="line">+-----------------+----------+</span>
<span class="line">| Variable_name   | Value    |</span>
<span class="line">+-----------------+----------+</span>
<span class="line">| long_query_time | <span class="number">1.000000</span> |   <span class="comment"># 慢查询时间为1s</span></span>
<span class="line">+-----------------+----------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>通用日志默认是不开启的（通用日志主要用在数据库审计）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%gen%&apos;;</span>
<span class="line">+------------------+----------------------------+</span>
<span class="line">| Variable_name    | Value                      |</span>
<span class="line">+------------------+----------------------------+</span>
<span class="line">| general_log      | OFF                        |</span>
<span class="line">| general_log_file | /u01/my3306/data/mysql.log |</span>
<span class="line">+------------------+----------------------------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>最大用户连接数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like &apos;%max_user_connect%&apos;;</span>
<span class="line">+----------------------+-------+</span>
<span class="line">| Variable_name        | Value |</span>
<span class="line">+----------------------+-------+</span>
<span class="line">| max_user_connections | 2800  |</span>
<span class="line">+----------------------+-------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>查出mysqld进程号为27507</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ps -ef | <span class="keyword">grep</span> <span class="number">3306</span></span>
<span class="line"></span>
<span class="line">root      <span class="number">5475</span>  <span class="number">5183</span>  <span class="number">0</span> <span class="number">11</span>:<span class="number">44</span> pts/<span class="number">1</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> <span class="keyword">grep</span> <span class="number">3306</span></span>
<span class="line">mysql    <span class="number">26656</span>     <span class="number">1</span>  <span class="number">0</span> Jan17 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> /bin/sh /u01/my3306/bin/mysqld_safe --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf --user=mysql</span>
<span class="line">mysql    <span class="number">27507</span> <span class="number">26656</span>  <span class="number">0</span> Jan17 ?        <span class="number">00</span>:<span class="number">01</span>:<span class="number">32</span> /u01/my3306/bin/mysqld --defaults-file=<span class="regexp">/u01/my</span>3306/my.cnf --basedir=<span class="regexp">/u01/my</span>3306 --datadir=<span class="regexp">/u01/my</span>3306/data --plugin-dir=<span class="regexp">/u01/my</span>3306/lib/plugin --<span class="keyword">log</span>-error=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/error.log --<span class="keyword">open</span>-files-limit=<span class="number">65535</span> --pid-file=<span class="regexp">/u01/my</span>3306/run/mysqld.pid --<span class="keyword">socket</span>=<span class="regexp">/u01/my</span>3306/run/mysql.sock --port=<span class="number">3306</span></span>
</pre></td></tr></table></figure>
</li>
<li><p>查看mysqld进程27507下所有线程</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">pstack <span class="number">27507</span></span>
<span class="line"></span>
<span class="line">Thread <span class="number">28</span> (Thread <span class="number">0x7f9b070c4700</span> (LWP <span class="number">27508</span>)):</span>
<span class="line"><span class="comment">#0  0x00000038a040b68c in pthread_cond_wait@@GLIBC_2.3.2 () from /lib64/libpthread.so.0</span></span>
<span class="line"><span class="comment">#1  0x00000000009536bb in os_event_wait_low(os_event*, long) ()</span></span>
<span class="line"><span class="comment">#2  0x0000000000950aa6 in os_aio_simulated_handle(unsigned long, fil_node_t**, void**, unsigned long*) ()</span></span>
<span class="line"><span class="comment">#3  0x0000000000a49ed7 in fil_aio_wait(unsigned long) ()</span></span>
<span class="line"><span class="comment">#4  0x00000000009b9638 in io_handler_thread ()</span></span>
<span class="line"><span class="comment">#5  0x00000038a0407aa1 in start_thread () from /lib64/libpthread.so.0</span></span>
<span class="line"><span class="comment">#6  0x00000038a00e8aad in clone () from /lib64/libc.so.6</span></span>
<span class="line"><span class="comment"># ...... 中间略过</span></span>
<span class="line">Thread <span class="number">1</span> (Thread <span class="number">0x7f9b18f637e0</span> (LWP <span class="number">27507</span>)):</span>
<span class="line"><span class="comment">#0  0x00000038a00df283 in poll () from /lib64/libc.so.6</span></span>
<span class="line"><span class="comment">#1  0x0000000000585284 in handle_connections_sockets() ()</span></span>
<span class="line"><span class="comment">#2  0x000000000058cd51 in mysqld_main(int, char**) ()</span></span>
<span class="line"><span class="comment">#3  0x00000038a001ed1d in __libc_start_main () from /lib64/libc.so.6</span></span>
<span class="line"><span class="comment">#4  0x000000000057dbc1 in _start ()</span></span>
</pre></td></tr></table></figure>
</li>
<li><p>read/write thread</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%io_thread%'</span>;</span>
<span class="line">+-------------------------+-------+</span>
<span class="line">| Variable_name           | Value |</span>
<span class="line">+-------------------------+-------+</span>
<span class="line">| innodb_read_io_threads  | <span class="number">4</span>     |     <span class="comment"># 预读</span></span>
<span class="line">| innodb_write_io_threads | <span class="number">10</span>    |</span>
<span class="line">+-------------------------+-------+</span>
</pre></td></tr></table></figure>
</li>
<li><p>purge thread: 清undo page</p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">'%purge%'</span>;</span>
<span class="line">+----------------------------+-------+</span>
<span class="line">| Variable_name              | Value |</span>
<span class="line">+----------------------------+-------+</span>
<span class="line">| gtid_purged                |       |</span>
<span class="line">| innodb_max_purge_lag       | <span class="number">0</span>     |</span>
<span class="line">| innodb_max_purge_lag_delay | <span class="number">0</span>     |</span>
<span class="line">| innodb_purge_batch_size    | <span class="number">300</span>   |</span>
<span class="line">| innodb_purge_threads       | <span class="number">1</span>     |</span>
<span class="line">| relay_log_purge            | ON    |</span>
<span class="line">+----------------------------+-------+</span>
</pre></td></tr></table></figure></li>
</ol>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[VIM常用命令]]></title>
      <url>/2017/01/28/tools/vim%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<p>文本编辑器是所有计算机系统中最常用的一种工具。UNIX下的编辑器有ex,sed和vi等，其中，使用最为广泛的是vi。 文中是两张<code>VIM键盘图</code>和<code>VIM命令图解</code>。<br><a id="more"></a></p>
<p><img src="http://oligvdnzp.bkt.clouddn.com/vim02.jpg" alt="VIM键盘图"><br><img src="http://oligvdnzp.bkt.clouddn.com/vim01.png" alt="VIM命令图解"></p>
]]></content>
      
        
        <tags>
            
            <tag> tools </tag>
            
            <tag> vim </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-02 MySQL标准化、自动化部署]]></title>
      <url>/2017/01/23/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/02-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="为什么数据目录和日志目录需要分开"><a href="#为什么数据目录和日志目录需要分开" class="headerlink" title="为什么数据目录和日志目录需要分开?"></a>为什么数据目录和日志目录需要分开?</h2><p>这里的分开，我理解是将MySQL的数据目录和日志目录分别放到不同类型的磁盘中。<br>假设生产环境中服务器上有两种类型的磁盘，分别是SSD和SAS，SSD比SAS的响应时间要快（SSD响应时间约0.1毫秒，SAS的响应时间约10毫秒），为了更好的利用磁盘，一般会把活跃的数据放到SSD上，冷数据放到SAS磁盘上。<br>数据目录下的数据一般是随机读写的热数据，放到SSD盘中会有较高的响应速度；<br>日志目录下的日志是顺序读写的冷数据，放到SAS盘中满足写日志高吞吐量的需求。<br><a id="more"></a></p>
<h2 id="如何标准化配置多实例-（例如：一台物理主机上部署3306与3307两个实例）"><a href="#如何标准化配置多实例-（例如：一台物理主机上部署3306与3307两个实例）" class="headerlink" title="如何标准化配置多实例?（例如：一台物理主机上部署3306与3307两个实例）"></a>如何标准化配置多实例?（例如：一台物理主机上部署3306与3307两个实例）</h2><p>标准化配置多实例，主要是标准化每个实例的目录和内存设置，这样每个实例的参数设置也很容易达到标准化。标准化配置的MYSQL实例，方便实施监控及运维管理。<br>因一个MySQL实例最多占用64G的物理内存，所以在物理内存较高的服务器上，一般会安装多个MySQL实例，MySQL不同实例是通过端口来区别的。<br>例如：一台64G的物理主机上部署3306与3307两个MYSQL实例  </p>
<h3 id="标准化目录"><a href="#标准化目录" class="headerlink" title="标准化目录"></a>标准化目录</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">实例1：</span>
<span class="line">/data/my3306</span>
<span class="line">/log/my3306</span>
<span class="line"></span>
<span class="line">实例2：</span>
<span class="line">/data/my3307</span>
<span class="line">/log/my3307</span>
<span class="line"></span>
<span class="line"># /data 目录挂载到SSD盘上</span>
<span class="line"># /log  目录挂载到SAS盘上</span>
</pre></td></tr></table></figure>
<h3 id="标准化内存"><a href="#标准化内存" class="headerlink" title="标准化内存"></a>标准化内存</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">实例1：</span>
<span class="line">15G: InnoDB buffer cache</span>
<span class="line">5G : mysql server层</span>
<span class="line"></span>
<span class="line">实例2：</span>
<span class="line">15G: InnoDB buffer cache</span>
<span class="line">5G : mysql server层</span>
<span class="line"></span>
<span class="line">OS:</span>
<span class="line">24G</span>
</pre></td></tr></table></figure>
<h3 id="标准化参数"><a href="#标准化参数" class="headerlink" title="标准化参数"></a>标准化参数</h3><p>结合标准化的目录及内存设置，设置标准化的参数</p>
<h2 id="详细描述MySQL编译安装的过程（截图安装步骤）"><a href="#详细描述MySQL编译安装的过程（截图安装步骤）" class="headerlink" title="详细描述MySQL编译安装的过程（截图安装步骤）"></a>详细描述MySQL编译安装的过程（截图安装步骤）</h2><h3 id="关闭防火墙和SELINUX"><a href="#关闭防火墙和SELINUX" class="headerlink" title="关闭防火墙和SELINUX"></a>关闭防火墙和SELINUX</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">service iptables status</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">Table: filter</span>
<span class="line">Chain INPUT (policy ACCEPT)</span>
<span class="line">num  target     prot opt source               destination         </span>
<span class="line"><span class="number">1</span>    ACCEPT     all  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           <span class="keyword">state</span> RELATED,ESTABLISHED </span>
<span class="line"><span class="number">2</span>    ACCEPT     icmp --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           </span>
<span class="line"><span class="number">3</span>    ACCEPT     all  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           </span>
<span class="line"><span class="number">4</span>    ACCEPT     tcp  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           <span class="keyword">state</span> NEW tcp dpt:<span class="number">22</span> </span>
<span class="line"><span class="number">5</span>    REJECT     all  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           reject-with icmp-host-prohibited </span>
<span class="line"></span>
<span class="line">Chain FORWARD (policy ACCEPT)</span>
<span class="line">num  target     prot opt source               destination         </span>
<span class="line"><span class="number">1</span>    REJECT     all  --  <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span>           reject-with icmp-host-prohibited </span>
<span class="line"></span>
<span class="line">Chain OUTPUT (policy ACCEPT)</span>
<span class="line">num  target     prot opt source               destination         </span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">service iptables stop</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">iptables: Setting chains to policy ACCEPT: filter          [  OK  ]</span>
<span class="line">iptables: Flushing firewall rules:                         [  OK  ]</span>
<span class="line">iptables: Unloading modules:                               [  OK  ]</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">service iptables status</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">iptables: Firewall is <span class="keyword">not</span> running.</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">chkconfig iptables off</span>
<span class="line"></span>
<span class="line">vi /etc/selinux/config</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">SELINUX=disabled</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="配置sysctl-conf"><a href="#配置sysctl-conf" class="headerlink" title="配置sysctl.conf"></a>配置sysctl.conf</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看服务器内存</span></span>
<span class="line">free</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">             total       used       free     shared    buffers     cached</span>
<span class="line">Mem:       <span class="number">8174352</span>     <span class="number">616628</span>    <span class="number">7557724</span>        <span class="number">172</span>     <span class="number">151904</span>     <span class="number">253892</span></span>
<span class="line">-<span class="regexp">/+ buffers/cache</span>:     <span class="number">210832</span>    <span class="number">7963520</span></span>
<span class="line">Swap:     <span class="number">16531452</span>          <span class="number">0</span>   <span class="number">16531452</span></span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line">vi /etc/sysctl.conf</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"><span class="comment"># 修改</span></span>
<span class="line">kernel.shmmax = <span class="number">4398046511104</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 添加</span></span>
<span class="line">fs.file-max = <span class="number">6815744</span></span>
<span class="line">kernel.sem = <span class="number">250</span> <span class="number">32000</span> <span class="number">100</span> <span class="number">128</span></span>
<span class="line">kernel.shmmni = <span class="number">4096</span></span>
<span class="line">kernel.panic_on_oops = <span class="number">1</span></span>
<span class="line">net.core.rmem_default = <span class="number">262144</span></span>
<span class="line">net.core.rmem_max = <span class="number">4194304</span></span>
<span class="line">net.core.wmem_default = <span class="number">262144</span></span>
<span class="line">net.core.wmem_max = <span class="number">1048576</span></span>
<span class="line">fs.aio-max-nr = <span class="number">1048576</span></span>
<span class="line">net.ipv4.ip_local_port_range = <span class="number">9000</span> <span class="number">65500</span></span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"><span class="comment"># kernel.shmmax算法：修改为物理内容的50%、60%</span></span>
<span class="line"><span class="comment"># 8G:kernel.shmmax = (8G*1024*1024*1024*1024)*50% = 4398046511104</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 使配置立即生效</span></span>
<span class="line">sysctl -p</span>
</pre></td></tr></table></figure>
<h3 id="检查是否已安装MySQL"><a href="#检查是否已安装MySQL" class="headerlink" title="检查是否已安装MySQL"></a>检查是否已安装MySQL</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">rpm -qa | <span class="keyword">grep</span> mysql</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">mysql-libs-<span class="number">5.1</span>.<span class="number">73</span>-<span class="number">7</span>.el6.x86_64</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除mysql-libs-5.1.73-7.el6.x86_64包</span></span>
<span class="line">rpm -e --nodeps mysql-libs-<span class="number">5.1</span>.<span class="number">73</span>-<span class="number">7</span>.el6.x86_64</span>
</pre></td></tr></table></figure>
<h3 id="下载MySQL源码"><a href="#下载MySQL源码" class="headerlink" title="下载MySQL源码"></a>下载MySQL源码</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">Download MySQL Community Server  https:<span class="regexp">//dev</span>.mysql.com/downloads/mysql/<span class="number">5.6</span>.html<span class="comment">#downloads</span></span>
<span class="line">Select Version: <span class="number">5.6</span>.<span class="number">35</span> -&gt; Select Platform: Source Code</span>
<span class="line">-&gt; 选择【Generic Linux (Architecture Independent), Compressed TAR Archive】下载 </span>
<span class="line"></span>
<span class="line"><span class="comment"># 配置yum源，安装lrzsz(代替ftp上传和下载的工具)</span></span>
<span class="line"><span class="keyword">mkdir</span> /media/disk</span>
<span class="line"><span class="keyword">mkdir</span> /media/cdrom</span>
<span class="line">mount /dev/cdrom /media/cdrom</span>
<span class="line"></span>
<span class="line">cp -rf /media/cdrom/* <span class="regexp">/media/disk</span></span>
<span class="line">umount /media/cdrom</span>
<span class="line"></span>
<span class="line">cp /etc/yum.repos.d/public-yum-ol6.repo /etc/yum.repos.d/public-yum-ol6.repo.bak</span>
<span class="line">vi /etc/yum.repos.d/public-yum-ol6.repo</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">name=Oracle Linux $releasever Latest ($basearch)</span>
<span class="line">baseurl=file:<span class="regexp">//</span><span class="regexp">/media/disk</span><span class="regexp">/Server</span>
<span class="line">gpgcheck=0</span>
<span class="line">enabled=1</span>
<span class="line">#------------------------------------------------</span>
<span class="line"></span>
<span class="line">yum -y install lrzsz</span>
<span class="line"></span>
<span class="line"># 上传到服务器的/u</span>01目录下</span>
<span class="line"><span class="keyword">mkdir</span> /u01</span>
<span class="line">cd /u01</span>
<span class="line">rz</span>
<span class="line"></span>
<span class="line"><span class="comment"># 选择mysql源码包，上传</span></span>
<span class="line">rz waiting to receive.</span>
<span class="line">Starting zmodem transfer.  Press Ctrl+C to cancel.</span>
<span class="line">Transferring mysql-<span class="number">5.6</span>.<span class="number">35</span>.tar.gz...</span>
<span class="line">  <span class="number">100</span>%   <span class="number">31413</span> KB    <span class="number">15706</span> KB/sec    <span class="number">00</span>:<span class="number">00</span>:<span class="number">02</span>       <span class="number">0</span> Errors </span>
<span class="line"></span>
<span class="line">ll /u01/mysql*</span>
<span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">32167628</span> Jan <span class="number">17</span> <span class="number">11</span>:<span class="number">16</span> /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span>.tar.gz</span>
</pre></td></tr></table></figure>
<h3 id="添加MySQL用户和组"><a href="#添加MySQL用户和组" class="headerlink" title="添加MySQL用户和组"></a>添加MySQL用户和组</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">groupadd -g <span class="number">501</span> mysql</span>
<span class="line">useradd -u <span class="number">501</span> mysql -g mysql</span>
<span class="line">echo <span class="string">"mysql123"</span> | passwd --stdin mysql</span>
<span class="line"></span>
<span class="line">id mysql</span>
<span class="line">uid=<span class="number">501</span>(mysql) gid=<span class="number">501</span>(mysql) groups=<span class="number">501</span>(mysql)</span>
</pre></td></tr></table></figure>
<h3 id="配MySQL环境变量"><a href="#配MySQL环境变量" class="headerlink" title="配MySQL环境变量"></a>配MySQL环境变量</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">vi /home/mysql/.bash_profile</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
<span class="line">PATH=$PATH:$HOME/bin:<span class="regexp">/u01/my</span>3306/bin</span>
<span class="line"><span class="comment">#------------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="创建目录及授权"><a href="#创建目录及授权" class="headerlink" title="创建目录及授权"></a>创建目录及授权</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/data</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/<span class="keyword">log</span>/iblog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/<span class="keyword">log</span>/binlog</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/run</span>
<span class="line"><span class="keyword">mkdir</span> -p /u01/my3306/tmp</span>
<span class="line"></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01/my3306</span>
<span class="line"><span class="keyword">chmod</span> -R <span class="number">755</span> /u01/my3306</span>
</pre></td></tr></table></figure>
<h3 id="解压mysql5-6"><a href="#解压mysql5-6" class="headerlink" title="解压mysql5.6"></a>解压mysql5.6</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /u01</span>
<span class="line">tar xvpf mysql-5.6.35.tar.gz</span>
</pre></td></tr></table></figure>
<h3 id="安装cmake及相关依赖包"><a href="#安装cmake及相关依赖包" class="headerlink" title="安装cmake及相关依赖包"></a>安装cmake及相关依赖包</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y  cmake gcc gcc-c++ ncurses-devel bison zlib libxml openssl</span>
</pre></td></tr></table></figure>
<h3 id="编译并安装"><a href="#编译并安装" class="headerlink" title="编译并安装"></a>编译并安装</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/mysql-<span class="number">5.6</span>.<span class="number">35</span></span>
<span class="line"></span>
<span class="line">cmake \</span>
<span class="line">-DCMAKE_INSTALL_PREFIX=<span class="regexp">/u01/my</span>3306 \</span>
<span class="line">-DINSTALL_DATADIR=<span class="regexp">/u01/my</span>3306/data  \</span>
<span class="line">-DDEFAULT_CHARSET=utf8 \</span>
<span class="line">-DDEFAULT_COLLATION=utf8_general_ci \</span>
<span class="line">-DEXTRA_CHARSETS=all \</span>
<span class="line">-DWITH_SSL=yes \</span>
<span class="line">-DWITH_EMBEDDED_SERVER=<span class="number">1</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DWITH_MYISAM_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_INNOBASE_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_ARCHIVE_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_BLACKHOLE_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_FEDERATED_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DWITH_PARTITION_STORAGE_ENGINE=<span class="number">1</span> \</span>
<span class="line">-DMYSQL_UNIX_ADDR=<span class="regexp">/u01/my</span>3306/run/mysql.sock \</span>
<span class="line">-DMYSQL_TCP_PORT=<span class="number">3306</span> \</span>
<span class="line">-DENABLED_LOCAL_INFILE=<span class="number">1</span> \</span>
<span class="line">-DSYSCONFDIR=<span class="regexp">/etc \</span>
<span class="line">-DWITH_READLINE=on</span>
<span class="line"></span>
<span class="line"># 第一次CMAKE出现错误提示</span>
<span class="line">#---------------------------------------------------------------------------------------------</span>
<span class="line">CMake Error: The following variables are used in this project, but they are set to NOTFOUND.</span>
<span class="line">Please set them or make sure they are set and tested correctly in the CMake files:</span>
<span class="line">OPENSSL_INCLUDE_DIR</span>
<span class="line">   used as include directory in directory /u</span>01/mysql-<span class="number">5.6</span>.<span class="number">35</span>/CMakeFiles/CMakeTmp</span>
<span class="line"><span class="comment">#---------------------------------------------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#安装openssl-devel包</span></span>
<span class="line">yum -<span class="keyword">y</span> install openssl-devel</span>
<span class="line"></span>
<span class="line"><span class="comment">#重新cmake需要删除当前目录下CMakeCache.txt，然后再重新执行</span></span>
<span class="line">rm -rf CMakeCache.txt</span>
<span class="line"></span>
<span class="line"><span class="comment">#编译并安装</span></span>
<span class="line">make</span>
<span class="line">make install</span>
</pre></td></tr></table></figure>
<h3 id="MySQL参数配置"><a href="#MySQL参数配置" class="headerlink" title="MySQL参数配置"></a>MySQL参数配置</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">cd /u01/my3306</span>
<span class="line">vi my.cnf</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line">[client]</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/my</span>3306/mysql.sock</span>
<span class="line"></span>
<span class="line">[mysql]</span>
<span class="line">pid_file=<span class="regexp">/u01/my</span>3306/run/mysqld.pid</span>
<span class="line"></span>
<span class="line">[mysqld]</span>
<span class="line">autocommit=<span class="number">1</span></span>
<span class="line">general_log=off</span>
<span class="line">explicit_defaults_for_timestamp=true</span>
<span class="line"></span>
<span class="line"><span class="comment"># system</span></span>
<span class="line">basedir=<span class="regexp">/u01/my</span>3306</span>
<span class="line">datadir=<span class="regexp">/u01/my</span>3306/data</span>
<span class="line">max_allowed_packet=<span class="number">1</span>g</span>
<span class="line">max_connections=<span class="number">3000</span></span>
<span class="line">max_user_connections=<span class="number">2800</span></span>
<span class="line">open_files_limit=<span class="number">65535</span></span>
<span class="line">pid_file=<span class="regexp">/u01/my</span>3306/run/mysqld.pid</span>
<span class="line">port=<span class="number">3306</span></span>
<span class="line">server_id=<span class="number">101</span></span>
<span class="line">skip_name_resolve=ON</span>
<span class="line"><span class="keyword">socket</span>=<span class="regexp">/u01/my</span>3306/run/mysql.sock</span>
<span class="line">tmpdir=<span class="regexp">/u01/my</span>3306/tmp</span>
<span class="line"></span>
<span class="line"><span class="comment">#binlog</span></span>
<span class="line">log_bin=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/binlog/binlog</span>
<span class="line">binlog_cache_size=<span class="number">32768</span></span>
<span class="line">binlog_format=row</span>
<span class="line">expire_logs_days=<span class="number">7</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">max_binlog_cache_size=<span class="number">2147483648</span></span>
<span class="line">max_binlog_size=<span class="number">524288000</span></span>
<span class="line">sync_binlog=<span class="number">100</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#logging</span></span>
<span class="line">log_error=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/error.log</span>
<span class="line">slow_query_log_file=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/slow.log</span>
<span class="line">log_queries_not_using_indexes=<span class="number">0</span></span>
<span class="line">slow_query_log=<span class="number">1</span></span>
<span class="line">log_slave_updates=ON</span>
<span class="line">log_slow_admin_statements=<span class="number">1</span></span>
<span class="line">long_query_time=<span class="number">1</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#relay</span></span>
<span class="line">relay_log=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/relaylog</span>
<span class="line">relay_log_index=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/relay.index</span>
<span class="line">relay_log_info_file=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/relay-log.info</span>
<span class="line"></span>
<span class="line"><span class="comment">#slave</span></span>
<span class="line">slave_load_tmpdir=<span class="regexp">/u01/my</span>3306/tmp</span>
<span class="line">slave_skip_errors=OFF</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment">#innodb</span></span>
<span class="line">innodb_data_home_dir=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/iblog</span>
<span class="line">innodb_log_group_home_dir=<span class="regexp">/u01/my</span>3306/<span class="keyword">log</span>/iblog</span>
<span class="line">innodb_adaptive_flushing=ON</span>
<span class="line">innodb_adaptive_hash_index=ON</span>
<span class="line">innodb_autoinc_lock_mode=<span class="number">1</span></span>
<span class="line">innodb_buffer_pool_instances=<span class="number">8</span></span>
<span class="line"></span>
<span class="line"><span class="comment">#default</span></span>
<span class="line">innodb_change_buffering=inserts</span>
<span class="line">innodb_checksums=ON</span>
<span class="line">innodb_buffer_pool_size= <span class="number">128</span>M</span>
<span class="line">innodb_data_file_path=ibdata1:<span class="number">32</span>M;ibdata2:<span class="number">16</span>M:autoextend</span>
<span class="line">innodb_doublewrite=ON</span>
<span class="line">innodb_file_format=Barracuda</span>
<span class="line">innodb_file_per_table=ON</span>
<span class="line">innodb_flush_log_at_trx_commit=<span class="number">1</span></span>
<span class="line">innodb_flush_method=O_DIRECT</span>
<span class="line">innodb_io_capacity=<span class="number">1000</span></span>
<span class="line">innodb_lock_wait_timeout=<span class="number">10</span></span>
<span class="line">innodb_log_buffer_size=<span class="number">67108864</span></span>
<span class="line">innodb_log_file_size=<span class="number">1048576000</span></span>
<span class="line">innodb_log_files_in_group=<span class="number">4</span></span>
<span class="line">innodb_max_dirty_pages_pct=<span class="number">60</span></span>
<span class="line">innodb_open_files=<span class="number">60000</span></span>
<span class="line">innodb_purge_threads=<span class="number">1</span></span>
<span class="line">innodb_read_io_threads=<span class="number">4</span></span>
<span class="line">innodb_stats_on_metadata=OFF</span>
<span class="line">innodb_support_xa=ON</span>
<span class="line">innodb_use_native_aio=OFF</span>
<span class="line">innodb_write_io_threads=<span class="number">10</span></span>
<span class="line"></span>
<span class="line">[mysqld_safe]</span>
<span class="line">datadir=<span class="regexp">/u01/my</span>3306/data</span>
<span class="line"><span class="comment">#----------------------------------------------------------</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 编译后重新修改目录权限</span></span>
<span class="line"><span class="keyword">chown</span> -R mysql:mysql /u01/my3306</span>
</pre></td></tr></table></figure>
<h3 id="初始化MySQL脚本"><a href="#初始化MySQL脚本" class="headerlink" title="初始化MySQL脚本"></a>初始化MySQL脚本</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">su - mysql</span>
<span class="line">cd /u01/my3306/scripts</span>
<span class="line">./mysql_install_db --defaults-file=/u01/my3306/my.cnf \</span>
<span class="line">--datadir=/u01/my3306/data --basedir=/u01/my3306 --user=mysql</span>
</pre></td></tr></table></figure>
<h3 id="启动MySQL"><a href="#启动MySQL" class="headerlink" title="启动MySQL"></a>启动MySQL</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/u01/my3306/bin/mysqld_safe --defaults-file=/u01/my3306/my.cnf --user=mysql &amp;</span>
</pre></td></tr></table></figure>
<h3 id="登录MySQL"><a href="#登录MySQL" class="headerlink" title="登录MySQL"></a>登录MySQL</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">mysql</span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line">mysql -h127.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span> -uroot</span>
<span class="line"></span>
<span class="line">Welcome to the MySQL monitor.  Commands end with ; <span class="keyword">or</span> \g.</span>
<span class="line">Your MySQL connection id is <span class="number">2</span></span>
<span class="line">Server version: <span class="number">5.6</span>.<span class="number">35</span>-<span class="keyword">log</span> Source distribution</span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2016</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span>
<span class="line"></span>
<span class="line">Oracle is a registered trademark of Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span>
<span class="line">affiliates. Other names may be trademarks of their respective</span>
<span class="line">owners.</span>
<span class="line"></span>
<span class="line">Type <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> to clear the current input statement.</span>
<span class="line"></span>
<span class="line">mysql&gt; show databases;</span>
<span class="line">+--------------------+</span>
<span class="line">| Database           |</span>
<span class="line">+--------------------+</span>
<span class="line">| information_schema |</span>
<span class="line">| mysql              |</span>
<span class="line">| performance_schema |</span>
<span class="line">| test               |</span>
<span class="line">+--------------------+</span>
<span class="line"><span class="number">4</span> rows in set (<span class="number">0</span>.<span class="number">01</span> sec)</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[MySQL DBA从小白到大神实战-01 MySQL 高级DBA职业规划]]></title>
      <url>/2017/01/09/mysql/MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/01-MySQL-DBA%E4%BB%8E%E5%B0%8F%E7%99%BD%E5%88%B0%E5%A4%A7%E7%A5%9E%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<h2 id="什么是MVCC？有什么作用？"><a href="#什么是MVCC？有什么作用？" class="headerlink" title="什么是MVCC？有什么作用？"></a>什么是MVCC？有什么作用？</h2><p>MVCC是Multiversion Concurrency Control的缩写，中文的意思是多版本并发控制。<br>目前多数DB都采用了这一技术，比如Oracle，PostgreSQL等，但各自的实现机制不尽相同，MVCC没有一个统一的实现标准。<br>MVCC能有效降低锁的开销，虽然不同数据库实现MVCC的机制有所有同，但大都实现了非阻塞的读操作，写操作也只锁定必要的行。</p>
<a id="more"></a>
<h2 id="ACID中的I是怎么实现在的？"><a href="#ACID中的I是怎么实现在的？" class="headerlink" title="ACID中的I是怎么实现在的？"></a>ACID中的I是怎么实现在的？</h2><ul>
<li>A: 原子性 Atomicity</li>
<li>C: 一致性 Consistency</li>
<li>I: 隔离性 Isolation</li>
<li>D: 持久性 Durability</li>
</ul>
<p><code>I</code>的实现需要对事务进行并发控制，使事务在并发环境中相互隔离，一个事务的执行不能被其他事务干扰。也就是说，不同的事务并发操纵相同的数据时，每个事务都有各自完整的数据空间，一个事务内部的操作及使用的数据对其他并发事务是隔离的，一个事务所做的修改在终提交以前，对其他事务是不可见的。</p>
<h2 id="2PC在数据库中是怎么来实现的？"><a href="#2PC在数据库中是怎么来实现的？" class="headerlink" title="2PC在数据库中是怎么来实现的？"></a>2PC在数据库中是怎么来实现的？</h2><p>2PC是Two Phase Commitment Protocol的缩写，中文的意思是两阶段提交协议，用于保证属于多个数据分片上的操作的原子性。这些数据分片可能分布在不同的服务器上，2PC协议保证多台服务器上的操作要么全部成功，要么全部失败。 以ORACLE数据库为例，2PC的实现步骤如下：</p>
<h3 id="阶段一：提交事务请求（投票阶段）"><a href="#阶段一：提交事务请求（投票阶段）" class="headerlink" title="阶段一：提交事务请求（投票阶段）"></a>阶段一：提交事务请求（投票阶段）</h3><ol>
<li><p><strong>事务询问</strong><br>协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并开始等待各参与者的响应</p>
</li>
<li><p><strong>执行事务</strong><br>各参与者节点执行事务操作，并将Undo和Redo信息计入事务日志中</p>
</li>
<li><p><strong>各参与者向协调者反馈事务询问的响应</strong><br>如果参与者成功执行了事务操作，那么就反馈给协调者Yes响应，表示事务可以执行；<br>如果参与者没有成功执行事务，那么就反馈给协调者No响应，表示事务不可以执行。</p>
</li>
</ol>
<h3 id="阶段二：执行事务提交（执行阶段）"><a href="#阶段二：执行事务提交（执行阶段）" class="headerlink" title="阶段二：执行事务提交（执行阶段）"></a>阶段二：执行事务提交（执行阶段）</h3><h4 id="执行事务提交"><a href="#执行事务提交" class="headerlink" title="执行事务提交"></a>执行事务提交</h4><p>如果所有参与者的反馈都是Yes响应，那么  </p>
<ol>
<li><p><strong>发送提交请求</strong><br>协调者向所有参与者节点发出Commit请求</p>
</li>
<li><p><strong>事务提交</strong><br>参与者接收到Commit请求后，会正式执行事务提交操作，并在完成提交之后释放在整个事务执行期间占用的事务资源</p>
</li>
<li><p><strong>反馈事务提交结果</strong><br>参与者在完成事务提交之后，向协调者发送ACK信息</p>
</li>
<li><p><strong>完成事务</strong><br>协调者接收到所有参与者反馈的ACK消息后，完成事务</p>
</li>
</ol>
<h4 id="中断事务"><a href="#中断事务" class="headerlink" title="中断事务"></a>中断事务</h4><p>任何一个参与者反馈了No响应，或者在等待超时之后，协调者尚无法接收到所有参与者的反馈响应，那么就会中断事务。</p>
<ol>
<li><p><strong>发送回滚请求</strong><br>协调者向所有参与者节点发出Rollback请求</p>
</li>
<li><p><strong>事务回滚</strong><br>参与者接收到rollback请求后，会利用其在阶段一中记录的Undo信息来执行事务回滚操作，并在完成回滚之后释放整个事务执行期间占用的资源</p>
</li>
<li><p><strong>反馈事务回滚结果</strong><br>参与者在完成事务回滚之后，向协调者发送ACK信息</p>
</li>
<li><p><strong>中断事务</strong><br>协调者接收到所有参与者反馈的ACK信息后，完成事务中断</p>
</li>
</ol>
<h2 id="简单讲讲CAP-base-paxos算法。"><a href="#简单讲讲CAP-base-paxos算法。" class="headerlink" title="简单讲讲CAP/base/paxos算法。"></a>简单讲讲CAP/base/paxos算法。</h2><h3 id="CAP定理"><a href="#CAP定理" class="headerlink" title="CAP定理"></a>CAP定理</h3><p>一个分布式系统不可能同时满足一致性(C: Consistency)、可用性(A: Availibility)和分区容错性(P: Partition tolerance)这三个基本需求，最多只能同时满足其中的两项。<br>其中分区容错性是一个最基本的要求，是一个分布式系统必然需要面对和解决的问题。系统架构设计的主要精力应放在根据业务特点在C（一致性）和A（可用性）之间寻求平衡。</p>
<ul>
<li><strong>一致性</strong><br>在分布式环境中，一致性是指数据在多个副本之间是否能够保持一致的特性。<br>CAP定理应用中的放弃一致性，是指放弃数据的强一致性，而保留数据的最终一致性。这样的系统无法保证数据保持实时的一致性，但是能够承诺的是，数据最终会达到一个一致的状态。具体多久能够达到数据一致取决于系统的设计，主要包括数据副本在不同节点之间的复制时间长短。</li>
</ul>
<ul>
<li><strong>可用性</strong><br>系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。<br>CAP定理应用中的放弃可用性，是指一旦系统遇到网络分区或其他故障时，受到影响的服务需要等待一定的时间，在等待期间系统无法对外提供正常的服务，即不可用。</li>
</ul>
<ul>
<li><strong>分区容错性</strong><br>分区容错性约束了一个分布式系统需要具有如下特性：分布式系统在遇到任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境都发生了故障。<br>对于一个分布式系统而言，分区容错性是一个最基本的要求，CAP定理应用中的放弃分区容错性，一种较为简单的做法是将所有的数据（或者仅仅是那些与事务相关的数据）都放在一个分布式节点上，这样就不会碰到由于网络分区带来的负面影响，但放弃P的同时，也就意味着放弃了系统的可扩展性。</li>
</ul>
<h3 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h3><p>BASE是Basically Available(基本可用)、 Soft state(软状态) 和Eventually consistent(最终一致性)三个短语的简写。 BASE是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的总结，是基于CAP定理逐步演化而来的，其核心思想是即使无法做到强一致性(Strong Consistency)，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性(Eventually consistent)。</p>
<ul>
<li><strong>基本可用</strong><br>基本可用是指分布式系统在出现不可预知故障时，允许损失部分可用性，如响应时间上的损失，部分非关键功能上的损失。  </li>
</ul>
<ul>
<li><strong>软状态</strong><br>软状态和是指允许系统中的数据存在中间的状态，并认为该中间状态存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。  </li>
</ul>
<ul>
<li><strong>最终一致性</strong><br>最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态。BASE理论面向的是大型高可用可扩展的分布式系统，和传统事务的ACID强一致性相反，BASE是通过牺牲强一致性来获得可用性，并允许数据在一段时间内是不一致的，但最终达到一致状态。<br>在实际的分布式场景中，不同业务单元和组件对数据一致性的要求是不同的，因此在具体的分布式系统架构设计过程中，ACID特性与BASE理论往往会结合一起使用。  </li>
</ul>
<h3 id="Paxos（帕克索斯）算法"><a href="#Paxos（帕克索斯）算法" class="headerlink" title="Paxos（帕克索斯）算法"></a>Paxos（帕克索斯）算法</h3><p>Paxos是基于消息传递且具有高度容错性的一致性算法。<br>算法要解决的问题就是如何在可能发生的宕机或网络异常的分布式系统中，快速且正确地在集群内部对某个数据的值达成一致，并且保证不论发生以上任何异常，都不会破坏整个系统的一致性。<br>Paxos算法引入了“过半”的理念，通俗的讲就是少数服从多数据的原则。同时，Paxos算法支持分布式节点角色之间的轮换，这极大的避免了分布式单点的出现，因此Paxos算法解决了无限期等待问题，也解决了“脑残”问题，是目前来说最优秀的分布式一致性协议之一。</p>
]]></content>
      
        <categories>
            
            <category> MySQL DBA从小白到大神实战 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle职业直通车-07 重做日志、日志挖掘和回滚段]]></title>
      <url>/2015/04/08/oracle/Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/07_Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6/</url>
      <content type="html"><![CDATA[<h2 id="Oracle的重做日志"><a href="#Oracle的重做日志" class="headerlink" title="Oracle的重做日志"></a>Oracle的重做日志</h2><h3 id="为什么需要redo-log"><a href="#为什么需要redo-log" class="headerlink" title="为什么需要redo log"></a>为什么需要redo log</h3><ul>
<li>内存中数据修改后，不必立即更新到磁盘  —效率</li>
<li>由日志完成数据的保护目的  —效率</li>
<li>其它副产品<ul>
<li>数据恢复（备份集+归档日志）</li>
<li>数据同步（DG ，streams，gg）</li>
<li>日志挖掘</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h3 id="REDO的机制"><a href="#REDO的机制" class="headerlink" title="REDO的机制"></a>REDO的机制</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_01.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_02.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_03.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_04.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_05.png" alt=""></p>
<h3 id="SCN–System-Commit-Number"><a href="#SCN–System-Commit-Number" class="headerlink" title="SCN–System Commit Number"></a>SCN–System Commit Number</h3><p>SCN数据库中顺序增长的一个数字，用来精确的区别操作的先后顺序，比如 commit, rollback or checkpoint<br><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_06.png" alt=""></p>
<h3 id="日志文件"><a href="#日志文件" class="headerlink" title="日志文件"></a>日志文件</h3><h4 id="日志文件使用操作系统块大小"><a href="#日志文件使用操作系统块大小" class="headerlink" title="日志文件使用操作系统块大小"></a>日志文件使用操作系统块大小</h4><ul>
<li>通常是 512 bytes</li>
<li>格式依赖于操作系统和Oracle版本</li>
</ul>
<h4 id="Redo日志组成"><a href="#Redo日志组成" class="headerlink" title="Redo日志组成"></a>Redo日志组成</h4><ul>
<li>数据头</li>
<li>Redo record<br><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_07.png" alt=""></li>
</ul>
<h4 id="Redo-Record"><a href="#Redo-Record" class="headerlink" title="Redo Record"></a>Redo Record</h4><ul>
<li>一个Redo Record记录包括Redo记录头和一个或多个改变向量</li>
<li>每个Redo Record包含每个原子改变的undo和redo</li>
<li>某些改动不需要undo(临时表，直接加载…)</li>
</ul>
<p>单行插入的redo record<br><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_08.png" alt=""></p>
<p>多行插入的redo record<br><img src="http://oligvdnzp.bkt.clouddn.com/1101_oracle_redo_09.png" alt=""></p>
<p>临时表的数据块不产生REDO</p>
<h4 id="Oracle-Dump-Redo-Log-File"><a href="#Oracle-Dump-Redo-Log-File" class="headerlink" title="Oracle Dump Redo Log File"></a>Oracle Dump Redo Log File</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> FORCE_LOGGING,SUPPLEMENTAL_LOG_DATA_MIN from v$database;</span>
<span class="line"></span>
<span class="line">FOR SUPPLEME</span>
<span class="line">--- --------</span>
<span class="line">YES  NO</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database add supplemental <span class="keyword">log</span> data;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> GROUP<span class="comment">#,STATUS from v$log;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment"># STATUS</span></span>
<span class="line">---------- ----------------</span>
<span class="line">         <span class="number">1</span> CURRENT</span>
<span class="line">         <span class="number">2</span> INACTIVE</span>
<span class="line">         <span class="number">3</span> INACTIVE</span>
<span class="line">         <span class="number">4</span> INACTIVE</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> current_scn from v$database;</span>
<span class="line"></span>
<span class="line">CURRENT_SCN</span>
<span class="line">-----------</span>
<span class="line">    <span class="number">6001185</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 新开一个窗口用lyj登陆</span></span>
<span class="line">SQL&gt; conn lyj/lyj</span>
<span class="line"></span>
<span class="line">SQL&gt; insert into test02 <span class="keyword">values</span>(<span class="string">'lyj'</span>,<span class="number">100</span>,sysdate);</span>
<span class="line"></span>
<span class="line"><span class="number">1</span> row created.</span>
<span class="line"></span>
<span class="line">SQL&gt; commit;</span>
<span class="line"></span>
<span class="line">Commit complete.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># 回到一开始的窗口</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> current_scn from v$database;</span>
<span class="line"></span>
<span class="line">CURRENT_SCN</span>
<span class="line">-----------</span>
<span class="line">    <span class="number">6001195</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> group<span class="comment">#,member from v$logfile;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment"># MEMBER</span></span>
<span class="line">---------- --------------------------------------------------</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl/redo03.log</span>
<span class="line">         <span class="number">2</span> /u01/app/oracle/oradata/orcl/redo02.log</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl/redo01.log</span>
<span class="line">         <span class="number">4</span> /u01/app/oracle/oradata/orcl/redo04.log</span>
<span class="line"></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> <span class="keyword">dump</span> logfile <span class="string">'/u01/app/oracle/oradata/orcl/redo01.log'</span> scn min <span class="number">6001185</span> scn max <span class="number">6001195</span>;</span>
<span class="line"></span>
<span class="line">System altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> VALUE from v$diag_info where name=<span class="string">'Default Trace File'</span>;</span>
<span class="line"></span>
<span class="line">VALUE</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/diag</span><span class="regexp">/rdbms/orcl</span><span class="regexp">/orcl/trace</span><span class="regexp">/orcl_ora_5838.trc     # 这个就是一会dump出来的logfile trace了</span>
<span class="line"></span>
<span class="line"># 也可以通过下面方法找到对应的trace文件</span>
<span class="line">oradebug setmypid</span>
<span class="line">oradebug tracefile_name</span>
<span class="line"></span>
<span class="line"># 基于记录块位置导出redo log trace</span>
<span class="line">select distinct dbms_rowid.rowid_relative_fno(rowid) rel_fno,dbms_rowid.rowid_block_number(rowid)blockno from lyj.test02;</span>
<span class="line"></span>
<span class="line">   REL_FNO    BLOCKNO</span>
<span class="line">---------- ----------</span>
<span class="line">        14        643</span>
<span class="line">        14        644</span>
<span class="line"></span>
<span class="line">SQL&gt; col MEMBER for a50</span>
<span class="line">SQL&gt; select a.group#,a.status,b.member from v$log a,v$logfile b where a.group#=b.group#;</span>
<span class="line"></span>
<span class="line">    GROUP# STATUS           MEMBER</span>
<span class="line">---------- ---------------- --------------------------------------------------</span>
<span class="line">         3 CURRENT          /u</span>01/app/oracle/oradata/orcl/redo03.log</span>
<span class="line">         <span class="number">2</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo02.log</span>
<span class="line">         <span class="number">1</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo01.log</span>
<span class="line">         <span class="number">4</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo04.log</span>
<span class="line"></span>
<span class="line">alter <span class="keyword">system</span> <span class="keyword">dump</span> logfile <span class="string">'/u01/app/oracle/oradata/orcl/redo01.log'</span> dba min <span class="number">14</span> <span class="number">643</span> dba max <span class="number">14</span> <span class="number">644</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># chr()函数将ASCII码转换为字符，可用来验证dump出来的内容值</span></span>
<span class="line"><span class="keyword">select</span> <span class="keyword">chr</span>(to_number(<span class="string">'6c'</span>,<span class="string">'xx'</span>)) from dual;</span>
</pre></td></tr></table></figure>
<p>下面是dump出来redo log<br><img src="http://oligvdnzp.bkt.clouddn.com/1102_oracle_redo_01.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1102_oracle_redo_02.png" alt=""></p>
<h4 id="重做向量–redo-vector"><a href="#重做向量–redo-vector" class="headerlink" title="重做向量–redo vector"></a>重做向量–redo vector</h4><ul>
<li>redo vector redo log存放数据库修改数据的信息。</li>
<li>redo vector 里面保存着每个数据块的修改，而不是数据块修改的SQL语句</li>
</ul>
<blockquote>
<p>redo里面记录的信息是物理数据块改变的向量，不是SQL语句</p>
</blockquote>
<h4 id="日志文件镜像"><a href="#日志文件镜像" class="headerlink" title="日志文件镜像"></a>日志文件镜像</h4><p>为了保证日志文件的安全，应该给每个日志文件增加镜像文件，LGWR将向每组多个日志文件同时写入数据<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter database add logfile member <span class="string">'/u01/app/oracle/oradata/orcl/redo05.log'</span> to group <span class="number">1</span>;</span>
<span class="line">alter database add logfile member <span class="string">'/u01/app/oracle/oradata/orcl/redo06.log'</span> to group <span class="number">2</span>;</span>
<span class="line">alter database add logfile member <span class="string">'/u01/app/oracle/oradata/orcl/redo07.log'</span> to group <span class="number">3</span>;</span>
<span class="line">alter database add logfile member <span class="string">'/u01/app/oracle/oradata/orcl/redo08.log'</span> to group <span class="number">4</span>;</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> group<span class="comment">#,member from v$logfile order by 1;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment"># MEMBER</span></span>
<span class="line">---------- --------------------------------------------------</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl/redo01.log</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl/redo05.log</span>
<span class="line">         <span class="number">2</span> /u01/app/oracle/oradata/orcl/redo02.log</span>
<span class="line">         <span class="number">2</span> /u01/app/oracle/oradata/orcl/redo06.log</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl/redo07.log</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl/redo03.log</span>
<span class="line">         <span class="number">4</span> /u01/app/oracle/oradata/orcl/redo08.log</span>
<span class="line">         <span class="number">4</span> /u01/app/oracle/oradata/orcl/redo04.log</span>
</pre></td></tr></table></figure></p>
<h2 id="日志挖掘-logminer"><a href="#日志挖掘-logminer" class="headerlink" title="日志挖掘-logminer"></a>日志挖掘-logminer</h2><h3 id="日志挖掘工具包dbms-logmnr"><a href="#日志挖掘工具包dbms-logmnr" class="headerlink" title="日志挖掘工具包dbms_logmnr"></a>日志挖掘工具包dbms_logmnr</h3><ul>
<li>可以基于日志文件分析（一个或者多个）</li>
<li>可以基于时间段分析</li>
<li>可以基于SCN分析</li>
</ul>
<h3 id="logminer日志挖掘"><a href="#logminer日志挖掘" class="headerlink" title="logminer日志挖掘"></a>logminer日志挖掘</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">col MEMBER <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> a.group<span class="comment">#,a.status,b.member from v$log a,v$logfile b where a.group#=b.group# order by 1;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment"># STATUS           MEMBER</span></span>
<span class="line">---------- ---------------- --------------------------------------------------</span>
<span class="line">         <span class="number">1</span> CURRENT          /u01/app/oracle/oradata/orcl/redo01.log</span>
<span class="line">         <span class="number">1</span> CURRENT          /u01/app/oracle/oradata/orcl/redo05.log</span>
<span class="line">         <span class="number">2</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo02.log</span>
<span class="line">         <span class="number">2</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo06.log</span>
<span class="line">         <span class="number">3</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo07.log</span>
<span class="line">         <span class="number">3</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo03.log</span>
<span class="line">         <span class="number">4</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo08.log</span>
<span class="line">         <span class="number">4</span> INACTIVE         /u01/app/oracle/oradata/orcl/redo04.log</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> dbms_flashback.get_system_change_number from dual;</span>
<span class="line"></span>
<span class="line">GET_SYSTEM_CHANGE_NUMBER</span>
<span class="line">------------------------</span>
<span class="line">                 <span class="number">6008670</span></span>
<span class="line"></span>
<span class="line">insert into lyj.test02 <span class="keyword">values</span>(<span class="string">'lyj'</span>,<span class="number">101</span>,sysdate);</span>
<span class="line">commit;</span>
<span class="line"><span class="keyword">select</span> dbms_flashback.get_system_change_number from dual;</span>
<span class="line"></span>
<span class="line">GET_SYSTEM_CHANGE_NUMBER</span>
<span class="line">------------------------</span>
<span class="line">                 <span class="number">6008691</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 第一个logfile</span></span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.add_logfile(<span class="string">logfilename=&gt;</span><span class="string">'/u01/app/oracle/oradata/orcl/redo01.log'</span>, <span class="string">options=&gt;</span>dbms_logmnr.new);</span>
<span class="line"><span class="comment"># 追加logfile</span></span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.add_logfile(<span class="string">logfilename=&gt;</span><span class="string">'/u01/app/oracle/oradata/orcl/redo02.log'</span>, <span class="string">options=&gt;</span>dbms_logmnr.addfile);</span>
<span class="line"></span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.start_logmnr(<span class="string">options=&gt;</span>dbms_logmnr.dict_from_online_catalog,<span class="string">startscn=&gt;</span><span class="number">6008670</span>,<span class="string">endscn=&gt;</span><span class="number">6008691</span>);</span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.start_logmnr(<span class="string">options=&gt;</span>dbms_logmnr.dict_from_online_catalog,<span class="string">startscn=&gt;</span>&amp;startscn,<span class="string">endscn=&gt;</span>&amp;endscn);</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="comment"># v$logmnr_contents里的内容是实时从加载的logfile中抽取的</span></span>
<span class="line">col OPERATION <span class="keyword">for</span> a15</span>
<span class="line">col SQL_REDO <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">col SQL_UNDO <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> operation,sql_redo,sql_undo from v$logmnr_contents;</span>
<span class="line"></span>
<span class="line">OPERATION       SQL_REDO                                           SQL_UNDO</span>
<span class="line">--------------- -------------------------------------------------- --------------------------------------------------</span>
<span class="line">START           set transaction <span class="keyword">read</span> <span class="keyword">write</span>;</span>
<span class="line">INSERT          insert into <span class="string">"LYJ"</span>.<span class="string">"TEST02"</span>(<span class="string">"USERNAME"</span>,<span class="string">"USER_ID"</span>,<span class="string">"C delete from "</span>LYJ<span class="string">"."</span>TEST02<span class="string">" where "</span>USERNAME<span class="string">" = 'lyj'</span>
<span class="line">                REATED"</span>) <span class="keyword">values</span> (<span class="string">'lyj'</span>,<span class="string">'101'</span>,TO_DATE(<span class="string">'2017-11-02 1  and "USER_ID" = '</span><span class="number">101</span><span class="string">' and "CREATED" = TO_DATE('</span><span class="number">2</span></span>
<span class="line">                <span class="number">5</span>:<span class="number">51</span>:<span class="number">24</span><span class="string">', '</span>yyyy-mm-dd hh24:mi:ss<span class="string">'));               017-11-02 15:51:24'</span>, <span class="string">'yyyy-mm-dd hh24:mi:ss'</span>) <span class="keyword">and</span></span>
<span class="line">                                                                   ROWID = <span class="string">'AAAWG0AAOAAAAKFAAA'</span>;</span>
<span class="line"></span>
<span class="line">COMMIT          commit;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看更详细的信息</span></span>
<span class="line"><span class="keyword">select</span> username,session_info,operation,sql_redo,sql_undo from v$logmnr_contents;</span>
<span class="line"></span>
<span class="line"><span class="comment">#关闭logmnr</span></span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.end_logmnr;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 注意需要开启附加日志</span></span>
<span class="line">alter database add supplemental <span class="keyword">log</span> data;</span>
</pre></td></tr></table></figure>
<h2 id="Oracle的回滚段"><a href="#Oracle的回滚段" class="headerlink" title="Oracle的回滚段"></a>Oracle的回滚段</h2><h3 id="undo和redo"><a href="#undo和redo" class="headerlink" title="undo和redo"></a>undo和redo</h3><ul>
<li>undo 用于撤销修改的操作（事务回滚）</li>
<li>redo 用于讲数据的修改重演一遍（恢复）</li>
</ul>
<h3 id="UNDO的目的"><a href="#UNDO的目的" class="headerlink" title="UNDO的目的"></a>UNDO的目的</h3><ul>
<li>事务的回滚</li>
<li>实例的恢复</li>
<li>提供查询的一致性读</li>
</ul>
<h3 id="回滚段和事务的联系"><a href="#回滚段和事务的联系" class="headerlink" title="回滚段和事务的联系"></a>回滚段和事务的联系</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line">grant <span class="keyword">select</span> on v<span class="number">_</span>$transaction to lyj;</span>
<span class="line"></span>
<span class="line">conn lyj/lyj</span>
<span class="line">insert into t <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">'jz'</span>);</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> xid,xidusn,xidslot,xidsqn,ubafil,ubablk,ubasqn from v$transaction;</span>
<span class="line"></span>
<span class="line">XID                  XIDUSN    XIDSLOT     XIDSQN     UBAFIL     UBABLK     UBASQN</span>
<span class="line">---------------- ---------- ---------- ---------- ---------- ---------- ----------</span>
<span class="line">0E0016006708000<span class="number">0</span>         <span class="number">14</span>         <span class="number">22</span>       <span class="number">2151</span>          <span class="number">7</span>      <span class="number">20147</span>        <span class="number">600</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> to_number(<span class="string">'0E'</span>,<span class="string">'xxxx'</span>),to_number(<span class="string">'0016'</span>,<span class="string">'xxxx'</span>),to_number(<span class="string">'0867'</span>,<span class="string">'xxxxxx'</span>) from dual;</span>
<span class="line"></span>
<span class="line">TO_NUMBER(<span class="string">'0E'</span>,<span class="string">'XXXX'</span>) TO_NUMBER(<span class="string">'0016'</span>,<span class="string">'XXXX'</span>) TO_NUMBER(<span class="string">'0867'</span>,<span class="string">'XXXXXX'</span>)</span>
<span class="line">---------------------- ------------------------ --------------------------</span>
<span class="line">                    <span class="number">14</span>                       <span class="number">22</span>                       <span class="number">2151</span></span>
<span class="line"><span class="comment"># XID 事务号，事务唯一标识</span></span>
<span class="line"><span class="comment"># XIDUSN  回滚段</span></span>
<span class="line"><span class="comment"># XIDSLOT 回滚段槽</span></span>
<span class="line"><span class="comment"># XIDSQN  回滚段序列号</span></span>
<span class="line"><span class="comment"># UBAFIL  回滚段所在的文件号</span></span>
<span class="line"><span class="comment"># UBABLK  回滚段所在的文件号的块</span></span>
<span class="line"><span class="comment"># UBASQN  回滚段所在的文件号的序列号</span></span>
</pre></td></tr></table></figure>
<h3 id="事务回滚机制"><a href="#事务回滚机制" class="headerlink" title="事务回滚机制"></a>事务回滚机制</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/1103_oracle_undo_01.png" alt=""></p>
<h3 id="回滚段的逻辑结构"><a href="#回滚段的逻辑结构" class="headerlink" title="回滚段的逻辑结构"></a>回滚段的逻辑结构</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/1103_oracle_undo_02.png" alt=""></p>
<h3 id="回滚段的空间使用机制"><a href="#回滚段的空间使用机制" class="headerlink" title="回滚段的空间使用机制"></a>回滚段的空间使用机制</h3><h4 id="增长"><a href="#增长" class="headerlink" title="增长"></a>增长</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/1103_oracle_undo_03.png" alt=""></p>
<h4 id="回收"><a href="#回收" class="headerlink" title="回收"></a>回收</h4><p><img src="http://oligvdnzp.bkt.clouddn.com/1103_oracle_undo_04.png" alt=""></p>
<h3 id="一致性读"><a href="#一致性读" class="headerlink" title="一致性读"></a>一致性读</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/1103_oracle_undo_05.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1103_oracle_undo_06.png" alt=""></p>
<h3 id="UNDO的相关参数"><a href="#UNDO的相关参数" class="headerlink" title="UNDO的相关参数"></a>UNDO的相关参数</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; show parameter undo</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">undo_management                      string      AUTO</span>
<span class="line">undo_retention                       integer     <span class="number">900</span></span>
<span class="line">undo_tablespace                      string      UNDOTBS2</span>
<span class="line"></span>
<span class="line"><span class="comment"># 注意：undo_retention是一个动态调整的参数，同时，Oracle无法保证在这个保留时间内的UNO数据不被覆盖</span></span>
<span class="line"><span class="comment"># 当UNDO空间不足时，Oracle将覆盖即使未过保留期的数据以释放空间。</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 强制保留undo_retention时间内的数据</span></span>
<span class="line">alter tablespace UNDOTBS2 retention guarantee;</span>
<span class="line">alter tablespace UNDOTBS2 retention noguarantee;</span>
</pre></td></tr></table></figure>
<h3 id="UNDO的相关视图"><a href="#UNDO的相关视图" class="headerlink" title="UNDO的相关视图"></a>UNDO的相关视图</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># v$rollstat  v$rollname</span></span>
<span class="line">set line <span class="number">150</span></span>
<span class="line">set pagesize <span class="number">9999</span></span>
<span class="line"><span class="keyword">select</span> a.usn,b.name,extents,rssize,shrinks,wraps,extends,status</span>
<span class="line">  from v$rollstat a,v$rollname b</span>
<span class="line">  where a.usn=b.usn;</span>
<span class="line"></span>
<span class="line">       USN NAME                              EXTENTS     RSSIZE    SHRINKS      WRAPS    EXTENDS STATUS</span>
<span class="line">---------- ------------------------------ ---------- ---------- ---------- ---------- ---------- ---------------</span>
<span class="line">         <span class="number">0</span> SYSTEM                                  <span class="number">6</span>     <span class="number">385024</span>          <span class="number">0</span>          <span class="number">0</span>          <span class="number">0</span> ONLINE</span>
<span class="line">        <span class="number">11</span> _SYSSMU11_1119644918$                  <span class="number">16</span>   <span class="number">14802944</span>          <span class="number">6</span>         <span class="number">30</span>         <span class="number">16</span> ONLINE</span>
<span class="line">        <span class="number">12</span> _SYSSMU12_2617804053$                  <span class="number">13</span>   <span class="number">11657216</span>          <span class="number">5</span>         <span class="number">28</span>         <span class="number">12</span> ONLINE</span>
<span class="line">        <span class="number">13</span> _SYSSMU13_142672783$                   <span class="number">14</span>   <span class="number">12705792</span>          <span class="number">4</span>         <span class="number">31</span>         <span class="number">16</span> ONLINE</span>
<span class="line">        <span class="number">14</span> _SYSSMU14_3304230682$                   <span class="number">9</span>    <span class="number">7462912</span>          <span class="number">9</span>         <span class="number">47</span>         <span class="number">40</span> ONLINE</span>
<span class="line">        <span class="number">15</span> _SYSSMU15_1030784191$                  <span class="number">28</span>   <span class="number">27385856</span>          <span class="number">7</span>         <span class="number">54</span>         <span class="number">38</span> ONLINE</span>
<span class="line">        <span class="number">16</span> _SYSSMU16_2346225559$                  <span class="number">29</span>   <span class="number">28434432</span>         <span class="number">14</span>         <span class="number">51</span>         <span class="number">35</span> ONLINE</span>
<span class="line">        <span class="number">17</span> _SYSSMU17_4024467071$                  <span class="number">13</span>   <span class="number">11657216</span>         <span class="number">17</span>         <span class="number">29</span>         <span class="number">25</span> ONLINE</span>
<span class="line">        <span class="number">18</span> _SYSSMU18_2055119062$                  <span class="number">12</span>   <span class="number">10608640</span>          <span class="number">6</span>         <span class="number">26</span>         <span class="number">12</span> ONLINE</span>
<span class="line">        <span class="number">19</span> _SYSSMU19_3736672493$                  <span class="number">24</span>   <span class="number">23191552</span>          <span class="number">5</span>         <span class="number">41</span>         <span class="number">16</span> ONLINE</span>
<span class="line">        <span class="number">20</span> _SYSSMU20_59879734<span class="number">0</span>$                   <span class="number">23</span>   <span class="number">22142976</span>          <span class="number">8</span>         <span class="number">39</span>         <span class="number">25</span> ONLINE</span>
<span class="line"></span>
<span class="line"><span class="comment"># v$undostat: 视图中保留4天的数据，每次快照10分钟，再早的数据保留在DBA_HIST_UNDOSTAT视图中</span></span>
<span class="line"><span class="keyword">select</span> to_char(begin_time,<span class="string">'hh24:mi'</span>),to_char(end_time,<span class="string">'hh24:mi'</span>),</span>
<span class="line">       undoblks,txncount,maxquerylen,maxqueryid,maxconcurrency,</span>
<span class="line">       ssolderrcnt,nospaceerrcnt,activeblks,tuned_undoretention</span>
<span class="line">   from v$undostat;</span>
<span class="line">TO_CH TO_CH   UNDOBLKS   TXNCOUNT MAXQUERYLEN MAXQUERYID    MAXCONCURRENCY SSOLDERRCNT NOSPACEERRCNT ACTIVEBLKS TUNED_UNDORETENTION</span>
<span class="line">----- ----- ---------- ---------- ----------- ------------- -------------- ----------- ------------- ---------- -------------------</span>
<span class="line"><span class="number">18</span>:<span class="number">12</span> <span class="number">18</span>:<span class="number">13</span>          <span class="number">0</span>          <span class="number">0</span>         <span class="number">488</span> 0rc4km05kgzb9              <span class="number">0</span>           <span class="number">0</span>             <span class="number">0</span>        <span class="number">160</span>              <span class="number">273926</span></span>
<span class="line"><span class="number">18</span>:<span class="number">02</span> <span class="number">18</span>:<span class="number">12</span>          <span class="number">8</span>        <span class="number">250</span>         <span class="number">488</span> 0rc4km05kgzb9              <span class="number">1</span>           <span class="number">0</span>             <span class="number">0</span>        <span class="number">160</span>              <span class="number">273926</span></span>
<span class="line"><span class="number">17</span>:<span class="number">52</span> <span class="number">18</span>:<span class="number">02</span>         <span class="number">95</span>         <span class="number">75</span>        <span class="number">1091</span> 0rc4km05kgzb9              <span class="number">3</span>           <span class="number">0</span>             <span class="number">0</span>        <span class="number">288</span>              <span class="number">273449</span></span>
<span class="line"><span class="number">17</span>:<span class="number">42</span> <span class="number">17</span>:<span class="number">52</span>          <span class="number">2</span>         <span class="number">14</span>         <span class="number">491</span> 0rc4km05kgzb9              <span class="number">2</span>           <span class="number">0</span>             <span class="number">0</span>        <span class="number">288</span>              <span class="number">276548</span></span>
<span class="line"><span class="number">17</span>:<span class="number">32</span> <span class="number">17</span>:<span class="number">42</span>          <span class="number">2</span>         <span class="number">65</span>        <span class="number">1096</span> 0rc4km05kgzb9              <span class="number">2</span>           <span class="number">0</span>             <span class="number">0</span>        <span class="number">288</span>              <span class="number">275981</span></span>
<span class="line"><span class="number">17</span>:<span class="number">22</span> <span class="number">17</span>:<span class="number">32</span>          <span class="number">0</span>          <span class="number">4</span>         <span class="number">495</span> 0rc4km05kgzb9              <span class="number">1</span>           <span class="number">0</span>             <span class="number">0</span>        <span class="number">288</span>              <span class="number">275412</span></span>
<span class="line">......</span>
</pre></td></tr></table></figure>
<h2 id="本课作业"><a href="#本课作业" class="headerlink" title="本课作业"></a>本课作业</h2><h3 id="用图示展示Oracle更新一条数据然后提交的整个经过（包括undo-redo-后台进程-，并辅助语言描述。"><a href="#用图示展示Oracle更新一条数据然后提交的整个经过（包括undo-redo-后台进程-，并辅助语言描述。" class="headerlink" title="用图示展示Oracle更新一条数据然后提交的整个经过（包括undo,redo,后台进程)，并辅助语言描述。"></a>用图示展示Oracle更新一条数据然后提交的整个经过（包括undo,redo,后台进程)，并辅助语言描述。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 示例语句</span></span>
<span class="line">update emp set sal=<span class="number">2000</span> where id=<span class="number">1</span>;</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure>
<p>数据块(id=1)从磁盘中被读入内存（除非它已经在内存中），同时undo数据块也被读取到内存中（除非它已经在内存中），回滚段块保留了数据前映像(1000)，由于回滚段的数据被修改了，因此一条redo信息记录了undo数据块的修改操作<br><img src="http://oligvdnzp.bkt.clouddn.com/1102_oracle_redo_03.png" alt=""></p>
<p>数据块中原数据被修改(2000)，由于数据发生改变，因此一条redo信息记录了数据块的修改操作<br><img src="http://oligvdnzp.bkt.clouddn.com/1102_oracle_redo_04.png" alt=""></p>
<p>commit执行后，一个commit的标识被记录在redo日志中，LGWR进程将redo log buffer中的内容写到redo log file中<br><img src="http://oligvdnzp.bkt.clouddn.com/1102_oracle_redo_05.png" alt=""></p>
<h3 id="演示一个UPDATE操作，从相关视图中查询产生的UNDO和REDO大小，给出操作过程。"><a href="#演示一个UPDATE操作，从相关视图中查询产生的UNDO和REDO大小，给出操作过程。" class="headerlink" title="演示一个UPDATE操作，从相关视图中查询产生的UNDO和REDO大小，给出操作过程。"></a>演示一个UPDATE操作，从相关视图中查询产生的UNDO和REDO大小，给出操作过程。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">grant <span class="keyword">select</span> on v<span class="number">_</span>$mystat to lyj;</span>
<span class="line">grant <span class="keyword">select</span> on v<span class="number">_</span>$statname to lyj;</span>
<span class="line"></span>
<span class="line">conn lyj/lyj</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                              <span class="number">1600</span></span>
<span class="line">undo change vector size                                                 <span class="number">188</span></span>
<span class="line"></span>
<span class="line">SQL&gt; update test03 set id=<span class="number">1000</span> where id&lt;<span class="number">8</span>;</span>
<span class="line"></span>
<span class="line"><span class="number">7</span> rows updated.</span>
<span class="line"></span>
<span class="line">SQL&gt; commit;</span>
<span class="line"></span>
<span class="line">Commit complete.</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                              <span class="number">4000</span></span>
<span class="line">undo change vector size                                                <span class="number">1044</span></span>
<span class="line"></span>
<span class="line">产生的REDO大小为(<span class="number">4000</span>-<span class="number">1600</span>)  UNDO大小为(<span class="number">1044</span>-<span class="number">188</span>)</span>
</pre></td></tr></table></figure>
<h3 id="比较操作相同的数据，INSERT-DELETE和UPDATE各自产生的UNDO和REDO的大小，给出一个对比的列表，并说明导致这种差异的原因。"><a href="#比较操作相同的数据，INSERT-DELETE和UPDATE各自产生的UNDO和REDO的大小，给出一个对比的列表，并说明导致这种差异的原因。" class="headerlink" title="比较操作相同的数据，INSERT,DELETE和UPDATE各自产生的UNDO和REDO的大小，给出一个对比的列表，并说明导致这种差异的原因。"></a>比较操作相同的数据，INSERT,DELETE和UPDATE各自产生的UNDO和REDO的大小，给出一个对比的列表，并说明导致这种差异的原因。</h3><p>分别执行insert，delete，update语句后，产生的undo和redo的大小如图所示<br><img src="http://oligvdnzp.bkt.clouddn.com/1102_oracle_redo_07.png" alt=""><br>结论：</p>
<ol>
<li>insert产生的redo大小是由数据插入的redo和undo(回滚)产生的redo两部分组成，回滚是delete操作，产生的undo最少，相应的undo产生的redo就也少</li>
<li>delete产生的redo的大小是由数据删除和数据回滚的redo两部分组成，删除是delete操作，产生的redo最小，回滚是insert操作，相对产生的undo会多一些</li>
<li>update产生的redo和undo都是对数据的修改，产生的redo(含undo产生的redo)相比insert和delete操作产生的redo就要多</li>
</ol>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                              <span class="number">8076</span></span>
<span class="line">undo change vector size                                                <span class="number">1720</span></span>
<span class="line"></span>
<span class="line">SQL&gt; </span>
<span class="line">SQL&gt; insert into t <span class="keyword">values</span> (<span class="number">2</span>);</span>
<span class="line"></span>
<span class="line"><span class="number">1</span> row created.</span>
<span class="line"></span>
<span class="line">SQL&gt; commit;</span>
<span class="line"></span>
<span class="line">Commit complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                              <span class="number">8724</span></span>
<span class="line">undo change vector size                                                <span class="number">1856</span></span>
<span class="line"></span>
<span class="line">SQL&gt; </span>
<span class="line">SQL&gt; update t set id=<span class="number">6</span> where id=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line"><span class="number">1</span> row updated.</span>
<span class="line"></span>
<span class="line">SQL&gt; commit;</span>
<span class="line"></span>
<span class="line">Commit complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                              <span class="number">9456</span></span>
<span class="line">undo change vector size                                                <span class="number">2040</span></span>
<span class="line"></span>
<span class="line">SQL&gt; </span>
<span class="line">SQL&gt; <span class="keyword">delete</span> from t where id=<span class="number">6</span>;</span>
<span class="line"></span>
<span class="line"><span class="number">1</span> row deleted.</span>
<span class="line"></span>
<span class="line">SQL&gt; commit;</span>
<span class="line"></span>
<span class="line">Commit complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                             <span class="number">10172</span></span>
<span class="line">undo change vector size                                                <span class="number">2236</span></span>
</pre></td></tr></table></figure>
<h3 id="DDL操作是否产生UNDO和REDO，用示例说明，并说明原因。"><a href="#DDL操作是否产生UNDO和REDO，用示例说明，并说明原因。" class="headerlink" title="DDL操作是否产生UNDO和REDO，用示例说明，并说明原因。"></a>DDL操作是否产生UNDO和REDO，用示例说明，并说明原因。</h3><p>DDL操作产生UNDO和REDO，原因是：</p>
<ol>
<li>DDL操作产生的redo是因为DDL修改的字典表和一些段头信息产生的redo</li>
<li>DDL操作所产生的undo量视乎其所要维护数据字典的操作类型和操作量。DDL执行失败也产生少量undo，因为执行少量递归操作后，Oracle发现所要drop的对象并不存在，将会rollback之前的”部分”递归dml操作</li>
</ol>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 当t表存在时</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                             <span class="number">10172</span></span>
<span class="line">undo change vector size                                                <span class="number">2236</span></span>
<span class="line"></span>
<span class="line">SQL&gt; drop table t purge;</span>
<span class="line"></span>
<span class="line">Table dropped.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                             <span class="number">20068</span></span>
<span class="line">undo change vector size                                                <span class="number">5716</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 当T表不存在时</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                             <span class="number">21232</span></span>
<span class="line">undo change vector size                                                <span class="number">5956</span></span>
<span class="line"></span>
<span class="line">SQL&gt; drop table t purge;</span>
<span class="line">drop table t purge</span>
<span class="line">           *</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">00</span>942: table <span class="keyword">or</span> view does <span class="keyword">not</span> exist</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                             <span class="number">22396</span></span>
<span class="line">undo change vector size                                                <span class="number">6196</span></span>
</pre></td></tr></table></figure>
<h3 id="通过一个示例，演示利用logminer，恢复delete误删除操作的数据。"><a href="#通过一个示例，演示利用logminer，恢复delete误删除操作的数据。" class="headerlink" title="通过一个示例，演示利用logminer，恢复delete误删除操作的数据。"></a>通过一个示例，演示利用logminer，恢复delete误删除操作的数据。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; show user</span>
<span class="line">USER is <span class="string">"LYJ"</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> * from t;</span>
<span class="line"></span>
<span class="line">        ID NAME</span>
<span class="line">---------- ----------</span>
<span class="line">         <span class="number">1</span> lyj</span>
<span class="line">         <span class="number">2</span> zc</span>
<span class="line">SQL&gt; <span class="keyword">delete</span> from t where id=<span class="number">2</span>;</span>
<span class="line"></span>
<span class="line"><span class="number">1</span> row deleted.</span>
<span class="line"></span>
<span class="line">SQL&gt; commit;</span>
<span class="line"></span>
<span class="line">Commit complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; conn / as sysdba</span>
<span class="line">Connected.</span>
<span class="line"></span>
<span class="line"><span class="comment"># 记录下删除后大致的系统时间</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> sysdate from dual;</span>
<span class="line"></span>
<span class="line">SYSDATE</span>
<span class="line">-------------------</span>
<span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">03</span> <span class="number">10</span>:<span class="number">26</span>:<span class="number">11</span></span>
<span class="line"></span>
<span class="line">SQL&gt; col member <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.group<span class="comment">#,b.member,a.status from v$log a,v$logfile b where a.group#=b.group# order by 1;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment"># MEMBER                                             STATUS</span></span>
<span class="line">---------- -------------------------------------------------- ----------------</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl/redo01.log            INACTIVE</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl/redo05.log            INACTIVE</span>
<span class="line">         <span class="number">2</span> /u01/app/oracle/oradata/orcl/redo02.log            CURRENT</span>
<span class="line">         <span class="number">2</span> /u01/app/oracle/oradata/orcl/redo06.log            CURRENT</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl/redo07.log            INACTIVE</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl/redo03.log            INACTIVE</span>
<span class="line">         <span class="number">4</span> /u01/app/oracle/oradata/orcl/redo08.log            INACTIVE</span>
<span class="line">         <span class="number">4</span> /u01/app/oracle/oradata/orcl/redo04.log            INACTIVE</span>
<span class="line"></span>
<span class="line"><span class="comment"># 加载当前的日志组文件</span></span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.add_logfile(<span class="string">logfilename=&gt;</span><span class="string">'/u01/app/oracle/oradata/orcl/redo02.log'</span>, <span class="string">options=&gt;</span>dbms_logmnr.new);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 如果不确定日志组是否已切换可以添加其他日志组文件</span></span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.add_logfile(<span class="string">logfilename=&gt;</span><span class="string">'/u01/app/oracle/oradata/orcl/redo02.log'</span>, <span class="string">options=&gt;</span>dbms_logmnr.addfile);</span>
<span class="line"></span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.start_logmnr(<span class="string">options=&gt;</span>dbms_logmnr.dict_from_online_catalog,<span class="string">starttime=&gt;</span>to_date(<span class="string">'2017-11-03 10:24:00'</span>,<span class="string">'yyyy-mm-dd hh24:mi:ss'</span>),<span class="string">endtime=&gt;</span>to_date(<span class="string">'2017-11-03 10:26:11'</span>,<span class="string">'yyyy-mm-dd hh24:mi:ss'</span>)); </span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看logminer挖掘内容</span></span>
<span class="line">set line <span class="number">150</span></span>
<span class="line">set pagesize <span class="number">9999</span></span>
<span class="line">col operation <span class="keyword">for</span> a15</span>
<span class="line">col sql_redo <span class="keyword">for</span> a6<span class="number">0</span></span>
<span class="line">col sql_undo <span class="keyword">for</span> a6<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> operation,sql_redo,sql_undo from v$logmnr_contents where seg_owner=<span class="string">'LYJ'</span> <span class="keyword">and</span> operation=<span class="string">'DELETE'</span>;</span>
<span class="line"></span>
<span class="line">OPERATION       SQL_REDO                                                     SQL_UNDO</span>
<span class="line">--------------- ------------------------------------------------------------ ------------------------------------------------------------</span>
<span class="line">DELETE          <span class="keyword">delete</span> from <span class="string">"LYJ"</span>.<span class="string">"T"</span> where <span class="string">"ID"</span> = <span class="string">'2'</span> <span class="keyword">and</span> <span class="string">"NAME"</span> = <span class="string">'zc'</span> <span class="keyword">and</span> insert into <span class="string">"LYJ"</span>.<span class="string">"T"</span>(<span class="string">"ID"</span>,<span class="string">"NAME"</span>) <span class="keyword">values</span> (<span class="string">'2'</span>,<span class="string">'zc'</span>);</span>
<span class="line">                 ROWID = <span class="string">'AAAWH7AAOAAAAKOAAB'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment">#关闭logmnr</span></span>
<span class="line"><span class="keyword">exec</span> dbms_logmnr.end_logmnr;</span>
<span class="line"></span>
<span class="line"><span class="comment"># SQL_UNDO里就是恢复delete误删除操作的语句</span></span>
<span class="line">insert into <span class="string">"LYJ"</span>.<span class="string">"T"</span>(<span class="string">"ID"</span>,<span class="string">"NAME"</span>) <span class="keyword">values</span> (<span class="string">'2'</span>,<span class="string">'zc'</span>);</span>
<span class="line">commit;</span>
</pre></td></tr></table></figure>
<h3 id="示例演示回滚是否产生REDO日志。"><a href="#示例演示回滚是否产生REDO日志。" class="headerlink" title="示例演示回滚是否产生REDO日志。"></a>示例演示回滚是否产生REDO日志。</h3><p>回滚产生REDO日志，示例如下：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                              <span class="number">1604</span></span>
<span class="line">undo change vector size                                                 <span class="number">188</span></span>
<span class="line"></span>
<span class="line">SQL&gt; update t set id=<span class="number">6</span> where id=<span class="number">2</span>;</span>
<span class="line"></span>
<span class="line"><span class="number">1</span> row updated.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                              <span class="number">2172</span></span>
<span class="line">undo change vector size                                                 <span class="number">372</span></span>
<span class="line"></span>
<span class="line">SQL&gt; rollback;</span>
<span class="line"></span>
<span class="line">Rollback complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> b.name,a.value from v$mystat a,v$statname b </span>
<span class="line">  <span class="number">2</span>    where a.statistic<span class="comment">#=b.statistic# and (b.name='redo size' or b.name='undo change vector size');</span></span>
<span class="line"></span>
<span class="line">NAME                                                                  VALUE</span>
<span class="line">---------------------------------------------------------------- ----------</span>
<span class="line"><span class="keyword">redo</span> size                                                              <span class="number">2700</span></span>
<span class="line">undo change vector size                                                 <span class="number">372</span></span>
</pre></td></tr></table></figure></p>
<h3 id="示例演示为数据库创建一个新的UNDO表空间。"><a href="#示例演示为数据库创建一个新的UNDO表空间。" class="headerlink" title="示例演示为数据库创建一个新的UNDO表空间。"></a>示例演示为数据库创建一个新的UNDO表空间。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; create undo tablespace undotablespace datafile <span class="string">'/u01/app/oracle/oradata/orcl/undotablespace.dbf'</span> size <span class="number">100</span><span class="keyword">m</span> autoextend on <span class="keyword">next</span> <span class="number">100</span><span class="keyword">m</span>;</span>
<span class="line"></span>
<span class="line">Tablespace created.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> set undo_tablespace=<span class="string">'undotablespace'</span>;</span>
<span class="line"></span>
<span class="line">System altered.</span>
</pre></td></tr></table></figure>
<h3 id="示例分别说明什么是consistent-read和current-read"><a href="#示例分别说明什么是consistent-read和current-read" class="headerlink" title="示例分别说明什么是consistent read和current read?"></a>示例分别说明什么是consistent read和current read?</h3><p>从内存中读取数据块，包括<code>consistent read</code>和<code>current read</code>，其中<code>current read</code>又叫做<code>db block gets</code>，逻辑读 = <code>db block gets + consistent read</code>。</p>
<ul>
<li><code>consistent gets</code>：查询最终出结果的数据是查询开始的时间点的，若存在block在查询开始后发生了变化的情况，则会从回滚段中读<code>before image</code>数据，这就是一致性读。<font color="red">一致性读并非总要去读取回滚段。</font></li>
<li><code>db block gets</code>：current read, 不管这个块上的数据是否存在<code>before image</code>，也就是说不管是否存在回滚中数据，只看见当前最新块的数据。比如DML的时候不需要看见别人更改前的数据，而是看见正在更改的，同时操作相同数据会被lock住。<code>current read</code>一次操作（查询）中的数据可能不在同一个时间点上。</li>
</ul>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; set autot trace <span class="keyword">stat</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> * from test01;</span>
<span class="line"></span>
<span class="line"><span class="number">68316</span> rows selected.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Statistics</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">         <span class="number">85</span>  recursive calls</span>
<span class="line">          <span class="number">0</span>  db block gets</span>
<span class="line">       <span class="number">5663</span>  consistent gets</span>
<span class="line">       <span class="number">1009</span>  physical reads</span>
<span class="line">          <span class="number">0</span>  <span class="keyword">redo</span> size</span>
<span class="line">    <span class="number">7935177</span>  bytes sent via SQL*Net to client</span>
<span class="line">      <span class="number">50614</span>  bytes received via SQL*Net from client</span>
<span class="line">       <span class="number">4556</span>  SQL*Net roundtrips to/from client</span>
<span class="line">         <span class="number">12</span>  sorts (memory)</span>
<span class="line">          <span class="number">0</span>  sorts (disk)</span>
<span class="line">      <span class="number">68316</span>  rows processed</span>
<span class="line"></span>
<span class="line">SQL&gt; update test01 set object_id=object_id+<span class="number">10</span> where object_id&lt;<span class="number">500</span>;</span>
<span class="line"></span>
<span class="line"><span class="number">10</span> rows updated.</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">Statistics</span>
<span class="line">----------------------------------------------------------</span>
<span class="line">         <span class="number">89</span>  recursive calls</span>
<span class="line">         <span class="number">12</span>  db block gets      <span class="comment"># current read</span></span>
<span class="line">       <span class="number">1155</span>  consistent gets</span>
<span class="line">         <span class="number">13</span>  physical reads</span>
<span class="line">       <span class="number">2980</span>  <span class="keyword">redo</span> size</span>
<span class="line">        <span class="number">842</span>  bytes sent via SQL*Net to client</span>
<span class="line">        <span class="number">813</span>  bytes received via SQL*Net from client</span>
<span class="line">          <span class="number">3</span>  SQL*Net roundtrips to/from client</span>
<span class="line">         <span class="number">24</span>  sorts (memory)</span>
<span class="line">          <span class="number">0</span>  sorts (disk)</span>
<span class="line">         <span class="number">10</span>  rows processed</span>
</pre></td></tr></table></figure>
<h3 id="示例演示一个导致ora-01555错误的场景。"><a href="#示例演示一个导致ora-01555错误的场景。" class="headerlink" title="示例演示一个导致ora-01555错误的场景。"></a>示例演示一个导致ora-01555错误的场景。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 如果用undotest1表空间，使用以下语句删除</span></span>
<span class="line">drop tablespace undotest1 including contents <span class="keyword">and</span> datafiles;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 创建一个新的undo表空间，undo文件为1M，并且不能自动扩展</span></span>
<span class="line">create undo tablespace undotest1 datafile <span class="string">'/u01/app/oracle/oradata/orcl/undotest01.dbf'</span> size <span class="number">1</span><span class="keyword">m</span>;</span>
<span class="line"></span>
<span class="line">alter <span class="keyword">system</span> set undo_tablespace=<span class="string">'undotest1'</span>;</span>
<span class="line">alter <span class="keyword">system</span> set undo_retention=<span class="number">1</span>;</span>
<span class="line"></span>
<span class="line">show parameter undo</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">undo_management                      string      AUTO</span>
<span class="line">undo_retention                       integer     <span class="number">1</span></span>
<span class="line">undo_tablespace                      string      undotest1</span>
<span class="line"></span>
<span class="line"><span class="comment"># 会话1，定义并打开一个游标</span></span>
<span class="line">conn lyj/lyj</span>
<span class="line">var c1 refcursor</span>
<span class="line">begin</span>
<span class="line"><span class="keyword">open</span> :c1 <span class="keyword">for</span> <span class="keyword">select</span> * from t;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line"># 会话2，做一个大量的update操作，将T表中的所有ID字段更新了10万次</span>
<span class="line">conn lyj/lyj</span></span>
<span class="line">begin</span>
<span class="line"><span class="keyword">for</span> i in <span class="number">1</span>..<span class="number">100000</span> loop</span>
<span class="line">update t set id=i;</span>
<span class="line">commit;</span>
<span class="line">end loop;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line"># 会话1，打开刚才定义的游标C1，会得到如下ORA-01555的错误</span>
<span class="line">SQL&gt; print :c1</span>
<span class="line">ERROR:</span>
<span class="line">ORA-01555: snapshot too old: rollback segment number 22 with name</span>
<span class="line">"_SYSSMU22_656159337$" too small</span></span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle职业直通车 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
            <tag> logminer </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle职业直通车-06 Oracle的内存结构与后台进程]]></title>
      <url>/2015/03/30/oracle/Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/06_Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6/</url>
      <content type="html"><![CDATA[<h2 id="Oracle实例"><a href="#Oracle实例" class="headerlink" title="Oracle实例"></a>Oracle实例</h2><h3 id="SGA-System-Global-Area"><a href="#SGA-System-Global-Area" class="headerlink" title="SGA(System Global Area)"></a>SGA(System Global Area)</h3><ul>
<li>SGA区包括Oracle实例需要的一系列内存组件，用于存放共享的数据信息和数据控制信息<ul>
<li>Database Buffer Cache</li>
<li>Redo Log Buffer</li>
<li>Shared Pool  Library Cache、Data dictionary Cache</li>
<li>Large Pool</li>
<li>Streams Pool</li>
<li>Fixed SGA</li>
</ul>
</li>
<li>这些内存信息被所有进程所共享(server process,background process)</li>
</ul>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; show sga</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size- - - <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size- -  <span class="number">838861464</span> bytes    <span class="comment"># shared pool</span></span>
<span class="line">Database Buffers-    <span class="number">3523215360</span> bytes</span>
<span class="line">Redo Buffers- -    <span class="number">11661312</span> bytes</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="Database-Buffer-Cache"><a href="#Database-Buffer-Cache" class="headerlink" title="Database Buffer Cache"></a>Database Buffer Cache</h3><p>Buffer cache里面存放这从磁盘上读到内存中的数据块，这些数据块可以被所有的会话访问，是全局共享的。</p>
<ul>
<li>Default pool 正常情况下，数据块存放的内存区域。</li>
<li>Keep pool 这个区域（池）用于将一些数据始终固定在内存中，Default pool会根据一个过期算法（LRU）将过期的脏数据写到磁盘上。</li>
<li>Recycle pool 存放一些不经常使用的数据块，避免这些数据块在Default pool池中占据空间。</li>
<li>2k，4k，16k 用于存放不是标准大小（8k）表空间的数据块信息<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建一个16k块大小的表空间示例</span></span>
<span class="line">show parameter cache_size</span>
<span class="line"></span>
<span class="line">NAME- - - - -    TYPE-   VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">client_result_cache_size- -  big integer <span class="number">0</span></span>
<span class="line">db_16k_cache_size- - -   big integer <span class="number">0</span></span>
<span class="line">db_2k_cache_size- - -    big integer <span class="number">0</span></span>
<span class="line">db_32k_cache_size- - -   big integer <span class="number">0</span></span>
<span class="line">db_4k_cache_size- - -    big integer <span class="number">0</span></span>
<span class="line">db_8k_cache_size- - -    big integer <span class="number">0</span></span>
<span class="line">db_cache_size- - - - big integer <span class="number">0</span></span>
<span class="line">db_flash_cache_size- - - big integer <span class="number">0</span></span>
<span class="line">db_keep_cache_size- - -  big integer <span class="number">0</span></span>
<span class="line">db_recycle_cache_size- -     big integer <span class="number">0</span></span>
<span class="line"></span>
<span class="line">alter <span class="keyword">system</span> set db_16k_cache_size=<span class="number">10</span>M;</span>
<span class="line">show parameter db_16k_cache_size</span>
<span class="line">NAME- - - - -    TYPE-   VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">db_16k_cache_size- - -   big integer <span class="number">16</span>M</span>
<span class="line"></span>
<span class="line">create tablespace ts_16 datafile <span class="string">'/u01/app/oracle/oradata/orcl/ts16k_01.dbf'</span> size <span class="number">100</span><span class="keyword">m</span> blocksize <span class="number">16</span>k;</span>
</pre></td></tr></table></figure>
</li>
</ul>
<h3 id="buffer的概念"><a href="#buffer的概念" class="headerlink" title="buffer的概念"></a>buffer的概念</h3><p>在database buffer cache当中，一个buffer指的是用来从磁盘中读入的数据块在内存中的存放位置，可以理解为<code>1 buffer=1 block</code>。</p>
<h4 id="buffer（内存数据块）的3种状态"><a href="#buffer（内存数据块）的3种状态" class="headerlink" title="buffer（内存数据块）的3种状态"></a>buffer（内存数据块）的3种状态</h4><ul>
<li>unused</li>
<li>clean</li>
<li>dirty</li>
</ul>
<h4 id="Buffer-的2种模式"><a href="#Buffer-的2种模式" class="headerlink" title="Buffer 的2种模式"></a>Buffer 的2种模式</h4><ul>
<li>Current mode     update/delete/insert</li>
<li>Consistent mode  select</li>
</ul>
<h3 id="Shared-Pool-Server-Result-Cache"><a href="#Shared-Pool-Server-Result-Cache" class="headerlink" title="Shared Pool - Server Result Cache"></a>Shared Pool - Server Result Cache</h3><p>这部分内存中保留了SQL查询的结果集，这样对于后续的相同查询，Oracle无需重新加载数据块进行计算，直接使用现有的数据集。</p>
<ul>
<li>由参数<code>RESULT_CACHE_MODE</code>设定</li>
<li>默认值<code>Manual</code>，需要使用<code>RESULT_CACHE hint</code>来启用。</li>
<li><code>FORCE</code>对所有<code>SELECT</code>操作生效（会消耗更多shared_pool空间）<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; show parameter result_cache_mode</span>
<span class="line"></span>
<span class="line">NAME- - - - -    TYPE-   VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">result_cache_mode- - -   string- MANUAL</span>
</pre></td></tr></table></figure>
</li>
</ul>
<h3 id="PGA-Program-Global-Area"><a href="#PGA-Program-Global-Area" class="headerlink" title="PGA(Program Global Area)"></a>PGA(Program Global Area)</h3><ul>
<li>不同于SGA，PGA属于独占式内存区，它的数据和控制信息为某个会话所独有，当一个会话产生时，Oracle会为这个会话分配一个PGA内存区域。</li>
<li>PGA属于单个的服务端进程或者后台进程，而实例级别说的PGA，通常指的是所有这些会话占用的PGA的总和，也就是由参数pga_aggregate_target设定的值。</li>
</ul>
<h3 id="PGA-amp-UGA"><a href="#PGA-amp-UGA" class="headerlink" title="PGA &amp; UGA"></a>PGA &amp; UGA</h3><ul>
<li>PGA是一个进程占用的内存区域，可以理解为操作系统在一个进程启动时，为它分配的内存空间，是一个操作系统含义上的内存区。</li>
<li>UGA(User global area)是一个会话含义的内存区，它保存着和会话相关的信息，比如会话登录信息，绑定变量的值，Pl/SQL包的参数信息等。</li>
<li>UGA必须保证会话能够访问到UGA当中的数据，因此UGA的位置会随数据库连接方式的不同而不同。<ul>
<li>当连接使用的是专用模式(dedicated)时，因为会话是专有的，所以UGA属于PGA的一部分。</li>
<li>当连接模式为MTS(Shared)时，由于会话可能会使用任意一个共享进程，因此这些进程必须能够同时访问UGA中的数据，此时Oracle会把UGA放在SGA区中（共享内存区域）。</li>
</ul>
</li>
</ul>
<h2 id="Oracle的进程"><a href="#Oracle的进程" class="headerlink" title="Oracle的进程"></a>Oracle的进程</h2><ul>
<li>用户进程 user process</li>
<li>服务器进程 server process</li>
<li>实例后台进程 background process</li>
</ul>
<h3 id="Oracle实例的后台进程–SMON"><a href="#Oracle实例的后台进程–SMON" class="headerlink" title="Oracle实例的后台进程–SMON"></a>Oracle实例的后台进程–SMON</h3><p>SMON 的主要工作：</p>
<ul>
<li>数据库启动时的实例恢复，在RAC环境下，一个节点的SMON可以对另外一个节点做实例恢复</li>
<li>清理和释放临时段上的数据（排序，临时表…)</li>
<li>对于DMT(字典管理表空间）,SMON可以合并连续空闲的extent</li>
<li>维护回滚段的online,offline以及空间的回收</li>
</ul>
<h3 id="Oracle实例的后台进程–PMON"><a href="#Oracle实例的后台进程–PMON" class="headerlink" title="Oracle实例的后台进程–PMON"></a>Oracle实例的后台进程–PMON</h3><h4 id="Pmon后台进程负责的工作"><a href="#Pmon后台进程负责的工作" class="headerlink" title="Pmon后台进程负责的工作"></a>Pmon后台进程负责的工作</h4><ul>
<li>进程异常终止</li>
<li>会话被杀掉</li>
<li>事务超过空闲时间</li>
<li>网络连接超时</li>
<li>将实例信息注册到监听器上<ul>
<li>手工注册 <code>alter system register;</code></li>
</ul>
</li>
</ul>
<h4 id="Pmon进程的清理工作"><a href="#Pmon进程的清理工作" class="headerlink" title="Pmon进程的清理工作"></a>Pmon进程的清理工作</h4><ul>
<li>回滚未提交的事务，释放事务相关的资源<ul>
<li>重置undo数据块上的事务表的状态为inactive。</li>
<li>释放事务产生的锁。</li>
<li>从v$session中清除异常终止的会话ID。</li>
</ul>
</li>
</ul>
<h3 id="Oracle实例的后台进程–DBWn"><a href="#Oracle实例的后台进程–DBWn" class="headerlink" title="Oracle实例的后台进程–DBWn"></a>Oracle实例的后台进程–DBWn</h3><ul>
<li>负责将buffer cache中脏数据（修改过的数据）块写到磁盘上，由于数据块在磁盘上的位置不连续，这个过程会比LGWR比较耗时。</li>
<li>DBWn触发条件<ul>
<li>当server process无法在buffer cache中无法找到可用的buffer时。</li>
<li>DBWn接到checkpoint的指令，将脏数据写到磁盘上。</li>
</ul>
</li>
<li>可以通过设置多个DBWn进程加快脏数据写入磁盘的速度，参数是<code>DB_WRITER_PROCESSES</code></li>
</ul>
<h3 id="Oracle实例的后台进程–CKPT"><a href="#Oracle实例的后台进程–CKPT" class="headerlink" title="Oracle实例的后台进程–CKPT"></a>Oracle实例的后台进程–CKPT</h3><h4 id="checkpoint的目的和作用"><a href="#checkpoint的目的和作用" class="headerlink" title="checkpoint的目的和作用"></a>checkpoint的目的和作用</h4><ul>
<li>减少数据库实例恢复的时间</li>
<li>让内存中的脏数据及时的写到磁盘上，CKPT进程通知DBWn进程开始将内存(buffer cache)中的脏数据写到磁盘的文件上</li>
<li>在安全关闭数据库时，保证所有提交的数据被写到磁盘上 </li>
<li>CKPT负责更新文件头和控制文件的信息</li>
</ul>
<h4 id="checkpoint的触发"><a href="#checkpoint的触发" class="headerlink" title="checkpoint的触发"></a>checkpoint的触发</h4><ul>
<li>database checkpoint<ul>
<li>Consistent database shutdown</li>
<li>ALTER SYSTEM CHECKPOINT statement</li>
<li>Online redo log switch</li>
<li>ALTER DATABASE BEGIN BACKUP statement</li>
</ul>
</li>
<li>Tablespace and data file checkpoints<ul>
<li>tablespace read only</li>
<li>tablespace offline normal</li>
<li>shrinking a data file</li>
<li>alter tablespace begin backup</li>
</ul>
</li>
<li>Incremental checkpoints</li>
</ul>
<h3 id="Oracle实例的后台进程–LGWR"><a href="#Oracle实例的后台进程–LGWR" class="headerlink" title="Oracle实例的后台进程–LGWR"></a>Oracle实例的后台进程–LGWR</h3><p>LGWR负责将log buffer中的数据顺序的写到磁盘上的online redo file,由于是顺序的写入，效率要比DBWn高很多。LGWR触发条件：</p>
<ul>
<li>用户提交事务(commit)</li>
<li>日志切换</li>
<li>最后一次提交经过了3秒。</li>
<li>redo log buffer容量达到1/3或者达到1M的redo数据。</li>
<li>DBWn进程在把脏数据写入磁盘之前，必须保证这些脏数据对应的日志信息已经被写入磁盘，如果发现脏数据的日志信息没有写入磁盘，DBWn通知LGWR进程写日志信息，完成后继续将<br>脏数据写入磁盘。</li>
</ul>
<h3 id="checkpoint和commit"><a href="#checkpoint和commit" class="headerlink" title="checkpoint和commit"></a>checkpoint和commit</h3><p>commit 提交的事务修改的数据产生的日志，必须立即写到磁盘上。</p>
<ul>
<li>刷新到磁盘上的日志中，包含未提交的日志。</li>
</ul>
<p>checkpoint 将脏数据写到磁盘上，加快数据的恢复时间，为data buffer提供空闲空间</p>
<ul>
<li>写到磁盘上的数据，并不一定是提交的。</li>
<li>数据写到磁盘之前，这部分数据对应的日志信息，必须提前写到磁盘上。</li>
<li>如果是alter system checkpoint,将只把commited的数据块写到磁盘。</li>
<li>安全关闭数据库，所有的commited的数据会写到磁盘上。</li>
</ul>
<h3 id="Oracle实例的后台进程–ARCn"><a href="#Oracle实例的后台进程–ARCn" class="headerlink" title="Oracle实例的后台进程–ARCn"></a>Oracle实例的后台进程–ARCn</h3><ul>
<li>归档进程，当数据库处于归档模式时(archive mode)，ARCn负责将online redo file归档到目标存储位置，用于数据库的恢复，当在线日志切换时，会触发ARCn进程将在线日志文件归档。</li>
<li>ARCn进程在data guard下，负责将日志向standby 服务器发送。</li>
</ul>
<h3 id="Oracle实例的后台进程–其它"><a href="#Oracle实例的后台进程–其它" class="headerlink" title="Oracle实例的后台进程–其它"></a>Oracle实例的后台进程–其它</h3><ul>
<li>ASMB–ASM实例的核心后台进程，负责管理ASM的存储。</li>
<li>CJQ0–job任务协调进程，负责数据库中JOB的自动执行。</li>
<li>Jnnn–job具体执行进程，接受CJQ0分发的job任务。</li>
<li>MMAN–内存管理进程，负责内存的动态管理，分配和收回。</li>
<li>Pnnn–并行执行子进程，接受并行协调进程分配的任务并执行。</li>
<li>RBAL–ASM的rebalance进程，负责ASM数据的rebalance操作。</li>
<li>RECO–分布式事务的恢复进程。</li>
<li>Snnn–MTS下共享进程。</li>
</ul>
<h2 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h2><h3 id="用SQL计算某个表空间的大小及所包含对象的大小，给出SQL语句和结果。"><a href="#用SQL计算某个表空间的大小及所包含对象的大小，给出SQL语句和结果。" class="headerlink" title="用SQL计算某个表空间的大小及所包含对象的大小，给出SQL语句和结果。"></a>用SQL计算某个表空间的大小及所包含对象的大小，给出SQL语句和结果。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create tablespace ts_lyj datafile </span>
<span class="line"> <span class="string">'/u01/app/oracle/oradata/orcl/ts_lyj01.dbf'</span> size <span class="number">100</span><span class="keyword">m</span>,</span>
<span class="line"> <span class="string">'/u01/app/oracle/oradata/orcl/ts_lyj02.dbf'</span> size <span class="number">100</span><span class="keyword">m</span>;</span>
<span class="line"></span>
<span class="line">drop user lyj cascade;</span>
<span class="line">create user lyj identified by lyj default tablespace ts_lyj;</span>
<span class="line">grant <span class="keyword">connect</span>,resource to lyj;</span>
<span class="line"></span>
<span class="line">conn lyj/lyj</span>
<span class="line">create table test01 as <span class="keyword">select</span> * from all_objects;</span>
<span class="line">create table test02 as <span class="keyword">select</span> * from all_users;</span>
<span class="line"></span>
<span class="line">conn / as sysdba</span>
<span class="line"><span class="keyword">select</span> TABLESPACE_NAME, sum(bytes)/<span class="number">1024</span>/<span class="number">1024</span> tablespace_size_m from dba_data_files </span>
<span class="line">  where TABLESPACE_NAME=<span class="string">'TS_LYJ'</span> group by tablespace_name;</span>
<span class="line"></span>
<span class="line">TABLESPACE_NAME                TABLESPACE_SIZE_M</span>
<span class="line">------------------------------ -----------------</span>
<span class="line">TS_LYJ                                       <span class="number">200</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">col OWNER <span class="keyword">for</span> a1<span class="number">0</span></span>
<span class="line">col SEGMENT_NAME <span class="keyword">for</span> a1<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> TABLESPACE_NAME,sum(bytes)/<span class="number">1024</span>/<span class="number">1024</span> object_size_m from dba_segments </span>
<span class="line">  where TABLESPACE_NAME=<span class="string">'TS_LYJ'</span> group by TABLESPACE_NAME;</span>
<span class="line"></span>
<span class="line">TABLESPACE_NAME                OBJECT_SIZE_M</span>
<span class="line">------------------------------ -------------</span>
<span class="line">TS_LYJ                                <span class="number">8.0625</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 把以上两条语句拼成一条</span></span>
<span class="line"><span class="keyword">select</span></span>
<span class="line">  t.tablespace_name,</span>
<span class="line">  t.tablespace_size_m,</span>
<span class="line">  o.object_size_m</span>
<span class="line">from (<span class="keyword">select</span> TABLESPACE_NAME,sum(bytes)/<span class="number">1024</span>/<span class="number">1024</span> tablespace_size_m </span>
<span class="line">         from dba_data_files where TABLESPACE_NAME=<span class="string">'TS_LYJ'</span> group by tablespace_name) t,</span>
<span class="line">     (<span class="keyword">select</span> TABLESPACE_NAME,sum(bytes)/<span class="number">1024</span>/<span class="number">1024</span> object_size_m </span>
<span class="line">         from dba_segments where TABLESPACE_NAME=<span class="string">'TS_LYJ'</span> group by tablespace_name) o</span>
<span class="line">where t.tablespace_name=o.tablespace_name;</span>
<span class="line"></span>
<span class="line">TABLESPACE_NAME                TABLESPACE_SIZE_M OBJECT_SIZE_M</span>
<span class="line">------------------------------ ----------------- -------------</span>
<span class="line">TS_LYJ                                       <span class="number">200</span>        <span class="number">8.0625</span></span>
</pre></td></tr></table></figure>
<h3 id="在告警日志中找到一条错误信息，并贴出来（如果没有，自己造出一条错误信息）。"><a href="#在告警日志中找到一条错误信息，并贴出来（如果没有，自己造出一条错误信息）。" class="headerlink" title="在告警日志中找到一条错误信息，并贴出来（如果没有，自己造出一条错误信息）。"></a>在告警日志中找到一条错误信息，并贴出来（如果没有，自己造出一条错误信息）。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; !rm /u01/app/oracle/oradata/orcl/ts_lyj01.dbf</span>
<span class="line"></span>
<span class="line"><span class="comment"># 重启数据库报错</span></span>
<span class="line">SQL&gt; startup force</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size- - - <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size- -  <span class="number">939524760</span> bytes</span>
<span class="line">Database Buffers-    <span class="number">3422552064</span> bytes</span>
<span class="line">Redo Buffers- -    <span class="number">11661312</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">ORA-<span class="number">01157</span>: cannot identify/lock data file <span class="number">13</span> - see DBWR trace file</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">13</span>: <span class="string">'/u01/app/oracle/oradata/orcl/ts_lyj01.dbf'</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 找到alert日志所在目录</span></span>
<span class="line">col VALUE <span class="keyword">for</span> a8<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> value from v$diag_info where NAME=<span class="string">'Default Trace File'</span>;</span>
<span class="line"></span>
<span class="line">VALUE</span>
<span class="line">--------------------------------------------------------------------------------</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/diag</span><span class="regexp">/rdbms/orcl</span><span class="regexp">/orcl/trace</span><span class="regexp">/orcl_ora_25472.trc   # 这个目录的地址就是alert日志所在的目录</span>
<span class="line"></span>
<span class="line"># 查看alert日志</span>
<span class="line">vi /u</span>01/app/oracle/diag/rdbms/orcl/orcl/trace/alert_orcl.log </span>
<span class="line"><span class="comment">#==============================================================================</span></span>
<span class="line">ALTER DATABASE OPEN</span>
<span class="line">Errors in file /u01/app/oracle/diag/rdbms/orcl/orcl/trace/orcl_dbw0_29603.trc:</span>
<span class="line">ORA-<span class="number">01157</span>: cannot identify/lock data file <span class="number">13</span> - see DBWR trace file</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">13</span>: <span class="string">'/u01/app/oracle/oradata/orcl/ts_lyj01.dbf'</span></span>
<span class="line">ORA-<span class="number">27037</span>: unable to obtain file status</span>
<span class="line">Linux-x86_64 Error: <span class="number">2</span>: No such file <span class="keyword">or</span> directory</span>
<span class="line">Additional information: <span class="number">3</span></span>
<span class="line">Errors in file /u01/app/oracle/diag/rdbms/orcl/orcl/trace/orcl_ora_29627.trc:</span>
<span class="line">ORA-<span class="number">01157</span>: cannot identify/lock data file <span class="number">13</span> - see DBWR trace file</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">13</span>: <span class="string">'/u01/app/oracle/oradata/orcl/ts_lyj01.dbf'</span></span>
<span class="line">ORA-<span class="number">1157</span> signalled during: ALTER DATABASE OPEN...</span>
<span class="line"><span class="comment">#==============================================================================</span></span>
</pre></td></tr></table></figure>
<h3 id="学会使用官方文档，在网站https-docs-oracle-com上查找V-session的描述信息，查出dbms-stats包的信息，并截图贴出来。"><a href="#学会使用官方文档，在网站https-docs-oracle-com上查找V-session的描述信息，查出dbms-stats包的信息，并截图贴出来。" class="headerlink" title="学会使用官方文档，在网站https://docs.oracle.com上查找V$session的描述信息，查出dbms_stats包的信息，并截图贴出来。"></a>学会使用官方文档，在网站<code>https://docs.oracle.com</code>上查找V$session的描述信息，查出<code>dbms_stats</code>包的信息，并截图贴出来。</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/1031_oracle_01.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/1031_oracle_02.png" alt=""></p>
<h3 id="画一个Oracle内存结构示意图，并给出文字描述。"><a href="#画一个Oracle内存结构示意图，并给出文字描述。" class="headerlink" title="画一个Oracle内存结构示意图，并给出文字描述。"></a>画一个Oracle内存结构示意图，并给出文字描述。</h3><p><img src="http://oligvdnzp.bkt.clouddn.com/1031_oracle_01.gif" alt=""></p>
<table>
<thead>
<tr>
<th>System Global Area (SGA)</th>
<th>文字描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Shared Pool</td>
<td>-  包括library cache，存储最近使用的SQL和pl/sql语句的信息<br>- 通过“最近最少使用”<code>least recently used(LRU)</code>算法来管理<br>- 还包括data dictionary cache在解析过程中会频繁的访问数据字典<br> - 包括数据库文件、表、索引、列、用户、权限、和其它对象的信息<br> - 在解析阶段，服务器进程寻找数据字典信息来解析对象的名字和访问权限<br>- 把数据字典的信息加载到shared pool里面，来提高查询和DML(Data Manipulation Language)数据操纵语言语句的反应时间<br>- 包括Server Result cache,sql 查询的结果集 </td>
</tr>
<tr>
<td>Database Buffer Cache</td>
<td>- 数据库缓冲区快速缓存<br> - 存储从数据文件提取出来的数据块的一个拷贝<br> - 当提取数据或者修改数据的时候，能很大的提高性能<br> - 通过LRU(Least Recently Used )算法来管理<br> - DB_BLOCK_SIZE决定了主数据块的大小<br> - Redo Log Buffer 重做日志缓冲区<br> - 记录了对数据块的所有改变<br> - 主要的目的是为了恢复数据库</td>
</tr>
<tr>
<td>Java Pool</td>
<td>- Java池<br>- 用于解析java命令<br>- 在安装和使用java的时候需要使用</td>
</tr>
<tr>
<td>Large Pool</td>
<td>- 大池<br>- SGA中可选的一块内存区域<br>- 减少了共享池（Shared Pool）的负担</td>
</tr>
</tbody>
</table>
<p>System Global Area (SGA): 在实例启动的时候分配, 是数据库实例的基本组成部分<br>Program Global Area (PGA): 当服务器进程启动的时候分配</p>
<ul>
<li>每个用户连接到Oracle数据库的内存区域；</li>
<li>当进程建立的时候单独分配；</li>
<li>当进程终止的时候释放；</li>
<li>只能用于一个进程,是私有的，不能够共享</li>
</ul>
<h3 id="画一个CKPT进程工作机制示意图，并给出文字描述。"><a href="#画一个CKPT进程工作机制示意图，并给出文字描述。" class="headerlink" title="画一个CKPT进程工作机制示意图，并给出文字描述。"></a>画一个CKPT进程工作机制示意图，并给出文字描述。</h3><blockquote>
<p>The checkpoint process (CKPT) updates the control file and data file headers with checkpoint information and signals DBWn to write blocks to disk. Checkpoint information includes the checkpoint position, SCN, location in online redo log to begin recovery, and so on. CKPT does not write data blocks to data files or redo blocks to online redo log files.</p>
</blockquote>
<p><img src="http://oligvdnzp.bkt.clouddn.com/1031_oracle_02.gif" alt=""><br>CKPT进程通知DBWn进程开始将内存(buffer cache)中的脏数据写到磁盘的文件上，并负责更新文件头和控制文件的信息。</p>
<h3 id="列出你所用数据库运行的后台进程，并对每个进程做文字描述。"><a href="#列出你所用数据库运行的后台进程，并对每个进程做文字描述。" class="headerlink" title="列出你所用数据库运行的后台进程，并对每个进程做文字描述。"></a>列出你所用数据库运行的后台进程，并对每个进程做文字描述。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">ps -ef | <span class="keyword">grep</span> ora<span class="number">_</span> | <span class="keyword">grep</span> -v <span class="keyword">grep</span></span>
<span class="line"></span>
<span class="line">oracle    <span class="number">7873</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">44</span>:<span class="number">29</span> ora_pmon_bi</span>
<span class="line">oracle    <span class="number">7876</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">33</span>:<span class="number">30</span> ora_psp0_bi</span>
<span class="line">oracle    <span class="number">7878</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">1</span>-<span class="number">02</span>:<span class="number">00</span>:<span class="number">41</span> ora_vktm_bi</span>
<span class="line">oracle    <span class="number">7882</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">06</span>:<span class="number">12</span> ora_gen0_bi</span>
<span class="line">oracle    <span class="number">7884</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:08:<span class="number">46</span> ora_diag_bi</span>
<span class="line">oracle    <span class="number">7886</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:08:<span class="number">20</span> ora_dbrm_bi</span>
<span class="line">oracle    <span class="number">7888</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">02</span>:<span class="number">31</span>:<span class="number">19</span> ora_dia0_bi</span>
<span class="line">oracle    <span class="number">7890</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">07</span>:<span class="number">32</span> ora_mman_bi</span>
<span class="line">oracle    <span class="number">7892</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">01</span>:<span class="number">20</span>:<span class="number">11</span> ora_dbw0_bi</span>
<span class="line">oracle    <span class="number">7894</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">01</span>:<span class="number">18</span>:<span class="number">40</span> ora_dbw1_bi</span>
<span class="line">oracle    <span class="number">7896</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">01</span>:<span class="number">21</span>:<span class="number">50</span> ora_dbw2_bi</span>
<span class="line">oracle    <span class="number">7898</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">02</span>:<span class="number">14</span>:<span class="number">10</span> ora_lgwr_bi</span>
<span class="line">oracle    <span class="number">7900</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">01</span>:<span class="number">05</span>:<span class="number">55</span> ora_ckpt_bi</span>
<span class="line">oracle    <span class="number">7902</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">44</span>:<span class="number">00</span> ora_smon_bi</span>
<span class="line">oracle    <span class="number">7904</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">02</span>:<span class="number">26</span> ora_reco_bi</span>
<span class="line">oracle    <span class="number">7906</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">07</span>:<span class="number">04</span> ora_rbal_bi</span>
<span class="line">oracle    <span class="number">7908</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">05</span>:<span class="number">21</span> ora_asmb_bi</span>
<span class="line">oracle    <span class="number">7910</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">02</span>:<span class="number">00</span>:<span class="number">37</span> ora_mmon_bi</span>
<span class="line">oracle    <span class="number">7914</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">01</span>:<span class="number">57</span>:<span class="number">32</span> ora_mmnl_bi</span>
<span class="line">oracle    <span class="number">7916</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">03</span>:<span class="number">00</span> ora_d000_bi</span>
<span class="line">oracle    <span class="number">7918</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">02</span>:<span class="number">52</span> ora_s000_bi</span>
<span class="line">oracle    <span class="number">7921</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:09:<span class="number">49</span> ora_mark_bi</span>
<span class="line">oracle    <span class="number">8042</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">24</span>:<span class="number">13</span> ora_arc0_bi</span>
<span class="line">oracle    <span class="number">8061</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">06</span>:<span class="number">31</span> ora_arc1_bi</span>
<span class="line">oracle    <span class="number">8064</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">24</span>:<span class="number">10</span> ora_arc2_bi</span>
<span class="line">oracle    <span class="number">8066</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">24</span>:<span class="number">05</span> ora_arc3_bi</span>
<span class="line">oracle    <span class="number">8097</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">03</span>:<span class="number">21</span> ora_qmnc_bi</span>
<span class="line">oracle    <span class="number">8132</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">02</span>:<span class="number">53</span> ora_emnc_bi</span>
<span class="line">oracle    <span class="number">8248</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">02</span>:<span class="number">32</span> ora_q001_bi</span>
<span class="line">oracle    <span class="number">8270</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">03</span>:<span class="number">10</span> ora_e000_bi</span>
<span class="line">oracle    <span class="number">8272</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">03</span>:<span class="number">14</span> ora_e001_bi</span>
<span class="line">oracle    <span class="number">8276</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">03</span>:<span class="number">13</span> ora_e002_bi</span>
<span class="line">oracle    <span class="number">8282</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">03</span>:<span class="number">13</span> ora_e003_bi</span>
<span class="line">oracle    <span class="number">8284</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:<span class="number">31</span>:<span class="number">24</span> ora_e004_bi</span>
<span class="line">oracle    <span class="number">8307</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">02</span>:<span class="number">40</span>:<span class="number">31</span> ora_cjq0_bi</span>
<span class="line">oracle    <span class="number">8789</span>     <span class="number">1</span>  <span class="number">0</span> May27 ?        <span class="number">00</span>:09:<span class="number">11</span> ora_smco_bi</span>
<span class="line">oracle   <span class="number">15439</span>     <span class="number">1</span>  <span class="number">0</span> Oct26 ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">12</span> ora_q002_bi</span>
<span class="line">oracle   <span class="number">16793</span>     <span class="number">1</span>  <span class="number">0</span> <span class="number">04</span>:<span class="number">37</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">43</span> ora_o000_bi</span>
<span class="line">oracle   <span class="number">24737</span>     <span class="number">1</span>  <span class="number">4</span> <span class="number">16</span>:<span class="number">33</span> ?        <span class="number">00</span>:<span class="number">01</span>:<span class="number">46</span> ora_j001_bi</span>
<span class="line">oracle   <span class="number">27582</span>     <span class="number">1</span>  <span class="number">0</span> <span class="number">16</span>:<span class="number">59</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> ora_w000_bi</span>
<span class="line">oracle   <span class="number">28020</span>     <span class="number">1</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">03</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">01</span> ora_j000_bi</span>
<span class="line">oracle   <span class="number">28135</span>     <span class="number">1</span>  <span class="number">0</span> <span class="number">17</span>:<span class="number">05</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> ora_w001_bi</span>
</pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>ARCn</td>
<td>Archiver Process, Copies the redo log files to archival storage when they are full or an online redo log switch occurs</td>
</tr>
<tr>
<td>ASMB</td>
<td>ASM Background Process, Communicates with the ASM instance, managing storage and providing statistics</td>
</tr>
<tr>
<td>CJQ0</td>
<td>Job Queue Coordinator Process, Selects jobs that need to be run from the data dictionary and spawns job queue slave processes (Jnnn) to run the jobs</td>
</tr>
<tr>
<td>CKPT</td>
<td>Checkpoint Process, Signals DBWn at checkpoints and updates all the data files and control files of the database to indicate the most recent checkpoint</td>
</tr>
<tr>
<td>Dnnn</td>
<td>Dispatcher Process, Performs network communication in the shared server architecture</td>
</tr>
<tr>
<td>DBRM</td>
<td>Database Resource Manager Process, Sets resource plans and performs other tasks related to the Database Resource Manager</td>
</tr>
<tr>
<td>DBWn</td>
<td>Database Writer Process, Writes modified blocks from the database buffer cache to the data files</td>
</tr>
<tr>
<td>DIA0</td>
<td>Diagnostic Process, Detects and resolves hangs and deadlocks</td>
</tr>
<tr>
<td>DIAG</td>
<td>Diagnostic Capture Process, Performs diagnostic dumps</td>
</tr>
<tr>
<td>EMNC</td>
<td>EMON Coordinator Process, Coordinates database event management and notifications</td>
</tr>
<tr>
<td>Ennn</td>
<td>EMON Slave Process, Performs database event management and notifications</td>
</tr>
<tr>
<td>GEN0</td>
<td>General Task Execution Process, Performs required tasks including SQL and DML</td>
</tr>
<tr>
<td>Jnnn</td>
<td>Job Queue Slave Process, Executes jobs assigned by the job coordinator</td>
</tr>
<tr>
<td>LGWR</td>
<td>Log Writer Process, Writes redo entries to the online redo log</td>
</tr>
<tr>
<td>MARK</td>
<td>Mark AU for Resynchronization Coordinator Process, Marks ASM allocation units as stale following a missed write to an offline disk</td>
</tr>
<tr>
<td>MMAN</td>
<td>Memory Manager Process, Serves as the instance memory manager</td>
</tr>
<tr>
<td>MMNL</td>
<td>Manageability Monitor Lite Process, Performs tasks relating to manageability, including active session history sampling and metrics computation</td>
</tr>
<tr>
<td>MMON</td>
<td>Manageability Monitor Process, Performs or schedules many manageability tasks</td>
</tr>
<tr>
<td>Onnn</td>
<td>ASM Connection Pool Process, Maintains a connection to the ASM instance for metadata operations</td>
</tr>
<tr>
<td>PMON</td>
<td>Process Monitor, Monitors the other background processes and performs process recovery when a server or dispatcher process terminates abnormally</td>
</tr>
<tr>
<td>PSP0</td>
<td>Process Spawner Process, Spawns Oracle background processes after initial instance startup</td>
</tr>
<tr>
<td>QMNC</td>
<td>AQ Coordinator Process, Monitors AQ</td>
</tr>
<tr>
<td>Qnnn</td>
<td>AQ Server Class Process, Performs various AQ-related background task for QMNC</td>
</tr>
<tr>
<td>RBAL</td>
<td>ASM Rebalance Master Process, Coordinates rebalance activity</td>
</tr>
<tr>
<td>RECO</td>
<td>Recoverer Process, Resolves distributed transactions that are pending because of a network or system failure in a distributed database</td>
</tr>
<tr>
<td>SMCO</td>
<td>Space Management Coordinator Process, Coordinates the execution of various space management tasks</td>
</tr>
<tr>
<td>SMON</td>
<td>System Monitor Process, Performs critical tasks such as instance recovery and dead transaction recovery, and maintenance tasks such as temporary space reclamation, data dictionary cleanup, and undo tablespace management</td>
</tr>
<tr>
<td>Snnn</td>
<td>Shared Server Process, Handles client requests in the shared server architecture</td>
</tr>
<tr>
<td>VKTM</td>
<td>Virtual Keeper of Time Process, Provides a wall clock time and reference time for time interval measurements</td>
</tr>
<tr>
<td>Wnnn</td>
<td>Space Management Slave Process, Performs various background space management tasks, including proactive space allocation and space reclamation</td>
</tr>
</tbody>
</table>
<p>官方文档中全部的<a href="https://docs.oracle.com/cd/E11882_01/server.112/e40402/bgprocesses.htm#REFRN104" target="_blank" rel="external">Background Processes</a>说明</p>
<h3 id="演示Oracle实例自动注册到监听器的例子，贴出输出或截图。"><a href="#演示Oracle实例自动注册到监听器的例子，贴出输出或截图。" class="headerlink" title="演示Oracle实例自动注册到监听器的例子，贴出输出或截图。"></a>演示Oracle实例自动注册到监听器的例子，贴出输出或截图。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">[grid@bi ~]$ lsnrctl status</span>
<span class="line"></span>
<span class="line">LSNRCTL <span class="keyword">for</span> Linux: Version <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">3.0</span> - Production on <span class="number">31</span>-OCT-<span class="number">2017</span> <span class="number">18</span>:<span class="number">05</span>:<span class="number">11</span></span>
<span class="line"></span>
<span class="line">Copyright (c) <span class="number">1991</span>, <span class="number">2011</span>, Oracle.  All rights reserved.</span>
<span class="line"></span>
<span class="line">Connecting to (DESCRIPTION=(ADDRESS=(PROTOCOL=IPC)(KEY=EXTPROC1521)))</span>
<span class="line">STATUS of the LISTENER</span>
<span class="line">------------------------</span>
<span class="line">Alias                     LISTENER</span>
<span class="line">Version                   TNSLSNR <span class="keyword">for</span> Linux: Version <span class="number">11.2</span>.<span class="number">0</span>.<span class="number">3.0</span> - Production</span>
<span class="line">Start Date                <span class="number">23</span>-OCT-<span class="number">2015</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">47</span></span>
<span class="line">Uptime                    <span class="number">242</span> days <span class="number">4</span> hr. <span class="number">41</span> min. <span class="number">31</span> sec</span>
<span class="line">Trace Level               off</span>
<span class="line">Security                  ON: Local OS Authentication</span>
<span class="line">SNMP                      OFF</span>
<span class="line">Listener Parameter File   /u01/app/<span class="number">11.2</span>.<span class="number">0</span>/grid/network/admin/listener.ora</span>
<span class="line">Listener Log File         /u01/app/grid/diag/tnslsnr/bi/listener/alert/log.xml</span>
<span class="line">Listening Endpoints Summary...</span>
<span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=ipc)(KEY=EXTPROC1521)))</span>
<span class="line">  (DESCRIPTION=(ADDRESS=(PROTOCOL=tcp)(HOST=bi.localdomain)(PORT=<span class="number">1521</span>)))</span>
<span class="line">Services Summary...</span>
<span class="line">Service <span class="string">"+ASM"</span> has <span class="number">1</span> instance(<span class="keyword">s</span>).</span>
<span class="line">  Instance <span class="string">"+ASM"</span>, status READY, has <span class="number">1</span> handler(<span class="keyword">s</span>) <span class="keyword">for</span> this service...</span>
<span class="line">Service <span class="string">"bi"</span> has <span class="number">1</span> instance(<span class="keyword">s</span>).</span>
<span class="line">  Instance <span class="string">"bi"</span>, status READY, has <span class="number">1</span> handler(<span class="keyword">s</span>) <span class="keyword">for</span> this service...</span>
<span class="line">Service <span class="string">"biXDB"</span> has <span class="number">1</span> instance(<span class="keyword">s</span>).</span>
<span class="line">  Instance <span class="string">"bi"</span>, status READY, has <span class="number">1</span> handler(<span class="keyword">s</span>) <span class="keyword">for</span> this service...</span>
<span class="line">The command completed successfully</span>
<span class="line">[grid@bi ~]$ vi /u01/app/<span class="number">11.2</span>.<span class="number">0</span>/grid/network/admin/listener.ora</span>
<span class="line"><span class="comment"># listener.ora Network Configuration File: /u01/app/11.2.0/grid/network/admin/listener.ora</span></span>
<span class="line"><span class="comment"># Generated by Oracle configuration tools.</span></span>
<span class="line"></span>
<span class="line">LISTENER =</span>
<span class="line">  (DESCRIPTION_LIST =</span>
<span class="line">    (DESCRIPTION =</span>
<span class="line">      (ADDRESS = (PROTOCOL = IPC)(KEY = EXTPROC1521))</span>
<span class="line">      (ADDRESS = (PROTOCOL = TCP)(HOST = bi.localdomain)(PORT = <span class="number">1521</span>))</span>
<span class="line">    )</span>
<span class="line">  )</span>
<span class="line"></span>
<span class="line">ADR_BASE_LISTENER = <span class="regexp">/u01/app</span><span class="regexp">/grid</span>
<span class="line"></span>
<span class="line">ENABLE_GLOBAL_DYNAMIC_ENDPOINT_LISTENER=ON              # line added by Agent</span>
<span class="line"></span>
<span class="line">#----ADDED BY TNSLSNR 23-OCT-2015 10:29:01---</span>
<span class="line">SAVE_CONFIG_ON_STOP_LISTENER = ON</span>
<span class="line">INBOUND_CONNECT_TIMEOUT_LISTENER = 0</span>
<span class="line">#--------------------------------------------</span></span>
</pre></td></tr></table></figure>
<h3 id="将数据库设置为归档模式，手工产生一个归档日志，观察归档日志的产生，以及alert-xxx-ora日志中的信息，贴出演示过程和结果。"><a href="#将数据库设置为归档模式，手工产生一个归档日志，观察归档日志的产生，以及alert-xxx-ora日志中的信息，贴出演示过程和结果。" class="headerlink" title="将数据库设置为归档模式，手工产生一个归档日志，观察归档日志的产生，以及alert_xxx.ora日志中的信息，贴出演示过程和结果。"></a>将数据库设置为归档模式，手工产生一个归档日志，观察归档日志的产生，以及alert_xxx.ora日志中的信息，贴出演示过程和结果。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; archive <span class="keyword">log</span> list;</span>
<span class="line">Database <span class="keyword">log</span> mode              No Archive Mode</span>
<span class="line">Automatic archival             Disabled</span>
<span class="line">Archive destination            USE_DB_RECOVERY_FILE_DEST</span>
<span class="line">Oldest online <span class="keyword">log</span> sequence     <span class="number">40</span></span>
<span class="line">Current <span class="keyword">log</span> sequence           <span class="number">43</span></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">Database closed.</span>
<span class="line">Database dismounted.</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line">SQL&gt; startup mount</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">939524760</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3422552064</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">SQL&gt; alter database archivelog;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> archive <span class="keyword">log</span> current; </span>
<span class="line"></span>
<span class="line">System altered.</span>
<span class="line"></span>
<span class="line"><span class="comment"># alter日志中信息</span></span>
<span class="line"><span class="comment">#==============================================================================</span></span>
<span class="line">Thread <span class="number">1</span> advanced to <span class="keyword">log</span> sequence <span class="number">45</span> (LGWR switch)</span>
<span class="line">  Current <span class="keyword">log</span><span class="comment"># 1 seq# 45 mem# 0: /u01/app/oracle/oradata/orcl/redo01.log</span></span>
<span class="line">Archived Log entry <span class="number">297</span> added <span class="keyword">for</span> thread <span class="number">1</span> sequence <span class="number">44</span> ID <span class="number">0x588d1e5b</span> dest <span class="number">1</span>:</span>
<span class="line"><span class="comment">#==============================================================================</span></span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle职业直通车 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle职业直通车-05 数据字典&数据库的备份和恢复]]></title>
      <url>/2015/03/23/oracle/Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/05_Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6/</url>
      <content type="html"><![CDATA[<h3 id="创建一张表，在表上创建一个索引，查询表，索引各自分配了多少个extents-多少个数据块以及共占空间大小-bytes"><a href="#创建一张表，在表上创建一个索引，查询表，索引各自分配了多少个extents-多少个数据块以及共占空间大小-bytes" class="headerlink" title="创建一张表，在表上创建一个索引，查询表，索引各自分配了多少个extents,多少个数据块以及共占空间大小(bytes)"></a>创建一张表，在表上创建一个索引，查询表，索引各自分配了多少个extents,多少个数据块以及共占空间大小(bytes)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn lyj/lyj</span>
<span class="line">drop table t purge;</span>
<span class="line">create table t as <span class="keyword">select</span> * from all_objects;</span>
<span class="line">create <span class="keyword">index</span> ind_t_oid on t(object_id);</span>
<span class="line"></span>
<span class="line">col segment_name <span class="keyword">for</span> a2<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> segment_name,extents,blocks,bytes/<span class="number">1024</span>/<span class="number">1024</span> size_m</span>
<span class="line">  from user_segments</span>
<span class="line">  where segment_name=<span class="string">'T'</span>;</span>
<span class="line"></span>
<span class="line">SEGMENT_NAME            EXTENTS     BLOCKS     SIZE_M</span>
<span class="line">-------------------- ---------- ---------- ----------</span>
<span class="line">T                            <span class="number">23</span>       <span class="number">1024</span>          <span class="number">8</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> segment_name,extents,blocks,bytes/<span class="number">1024</span>/<span class="number">1024</span> size_m</span>
<span class="line">  from user_segments</span>
<span class="line">  where segment_name=<span class="string">'IND_T_OID'</span>;</span>
<span class="line"></span>
<span class="line">SEGMENT_NAME            EXTENTS     BLOCKS     SIZE_M</span>
<span class="line">-------------------- ---------- ---------- ----------</span>
<span class="line">IND_T_OID                    <span class="number">17</span>        <span class="number">256</span>          <span class="number">2</span></span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="创建一个分区表T，创建2个分区P1-P2，并且把每个分区放在不同的表空间上，从视图中查到表和分区的信息，以及每个分区所在表空间的信息。注意观察当前表T所在的表空间是什么？给出原因。"><a href="#创建一个分区表T，创建2个分区P1-P2，并且把每个分区放在不同的表空间上，从视图中查到表和分区的信息，以及每个分区所在表空间的信息。注意观察当前表T所在的表空间是什么？给出原因。" class="headerlink" title="创建一个分区表T，创建2个分区P1,P2，并且把每个分区放在不同的表空间上，从视图中查到表和分区的信息，以及每个分区所在表空间的信息。注意观察当前表T所在的表空间是什么？给出原因。"></a>创建一个分区表T，创建2个分区P1,P2，并且把每个分区放在不同的表空间上，从视图中查到表和分区的信息，以及每个分区所在表空间的信息。注意观察当前表T所在的表空间是什么？给出原因。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line">create tablespace test1 datafile <span class="string">'/u01/app/oracle/oradata/orcl/test01.dbf'</span> size <span class="number">100</span><span class="keyword">m</span>;</span>
<span class="line">create tablespace test2 datafile <span class="string">'/u01/app/oracle/oradata/orcl/test02.dbf'</span> size <span class="number">100</span><span class="keyword">m</span>;</span>
<span class="line"></span>
<span class="line">conn lyj/lyj</span>
<span class="line">drop table t purge;</span>
<span class="line">create table t (object_id number,object_name varchar2(<span class="number">30</span>))</span>
<span class="line">partition by range(object_id)</span>
<span class="line">(</span>
<span class="line">  partition p1 <span class="keyword">values</span> less than(<span class="number">50000</span>) tablespace test1,</span>
<span class="line">  partition p2 <span class="keyword">values</span> less than(maxvalue) tablespace test2</span>
<span class="line">);</span>
<span class="line"></span>
<span class="line">insert into t <span class="keyword">select</span> object_id,object_name from all_objects;</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">create <span class="keyword">index</span> ind_t_id on t(object_id) <span class="keyword">local</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> TABLE_NAME,TABLESPACE_NAME,PARTITIONED from user_tables where TABLE_NAME=<span class="string">'T'</span>;</span>
<span class="line"></span>
<span class="line">TABLE_NAME                     TABLESPACE_NAME                PAR</span>
<span class="line">------------------------------ ------------------------------ ---</span>
<span class="line">T                                                             YES</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> table_name,partition_name,tablespace_name</span>
<span class="line">from user_tab_partitions</span>
<span class="line">where table_name=<span class="string">'T'</span>;</span>
<span class="line"></span>
<span class="line">TABLE_NAME                     PARTITION_NAME                 TABLESPACE_NAME</span>
<span class="line">------------------------------ ------------------------------ ------------------------------</span>
<span class="line">T                              P1                             TEST1</span>
<span class="line">T                              P2                             TEST2</span>
</pre></td></tr></table></figure>
<h3 id="查看当前用户下有哪些对象？有哪些表？有哪些索引？"><a href="#查看当前用户下有哪些对象？有哪些表？有哪些索引？" class="headerlink" title="查看当前用户下有哪些对象？有哪些表？有哪些索引？"></a>查看当前用户下有哪些对象？有哪些表？有哪些索引？</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> object_name from user_objects;</span>
<span class="line"><span class="keyword">select</span> table_name from user_tables;</span>
<span class="line"><span class="keyword">select</span> index_name from user_indexes;</span>
</pre></td></tr></table></figure>
<h3 id="分别演示数据库打开的三个阶段-nomount-mount-open-，并分别从视图中查到它的状态。"><a href="#分别演示数据库打开的三个阶段-nomount-mount-open-，并分别从视图中查到它的状态。" class="headerlink" title="分别演示数据库打开的三个阶段(nomount,mount,open)，并分别从视图中查到它的状态。"></a>分别演示数据库打开的三个阶段(nomount,mount,open)，并分别从视图中查到它的状态。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; conn / as sysdba</span>
<span class="line">Connected.</span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">Database closed.</span>
<span class="line">Database dismounted.</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line">SQL&gt; startup nomount</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">956301976</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3405774848</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">SQL&gt; <span class="keyword">select</span> status from v$instance;</span>
<span class="line"></span>
<span class="line">STATUS</span>
<span class="line">------------------------</span>
<span class="line">STARTED</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database mount;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> status from v$instance;</span>
<span class="line"></span>
<span class="line">STATUS</span>
<span class="line">------------</span>
<span class="line">MOUNTED</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> status from v$instance;</span>
<span class="line"></span>
<span class="line">STATUS</span>
<span class="line">------------</span>
<span class="line">OPEN</span>
</pre></td></tr></table></figure>
<h3 id="发出一条sql语句，从视图中找到这条sql，同时找到这条SQL的执行时间。"><a href="#发出一条sql语句，从视图中找到这条sql，同时找到这条SQL的执行时间。" class="headerlink" title="发出一条sql语句，从视图中找到这条sql，同时找到这条SQL的执行时间。"></a>发出一条sql语句，从视图中找到这条sql，同时找到这条SQL的执行时间。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn lyj/lyj</span>
<span class="line"><span class="keyword">select</span> count(*) from t;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 新打开一个会话</span></span>
<span class="line">conn / as sysdba</span>
<span class="line">col sql_text <span class="keyword">for</span> a4<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> sql_text,</span>
<span class="line">       to_char(cpu_time/<span class="number">1000000</span>,<span class="string">'999,990.999999'</span>)  <span class="string">"CPU_TIME(S)"</span>,</span>
<span class="line">       to_char(elapsed_time/<span class="number">1000000</span>,<span class="string">'999,990.999999'</span>) <span class="string">"ELAPSED_TIME(S)"</span></span>
<span class="line">from v$session n,v$sql l</span>
<span class="line">where n.sql_id=l.sql_id <span class="keyword">and</span> n.username=<span class="string">'LYJ'</span>;</span>
<span class="line"></span>
<span class="line">SQL_TEXT                                 CPU_TIME(S)     ELAPSED_TIME(S)</span>
<span class="line">---------------------------------------- --------------- ---------------</span>
<span class="line"><span class="keyword">select</span> count(*) from t                          <span class="number">0</span>.<span class="number">150000</span>        <span class="number">0</span>.<span class="number">152085</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># CPU Time 指的是CPU在忙于执行当前任务的时间，并没有考虑等待时间，如IO等待，网络等待等，而Elapsed Time则是执行当前任务所花费的总时间，单位是微妙</span></span>
</pre></td></tr></table></figure>
<h3 id="演示用Rman对数据库做全备份和全库恢复的示例"><a href="#演示用Rman对数据库做全备份和全库恢复的示例" class="headerlink" title="演示用Rman对数据库做全备份和全库恢复的示例"></a>演示用Rman对数据库做全备份和全库恢复的示例</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">$ rman target / </span>
<span class="line"></span>
<span class="line"><span class="comment"># 备份整个数据库</span></span>
<span class="line">RMAN&gt; backup database <span class="keyword">format</span> <span class="string">'/oradata/rmanbackup/dbbak_%d_%T_%s_%U'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看备份集</span></span>
<span class="line">RMAN&gt; list backup;</span>
<span class="line">RMAN&gt; list backupset;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 恢复前可以在数据库中做一下DML操作，并摸拟数据文件损坏</span></span>
<span class="line">conn lyj/lyj</span>
<span class="line">create table test1 (id <span class="keyword">int</span>);</span>
<span class="line">insert into test1 <span class="keyword">select</span> object_id from all_objects where rownum&lt;<span class="number">10</span>;</span>
<span class="line">commit;</span>
<span class="line">! rm -rf /u01/app/oracle/oradata/orcl/users01.dbf</span>
<span class="line"></span>
<span class="line"><span class="comment"># 出现故障</span></span>
<span class="line">conn / as sysdba</span>
<span class="line">alter <span class="keyword">system</span> checkpoint;</span>
<span class="line">alter <span class="keyword">system</span> checkpoint</span>
<span class="line">*</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">03113</span>: end-of-file on communication channel</span>
<span class="line">Process ID: <span class="number">1600</span></span>
<span class="line">Session ID: <span class="number">355</span> Serial number: <span class="number">11</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 在RMAN中恢复数据库</span></span>
<span class="line">RMAN&gt; startup mount</span>
<span class="line">RMAN&gt; restore database;</span>
<span class="line">RMAN&gt; recover database;</span>
<span class="line">RMAN&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">database opened</span>
</pre></td></tr></table></figure>
<h3 id="演示将某个表的数据闪回到历史某个时间点的示例，贴出整个操作过程（查询闪回）"><a href="#演示将某个表的数据闪回到历史某个时间点的示例，贴出整个操作过程（查询闪回）" class="headerlink" title="演示将某个表的数据闪回到历史某个时间点的示例，贴出整个操作过程（查询闪回）"></a>演示将某个表的数据闪回到历史某个时间点的示例，贴出整个操作过程（查询闪回）</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn lyj/lyj</span>
<span class="line">SQL&gt; <span class="keyword">select</span> sysdate,timestamp_to_scn(sysdate) scn from dual;</span>
<span class="line"></span>
<span class="line">SYSDATE                    SCN</span>
<span class="line">------------------- ----------</span>
<span class="line"><span class="number">2016</span>-<span class="number">10</span>-<span class="number">20</span> <span class="number">11</span>:<span class="number">06</span>:<span class="number">32</span>    <span class="number">5305382</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from flashback_test;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68323</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">delete</span> from flashback_test where OBJECT_ID&lt;<span class="number">300</span>;</span>
<span class="line"></span>
<span class="line"><span class="number">4</span> rows deleted.</span>
<span class="line"></span>
<span class="line">SQL&gt; commit;</span>
<span class="line"></span>
<span class="line">Commit complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from flashback_test;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68319</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 开启允许行迁移</span></span>
<span class="line">SQL&gt; alter table flashback_test enable row movement;</span>
<span class="line"></span>
<span class="line">Table altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; flashback table flashback_test to scn <span class="number">5305382</span>;</span>
<span class="line"></span>
<span class="line">Flashback complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from flashback_test;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68323</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from flashback_test as of scn <span class="number">5305382</span>;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68323</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 查询闪回</span></span>
<span class="line">SQL&gt; <span class="keyword">delete</span> flashback_test where object_id&lt;<span class="number">1000</span>;</span>
<span class="line"></span>
<span class="line"><span class="number">10</span> rows deleted.</span>
<span class="line"></span>
<span class="line">SQL&gt; commit;</span>
<span class="line"></span>
<span class="line">Commit complete.</span>
<span class="line"></span>
<span class="line"><span class="comment"># 当前</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from flashback_test;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68313</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 基于时间的闪回查询（5分钟前）</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from flashback_test as of timestamp sysdate-<span class="number">5</span>/<span class="number">1440</span>;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68323</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 基于SCN号的闪回查询</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from flashback_test as of scn <span class="number">5305382</span>;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68323</span></span>
</pre></td></tr></table></figure>
<h3 id="写出10条你认为DBA应该会使用的SQL语句"><a href="#写出10条你认为DBA应该会使用的SQL语句" class="headerlink" title="写出10条你认为DBA应该会使用的SQL语句"></a>写出10条你认为DBA应该会使用的SQL语句</h3><h4 id="查看隐藏参数"><a href="#查看隐藏参数" class="headerlink" title="查看隐藏参数"></a>查看隐藏参数</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">set pagesize <span class="number">9999</span></span>
<span class="line">set line <span class="number">180</span></span>
<span class="line">col name <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">col value <span class="keyword">for</span> a1<span class="number">0</span></span>
<span class="line">col description <span class="keyword">for</span> a7<span class="number">0</span></span>
<span class="line"><span class="keyword">select</span> a.ksppinm name, b.ksppstvl value, a.ksppdesc description</span>
<span class="line">  from <span class="keyword">x</span>$ksppi a, <span class="keyword">x</span>$ksppcv b</span>
<span class="line">  where a.indx = b.indx <span class="keyword">and</span> a.ksppinm like <span class="string">'_%&amp;parameter%'</span>;</span>
</pre></td></tr></table></figure>
<h4 id="查看表空间使用情况"><a href="#查看表空间使用情况" class="headerlink" title="查看表空间使用情况"></a>查看表空间使用情况</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span>
<span class="line">  total.tablespace_name,</span>
<span class="line">  to_char(total.MB,<span class="string">'9,999,990.99'</span>) as Total_MB,</span>
<span class="line">  to_char(total.MB-free.MB, <span class="string">'9,999,990.99'</span>) as Used_MB,</span>
<span class="line">  to_char((<span class="number">1</span>-free.MB/total.MB)*<span class="number">100</span>, <span class="string">'990.00'</span>) ||<span class="string">'%'</span> as <span class="string">"% Used"</span></span>
<span class="line">from (<span class="keyword">select</span> tablespace_name, sum(bytes)/<span class="number">1024</span>/<span class="number">1024</span> as MB from dba_free_space group by tablespace_name) free,</span>
<span class="line">     (<span class="keyword">select</span> tablespace_name, sum(bytes)/<span class="number">1024</span>/<span class="number">1024</span> as MB from dba_data_files group by tablespace_name) total</span>
<span class="line">where free.tablespace_name=total.tablespace_name</span>
<span class="line">union all</span>
<span class="line"><span class="keyword">select</span> tablespace_name,</span>
<span class="line">  to_char(TABLESPACE_SIZE/<span class="number">1024</span>/<span class="number">1024</span>, <span class="string">'999,990.99'</span>) as Total_MB,</span>
<span class="line">  to_char((TABLESPACE_SIZE-FREE_SPACE)/<span class="number">1024</span>/<span class="number">1024</span>, <span class="string">'999,990.99'</span>) as Used_MB,</span>
<span class="line">  to_char(((TABLESPACE_SIZE-FREE_SPACE)/TABLESPACE_SIZE)*<span class="number">100</span>,<span class="string">'990.00'</span>) ||<span class="string">'%'</span> as <span class="string">"% Used"</span></span>
<span class="line">from dba_temp_free_space order by <span class="number">1</span>;</span>
</pre></td></tr></table></figure>
<h4 id="查看ASM使用情况"><a href="#查看ASM使用情况" class="headerlink" title="查看ASM使用情况"></a>查看ASM使用情况</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span></span>
<span class="line">  NAME,</span>
<span class="line">  to_char(TOTAL_MB/<span class="number">1024</span>,<span class="string">'999,990.99'</span>) TOTAL_GB,</span>
<span class="line">  to_char((TOTAL_MB-USABLE_FILE_MB)/<span class="number">1024</span>,<span class="string">'999,990.99'</span>) USED_GB,</span>
<span class="line">  to_char(USABLE_FILE_MB/<span class="number">1024</span>,<span class="string">'999,990.00'</span>) FREE_GB,</span>
<span class="line">  to_char((TOTAL_MB-USABLE_FILE_MB)/TOTAL_MB*<span class="number">100</span>,<span class="string">'990.00'</span>)||<span class="string">'%'</span> <span class="string">"% USED"</span></span>
<span class="line">from v$asm_diskgroup;</span>
</pre></td></tr></table></figure>
<h4 id="查看数据库中的锁"><a href="#查看数据库中的锁" class="headerlink" title="查看数据库中的锁"></a>查看数据库中的锁</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SELECT l.session_id sid,e.serial<span class="comment">#,</span></span>
<span class="line">       l.locked_mode,</span>
<span class="line">       l.oracle_username,</span>
<span class="line">       e.user<span class="comment">#,</span></span>
<span class="line">       l.os_user_name,</span>
<span class="line">       e.machine,</span>
<span class="line">       e.terminal,</span>
<span class="line">       a.sql_text,</span>
<span class="line">       a.action</span>
<span class="line">  FROM v$sqlarea a, v$session e, v$locked_object l</span>
<span class="line">WHERE l.session_id = e.sid</span>
<span class="line">   AND e.prev_sql_addr = a.address</span>
<span class="line">ORDER BY sid, e.serial<span class="comment">#;</span></span>
</pre></td></tr></table></figure>
<h4 id="查询正在进行表扫表的会话及执行的sql语句"><a href="#查询正在进行表扫表的会话及执行的sql语句" class="headerlink" title="查询正在进行表扫表的会话及执行的sql语句"></a>查询正在进行表扫表的会话及执行的sql语句</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> vsl.sid,</span>
<span class="line">       vsn.serial<span class="comment">#,</span></span>
<span class="line">       vsn.status,</span>
<span class="line">       vsl.opname,</span>
<span class="line">       vsl.target,</span>
<span class="line">       ds.bytes/<span class="number">1024</span>/<span class="number">1024</span> as <span class="string">"SEGMENT(MB)"</span>,</span>
<span class="line">       dt.last_analyzed,</span>
<span class="line">       vs.hash_value,</span>
<span class="line">       vs.sql_text</span>
<span class="line">from v$session_longops vsl, </span>
<span class="line">     v$session vsn, </span>
<span class="line">     dba_segments ds, </span>
<span class="line">     dba_tables dt,</span>
<span class="line">     v$sql vs</span>
<span class="line">where vsl.opname=<span class="string">'Table Scan'</span></span>
<span class="line"><span class="keyword">and</span> vsl.sid=vsn.sid</span>
<span class="line"><span class="keyword">and</span> vsn.status=<span class="string">'ACTIVE'</span></span>
<span class="line"><span class="keyword">and</span> vsl.target=ds.owner || <span class="string">'.'</span> || ds.segment_name</span>
<span class="line"><span class="keyword">and</span> vsl.target=dt.owner || <span class="string">'.'</span> || dt.table_name</span>
<span class="line"><span class="keyword">and</span> vsn.sql_hash_value=vs.hash_value</span>
<span class="line">order by vsn.sid, vsn.serial<span class="comment">#, vsl.target, vsn.status;</span></span>
</pre></td></tr></table></figure>
<h4 id="查询系统内大于500M的表和索引的比例"><a href="#查询系统内大于500M的表和索引的比例" class="headerlink" title="查询系统内大于500M的表和索引的比例"></a>查询系统内大于500M的表和索引的比例</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> dtb.owner,</span>
<span class="line">       count(dtb.table_name) as tbs,</span>
<span class="line">       count(didx.index_name) as idxs</span>
<span class="line">from dba_tables dtb, </span>
<span class="line">     dba_indexes didx,</span>
<span class="line">     dba_segments ds</span>
<span class="line">where dtb.owner=didx.table_owner(+)</span>
<span class="line"><span class="keyword">and</span> dtb.table_name=didx.table_name(+)</span>
<span class="line"><span class="keyword">and</span> dtb.table_name=ds.segment_name</span>
<span class="line"><span class="keyword">and</span> ds.bytes/<span class="number">1024</span>/<span class="number">1024</span>&gt;<span class="number">500</span></span>
<span class="line">group by dtb.owner</span>
<span class="line">order by tbs desc, idxs desc;</span>
</pre></td></tr></table></figure>
<h4 id="查询系统内大于200M且没有索引的表"><a href="#查询系统内大于200M且没有索引的表" class="headerlink" title="查询系统内大于200M且没有索引的表"></a>查询系统内大于200M且没有索引的表</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ds.owner,</span>
<span class="line">       ds.segment_name,</span>
<span class="line">       ds.bytes/<span class="number">1024</span>/<span class="number">1024</span> as <span class="string">"SEGMENT(MB)"</span>,</span>
<span class="line">       ds.segment_type</span>
<span class="line">from  dba_segments ds</span>
<span class="line">where ds.owner <span class="keyword">not</span> in (<span class="string">'MDSYS'</span>,<span class="string">'SYS'</span>,<span class="string">'SYSTEM'</span>,<span class="string">'OUTLN'</span>,<span class="string">'WMSYS'</span>,<span class="string">'XDB'</span>,<span class="string">'SYSMAN'</span>,<span class="string">'DBSNMP'</span>,<span class="string">'EXFSYS'</span>)</span>
<span class="line"><span class="keyword">and</span> ds.segment_name <span class="keyword">not</span> in (<span class="keyword">select</span> didx.table_name from dba_indexes didx)</span>
<span class="line"><span class="keyword">and</span> ds.segment_type in (<span class="string">'TABLE'</span>,<span class="string">'TABLE PARTITION'</span>)</span>
<span class="line"><span class="keyword">and</span> ds.bytes/<span class="number">1024</span>/<span class="number">1024</span>&gt;<span class="number">200</span></span>
<span class="line">order by ds.owner,ds.segment_name;</span>
</pre></td></tr></table></figure>
<h4 id="查询系统非空闲等待事件"><a href="#查询系统非空闲等待事件" class="headerlink" title="查询系统非空闲等待事件"></a>查询系统非空闲等待事件</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> vsn.sid,</span>
<span class="line">       vsn.serial<span class="comment">#,</span></span>
<span class="line">       vsw.event,</span>
<span class="line">       vsw.wait_time</span>
<span class="line">from v$session_wait vsw,</span>
<span class="line">     v$session vsn</span>
<span class="line">where vsw.sid=vsn.sid</span>
<span class="line"><span class="keyword">and</span> vsw.event <span class="keyword">not</span> like <span class="string">'SQL%'</span></span>
<span class="line"><span class="keyword">and</span> vsw.event <span class="keyword">not</span> like <span class="string">'rdbms%'</span></span>
<span class="line"><span class="keyword">and</span> vsw.event <span class="keyword">not</span> like <span class="string">'%timer'</span>;</span>
</pre></td></tr></table></figure>
<h4 id="定位系统内IO消耗最高的SQL语句"><a href="#定位系统内IO消耗最高的SQL语句" class="headerlink" title="定位系统内IO消耗最高的SQL语句"></a>定位系统内IO消耗最高的SQL语句</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> vs.hash_value,</span>
<span class="line">       vs.sql_text,</span>
<span class="line">       sum(vs.disk_reads) as R,</span>
<span class="line">       sum(vs.direct_writes) AS W     </span>
<span class="line">from v$sql vs</span>
<span class="line">group by vs.hash_value, vs.sql_text</span>
<span class="line">order by R desc,W desc</span>
</pre></td></tr></table></figure>
<h4 id="定位系统内CPU消耗最高的SQL语句"><a href="#定位系统内CPU消耗最高的SQL语句" class="headerlink" title="定位系统内CPU消耗最高的SQL语句"></a>定位系统内CPU消耗最高的SQL语句</h4><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> vs.hash_value,</span>
<span class="line">       vs.sql_text,</span>
<span class="line">       sum(vs.cpu_time) as cpu</span>
<span class="line">from v$sql vs</span>
<span class="line">group by vs.hash_value, vs.sql_text</span>
<span class="line">order by cpu desc</span>
</pre></td></tr></table></figure>
<h4 id="查询硬解析"><a href="#查询硬解析" class="headerlink" title="查询硬解析"></a>查询硬解析</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select d.plan_hash_value plan_hash_value ,</span>
<span class="line">       d.execnt  execnt ,</span>
<span class="line">       a.hash_value hash_value ,</span>
<span class="line">       a.sql_text  sql_text</span>
<span class="line">from v$sqltext a,</span>
<span class="line">    (select plan_hash_value,</span>
<span class="line">            hash_value,</span>
<span class="line">            execnt </span>
<span class="line">     from (select c.plan_hash_value,</span>
<span class="line">                  b.hash_value,</span>
<span class="line">                  c.execnt,</span>
<span class="line">                  rank() over(partition by c.plan_hash_value order by b.hash_value) as hashrank</span>
<span class="line">           from v$sql b,</span>
<span class="line">                (select count(*) as execnt,</span>
<span class="line">                        plan_hash_value</span>
<span class="line">                 from v$sql</span>
<span class="line">                 where plan_hash_value &lt;&gt; 0</span>
<span class="line">                 group by plan_hash_value</span>
<span class="line">                 having count(*) &gt; 10</span>
<span class="line">                 order by count(*) desc) c</span>
<span class="line">           where b.plan_hash_value = c.plan_hash_value</span>
<span class="line">           group by c.plan_hash_value,b.hash_value,c.execnt)</span>
<span class="line">     where hashrank&lt;=3) d</span>
<span class="line">where a.hash_value = d.hash_value</span>
<span class="line">order by d.execnt desc,a.hash_value,a.piece</span>
</pre></td></tr></table></figure>
<h2 id="课堂笔记"><a href="#课堂笔记" class="headerlink" title="课堂笔记"></a>课堂笔记</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看所有数据字典视图列表</span></span>
<span class="line"><span class="keyword">select</span> table_name from dict;</span>
<span class="line"><span class="keyword">select</span> table_name from dict where table_name like <span class="string">'%PRIVS%'</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 查看数据字典基表的方法-查看执行执行</span></span>
<span class="line">set autot trace <span class="keyword">exp</span></span>
<span class="line"><span class="keyword">select</span> * from v$lock;</span>
<span class="line">set autot off</span>
<span class="line"></span>
<span class="line"><span class="comment"># 常用的数据字典-静态视图</span></span>
<span class="line">user_tables</span>
<span class="line">user_tab_partitions</span>
<span class="line">user_indexes</span>
<span class="line">user_ind_partitions</span>
<span class="line">user_segments</span>
<span class="line">dba_data_files</span>
<span class="line"></span>
<span class="line"><span class="comment"># 常用的数据字典-动态视图</span></span>
<span class="line">v$instance</span>
<span class="line">v$database</span>
<span class="line">v$log</span>
<span class="line">v$logfile</span>
<span class="line">v$session</span>
<span class="line">v$sql</span>
<span class="line">v$session_wait</span>
<span class="line">v$lock</span>
<span class="line">v$locked_object</span>
<span class="line"></span>
<span class="line">create table t_part (id <span class="keyword">int</span>) </span>
<span class="line">  partition by range(id)</span>
<span class="line">  (</span>
<span class="line">    partition p1 <span class="keyword">values</span> less than(<span class="number">5</span>),</span>
<span class="line">    partition p2 <span class="keyword">values</span> less than(<span class="number">10</span>),</span>
<span class="line">    partition pmax <span class="keyword">values</span> less than(maxvalue)</span>
<span class="line">  );</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> * from t_part partition(pmax);</span>
<span class="line"><span class="keyword">select</span> table_name,partition_name,tablespace_name from user_tab_partitions;</span>
<span class="line"></span>
<span class="line">alter table t_part move partition pmax tablespace test_ts;</span>
<span class="line">create <span class="keyword">index</span> ind_t_part on t_part(id) <span class="keyword">local</span> tablespace users;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> INDEX_NAME,TABLESPACE_NAME from user_ind_partitions group by index_name,tablespace_name;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> i.table_name,p.index_name,p.partition_name,p.tablespace_name</span>
<span class="line">from user_ind_partitions p,user_indexes i</span>
<span class="line">where i.index_name=p.index_name;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> sum(size_m) all_size_m from</span>
<span class="line">(<span class="keyword">select</span> sum(bytes/<span class="number">1024</span>/<span class="number">1024</span>) size_m from dba_data_files</span>
<span class="line"> union</span>
<span class="line"> <span class="keyword">select</span> sum(bytes/<span class="number">1024</span>/<span class="number">1024</span>) size_m from dba_temp_files);</span>
<span class="line"></span>
<span class="line">grant <span class="keyword">select</span> on v<span class="number">_</span>$mystat to lyj;</span>
<span class="line">conn lyj/lyj</span>
<span class="line"><span class="keyword">select</span> distinct sid from v$mystat;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> event,seconds_in_wait from v$session_wait where sid=<span class="number">355</span>;</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> sid,type,lmode,request,block from v$lock where type in (<span class="string">'TM'</span>,<span class="string">'TX'</span>);</span>
</pre></td></tr></table></figure>
<h3 id="实例的恢复-crash-recovery"><a href="#实例的恢复-crash-recovery" class="headerlink" title="实例的恢复(crash recovery)"></a>实例的恢复(crash recovery)</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 实例恢复发生在那个阶段？</span></span>
<span class="line">sql&gt; startup nomount       <span class="comment"># (读取spfle) ，没有实例恢复。</span></span>
<span class="line">sql&gt; mount database        <span class="comment"># (读取控制文件)，没有实例恢复。</span></span>
<span class="line">sql&gt; alter database <span class="keyword">open</span>   <span class="comment"># (检查控制文件，数据文件头)，发生实例恢复。</span></span>
<span class="line"><span class="comment"># Oracle在打开数据库时(alter database open)，会检查每个文件头上的信息(SCN)，</span></span>
<span class="line"><span class="comment"># 并同控制文件中相应的信息(SCN)比较，如果不一致，则进行实例恢复。</span></span>
</pre></td></tr></table></figure>
<h4 id="实例恢复的过程"><a href="#实例恢复的过程" class="headerlink" title="实例恢复的过程"></a>实例恢复的过程</h4><ol>
<li>前滚 rolling forward<br>读取状态为current和active状态的日志(redo log)，将发生crash时，没有来得及写到磁盘上的数据块，使用redo的信息来恢复。</li>
<li>打开数据库(alter database open)</li>
<li>回滚 rolling back<br>将没有提交的事务进行回滚</li>
</ol>
<h3 id="介质恢复（Media-recovery"><a href="#介质恢复（Media-recovery" class="headerlink" title="介质恢复（Media recovery)"></a>介质恢复（Media recovery)</h3><p>当发生以下情况时，实例恢复无效，需要进行介质恢复：</p>
<ol>
<li>数据文件丢失，损坏。</li>
<li>在线日志文件(online redo)丢失，损坏。</li>
<li>数据文件太旧 (比如从一个备份集中恢复过来的文件)</li>
<li>文件太新（比如，其它所有的文件都是从备份中恢复过来的)</li>
</ol>
<p>示例：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> FILE_ID,FILE_NAME,TABLESPACE_NAME,STATUS from dba_data_files order by <span class="number">1</span>;</span>
<span class="line"></span>
<span class="line">   FILE_ID FILE_NAME                                          TABLESPACE_NAME                STATUS</span>
<span class="line">---------- -------------------------------------------------- ------------------------------ ---------</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl/system01.dbf          SYSTEM                         AVAILABLE</span>
<span class="line">         <span class="number">2</span> /u01/app/oracle/oradata/orcl/sysaux01.dbf          SYSAUX                         AVAILABLE</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl/undotbs01.dbf         UNDOTBS1                       AVAILABLE</span>
<span class="line">         <span class="number">4</span> /u01/app/oracle/oradata/orcl/users01.dbf           USERS                          AVAILABLE</span>
<span class="line">         <span class="number">5</span> /u01/app/oracle/oradata/orcl/example01.dbf         EXAMPLE                        AVAILABLE</span>
<span class="line">         <span class="number">6</span> /u01/app/oracle/oradata/orcl/users02.dbf           USERS                          AVAILABLE</span>
<span class="line">         <span class="number">7</span> /u01/app/oracle/oradata/orcl/undotbs02.dbf         UNDOTBS2                       AVAILABLE</span>
<span class="line">         <span class="number">8</span> /u01/app/oracle/oradata/orcl/test_ts01.dbf         TEST_TS                        AVAILABLE</span>
<span class="line">         <span class="number">9</span> /u01/app/oracle/oradata/orcl/tbs_a.dbf             TBS_A                          AVAILABLE</span>
<span class="line">        <span class="number">10</span> /u01/app/oracle/oradata/orcl/test01.dbf            TEST1                          AVAILABLE</span>
<span class="line">        <span class="number">11</span> /u01/app/oracle/oradata/orcl/test02.dbf            TEST2                          AVAILABLE</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database datafile <span class="number">11</span> offline;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> checkpoint;</span>
<span class="line"></span>
<span class="line">System altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database datafile <span class="number">11</span> online;</span>
<span class="line">alter database datafile <span class="number">11</span> online</span>
<span class="line">*</span>
<span class="line">ERROR at line <span class="number">1</span>:</span>
<span class="line">ORA-<span class="number">01113</span>: file <span class="number">11</span> needs media recovery</span>
<span class="line">ORA-<span class="number">01110</span>: data file <span class="number">11</span>: <span class="string">'/u01/app/oracle/oradata/orcl/test02.dbf'</span></span>
<span class="line"></span>
<span class="line">SQL&gt; recover datafile <span class="number">11</span>;</span>
<span class="line">Media recovery complete.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database datafile <span class="number">11</span> online;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
</pre></td></tr></table></figure></p>
<h2 id="RAC"><a href="#RAC" class="headerlink" title="RAC"></a>RAC</h2><h3 id="RAC的目的"><a href="#RAC的目的" class="headerlink" title="RAC的目的"></a>RAC的目的</h3><ul>
<li>提供实例级别的冗余</li>
<li>提供更多的系统资源</li>
<li>增加更多的并行处理</li>
</ul>
<h3 id="RAC的优点和缺点"><a href="#RAC的优点和缺点" class="headerlink" title="RAC的优点和缺点"></a>RAC的优点和缺点</h3><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>提供系统冗余</li>
<li>更多的系统资源</li>
<li>业务分割处理</li>
</ul>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>内存共享与资源争用（Cache Fusion）</li>
<li>底层技术复杂，对DBA技术要求高</li>
</ul>
<p>CRS（Cluster Ready Service）</p>
<h2 id="Data-Guard"><a href="#Data-Guard" class="headerlink" title="Data Guard"></a>Data Guard</h2><p>DG是一个容错方案，一般使用于数据量不是很大的数据库，对于OLTP非常适合。<br>OLAP数据量太大，一般选择关键数据创建DG，常规数据，选择其他方式备份。</p>
]]></content>
      
        <categories>
            
            <category> Oracle职业直通车 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle职业直通车-04 复杂一点的SQL/PLSQL]]></title>
      <url>/2015/03/16/oracle/Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/04_Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6/</url>
      <content type="html"><![CDATA[<h2 id="写一个子查询的SQL语句。"><a href="#写一个子查询的SQL语句。" class="headerlink" title="写一个子查询的SQL语句。"></a>写一个子查询的SQL语句。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> b.dname,a.ename</span>
<span class="line">from</span>
<span class="line">  (<span class="keyword">select</span> deptno,ename from emp) a,</span>
<span class="line">  (<span class="keyword">select</span> deptno,dname from dept) b</span>
<span class="line">where a.deptno=b.deptno order by <span class="number">1</span>,<span class="number">2</span>;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="分别写一个内连接，左连接，右连接的SQL语句。"><a href="#分别写一个内连接，左连接，右连接的SQL语句。" class="headerlink" title="分别写一个内连接，左连接，右连接的SQL语句。"></a>分别写一个内连接，左连接，右连接的SQL语句。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 内连接 inner join</span></span>
<span class="line"><span class="keyword">select</span> a.dname,b.ename,b.mgr</span>
<span class="line">from dept a, emp b</span>
<span class="line">where a.deptno=b.deptno;</span>
<span class="line"></span>
<span class="line">DNAME          ENAME             MGR</span>
<span class="line">-------------- ---------- ----------</span>
<span class="line">ACCOUNTING     CLARK            <span class="number">7839</span></span>
<span class="line">ACCOUNTING     KING</span>
<span class="line">ACCOUNTING     MILLER           <span class="number">7782</span></span>
<span class="line">RESEARCH       JONES            <span class="number">7839</span></span>
<span class="line">RESEARCH       FORD             <span class="number">7566</span></span>
<span class="line">RESEARCH       ADAMS            <span class="number">7788</span></span>
<span class="line">RESEARCH       SMITH            <span class="number">7902</span></span>
<span class="line">RESEARCH       SCOTT            <span class="number">7566</span></span>
<span class="line">SALES          WARD             <span class="number">7698</span></span>
<span class="line">SALES          TURNER           <span class="number">7698</span></span>
<span class="line">SALES          ALLEN            <span class="number">7698</span></span>
<span class="line">SALES          JAMES            <span class="number">7698</span></span>
<span class="line">SALES          BLAKE            <span class="number">7839</span></span>
<span class="line">SALES          MARTIN           <span class="number">7698</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 外连接 outer join - 左连接 左边集合的全集</span></span>
<span class="line"><span class="keyword">select</span> a.dname,b.ename,b.mgr</span>
<span class="line">from dept a, emp b</span>
<span class="line">where a.deptno=b.deptno(+);</span>
<span class="line">DNAME          ENAME             MGR</span>
<span class="line">-------------- ---------- ----------</span>
<span class="line">ACCOUNTING     CLARK            <span class="number">7839</span></span>
<span class="line">ACCOUNTING     KING</span>
<span class="line">ACCOUNTING     MILLER           <span class="number">7782</span></span>
<span class="line">RESEARCH       JONES            <span class="number">7839</span></span>
<span class="line">RESEARCH       FORD             <span class="number">7566</span></span>
<span class="line">RESEARCH       ADAMS            <span class="number">7788</span></span>
<span class="line">RESEARCH       SMITH            <span class="number">7902</span></span>
<span class="line">RESEARCH       SCOTT            <span class="number">7566</span></span>
<span class="line">SALES          WARD             <span class="number">7698</span></span>
<span class="line">SALES          TURNER           <span class="number">7698</span></span>
<span class="line">SALES          ALLEN            <span class="number">7698</span></span>
<span class="line">SALES          JAMES            <span class="number">7698</span></span>
<span class="line">SALES          BLAKE            <span class="number">7839</span></span>
<span class="line">SALES          MARTIN           <span class="number">7698</span></span>
<span class="line">OPERATIONS</span>
<span class="line">IT</span>
<span class="line"></span>
<span class="line"><span class="comment"># 外连接 outer join - 右连接 右边集合的全集</span></span>
<span class="line"><span class="keyword">select</span> a.dname,b.ename,b.mgr</span>
<span class="line">from dept a, emp b</span>
<span class="line">where a.deptno(+)=b.deptno;</span>
</pre></td></tr></table></figure>
<h2 id="写一个标量子查询的SQL。"><a href="#写一个标量子查询的SQL。" class="headerlink" title="写一个标量子查询的SQL。"></a>写一个标量子查询的SQL。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span>
<span class="line">  (<span class="keyword">select</span> dname from dept b where b.deptno=a.deptno),ename</span>
<span class="line">from emp a</span>
<span class="line">order by <span class="number">1</span>,<span class="number">2</span>;</span>
</pre></td></tr></table></figure>
<h2 id="写一个with语法的SQL语句。"><a href="#写一个with语法的SQL语句。" class="headerlink" title="写一个with语法的SQL语句。"></a>写一个with语法的SQL语句。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 找出工资大于平均工资的员工</span></span>
<span class="line"><span class="keyword">select</span> ename, sum(sal) from emp group by ename having sum(sal)&gt;=(<span class="keyword">select</span> sum(sal)/<span class="number">14</span> from emp);</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用WITH</span></span>
<span class="line">with t as (<span class="keyword">select</span> ename, sal from emp)</span>
<span class="line"><span class="keyword">select</span> ename,sal from t where sal&gt;=(<span class="keyword">select</span> sum(sal)/<span class="number">14</span> from emp);</span>
<span class="line"></span>
<span class="line">with t as (<span class="keyword">select</span> ename,sum(sal) sal from emp group by ename)</span>
<span class="line"><span class="keyword">select</span> ename,sal from t where sal&gt;=(<span class="keyword">select</span> sum(sal)/<span class="number">14</span> from emp);</span>
</pre></td></tr></table></figure>
<h2 id="用case或者decode语法做一个行列转换的列子，给出SQL语句。"><a href="#用case或者decode语法做一个行列转换的列子，给出SQL语句。" class="headerlink" title="用case或者decode语法做一个行列转换的列子，给出SQL语句。"></a>用case或者decode语法做一个行列转换的列子，给出SQL语句。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># case</span></span>
<span class="line"><span class="keyword">select</span> </span>
<span class="line">  case</span>
<span class="line">    <span class="keyword">when</span> deptno=<span class="number">10</span> then <span class="string">'ACCOUNTING'</span></span>
<span class="line">    <span class="keyword">when</span> deptno=<span class="number">20</span> then <span class="string">'RESERCH'</span></span>
<span class="line">    <span class="keyword">when</span> deptno=<span class="number">30</span> then <span class="string">'SALES'</span></span>
<span class="line">  end,</span>
<span class="line">  sum(sal) from emp</span>
<span class="line">  group by deptno;</span>
<span class="line"></span>
<span class="line"><span class="comment"># decode</span></span>
<span class="line"><span class="keyword">select</span> </span>
<span class="line">  decode(deptno,</span>
<span class="line">         <span class="number">10</span>,<span class="string">'ACCOUNTING'</span>,</span>
<span class="line">         <span class="number">20</span>,<span class="string">'RESERCH'</span>,</span>
<span class="line">         <span class="number">30</span>,<span class="string">'SALES'</span>),</span>
<span class="line">  sum(sal) from emp</span>
<span class="line">  group by deptno;</span>
<span class="line"></span>
<span class="line"><span class="comment"># 行转列</span></span>
<span class="line"><span class="keyword">select</span> job,ename,sal from emp where job=<span class="string">'MANAGER'</span>;</span>
<span class="line"></span>
<span class="line">JOB       ENAME             SAL</span>
<span class="line">--------- ---------- ----------</span>
<span class="line">MANAGER   JONES            <span class="number">2975</span></span>
<span class="line">MANAGER   BLAKE            <span class="number">2850</span></span>
<span class="line">MANAGER   CLARK            <span class="number">2450</span></span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> job,</span>
<span class="line">       sum(decode(ename,<span class="string">'JONES'</span>,SAL)) JONES,</span>
<span class="line">       sum(decode(ename,<span class="string">'BLAKE'</span>,SAL)) BLAKE,</span>
<span class="line">       sum(decode(ename,<span class="string">'CLARK'</span>,SAL)) CLARK</span>
<span class="line">from emp</span>
<span class="line">where job=<span class="string">'MANAGER'</span> group by job;</span>
<span class="line"></span>
<span class="line">JOB            JONES      BLAKE      CLARK</span>
<span class="line">--------- ---------- ---------- ----------</span>
<span class="line">MANAGER         <span class="number">2975</span>       <span class="number">2850</span>       <span class="number">2450</span></span>
</pre></td></tr></table></figure>
<h2 id="写个存储过程，在在屏幕中打印出scott-dept表的内容。"><a href="#写个存储过程，在在屏幕中打印出scott-dept表的内容。" class="headerlink" title="写个存储过程，在在屏幕中打印出scott.dept表的内容。"></a>写个存储过程，在在屏幕中打印出scott.dept表的内容。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create <span class="keyword">or</span> replace procedure print_dept is</span>
<span class="line">begin</span>
<span class="line"><span class="keyword">for</span> i in (<span class="keyword">select</span> * from scott.dept)</span>
<span class="line">loop</span>
<span class="line">  dbms_output.put_line(i.deptno||<span class="string">','</span>||i.dname||<span class="string">','</span>||i.loc);</span>
<span class="line">end loop;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">set serverout on</span>
<span class="line">exec print_dept</span></span>
</pre></td></tr></table></figure>
<h2 id="写个存储过程，通过使用传入的表名作为参数-删除这张表。"><a href="#写个存储过程，通过使用传入的表名作为参数-删除这张表。" class="headerlink" title="写个存储过程，通过使用传入的表名作为参数,删除这张表。"></a>写个存储过程，通过使用传入的表名作为参数,删除这张表。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create table emp1 as <span class="keyword">select</span> * from emp;</span>
<span class="line"></span>
<span class="line">create <span class="keyword">or</span> replace procedure droptable (v_tablename varchar2) is</span>
<span class="line">begin</span>
<span class="line">  execute immediate <span class="string">'drop table '</span> || v_tablename ||<span class="string">' purge'</span>;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">exec droptable('emp1');</span></span>
</pre></td></tr></table></figure>
<h2 id="写个函数，通过“表空间名称”作为传入参数，打印出表空间的大小。"><a href="#写个函数，通过“表空间名称”作为传入参数，打印出表空间的大小。" class="headerlink" title="写个函数，通过“表空间名称”作为传入参数，打印出表空间的大小。"></a>写个函数，通过“表空间名称”作为传入参数，打印出表空间的大小。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line"></span>
<span class="line"><span class="comment"># 函数</span></span>
<span class="line">create <span class="keyword">or</span> replace function f_tablespace_size(v_tablesapce varchar2)  </span>
<span class="line"><span class="keyword">return</span> varchar2 is</span>
<span class="line">v_size varchar2(<span class="number">10</span>);</span>
<span class="line">begin</span>
<span class="line">  <span class="keyword">select</span> sum(bytes/<span class="number">1024</span>/<span class="number">1024</span>)||<span class="string">'M'</span> into v_size from dba_data_files where TABLESPACE_NAME=v_tablesapce;</span>
<span class="line">  <span class="keyword">return</span> v_size;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">select f_tablespace_size('USERS') from dual;</span>
<span class="line"></span>
<span class="line"># 存储过程</span>
<span class="line">create or replace procedure tablespace_size(v_tablespace varchar2) is</span>
<span class="line">v_size varchar2(10);</span>
<span class="line">begin</span>
<span class="line">  select sum(bytes/</span><span class="number">1024</span>/<span class="number">1024</span>)||<span class="string">'M'</span> into v_size from dba_data_files where TABLESPACE_NAME=v_tablespace;</span>
<span class="line">  dbms_output.put_line(v_tablespace||<span class="string">'表空间的大小为'</span>||v_size);</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">exec tablespace_size('USERS')</span></span>
</pre></td></tr></table></figure>
<h2 id="写个触发器，当向一张表中插入数据时，同时向另一张表中插入数据。"><a href="#写个触发器，当向一张表中插入数据时，同时向另一张表中插入数据。" class="headerlink" title="写个触发器，当向一张表中插入数据时，同时向另一张表中插入数据。"></a>写个触发器，当向一张表中插入数据时，同时向另一张表中插入数据。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn scott/scott</span>
<span class="line">create table t1 (id <span class="keyword">int</span>);</span>
<span class="line">create table t2 (id <span class="keyword">int</span>);</span>
<span class="line"></span>
<span class="line">create <span class="keyword">or</span> replace trigger ins_talbe</span>
<span class="line">after insert on t1</span>
<span class="line"><span class="keyword">for</span> <span class="keyword">each</span> row</span>
<span class="line">begin</span>
<span class="line">  insert into t2(id) <span class="keyword">values</span>(:new.id);</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span></span>
</pre></td></tr></table></figure>
<h2 id="课堂练习"><a href="#课堂练习" class="headerlink" title="课堂练习"></a>课堂练习</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">begin</span>
<span class="line">  <span class="keyword">for</span> i in <span class="number">1</span> .. <span class="number">10</span> loop</span>
<span class="line">    null;</span>
<span class="line">  end loop;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">set serveroutput on;</span>
<span class="line">begin</span>
<span class="line">  for i in 1 .. 10 loop</span>
<span class="line">    dbms_output.put_line('hello,world!');</span>
<span class="line">  end loop;</span>
<span class="line">end;</span>
<span class="line">/</span></span>
<span class="line"></span>
<span class="line">conn scott/scott</span>
<span class="line">drop table t purge;</span>
<span class="line">create table t (id <span class="keyword">int</span>);</span>
<span class="line"></span>
<span class="line">begin</span>
<span class="line">  <span class="keyword">for</span> i in <span class="number">1</span> .. <span class="number">100</span> loop</span>
<span class="line">    insert into t <span class="keyword">values</span>(i);</span>
<span class="line">  end loop;</span>
<span class="line">  commit;</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line"># 定义变量的匿名PL/</span>SQL块</span>
<span class="line">set serveroutput on</span>
<span class="line">declare</span>
<span class="line"><span class="keyword">x</span> varchar2(<span class="number">40</span>):=<span class="string">'my first PL/SQL block'</span>;</span>
<span class="line">begin</span>
<span class="line">  dbms_output.put_line(<span class="keyword">x</span>);</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line"># 游标cursor</span>
<span class="line">declare</span>
<span class="line">x t.id%type;</span>
<span class="line">cursor c is select * from t;</span>
<span class="line">begin</span>
<span class="line">  open c;</span>
<span class="line">  loop</span>
<span class="line">    fetch c into x;</span>
<span class="line">    exit when c%notfound;</span>
<span class="line">    dbms_output.put_line('id is '|| x);</span>
<span class="line">  end loop;</span>
<span class="line">  close c;</span>
<span class="line">end;</span>
<span class="line">/</span></span>
<span class="line"></span>
<span class="line"><span class="comment"># 删除指定员工记录</span></span>
<span class="line">create <span class="keyword">or</span> replace procedure delemp(v_empno IN emp.empno%TYPE) as</span>
<span class="line">  no_result exception;</span>
<span class="line">begin</span>
<span class="line">  <span class="keyword">delete</span> from emp where empno=v_empno;</span>
<span class="line"></span>
<span class="line">  <span class="keyword">if</span> sql%notfound then</span>
<span class="line">    raise no_result;</span>
<span class="line">  end <span class="keyword">if</span>;</span>
<span class="line">  commit;</span>
<span class="line">  dbms_output.put_line(<span class="string">'编码为'</span>||v_empno||<span class="string">'的员工已被删除！'</span>);</span>
<span class="line">exception</span>
<span class="line">  <span class="keyword">when</span> no_result then</span>
<span class="line">    dbms_output.put_line(<span class="string">'您需要的数据不存在！'</span>);</span>
<span class="line">  <span class="keyword">when</span> others then</span>
<span class="line">    dbms_output.put_line(<span class="string">'其他错误！'</span>);</span>
<span class="line">end;</span>
<span class="line"><span class="regexp">/</span>
<span class="line"></span>
<span class="line">exec delemp(100)</span>
<span class="line"></span>
<span class="line"># 存储过程的参数 --IN,OUT,IN OUT</span>
<span class="line">CREATE OR REPLACE PROCEDURE ModeTest (</span>
<span class="line">p_InParameter IN NUMBER,</span>
<span class="line">p_OutParameter OUT NUMBER,</span>
<span class="line">p_InOutParameter IN OUT NUMBER) IS</span>
<span class="line">v_LocalVariable NUMBER;</span>
<span class="line">BEGIN</span>
<span class="line">v_LocalVariable := p_InParameter; -- Legal</span>
<span class="line">--p_InParameter := 7; -- Illegal</span>
<span class="line">p_OutParameter := 7; -- Legal</span>
<span class="line">--v_LocalVariable := p_outParameter; -- Illegal</span>
<span class="line">v_LocalVariable := p_InOutParameter; -- Legal</span>
<span class="line">p_InOutParameter := 7; -- Legal</span>
<span class="line">END ModeTest;</span>
<span class="line">/</span></span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle职业直通车 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle职业直通车-03 Oracle数据库的安装和配置]]></title>
      <url>/2015/03/09/oracle/Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/03_Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6/</url>
      <content type="html"><![CDATA[<h2 id="感知事务提交的效果，给出SQL演示："><a href="#感知事务提交的效果，给出SQL演示：" class="headerlink" title="感知事务提交的效果，给出SQL演示："></a>感知事务提交的效果，给出SQL演示：</h2><p><strong>在一个会话里发出一条DML语句（比如插入一条数据），不要提交，在另一个会话里面进行查询，看是否能够查到插入的数据？</strong><br>不能看到插入的数据<br><img src="http://oligvdnzp.bkt.clouddn.com/0718_oracle_01.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0718_oracle_02.png" alt=""><br><a id="more"></a><br><strong>在第一个会话中发出commit，在另一个会话里面进行查询，看是否能够查到修改过的数据。</strong><br>可以<br><img src="http://oligvdnzp.bkt.clouddn.com/0718_oracle_03.png" alt=""><br><img src="http://oligvdnzp.bkt.clouddn.com/0718_oracle_04.png" alt=""></p>
<p><strong>同时思考一个问题，在第一个会话插入一条数据之后，不要提交，为什么别的会话查询不到，而当前会话可以查到？</strong><br>这里的场景考虑到事务隔离级别：Oracle数据库支持READ COMMITTED 和SERIALIZABLE这两种事务隔离级别。并且oracle默认采用的是持READ COMMITTED隔离级别，也就是说一个会话只能读取其他事务已提交的更新结果，否则，发生等待，但是其他会话可以修改这个事务中被读取的记录，而不必等待事务结束，显然，在这种隔离级别下，一个事务中的两个相同的读取操作，其结果可能不同。</p>
<h2 id="计算出你的数据库当前SGA和PGA的大小，给出SQL演示。"><a href="#计算出你的数据库当前SGA和PGA的大小，给出SQL演示。" class="headerlink" title="计算出你的数据库当前SGA和PGA的大小，给出SQL演示。"></a>计算出你的数据库当前SGA和PGA的大小，给出SQL演示。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; show sga</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">838861464</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3523215360</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> sum(PGA_USED_MEM) PGA_USED_MEM from v$process;</span>
<span class="line"></span>
<span class="line">PGA_USED_MEM</span>
<span class="line">------------</span>
<span class="line">    <span class="number">41467768</span></span>
</pre></td></tr></table></figure>
<h2 id="说出服务器进程和实例后台进程有什么区别？"><a href="#说出服务器进程和实例后台进程有什么区别？" class="headerlink" title="说出服务器进程和实例后台进程有什么区别？"></a>说出服务器进程和实例后台进程有什么区别？</h2><p>实例的一半是内存，实例的另外一半就是进程。与内存不同，进程都是实实在在的存在，你可以看得见（不过摸不着）。通过相关进程，Oracle实现数据库与实例的连通；通过相关进程，Oracle实现数据库与实例的互动；通过相关进程，Oracle实现对Oracle数据库的应用。<br>Oracle进程分为两类：服务器进程（Server Process）和后台进程（Background Process），下面分别进行区分。</p>
<h3 id="服务器进程"><a href="#服务器进程" class="headerlink" title="服务器进程"></a>服务器进程</h3><p>Oracle的服务器进程有Oracle实例自动创建，用来处理连接到实例的客户端进程发出的请求，用户必须通过连接到Oracle的服务器进程来获取数据库中的信息。对于专用服务器模式，客户端进程和Oracle服务器进程是一一对应的，而在共享服务器模式下，一个Oracle服务器进程可能同时服务多个客户端进程。<br>服务器进程主要用来执行下列的任务：</p>
<ul>
<li>解析、执行客户端提交的SQL语句。</li>
<li>从磁盘数据文件中读取必须的数据块到SGA得数据缓存区。</li>
<li>以适当形式返回SQL语句执行结果。</li>
</ul>
<h3 id="实例后台进程"><a href="#实例后台进程" class="headerlink" title="实例后台进程"></a>实例后台进程</h3><p>后台进程是管理实例的，是实例的内存结构与文件系统之间的桥梁。像Oracle数据库这么庞大的结构，要保持高效、稳定并且具有良好的性能，只有几个经纪人显然不行的，因此各项标准服务都由特定进程专门处理，比如写数据文件要有DBWR进程，写归档文件要有ARCH进程等。由Oracle在后台自动启动、管理和维护，因此这些进程才被称为后台进程。</p>
<h2 id="说说你对数据库实例的理解，它的主要作用是什么？"><a href="#说说你对数据库实例的理解，它的主要作用是什么？" class="headerlink" title="说说你对数据库实例的理解，它的主要作用是什么？"></a>说说你对数据库实例的理解，它的主要作用是什么？</h2><p>实例是由操作系统中的一组内存区和一系列的操作系统进程组成，数据库则是指Oracle保存数据的一系列物理结构和逻辑结构，用户在访问Oracle数据库时主要是在与实例打交道，由实例访问数据库，并返回相应的操作结果。<br>最简单的Oracle数据库结构是由一个实例和一个数据库组成，不过对于RAC(或OPS)架构的Oracle数据库，一个数据库会对应多个实例。<br>在Oracle数据库，实例和数据库可以理解成两个相互间有关联的独立个体，每个数据库都至少有一个与之对应的实例（对于OPS/RAC架构的Oracle数据库，一个数据库会对应多个实例），每个实例在其生命周期内同时只能对应一个数据库。所谓的启动Oracle数据库时，实际上是连接到实例，说的更直白点儿，就是连接到操作系统的某些进程，并由这些进程访问处理内存中的对象，至于这些对象时如何从磁盘被读取到内存，那正是实例所做的工作。<br>Oracle中的实例有内存结构和进程结构两大部分组成。</p>
<h2 id="创建一个分区表，并插入一些数据，同时查询出每个分区的数据。"><a href="#创建一个分区表，并插入一些数据，同时查询出每个分区的数据。" class="headerlink" title="创建一个分区表，并插入一些数据，同时查询出每个分区的数据。"></a>创建一个分区表，并插入一些数据，同时查询出每个分区的数据。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create table tab_pat (col1 number,col2 varchar2(<span class="number">30</span>))</span>
<span class="line">partition by range(col1)(</span>
<span class="line">  partition tab_pat_01 <span class="keyword">values</span> less than(<span class="number">20000</span>),</span>
<span class="line">  partition tab_pat_02 <span class="keyword">values</span> less than(<span class="number">40000</span>),</span>
<span class="line">  partition tab_pat_03 <span class="keyword">values</span> less than(<span class="number">60000</span>),</span>
<span class="line">  partition tab_pat_04 <span class="keyword">values</span> less than(<span class="number">80000</span>),</span>
<span class="line">  partition tab_pat_05 <span class="keyword">values</span> less than(maxvalue)</span>
<span class="line">);</span>
<span class="line"></span>
<span class="line"></span>
<span class="line">insert into tab_pat <span class="keyword">select</span> object_id,object_name from all_objects;</span>
<span class="line">commit;</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from tab_pat;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">68327</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from tab_pat partition (tab_pat_01);</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">11699</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from tab_pat partition (tab_pat_02);</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">19993</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from tab_pat partition (tab_pat_03);</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">19999</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from tab_pat partition (tab_pat_04);</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">     <span class="number">15842</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from tab_pat partition (tab_pat_05);</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">       <span class="number">794</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> * from tab_pat partition (tab_pat_05) where rownum&lt;<span class="number">10</span>;</span>
<span class="line"></span>
<span class="line">      COL1 COL2</span>
<span class="line">---------- ------------------------------</span>
<span class="line">     <span class="number">80001</span> SDO_NETWORK_MANAGER_T</span>
<span class="line">     <span class="number">80004</span> SDO_NETWORK_MANAGER_T</span>
<span class="line">     <span class="number">80005</span> SDO_NODE_T</span>
<span class="line">     <span class="number">80007</span> SDO_NODE_T</span>
<span class="line">     <span class="number">80008</span> SDO_LINK_T</span>
<span class="line">     <span class="number">80019</span> SDO_NETWORK_T</span>
<span class="line">     <span class="number">80010</span> SDO_LINK_T</span>
<span class="line">     <span class="number">80011</span> SDO_PATH_T</span>
<span class="line">     <span class="number">80013</span> SDO_PATH_T</span>
</pre></td></tr></table></figure>
<h2 id="创建一个视图，并给出一个查询语句。"><a href="#创建一个视图，并给出一个查询语句。" class="headerlink" title="创建一个视图，并给出一个查询语句。"></a>创建一个视图，并给出一个查询语句。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create view vi_obj</span>
<span class="line">as</span>
<span class="line"><span class="keyword">select</span> col1 object_id,col2 object_name</span>
<span class="line">  from tab_pat</span>
<span class="line">    where col1&gt;=<span class="number">85000</span>;</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> count(*) from vi_obj;</span>
<span class="line"></span>
<span class="line">  COUNT(*)</span>
<span class="line">----------</span>
<span class="line">       <span class="number">358</span></span>
</pre></td></tr></table></figure>
<h2 id="在当前用户下创建一个同义词，用于查询scott用户下的dept表，并给出一个查询语句。"><a href="#在当前用户下创建一个同义词，用于查询scott用户下的dept表，并给出一个查询语句。" class="headerlink" title="在当前用户下创建一个同义词，用于查询scott用户下的dept表，并给出一个查询语句。"></a>在当前用户下创建一个同义词，用于查询scott用户下的dept表，并给出一个查询语句。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line">grant <span class="keyword">select</span> any table to hr;</span>
<span class="line">conn hr/hr</span>
<span class="line">create synonym dept <span class="keyword">for</span> scott.dept;</span>
<span class="line"><span class="keyword">select</span> * from dept;</span>
<span class="line"></span>
<span class="line">    DEPTNO DNAME          LOC</span>
<span class="line">---------- -------------- -------------</span>
<span class="line">        <span class="number">10</span> ACCOUNTING     NEW YORK</span>
<span class="line">        <span class="number">20</span> RESEARCH       DALLAS</span>
<span class="line">        <span class="number">30</span> SALES          CHICAGO</span>
<span class="line">        <span class="number">40</span> OPERATIONS     BOSTON</span>
<span class="line">        <span class="number">50</span> IT             BEIJING</span>
</pre></td></tr></table></figure>
<h2 id="创建一个sequence，并给出一个获得sequence号的语句。"><a href="#创建一个sequence，并给出一个获得sequence号的语句。" class="headerlink" title="创建一个sequence，并给出一个获得sequence号的语句。"></a>创建一个sequence，并给出一个获得sequence号的语句。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create sequence emp_seq</span>
<span class="line"> start with <span class="number">1000</span></span>
<span class="line"> increment by <span class="number">1</span></span>
<span class="line"> nocache</span>
<span class="line"> nocycle;</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> emp_seq.nextval from dual;</span>
<span class="line"></span>
<span class="line">   NEXTVAL</span>
<span class="line">----------</span>
<span class="line">      <span class="number">1000</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> emp_seq.currval from dual;</span>
<span class="line"></span>
<span class="line">   CURRVAL</span>
<span class="line">----------</span>
<span class="line">      <span class="number">1000</span></span>
</pre></td></tr></table></figure>
<h2 id="创建一个指向本地数据库的dblink-并通过dblink查询一个表中的数据。"><a href="#创建一个指向本地数据库的dblink-并通过dblink查询一个表中的数据。" class="headerlink" title="创建一个指向本地数据库的dblink,并通过dblink查询一个表中的数据。"></a>创建一个指向本地数据库的dblink,并通过dblink查询一个表中的数据。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; conn / as sysdba</span>
<span class="line">Connected.</span>
<span class="line">SQL&gt; grant create database <span class="keyword">link</span> to hr;</span>
<span class="line"></span>
<span class="line">Grant succeeded.</span>
<span class="line"></span>
<span class="line">conn hr/hr</span>
<span class="line">create database <span class="keyword">link</span> scott </span>
<span class="line">  <span class="keyword">connect</span> to scott identified by scott using <span class="string">'orcl'</span>;</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> * from scott.dept@scott;</span>
<span class="line"></span>
<span class="line">    DEPTNO DNAME          LOC</span>
<span class="line">---------- -------------- -------------</span>
<span class="line">        <span class="number">10</span> ACCOUNTING     NEW YORK</span>
<span class="line">        <span class="number">20</span> RESEARCH       DALLAS</span>
<span class="line">        <span class="number">30</span> SALES          CHICAGO</span>
<span class="line">        <span class="number">40</span> OPERATIONS     BOSTON</span>
<span class="line">        <span class="number">50</span> IT             BEIJING</span>
</pre></td></tr></table></figure>
<h2 id="创建一个表空间，并在这个表空间上创建一张表。"><a href="#创建一个表空间，并在这个表空间上创建一张表。" class="headerlink" title="创建一个表空间，并在这个表空间上创建一张表。"></a>创建一个表空间，并在这个表空间上创建一张表。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">conn / as sysdba</span>
<span class="line">create tablespace test_ts datafile <span class="string">'/u01/app/oracle/oradata/orcl/test_ts01.dbf'</span> size <span class="number">50</span><span class="keyword">m</span>;</span>
<span class="line">conn hr/hr</span>
<span class="line">create table test1 (id number,name varchar2(<span class="number">10</span>)) tablespace test_ts;</span>
</pre></td></tr></table></figure>
<h2 id="将数据库设置为归档模式，并进行一次日志切换，观察归档文件的产生。"><a href="#将数据库设置为归档模式，并进行一次日志切换，观察归档文件的产生。" class="headerlink" title="将数据库设置为归档模式，并进行一次日志切换，观察归档文件的产生。"></a>将数据库设置为归档模式，并进行一次日志切换，观察归档文件的产生。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; conn / as sysdba</span>
<span class="line">Connected.</span>
<span class="line"></span>
<span class="line">SQL&gt; archive <span class="keyword">log</span> list;</span>
<span class="line">Database <span class="keyword">log</span> mode              No Archive Mode</span>
<span class="line">Automatic archival             Disabled</span>
<span class="line">Archive destination            /u01/app/oracle/<span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/db_1/dbs/arch</span>
<span class="line">Oldest online <span class="keyword">log</span> sequence     <span class="number">4</span></span>
<span class="line">Current <span class="keyword">log</span> sequence           <span class="number">6</span></span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">Database closed.</span>
<span class="line">Database dismounted.</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line"></span>
<span class="line">SQL&gt; startup mount</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">905970328</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3456106496</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database archivelog;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; ! <span class="keyword">mkdir</span> /u01/app/oracle/archive</span>
<span class="line"></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> set log_archive_dest=<span class="string">'/u01/app/oracle/archive'</span>;</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database <span class="keyword">open</span>;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; archive <span class="keyword">log</span> list;</span>
<span class="line"></span>
<span class="line">SQL&gt; archive <span class="keyword">log</span> list;</span>
<span class="line">Database <span class="keyword">log</span> mode              Archive Mode</span>
<span class="line">Automatic archival             Enabled</span>
<span class="line">Archive destination            /u01/app/oracle/archive</span>
<span class="line">Oldest online <span class="keyword">log</span> sequence     <span class="number">4</span></span>
<span class="line">Next <span class="keyword">log</span> sequence to archive   <span class="number">7</span></span>
<span class="line">Current <span class="keyword">log</span> sequence           <span class="number">7</span></span>
<span class="line"></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> switch logfile;</span>
<span class="line"></span>
<span class="line">System altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; ! ls -l /u01/app/oracle/archive</span>
<span class="line">total <span class="number">248</span></span>
<span class="line">-rw-r----- <span class="number">1</span> oracle oinstall <span class="number">253952</span> Jul <span class="number">18</span> <span class="number">16</span>:<span class="number">57</span> <span class="number">1_7_949653805</span>.dbf</span>
</pre></td></tr></table></figure>
<h2 id="说说你是如何理解commit和checkpoint的。"><a href="#说说你是如何理解commit和checkpoint的。" class="headerlink" title="说说你是如何理解commit和checkpoint的。"></a>说说你是如何理解commit和checkpoint的。</h2><p>下面这些操作将会触发checkpoint事件：</p>
<ol>
<li>日志切换，通过ALTER SYSTEM SWITCH LOGFILE。</li>
<li>DBA发出checkpoint命令，通过ALTER SYSTEM checkpoint。</li>
<li>对数据文件进行热备时，针对该数据文件的checkpoint也会进行，ALTER TABLESPACE TS_NAME BEGIN BACKUP/END BACKUP。</li>
<li>当运行ALTER TABLESPACE/DATAFILE READ ONLY的时候。</li>
<li>SHUTDOWN命令发出时。</li>
</ol>
<p>checkpoint会触发DBWR进程（数据库写进程），将脏数据块写到数据文件中，而commit触发LGWR（日志写进程），将redo日志缓存写到redo日志文件中。<br>如果DBWR进程要将事务的结果写入数据文件，但发现要写入的脏数据块相关的重做信息仍然处于重做日志缓存中，它将通知oracle启动LGWR进程，先将这些重做信息写入重做日志文件，直到重做信息全部被写入后，DBWR进程才开始将脏缓存写入数据文件。</p>
<h2 id="说说你是如何理解redo和undo的作用的。"><a href="#说说你是如何理解redo和undo的作用的。" class="headerlink" title="说说你是如何理解redo和undo的作用的。"></a>说说你是如何理解redo和undo的作用的。</h2><p>redo 是利用日志恢复已提交的事务；undo是利用undo表空间里的前镜像恢复未提交的但已修改的事务。<br>REDO记录transaction logs，分为online和archived，以恢复为目的。比如，机器停电，那么在重起之后需要online redo logs去恢复系统到失败点。比如，磁盘坏了，需要用archived redo logs和online redo logs区恢复数据。比如，truncate一个表或其他的操作，想恢复到之前的状态，同样也需要。</p>
<p>REDO是为了重新实现你的操作，而UNDO相反，是为了撤销你做的操作，比如你得一个TRANSACTION执行失败了或你自己后悔了，则需要用 ROLLBACK命令回退到操作之前。回滚是在逻辑层面实现而不是物理层面，因为在一个多用户系统中，数据结构，blocks等都在时时变化，比如我们 INSERT一个数据，表的空间不够，扩展了一个新的EXTENT，我们的数据保存在这新的EXTENT里，其它用户随后也在这EXTENT里插入了数据，而此时我想ROLLBACK，那么显然物理上讲这EXTENT撤销是不可能的，因为这么做会影响其他用户的操作。所以，ROLLBACK是逻辑上回滚，比如对INSERT来说，那么ROLLBACK就是DELETE了。</p>
<h2 id="对于下面的操作，说一说redo和undo分别是在哪个阶段产生的"><a href="#对于下面的操作，说一说redo和undo分别是在哪个阶段产生的" class="headerlink" title="对于下面的操作，说一说redo和undo分别是在哪个阶段产生的"></a>对于下面的操作，说一说redo和undo分别是在哪个阶段产生的</h2><p>语句：<code>update t set id=1 where id=2</code></p>
<ol>
<li>当发出这条update语句后，oracle先将更改前后信息写进redo（当满足一定条件后由日志写进程写入日志文件）</li>
<li>然后将更新前得数据镜像copy到undo中。</li>
<li>用户rollback后，oracle 将undo中的数据覆盖回去。T表中的id=1</li>
<li>用户commit后，oracle可以根据redo 的信息进行数据恢复。T表中的id=2</li>
</ol>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><h3 id="数据库中的对象"><a href="#数据库中的对象" class="headerlink" title="数据库中的对象"></a>数据库中的对象</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看数据库中所有对象的类型</span></span>
<span class="line"><span class="keyword">select</span> distinct object_type from dba_objects order by <span class="number">1</span>;</span>
<span class="line"><span class="comment"># 以下是一些常用的对象类型</span></span>
<span class="line">INDEX PARTITION</span>
<span class="line">SEQUENCE</span>
<span class="line">TABLE PARTITION</span>
<span class="line">SCHEDULE</span>
<span class="line">PROCEDURE</span>
<span class="line">LOB</span>
<span class="line">PACKAGE</span>
<span class="line">TRIGGER</span>
<span class="line">DIRECTORY</span>
<span class="line">MATERIALIZED VIEW</span>
<span class="line">TABLE</span>
<span class="line">INDEX</span>
<span class="line">SYNONYM</span>
<span class="line">VIEW</span>
<span class="line">FUNCTION</span>
<span class="line">JOB</span>
<span class="line">DATABASE LINK</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle职业直通车 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle职业直通车-02 从最简单的SQL语句开始]]></title>
      <url>/2015/03/02/oracle/Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/02_Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6/</url>
      <content type="html"><![CDATA[<h2 id="教材第二章课后作业-1，2，3，4题"><a href="#教材第二章课后作业-1，2，3，4题" class="headerlink" title="教材第二章课后作业 1，2，3，4题"></a>教材第二章课后作业 1，2，3，4题</h2><h3 id="创建一查询，显示与BLAKE在同一部门工作的雇员的项目和受雇日期，但是BLAKE不包含在内。"><a href="#创建一查询，显示与BLAKE在同一部门工作的雇员的项目和受雇日期，但是BLAKE不包含在内。" class="headerlink" title="创建一查询，显示与BLAKE在同一部门工作的雇员的项目和受雇日期，但是BLAKE不包含在内。"></a>创建一查询，显示与BLAKE在同一部门工作的雇员的项目和受雇日期，但是BLAKE不包含在内。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; conn scott/scott</span>
<span class="line">Connected.</span>
<span class="line">SQL&gt; <span class="keyword">select</span> * from cat;</span>
<span class="line"></span>
<span class="line">TABLE_NAME                     TABLE_TYPE</span>
<span class="line">------------------------------ -----------</span>
<span class="line">BONUS                          TABLE</span>
<span class="line">DEPT                           TABLE</span>
<span class="line">EMP                            TABLE</span>
<span class="line">SALGRADE                       TABLE</span>
<span class="line"></span>
<span class="line"><span class="keyword">select</span> ENAME,JOB,to_char(HIREDATE,<span class="string">'YYYY-mm-dd'</span>) as HIREDATE from emp </span>
<span class="line">  where DEPTNO = (<span class="keyword">select</span> DEPTNO from emp where ENAME=<span class="string">'BLAKE'</span>)</span>
<span class="line">    <span class="keyword">and</span> ENAME&lt;&gt;<span class="string">'BLAKE'</span>;</span>
<span class="line"></span>
<span class="line">ENAME      JOB       HIREDATE</span>
<span class="line">---------- --------- ----------</span>
<span class="line">ALLEN      SALESMAN  <span class="number">1981</span>-<span class="number">02</span>-<span class="number">20</span></span>
<span class="line">WARD       SALESMAN  <span class="number">1981</span>-<span class="number">02</span>-<span class="number">22</span></span>
<span class="line">MARTIN     SALESMAN  <span class="number">1981</span>-09-<span class="number">28</span></span>
<span class="line">TURNER     SALESMAN  <span class="number">1981</span>-09-08</span>
<span class="line">JAMES      CLERK     <span class="number">1981</span>-<span class="number">12</span>-<span class="number">03</span></span>
</pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="显示位置在Dallas的部门内的雇员姓名、变化以及工作"><a href="#显示位置在Dallas的部门内的雇员姓名、变化以及工作" class="headerlink" title="显示位置在Dallas的部门内的雇员姓名、变化以及工作"></a>显示位置在Dallas的部门内的雇员姓名、变化以及工作</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.EMPNO,e.ENAME,e.JOB from EMP e, DEPT d</span>
<span class="line">  where e.DEPTNO=d.DEPTNO <span class="keyword">and</span> LOC=<span class="string">'DALLAS'</span>;</span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line"><span class="keyword">select</span> EMPNO,ENAME,JOB from emp </span>
<span class="line">  where DEPTNO=(<span class="keyword">select</span> deptno from dept where LOC=<span class="string">'DALLAS'</span>);</span>
<span class="line"></span>
<span class="line">     EMPNO ENAME      JOB</span>
<span class="line">---------- ---------- ---------</span>
<span class="line">      <span class="number">7369</span> SMITH      CLERK</span>
<span class="line">      <span class="number">7566</span> JONES      MANAGER</span>
<span class="line">      <span class="number">7788</span> SCOTT      ANALYST</span>
<span class="line">      <span class="number">7876</span> ADAMS      CLERK</span>
<span class="line">      <span class="number">7902</span> FORD       ANALYST</span>
</pre></td></tr></table></figure>
<h3 id="显示被-KING-直接管理的雇员的姓名以及工资"><a href="#显示被-KING-直接管理的雇员的姓名以及工资" class="headerlink" title="显示被 KING 直接管理的雇员的姓名以及工资"></a>显示被 KING 直接管理的雇员的姓名以及工资</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ENAME,SAL</span>
<span class="line">  from emp</span>
<span class="line">  where MGR=(<span class="keyword">select</span> EMPNO from emp where ENAME=<span class="string">'KING'</span>);</span>
<span class="line"><span class="comment"># 或者</span></span>
<span class="line">SELECT E.ENAME,E.SAL FROM EMP E,EMP EP WHERE E.MGR=EP.EMPNO AND EP.ENAME=<span class="string">'KING'</span>;</span>
<span class="line"></span>
<span class="line">ENAME             SAL</span>
<span class="line">---------- ----------</span>
<span class="line">JONES            <span class="number">2975</span></span>
<span class="line">BLAKE            <span class="number">2850</span></span>
<span class="line">CLARK            <span class="number">2450</span></span>
</pre></td></tr></table></figure>
<h3 id="创建一查询，显示能获得与-Scott-一样工资和奖金的其他雇员的姓名、受雇日期以及工资。"><a href="#创建一查询，显示能获得与-Scott-一样工资和奖金的其他雇员的姓名、受雇日期以及工资。" class="headerlink" title="创建一查询，显示能获得与 Scott 一样工资和奖金的其他雇员的姓名、受雇日期以及工资。"></a>创建一查询，显示能获得与 Scott 一样工资和奖金的其他雇员的姓名、受雇日期以及工资。</h3><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> ENAME,to_char(HIREDATE,<span class="string">'YYYY-MM-DD'</span>) HIREDATE,SAL</span>
<span class="line">from emp</span>
<span class="line">where SAL=(<span class="keyword">select</span> SAL from emp where ENAME=<span class="string">'SCOTT'</span>)</span>
<span class="line">  <span class="keyword">and</span> nvl(COMM,<span class="number">0</span>)=(<span class="keyword">select</span> nvl(COMM,<span class="number">0</span>) from emp where ENAME=<span class="string">'SCOTT'</span>)</span>
<span class="line">  <span class="keyword">and</span> ENAME&lt;&gt;<span class="string">'SCOTT'</span>;</span>
<span class="line"></span>
<span class="line">ENAME      HIREDATE          SAL</span>
<span class="line">---------- ---------- ----------</span>
<span class="line">FORD       <span class="number">1981</span>-<span class="number">12</span>-<span class="number">03</span>       <span class="number">3000</span></span>
</pre></td></tr></table></figure>
<h2 id="Oracle企业版和标准版有什么区别？"><a href="#Oracle企业版和标准版有什么区别？" class="headerlink" title="Oracle企业版和标准版有什么区别？"></a>Oracle企业版和标准版有什么区别？</h2><p>标准版是为中小型企业提供的功能全面的数据库，它以较低的成本为中小企业提供了世界一流数据库的性能、可用性、可伸缩性和安全性。</p>
<p>企业版在集群化和单一服务器配置方面提供了企业级的性能、可伸缩性和可靠性。它提供了全面的功能来支持要求最严格的事务处理、商务智能和内容管理软件。防止服务器故障、站点故障和人为错误的发生，并减少了计划内的宕机时间利用独特的行级安全性、细粒度审计和透明的数据加密技术来确保数据安全包括了高性能的数据仓库、在线分析处理和数据挖掘功能。</p>
<p>企业版的功能和组件是最全的，标准版的功能和组件有些没有，如分区功能、RAC、 OLAP、DATA MINING 、SPATIAL、ADVANCED REPLICATION等等功能是企业版有标准版没有的。</p>
<h2 id="描述ORACLE-BASE-ORACLE-HOME-ORACLE-SID的含义以及它们的用途，并给出你本机的这三个变量的值。"><a href="#描述ORACLE-BASE-ORACLE-HOME-ORACLE-SID的含义以及它们的用途，并给出你本机的这三个变量的值。" class="headerlink" title="描述ORACLE_BASE,ORACLE_HOME,ORACLE_SID的含义以及它们的用途，并给出你本机的这三个变量的值。"></a>描述ORACLE_BASE,ORACLE_HOME,ORACLE_SID的含义以及它们的用途，并给出你本机的这三个变量的值。</h2><p>ORACLE_BASE是Oracle产品的基目录，Oracle提供了大量企业级软件，并不单单是Oracle数据库，该目录用于存放所有安装的Oracle产品<br>ORACLE_HOME是Oracle数据库目录<br>ORACLE_SID是Oracle数据库实例名</p>
<h2 id="在安装过程中如果选择一般事务或者数据仓库，将会有什么不同？"><a href="#在安装过程中如果选择一般事务或者数据仓库，将会有什么不同？" class="headerlink" title="在安装过程中如果选择一般事务或者数据仓库，将会有什么不同？"></a>在安装过程中如果选择一般事务或者数据仓库，将会有什么不同？</h2><p>一般事务即适于OLTP，数据库系统善于短事务，高并发，读写频繁，对并发数，内存，变量绑定要求比较高，主要用于在线交易。</p>
<p>数据仓库即适于OLAP，数据库系统善于长事务，低并发，多读而少写，动态采样要求比较高，主要用于高层数据分析。并行在安装过程中选取的模式不一样，那么数据库会针对不同的模式配置不同的参数，以使得数据库运行的更加稳定，更加可靠。</p>
<p>Oracle数据库大多数参数都是可以调节的，但是有一些参数是无法调整的，比如db_block_size，即块大小，这个参数在OLTP和OLAP中设置不一样。对于OLTP数据库，一般不会将db_block_size设置太大，以避免读写时的I/O浪费；而在OLAP数据库中则一般设置较大。</p>
<p>OLTP(on-linetransaction processing)：联机事务处理，表示事务多，但执行大多较短，并发量大的数据库，如日常的进销存操作等；OLTP（在线交易）对并发、内存、变量绑定、优化器等有特殊要求。OLTP适用于用户多、连接数大,资源要求并发量高，内存效率高，SQL解析要求高</p>
<p>OLAP(On-LineAnalytical Processing): 联机分析处理，表示事务较少，但执行大多较长，并发量较小的数据库，如基于数据仓库的操作；OLAP（在线分析）：对I/O，并行，动态采样，优化器有特殊要求OLAP适用于用户不多、数据量大、查询复杂的报表系统，资源要求中I/O要求高、并行（多核CPU处理性能）、SQL执行计划要求高。</p>
<h2 id="分别用pfile生成spfile和用spfile生成pfile；分别用这两个参数启动数据库。"><a href="#分别用pfile生成spfile和用spfile生成pfile；分别用这两个参数启动数据库。" class="headerlink" title="分别用pfile生成spfile和用spfile生成pfile；分别用这两个参数启动数据库。"></a>分别用pfile生成spfile和用spfile生成pfile；分别用这两个参数启动数据库。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; conn / as sysdba</span>
<span class="line">Connected.</span>
<span class="line">SQL&gt; show parameter spfile</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">spfile                               string      /u01/app/oracle/<span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/db_1/</span>
<span class="line">                                                 dbs/spfileorcl.ora</span>
<span class="line">SQL&gt; create pfile from spfile;</span>
<span class="line"></span>
<span class="line">File created.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">Database closed.</span>
<span class="line">Database dismounted.</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line">SQL&gt; ! ls -l /u01/app/oracle/<span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/db_1/dbs/</span>
<span class="line">total <span class="number">39768</span></span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">10158080</span> Aug <span class="number">29</span>  <span class="number">2016</span> c-<span class="number">1445641855</span>-<span class="number">20160829</span>-<span class="number">01</span></span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">10158080</span> Aug <span class="number">29</span>  <span class="number">2016</span> c-<span class="number">1445641855</span>-<span class="number">20160829</span>-<span class="number">03</span></span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">10158080</span> Aug <span class="number">29</span>  <span class="number">2016</span> c-<span class="number">1445641855</span>-<span class="number">20160829</span>-<span class="number">04</span></span>
<span class="line">-rw-r-----. <span class="number">1</span> oracle oinstall <span class="number">10223616</span> Aug <span class="number">29</span>  <span class="number">2016</span> c-<span class="number">1445641855</span>-<span class="number">20160829</span>-<span class="number">06</span></span>
<span class="line">-rw-rw----. <span class="number">1</span> oracle oinstall     <span class="number">1544</span> Jul <span class="number">18</span> <span class="number">10</span>:<span class="number">30</span> hc_orcl.dat</span>
<span class="line">-rw-r--r--. <span class="number">1</span> oracle oinstall     <span class="number">2851</span> May <span class="number">15</span>  <span class="number">2009</span> init.ora</span>
<span class="line">-rw-r--r--  <span class="number">1</span> oracle oinstall      <span class="number">827</span> Jul <span class="number">18</span> <span class="number">10</span>:<span class="number">30</span> initorcl.ora</span>
<span class="line">-rw-r-----  <span class="number">1</span> oracle oinstall       <span class="number">24</span> Jul <span class="number">18</span> 08:<span class="number">43</span> lkORCL</span>
<span class="line">-rw-r-----  <span class="number">1</span> oracle oinstall     <span class="number">1536</span> Jul <span class="number">18</span> 08:<span class="number">46</span> orapworcl</span>
<span class="line">-rw-r-----  <span class="number">1</span> oracle oinstall     <span class="number">2560</span> Jul <span class="number">18</span> 08:<span class="number">47</span> spfileorcl.ora</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用pfile启动数据库</span></span>
<span class="line">SQL&gt; startup pfile=<span class="string">'/u01/app/oracle/11.2.0.4/db_1/dbs/initorcl.ora'</span>;</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">905970328</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3456106496</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">Database opened.</span>
<span class="line"></span>
<span class="line">SQL&gt; show parameter spfile</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">spfile                               string</span>
<span class="line"></span>
<span class="line"><span class="comment"># 使用SPFILE启动数据库（默认）</span></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">Database closed.</span>
<span class="line">Database dismounted.</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line">SQL&gt; create spfile from pfile;</span>
<span class="line"></span>
<span class="line">File created.</span>
<span class="line"></span>
<span class="line">SQL&gt; startup</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">905970328</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3456106496</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">Database opened.</span>
<span class="line">SQL&gt; show parameter pfile</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">spfile                               string      /u01/app/oracle/<span class="number">11.2</span>.<span class="number">0</span>.<span class="number">4</span>/db_1/</span>
<span class="line">                                                 dbs/spfileorcl.ora</span>
</pre></td></tr></table></figure>
<h2 id="给表空间增加一个数据文件"><a href="#给表空间增加一个数据文件" class="headerlink" title="给表空间增加一个数据文件"></a>给表空间增加一个数据文件</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; col FILE_NAME <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">SQL&gt; col TABLESPACE_NAME <span class="keyword">for</span> a15</span>
<span class="line">SQL&gt; <span class="keyword">select</span> FILE_NAME,TABLESPACE_NAME,BYTES/<span class="number">1024</span>/<span class="number">1024</span> size_m from dba_data_files;</span>
<span class="line"></span>
<span class="line">FILE_NAME                                          TABLESPACE_NAME     SIZE_M</span>
<span class="line">-------------------------------------------------- --------------- ----------</span>
<span class="line"><span class="regexp">/u01/app</span><span class="regexp">/oracle/oradata</span><span class="regexp">/orcl/users</span>01.dbf           USERS                    <span class="number">5</span></span>
<span class="line">/u01/app/oracle/oradata/orcl/undotbs01.dbf         UNDOTBS1                <span class="number">90</span></span>
<span class="line">/u01/app/oracle/oradata/orcl/sysaux01.dbf          SYSAUX                 <span class="number">520</span></span>
<span class="line">/u01/app/oracle/oradata/orcl/system01.dbf          SYSTEM                 <span class="number">750</span></span>
<span class="line">/u01/app/oracle/oradata/orcl/example01.dbf         EXAMPLE            <span class="number">313.125</span></span>
<span class="line"></span>
<span class="line">SQL&gt; alter tablespace USERS add datafile <span class="string">'/u01/app/oracle/oradata/orcl/users02.dbf'</span> size <span class="number">5</span>M;</span>
<span class="line"></span>
<span class="line">Tablespace altered.</span>
</pre></td></tr></table></figure>
<h2 id="创建一个新的UNDO表空间，并使用它。"><a href="#创建一个新的UNDO表空间，并使用它。" class="headerlink" title="创建一个新的UNDO表空间，并使用它。"></a>创建一个新的UNDO表空间，并使用它。</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; create undo tablespace UNDOTBS2 datafile <span class="string">'/u01/app/oracle/oradata/orcl/undotbs02.dbf'</span> size <span class="number">200</span>M;</span>
<span class="line"></span>
<span class="line">Tablespace created.</span>
<span class="line"></span>
<span class="line">SQL&gt; alter <span class="keyword">system</span> set undo_tablespace=<span class="string">'UNDOTBS2'</span>;</span>
<span class="line"></span>
<span class="line">System altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; show parameter undo</span>
<span class="line"></span>
<span class="line">NAME                                 TYPE        VALUE</span>
<span class="line">------------------------------------ ----------- ------------------------------</span>
<span class="line">undo_management                      string      AUTO</span>
<span class="line">undo_retention                       integer     <span class="number">900</span></span>
<span class="line">undo_tablespace                      string      UNDOTBS2</span>
</pre></td></tr></table></figure>
<h2 id="给当前redo增加一组新的redo-group"><a href="#给当前redo增加一组新的redo-group" class="headerlink" title="给当前redo增加一组新的redo group"></a>给当前redo增加一组新的redo group</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">SQL&gt; <span class="keyword">select</span> GROUP<span class="comment">#,MEMBERS,BYTES/1024/1024 size_m from v$log;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment">#    MEMBERS     SIZE_M</span></span>
<span class="line">---------- ---------- ----------</span>
<span class="line">         <span class="number">1</span>          <span class="number">1</span>         <span class="number">50</span></span>
<span class="line">         <span class="number">2</span>          <span class="number">1</span>         <span class="number">50</span></span>
<span class="line">         <span class="number">3</span>          <span class="number">1</span>         <span class="number">50</span></span>
<span class="line"></span>
<span class="line">SQL&gt; col MEMBER <span class="keyword">for</span> a5<span class="number">0</span></span>
<span class="line">SQL&gt; <span class="keyword">select</span> GROUP<span class="comment">#,MEMBER from v$logfile;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment"># MEMBER</span></span>
<span class="line">---------- --------------------------------------------------</span>
<span class="line">         <span class="number">3</span> /u01/app/oracle/oradata/orcl/redo03.log</span>
<span class="line">         <span class="number">2</span> /u01/app/oracle/oradata/orcl/redo02.log</span>
<span class="line">         <span class="number">1</span> /u01/app/oracle/oradata/orcl/redo01.log</span>
<span class="line"></span>
<span class="line">SQL&gt; alter database add logfile group <span class="number">4</span> (<span class="string">'/u01/app/oracle/oradata/orcl/redo04.log'</span>) size <span class="number">50</span>M;</span>
<span class="line"></span>
<span class="line">Database altered.</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">select</span> GROUP<span class="comment">#,MEMBERS,BYTES/1024/1024 size_m from v$log;</span></span>
<span class="line"></span>
<span class="line">    GROUP<span class="comment">#    MEMBERS     SIZE_M</span></span>
<span class="line">---------- ---------- ----------</span>
<span class="line">         <span class="number">1</span>          <span class="number">1</span>         <span class="number">50</span></span>
<span class="line">         <span class="number">2</span>          <span class="number">1</span>         <span class="number">50</span></span>
<span class="line">         <span class="number">3</span>          <span class="number">1</span>         <span class="number">50</span></span>
<span class="line">         <span class="number">4</span>          <span class="number">1</span>         <span class="number">50</span></span>
</pre></td></tr></table></figure>
<h2 id="计算当前数据库中所有数据文件的总计大小"><a href="#计算当前数据库中所有数据文件的总计大小" class="headerlink" title="计算当前数据库中所有数据文件的总计大小"></a>计算当前数据库中所有数据文件的总计大小</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SQL&gt; select sum(BYTES)/1024/1024 size_m from v$datafile;</span>
<span class="line"></span>
<span class="line">    SIZE_M</span>
<span class="line">----------</span>
<span class="line">  1883.125</span>
</pre></td></tr></table></figure>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><h3 id="dual是什么？"><a href="#dual是什么？" class="headerlink" title="dual是什么？"></a>dual是什么？</h3><ul>
<li>是Oracle下的一个字典表</li>
<li>属于sys用户</li>
<li>用于构造一个标准的SQL</li>
<li>对优化器有一定影响</li>
</ul>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">alter session set nls_date_format=<span class="string">'yyyy-mm-dd hh24:mi:ss'</span>;</span>
<span class="line"><span class="keyword">select</span> sysdate from dual;</span>
<span class="line"><span class="keyword">select</span> user from dual;</span>
</pre></td></tr></table></figure>
<h3 id="SQL语句的种类"><a href="#SQL语句的种类" class="headerlink" title="SQL语句的种类"></a>SQL语句的种类</h3><ul>
<li>DML: Data Manipulation language<ul>
<li>SELECT</li>
<li>INSERT</li>
<li>DELETE</li>
<li>UPDATE</li>
</ul>
</li>
<li>DDL: Data Definition Language<ul>
<li>CREATE</li>
<li>DROP</li>
<li>TRUNCATE</li>
<li>ALTER</li>
</ul>
</li>
<li>DCL: Data Control Language<ul>
<li>GRANT</li>
<li>REVOKE</li>
</ul>
</li>
</ul>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">create user lyj identified by lyj default tablespace users;</span>
<span class="line">grant <span class="keyword">connect</span>, resource to lyj;</span>
<span class="line">conn lyj/lyj</span>
<span class="line">create table t1 (id <span class="keyword">int</span>);</span>
<span class="line"><span class="keyword">truncate</span> table t1;</span>
<span class="line">alter table t1 add name varchar2(<span class="number">10</span>);</span>
<span class="line">insert into t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'lyj'</span>);</span>
<span class="line"><span class="keyword">delete</span> from t1 where id=<span class="number">1</span>;</span>
<span class="line">drop table t1 purge;</span>
<span class="line">conn / as sysdba</span>
<span class="line">drop user lyj cascade;</span>
<span class="line"></span>
<span class="line">conn scott/scott</span>
<span class="line"><span class="keyword">select</span> job,max(sal),min(sal),avg(sal),sum(sal) from emp group by job;</span>
<span class="line"></span>
<span class="line">alter database backup controlfile to trace;</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle职业直通车 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Oracle职业直通车-01 轻松带你走进Oracle数据库的世界]]></title>
      <url>/2015/02/10/oracle/Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6-%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/01_Oracle%E8%81%8C%E4%B8%9A%E7%9B%B4%E9%80%9A%E8%BD%A6/</url>
      <content type="html"><![CDATA[<h2 id="使用sqlplus-启动和关闭数据库"><a href="#使用sqlplus-启动和关闭数据库" class="headerlink" title="使用sqlplus 启动和关闭数据库"></a>使用sqlplus 启动和关闭数据库</h2><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line">$ sqlplus / as sysdba</span>
<span class="line"></span>
<span class="line">SQL&gt; <span class="keyword">shutdown</span> immediate</span>
<span class="line">Database closed.</span>
<span class="line">Database dismounted.</span>
<span class="line">ORACLE instance shut down.</span>
<span class="line"></span>
<span class="line">SQL&gt; startup</span>
<span class="line">ORACLE instance started.</span>
<span class="line"></span>
<span class="line">Total System Global Area <span class="number">4375998464</span> bytes</span>
<span class="line">Fixed Size                  <span class="number">2260328</span> bytes</span>
<span class="line">Variable Size             <span class="number">905970328</span> bytes</span>
<span class="line">Database Buffers         <span class="number">3456106496</span> bytes</span>
<span class="line">Redo Buffers               <span class="number">11661312</span> bytes</span>
<span class="line">Database mounted.</span>
<span class="line">Database opened.</span>
</pre></td></tr></table></figure>
<h2 id="创建用户test，密码test"><a href="#创建用户test，密码test" class="headerlink" title="创建用户test，密码test"></a>创建用户test，密码test</h2><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> <span class="keyword">test</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="keyword">test</span> <span class="keyword">default</span> <span class="keyword">tablespace</span> <span class="keyword">users</span>;</span>
</pre></td></tr></table></figure>]]></content>
      
        <categories>
            
            <category> Oracle职业直通车 </category>
            
        </categories>
        
        
        <tags>
            
            <tag> oracle </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
